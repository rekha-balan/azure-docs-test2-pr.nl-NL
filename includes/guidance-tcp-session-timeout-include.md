## <a name="tcp-settings-for-azure-vms"></a><span data-ttu-id="37496-101">TCP settings for Azure VMs</span><span class="sxs-lookup"><span data-stu-id="37496-101">TCP settings for Azure VMs</span></span>
<span data-ttu-id="37496-102">Azure VMs communicate with the public Internet by using [NAT][nat] (Network Address Translation).</span><span class="sxs-lookup"><span data-stu-id="37496-102">Azure VMs communicate with the public Internet by using [NAT][nat] (Network Address Translation).</span></span> <span data-ttu-id="37496-103">NAT devices assign a public IP address and port to an Azure VM, allowing that VM to establish a socket for communication with other devices.</span><span class="sxs-lookup"><span data-stu-id="37496-103">NAT devices assign a public IP address and port to an Azure VM, allowing that VM to establish a socket for communication with other devices.</span></span> <span data-ttu-id="37496-104">If packets stop flowing through that socket after a specific time, the NAT device kills the mapping, and the socket is free to be used by other VMs.</span><span class="sxs-lookup"><span data-stu-id="37496-104">If packets stop flowing through that socket after a specific time, the NAT device kills the mapping, and the socket is free to be used by other VMs.</span></span>

<span data-ttu-id="37496-105">This is a common NAT behavior, which can cause communication issues on TCP based applications that expect a socket to be maintained beyond a time-out period.</span><span class="sxs-lookup"><span data-stu-id="37496-105">This is a common NAT behavior, which can cause communication issues on TCP based applications that expect a socket to be maintained beyond a time-out period.</span></span> <span data-ttu-id="37496-106">There are two idle timeout settings to consider, for sessions in a *established connection* state:</span><span class="sxs-lookup"><span data-stu-id="37496-106">There are two idle timeout settings to consider, for sessions in a *established connection* state:</span></span>

* <span data-ttu-id="37496-107">**inbound** through the [Azure load balancer][azure-lb-timeout].</span><span class="sxs-lookup"><span data-stu-id="37496-107">**inbound** through the [Azure load balancer][azure-lb-timeout].</span></span> <span data-ttu-id="37496-108">This timeout defaults to 4 minutes, and can be adjusted up to 30 minutes.</span><span class="sxs-lookup"><span data-stu-id="37496-108">This timeout defaults to 4 minutes, and can be adjusted up to 30 minutes.</span></span>
* <span data-ttu-id="37496-109">**outbound** using [SNAT][snat] (Source NAT).</span><span class="sxs-lookup"><span data-stu-id="37496-109">**outbound** using [SNAT][snat] (Source NAT).</span></span> <span data-ttu-id="37496-110">This timeout is set to 4 minutes, and cannot be adjusted.</span><span class="sxs-lookup"><span data-stu-id="37496-110">This timeout is set to 4 minutes, and cannot be adjusted.</span></span>

<span data-ttu-id="37496-111">To ensure connections are not lost beyond the timeout limit, you should make sure either your application keeps the session alive, or you can configure the underlying operating system to do so.</span><span class="sxs-lookup"><span data-stu-id="37496-111">To ensure connections are not lost beyond the timeout limit, you should make sure either your application keeps the session alive, or you can configure the underlying operating system to do so.</span></span> <span data-ttu-id="37496-112">The settings to be used are different for Linux and Windows systems, as shown below.</span><span class="sxs-lookup"><span data-stu-id="37496-112">The settings to be used are different for Linux and Windows systems, as shown below.</span></span>

<span data-ttu-id="37496-113">For [Linux][linux], you should change the kernel variables below.</span><span class="sxs-lookup"><span data-stu-id="37496-113">For [Linux][linux], you should change the kernel variables below.</span></span>
<span data-ttu-id="37496-114">net.ipv4.tcp_keepalive_time = 120 net.ipv4.tcp_keepalive_intvl = 30 net.ipv4.tcp_keepalive_probes = 8</span><span class="sxs-lookup"><span data-stu-id="37496-114">net.ipv4.tcp_keepalive_time = 120 net.ipv4.tcp_keepalive_intvl = 30 net.ipv4.tcp_keepalive_probes = 8</span></span>

<span data-ttu-id="37496-115">For [Windows][windows], you should change the registry values below.</span><span class="sxs-lookup"><span data-stu-id="37496-115">For [Windows][windows], you should change the registry values below.</span></span>
<span data-ttu-id="37496-116">KeepAliveInterval = 30 KeepAliveTime = 120 TcpMaxDataRetransmissions = 8</span><span class="sxs-lookup"><span data-stu-id="37496-116">KeepAliveInterval = 30 KeepAliveTime = 120 TcpMaxDataRetransmissions = 8</span></span>

<span data-ttu-id="37496-117">The settings above ensure a keep alive packet is sent after 2 minutes (120 seconds) of idle time, and then sent every 30 seconds.</span><span class="sxs-lookup"><span data-stu-id="37496-117">The settings above ensure a keep alive packet is sent after 2 minutes (120 seconds) of idle time, and then sent every 30 seconds.</span></span> <span data-ttu-id="37496-118">And if 8 of those packets fail, the session is dropped.</span><span class="sxs-lookup"><span data-stu-id="37496-118">And if 8 of those packets fail, the session is dropped.</span></span>

<!-- links -->
[nat]: http://computer.howstuffworks.com/nat.htm
[snat]: ../load-balancer/load-balancer-overview.md/#source-nat
[linux]: http://tldp.org/HOWTO/TCP-Keepalive-HOWTO/usingkeepalive.html
[windows]: http://blogs.technet.com/b/nettracer/archive/2010/06/03/things-that-you-may-want-to-know-about-tcp-keepalives.aspx
[azure-lb-timeout]: ../load-balancer/load-balancer-tcp-idle-timeout.md