<span data-ttu-id="ff068-101">The approach to Azure endpoints works a little differently between the Classic and Resource Manager deployment models.</span><span class="sxs-lookup"><span data-stu-id="ff068-101">The approach to Azure endpoints works a little differently between the Classic and Resource Manager deployment models.</span></span> <span data-ttu-id="ff068-102">In the Resource Manager deployment model, you now have the flexibility to create network filters that control the flow of traffic in and out of your VMs.</span><span class="sxs-lookup"><span data-stu-id="ff068-102">In the Resource Manager deployment model, you now have the flexibility to create network filters that control the flow of traffic in and out of your VMs.</span></span> <span data-ttu-id="ff068-103">These filters allow you to create complex networking environments beyond a simple endpoint as in the Classic deployment model.</span><span class="sxs-lookup"><span data-stu-id="ff068-103">These filters allow you to create complex networking environments beyond a simple endpoint as in the Classic deployment model.</span></span> <span data-ttu-id="ff068-104">This article provides an overview of Network Security Groups and how they differ from using Classic endpoints, creating these filtering rules, and sample deployment scenarios.</span><span class="sxs-lookup"><span data-stu-id="ff068-104">This article provides an overview of Network Security Groups and how they differ from using Classic endpoints, creating these filtering rules, and sample deployment scenarios.</span></span>

## <a name="overview-of-resource-manager-deployments"></a><span data-ttu-id="ff068-105">Overview of Resource Manager deployments</span><span class="sxs-lookup"><span data-stu-id="ff068-105">Overview of Resource Manager deployments</span></span>
<span data-ttu-id="ff068-106">Endpoints in the Classic deployment model are replaced by Network Security Groups and access control list (ACL) rules.</span><span class="sxs-lookup"><span data-stu-id="ff068-106">Endpoints in the Classic deployment model are replaced by Network Security Groups and access control list (ACL) rules.</span></span> <span data-ttu-id="ff068-107">Quick steps for implementing Network Security Group ACL rules are:</span><span class="sxs-lookup"><span data-stu-id="ff068-107">Quick steps for implementing Network Security Group ACL rules are:</span></span>

* <span data-ttu-id="ff068-108">Create a Network Security Group.</span><span class="sxs-lookup"><span data-stu-id="ff068-108">Create a Network Security Group.</span></span>
* <span data-ttu-id="ff068-109">To allow or deny traffic, define your Network Security Group ACL rules.</span><span class="sxs-lookup"><span data-stu-id="ff068-109">To allow or deny traffic, define your Network Security Group ACL rules.</span></span>
* <span data-ttu-id="ff068-110">Assign your Network Security Group to a network interface or virtual network subnet.</span><span class="sxs-lookup"><span data-stu-id="ff068-110">Assign your Network Security Group to a network interface or virtual network subnet.</span></span>

<span data-ttu-id="ff068-111">If you are wanting to also perform port-forwarding, you need to place a load balancer in front of your VM and use NAT rules.</span><span class="sxs-lookup"><span data-stu-id="ff068-111">If you are wanting to also perform port-forwarding, you need to place a load balancer in front of your VM and use NAT rules.</span></span> <span data-ttu-id="ff068-112">Quick steps for implementing a load balancer and NAT rules would be as follows:</span><span class="sxs-lookup"><span data-stu-id="ff068-112">Quick steps for implementing a load balancer and NAT rules would be as follows:</span></span>

* <span data-ttu-id="ff068-113">Create a load balancer.</span><span class="sxs-lookup"><span data-stu-id="ff068-113">Create a load balancer.</span></span>
* <span data-ttu-id="ff068-114">Create a backend pool and add your VMs to the pool.</span><span class="sxs-lookup"><span data-stu-id="ff068-114">Create a backend pool and add your VMs to the pool.</span></span>
* <span data-ttu-id="ff068-115">Define your NAT rules for the required port forwarding.</span><span class="sxs-lookup"><span data-stu-id="ff068-115">Define your NAT rules for the required port forwarding.</span></span>
* <span data-ttu-id="ff068-116">Assign your NAT rules to your VMs.</span><span class="sxs-lookup"><span data-stu-id="ff068-116">Assign your NAT rules to your VMs.</span></span>

## <a name="network-security-group-overview"></a><span data-ttu-id="ff068-117">Network Security Group overview</span><span class="sxs-lookup"><span data-stu-id="ff068-117">Network Security Group overview</span></span>
<span data-ttu-id="ff068-118">Network Security Groups are a new feature that provides a layer of security for you to allow specific ports and subnets to access your VMs.</span><span class="sxs-lookup"><span data-stu-id="ff068-118">Network Security Groups are a new feature that provides a layer of security for you to allow specific ports and subnets to access your VMs.</span></span> <span data-ttu-id="ff068-119">You typically always have a Network Security Group providing this layer of security between your VMs and the outside world.</span><span class="sxs-lookup"><span data-stu-id="ff068-119">You typically always have a Network Security Group providing this layer of security between your VMs and the outside world.</span></span> <span data-ttu-id="ff068-120">Network Security Groups can be applied to a virtual network subnet or a specific network interface for a VM.</span><span class="sxs-lookup"><span data-stu-id="ff068-120">Network Security Groups can be applied to a virtual network subnet or a specific network interface for a VM.</span></span> <span data-ttu-id="ff068-121">Rather than creating endpoint ACL rules, you now create Network Security Group ACL rules.</span><span class="sxs-lookup"><span data-stu-id="ff068-121">Rather than creating endpoint ACL rules, you now create Network Security Group ACL rules.</span></span> <span data-ttu-id="ff068-122">These ACL rules provide much greater control than simply creating an endpoint to forward a given port.</span><span class="sxs-lookup"><span data-stu-id="ff068-122">These ACL rules provide much greater control than simply creating an endpoint to forward a given port.</span></span> <span data-ttu-id="ff068-123">For more information, see [What is a Network Security Group?](../articles/virtual-network/virtual-networks-nsg.md).</span><span class="sxs-lookup"><span data-stu-id="ff068-123">For more information, see [What is a Network Security Group?](../articles/virtual-network/virtual-networks-nsg.md).</span></span>

> [!TIP]
> <span data-ttu-id="ff068-124">You can assign Network Security Groups to multiple subnets or network interfaces.</span><span class="sxs-lookup"><span data-stu-id="ff068-124">You can assign Network Security Groups to multiple subnets or network interfaces.</span></span> <span data-ttu-id="ff068-125">There is no 1:1 mapping, meaning that you can create a Network Security Group with a common set of ACL rules and apply to multiple subnets or network interfaces.</span><span class="sxs-lookup"><span data-stu-id="ff068-125">There is no 1:1 mapping, meaning that you can create a Network Security Group with a common set of ACL rules and apply to multiple subnets or network interfaces.</span></span> <span data-ttu-id="ff068-126">Further, Network Security Group can be applied to resources across your subscription (based on [Role Based Access Controls](../articles/active-directory/role-based-access-control-what-is.md).</span><span class="sxs-lookup"><span data-stu-id="ff068-126">Further, Network Security Group can be applied to resources across your subscription (based on [Role Based Access Controls](../articles/active-directory/role-based-access-control-what-is.md).</span></span>

## <a name="load-balancers-overview"></a><span data-ttu-id="ff068-127">Load Balancers overview</span><span class="sxs-lookup"><span data-stu-id="ff068-127">Load Balancers overview</span></span>
<span data-ttu-id="ff068-128">In the Classic deployment model, Azure would perform all the Network Address Translation (NAT) and port forwarding on a Cloud Service for you.</span><span class="sxs-lookup"><span data-stu-id="ff068-128">In the Classic deployment model, Azure would perform all the Network Address Translation (NAT) and port forwarding on a Cloud Service for you.</span></span> <span data-ttu-id="ff068-129">When creating an endpoint, you would specify the external port to expose along with the internal port to direct traffic to.</span><span class="sxs-lookup"><span data-stu-id="ff068-129">When creating an endpoint, you would specify the external port to expose along with the internal port to direct traffic to.</span></span> <span data-ttu-id="ff068-130">Network Security Groups by themselves do not perform this same NAT and port forwarding.</span><span class="sxs-lookup"><span data-stu-id="ff068-130">Network Security Groups by themselves do not perform this same NAT and port forwarding.</span></span> 

<span data-ttu-id="ff068-131">To allow you to create NAT rules for such port forwarding, create an Azure load balancer in your resource group.</span><span class="sxs-lookup"><span data-stu-id="ff068-131">To allow you to create NAT rules for such port forwarding, create an Azure load balancer in your resource group.</span></span> <span data-ttu-id="ff068-132">Again, the load balancer is granular enough to only apply to specific VMs if needed.</span><span class="sxs-lookup"><span data-stu-id="ff068-132">Again, the load balancer is granular enough to only apply to specific VMs if needed.</span></span> <span data-ttu-id="ff068-133">The Azure load balancer NAT rules work alongside Network Security Group ACL rules to provide much more flexibility and control than was achievable using Cloud Service endpoints.</span><span class="sxs-lookup"><span data-stu-id="ff068-133">The Azure load balancer NAT rules work alongside Network Security Group ACL rules to provide much more flexibility and control than was achievable using Cloud Service endpoints.</span></span> <span data-ttu-id="ff068-134">For more information, see the [load balancer overview](../articles/load-balancer/load-balancer-overview.md).</span><span class="sxs-lookup"><span data-stu-id="ff068-134">For more information, see the [load balancer overview](../articles/load-balancer/load-balancer-overview.md).</span></span>

## <a name="network-security-group-acl-rules"></a><span data-ttu-id="ff068-135">Network Security Group ACL rules</span><span class="sxs-lookup"><span data-stu-id="ff068-135">Network Security Group ACL rules</span></span>
<span data-ttu-id="ff068-136">ACL rules let you define what traffic can flow in and out of your VM based on specific ports, port ranges, or protocols.</span><span class="sxs-lookup"><span data-stu-id="ff068-136">ACL rules let you define what traffic can flow in and out of your VM based on specific ports, port ranges, or protocols.</span></span> <span data-ttu-id="ff068-137">Rules are assigned to individual VMs or to a subnet.</span><span class="sxs-lookup"><span data-stu-id="ff068-137">Rules are assigned to individual VMs or to a subnet.</span></span> <span data-ttu-id="ff068-138">The following screenshot is an example of ACL rules for a common webserver:</span><span class="sxs-lookup"><span data-stu-id="ff068-138">The following screenshot is an example of ACL rules for a common webserver:</span></span>

![List of Network Security Group ACL rules](https://docstestmedia1.blob.core.windows.net/azure-media/includes/media/virtual-machines-common-endpoints-in-resource-manager/example-acl-rules.png)

<span data-ttu-id="ff068-140">ACL rules are applied based on a priority metric that you specify - the higher the value, the lower the priority.</span><span class="sxs-lookup"><span data-stu-id="ff068-140">ACL rules are applied based on a priority metric that you specify - the higher the value, the lower the priority.</span></span> <span data-ttu-id="ff068-141">Every Network Security Group has three default rules that are designed to handle the flow of Azure networking traffic, with an explicit `DenyAllInbound` as the final rule.</span><span class="sxs-lookup"><span data-stu-id="ff068-141">Every Network Security Group has three default rules that are designed to handle the flow of Azure networking traffic, with an explicit `DenyAllInbound` as the final rule.</span></span> <span data-ttu-id="ff068-142">Default ACL rules are given a low priority to not interfere with rules you create.</span><span class="sxs-lookup"><span data-stu-id="ff068-142">Default ACL rules are given a low priority to not interfere with rules you create.</span></span>

## <a name="assigning-network-security-groups"></a><span data-ttu-id="ff068-143">Assigning Network Security Groups</span><span class="sxs-lookup"><span data-stu-id="ff068-143">Assigning Network Security Groups</span></span>
<span data-ttu-id="ff068-144">You assign a Network Security Group to a subnet or a network interface.</span><span class="sxs-lookup"><span data-stu-id="ff068-144">You assign a Network Security Group to a subnet or a network interface.</span></span> <span data-ttu-id="ff068-145">This approach allows you to be as granular as needed when applying your ACL rules to only a specific VM, or ensure a common set of ACL rules are applied to all VMs part of a subnet:</span><span class="sxs-lookup"><span data-stu-id="ff068-145">This approach allows you to be as granular as needed when applying your ACL rules to only a specific VM, or ensure a common set of ACL rules are applied to all VMs part of a subnet:</span></span>

![Apply NSGs to network interfaces or subnets](https://docstestmedia1.blob.core.windows.net/azure-media/includes/media/virtual-machines-common-endpoints-in-resource-manager/apply-nsg-to-resources.png)

<span data-ttu-id="ff068-147">The behavior of the Network Security Group doesn't change depending on being assigned to a subnet or a network interface.</span><span class="sxs-lookup"><span data-stu-id="ff068-147">The behavior of the Network Security Group doesn't change depending on being assigned to a subnet or a network interface.</span></span> <span data-ttu-id="ff068-148">A common deployment scenario has the Network Security Group assigned to a subnet to ensure compliance of all VMs attached to that subnet.</span><span class="sxs-lookup"><span data-stu-id="ff068-148">A common deployment scenario has the Network Security Group assigned to a subnet to ensure compliance of all VMs attached to that subnet.</span></span> <span data-ttu-id="ff068-149">For more information, see [applying Network Security groups to resources](../articles/virtual-network/virtual-networks-nsg.md#associating-nsgs).</span><span class="sxs-lookup"><span data-stu-id="ff068-149">For more information, see [applying Network Security groups to resources](../articles/virtual-network/virtual-networks-nsg.md#associating-nsgs).</span></span>

## <a name="default-behavior-of-network-security-groups"></a><span data-ttu-id="ff068-150">Default behavior of Network Security Groups</span><span class="sxs-lookup"><span data-stu-id="ff068-150">Default behavior of Network Security Groups</span></span>
<span data-ttu-id="ff068-151">Depending on how and when you create your Network Security Group, default rules may be created for Windows VMs to permit RDP access on TCP port 3389.</span><span class="sxs-lookup"><span data-stu-id="ff068-151">Depending on how and when you create your Network Security Group, default rules may be created for Windows VMs to permit RDP access on TCP port 3389.</span></span> <span data-ttu-id="ff068-152">Default rules for Linux VMs permit SSH access on TCP port 22.</span><span class="sxs-lookup"><span data-stu-id="ff068-152">Default rules for Linux VMs permit SSH access on TCP port 22.</span></span> <span data-ttu-id="ff068-153">These automatic ACL rules are created under the following conditions:</span><span class="sxs-lookup"><span data-stu-id="ff068-153">These automatic ACL rules are created under the following conditions:</span></span>

* <span data-ttu-id="ff068-154">If you create a Windows VM through the portal and accept the default action to create a Network Security Group, an ACL rule to allow TCP port 3389 (RDP) is created.</span><span class="sxs-lookup"><span data-stu-id="ff068-154">If you create a Windows VM through the portal and accept the default action to create a Network Security Group, an ACL rule to allow TCP port 3389 (RDP) is created.</span></span>
* <span data-ttu-id="ff068-155">If you create a Linux VM through the portal and accept the default action to create a Network Security Group, an ACL rule to allow TCP port 22 (SSH) is created.</span><span class="sxs-lookup"><span data-stu-id="ff068-155">If you create a Linux VM through the portal and accept the default action to create a Network Security Group, an ACL rule to allow TCP port 22 (SSH) is created.</span></span>

<span data-ttu-id="ff068-156">Under all other conditions, these default ACL rules are not created.</span><span class="sxs-lookup"><span data-stu-id="ff068-156">Under all other conditions, these default ACL rules are not created.</span></span> <span data-ttu-id="ff068-157">You cannot connect to your VM without creating the appropriate ACL rules.</span><span class="sxs-lookup"><span data-stu-id="ff068-157">You cannot connect to your VM without creating the appropriate ACL rules.</span></span> <span data-ttu-id="ff068-158">These conditions include the following common actions:</span><span class="sxs-lookup"><span data-stu-id="ff068-158">These conditions include the following common actions:</span></span>

* <span data-ttu-id="ff068-159">Creating a Network Security Group through the portal as a separate action to creating the VM.</span><span class="sxs-lookup"><span data-stu-id="ff068-159">Creating a Network Security Group through the portal as a separate action to creating the VM.</span></span>
* <span data-ttu-id="ff068-160">Creating a Network Security Group programmatically through PowerShell, Azure CLI, Rest APIs, etc.</span><span class="sxs-lookup"><span data-stu-id="ff068-160">Creating a Network Security Group programmatically through PowerShell, Azure CLI, Rest APIs, etc.</span></span>
* <span data-ttu-id="ff068-161">Creating a VM and assigning it to an existing Network Security Group that does not already have the appropriate ACL rule defined.</span><span class="sxs-lookup"><span data-stu-id="ff068-161">Creating a VM and assigning it to an existing Network Security Group that does not already have the appropriate ACL rule defined.</span></span>

<span data-ttu-id="ff068-162">In all the preceding cases, you need to create ACL rules for your VM to allow the appropriate remote management connections.</span><span class="sxs-lookup"><span data-stu-id="ff068-162">In all the preceding cases, you need to create ACL rules for your VM to allow the appropriate remote management connections.</span></span>

## <a name="default-behavior-of-a-vm-without-a-network-security-group"></a><span data-ttu-id="ff068-163">Default behavior of a VM without a Network Security Group</span><span class="sxs-lookup"><span data-stu-id="ff068-163">Default behavior of a VM without a Network Security Group</span></span>
<span data-ttu-id="ff068-164">You can create a VM without creating a Network Security Group.</span><span class="sxs-lookup"><span data-stu-id="ff068-164">You can create a VM without creating a Network Security Group.</span></span> <span data-ttu-id="ff068-165">In these situations, you can connect to your VM using RDP or SSH without creating any ACL rules.</span><span class="sxs-lookup"><span data-stu-id="ff068-165">In these situations, you can connect to your VM using RDP or SSH without creating any ACL rules.</span></span> <span data-ttu-id="ff068-166">Similarly, if you installed a web service on port 80, that service is automatically accessible remotely.</span><span class="sxs-lookup"><span data-stu-id="ff068-166">Similarly, if you installed a web service on port 80, that service is automatically accessible remotely.</span></span> <span data-ttu-id="ff068-167">The VM has all ports open.</span><span class="sxs-lookup"><span data-stu-id="ff068-167">The VM has all ports open.</span></span>

> [!NOTE]
> <span data-ttu-id="ff068-168">You still need to have a public IP address assigned to a VM in order for any remote connections.</span><span class="sxs-lookup"><span data-stu-id="ff068-168">You still need to have a public IP address assigned to a VM in order for any remote connections.</span></span> <span data-ttu-id="ff068-169">Not having a Network Security Group for the subnet or network interface doesn't expose the VM to any external traffic.</span><span class="sxs-lookup"><span data-stu-id="ff068-169">Not having a Network Security Group for the subnet or network interface doesn't expose the VM to any external traffic.</span></span> <span data-ttu-id="ff068-170">The default action when creating a VM through the portal is to create a new public IP.</span><span class="sxs-lookup"><span data-stu-id="ff068-170">The default action when creating a VM through the portal is to create a new public IP.</span></span> <span data-ttu-id="ff068-171">For all other forms of creating a VM such as PowerShell, Azure CLI, or Resource Manager template, a public IP is not automatically created unless explicitly requested.</span><span class="sxs-lookup"><span data-stu-id="ff068-171">For all other forms of creating a VM such as PowerShell, Azure CLI, or Resource Manager template, a public IP is not automatically created unless explicitly requested.</span></span> <span data-ttu-id="ff068-172">The default action through the portal is also to create a Network Security Group.</span><span class="sxs-lookup"><span data-stu-id="ff068-172">The default action through the portal is also to create a Network Security Group.</span></span> <span data-ttu-id="ff068-173">This default action means you shouldn't end up in a situation with an exposed VM that has no network filtering in place.</span><span class="sxs-lookup"><span data-stu-id="ff068-173">This default action means you shouldn't end up in a situation with an exposed VM that has no network filtering in place.</span></span>

## <a name="understanding-load-balancers-and-nat-rules"></a><span data-ttu-id="ff068-174">Understanding Load Balancers and NAT rules</span><span class="sxs-lookup"><span data-stu-id="ff068-174">Understanding Load Balancers and NAT rules</span></span>
<span data-ttu-id="ff068-175">In the Classic deployment model, you could create endpoints that also performed port forwarding.</span><span class="sxs-lookup"><span data-stu-id="ff068-175">In the Classic deployment model, you could create endpoints that also performed port forwarding.</span></span> <span data-ttu-id="ff068-176">When you create a VM in the Classic deployment model, ACL rules for RDP or SSH would be automatically created.</span><span class="sxs-lookup"><span data-stu-id="ff068-176">When you create a VM in the Classic deployment model, ACL rules for RDP or SSH would be automatically created.</span></span> <span data-ttu-id="ff068-177">These rules would not expose TCP port 3389 or TCP port 22 respectively to the outside world.</span><span class="sxs-lookup"><span data-stu-id="ff068-177">These rules would not expose TCP port 3389 or TCP port 22 respectively to the outside world.</span></span> <span data-ttu-id="ff068-178">Instead, a high-value TCP port would be exposed that maps to the appropriate internal port.</span><span class="sxs-lookup"><span data-stu-id="ff068-178">Instead, a high-value TCP port would be exposed that maps to the appropriate internal port.</span></span> <span data-ttu-id="ff068-179">You could also create your own ACL rules in a similar manner, such as expose a webserver on TCP port 4280 to the outside world.</span><span class="sxs-lookup"><span data-stu-id="ff068-179">You could also create your own ACL rules in a similar manner, such as expose a webserver on TCP port 4280 to the outside world.</span></span> <span data-ttu-id="ff068-180">You can see these ACL rules and port mappings in the following screenshot from the Classic portal:</span><span class="sxs-lookup"><span data-stu-id="ff068-180">You can see these ACL rules and port mappings in the following screenshot from the Classic portal:</span></span>

![Port-forwarding with Classic endpoints](https://docstestmedia1.blob.core.windows.net/azure-media/includes/media/virtual-machines-common-endpoints-in-resource-manager/classic-endpoints-port-forwarding.png)

<span data-ttu-id="ff068-182">With Network Security Groups, that port-forwarding function is handled by a load balancer.</span><span class="sxs-lookup"><span data-stu-id="ff068-182">With Network Security Groups, that port-forwarding function is handled by a load balancer.</span></span> <span data-ttu-id="ff068-183">For more information, see [load balancers in Azure](../articles/load-balancer/load-balancer-overview.md).</span><span class="sxs-lookup"><span data-stu-id="ff068-183">For more information, see [load balancers in Azure](../articles/load-balancer/load-balancer-overview.md).</span></span> <span data-ttu-id="ff068-184">The following example shows a load balancer with a NAT rule to perform port-forwarding TCP port 4222 to the internal TCP port 22 a VM:</span><span class="sxs-lookup"><span data-stu-id="ff068-184">The following example shows a load balancer with a NAT rule to perform port-forwarding TCP port 4222 to the internal TCP port 22 a VM:</span></span>

![Load balancer NAT rules for port-forwarding](https://docstestmedia1.blob.core.windows.net/azure-media/includes/media/virtual-machines-common-endpoints-in-resource-manager/load-balancer-nat-rules.png)

> [!NOTE]
> <span data-ttu-id="ff068-186">When you implement a load balancer, you typically don't assign the VM itself a public IP address.</span><span class="sxs-lookup"><span data-stu-id="ff068-186">When you implement a load balancer, you typically don't assign the VM itself a public IP address.</span></span> <span data-ttu-id="ff068-187">Instead, the load balancer has a public IP address assigned to it.</span><span class="sxs-lookup"><span data-stu-id="ff068-187">Instead, the load balancer has a public IP address assigned to it.</span></span> <span data-ttu-id="ff068-188">You still need to create your Network Security Group and ACL rules to define the flow of traffic in and out of your VM.</span><span class="sxs-lookup"><span data-stu-id="ff068-188">You still need to create your Network Security Group and ACL rules to define the flow of traffic in and out of your VM.</span></span> <span data-ttu-id="ff068-189">The load balancer NAT rules are simply to define what ports are allowed through the load balancer and how they get distributed across the backend VMs.</span><span class="sxs-lookup"><span data-stu-id="ff068-189">The load balancer NAT rules are simply to define what ports are allowed through the load balancer and how they get distributed across the backend VMs.</span></span> <span data-ttu-id="ff068-190">As such, you need to create a NAT rule for traffic to flow through the load balancer.</span><span class="sxs-lookup"><span data-stu-id="ff068-190">As such, you need to create a NAT rule for traffic to flow through the load balancer.</span></span> <span data-ttu-id="ff068-191">To allow the traffic to reach the VM, create a Network Security Group ACL rule.</span><span class="sxs-lookup"><span data-stu-id="ff068-191">To allow the traffic to reach the VM, create a Network Security Group ACL rule.</span></span>




