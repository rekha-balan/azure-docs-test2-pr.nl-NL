---
title: Configure your account for offline streaming of Widevine protected content - Azure
description: This topic shows how to configure your Azure Media Services account for offline streaming of Widevine protected content.
services: media-services
keywords: DASH, DRM, Widevine Offline Mode, ExoPlayer, Android
documentationcenter: ''
author: willzhan
manager: steveng
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/10/2017
ms.author: willzhan, dwgeo
ms.openlocfilehash: 158b58c13aee4d6241900db4a5e2b3fe8a45cc3c
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44865171"
---
# <a name="offline-widevine-streaming-for-android"></a><span data-ttu-id="25ace-104">Offline Widevine streaming for Android</span><span class="sxs-lookup"><span data-stu-id="25ace-104">Offline Widevine streaming for Android</span></span>

<span data-ttu-id="25ace-105">In addition to protecting content for online streaming, media content subscription and rental services offer downloadable content that works when you are not connected to the internet.</span><span class="sxs-lookup"><span data-stu-id="25ace-105">In addition to protecting content for online streaming, media content subscription and rental services offer downloadable content that works when you are not connected to the internet.</span></span> <span data-ttu-id="25ace-106">You might need to download content onto your phone or tablet for playback in airplane mode when flying disconnected from the network.</span><span class="sxs-lookup"><span data-stu-id="25ace-106">You might need to download content onto your phone or tablet for playback in airplane mode when flying disconnected from the network.</span></span> <span data-ttu-id="25ace-107">Additional scenarios, in which you might want to download content:</span><span class="sxs-lookup"><span data-stu-id="25ace-107">Additional scenarios, in which you might want to download content:</span></span>

- <span data-ttu-id="25ace-108">Some content providers may disallow DRM license delivery beyond a country's border.</span><span class="sxs-lookup"><span data-stu-id="25ace-108">Some content providers may disallow DRM license delivery beyond a country's border.</span></span> <span data-ttu-id="25ace-109">If a user wants to watch content while traveling abroad, offline download is needed.</span><span class="sxs-lookup"><span data-stu-id="25ace-109">If a user wants to watch content while traveling abroad, offline download is needed.</span></span>
- <span data-ttu-id="25ace-110">In some countries, Internet availability and/or bandwidth is limited.</span><span class="sxs-lookup"><span data-stu-id="25ace-110">In some countries, Internet availability and/or bandwidth is limited.</span></span> <span data-ttu-id="25ace-111">Users may choose to download content to be able to watch it in high enough resolution for satisfactory viewing experience.</span><span class="sxs-lookup"><span data-stu-id="25ace-111">Users may choose to download content to be able to watch it in high enough resolution for satisfactory viewing experience.</span></span>

<span data-ttu-id="25ace-112">This article discusses how to implement offline mode playback for DASH content protected by Widevine on Android devices.</span><span class="sxs-lookup"><span data-stu-id="25ace-112">This article discusses how to implement offline mode playback for DASH content protected by Widevine on Android devices.</span></span> <span data-ttu-id="25ace-113">Offline DRM allows you to provide subscription, rental, and purchase models for your content, enabling customers of your services to easily take content with them when disconnected from the internet.</span><span class="sxs-lookup"><span data-stu-id="25ace-113">Offline DRM allows you to provide subscription, rental, and purchase models for your content, enabling customers of your services to easily take content with them when disconnected from the internet.</span></span>

<span data-ttu-id="25ace-114">For building the Android player apps, we outline three options:</span><span class="sxs-lookup"><span data-stu-id="25ace-114">For building the Android player apps, we outline three options:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="25ace-115">Build a player using the Java API of ExoPlayer SDK</span><span class="sxs-lookup"><span data-stu-id="25ace-115">Build a player using the Java API of ExoPlayer SDK</span></span>
> * <span data-ttu-id="25ace-116">Build a player using Xamarin binding of ExoPlayer SDK</span><span class="sxs-lookup"><span data-stu-id="25ace-116">Build a player using Xamarin binding of ExoPlayer SDK</span></span>
> * <span data-ttu-id="25ace-117">Build a player using Encrypted Media Extension (EME) and Media Source Extension (MSE) in Chrome mobile browser v62 or later</span><span class="sxs-lookup"><span data-stu-id="25ace-117">Build a player using Encrypted Media Extension (EME) and Media Source Extension (MSE) in Chrome mobile browser v62 or later</span></span>

<span data-ttu-id="25ace-118">The article also answers some common questions related to offline streaming of Widevine protected content.</span><span class="sxs-lookup"><span data-stu-id="25ace-118">The article also answers some common questions related to offline streaming of Widevine protected content.</span></span>

## <a name="requirements"></a><span data-ttu-id="25ace-119">Requirements</span><span class="sxs-lookup"><span data-stu-id="25ace-119">Requirements</span></span> 

<span data-ttu-id="25ace-120">Before implementing offline DRM for Widevine on Android devices, you should first:</span><span class="sxs-lookup"><span data-stu-id="25ace-120">Before implementing offline DRM for Widevine on Android devices, you should first:</span></span>

- <span data-ttu-id="25ace-121">Become familiar with the concepts introduced for online content protection using Widevine DRM.</span><span class="sxs-lookup"><span data-stu-id="25ace-121">Become familiar with the concepts introduced for online content protection using Widevine DRM.</span></span> <span data-ttu-id="25ace-122">This is covered in detail in the following documents/samples:</span><span class="sxs-lookup"><span data-stu-id="25ace-122">This is covered in detail in the following documents/samples:</span></span>
    - [<span data-ttu-id="25ace-123">Use Azure Media Services to deliver DRM licenses or AES keys</span><span class="sxs-lookup"><span data-stu-id="25ace-123">Use Azure Media Services to deliver DRM licenses or AES keys</span></span>](media-services-deliver-keys-and-licenses.md)
    - [<span data-ttu-id="25ace-124">CENC with Multi-DRM and Access Control: A Reference Design and Implementation on Azure and Azure Media Services</span><span class="sxs-lookup"><span data-stu-id="25ace-124">CENC with Multi-DRM and Access Control: A Reference Design and Implementation on Azure and Azure Media Services</span></span>](media-services-cenc-with-multidrm-access-control.md)
    - [<span data-ttu-id="25ace-125">Using PlayReady and/or Widevine Dynamic Common Encryption with .NET</span><span class="sxs-lookup"><span data-stu-id="25ace-125">Using PlayReady and/or Widevine Dynamic Common Encryption with .NET</span></span>](https://azure.microsoft.com/resources/samples/media-services-dotnet-dynamic-encryption-with-drm/)
    - [<span data-ttu-id="25ace-126">Use Azure Media Services to deliver PlayReady and/or Widevine licenses with .NET</span><span class="sxs-lookup"><span data-stu-id="25ace-126">Use Azure Media Services to deliver PlayReady and/or Widevine licenses with .NET</span></span>](https://azure.microsoft.com/resources/samples/media-services-dotnet-deliver-playready-widevine-licenses/)
- <span data-ttu-id="25ace-127">Become familiar with the Google ExoPlayer SDK for Android, an open-source video player SDK capable of supporting offline Widevine DRM playback.</span><span class="sxs-lookup"><span data-stu-id="25ace-127">Become familiar with the Google ExoPlayer SDK for Android, an open-source video player SDK capable of supporting offline Widevine DRM playback.</span></span> 
    - [<span data-ttu-id="25ace-128">ExoPlayer SDK</span><span class="sxs-lookup"><span data-stu-id="25ace-128">ExoPlayer SDK</span></span>](https://github.com/google/ExoPlayer)
    - [<span data-ttu-id="25ace-129">ExoPlayer Developer Guide</span><span class="sxs-lookup"><span data-stu-id="25ace-129">ExoPlayer Developer Guide</span></span>](https://google.github.io/ExoPlayer/guide.html)
    - [<span data-ttu-id="25ace-130">EoPlayer Developer Blog</span><span class="sxs-lookup"><span data-stu-id="25ace-130">EoPlayer Developer Blog</span></span>](https://medium.com/google-exoplayer)

## <a name="content-protection-configuration-in-azure-media-services"></a><span data-ttu-id="25ace-131">Content protection configuration in Azure Media Services</span><span class="sxs-lookup"><span data-stu-id="25ace-131">Content protection configuration in Azure Media Services</span></span>

<span data-ttu-id="25ace-132">When you configure Widevine protection of an asset in Media Services, you need to create ContentKeyAuthorizationPolicyOption which specified the following three things:</span><span class="sxs-lookup"><span data-stu-id="25ace-132">When you configure Widevine protection of an asset in Media Services, you need to create ContentKeyAuthorizationPolicyOption which specified the following three things:</span></span>

1. <span data-ttu-id="25ace-133">DRM system (Widevine)</span><span class="sxs-lookup"><span data-stu-id="25ace-133">DRM system (Widevine)</span></span>
2. <span data-ttu-id="25ace-134">ContentKeyAuthorizationPolicyRestriction specifying how content key delivery is authorized in license delivery service (Open or token authorization)</span><span class="sxs-lookup"><span data-stu-id="25ace-134">ContentKeyAuthorizationPolicyRestriction specifying how content key delivery is authorized in license delivery service (Open or token authorization)</span></span>
3. <span data-ttu-id="25ace-135">DRM (Widevine) license template</span><span class="sxs-lookup"><span data-stu-id="25ace-135">DRM (Widevine) license template</span></span>

<span data-ttu-id="25ace-136">To enable **offline** mode for Widevine licenses, you need to configure [Widevine license template](media-services-widevine-license-template-overview.md).</span><span class="sxs-lookup"><span data-stu-id="25ace-136">To enable **offline** mode for Widevine licenses, you need to configure [Widevine license template](media-services-widevine-license-template-overview.md).</span></span> <span data-ttu-id="25ace-137">In the **policy_overrides** object, set the **can_persist** property to **true** (default is false).</span><span class="sxs-lookup"><span data-stu-id="25ace-137">In the **policy_overrides** object, set the **can_persist** property to **true** (default is false).</span></span> 

<span data-ttu-id="25ace-138">The following code sample uses .NET to enable **offline** mode for Widevine licenses.</span><span class="sxs-lookup"><span data-stu-id="25ace-138">The following code sample uses .NET to enable **offline** mode for Widevine licenses.</span></span> <span data-ttu-id="25ace-139">The code is based on the [ Using PlayReady and/or Widevine Dynamic Common Encryption with .NET](https://github.com/Azure-Samples/media-services-dotnet-dynamic-encryption-with-drm) sample.</span><span class="sxs-lookup"><span data-stu-id="25ace-139">The code is based on the [ Using PlayReady and/or Widevine Dynamic Common Encryption with .NET](https://github.com/Azure-Samples/media-services-dotnet-dynamic-encryption-with-drm) sample.</span></span> 

```
private static string ConfigureWidevineLicenseTemplateOffline(Uri keyDeliveryUrl)
{
    var template = new WidevineMessage
    {
        allowed_track_types = AllowedTrackTypes.SD_HD,
        content_key_specs = new[]
        {
            new ContentKeySpecs
            {
                required_output_protection = new RequiredOutputProtection { hdcp = Hdcp.HDCP_NONE},
                security_level = 1,
                track_type = "SD"
            }
        },
        policy_overrides = new
        {
            can_play = true,
            can_persist = true,
            //can_renew = true,                             //if you set can_renew = false, you do not need renewal_server_url
            //renewal_server_url = keyDeliveryUrl.ToString(),   //not mandatory, renewal_server_url is needed only if license_duration_seconds is set
            can_renew = false,
            //rental_duration_seconds = 1209600,
            //playback_duration_seconds = 1209600,
            //license_duration_seconds = 1209600
        }
        };

    string configuration = Newtonsoft.Json.JsonConvert.SerializeObject(template);
    return configuration;
}
```

## <a name="configuring-the-android-player-for-offline-playback"></a><span data-ttu-id="25ace-140">Configuring the Android player for offline playback</span><span class="sxs-lookup"><span data-stu-id="25ace-140">Configuring the Android player for offline playback</span></span>

<span data-ttu-id="25ace-141">The easiest way to develop a native player app for Android devices is to use the [Google ExoPlayer SDK](https://github.com/google/ExoPlayer), an open-source video player SDK.</span><span class="sxs-lookup"><span data-stu-id="25ace-141">The easiest way to develop a native player app for Android devices is to use the [Google ExoPlayer SDK](https://github.com/google/ExoPlayer), an open-source video player SDK.</span></span> <span data-ttu-id="25ace-142">ExoPlayer supports features not currently supported by Android’s native MediaPlayer API, including MPEG-DASH and Microsoft Smooth Streaming delivery protocols.</span><span class="sxs-lookup"><span data-stu-id="25ace-142">ExoPlayer supports features not currently supported by Android’s native MediaPlayer API, including MPEG-DASH and Microsoft Smooth Streaming delivery protocols.</span></span>

<span data-ttu-id="25ace-143">ExoPlayer version 2.6 and higher includes many classes that support offline Widevine DRM playback.</span><span class="sxs-lookup"><span data-stu-id="25ace-143">ExoPlayer version 2.6 and higher includes many classes that support offline Widevine DRM playback.</span></span> <span data-ttu-id="25ace-144">In particular, the OfflineLicenseHelper class provides utility functions to facilitate the use of the DefaultDrmSessionManager for downloading, renewing, and releasing offline licenses.</span><span class="sxs-lookup"><span data-stu-id="25ace-144">In particular, the OfflineLicenseHelper class provides utility functions to facilitate the use of the DefaultDrmSessionManager for downloading, renewing, and releasing offline licenses.</span></span> <span data-ttu-id="25ace-145">The classes provided in the SDK folder "library/core/src/main/java/com/google/android/exoplayer2/offline/" support offline video content downloading.</span><span class="sxs-lookup"><span data-stu-id="25ace-145">The classes provided in the SDK folder "library/core/src/main/java/com/google/android/exoplayer2/offline/" support offline video content downloading.</span></span>

<span data-ttu-id="25ace-146">The following list of classes facilitate offline mode in the ExoPlayer SDK for Android:</span><span class="sxs-lookup"><span data-stu-id="25ace-146">The following list of classes facilitate offline mode in the ExoPlayer SDK for Android:</span></span>

- <span data-ttu-id="25ace-147">library/core/src/main/java/com/google/android/exoplayer2/drm/OfflineLicenseHelper.java</span><span class="sxs-lookup"><span data-stu-id="25ace-147">library/core/src/main/java/com/google/android/exoplayer2/drm/OfflineLicenseHelper.java</span></span>  
- <span data-ttu-id="25ace-148">library/core/src/main/java/com/google/android/exoplayer2/drm/DefaultDrmSession.java</span><span class="sxs-lookup"><span data-stu-id="25ace-148">library/core/src/main/java/com/google/android/exoplayer2/drm/DefaultDrmSession.java</span></span>
- <span data-ttu-id="25ace-149">library/core/src/main/java/com/google/android/exoplayer2/drm/DefaultDrmSessionManager.java</span><span class="sxs-lookup"><span data-stu-id="25ace-149">library/core/src/main/java/com/google/android/exoplayer2/drm/DefaultDrmSessionManager.java</span></span>
- <span data-ttu-id="25ace-150">library/core/src/main/java/com/google/android/exoplayer2/drm/DrmSession.java</span><span class="sxs-lookup"><span data-stu-id="25ace-150">library/core/src/main/java/com/google/android/exoplayer2/drm/DrmSession.java</span></span>
- <span data-ttu-id="25ace-151">library/core/src/main/java/com/google/android/exoplayer2/drm/ErrorStateDrmSession.java</span><span class="sxs-lookup"><span data-stu-id="25ace-151">library/core/src/main/java/com/google/android/exoplayer2/drm/ErrorStateDrmSession.java</span></span>
- <span data-ttu-id="25ace-152">library/core/src/main/java/com/google/android/exoplayer2/drm/ExoMediaDrm.java</span><span class="sxs-lookup"><span data-stu-id="25ace-152">library/core/src/main/java/com/google/android/exoplayer2/drm/ExoMediaDrm.java</span></span>
- <span data-ttu-id="25ace-153">library/core/src/main/java/com/google/android/exoplayer2/offline/SegmentDownloader.java</span><span class="sxs-lookup"><span data-stu-id="25ace-153">library/core/src/main/java/com/google/android/exoplayer2/offline/SegmentDownloader.java</span></span>
- <span data-ttu-id="25ace-154">library/core/src/main/java/com/google/android/exoplayer2/offline/DownloaderConstructorHelper.java</span><span class="sxs-lookup"><span data-stu-id="25ace-154">library/core/src/main/java/com/google/android/exoplayer2/offline/DownloaderConstructorHelper.java</span></span> 
- <span data-ttu-id="25ace-155">library/core/src/main/java/com/google/android/exoplayer2/offline/Downloader.java</span><span class="sxs-lookup"><span data-stu-id="25ace-155">library/core/src/main/java/com/google/android/exoplayer2/offline/Downloader.java</span></span>
- <span data-ttu-id="25ace-156">library/dash/src/main/java/com/google/android/exoplayer2/source/dash/offline/DashDownloader.java</span><span class="sxs-lookup"><span data-stu-id="25ace-156">library/dash/src/main/java/com/google/android/exoplayer2/source/dash/offline/DashDownloader.java</span></span> 

<span data-ttu-id="25ace-157">Developers should reference the [ExoPlayer Developer Guide](https://google.github.io/ExoPlayer/guide.html) and the corresponding [Developer Blog](https://medium.com/google-exoplayer) during development of an application.</span><span class="sxs-lookup"><span data-stu-id="25ace-157">Developers should reference the [ExoPlayer Developer Guide](https://google.github.io/ExoPlayer/guide.html) and the corresponding [Developer Blog](https://medium.com/google-exoplayer) during development of an application.</span></span> <span data-ttu-id="25ace-158">Google has not released a fully documented reference implementation or sample code for the ExoPlayer app supporting Widevine offline at this time, so the information is limited to the developers guide and blog.</span><span class="sxs-lookup"><span data-stu-id="25ace-158">Google has not released a fully documented reference implementation or sample code for the ExoPlayer app supporting Widevine offline at this time, so the information is limited to the developers guide and blog.</span></span> 

### <a name="working-with-older-android-devices"></a><span data-ttu-id="25ace-159">Working with older Android devices</span><span class="sxs-lookup"><span data-stu-id="25ace-159">Working with older Android devices</span></span>

<span data-ttu-id="25ace-160">For some older Android devices, you must set values for the following **policy_overrides** properties (defined in [Widevine license template](media-services-widevine-license-template-overview.md): **rental_duration_seconds**, **playback_duration_seconds**, and **license_duration_seconds**.</span><span class="sxs-lookup"><span data-stu-id="25ace-160">For some older Android devices, you must set values for the following **policy_overrides** properties (defined in [Widevine license template](media-services-widevine-license-template-overview.md): **rental_duration_seconds**, **playback_duration_seconds**, and **license_duration_seconds**.</span></span> <span data-ttu-id="25ace-161">Alternatively, you can set them to zero, which means infinite/unlimited duration.</span><span class="sxs-lookup"><span data-stu-id="25ace-161">Alternatively, you can set them to zero, which means infinite/unlimited duration.</span></span>  

<span data-ttu-id="25ace-162">The values must be set to avoid an integer overflow bug.</span><span class="sxs-lookup"><span data-stu-id="25ace-162">The values must be set to avoid an integer overflow bug.</span></span> <span data-ttu-id="25ace-163">For more explanation about the issue, see https://github.com/google/ExoPlayer/issues/3150 and https://github.com/google/ExoPlayer/issues/3112.</span><span class="sxs-lookup"><span data-stu-id="25ace-163">For more explanation about the issue, see https://github.com/google/ExoPlayer/issues/3150 and https://github.com/google/ExoPlayer/issues/3112.</span></span> <br/><span data-ttu-id="25ace-164">If you do not set the values explicitly, very large values for  **PlaybackDurationRemaining** and **LicenseDurationRemaining** will be assigned, (for example, 9223372036854775807, which is the maximum positive value for a 64-bit integer).</span><span class="sxs-lookup"><span data-stu-id="25ace-164">If you do not set the values explicitly, very large values for  **PlaybackDurationRemaining** and **LicenseDurationRemaining** will be assigned, (for example, 9223372036854775807, which is the maximum positive value for a 64-bit integer).</span></span> <span data-ttu-id="25ace-165">As a result, the Widevine license appears expired and hence the decryption will not happen.</span><span class="sxs-lookup"><span data-stu-id="25ace-165">As a result, the Widevine license appears expired and hence the decryption will not happen.</span></span> 

<span data-ttu-id="25ace-166">This issue does not occur on Android 5.0 Lollipop or later since Android 5.0 is the first Android version, which has been designed to fully support ARMv8 ([Advanced RISC Machine](https://en.wikipedia.org/wiki/ARM_architecture)) and 64-bit platforms, while Android 4.4 KitKat was originally designed to support  ARMv7 and 32-bit platforms as with other older Android versions.</span><span class="sxs-lookup"><span data-stu-id="25ace-166">This issue does not occur on Android 5.0 Lollipop or later since Android 5.0 is the first Android version, which has been designed to fully support ARMv8 ([Advanced RISC Machine](https://en.wikipedia.org/wiki/ARM_architecture)) and 64-bit platforms, while Android 4.4 KitKat was originally designed to support  ARMv7 and 32-bit platforms as with other older Android versions.</span></span>

## <a name="using-xamarin-to-build-an-android-playback-app"></a><span data-ttu-id="25ace-167">Using Xamarin to build an Android playback app</span><span class="sxs-lookup"><span data-stu-id="25ace-167">Using Xamarin to build an Android playback app</span></span>

<span data-ttu-id="25ace-168">You can find Xamarin bindings for ExoPlayer using the following links:</span><span class="sxs-lookup"><span data-stu-id="25ace-168">You can find Xamarin bindings for ExoPlayer using the following links:</span></span>

- [<span data-ttu-id="25ace-169">Xamarin bindings library for the Google ExoPlayer library</span><span class="sxs-lookup"><span data-stu-id="25ace-169">Xamarin bindings library for the Google ExoPlayer library</span></span>](https://github.com/martijn00/ExoPlayerXamarin)
- [<span data-ttu-id="25ace-170">Xamarin bindings for ExoPlayer NuGet</span><span class="sxs-lookup"><span data-stu-id="25ace-170">Xamarin bindings for ExoPlayer NuGet</span></span>](https://www.nuget.org/packages/Xam.Plugins.Android.ExoPlayer/)

<span data-ttu-id="25ace-171">Also, see the following thread: [Xamarin binding](https://github.com/martijn00/ExoPlayerXamarin/pull/57).</span><span class="sxs-lookup"><span data-stu-id="25ace-171">Also, see the following thread: [Xamarin binding](https://github.com/martijn00/ExoPlayerXamarin/pull/57).</span></span> 

## <a name="chrome-player-apps-for-android"></a><span data-ttu-id="25ace-172">Chrome player apps for Android</span><span class="sxs-lookup"><span data-stu-id="25ace-172">Chrome player apps for Android</span></span>

<span data-ttu-id="25ace-173">Starting with the release of [Chrome for Android v. 62](https://developers.google.com/web/updates/2017/09/chrome-62-media-updates), persistent license in EME is supported.</span><span class="sxs-lookup"><span data-stu-id="25ace-173">Starting with the release of [Chrome for Android v. 62](https://developers.google.com/web/updates/2017/09/chrome-62-media-updates), persistent license in EME is supported.</span></span> <span data-ttu-id="25ace-174">[Widevine L1](https://developers.google.com/web/updates/2017/09/chrome-62-media-updates#widevine_l1) is now also supported in Chrome for Android.</span><span class="sxs-lookup"><span data-stu-id="25ace-174">[Widevine L1](https://developers.google.com/web/updates/2017/09/chrome-62-media-updates#widevine_l1) is now also supported in Chrome for Android.</span></span> <span data-ttu-id="25ace-175">This allows you to create offline playback applications in Chrome if your end users have this (or higher) version of Chrome.</span><span class="sxs-lookup"><span data-stu-id="25ace-175">This allows you to create offline playback applications in Chrome if your end users have this (or higher) version of Chrome.</span></span> 

<span data-ttu-id="25ace-176">In addition, Google has produced a Progressive Web App (PWA) sample and open-sourced it:</span><span class="sxs-lookup"><span data-stu-id="25ace-176">In addition, Google has produced a Progressive Web App (PWA) sample and open-sourced it:</span></span> 

- [<span data-ttu-id="25ace-177">Source code</span><span class="sxs-lookup"><span data-stu-id="25ace-177">Source code</span></span>](https://github.com/GoogleChromeLabs/sample-media-pwa)
- <span data-ttu-id="25ace-178">[Google hosted version](https://biograf-155113.appspot.com/ttt/episode-2/) (only works in Chrome v 62 and higher on Android devices)</span><span class="sxs-lookup"><span data-stu-id="25ace-178">[Google hosted version](https://biograf-155113.appspot.com/ttt/episode-2/) (only works in Chrome v 62 and higher on Android devices)</span></span>

<span data-ttu-id="25ace-179">If you upgrade your mobile Chrome browser to v62 (or higher) on an Android phone and test the above hosted sample app, you will see that both online streaming and offline playback work.</span><span class="sxs-lookup"><span data-stu-id="25ace-179">If you upgrade your mobile Chrome browser to v62 (or higher) on an Android phone and test the above hosted sample app, you will see that both online streaming and offline playback work.</span></span>

<span data-ttu-id="25ace-180">The above open-source PWA app is authored in Node.js.</span><span class="sxs-lookup"><span data-stu-id="25ace-180">The above open-source PWA app is authored in Node.js.</span></span> <span data-ttu-id="25ace-181">If you want to host your own version on an Ubuntu server, keep in mind the following common encountered issues that can prevent playback:</span><span class="sxs-lookup"><span data-stu-id="25ace-181">If you want to host your own version on an Ubuntu server, keep in mind the following common encountered issues that can prevent playback:</span></span>

1. <span data-ttu-id="25ace-182">CORS issue: The sample video in the sample app is hosted in https://storage.googleapis.com/biograf-video-files/videos/.</span><span class="sxs-lookup"><span data-stu-id="25ace-182">CORS issue: The sample video in the sample app is hosted in https://storage.googleapis.com/biograf-video-files/videos/.</span></span> <span data-ttu-id="25ace-183">Google has set up CORS for all their test samples hosted in Google Cloud Storage bucket.</span><span class="sxs-lookup"><span data-stu-id="25ace-183">Google has set up CORS for all their test samples hosted in Google Cloud Storage bucket.</span></span> <span data-ttu-id="25ace-184">They are served with CORS headers, specifying explicitly the CORS entry: https://biograf-155113.appspot.com (the domain in which google hosts their sample) preventing access by any other sites.</span><span class="sxs-lookup"><span data-stu-id="25ace-184">They are served with CORS headers, specifying explicitly the CORS entry: https://biograf-155113.appspot.com (the domain in which google hosts their sample) preventing access by any other sites.</span></span> <span data-ttu-id="25ace-185">If you try, you will see the following HTTP error: Failed to load https://storage.googleapis.com/biograf-video-files/videos/poly-sizzle-2015/mp4/dash.mpd: No 'Access-Control-Allow-Origin' header is present on the requested resource.</span><span class="sxs-lookup"><span data-stu-id="25ace-185">If you try, you will see the following HTTP error: Failed to load https://storage.googleapis.com/biograf-video-files/videos/poly-sizzle-2015/mp4/dash.mpd: No 'Access-Control-Allow-Origin' header is present on the requested resource.</span></span> <span data-ttu-id="25ace-186">Origin 'https://13.85.80.81:8080' is therefore not allowed access.</span><span class="sxs-lookup"><span data-stu-id="25ace-186">Origin 'https://13.85.80.81:8080' is therefore not allowed access.</span></span> <span data-ttu-id="25ace-187">If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span><span class="sxs-lookup"><span data-stu-id="25ace-187">If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span></span>
2. <span data-ttu-id="25ace-188">Certificate issue: Starting from Chrome v 58, EME for Widevine requires HTTPS.</span><span class="sxs-lookup"><span data-stu-id="25ace-188">Certificate issue: Starting from Chrome v 58, EME for Widevine requires HTTPS.</span></span> <span data-ttu-id="25ace-189">Therefore, you need to host the sample app over HTTPS with an X509 certificate.</span><span class="sxs-lookup"><span data-stu-id="25ace-189">Therefore, you need to host the sample app over HTTPS with an X509 certificate.</span></span> <span data-ttu-id="25ace-190">A usual test certificate does not work due to the following requirements: You need to obtain a certificate meeting the following minimum requirements:</span><span class="sxs-lookup"><span data-stu-id="25ace-190">A usual test certificate does not work due to the following requirements: You need to obtain a certificate meeting the following minimum requirements:</span></span>
    - <span data-ttu-id="25ace-191">Chrome and Firefox require SAN-Subject Alternative Name setting to exist in the certificate</span><span class="sxs-lookup"><span data-stu-id="25ace-191">Chrome and Firefox require SAN-Subject Alternative Name setting to exist in the certificate</span></span>
    - <span data-ttu-id="25ace-192">The certificate must have trusted CA and a self-signed development certificate does not work</span><span class="sxs-lookup"><span data-stu-id="25ace-192">The certificate must have trusted CA and a self-signed development certificate does not work</span></span>
    - <span data-ttu-id="25ace-193">The certificate must have a CN matching the DNS name of the web server or gateway</span><span class="sxs-lookup"><span data-stu-id="25ace-193">The certificate must have a CN matching the DNS name of the web server or gateway</span></span>

## <a name="frequently-asked-questions"></a><span data-ttu-id="25ace-194">Frequently asked questions</span><span class="sxs-lookup"><span data-stu-id="25ace-194">Frequently asked questions</span></span>

### <a name="question"></a><span data-ttu-id="25ace-195">Question</span><span class="sxs-lookup"><span data-stu-id="25ace-195">Question</span></span>

<span data-ttu-id="25ace-196">How can I deliver persistent licenses (offline-enabled) for some clients/users and non-persistent licenses (offline-disabled) for others?</span><span class="sxs-lookup"><span data-stu-id="25ace-196">How can I deliver persistent licenses (offline-enabled) for some clients/users and non-persistent licenses (offline-disabled) for others?</span></span> <span data-ttu-id="25ace-197">Do I have to duplicate the content and use separate content key?</span><span class="sxs-lookup"><span data-stu-id="25ace-197">Do I have to duplicate the content and use separate content key?</span></span>

### <a name="answer"></a><span data-ttu-id="25ace-198">Answer</span><span class="sxs-lookup"><span data-stu-id="25ace-198">Answer</span></span>
<span data-ttu-id="25ace-199">You do not need to duplicate the content.</span><span class="sxs-lookup"><span data-stu-id="25ace-199">You do not need to duplicate the content.</span></span> <span data-ttu-id="25ace-200">You can simply use a single copy of the content and a single ContentKeyAuthorizationPolicy, but two separate ContentKeyAuthorizationPolicyOption’s:</span><span class="sxs-lookup"><span data-stu-id="25ace-200">You can simply use a single copy of the content and a single ContentKeyAuthorizationPolicy, but two separate ContentKeyAuthorizationPolicyOption’s:</span></span>

1. <span data-ttu-id="25ace-201">IContentKeyAuthorizationPolicyOption 1: uses persistent license, and ContentKeyAuthorizationPolicyRestriction 1 which contains a claim such as license_type = “Persistent”</span><span class="sxs-lookup"><span data-stu-id="25ace-201">IContentKeyAuthorizationPolicyOption 1: uses persistent license, and ContentKeyAuthorizationPolicyRestriction 1 which contains a claim such as license_type = “Persistent”</span></span>
2. <span data-ttu-id="25ace-202">IContentKeyAuthorizationPolicyOption 2: uses non-persistent license, and ContentKeyAuthorizationPolicyRestriction 2 which contains a claim such as license_type = “Nonpersistent”</span><span class="sxs-lookup"><span data-stu-id="25ace-202">IContentKeyAuthorizationPolicyOption 2: uses non-persistent license, and ContentKeyAuthorizationPolicyRestriction 2 which contains a claim such as license_type = “Nonpersistent”</span></span>

<span data-ttu-id="25ace-203">This way, when a license request comes in from the client app, from license request there is no difference.</span><span class="sxs-lookup"><span data-stu-id="25ace-203">This way, when a license request comes in from the client app, from license request there is no difference.</span></span> <span data-ttu-id="25ace-204">However, for different end user/device, the STS should have the business logic to issue different JWT tokens containing different claims (one of the above two license_type’s).</span><span class="sxs-lookup"><span data-stu-id="25ace-204">However, for different end user/device, the STS should have the business logic to issue different JWT tokens containing different claims (one of the above two license_type’s).</span></span> <span data-ttu-id="25ace-205">The claims value in the JWT token will be used to decide by license service to issue what type of license: persistent or non-persistent.</span><span class="sxs-lookup"><span data-stu-id="25ace-205">The claims value in the JWT token will be used to decide by license service to issue what type of license: persistent or non-persistent.</span></span>

<span data-ttu-id="25ace-206">This means the Secure Token Service (STS) needs to have the business logic and client/device info to add corresponding claim value into a token.</span><span class="sxs-lookup"><span data-stu-id="25ace-206">This means the Secure Token Service (STS) needs to have the business logic and client/device info to add corresponding claim value into a token.</span></span>

### <a name="question"></a><span data-ttu-id="25ace-207">Question</span><span class="sxs-lookup"><span data-stu-id="25ace-207">Question</span></span>

<span data-ttu-id="25ace-208">For Widevine security levels, in Google’s [Widevine DRM Architecture Overview doc](https://storage.googleapis.com/wvdocs/Widevine_DRM_Architecture_Overview.pdf) documentation, it defines three different security levels.</span><span class="sxs-lookup"><span data-stu-id="25ace-208">For Widevine security levels, in Google’s [Widevine DRM Architecture Overview doc](https://storage.googleapis.com/wvdocs/Widevine_DRM_Architecture_Overview.pdf) documentation, it defines three different security levels.</span></span> <span data-ttu-id="25ace-209">However, in [Azure Media Services documentation on Widevine license template](https://docs.microsoft.com/azure/media-services/media-services-widevine-license-template-overview), five different security levels are outlined.</span><span class="sxs-lookup"><span data-stu-id="25ace-209">However, in [Azure Media Services documentation on Widevine license template](https://docs.microsoft.com/azure/media-services/media-services-widevine-license-template-overview), five different security levels are outlined.</span></span> <span data-ttu-id="25ace-210">What is the relationship or mapping between the two different sets of security levels?</span><span class="sxs-lookup"><span data-stu-id="25ace-210">What is the relationship or mapping between the two different sets of security levels?</span></span>

### <a name="answer"></a><span data-ttu-id="25ace-211">Answer</span><span class="sxs-lookup"><span data-stu-id="25ace-211">Answer</span></span>

<span data-ttu-id="25ace-212">In Google’s [Widevine DRM Architecture Overview](https://storage.googleapis.com/wvdocs/Widevine_DRM_Architecture_Overview.pdf), it defines the following three security levels:</span><span class="sxs-lookup"><span data-stu-id="25ace-212">In Google’s [Widevine DRM Architecture Overview](https://storage.googleapis.com/wvdocs/Widevine_DRM_Architecture_Overview.pdf), it defines the following three security levels:</span></span>

1.  <span data-ttu-id="25ace-213">Security Level 1: All content processing, cryptography, and control are performed within the Trusted Execution Environment (TEE).</span><span class="sxs-lookup"><span data-stu-id="25ace-213">Security Level 1: All content processing, cryptography, and control are performed within the Trusted Execution Environment (TEE).</span></span> <span data-ttu-id="25ace-214">In some implementation models, security processing may be performed in different chips.</span><span class="sxs-lookup"><span data-stu-id="25ace-214">In some implementation models, security processing may be performed in different chips.</span></span>
2.  <span data-ttu-id="25ace-215">Security Level 2: Performs cryptography (but not video processing) within the TEE: decrypted buffers are returned to the application domain and processed through separate video hardware or software.</span><span class="sxs-lookup"><span data-stu-id="25ace-215">Security Level 2: Performs cryptography (but not video processing) within the TEE: decrypted buffers are returned to the application domain and processed through separate video hardware or software.</span></span> <span data-ttu-id="25ace-216">At level 2, however, cryptographic information is still processed only within the TEE.</span><span class="sxs-lookup"><span data-stu-id="25ace-216">At level 2, however, cryptographic information is still processed only within the TEE.</span></span>
3.  <span data-ttu-id="25ace-217">Security Level 3 Does not have a TEE on the device.</span><span class="sxs-lookup"><span data-stu-id="25ace-217">Security Level 3 Does not have a TEE on the device.</span></span> <span data-ttu-id="25ace-218">Appropriate measures may be taken to protect the cryptographic information and decrypted content on host operating system.</span><span class="sxs-lookup"><span data-stu-id="25ace-218">Appropriate measures may be taken to protect the cryptographic information and decrypted content on host operating system.</span></span> <span data-ttu-id="25ace-219">A Level 3 implementation may also include a hardware cryptographic engine, but that only enhances performance, not security.</span><span class="sxs-lookup"><span data-stu-id="25ace-219">A Level 3 implementation may also include a hardware cryptographic engine, but that only enhances performance, not security.</span></span>

<span data-ttu-id="25ace-220">At the same time, in [Azure Media Services documentation on Widevine license template](https://docs.microsoft.com/azure/media-services/media-services-widevine-license-template-overview), the security_level property of content_key_specs can have the following five different values (client robustness requirements for playback):</span><span class="sxs-lookup"><span data-stu-id="25ace-220">At the same time, in [Azure Media Services documentation on Widevine license template](https://docs.microsoft.com/azure/media-services/media-services-widevine-license-template-overview), the security_level property of content_key_specs can have the following five different values (client robustness requirements for playback):</span></span>

1.  <span data-ttu-id="25ace-221">Software-based whitebox crypto is required.</span><span class="sxs-lookup"><span data-stu-id="25ace-221">Software-based whitebox crypto is required.</span></span>
2.  <span data-ttu-id="25ace-222">Software crypto and an obfuscated decoder is required.</span><span class="sxs-lookup"><span data-stu-id="25ace-222">Software crypto and an obfuscated decoder is required.</span></span>
3.  <span data-ttu-id="25ace-223">The key material and crypto operations must be performed within a hardware backed TEE.</span><span class="sxs-lookup"><span data-stu-id="25ace-223">The key material and crypto operations must be performed within a hardware backed TEE.</span></span>
4.  <span data-ttu-id="25ace-224">The crypto and decoding of content must be performed within a hardware backed TEE.</span><span class="sxs-lookup"><span data-stu-id="25ace-224">The crypto and decoding of content must be performed within a hardware backed TEE.</span></span>
5.  <span data-ttu-id="25ace-225">The crypto, decoding, and all handling of the media (compressed and uncompressed) must be handled within a hardware backed TEE.</span><span class="sxs-lookup"><span data-stu-id="25ace-225">The crypto, decoding, and all handling of the media (compressed and uncompressed) must be handled within a hardware backed TEE.</span></span>

<span data-ttu-id="25ace-226">Both security levels are defined by Google Widevine.</span><span class="sxs-lookup"><span data-stu-id="25ace-226">Both security levels are defined by Google Widevine.</span></span> <span data-ttu-id="25ace-227">The difference is in its usage level: architecture level or API level.</span><span class="sxs-lookup"><span data-stu-id="25ace-227">The difference is in its usage level: architecture level or API level.</span></span> <span data-ttu-id="25ace-228">The five security levels are used in the Widevine API.</span><span class="sxs-lookup"><span data-stu-id="25ace-228">The five security levels are used in the Widevine API.</span></span> <span data-ttu-id="25ace-229">The content_key_specs object, which contains security_level is deserialized and passed to the Widevine global delivery service by Azure Media Services Widevine license service.</span><span class="sxs-lookup"><span data-stu-id="25ace-229">The content_key_specs object, which contains security_level is deserialized and passed to the Widevine global delivery service by Azure Media Services Widevine license service.</span></span> <span data-ttu-id="25ace-230">The table below shows the mapping between the two sets of security levels.</span><span class="sxs-lookup"><span data-stu-id="25ace-230">The table below shows the mapping between the two sets of security levels.</span></span>

| <span data-ttu-id="25ace-231">**Security Levels Defined in Widevine Architecture**</span><span class="sxs-lookup"><span data-stu-id="25ace-231">**Security Levels Defined in Widevine Architecture**</span></span> |<span data-ttu-id="25ace-232">**Security Levels Used in Widevine API**</span><span class="sxs-lookup"><span data-stu-id="25ace-232">**Security Levels Used in Widevine API**</span></span>|
|---|---| 
| <span data-ttu-id="25ace-233">**Security Level 1**: All content processing, cryptography, and control are performed within the Trusted Execution Environment (TEE).</span><span class="sxs-lookup"><span data-stu-id="25ace-233">**Security Level 1**: All content processing, cryptography, and control are performed within the Trusted Execution Environment (TEE).</span></span> <span data-ttu-id="25ace-234">In some implementation models, security processing may be performed in different chips.</span><span class="sxs-lookup"><span data-stu-id="25ace-234">In some implementation models, security processing may be performed in different chips.</span></span>|<span data-ttu-id="25ace-235">**security_level=5**: The crypto, decoding, and all handling of the media (compressed and uncompressed) must be handled within a hardware backed TEE.</span><span class="sxs-lookup"><span data-stu-id="25ace-235">**security_level=5**: The crypto, decoding, and all handling of the media (compressed and uncompressed) must be handled within a hardware backed TEE.</span></span><br/><br/><span data-ttu-id="25ace-236">**security_level=4**: The crypto and decoding of content must be performed within a hardware backed TEE.</span><span class="sxs-lookup"><span data-stu-id="25ace-236">**security_level=4**: The crypto and decoding of content must be performed within a hardware backed TEE.</span></span>|
<span data-ttu-id="25ace-237">**Security Level 2**: Performs cryptography (but not video processing) within the TEE: decrypted buffers are returned to the application domain and processed through separate video hardware or software.</span><span class="sxs-lookup"><span data-stu-id="25ace-237">**Security Level 2**: Performs cryptography (but not video processing) within the TEE: decrypted buffers are returned to the application domain and processed through separate video hardware or software.</span></span> <span data-ttu-id="25ace-238">At level 2, however, cryptographic information is still processed only within the TEE.</span><span class="sxs-lookup"><span data-stu-id="25ace-238">At level 2, however, cryptographic information is still processed only within the TEE.</span></span>| <span data-ttu-id="25ace-239">**security_level=3**: The key material and crypto operations must be performed within a hardware backed TEE.</span><span class="sxs-lookup"><span data-stu-id="25ace-239">**security_level=3**: The key material and crypto operations must be performed within a hardware backed TEE.</span></span> |
| <span data-ttu-id="25ace-240">**Security Level 3**: Does not have a TEE on the device.</span><span class="sxs-lookup"><span data-stu-id="25ace-240">**Security Level 3**: Does not have a TEE on the device.</span></span> <span data-ttu-id="25ace-241">Appropriate measures may be taken to protect the cryptographic information and decrypted content on host operating system.</span><span class="sxs-lookup"><span data-stu-id="25ace-241">Appropriate measures may be taken to protect the cryptographic information and decrypted content on host operating system.</span></span> <span data-ttu-id="25ace-242">A Level 3 implementation may also include a hardware cryptographic engine, but that only enhances performance, not security.</span><span class="sxs-lookup"><span data-stu-id="25ace-242">A Level 3 implementation may also include a hardware cryptographic engine, but that only enhances performance, not security.</span></span> | <span data-ttu-id="25ace-243">**security_level=2**: Software crypto and an obfuscated decoder is required.</span><span class="sxs-lookup"><span data-stu-id="25ace-243">**security_level=2**: Software crypto and an obfuscated decoder is required.</span></span><br/><br/><span data-ttu-id="25ace-244">**security_level=1**: Software-based whitebox crypto is required.</span><span class="sxs-lookup"><span data-stu-id="25ace-244">**security_level=1**: Software-based whitebox crypto is required.</span></span>|

### <a name="question"></a><span data-ttu-id="25ace-245">Question</span><span class="sxs-lookup"><span data-stu-id="25ace-245">Question</span></span>

<span data-ttu-id="25ace-246">Why does content download take so long?</span><span class="sxs-lookup"><span data-stu-id="25ace-246">Why does content download take so long?</span></span>

### <a name="answer"></a><span data-ttu-id="25ace-247">Answer</span><span class="sxs-lookup"><span data-stu-id="25ace-247">Answer</span></span>

<span data-ttu-id="25ace-248">There are two ways to improve download speed:</span><span class="sxs-lookup"><span data-stu-id="25ace-248">There are two ways to improve download speed:</span></span>

1.  <span data-ttu-id="25ace-249">Enable CDN so that end users are more likely to hit CDN instead of origin/streaming endpoint for content download.</span><span class="sxs-lookup"><span data-stu-id="25ace-249">Enable CDN so that end users are more likely to hit CDN instead of origin/streaming endpoint for content download.</span></span> <span data-ttu-id="25ace-250">If user hits streaming endpoint, each HLS segment or DASH fragment is dynamically packaged and encrypted.</span><span class="sxs-lookup"><span data-stu-id="25ace-250">If user hits streaming endpoint, each HLS segment or DASH fragment is dynamically packaged and encrypted.</span></span> <span data-ttu-id="25ace-251">Even though this latency is in millisecond scale for each segment/fragment, when you have an hour long video, the accumulated latency can be large causing longer download.</span><span class="sxs-lookup"><span data-stu-id="25ace-251">Even though this latency is in millisecond scale for each segment/fragment, when you have an hour long video, the accumulated latency can be large causing longer download.</span></span>
2.  <span data-ttu-id="25ace-252">Provide end users the option to selectively download video quality layers and audio tracks instead of all contents.</span><span class="sxs-lookup"><span data-stu-id="25ace-252">Provide end users the option to selectively download video quality layers and audio tracks instead of all contents.</span></span> <span data-ttu-id="25ace-253">For offline mode, there is no point to download all of the quality layers.</span><span class="sxs-lookup"><span data-stu-id="25ace-253">For offline mode, there is no point to download all of the quality layers.</span></span> <span data-ttu-id="25ace-254">There are two ways to achieve this:</span><span class="sxs-lookup"><span data-stu-id="25ace-254">There are two ways to achieve this:</span></span>
    1.  <span data-ttu-id="25ace-255">Client controlled: either player app auto selects or user selects video  quality layer and audio tracks to download;</span><span class="sxs-lookup"><span data-stu-id="25ace-255">Client controlled: either player app auto selects or user selects video  quality layer and audio tracks to download;</span></span>
    2.  <span data-ttu-id="25ace-256">Service controlled: one can use Dynamic Manifest feature in Azure Media Services to create a (global) filter, which limits HLS playlist or DASH MPD to a single video quality layer and selected audio tracks.</span><span class="sxs-lookup"><span data-stu-id="25ace-256">Service controlled: one can use Dynamic Manifest feature in Azure Media Services to create a (global) filter, which limits HLS playlist or DASH MPD to a single video quality layer and selected audio tracks.</span></span> <span data-ttu-id="25ace-257">Then the download URL presented to end users will include this filter.</span><span class="sxs-lookup"><span data-stu-id="25ace-257">Then the download URL presented to end users will include this filter.</span></span>

## <a name="summary"></a><span data-ttu-id="25ace-258">Summary</span><span class="sxs-lookup"><span data-stu-id="25ace-258">Summary</span></span>

<span data-ttu-id="25ace-259">This article discussed how to implement offline mode playback for DASH content protected by Widevine on Android devices.</span><span class="sxs-lookup"><span data-stu-id="25ace-259">This article discussed how to implement offline mode playback for DASH content protected by Widevine on Android devices.</span></span>  <span data-ttu-id="25ace-260">It also answered some common questions related to offline streaming of Widevine protected content.</span><span class="sxs-lookup"><span data-stu-id="25ace-260">It also answered some common questions related to offline streaming of Widevine protected content.</span></span>
