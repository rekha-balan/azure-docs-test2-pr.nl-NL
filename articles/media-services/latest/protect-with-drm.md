---
title: Use DRM dynamic encryption license delivery service with Azure Media Services| Microsoft Docs
description: You can use Azure Media Services to deliver your streams encrypted with Microsoft PlayReady, Google Widevine, or Apple FairPlay licenses.
services: media-services
documentationcenter: ''
author: juliako
manager: cfowler
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 07/15/2018
ms.author: juliako
ms.openlocfilehash: 8bfe2fb7274fb8c6dcf977e8bd72af525d8ce8a5
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44868738"
---
# <a name="use-drm-dynamic-encryption-and-license-delivery-service"></a><span data-ttu-id="5125d-103">Use DRM dynamic encryption and license delivery service</span><span class="sxs-lookup"><span data-stu-id="5125d-103">Use DRM dynamic encryption and license delivery service</span></span>

<span data-ttu-id="5125d-104">You can use Azure Media Services to deliver MPEG-DASH, Smooth Streaming, and HTTP Live Streaming (HLS) streams protected with [PlayReady digital rights management (DRM)](https://www.microsoft.com/playready/overview/).</span><span class="sxs-lookup"><span data-stu-id="5125d-104">You can use Azure Media Services to deliver MPEG-DASH, Smooth Streaming, and HTTP Live Streaming (HLS) streams protected with [PlayReady digital rights management (DRM)](https://www.microsoft.com/playready/overview/).</span></span> <span data-ttu-id="5125d-105">You can also use Media Services to deliver encrypted DASH streams with **Google Widevine** DRM licenses.</span><span class="sxs-lookup"><span data-stu-id="5125d-105">You can also use Media Services to deliver encrypted DASH streams with **Google Widevine** DRM licenses.</span></span> <span data-ttu-id="5125d-106">Both PlayReady and Widevine are encrypted per the common encryption (ISO/IEC 23001-7 CENC) specification.</span><span class="sxs-lookup"><span data-stu-id="5125d-106">Both PlayReady and Widevine are encrypted per the common encryption (ISO/IEC 23001-7 CENC) specification.</span></span> <span data-ttu-id="5125d-107">Media Services also enables you to encrypt your HLS content with **Apple FairPlay** (AES-128 CBC).</span><span class="sxs-lookup"><span data-stu-id="5125d-107">Media Services also enables you to encrypt your HLS content with **Apple FairPlay** (AES-128 CBC).</span></span> 

<span data-ttu-id="5125d-108">Furthermore, Media Services provides a service for delivering PlayReady, Widevine, and FairPlay DRM licenses.</span><span class="sxs-lookup"><span data-stu-id="5125d-108">Furthermore, Media Services provides a service for delivering PlayReady, Widevine, and FairPlay DRM licenses.</span></span> <span data-ttu-id="5125d-109">When a user requests DRM-protected content, the player application requests a license from the Media Services license service.</span><span class="sxs-lookup"><span data-stu-id="5125d-109">When a user requests DRM-protected content, the player application requests a license from the Media Services license service.</span></span> <span data-ttu-id="5125d-110">If the player application is authorized, the Media Services license service issues a license to the player.</span><span class="sxs-lookup"><span data-stu-id="5125d-110">If the player application is authorized, the Media Services license service issues a license to the player.</span></span> <span data-ttu-id="5125d-111">A license contains the decryption key that can be used by the client player to decrypt and stream the content.</span><span class="sxs-lookup"><span data-stu-id="5125d-111">A license contains the decryption key that can be used by the client player to decrypt and stream the content.</span></span>

<span data-ttu-id="5125d-112">This article is based on the [Encrypting with DRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM) sample.</span><span class="sxs-lookup"><span data-stu-id="5125d-112">This article is based on the [Encrypting with DRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM) sample.</span></span> <span data-ttu-id="5125d-113">Among other things, the sample demonstrates how to:</span><span class="sxs-lookup"><span data-stu-id="5125d-113">Among other things, the sample demonstrates how to:</span></span>

* <span data-ttu-id="5125d-114">Create an encoding Transform that uses a built-in preset for adaptive bitrate encoding and ingest a file directly from an [HTTPs source URL](job-input-from-http-how-to.md).</span><span class="sxs-lookup"><span data-stu-id="5125d-114">Create an encoding Transform that uses a built-in preset for adaptive bitrate encoding and ingest a file directly from an [HTTPs source URL](job-input-from-http-how-to.md).</span></span>
* <span data-ttu-id="5125d-115">Set the signing key used for verification of your token.</span><span class="sxs-lookup"><span data-stu-id="5125d-115">Set the signing key used for verification of your token.</span></span>
* <span data-ttu-id="5125d-116">Set the requirements (restrictions) on the content key policy that must be met to deliver keys with the specified configuration.</span><span class="sxs-lookup"><span data-stu-id="5125d-116">Set the requirements (restrictions) on the content key policy that must be met to deliver keys with the specified configuration.</span></span> 

    * <span data-ttu-id="5125d-117">Configuration</span><span class="sxs-lookup"><span data-stu-id="5125d-117">Configuration</span></span> 
    
        <span data-ttu-id="5125d-118">In this sample, the [PlayReady](playready-license-template-overview.md) and [Widevine](widevine-license-template-overview.md) licenses are configured so they can be delivered by the Media Services license delivery service.</span><span class="sxs-lookup"><span data-stu-id="5125d-118">In this sample, the [PlayReady](playready-license-template-overview.md) and [Widevine](widevine-license-template-overview.md) licenses are configured so they can be delivered by the Media Services license delivery service.</span></span> <span data-ttu-id="5125d-119">Even though, this sample app does not configure the [FairPlay](fairplay-license-overview.md) license, it contains a method that you can use to configure FairPlay.</span><span class="sxs-lookup"><span data-stu-id="5125d-119">Even though, this sample app does not configure the [FairPlay](fairplay-license-overview.md) license, it contains a method that you can use to configure FairPlay.</span></span> <span data-ttu-id="5125d-120">If you wish, you can add FairPlay configuration as another option.</span><span class="sxs-lookup"><span data-stu-id="5125d-120">If you wish, you can add FairPlay configuration as another option.</span></span>

    * <span data-ttu-id="5125d-121">Restriction</span><span class="sxs-lookup"><span data-stu-id="5125d-121">Restriction</span></span>

        <span data-ttu-id="5125d-122">The app sets a JWT token type restriction on the policy.</span><span class="sxs-lookup"><span data-stu-id="5125d-122">The app sets a JWT token type restriction on the policy.</span></span>

* <span data-ttu-id="5125d-123">Create a StreamingLocator for the specified asset and with the specified streaming policy name.</span><span class="sxs-lookup"><span data-stu-id="5125d-123">Create a StreamingLocator for the specified asset and with the specified streaming policy name.</span></span> <span data-ttu-id="5125d-124">In this case, the predefined policy is used.</span><span class="sxs-lookup"><span data-stu-id="5125d-124">In this case, the predefined policy is used.</span></span> <span data-ttu-id="5125d-125">It sets two content keys on the StreamingLocator: AES-128 (envelope) and CENC (PlayReady and Widevine).</span><span class="sxs-lookup"><span data-stu-id="5125d-125">It sets two content keys on the StreamingLocator: AES-128 (envelope) and CENC (PlayReady and Widevine).</span></span>  
    
    <span data-ttu-id="5125d-126">Once the StreamingLocator is created the output asset is published and available to clients for playback.</span><span class="sxs-lookup"><span data-stu-id="5125d-126">Once the StreamingLocator is created the output asset is published and available to clients for playback.</span></span>

    > [!NOTE]
    > <span data-ttu-id="5125d-127">Make sure the StreamingEndpoint from which you want to stream is in the Running state.</span><span class="sxs-lookup"><span data-stu-id="5125d-127">Make sure the StreamingEndpoint from which you want to stream is in the Running state.</span></span>

* <span data-ttu-id="5125d-128">Create a URL, to the Azure Media Player, that includes both the DASH manifest and the PlayReady token needed to play back the PlayReady encrypted content.</span><span class="sxs-lookup"><span data-stu-id="5125d-128">Create a URL, to the Azure Media Player, that includes both the DASH manifest and the PlayReady token needed to play back the PlayReady encrypted content.</span></span> <span data-ttu-id="5125d-129">The sample sets the expiration of the token to 1 hour.</span><span class="sxs-lookup"><span data-stu-id="5125d-129">The sample sets the expiration of the token to 1 hour.</span></span> 

    <span data-ttu-id="5125d-130">You can open a browser and paste the resulting URL to launch the Azure Media Player demo page with the URL and token filled out for you already.</span><span class="sxs-lookup"><span data-stu-id="5125d-130">You can open a browser and paste the resulting URL to launch the Azure Media Player demo page with the URL and token filled out for you already.</span></span>  

    ![protect with drm](./media/protect-with-drm/playready_encrypted_url.png)

> [!NOTE]
> <span data-ttu-id="5125d-132">You can encrypt each asset with multiple encryption types (AES-128, PlayReady, Widevine, FairPlay).</span><span class="sxs-lookup"><span data-stu-id="5125d-132">You can encrypt each asset with multiple encryption types (AES-128, PlayReady, Widevine, FairPlay).</span></span> <span data-ttu-id="5125d-133">See [Streaming protocols and encryption types](content-protection-overview.md#streaming-protocols-and-encryption-types), to see what makes sense to combine.</span><span class="sxs-lookup"><span data-stu-id="5125d-133">See [Streaming protocols and encryption types](content-protection-overview.md#streaming-protocols-and-encryption-types), to see what makes sense to combine.</span></span>

<span data-ttu-id="5125d-134">The sample described in this article produces the following result:</span><span class="sxs-lookup"><span data-stu-id="5125d-134">The sample described in this article produces the following result:</span></span>

![protect with drm](./media/protect-with-drm/ams_player.png)

## <a name="prerequisites"></a><span data-ttu-id="5125d-136">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="5125d-136">Prerequisites</span></span>

<span data-ttu-id="5125d-137">The following are required to complete the tutorial.</span><span class="sxs-lookup"><span data-stu-id="5125d-137">The following are required to complete the tutorial.</span></span>

* <span data-ttu-id="5125d-138">Review the [Content protection overview](content-protection-overview.md) article.</span><span class="sxs-lookup"><span data-stu-id="5125d-138">Review the [Content protection overview](content-protection-overview.md) article.</span></span>
* <span data-ttu-id="5125d-139">Review the [Design multi-drm content protection system with access control](design-multi-drm-system-with-access-control.md)</span><span class="sxs-lookup"><span data-stu-id="5125d-139">Review the [Design multi-drm content protection system with access control](design-multi-drm-system-with-access-control.md)</span></span>
* <span data-ttu-id="5125d-140">Install Visual Studio Code or Visual Studio</span><span class="sxs-lookup"><span data-stu-id="5125d-140">Install Visual Studio Code or Visual Studio</span></span>
* <span data-ttu-id="5125d-141">Create a new Azure Media Services account, as described in [this quickstart](create-account-cli-quickstart.md).</span><span class="sxs-lookup"><span data-stu-id="5125d-141">Create a new Azure Media Services account, as described in [this quickstart](create-account-cli-quickstart.md).</span></span>
* <span data-ttu-id="5125d-142">Get credentials needed to use Media Services APIs by following [Access APIs](access-api-cli-how-to.md)</span><span class="sxs-lookup"><span data-stu-id="5125d-142">Get credentials needed to use Media Services APIs by following [Access APIs](access-api-cli-how-to.md)</span></span>
* <span data-ttu-id="5125d-143">Set the appropriate values in the application configuration file (appsettings.json).</span><span class="sxs-lookup"><span data-stu-id="5125d-143">Set the appropriate values in the application configuration file (appsettings.json).</span></span>

## <a name="download-code"></a><span data-ttu-id="5125d-144">Download code</span><span class="sxs-lookup"><span data-stu-id="5125d-144">Download code</span></span>

<span data-ttu-id="5125d-145">Clone a GitHub repository that contains the full .NET sample discussed in this article to your machine using the following command:</span><span class="sxs-lookup"><span data-stu-id="5125d-145">Clone a GitHub repository that contains the full .NET sample discussed in this article to your machine using the following command:</span></span>

 ```bash
 git clone https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials.git
 ```
 
<span data-ttu-id="5125d-146">The "Encrypt with DRM" sample is located in the [EncryptWithDRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM) folder.</span><span class="sxs-lookup"><span data-stu-id="5125d-146">The "Encrypt with DRM" sample is located in the [EncryptWithDRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM) folder.</span></span>

> [!NOTE]
> <span data-ttu-id="5125d-147">The sample creates unique resources every time you run the application.</span><span class="sxs-lookup"><span data-stu-id="5125d-147">The sample creates unique resources every time you run the application.</span></span> <span data-ttu-id="5125d-148">Typically, you will reuse existing resources like transforms and policies (if existing resource have required configurations).</span><span class="sxs-lookup"><span data-stu-id="5125d-148">Typically, you will reuse existing resources like transforms and policies (if existing resource have required configurations).</span></span> 

## <a name="start-using-media-services-apis-with-net-sdk"></a><span data-ttu-id="5125d-149">Start using Media Services APIs with .NET SDK</span><span class="sxs-lookup"><span data-stu-id="5125d-149">Start using Media Services APIs with .NET SDK</span></span>

<span data-ttu-id="5125d-150">To start using Media Services APIs with .NET, you need to create an **AzureMediaServicesClient** object.</span><span class="sxs-lookup"><span data-stu-id="5125d-150">To start using Media Services APIs with .NET, you need to create an **AzureMediaServicesClient** object.</span></span> <span data-ttu-id="5125d-151">To create the object, you need to supply credentials needed for the client to connect to Azure using Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5125d-151">To create the object, you need to supply credentials needed for the client to connect to Azure using Azure AD.</span></span> <span data-ttu-id="5125d-152">In the code you cloned at the beginning of the article, the **GetCredentialsAsync** function creates the ServiceClientCredentials object based on the credentials supplied in the local configuration file.</span><span class="sxs-lookup"><span data-stu-id="5125d-152">In the code you cloned at the beginning of the article, the **GetCredentialsAsync** function creates the ServiceClientCredentials object based on the credentials supplied in the local configuration file.</span></span> 

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CreateMediaServicesClient)]

## <a name="create-an-output-asset"></a><span data-ttu-id="5125d-153">Create an output asset</span><span class="sxs-lookup"><span data-stu-id="5125d-153">Create an output asset</span></span>  

<span data-ttu-id="5125d-154">The output [Asset](https://docs.microsoft.com/rest/api/media/assets) stores the result of your encoding job.</span><span class="sxs-lookup"><span data-stu-id="5125d-154">The output [Asset](https://docs.microsoft.com/rest/api/media/assets) stores the result of your encoding job.</span></span>  

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CreateOutputAsset)]
 
## <a name="get-or-create-an-encoding-transform"></a><span data-ttu-id="5125d-155">Get or create an encoding Transform</span><span class="sxs-lookup"><span data-stu-id="5125d-155">Get or create an encoding Transform</span></span>

<span data-ttu-id="5125d-156">When creating a new [Transform](https://docs.microsoft.com/rest/api/media/transforms) instance, you need to specify what you want it to produce as an output.</span><span class="sxs-lookup"><span data-stu-id="5125d-156">When creating a new [Transform](https://docs.microsoft.com/rest/api/media/transforms) instance, you need to specify what you want it to produce as an output.</span></span> <span data-ttu-id="5125d-157">The required parameter is a **TransformOutput** object, as shown in the code below.</span><span class="sxs-lookup"><span data-stu-id="5125d-157">The required parameter is a **TransformOutput** object, as shown in the code below.</span></span> <span data-ttu-id="5125d-158">Each **TransformOutput** contains a **Preset**.</span><span class="sxs-lookup"><span data-stu-id="5125d-158">Each **TransformOutput** contains a **Preset**.</span></span> <span data-ttu-id="5125d-159">**Preset** describes the step-by-step instructions of video and/or audio processing operations that are to be used to generate the desired **TransformOutput**.</span><span class="sxs-lookup"><span data-stu-id="5125d-159">**Preset** describes the step-by-step instructions of video and/or audio processing operations that are to be used to generate the desired **TransformOutput**.</span></span> <span data-ttu-id="5125d-160">The sample described in this article uses a built-in Preset called **AdaptiveStreaming**.</span><span class="sxs-lookup"><span data-stu-id="5125d-160">The sample described in this article uses a built-in Preset called **AdaptiveStreaming**.</span></span> <span data-ttu-id="5125d-161">The Preset encodes the input video into an auto-generated bitrate ladder (bitrate-resolution pairs) based on the input resolution and bitrate, and produces ISO MP4 files with H.264 video and AAC audio corresponding to each bitrate-resolution pair.</span><span class="sxs-lookup"><span data-stu-id="5125d-161">The Preset encodes the input video into an auto-generated bitrate ladder (bitrate-resolution pairs) based on the input resolution and bitrate, and produces ISO MP4 files with H.264 video and AAC audio corresponding to each bitrate-resolution pair.</span></span> 

<span data-ttu-id="5125d-162">Before creating a new [Transform](https://docs.microsoft.com/rest/api/media/transforms), you should first check if one already exists using the **Get** method, as shown in the code that follows.</span><span class="sxs-lookup"><span data-stu-id="5125d-162">Before creating a new [Transform](https://docs.microsoft.com/rest/api/media/transforms), you should first check if one already exists using the **Get** method, as shown in the code that follows.</span></span>  <span data-ttu-id="5125d-163">In Media Services v3, **Get** methods on entities return **null** if the entity doesn’t exist (a case-insensitive check on the name).</span><span class="sxs-lookup"><span data-stu-id="5125d-163">In Media Services v3, **Get** methods on entities return **null** if the entity doesn’t exist (a case-insensitive check on the name).</span></span>

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#EnsureTransformExists)]

## <a name="submit-job"></a><span data-ttu-id="5125d-164">Submit Job</span><span class="sxs-lookup"><span data-stu-id="5125d-164">Submit Job</span></span>

<span data-ttu-id="5125d-165">As mentioned above, the [Transform](https://docs.microsoft.com/rest/api/media/transforms) object is the recipe and a [Job](https://docs.microsoft.com/rest/api/media/jobs) is the actual request to Media Services to apply that **Transform** to a given input video or audio content.</span><span class="sxs-lookup"><span data-stu-id="5125d-165">As mentioned above, the [Transform](https://docs.microsoft.com/rest/api/media/transforms) object is the recipe and a [Job](https://docs.microsoft.com/rest/api/media/jobs) is the actual request to Media Services to apply that **Transform** to a given input video or audio content.</span></span> <span data-ttu-id="5125d-166">The **Job** specifies information like the location of the input video, and the location for the output.</span><span class="sxs-lookup"><span data-stu-id="5125d-166">The **Job** specifies information like the location of the input video, and the location for the output.</span></span>

<span data-ttu-id="5125d-167">In this tutorial, we create the job's input based on a file that is ingested directly from an [HTTPs source URL](job-input-from-http-how-to.md).</span><span class="sxs-lookup"><span data-stu-id="5125d-167">In this tutorial, we create the job's input based on a file that is ingested directly from an [HTTPs source URL](job-input-from-http-how-to.md).</span></span>

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#SubmitJob)]

## <a name="wait-for-the-job-to-complete"></a><span data-ttu-id="5125d-168">Wait for the Job to complete</span><span class="sxs-lookup"><span data-stu-id="5125d-168">Wait for the Job to complete</span></span>

<span data-ttu-id="5125d-169">The job takes some time to complete and when it does you want to be notified.</span><span class="sxs-lookup"><span data-stu-id="5125d-169">The job takes some time to complete and when it does you want to be notified.</span></span> <span data-ttu-id="5125d-170">The code sample below shows how to poll the service for the status of the [Job](https://docs.microsoft.com/rest/api/media/jobs).</span><span class="sxs-lookup"><span data-stu-id="5125d-170">The code sample below shows how to poll the service for the status of the [Job](https://docs.microsoft.com/rest/api/media/jobs).</span></span> <span data-ttu-id="5125d-171">Polling is not a recommended best practice for production applications because of potential latency.</span><span class="sxs-lookup"><span data-stu-id="5125d-171">Polling is not a recommended best practice for production applications because of potential latency.</span></span> <span data-ttu-id="5125d-172">Polling can be throttled if overused on an account.</span><span class="sxs-lookup"><span data-stu-id="5125d-172">Polling can be throttled if overused on an account.</span></span> <span data-ttu-id="5125d-173">Developers should instead use Event Grid.</span><span class="sxs-lookup"><span data-stu-id="5125d-173">Developers should instead use Event Grid.</span></span> <span data-ttu-id="5125d-174">See [Route events to a custom web endpoint](job-state-events-cli-how-to.md).</span><span class="sxs-lookup"><span data-stu-id="5125d-174">See [Route events to a custom web endpoint](job-state-events-cli-how-to.md).</span></span>

<span data-ttu-id="5125d-175">The **Job** usually goes through the following states: **Scheduled**, **Queued**, **Processing**, **Finished** (the final state).</span><span class="sxs-lookup"><span data-stu-id="5125d-175">The **Job** usually goes through the following states: **Scheduled**, **Queued**, **Processing**, **Finished** (the final state).</span></span> <span data-ttu-id="5125d-176">If the job has encountered an error, you get the **Error** state.</span><span class="sxs-lookup"><span data-stu-id="5125d-176">If the job has encountered an error, you get the **Error** state.</span></span> <span data-ttu-id="5125d-177">If the job is in the process of being canceled, you get **Canceling** and **Canceled** when it is done.</span><span class="sxs-lookup"><span data-stu-id="5125d-177">If the job is in the process of being canceled, you get **Canceling** and **Canceled** when it is done.</span></span>

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#WaitForJobToFinish)]

## <a name="create-a-contentkeypolicy"></a><span data-ttu-id="5125d-178">Create a ContentKeyPolicy</span><span class="sxs-lookup"><span data-stu-id="5125d-178">Create a ContentKeyPolicy</span></span>

<span data-ttu-id="5125d-179">A content key provides secure access to your Assets.</span><span class="sxs-lookup"><span data-stu-id="5125d-179">A content key provides secure access to your Assets.</span></span> <span data-ttu-id="5125d-180">You need to create a content key policy that configures how the content key is delivered to end clients.</span><span class="sxs-lookup"><span data-stu-id="5125d-180">You need to create a content key policy that configures how the content key is delivered to end clients.</span></span> <span data-ttu-id="5125d-181">The content key is associated with StreamingLocator.</span><span class="sxs-lookup"><span data-stu-id="5125d-181">The content key is associated with StreamingLocator.</span></span> <span data-ttu-id="5125d-182">Media Services also provides the key delivery service that delivers encryption keys and licenses to authorized users.</span><span class="sxs-lookup"><span data-stu-id="5125d-182">Media Services also provides the key delivery service that delivers encryption keys and licenses to authorized users.</span></span> 

<span data-ttu-id="5125d-183">You need to set the requirements (restrictions) on the content key policy that must be met to deliver keys with the specified configuration.</span><span class="sxs-lookup"><span data-stu-id="5125d-183">You need to set the requirements (restrictions) on the content key policy that must be met to deliver keys with the specified configuration.</span></span> <span data-ttu-id="5125d-184">In this example, we set the following configurations and requirements:</span><span class="sxs-lookup"><span data-stu-id="5125d-184">In this example, we set the following configurations and requirements:</span></span>

* <span data-ttu-id="5125d-185">Configuration</span><span class="sxs-lookup"><span data-stu-id="5125d-185">Configuration</span></span> 

    <span data-ttu-id="5125d-186">The [PlayReady](playready-license-template-overview.md) and [Widevine](widevine-license-template-overview.md) licenses are configured so they can be delivered by the Media Services license delivery service.</span><span class="sxs-lookup"><span data-stu-id="5125d-186">The [PlayReady](playready-license-template-overview.md) and [Widevine](widevine-license-template-overview.md) licenses are configured so they can be delivered by the Media Services license delivery service.</span></span> <span data-ttu-id="5125d-187">Even though, this sample app does not configure the [FairPlay](fairplay-license-overview.md) license, it contains a method that you can use to configure FairPlay.</span><span class="sxs-lookup"><span data-stu-id="5125d-187">Even though, this sample app does not configure the [FairPlay](fairplay-license-overview.md) license, it contains a method that you can use to configure FairPlay.</span></span> <span data-ttu-id="5125d-188">You can  add FairPlay configuration as another option.</span><span class="sxs-lookup"><span data-stu-id="5125d-188">You can  add FairPlay configuration as another option.</span></span>

* <span data-ttu-id="5125d-189">Restriction</span><span class="sxs-lookup"><span data-stu-id="5125d-189">Restriction</span></span>

    <span data-ttu-id="5125d-190">The app sets a JWT token type restriction on the policy.</span><span class="sxs-lookup"><span data-stu-id="5125d-190">The app sets a JWT token type restriction on the policy.</span></span>

<span data-ttu-id="5125d-191">When a stream is requested by a player, Media Services uses the specified key to dynamically encrypt your content.</span><span class="sxs-lookup"><span data-stu-id="5125d-191">When a stream is requested by a player, Media Services uses the specified key to dynamically encrypt your content.</span></span> <span data-ttu-id="5125d-192">To decrypt the stream, the player requests the key from the key delivery service.</span><span class="sxs-lookup"><span data-stu-id="5125d-192">To decrypt the stream, the player requests the key from the key delivery service.</span></span> <span data-ttu-id="5125d-193">To determine whether the user is authorized to get the key, the service evaluates the content key policy that you specified for the key.</span><span class="sxs-lookup"><span data-stu-id="5125d-193">To determine whether the user is authorized to get the key, the service evaluates the content key policy that you specified for the key.</span></span>

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#GetOrCreateContentKeyPolicy)]

## <a name="create-a-streaminglocator"></a><span data-ttu-id="5125d-194">Create a StreamingLocator</span><span class="sxs-lookup"><span data-stu-id="5125d-194">Create a StreamingLocator</span></span>

<span data-ttu-id="5125d-195">After the encoding is complete, and the content key policy is set, the next step is to make the video in the output Asset available to clients for playback.</span><span class="sxs-lookup"><span data-stu-id="5125d-195">After the encoding is complete, and the content key policy is set, the next step is to make the video in the output Asset available to clients for playback.</span></span> <span data-ttu-id="5125d-196">You accomplish this in two steps:</span><span class="sxs-lookup"><span data-stu-id="5125d-196">You accomplish this in two steps:</span></span> 

1. <span data-ttu-id="5125d-197">Create a [StreamingLocator](https://docs.microsoft.com/rest/api/media/streaminglocators)</span><span class="sxs-lookup"><span data-stu-id="5125d-197">Create a [StreamingLocator](https://docs.microsoft.com/rest/api/media/streaminglocators)</span></span>
2. <span data-ttu-id="5125d-198">Build the streaming URLs that clients can use.</span><span class="sxs-lookup"><span data-stu-id="5125d-198">Build the streaming URLs that clients can use.</span></span> 

<span data-ttu-id="5125d-199">The process of creating the **StreamingLocator** is called publishing.</span><span class="sxs-lookup"><span data-stu-id="5125d-199">The process of creating the **StreamingLocator** is called publishing.</span></span> <span data-ttu-id="5125d-200">By default, the **StreamingLocator** is valid immediately after you make the API calls, and lasts until it is deleted, unless you configure the optional start and end times.</span><span class="sxs-lookup"><span data-stu-id="5125d-200">By default, the **StreamingLocator** is valid immediately after you make the API calls, and lasts until it is deleted, unless you configure the optional start and end times.</span></span> 

<span data-ttu-id="5125d-201">When creating a [StreamingLocator](https://docs.microsoft.com/rest/api/media/streaminglocators), you need to specify the desired **StreamingPolicyName**.</span><span class="sxs-lookup"><span data-stu-id="5125d-201">When creating a [StreamingLocator](https://docs.microsoft.com/rest/api/media/streaminglocators), you need to specify the desired **StreamingPolicyName**.</span></span> <span data-ttu-id="5125d-202">In this tutorial, we are using one of the PredefinedStreamingPolicies, which tells Azure Media Services how to publish the content for streaming.</span><span class="sxs-lookup"><span data-stu-id="5125d-202">In this tutorial, we are using one of the PredefinedStreamingPolicies, which tells Azure Media Services how to publish the content for streaming.</span></span> <span data-ttu-id="5125d-203">In this example, we set StreamingLocator.StreamingPolicyName to the SecureStreaming policy.</span><span class="sxs-lookup"><span data-stu-id="5125d-203">In this example, we set StreamingLocator.StreamingPolicyName to the SecureStreaming policy.</span></span> <span data-ttu-id="5125d-204">This policy indicates that you want for two content keys (envelope and CENC) to get generated and set on the locator.</span><span class="sxs-lookup"><span data-stu-id="5125d-204">This policy indicates that you want for two content keys (envelope and CENC) to get generated and set on the locator.</span></span> <span data-ttu-id="5125d-205">Thus, the envelope, PlayReady, and Widevine encryptions are applied (the key is delivered to the playback client based on the configured DRM licenses).</span><span class="sxs-lookup"><span data-stu-id="5125d-205">Thus, the envelope, PlayReady, and Widevine encryptions are applied (the key is delivered to the playback client based on the configured DRM licenses).</span></span> <span data-ttu-id="5125d-206">If you also want to encrypt your stream with CBCS (FairPlay), use PredefinedStreamingPolicy.SecureStreamingWithFairPlay.</span><span class="sxs-lookup"><span data-stu-id="5125d-206">If you also want to encrypt your stream with CBCS (FairPlay), use PredefinedStreamingPolicy.SecureStreamingWithFairPlay.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="5125d-207">When using a custom [StreamingPolicy](https://docs.microsoft.com/rest/api/media/streamingpolicies), you should design a limited set of such policies for your Media Service account, and re-use them for your StreamingLocators whenever the same encryption options and protocols are needed.</span><span class="sxs-lookup"><span data-stu-id="5125d-207">When using a custom [StreamingPolicy](https://docs.microsoft.com/rest/api/media/streamingpolicies), you should design a limited set of such policies for your Media Service account, and re-use them for your StreamingLocators whenever the same encryption options and protocols are needed.</span></span> <span data-ttu-id="5125d-208">Your Media Service account has a quota for the number of StreamingPolicy entries.</span><span class="sxs-lookup"><span data-stu-id="5125d-208">Your Media Service account has a quota for the number of StreamingPolicy entries.</span></span> <span data-ttu-id="5125d-209">You should not be creating a new StreamingPolicy for each StreamingLocator.</span><span class="sxs-lookup"><span data-stu-id="5125d-209">You should not be creating a new StreamingPolicy for each StreamingLocator.</span></span>

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CreateStreamingLocator)]

## <a name="get-a-test-token"></a><span data-ttu-id="5125d-210">Get a test token</span><span class="sxs-lookup"><span data-stu-id="5125d-210">Get a test token</span></span>
        
<span data-ttu-id="5125d-211">In this tutorial, we specify for the content key policy to have a token restriction.</span><span class="sxs-lookup"><span data-stu-id="5125d-211">In this tutorial, we specify for the content key policy to have a token restriction.</span></span> <span data-ttu-id="5125d-212">The token-restricted policy must be accompanied by a token issued by a security token service (STS).</span><span class="sxs-lookup"><span data-stu-id="5125d-212">The token-restricted policy must be accompanied by a token issued by a security token service (STS).</span></span> <span data-ttu-id="5125d-213">Media Services supports tokens in the [JSON Web Token](https://msdn.microsoft.com/library/gg185950.aspx#BKMK_3) (JWT) formats and that is what we configure in the sample.</span><span class="sxs-lookup"><span data-stu-id="5125d-213">Media Services supports tokens in the [JSON Web Token](https://msdn.microsoft.com/library/gg185950.aspx#BKMK_3) (JWT) formats and that is what we configure in the sample.</span></span>

<span data-ttu-id="5125d-214">The ContentKeyIdentifierClaim is used in the ContentKeyPolicy, which means that the token presented to the key delivery service must have the identifier of the ContentKey in it.</span><span class="sxs-lookup"><span data-stu-id="5125d-214">The ContentKeyIdentifierClaim is used in the ContentKeyPolicy, which means that the token presented to the key delivery service must have the identifier of the ContentKey in it.</span></span> <span data-ttu-id="5125d-215">In the sample, we don't specify a content key when creating the StreamingLocator, the system creates a random one for us.</span><span class="sxs-lookup"><span data-stu-id="5125d-215">In the sample, we don't specify a content key when creating the StreamingLocator, the system creates a random one for us.</span></span> <span data-ttu-id="5125d-216">In order to generate the test token, we must get the ContentKeyId to put in the ContentKeyIdentifierClaim claim.</span><span class="sxs-lookup"><span data-stu-id="5125d-216">In order to generate the test token, we must get the ContentKeyId to put in the ContentKeyIdentifierClaim claim.</span></span>

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#GetToken)]

## <a name="build-a-dash-streaming-url"></a><span data-ttu-id="5125d-217">Build a DASH streaming URL</span><span class="sxs-lookup"><span data-stu-id="5125d-217">Build a DASH streaming URL</span></span>

<span data-ttu-id="5125d-218">Now that the [StreamingLocator](https://docs.microsoft.com/rest/api/media/streaminglocators) has been created, you can get the streaming URLs.</span><span class="sxs-lookup"><span data-stu-id="5125d-218">Now that the [StreamingLocator](https://docs.microsoft.com/rest/api/media/streaminglocators) has been created, you can get the streaming URLs.</span></span> <span data-ttu-id="5125d-219">To build a URL, you need to concatenate the [StreamingEndpoint](https://docs.microsoft.com/rest/api/media/streamingendpoints) host name and the **StreamingLocator** path.</span><span class="sxs-lookup"><span data-stu-id="5125d-219">To build a URL, you need to concatenate the [StreamingEndpoint](https://docs.microsoft.com/rest/api/media/streamingendpoints) host name and the **StreamingLocator** path.</span></span> <span data-ttu-id="5125d-220">In this sample, the *default* **StreamingEndpoint** is used.</span><span class="sxs-lookup"><span data-stu-id="5125d-220">In this sample, the *default* **StreamingEndpoint** is used.</span></span> <span data-ttu-id="5125d-221">When you first create a Media Service account, this *default* **StreamingEndpoint** will be in a stopped state, so you need to call **Start**.</span><span class="sxs-lookup"><span data-stu-id="5125d-221">When you first create a Media Service account, this *default* **StreamingEndpoint** will be in a stopped state, so you need to call **Start**.</span></span>

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#GetMPEGStreamingUrl)]

## <a name="clean-up-resources-in-your-media-services-account"></a><span data-ttu-id="5125d-222">Clean up resources in your Media Services account</span><span class="sxs-lookup"><span data-stu-id="5125d-222">Clean up resources in your Media Services account</span></span>

<span data-ttu-id="5125d-223">Generally, you should clean up everything except objects that you are planning to reuse (typically, you will reuse Transforms, and you will persist StreamingLocators, etc.).</span><span class="sxs-lookup"><span data-stu-id="5125d-223">Generally, you should clean up everything except objects that you are planning to reuse (typically, you will reuse Transforms, and you will persist StreamingLocators, etc.).</span></span> <span data-ttu-id="5125d-224">If you want for your account to be clean after experimenting, you should delete the resources that you do not plan to reuse.</span><span class="sxs-lookup"><span data-stu-id="5125d-224">If you want for your account to be clean after experimenting, you should delete the resources that you do not plan to reuse.</span></span>  <span data-ttu-id="5125d-225">For example, the following code deletes Jobs.</span><span class="sxs-lookup"><span data-stu-id="5125d-225">For example, the following code deletes Jobs.</span></span>

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/EncryptWithDRM/Program.cs#CleanUp)]

## <a name="next-steps"></a><span data-ttu-id="5125d-226">Next steps</span><span class="sxs-lookup"><span data-stu-id="5125d-226">Next steps</span></span>

<span data-ttu-id="5125d-227">Check out how to [protect with AES-128](protect-with-aes128.md)</span><span class="sxs-lookup"><span data-stu-id="5125d-227">Check out how to [protect with AES-128](protect-with-aes128.md)</span></span>
