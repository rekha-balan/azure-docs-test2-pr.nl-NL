---
title: Hybrid connection with 2-tier application | Microsoft Docs
description: Learn how to deploy virtual appliances and UDR to create a multi-tier application environment in Azure
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 2a0a8cc5cafabe8053e1617de5a63001465f776c
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44670766"
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="49eb5-103">Virtual appliance scenario</span><span class="sxs-lookup"><span data-stu-id="49eb5-103">Virtual appliance scenario</span></span>
<span data-ttu-id="49eb5-104">A common scenario among larger Azure customer is the need to provide a two-tiered application exposed to the Internet, while allowing access to the back tier from an on-premises datacenter.</span><span class="sxs-lookup"><span data-stu-id="49eb5-104">A common scenario among larger Azure customer is the need to provide a two-tiered application exposed to the Internet, while allowing access to the back tier from an on-premises datacenter.</span></span> <span data-ttu-id="49eb5-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances to deploy a two-tier environment that meets the following requirements:</span><span class="sxs-lookup"><span data-stu-id="49eb5-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances to deploy a two-tier environment that meets the following requirements:</span></span>

* <span data-ttu-id="49eb5-106">Web application must be accessible from the public Internet only.</span><span class="sxs-lookup"><span data-stu-id="49eb5-106">Web application must be accessible from the public Internet only.</span></span>
* <span data-ttu-id="49eb5-107">Web server hosting the application must be able to access a backend application server.</span><span class="sxs-lookup"><span data-stu-id="49eb5-107">Web server hosting the application must be able to access a backend application server.</span></span>
* <span data-ttu-id="49eb5-108">All traffic from the Internet to the web application must go through a firewall virtual appliance.</span><span class="sxs-lookup"><span data-stu-id="49eb5-108">All traffic from the Internet to the web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="49eb5-109">This virtual appliance will be used for Internet traffic only.</span><span class="sxs-lookup"><span data-stu-id="49eb5-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="49eb5-110">All traffic going to the application server must go through a firewall virtual appliance.</span><span class="sxs-lookup"><span data-stu-id="49eb5-110">All traffic going to the application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="49eb5-111">This virtual appliance will be used for access to the backend end server, and access coming in from the on-premises network via a VPN Gateway.</span><span class="sxs-lookup"><span data-stu-id="49eb5-111">This virtual appliance will be used for access to the backend end server, and access coming in from the on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="49eb5-112">Administrators must be able to manage the firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span><span class="sxs-lookup"><span data-stu-id="49eb5-112">Administrators must be able to manage the firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="49eb5-113">This is a standard DMZ scenario with a DMZ and a protected network.</span><span class="sxs-lookup"><span data-stu-id="49eb5-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="49eb5-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span><span class="sxs-lookup"><span data-stu-id="49eb5-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="49eb5-115">The table below shows some of the pros and cons between NSGs and firewall virtual appliances.</span><span class="sxs-lookup"><span data-stu-id="49eb5-115">The table below shows some of the pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="49eb5-116">Pros</span><span class="sxs-lookup"><span data-stu-id="49eb5-116">Pros</span></span> | <span data-ttu-id="49eb5-117">Cons</span><span class="sxs-lookup"><span data-stu-id="49eb5-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="49eb5-118">NSG</span><span class="sxs-lookup"><span data-stu-id="49eb5-118">NSG</span></span> |<span data-ttu-id="49eb5-119">No cost.</span><span class="sxs-lookup"><span data-stu-id="49eb5-119">No cost.</span></span> <br/><span data-ttu-id="49eb5-120">Integrated into Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="49eb5-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="49eb5-121">Rules can be created in ARM templates.</span><span class="sxs-lookup"><span data-stu-id="49eb5-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="49eb5-122">Complexity could vary in larger environments.</span><span class="sxs-lookup"><span data-stu-id="49eb5-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="49eb5-123">Firewall</span><span class="sxs-lookup"><span data-stu-id="49eb5-123">Firewall</span></span> |<span data-ttu-id="49eb5-124">Full control over data plane.</span><span class="sxs-lookup"><span data-stu-id="49eb5-124">Full control over data plane.</span></span> <br/><span data-ttu-id="49eb5-125">Central management through firewall console.</span><span class="sxs-lookup"><span data-stu-id="49eb5-125">Central management through firewall console.</span></span> |<span data-ttu-id="49eb5-126">Cost of firewall appliance.</span><span class="sxs-lookup"><span data-stu-id="49eb5-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="49eb5-127">Not integrated with Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="49eb5-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="49eb5-128">The solution below uses firewall virtual appliances to implement a DMZ/protected network scenario.</span><span class="sxs-lookup"><span data-stu-id="49eb5-128">The solution below uses firewall virtual appliances to implement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="49eb5-129">Considerations</span><span class="sxs-lookup"><span data-stu-id="49eb5-129">Considerations</span></span>
<span data-ttu-id="49eb5-130">You can deploy the environment explained above in Azure using different features available today, as follows.</span><span class="sxs-lookup"><span data-stu-id="49eb5-130">You can deploy the environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="49eb5-131">**Virtual network (VNet)**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="49eb5-132">An Azure VNet acts in similar fashion to an on-premises network, and can be segmented into one or more subnets to provide traffic isolation, and separation of concerns.</span><span class="sxs-lookup"><span data-stu-id="49eb5-132">An Azure VNet acts in similar fashion to an on-premises network, and can be segmented into one or more subnets to provide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="49eb5-133">**Virtual appliance**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-133">**Virtual appliance**.</span></span> <span data-ttu-id="49eb5-134">Several partners provide virtual appliances in the Azure Marketplace that can be used for the three firewalls described above.</span><span class="sxs-lookup"><span data-stu-id="49eb5-134">Several partners provide virtual appliances in the Azure Marketplace that can be used for the three firewalls described above.</span></span> 
* <span data-ttu-id="49eb5-135">**User Defined Routes (UDR)**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="49eb5-136">Route tables can contain UDRs used by Azure networking to control the flow of packets within a VNet.</span><span class="sxs-lookup"><span data-stu-id="49eb5-136">Route tables can contain UDRs used by Azure networking to control the flow of packets within a VNet.</span></span> <span data-ttu-id="49eb5-137">These route tables can be applied to subnets.</span><span class="sxs-lookup"><span data-stu-id="49eb5-137">These route tables can be applied to subnets.</span></span> <span data-ttu-id="49eb5-138">One of the newest features in Azure is the ability to apply a route table to the GatewaySubnet, providing the ability to forward all traffic coming into the Azure VNet from a hybrid connection to a virtual appliance.</span><span class="sxs-lookup"><span data-stu-id="49eb5-138">One of the newest features in Azure is the ability to apply a route table to the GatewaySubnet, providing the ability to forward all traffic coming into the Azure VNet from a hybrid connection to a virtual appliance.</span></span>
* <span data-ttu-id="49eb5-139">**IP Forwarding**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-139">**IP Forwarding**.</span></span> <span data-ttu-id="49eb5-140">By default, the Azure networking engine forward packets to virtual network interface cards (NICs) only if the packet destination IP address matches the NIC IP address.</span><span class="sxs-lookup"><span data-stu-id="49eb5-140">By default, the Azure networking engine forward packets to virtual network interface cards (NICs) only if the packet destination IP address matches the NIC IP address.</span></span> <span data-ttu-id="49eb5-141">Therefore, if a UDR defines that a packet must be sent to a given virtual appliance, the Azure networking engine would drop that packet.</span><span class="sxs-lookup"><span data-stu-id="49eb5-141">Therefore, if a UDR defines that a packet must be sent to a given virtual appliance, the Azure networking engine would drop that packet.</span></span> <span data-ttu-id="49eb5-142">To ensure the packet is delivered to a VM (in this case a virtual appliance) that is not the actual destination for the packet, you need to enable IP Forwarding for the virtual appliance.</span><span class="sxs-lookup"><span data-stu-id="49eb5-142">To ensure the packet is delivered to a VM (in this case a virtual appliance) that is not the actual destination for the packet, you need to enable IP Forwarding for the virtual appliance.</span></span>
* <span data-ttu-id="49eb5-143">**Network Security Groups (NSGs)**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="49eb5-144">The example below does not make use of NSGs, but you could use NSGs applied to the subnets and/or NICs in this solution to further filter the traffic in and out of those subnets and NICs.</span><span class="sxs-lookup"><span data-stu-id="49eb5-144">The example below does not make use of NSGs, but you could use NSGs applied to the subnets and/or NICs in this solution to further filter the traffic in and out of those subnets and NICs.</span></span>

![IPv6 connectivity](https://docstestmedia1.blob.core.windows.net/azure-media/articles/virtual-network/media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="49eb5-146">In this example there is a subscription that contains the following:</span><span class="sxs-lookup"><span data-stu-id="49eb5-146">In this example there is a subscription that contains the following:</span></span>

* <span data-ttu-id="49eb5-147">2 resource groups, not shown in the diagram.</span><span class="sxs-lookup"><span data-stu-id="49eb5-147">2 resource groups, not shown in the diagram.</span></span> 
  * <span data-ttu-id="49eb5-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-148">**ONPREMRG**.</span></span> <span data-ttu-id="49eb5-149">Contains all resources necessary to simulate an on-premises network.</span><span class="sxs-lookup"><span data-stu-id="49eb5-149">Contains all resources necessary to simulate an on-premises network.</span></span>
  * <span data-ttu-id="49eb5-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-150">**AZURERG**.</span></span> <span data-ttu-id="49eb5-151">Contains all resources necessary for the Azure virtual network environment.</span><span class="sxs-lookup"><span data-stu-id="49eb5-151">Contains all resources necessary for the Azure virtual network environment.</span></span> 
* <span data-ttu-id="49eb5-152">A VNet named **onpremvnet** used to mimic an on-premises datacenter segmented as listed below.</span><span class="sxs-lookup"><span data-stu-id="49eb5-152">A VNet named **onpremvnet** used to mimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="49eb5-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-153">**onpremsn1**.</span></span> <span data-ttu-id="49eb5-154">Subnet containing a virtual machine (VM) running Ubuntu to mimic an on-premises server.</span><span class="sxs-lookup"><span data-stu-id="49eb5-154">Subnet containing a virtual machine (VM) running Ubuntu to mimic an on-premises server.</span></span>
  * <span data-ttu-id="49eb5-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-155">**onpremsn2**.</span></span> <span data-ttu-id="49eb5-156">Subnet containing a VM running Ubuntu to mimic an on-premises computer used by an administrator.</span><span class="sxs-lookup"><span data-stu-id="49eb5-156">Subnet containing a VM running Ubuntu to mimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="49eb5-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used to maintain a tunnel to **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used to maintain a tunnel to **azurevnet**.</span></span>
* <span data-ttu-id="49eb5-158">A VNet named **azurevnet** segmented as listed below.</span><span class="sxs-lookup"><span data-stu-id="49eb5-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="49eb5-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-159">**azsn1**.</span></span> <span data-ttu-id="49eb5-160">External firewall subnet used exclusively for the external firewall.</span><span class="sxs-lookup"><span data-stu-id="49eb5-160">External firewall subnet used exclusively for the external firewall.</span></span> <span data-ttu-id="49eb5-161">All Internet traffic will come in through this subnet.</span><span class="sxs-lookup"><span data-stu-id="49eb5-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="49eb5-162">This subnet only contains a NIC linked to the external firewall.</span><span class="sxs-lookup"><span data-stu-id="49eb5-162">This subnet only contains a NIC linked to the external firewall.</span></span>
  * <span data-ttu-id="49eb5-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-163">**azsn2**.</span></span> <span data-ttu-id="49eb5-164">Front end subnet hosting a VM running as a web server that will be accessed from the Internet.</span><span class="sxs-lookup"><span data-stu-id="49eb5-164">Front end subnet hosting a VM running as a web server that will be accessed from the Internet.</span></span>
  * <span data-ttu-id="49eb5-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-165">**azsn3**.</span></span> <span data-ttu-id="49eb5-166">Backend subnet hosting a VM running a backend application server that will be accessed by the front end web server.</span><span class="sxs-lookup"><span data-stu-id="49eb5-166">Backend subnet hosting a VM running a backend application server that will be accessed by the front end web server.</span></span>
  * <span data-ttu-id="49eb5-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-167">**azsn4**.</span></span> <span data-ttu-id="49eb5-168">Management subnet used exclusively to provide management access to all firewall virtual appliances.</span><span class="sxs-lookup"><span data-stu-id="49eb5-168">Management subnet used exclusively to provide management access to all firewall virtual appliances.</span></span> <span data-ttu-id="49eb5-169">This subnet only contains a NIC for each firewall virtual appliance used in the solution.</span><span class="sxs-lookup"><span data-stu-id="49eb5-169">This subnet only contains a NIC for each firewall virtual appliance used in the solution.</span></span>
  * <span data-ttu-id="49eb5-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-170">**GatewaySubnet**.</span></span> <span data-ttu-id="49eb5-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway to provide connectivity between Azure VNets and other networks.</span><span class="sxs-lookup"><span data-stu-id="49eb5-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway to provide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="49eb5-172">There are 3 firewall virtual appliances in the **azurevnet** network.</span><span class="sxs-lookup"><span data-stu-id="49eb5-172">There are 3 firewall virtual appliances in the **azurevnet** network.</span></span> 
  * <span data-ttu-id="49eb5-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-173">**AZF1**.</span></span> <span data-ttu-id="49eb5-174">External firewall exposed to the public Internet by using a public IP address resource in Azure.</span><span class="sxs-lookup"><span data-stu-id="49eb5-174">External firewall exposed to the public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="49eb5-175">You need to ensure you have a template from the Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span><span class="sxs-lookup"><span data-stu-id="49eb5-175">You need to ensure you have a template from the Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="49eb5-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-176">**AZF2**.</span></span> <span data-ttu-id="49eb5-177">Internal firewall used to control traffic between **azsn2** and **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-177">Internal firewall used to control traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="49eb5-178">This is also a 3-NIC virtual appliance.</span><span class="sxs-lookup"><span data-stu-id="49eb5-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="49eb5-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-179">**AZF3**.</span></span> <span data-ttu-id="49eb5-180">Management firewall accessible to administrators from the on-premises datacenter, and connected to a management subnet used to manage all firewall appliances.</span><span class="sxs-lookup"><span data-stu-id="49eb5-180">Management firewall accessible to administrators from the on-premises datacenter, and connected to a management subnet used to manage all firewall appliances.</span></span> <span data-ttu-id="49eb5-181">You can find 2-NIC virtual appliance templates in the Marketplace, or request one directly from your appliance vendor.</span><span class="sxs-lookup"><span data-stu-id="49eb5-181">You can find 2-NIC virtual appliance templates in the Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="49eb5-182">User Defined Routing (UDR)</span><span class="sxs-lookup"><span data-stu-id="49eb5-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="49eb5-183">Each subnet in Azure can be linked to a UDR table used to define how traffic initiated in that subnet is routed.</span><span class="sxs-lookup"><span data-stu-id="49eb5-183">Each subnet in Azure can be linked to a UDR table used to define how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="49eb5-184">If no UDRs are defined, Azure uses default routes to allow traffic to flow from one subnet to another.</span><span class="sxs-lookup"><span data-stu-id="49eb5-184">If no UDRs are defined, Azure uses default routes to allow traffic to flow from one subnet to another.</span></span> <span data-ttu-id="49eb5-185">To better understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="49eb5-185">To better understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="49eb5-186">To ensure communication is done through the right firewall appliance, based on the last requirement above, you need to create the following route table containing UDRs in **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-186">To ensure communication is done through the right firewall appliance, based on the last requirement above, you need to create the following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="49eb5-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="49eb5-187">azgwudr</span></span>
<span data-ttu-id="49eb5-188">In this scenario, the only traffic flowing from on-premises to Azure will be used to manage the firewalls by connecting to **AZF3**, and that traffic must go through the internal firewall, **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-188">In this scenario, the only traffic flowing from on-premises to Azure will be used to manage the firewalls by connecting to **AZF3**, and that traffic must go through the internal firewall, **AZF2**.</span></span> <span data-ttu-id="49eb5-189">Therefore, only one route is necessary in the **GatewaySubnet** as shown below.</span><span class="sxs-lookup"><span data-stu-id="49eb5-189">Therefore, only one route is necessary in the **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="49eb5-190">Destination</span><span class="sxs-lookup"><span data-stu-id="49eb5-190">Destination</span></span> | <span data-ttu-id="49eb5-191">Next hop</span><span class="sxs-lookup"><span data-stu-id="49eb5-191">Next hop</span></span> | <span data-ttu-id="49eb5-192">Explanation</span><span class="sxs-lookup"><span data-stu-id="49eb5-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="49eb5-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="49eb5-193">10.0.4.0/24</span></span> |<span data-ttu-id="49eb5-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="49eb5-194">10.0.3.11</span></span> |<span data-ttu-id="49eb5-195">Allows on-premises traffic to reach management firewall **AZF3**</span><span class="sxs-lookup"><span data-stu-id="49eb5-195">Allows on-premises traffic to reach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="49eb5-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="49eb5-196">azsn2udr</span></span>
| <span data-ttu-id="49eb5-197">Destination</span><span class="sxs-lookup"><span data-stu-id="49eb5-197">Destination</span></span> | <span data-ttu-id="49eb5-198">Next hop</span><span class="sxs-lookup"><span data-stu-id="49eb5-198">Next hop</span></span> | <span data-ttu-id="49eb5-199">Explanation</span><span class="sxs-lookup"><span data-stu-id="49eb5-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="49eb5-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="49eb5-200">10.0.3.0/24</span></span> |<span data-ttu-id="49eb5-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="49eb5-201">10.0.2.11</span></span> |<span data-ttu-id="49eb5-202">Allows traffic to the backend subnet hosting the application server through **AZF2**</span><span class="sxs-lookup"><span data-stu-id="49eb5-202">Allows traffic to the backend subnet hosting the application server through **AZF2**</span></span> |
| <span data-ttu-id="49eb5-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="49eb5-203">0.0.0.0/0</span></span> |<span data-ttu-id="49eb5-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="49eb5-204">10.0.2.10</span></span> |<span data-ttu-id="49eb5-205">Allows all other traffic to be routed through **AZF1**</span><span class="sxs-lookup"><span data-stu-id="49eb5-205">Allows all other traffic to be routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="49eb5-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="49eb5-206">azsn3udr</span></span>
| <span data-ttu-id="49eb5-207">Destination</span><span class="sxs-lookup"><span data-stu-id="49eb5-207">Destination</span></span> | <span data-ttu-id="49eb5-208">Next hop</span><span class="sxs-lookup"><span data-stu-id="49eb5-208">Next hop</span></span> | <span data-ttu-id="49eb5-209">Explanation</span><span class="sxs-lookup"><span data-stu-id="49eb5-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="49eb5-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="49eb5-210">10.0.2.0/24</span></span> |<span data-ttu-id="49eb5-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="49eb5-211">10.0.3.10</span></span> |<span data-ttu-id="49eb5-212">Allows traffic to **azsn2** to flow from app server to the webserver through **AZF2**</span><span class="sxs-lookup"><span data-stu-id="49eb5-212">Allows traffic to **azsn2** to flow from app server to the webserver through **AZF2**</span></span> |

<span data-ttu-id="49eb5-213">You also need to create route tables for the subnets in **onpremvnet** to mimic the on-premises datacenter.</span><span class="sxs-lookup"><span data-stu-id="49eb5-213">You also need to create route tables for the subnets in **onpremvnet** to mimic the on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="49eb5-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="49eb5-214">onpremsn1udr</span></span>
| <span data-ttu-id="49eb5-215">Destination</span><span class="sxs-lookup"><span data-stu-id="49eb5-215">Destination</span></span> | <span data-ttu-id="49eb5-216">Next hop</span><span class="sxs-lookup"><span data-stu-id="49eb5-216">Next hop</span></span> | <span data-ttu-id="49eb5-217">Explanation</span><span class="sxs-lookup"><span data-stu-id="49eb5-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="49eb5-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="49eb5-218">192.168.2.0/24</span></span> |<span data-ttu-id="49eb5-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="49eb5-219">192.168.1.4</span></span> |<span data-ttu-id="49eb5-220">Allows traffic to **onpremsn2** through **OPFW**</span><span class="sxs-lookup"><span data-stu-id="49eb5-220">Allows traffic to **onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="49eb5-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="49eb5-221">onpremsn2udr</span></span>
| <span data-ttu-id="49eb5-222">Destination</span><span class="sxs-lookup"><span data-stu-id="49eb5-222">Destination</span></span> | <span data-ttu-id="49eb5-223">Next hop</span><span class="sxs-lookup"><span data-stu-id="49eb5-223">Next hop</span></span> | <span data-ttu-id="49eb5-224">Explanation</span><span class="sxs-lookup"><span data-stu-id="49eb5-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="49eb5-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="49eb5-225">10.0.3.0/24</span></span> |<span data-ttu-id="49eb5-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="49eb5-226">192.168.2.4</span></span> |<span data-ttu-id="49eb5-227">Allows traffic to the backed subnet in Azure through **OPFW**</span><span class="sxs-lookup"><span data-stu-id="49eb5-227">Allows traffic to the backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="49eb5-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="49eb5-228">192.168.1.0/24</span></span> |<span data-ttu-id="49eb5-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="49eb5-229">192.168.2.4</span></span> |<span data-ttu-id="49eb5-230">Allows traffic to **onpremsn1** through **OPFW**</span><span class="sxs-lookup"><span data-stu-id="49eb5-230">Allows traffic to **onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="49eb5-231">IP Forwarding</span><span class="sxs-lookup"><span data-stu-id="49eb5-231">IP Forwarding</span></span>
<span data-ttu-id="49eb5-232">UDR and IP Forwarding are features that you can use in combination to allow virtual appliances to be used to control traffic flow in an Azure VNet.</span><span class="sxs-lookup"><span data-stu-id="49eb5-232">UDR and IP Forwarding are features that you can use in combination to allow virtual appliances to be used to control traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="49eb5-233">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span><span class="sxs-lookup"><span data-stu-id="49eb5-233">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="49eb5-234">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span><span class="sxs-lookup"><span data-stu-id="49eb5-234">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span></span> <span data-ttu-id="49eb5-235">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span><span class="sxs-lookup"><span data-stu-id="49eb5-235">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span></span> <span data-ttu-id="49eb5-236">This is an Azure setting, not a setting in the guest operating system.</span><span class="sxs-lookup"><span data-stu-id="49eb5-236">This is an Azure setting, not a setting in the guest operating system.</span></span> <span data-ttu-id="49eb5-237">Your virtual appliance still needs to run some type of application to handle the incoming traffic, and route it appropriately.</span><span class="sxs-lookup"><span data-stu-id="49eb5-237">Your virtual appliance still needs to run some type of application to handle the incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="49eb5-238">To learn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="49eb5-238">To learn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="49eb5-239">As an example, imagine you have the following setup in an Azure vnet:</span><span class="sxs-lookup"><span data-stu-id="49eb5-239">As an example, imagine you have the following setup in an Azure vnet:</span></span>

* <span data-ttu-id="49eb5-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="49eb5-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="49eb5-242">A virtual appliance named **OPFW** is connected to **onpremsn1** and **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-242">A virtual appliance named **OPFW** is connected to **onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="49eb5-243">A user defined route linked to **onpremsn1** specifies that all traffic to **onpremsn2** must be sent to **OPFW**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-243">A user defined route linked to **onpremsn1** specifies that all traffic to **onpremsn2** must be sent to **OPFW**.</span></span>

<span data-ttu-id="49eb5-244">At this point, if **onpremvm1** tries to establish a connection with **onpremvm2**, the UDR will be used and traffic will be sent to **OPFW** as the next hop.</span><span class="sxs-lookup"><span data-stu-id="49eb5-244">At this point, if **onpremvm1** tries to establish a connection with **onpremvm2**, the UDR will be used and traffic will be sent to **OPFW** as the next hop.</span></span> <span data-ttu-id="49eb5-245">Keep in mind that the actual packet destination is not being changed, it still says **onpremvm2** is the destination.</span><span class="sxs-lookup"><span data-stu-id="49eb5-245">Keep in mind that the actual packet destination is not being changed, it still says **onpremvm2** is the destination.</span></span> 

<span data-ttu-id="49eb5-246">Without IP Forwarding enabled for **OPFW**, the Azure virtual networking logic will drop the packets, since it only allows packets to be sent to a VM if the VM’s IP address is the destination for the packet.</span><span class="sxs-lookup"><span data-stu-id="49eb5-246">Without IP Forwarding enabled for **OPFW**, the Azure virtual networking logic will drop the packets, since it only allows packets to be sent to a VM if the VM’s IP address is the destination for the packet.</span></span>

<span data-ttu-id="49eb5-247">With IP Forwarding, the Azure virtual network logic will forward the packets to OPFW, without changing its original destination address.</span><span class="sxs-lookup"><span data-stu-id="49eb5-247">With IP Forwarding, the Azure virtual network logic will forward the packets to OPFW, without changing its original destination address.</span></span> <span data-ttu-id="49eb5-248">**OPFW** must handle the packets and determine what to do with them.</span><span class="sxs-lookup"><span data-stu-id="49eb5-248">**OPFW** must handle the packets and determine what to do with them.</span></span>

<span data-ttu-id="49eb5-249">For the scenario above to work, you must enable IP Forwarding on the NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except the ones linked to the management subnet).</span><span class="sxs-lookup"><span data-stu-id="49eb5-249">For the scenario above to work, you must enable IP Forwarding on the NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except the ones linked to the management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="49eb5-250">Firewall Rules</span><span class="sxs-lookup"><span data-stu-id="49eb5-250">Firewall Rules</span></span>
<span data-ttu-id="49eb5-251">As described above, IP Forwarding only ensures packets are sent to the virtual appliances.</span><span class="sxs-lookup"><span data-stu-id="49eb5-251">As described above, IP Forwarding only ensures packets are sent to the virtual appliances.</span></span> <span data-ttu-id="49eb5-252">Your appliance still needs to decide what to do with those packets.</span><span class="sxs-lookup"><span data-stu-id="49eb5-252">Your appliance still needs to decide what to do with those packets.</span></span> <span data-ttu-id="49eb5-253">In the scenario above, you will need to create the following rules in your appliances:</span><span class="sxs-lookup"><span data-stu-id="49eb5-253">In the scenario above, you will need to create the following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="49eb5-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="49eb5-254">OPFW</span></span>
<span data-ttu-id="49eb5-255">OPFW represents an on-premises device containing the following rules:</span><span class="sxs-lookup"><span data-stu-id="49eb5-255">OPFW represents an on-premises device containing the following rules:</span></span>

* <span data-ttu-id="49eb5-256">**Route**: All traffic to 10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-256">**Route**: All traffic to 10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="49eb5-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="49eb5-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="49eb5-258">AZF1</span></span>
<span data-ttu-id="49eb5-259">AZF1 represents an Azure virtual appliance containing the following rules:</span><span class="sxs-lookup"><span data-stu-id="49eb5-259">AZF1 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="49eb5-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="49eb5-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="49eb5-261">AZF2</span></span>
<span data-ttu-id="49eb5-262">AZF2 represents an Azure virtual appliance containing the following rules:</span><span class="sxs-lookup"><span data-stu-id="49eb5-262">AZF2 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="49eb5-263">**Route**: All traffic to 10.0.0.0/16 (**onpremvnet**) must be sent to the Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-263">**Route**: All traffic to 10.0.0.0/16 (**onpremvnet**) must be sent to the Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="49eb5-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="49eb5-265">Network Security Groups (NSGs)</span><span class="sxs-lookup"><span data-stu-id="49eb5-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="49eb5-266">In this scenario, NSGs are not being used.</span><span class="sxs-lookup"><span data-stu-id="49eb5-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="49eb5-267">However, you could apply NSGs to each subnet to restrict incoming and outgoing traffic.</span><span class="sxs-lookup"><span data-stu-id="49eb5-267">However, you could apply NSGs to each subnet to restrict incoming and outgoing traffic.</span></span> <span data-ttu-id="49eb5-268">For instance, you could apply the following NSG rules to the external FW subnet.</span><span class="sxs-lookup"><span data-stu-id="49eb5-268">For instance, you could apply the following NSG rules to the external FW subnet.</span></span>

<span data-ttu-id="49eb5-269">**Incoming**</span><span class="sxs-lookup"><span data-stu-id="49eb5-269">**Incoming**</span></span>

* <span data-ttu-id="49eb5-270">Allow all TCP traffic from the Internet to port 80 on any VM in the subnet.</span><span class="sxs-lookup"><span data-stu-id="49eb5-270">Allow all TCP traffic from the Internet to port 80 on any VM in the subnet.</span></span>
* <span data-ttu-id="49eb5-271">Deny all other traffic from the Internet.</span><span class="sxs-lookup"><span data-stu-id="49eb5-271">Deny all other traffic from the Internet.</span></span>

<span data-ttu-id="49eb5-272">**Outgoing**</span><span class="sxs-lookup"><span data-stu-id="49eb5-272">**Outgoing**</span></span>

* <span data-ttu-id="49eb5-273">Deny all traffic to the Internet.</span><span class="sxs-lookup"><span data-stu-id="49eb5-273">Deny all traffic to the Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="49eb5-274">High level steps</span><span class="sxs-lookup"><span data-stu-id="49eb5-274">High level steps</span></span>
<span data-ttu-id="49eb5-275">To deploy this scenario, follow the high level steps below.</span><span class="sxs-lookup"><span data-stu-id="49eb5-275">To deploy this scenario, follow the high level steps below.</span></span>

1. <span data-ttu-id="49eb5-276">Login to your Azure Subscription.</span><span class="sxs-lookup"><span data-stu-id="49eb5-276">Login to your Azure Subscription.</span></span>
2. <span data-ttu-id="49eb5-277">If you want to deploy a VNet to mimic the on-premises network, provision the resources that are part of **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-277">If you want to deploy a VNet to mimic the on-premises network, provision the resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="49eb5-278">Provision the resources that are part of **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-278">Provision the resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="49eb5-279">Provision the tunnel from **onpremvnet** to **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-279">Provision the tunnel from **onpremvnet** to **azurevnet**.</span></span>
5. <span data-ttu-id="49eb5-280">Once all resources are provisioned, log on to **onpremvm2** and ping 10.0.3.101 to test connectivity between **onpremsn2** and **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="49eb5-280">Once all resources are provisioned, log on to **onpremvm2** and ping 10.0.3.101 to test connectivity between **onpremsn2** and **azsn3**.</span></span>


