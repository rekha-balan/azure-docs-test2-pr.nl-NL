---
title: How to Reprotect from Azure to an on-premises site | Microsoft Docs
description: After failover of VMs to Azure, you can initiate a failback to bring VMs back to on-premises. Learn the steps how to do a reprotect before a failback.
services: site-recovery
documentationcenter: ''
author: ruturaj
manager: gauravd
editor: ''
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: ''
ms.date: 02/13/2017
ms.author: ruturajd
ms.openlocfilehash: 21624eb2d62ab7078a37c547bb7470d6c95d19f3
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44552267"
---
# <a name="reprotect-from-azure-to-an-on-premises-site"></a><span data-ttu-id="46bc7-104">Reprotect from Azure to an on-premises site</span><span class="sxs-lookup"><span data-stu-id="46bc7-104">Reprotect from Azure to an on-premises site</span></span>

## <a name="overview"></a><span data-ttu-id="46bc7-105">Overview</span><span class="sxs-lookup"><span data-stu-id="46bc7-105">Overview</span></span>
<span data-ttu-id="46bc7-106">This article describes how to reprotect Azure virtual machines from Azure to the on-premises site.</span><span class="sxs-lookup"><span data-stu-id="46bc7-106">This article describes how to reprotect Azure virtual machines from Azure to the on-premises site.</span></span> <span data-ttu-id="46bc7-107">Follow the instructions in this article when you're ready to fail back your VMware virtual machines or Windows/Linux physical servers after they've failed over from the on-premises site to Azure by using [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-failover.md).</span><span class="sxs-lookup"><span data-stu-id="46bc7-107">Follow the instructions in this article when you're ready to fail back your VMware virtual machines or Windows/Linux physical servers after they've failed over from the on-premises site to Azure by using [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-failover.md).</span></span>

<span data-ttu-id="46bc7-108">After reprotect finishes and the protected virtual machines are replicating, you can initiate a failback on the virtual machines to bring them to the on-premises site.</span><span class="sxs-lookup"><span data-stu-id="46bc7-108">After reprotect finishes and the protected virtual machines are replicating, you can initiate a failback on the virtual machines to bring them to the on-premises site.</span></span>

<span data-ttu-id="46bc7-109">Post comments or questions at the end of this article or on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span><span class="sxs-lookup"><span data-stu-id="46bc7-109">Post comments or questions at the end of this article or on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>

<span data-ttu-id="46bc7-110">For a quick overview, watch the following video about how to fail over from Azure to an on-premises site.</span><span class="sxs-lookup"><span data-stu-id="46bc7-110">For a quick overview, watch the following video about how to fail over from Azure to an on-premises site.</span></span>
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]


## <a name="prerequisites"></a><span data-ttu-id="46bc7-111">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="46bc7-111">Prerequisites</span></span>
<span data-ttu-id="46bc7-112">Following are the prerequisite steps that you need to take or consider when you prepare for reprotect.</span><span class="sxs-lookup"><span data-stu-id="46bc7-112">Following are the prerequisite steps that you need to take or consider when you prepare for reprotect.</span></span>

* <span data-ttu-id="46bc7-113">If the virtual machines that you want to fail back to are managed by a vCenter server, you need to make sure that you have the required permissions for discovery of virtual machines on vCenter servers.</span><span class="sxs-lookup"><span data-stu-id="46bc7-113">If the virtual machines that you want to fail back to are managed by a vCenter server, you need to make sure that you have the required permissions for discovery of virtual machines on vCenter servers.</span></span> <span data-ttu-id="46bc7-114">[Read more](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access).</span><span class="sxs-lookup"><span data-stu-id="46bc7-114">[Read more](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access).</span></span>
* <span data-ttu-id="46bc7-115">If snapshots are present on the on-premises virtual machine, then reprotection will fail.</span><span class="sxs-lookup"><span data-stu-id="46bc7-115">If snapshots are present on the on-premises virtual machine, then reprotection will fail.</span></span> <span data-ttu-id="46bc7-116">You can delete the snapshots before you proceed to reprotect.</span><span class="sxs-lookup"><span data-stu-id="46bc7-116">You can delete the snapshots before you proceed to reprotect.</span></span>
* <span data-ttu-id="46bc7-117">Before you fail back you’ll need to create two additional components:</span><span class="sxs-lookup"><span data-stu-id="46bc7-117">Before you fail back you’ll need to create two additional components:</span></span>
  * <span data-ttu-id="46bc7-118">**Create a process server**.</span><span class="sxs-lookup"><span data-stu-id="46bc7-118">**Create a process server**.</span></span> <span data-ttu-id="46bc7-119">The process server receives data from the protected virtual machine in Azure and sends data to the on-premises site.</span><span class="sxs-lookup"><span data-stu-id="46bc7-119">The process server receives data from the protected virtual machine in Azure and sends data to the on-premises site.</span></span> <span data-ttu-id="46bc7-120">A low-latency network is required between the process server and the protected virtual machine.</span><span class="sxs-lookup"><span data-stu-id="46bc7-120">A low-latency network is required between the process server and the protected virtual machine.</span></span> <span data-ttu-id="46bc7-121">Thus, you can have an on-premises process server if you are using an Azure ExpressRoute connection or an Azure process server if you are using a VPN.</span><span class="sxs-lookup"><span data-stu-id="46bc7-121">Thus, you can have an on-premises process server if you are using an Azure ExpressRoute connection or an Azure process server if you are using a VPN.</span></span>
  * <span data-ttu-id="46bc7-122">**Create a master target server**: The master target server receives failback data.</span><span class="sxs-lookup"><span data-stu-id="46bc7-122">**Create a master target server**: The master target server receives failback data.</span></span> <span data-ttu-id="46bc7-123">The on-premises management server that you created has a master target server installed by default.</span><span class="sxs-lookup"><span data-stu-id="46bc7-123">The on-premises management server that you created has a master target server installed by default.</span></span> <span data-ttu-id="46bc7-124">However, depending on the volume of failed-back traffic, you might need to create a separate master target server for failback.</span><span class="sxs-lookup"><span data-stu-id="46bc7-124">However, depending on the volume of failed-back traffic, you might need to create a separate master target server for failback.</span></span>
        * <span data-ttu-id="46bc7-125">[A Linux virtual machine needs a Linux master target server](site-recovery-how-to-install-linux-master-target.md).</span><span class="sxs-lookup"><span data-stu-id="46bc7-125">[A Linux virtual machine needs a Linux master target server](site-recovery-how-to-install-linux-master-target.md).</span></span>
        * <span data-ttu-id="46bc7-126">A Windows virtual machine needs a Windows master target server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-126">A Windows virtual machine needs a Windows master target server.</span></span> <span data-ttu-id="46bc7-127">You can use the on-premises process server and master target machines again.</span><span class="sxs-lookup"><span data-stu-id="46bc7-127">You can use the on-premises process server and master target machines again.</span></span>
* <span data-ttu-id="46bc7-128">A configuration server is required on premises when you do a failback.</span><span class="sxs-lookup"><span data-stu-id="46bc7-128">A configuration server is required on premises when you do a failback.</span></span> <span data-ttu-id="46bc7-129">During failback, the virtual machine must exist in the configuration server database.</span><span class="sxs-lookup"><span data-stu-id="46bc7-129">During failback, the virtual machine must exist in the configuration server database.</span></span> <span data-ttu-id="46bc7-130">Otherwise, failback won't be successful.</span><span class="sxs-lookup"><span data-stu-id="46bc7-130">Otherwise, failback won't be successful.</span></span> <span data-ttu-id="46bc7-131">Make sure that you take regularly scheduled backups of your server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-131">Make sure that you take regularly scheduled backups of your server.</span></span> <span data-ttu-id="46bc7-132">If there is a disaster, you need to restore the server with the same IP address so that failback works.</span><span class="sxs-lookup"><span data-stu-id="46bc7-132">If there is a disaster, you need to restore the server with the same IP address so that failback works.</span></span>
* <span data-ttu-id="46bc7-133">Ensure that you set the disk.EnableUUID=true setting in configuration parameters of the master target virtual machine in VMware.</span><span class="sxs-lookup"><span data-stu-id="46bc7-133">Ensure that you set the disk.EnableUUID=true setting in configuration parameters of the master target virtual machine in VMware.</span></span> <span data-ttu-id="46bc7-134">If this row does not exist, add it.</span><span class="sxs-lookup"><span data-stu-id="46bc7-134">If this row does not exist, add it.</span></span> <span data-ttu-id="46bc7-135">This setting is required to provide a consistent UUID to the virtual machine disk (VMDK) so that it mounts correctly.</span><span class="sxs-lookup"><span data-stu-id="46bc7-135">This setting is required to provide a consistent UUID to the virtual machine disk (VMDK) so that it mounts correctly.</span></span>
* <span data-ttu-id="46bc7-136">*You cannot use Storage vMaster for master target server*.</span><span class="sxs-lookup"><span data-stu-id="46bc7-136">*You cannot use Storage vMaster for master target server*.</span></span> <span data-ttu-id="46bc7-137">This can cause the failback to fail.</span><span class="sxs-lookup"><span data-stu-id="46bc7-137">This can cause the failback to fail.</span></span> <span data-ttu-id="46bc7-138">The virtual machine will not start because the disks will not be made available to it.</span><span class="sxs-lookup"><span data-stu-id="46bc7-138">The virtual machine will not start because the disks will not be made available to it.</span></span>
* <span data-ttu-id="46bc7-139">You need add a new drive to the master target server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-139">You need add a new drive to the master target server.</span></span> <span data-ttu-id="46bc7-140">This drive is called a retention drive.</span><span class="sxs-lookup"><span data-stu-id="46bc7-140">This drive is called a retention drive.</span></span> <span data-ttu-id="46bc7-141">Add a new disk and format the drive.</span><span class="sxs-lookup"><span data-stu-id="46bc7-141">Add a new disk and format the drive.</span></span>
* <span data-ttu-id="46bc7-142">Master target has other prerequisites that are listed in [Common things to check on a master target before reprotect](site-recovery-how-to-reprotect.md#common-things-to-check-after-completing-installation-of-the-master-target-server).</span><span class="sxs-lookup"><span data-stu-id="46bc7-142">Master target has other prerequisites that are listed in [Common things to check on a master target before reprotect](site-recovery-how-to-reprotect.md#common-things-to-check-after-completing-installation-of-the-master-target-server).</span></span>


### <a name="why-do-i-need-a-s2s-vpn-or-an-expressroute-connection-to-replicate-data-back-to-the-on-premises-site"></a><span data-ttu-id="46bc7-143">Why do I need a S2S VPN or an ExpressRoute connection to replicate data back to the on-premises site?</span><span class="sxs-lookup"><span data-stu-id="46bc7-143">Why do I need a S2S VPN or an ExpressRoute connection to replicate data back to the on-premises site?</span></span>
<span data-ttu-id="46bc7-144">Where replication from on premises to Azure can happen over the Internet or an ExpressRoute connection that has public peering, reprotect and failback requires a site-to-site (S2S) VPN to replicate data.</span><span class="sxs-lookup"><span data-stu-id="46bc7-144">Where replication from on premises to Azure can happen over the Internet or an ExpressRoute connection that has public peering, reprotect and failback requires a site-to-site (S2S) VPN to replicate data.</span></span> <span data-ttu-id="46bc7-145">The network should be provided so that the failed-over virtual machines in Azure can reach (ping) the on-premises configuration server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-145">The network should be provided so that the failed-over virtual machines in Azure can reach (ping) the on-premises configuration server.</span></span> <span data-ttu-id="46bc7-146">You might also be deploying a process server in the Azure network of the failed-over virtual machine.</span><span class="sxs-lookup"><span data-stu-id="46bc7-146">You might also be deploying a process server in the Azure network of the failed-over virtual machine.</span></span> <span data-ttu-id="46bc7-147">This process server should also be able to communicate with the on-premises configuration server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-147">This process server should also be able to communicate with the on-premises configuration server.</span></span>

### <a name="when-should-i-install-a-process-server-in-azure"></a><span data-ttu-id="46bc7-148">When should I install a process server in Azure?</span><span class="sxs-lookup"><span data-stu-id="46bc7-148">When should I install a process server in Azure?</span></span>


<span data-ttu-id="46bc7-149">The virtual machines on Azure that you want to reprotect send replication data to a process server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-149">The virtual machines on Azure that you want to reprotect send replication data to a process server.</span></span> <span data-ttu-id="46bc7-150">Your network should be set up so that the virtual machines on Azure can reach the process server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-150">Your network should be set up so that the virtual machines on Azure can reach the process server.</span></span>

<span data-ttu-id="46bc7-151">You can deploy a process server in Azure or use the existing process server that you used during failover.</span><span class="sxs-lookup"><span data-stu-id="46bc7-151">You can deploy a process server in Azure or use the existing process server that you used during failover.</span></span> <span data-ttu-id="46bc7-152">The important point to consider is the latency to send the data from the virtual machines on Azure to the process server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-152">The important point to consider is the latency to send the data from the virtual machines on Azure to the process server.</span></span>

<span data-ttu-id="46bc7-153">If you have an ExpressRoute connection set up, an on-premises process server can be used to send data because the latency between the virtual machine and the process server is low.</span><span class="sxs-lookup"><span data-stu-id="46bc7-153">If you have an ExpressRoute connection set up, an on-premises process server can be used to send data because the latency between the virtual machine and the process server is low.</span></span>

 ![Architecture diagram for ExpressRoute](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-classic/architecture.png)



<span data-ttu-id="46bc7-155">However, if you have only an S2S VPN, then we recommend deploying the process server in Azure.</span><span class="sxs-lookup"><span data-stu-id="46bc7-155">However, if you have only an S2S VPN, then we recommend deploying the process server in Azure.</span></span>

 ![Architecture Diagram for VPN](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-classic/architecture2.png)


<span data-ttu-id="46bc7-157">Remember that replication will happen only over the S2S VPN or the private peering of your ExpressRoute network.</span><span class="sxs-lookup"><span data-stu-id="46bc7-157">Remember that replication will happen only over the S2S VPN or the private peering of your ExpressRoute network.</span></span> <span data-ttu-id="46bc7-158">Ensure that enough bandwidth is available over that network channel.</span><span class="sxs-lookup"><span data-stu-id="46bc7-158">Ensure that enough bandwidth is available over that network channel.</span></span>

<span data-ttu-id="46bc7-159">Read more about how to install an [Azure process server](site-recovery-vmware-setup-azure-ps-resource-manager.md).</span><span class="sxs-lookup"><span data-stu-id="46bc7-159">Read more about how to install an [Azure process server](site-recovery-vmware-setup-azure-ps-resource-manager.md).</span></span>

### <a name="what-are-the-ports-to-be-open-on-different-components-so-that-reprotect-can-work"></a><span data-ttu-id="46bc7-160">What are the ports to be open on different components so that reprotect can work?</span><span class="sxs-lookup"><span data-stu-id="46bc7-160">What are the ports to be open on different components so that reprotect can work?</span></span>

![Failover-failback all ports](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

### <a name="which-master-target-server-should-be-used-for-reprotect"></a><span data-ttu-id="46bc7-162">Which master target server should be used for reprotect?</span><span class="sxs-lookup"><span data-stu-id="46bc7-162">Which master target server should be used for reprotect?</span></span>
<span data-ttu-id="46bc7-163">An on-premises master target server is required to receive data from the process server and then write to the on-premises virtual machine's VMDK.</span><span class="sxs-lookup"><span data-stu-id="46bc7-163">An on-premises master target server is required to receive data from the process server and then write to the on-premises virtual machine's VMDK.</span></span> <span data-ttu-id="46bc7-164">If you are protecting Windows virtual machines, you need a Windows master target server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-164">If you are protecting Windows virtual machines, you need a Windows master target server.</span></span> <span data-ttu-id="46bc7-165">You can reuse the on-premises process server and master target <!-- !todo component -->.</span><span class="sxs-lookup"><span data-stu-id="46bc7-165">You can reuse the on-premises process server and master target <!-- !todo component -->.</span></span> <span data-ttu-id="46bc7-166">For Linux virtual machines, you need to set up an additional on-premises Linux master target.</span><span class="sxs-lookup"><span data-stu-id="46bc7-166">For Linux virtual machines, you need to set up an additional on-premises Linux master target.</span></span>


<span data-ttu-id="46bc7-167">Click the following links to read about how to install a master target server:</span><span class="sxs-lookup"><span data-stu-id="46bc7-167">Click the following links to read about how to install a master target server:</span></span>

* [<span data-ttu-id="46bc7-168">How to install Windows master target server</span><span class="sxs-lookup"><span data-stu-id="46bc7-168">How to install Windows master target server</span></span>](site-recovery-vmware-to-azure.md#run-site-recovery-unified-setup)
* [<span data-ttu-id="46bc7-169">How to install Linux master target server</span><span class="sxs-lookup"><span data-stu-id="46bc7-169">How to install Linux master target server</span></span>](site-recovery-how-to-install-linux-master-target.md)


#### <a name="common-things-to-check-after-completing-installation-of-the-master-target-server"></a><span data-ttu-id="46bc7-170">Common things to check after completing installation of the master target server</span><span class="sxs-lookup"><span data-stu-id="46bc7-170">Common things to check after completing installation of the master target server</span></span>

* <span data-ttu-id="46bc7-171">If the virtual machine is present on premises on the vCenter server, the master target server needs access to the on-premises virtual machine's VMDK.</span><span class="sxs-lookup"><span data-stu-id="46bc7-171">If the virtual machine is present on premises on the vCenter server, the master target server needs access to the on-premises virtual machine's VMDK.</span></span> <span data-ttu-id="46bc7-172">Access is needed to write the replicated data to the virtual machine's disks.</span><span class="sxs-lookup"><span data-stu-id="46bc7-172">Access is needed to write the replicated data to the virtual machine's disks.</span></span> <span data-ttu-id="46bc7-173">Ensure that the on-premises virtual machine's datastore is mounted on the master target's host with read/write access.</span><span class="sxs-lookup"><span data-stu-id="46bc7-173">Ensure that the on-premises virtual machine's datastore is mounted on the master target's host with read/write access.</span></span>

* <span data-ttu-id="46bc7-174">If the virtual machine is not present on premises on the vCenter server, you need to create a new virtual machine during reprotect.</span><span class="sxs-lookup"><span data-stu-id="46bc7-174">If the virtual machine is not present on premises on the vCenter server, you need to create a new virtual machine during reprotect.</span></span> <span data-ttu-id="46bc7-175">This virtual machine will be created on the ESX host on which you create the master target.</span><span class="sxs-lookup"><span data-stu-id="46bc7-175">This virtual machine will be created on the ESX host on which you create the master target.</span></span> <span data-ttu-id="46bc7-176">Choose the ESX host carefully, so that the failback virtual machine is created on the host that you want.</span><span class="sxs-lookup"><span data-stu-id="46bc7-176">Choose the ESX host carefully, so that the failback virtual machine is created on the host that you want.</span></span>

* <span data-ttu-id="46bc7-177">*You cannot use Storage vMotion for the master target server*.</span><span class="sxs-lookup"><span data-stu-id="46bc7-177">*You cannot use Storage vMotion for the master target server*.</span></span> <span data-ttu-id="46bc7-178">This can cause the failback to fail.</span><span class="sxs-lookup"><span data-stu-id="46bc7-178">This can cause the failback to fail.</span></span> <span data-ttu-id="46bc7-179">The virtual machine will not start because the disks will not be made available to it.</span><span class="sxs-lookup"><span data-stu-id="46bc7-179">The virtual machine will not start because the disks will not be made available to it.</span></span>

* <span data-ttu-id="46bc7-180">You need to add a new drive to your existing Windows master target server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-180">You need to add a new drive to your existing Windows master target server.</span></span> <span data-ttu-id="46bc7-181">This drive is called a retention drive.</span><span class="sxs-lookup"><span data-stu-id="46bc7-181">This drive is called a retention drive.</span></span> <span data-ttu-id="46bc7-182">Add a new disk and format the drive.</span><span class="sxs-lookup"><span data-stu-id="46bc7-182">Add a new disk and format the drive.</span></span> <span data-ttu-id="46bc7-183">The retention drive is used to stop the points in time when the virtual machine replicates back to the on-premises site.</span><span class="sxs-lookup"><span data-stu-id="46bc7-183">The retention drive is used to stop the points in time when the virtual machine replicates back to the on-premises site.</span></span> <span data-ttu-id="46bc7-184">Following are some criteria of a retention drive without which the drive will not be listed for the master target server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-184">Following are some criteria of a retention drive without which the drive will not be listed for the master target server.</span></span>

   * <span data-ttu-id="46bc7-185">The volume shouldn't be used for any other purpose, such as a target of replication, etc.</span><span class="sxs-lookup"><span data-stu-id="46bc7-185">The volume shouldn't be used for any other purpose, such as a target of replication, etc.</span></span>

   * <span data-ttu-id="46bc7-186">The volume shouldn't be in lock mode.</span><span class="sxs-lookup"><span data-stu-id="46bc7-186">The volume shouldn't be in lock mode.</span></span>

   * <span data-ttu-id="46bc7-187">The volume shouldn't be cache volume.</span><span class="sxs-lookup"><span data-stu-id="46bc7-187">The volume shouldn't be cache volume.</span></span> <span data-ttu-id="46bc7-188">The master target installation shouldn't exist on that volume.</span><span class="sxs-lookup"><span data-stu-id="46bc7-188">The master target installation shouldn't exist on that volume.</span></span> <span data-ttu-id="46bc7-189">The process server and master target custom installation volume is not eligible for a retention volume.</span><span class="sxs-lookup"><span data-stu-id="46bc7-189">The process server and master target custom installation volume is not eligible for a retention volume.</span></span> <span data-ttu-id="46bc7-190">When the process server and master target are installed on a volume, the volume is a cache volume of the master target.</span><span class="sxs-lookup"><span data-stu-id="46bc7-190">When the process server and master target are installed on a volume, the volume is a cache volume of the master target.</span></span>

   * <span data-ttu-id="46bc7-191">The file system type of the volume shouldn't be FAT or FAT32.</span><span class="sxs-lookup"><span data-stu-id="46bc7-191">The file system type of the volume shouldn't be FAT or FAT32.</span></span>

   * <span data-ttu-id="46bc7-192">The volume capacity should be non-zero.</span><span class="sxs-lookup"><span data-stu-id="46bc7-192">The volume capacity should be non-zero.</span></span>

   * <span data-ttu-id="46bc7-193">The default retention volume for Windows is R volume.</span><span class="sxs-lookup"><span data-stu-id="46bc7-193">The default retention volume for Windows is R volume.</span></span>

   * <span data-ttu-id="46bc7-194">The default retention volume for Linux is /mnt/retention.</span><span class="sxs-lookup"><span data-stu-id="46bc7-194">The default retention volume for Linux is /mnt/retention.</span></span>

* <span data-ttu-id="46bc7-195">A Linux failed-over virtual machine needs a Linux master target server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-195">A Linux failed-over virtual machine needs a Linux master target server.</span></span> <span data-ttu-id="46bc7-196">A Windows failed-over virtual machine requires a Windows master target server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-196">A Windows failed-over virtual machine requires a Windows master target server.</span></span>

* <span data-ttu-id="46bc7-197">Install VMware tools on the master target server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-197">Install VMware tools on the master target server.</span></span> <span data-ttu-id="46bc7-198">Without the VMware tools, the datastores on the master target's ESXi host cannot be detected.</span><span class="sxs-lookup"><span data-stu-id="46bc7-198">Without the VMware tools, the datastores on the master target's ESXi host cannot be detected.</span></span>

* <span data-ttu-id="46bc7-199">Enable the disk.EnableUUID=true parameter on the master target virtual machine by using the vCenter properties.</span><span class="sxs-lookup"><span data-stu-id="46bc7-199">Enable the disk.EnableUUID=true parameter on the master target virtual machine by using the vCenter properties.</span></span> <!-- !todo Needs link. -->

* <span data-ttu-id="46bc7-200">The master target should have at least one virtual machine file system (VMFS) datastore attached.</span><span class="sxs-lookup"><span data-stu-id="46bc7-200">The master target should have at least one virtual machine file system (VMFS) datastore attached.</span></span> <span data-ttu-id="46bc7-201">If there is none, the **Datastore** input on the reprotect page will be empty, and you will not be able to proceed.</span><span class="sxs-lookup"><span data-stu-id="46bc7-201">If there is none, the **Datastore** input on the reprotect page will be empty, and you will not be able to proceed.</span></span>

* <span data-ttu-id="46bc7-202">The master target server cannot have snapshots on the disks.</span><span class="sxs-lookup"><span data-stu-id="46bc7-202">The master target server cannot have snapshots on the disks.</span></span> <span data-ttu-id="46bc7-203">If there are snapshots, reprotect and failback will fail.</span><span class="sxs-lookup"><span data-stu-id="46bc7-203">If there are snapshots, reprotect and failback will fail.</span></span>

* <span data-ttu-id="46bc7-204">The master target cannot have a Paravirtual SCSI controller.</span><span class="sxs-lookup"><span data-stu-id="46bc7-204">The master target cannot have a Paravirtual SCSI controller.</span></span> <span data-ttu-id="46bc7-205">The controller can only be an LSI Logic controller.</span><span class="sxs-lookup"><span data-stu-id="46bc7-205">The controller can only be an LSI Logic controller.</span></span> <span data-ttu-id="46bc7-206">Without an LSI Logic controller, reprotect will fail.</span><span class="sxs-lookup"><span data-stu-id="46bc7-206">Without an LSI Logic controller, reprotect will fail.</span></span>

<!--
### Failback policy
To replicate back to on-premises, you will need a failback policy. This policy get automatically created when you create a forward direction policy. Note that

1. This policy gets auto associated with the configuration server during creation.
2. This policy is not editable.
3. The set values of the policy are (RPO Threshold = 15 Mins, Recovery Point Retention = 24 Hours, App Consistency Snapshot Frequency = 60 Mins)
   ![](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-new/failback-policy.png)

-->

## <a name="steps-to-reprotect"></a><span data-ttu-id="46bc7-207">Steps to reprotect</span><span class="sxs-lookup"><span data-stu-id="46bc7-207">Steps to reprotect</span></span>

<span data-ttu-id="46bc7-208">Before reprotection, make sure that you install the [process server](site-recovery-vmware-setup-azure-ps-resource-manager.md) in Azure and the on-premises Windows or [Linux master target](site-recovery-how-to-install-linux-master-target.md).</span><span class="sxs-lookup"><span data-stu-id="46bc7-208">Before reprotection, make sure that you install the [process server](site-recovery-vmware-setup-azure-ps-resource-manager.md) in Azure and the on-premises Windows or [Linux master target](site-recovery-how-to-install-linux-master-target.md).</span></span>

> [!NOTE]
> <span data-ttu-id="46bc7-209">After a virtual machine boots up in Azure, it takes some time for the agent to register back to the configuration server (up to 15 minutes).</span><span class="sxs-lookup"><span data-stu-id="46bc7-209">After a virtual machine boots up in Azure, it takes some time for the agent to register back to the configuration server (up to 15 minutes).</span></span> <span data-ttu-id="46bc7-210">During this time, reprotect will fail, and an error message indicates that the agent is not installed.</span><span class="sxs-lookup"><span data-stu-id="46bc7-210">During this time, reprotect will fail, and an error message indicates that the agent is not installed.</span></span> <span data-ttu-id="46bc7-211">Wait for a few minutes, and then try reprotect again.</span><span class="sxs-lookup"><span data-stu-id="46bc7-211">Wait for a few minutes, and then try reprotect again.</span></span>



1. <span data-ttu-id="46bc7-212">In **Vault** > **Replicated items**, right-click the virtual machine that's been failed over, and then select **Re-Protect**.</span><span class="sxs-lookup"><span data-stu-id="46bc7-212">In **Vault** > **Replicated items**, right-click the virtual machine that's been failed over, and then select **Re-Protect**.</span></span> <span data-ttu-id="46bc7-213">You can also click the machine and select **Re-Protect** from the command buttons.</span><span class="sxs-lookup"><span data-stu-id="46bc7-213">You can also click the machine and select **Re-Protect** from the command buttons.</span></span>
2. <span data-ttu-id="46bc7-214">In the blade, notice that the direction of protection, **Azure to On-premises**, is already selected.</span><span class="sxs-lookup"><span data-stu-id="46bc7-214">In the blade, notice that the direction of protection, **Azure to On-premises**, is already selected.</span></span>
3. <span data-ttu-id="46bc7-215">In **Master Target Server** and **Process Server**, select the on-premises master target server and the process server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-215">In **Master Target Server** and **Process Server**, select the on-premises master target server and the process server.</span></span>
4. <span data-ttu-id="46bc7-216">Select the **Datastore** to which you want to recover the disks on premises.</span><span class="sxs-lookup"><span data-stu-id="46bc7-216">Select the **Datastore** to which you want to recover the disks on premises.</span></span> <span data-ttu-id="46bc7-217">This option is used when the on-premises virtual machine is deleted, and you need to create new disks.</span><span class="sxs-lookup"><span data-stu-id="46bc7-217">This option is used when the on-premises virtual machine is deleted, and you need to create new disks.</span></span> <span data-ttu-id="46bc7-218">This option is ignored if the disks already exist, but you still need to specify a value.</span><span class="sxs-lookup"><span data-stu-id="46bc7-218">This option is ignored if the disks already exist, but you still need to specify a value.</span></span>
5. <span data-ttu-id="46bc7-219">Choose the retention drive.</span><span class="sxs-lookup"><span data-stu-id="46bc7-219">Choose the retention drive.</span></span>
6. <span data-ttu-id="46bc7-220">The failback policy will be auto-selected.</span><span class="sxs-lookup"><span data-stu-id="46bc7-220">The failback policy will be auto-selected.</span></span>
7. <span data-ttu-id="46bc7-221">After you click **OK** to begin reprotection, a job begins to replicate the virtual machine from Azure to the on-premises site.</span><span class="sxs-lookup"><span data-stu-id="46bc7-221">After you click **OK** to begin reprotection, a job begins to replicate the virtual machine from Azure to the on-premises site.</span></span> <span data-ttu-id="46bc7-222">You can track the progress on the **Jobs** tab.</span><span class="sxs-lookup"><span data-stu-id="46bc7-222">You can track the progress on the **Jobs** tab.</span></span>

<span data-ttu-id="46bc7-223">If you want to recover to an alternate location (when the on-premises virtual machine is deleted), select the retention drive and datastore that's configured for the master target server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-223">If you want to recover to an alternate location (when the on-premises virtual machine is deleted), select the retention drive and datastore that's configured for the master target server.</span></span> <span data-ttu-id="46bc7-224">When you fail back to the on-premises site, the VMware virtual machine's in the failback protection plan will use the same datastore as the master target server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-224">When you fail back to the on-premises site, the VMware virtual machine's in the failback protection plan will use the same datastore as the master target server.</span></span> <span data-ttu-id="46bc7-225">A new virtual machine will be created in vCenter.</span><span class="sxs-lookup"><span data-stu-id="46bc7-225">A new virtual machine will be created in vCenter.</span></span>
<span data-ttu-id="46bc7-226">If you want to recover the virtual machine on Azure to an existing on-premises virtual machine, the on-premises virtual machine's datastores should be mounted with read/write access on the master target server's ESXi host.</span><span class="sxs-lookup"><span data-stu-id="46bc7-226">If you want to recover the virtual machine on Azure to an existing on-premises virtual machine, the on-premises virtual machine's datastores should be mounted with read/write access on the master target server's ESXi host.</span></span>
    <span data-ttu-id="46bc7-227">![Re-protect dialog box](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)</span><span class="sxs-lookup"><span data-stu-id="46bc7-227">![Re-protect dialog box](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)</span></span>

<span data-ttu-id="46bc7-228">You can also reprotect at the level of a recovery plan.</span><span class="sxs-lookup"><span data-stu-id="46bc7-228">You can also reprotect at the level of a recovery plan.</span></span> <span data-ttu-id="46bc7-229">A replication group can only be reprotected by using a recovery plan.</span><span class="sxs-lookup"><span data-stu-id="46bc7-229">A replication group can only be reprotected by using a recovery plan.</span></span> <span data-ttu-id="46bc7-230">When you reprotect by using a recovery plan, you will need to provide the values for every protected machine.</span><span class="sxs-lookup"><span data-stu-id="46bc7-230">When you reprotect by using a recovery plan, you will need to provide the values for every protected machine.</span></span>

> [!NOTE]
> <span data-ttu-id="46bc7-231">A replication group should be protected back by using the same master target.</span><span class="sxs-lookup"><span data-stu-id="46bc7-231">A replication group should be protected back by using the same master target.</span></span> <span data-ttu-id="46bc7-232">If they are protected back by using a different master target server, the server cannot provide a common point in time.</span><span class="sxs-lookup"><span data-stu-id="46bc7-232">If they are protected back by using a different master target server, the server cannot provide a common point in time.</span></span>


<span data-ttu-id="46bc7-233">After the reprotect succeed, the virtual machine will enter a protected state.</span><span class="sxs-lookup"><span data-stu-id="46bc7-233">After the reprotect succeed, the virtual machine will enter a protected state.</span></span>

## <a name="next-steps"></a><span data-ttu-id="46bc7-234">Next steps</span><span class="sxs-lookup"><span data-stu-id="46bc7-234">Next steps</span></span>

<span data-ttu-id="46bc7-235">After the virtual machine has entered a protected state, you can initiate a failback.</span><span class="sxs-lookup"><span data-stu-id="46bc7-235">After the virtual machine has entered a protected state, you can initiate a failback.</span></span> <span data-ttu-id="46bc7-236">The failback will shut down the virtual machine in Azure and boot the on-premises virtual machine.</span><span class="sxs-lookup"><span data-stu-id="46bc7-236">The failback will shut down the virtual machine in Azure and boot the on-premises virtual machine.</span></span> <span data-ttu-id="46bc7-237">Hence there is a small downtime for the application.</span><span class="sxs-lookup"><span data-stu-id="46bc7-237">Hence there is a small downtime for the application.</span></span> <span data-ttu-id="46bc7-238">So, choose the time for failback when your application can tolerate a downtime.</span><span class="sxs-lookup"><span data-stu-id="46bc7-238">So, choose the time for failback when your application can tolerate a downtime.</span></span>

[<span data-ttu-id="46bc7-239">Steps to initiate failback of the virtual machine</span><span class="sxs-lookup"><span data-stu-id="46bc7-239">Steps to initiate failback of the virtual machine</span></span>](site-recovery-how-to-failback-azure-to-vmware.md#steps-to-fail-back)

## <a name="common-issues"></a><span data-ttu-id="46bc7-240">Common issues</span><span class="sxs-lookup"><span data-stu-id="46bc7-240">Common issues</span></span>

* <span data-ttu-id="46bc7-241">If you used a template to create your virtual machines, ensure that each virtual machine has a unique UUID for the disks.</span><span class="sxs-lookup"><span data-stu-id="46bc7-241">If you used a template to create your virtual machines, ensure that each virtual machine has a unique UUID for the disks.</span></span> <span data-ttu-id="46bc7-242">If the on-premises virtual machine's UUID clashes with that of the master target because both were created from the same template, reprotection will fail.</span><span class="sxs-lookup"><span data-stu-id="46bc7-242">If the on-premises virtual machine's UUID clashes with that of the master target because both were created from the same template, reprotection will fail.</span></span> <span data-ttu-id="46bc7-243">You need to deploy another master target that has not been created from the same template.</span><span class="sxs-lookup"><span data-stu-id="46bc7-243">You need to deploy another master target that has not been created from the same template.</span></span>
* <span data-ttu-id="46bc7-244">If you perform a read-only user vCenter discovery and protect virtual machines, protection succeeds, and failover works.</span><span class="sxs-lookup"><span data-stu-id="46bc7-244">If you perform a read-only user vCenter discovery and protect virtual machines, protection succeeds, and failover works.</span></span> <span data-ttu-id="46bc7-245">During reprotection, failover fails because the datastores cannot be discovered.</span><span class="sxs-lookup"><span data-stu-id="46bc7-245">During reprotection, failover fails because the datastores cannot be discovered.</span></span> <span data-ttu-id="46bc7-246">As a symptom, you will not see the datastores listed during reprotection.</span><span class="sxs-lookup"><span data-stu-id="46bc7-246">As a symptom, you will not see the datastores listed during reprotection.</span></span> <span data-ttu-id="46bc7-247">To resolve this issue, you can update the vCenter credential with an appropriate account that has permissions, and retry the job.</span><span class="sxs-lookup"><span data-stu-id="46bc7-247">To resolve this issue, you can update the vCenter credential with an appropriate account that has permissions, and retry the job.</span></span> <span data-ttu-id="46bc7-248">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access).</span><span class="sxs-lookup"><span data-stu-id="46bc7-248">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access).</span></span>
* <span data-ttu-id="46bc7-249">When you fail back a Linux virtual machine and run it on premises, you can see that the Network Manager package has been uninstalled from the machine.</span><span class="sxs-lookup"><span data-stu-id="46bc7-249">When you fail back a Linux virtual machine and run it on premises, you can see that the Network Manager package has been uninstalled from the machine.</span></span> <span data-ttu-id="46bc7-250">This uninstallation happens because the Network Manager package is removed when the virtual machine is recovered in Azure.</span><span class="sxs-lookup"><span data-stu-id="46bc7-250">This uninstallation happens because the Network Manager package is removed when the virtual machine is recovered in Azure.</span></span>
* <span data-ttu-id="46bc7-251">When a Linux virtual machine is configured with a static IP address and is failed over to Azure, the IP address is acquired from DHCP.</span><span class="sxs-lookup"><span data-stu-id="46bc7-251">When a Linux virtual machine is configured with a static IP address and is failed over to Azure, the IP address is acquired from DHCP.</span></span> <span data-ttu-id="46bc7-252">When you fail over to on premises, the virtual machine continues to use DHCP to acquire the IP address.</span><span class="sxs-lookup"><span data-stu-id="46bc7-252">When you fail over to on premises, the virtual machine continues to use DHCP to acquire the IP address.</span></span> <span data-ttu-id="46bc7-253">Manually sign in to the machine, and set the IP address back to a static address if necessary.</span><span class="sxs-lookup"><span data-stu-id="46bc7-253">Manually sign in to the machine, and set the IP address back to a static address if necessary.</span></span> <span data-ttu-id="46bc7-254">A Windows virtual machine can acquire its static IP again.</span><span class="sxs-lookup"><span data-stu-id="46bc7-254">A Windows virtual machine can acquire its static IP again.</span></span>
* <span data-ttu-id="46bc7-255">If you use either ESXi 5.5 free edition or vSphere 6 Hypervisor free edition, failover succeeds, but failback does not succeed.</span><span class="sxs-lookup"><span data-stu-id="46bc7-255">If you use either ESXi 5.5 free edition or vSphere 6 Hypervisor free edition, failover succeeds, but failback does not succeed.</span></span> <span data-ttu-id="46bc7-256">To enable failback, upgrade to either program's evaluation license.</span><span class="sxs-lookup"><span data-stu-id="46bc7-256">To enable failback, upgrade to either program's evaluation license.</span></span>
* <span data-ttu-id="46bc7-257">If you cannot reach the configuration server from the process server, use Telnet to check connectivity to the configuration server on port 443.</span><span class="sxs-lookup"><span data-stu-id="46bc7-257">If you cannot reach the configuration server from the process server, use Telnet to check connectivity to the configuration server on port 443.</span></span> <span data-ttu-id="46bc7-258">You can also try to ping the configuration server from the process server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-258">You can also try to ping the configuration server from the process server.</span></span> <span data-ttu-id="46bc7-259">A process server should also have a heartbeat when it is connected to the configuration server.</span><span class="sxs-lookup"><span data-stu-id="46bc7-259">A process server should also have a heartbeat when it is connected to the configuration server.</span></span>
* <span data-ttu-id="46bc7-260">If you are trying to fail back to an alternate vCenter, make sure that your new vCenter is discovered and that the master target server is also discovered.</span><span class="sxs-lookup"><span data-stu-id="46bc7-260">If you are trying to fail back to an alternate vCenter, make sure that your new vCenter is discovered and that the master target server is also discovered.</span></span> <span data-ttu-id="46bc7-261">A typical symptom is that the datastores are not accessible or visible in the **Reprotect** dialog box.</span><span class="sxs-lookup"><span data-stu-id="46bc7-261">A typical symptom is that the datastores are not accessible or visible in the **Reprotect** dialog box.</span></span>
* <span data-ttu-id="46bc7-262">A Windows Server 2008 R2 SP1 server that is protected as a physical on-premises server cannot be failed back from Azure to an on-premises site.</span><span class="sxs-lookup"><span data-stu-id="46bc7-262">A Windows Server 2008 R2 SP1 server that is protected as a physical on-premises server cannot be failed back from Azure to an on-premises site.</span></span>





