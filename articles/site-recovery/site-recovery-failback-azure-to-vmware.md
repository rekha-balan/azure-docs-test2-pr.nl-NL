---
title: Failback VMware VMs from Azure to on-premises | Microsoft Docs
description: Learn about failing back to the on-premises site after failover of VMware VMs and physical servers to Azure.
services: site-recovery
documentationcenter: ''
author: ruturaj
manager: mkjain
editor: ''
ms.assetid: 5a47337f-89a9-43e8-8fdc-7da373c0fb0f
ms.service: site-recovery
ms.devlang: na
ms.tgt_pltfrm: na
ms.topic: article
ms.workload: required
ms.date: 03/27/2017
ms.author: ruturajd
ms.openlocfilehash: 104c2948a7e14bf6592a40b60956a2cf070936fb
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44551165"
---
# <a name="fail-back-vmware-virtual-machines-and-physical-servers-to-the-on-premises-site"></a><span data-ttu-id="1e8ff-103">Fail back VMware virtual machines and physical servers to the on-premises site</span><span class="sxs-lookup"><span data-stu-id="1e8ff-103">Fail back VMware virtual machines and physical servers to the on-premises site</span></span>
> [!div class="op_single_selector"]
> * [VMware/physical machines from Azure](site-recovery-failback-azure-to-vmware.md)
> * [Hyper-V VMs from Azure](site-recovery-failback-from-azure-to-hyper-v.md)

<span data-ttu-id="1e8ff-106">This article describes how to failback Azure virtual machines from Azure to the on-premises site.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-106">This article describes how to failback Azure virtual machines from Azure to the on-premises site.</span></span> <span data-ttu-id="1e8ff-107">Follow the instructions here when you're ready to fail back your VMware virtual machines or Windows or Linux physical servers after you have re-protected your machines using this [reference](site-recovery-how-to-reprotect.md).</span><span class="sxs-lookup"><span data-stu-id="1e8ff-107">Follow the instructions here when you're ready to fail back your VMware virtual machines or Windows or Linux physical servers after you have re-protected your machines using this [reference](site-recovery-how-to-reprotect.md).</span></span>

>[!NOTE]
>If you are using the classic Azure portal, please refer to instructions mentioned [here](site-recovery-failback-azure-to-vmware-classic.md) for enhanced VMware to Azure architecture and [here](site-recovery-failback-azure-to-vmware-classic-legacy.md) for the legacy architecture

## <a name="overview"></a><span data-ttu-id="1e8ff-109">Overview</span><span class="sxs-lookup"><span data-stu-id="1e8ff-109">Overview</span></span>
<span data-ttu-id="1e8ff-110">The diagrams in this section show the failback architecture for this scenario.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-110">The diagrams in this section show the failback architecture for this scenario.</span></span>

<span data-ttu-id="1e8ff-111">When the Process Server is on-premises and you are using an Azure ExpressRoute connection, use this architecture:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-111">When the Process Server is on-premises and you are using an Azure ExpressRoute connection, use this architecture:</span></span>

![Architecture diagram for ExpressRoute](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-classic/architecture.png)

<span data-ttu-id="1e8ff-113">When the Process Server is on Azure and you have either a VPN or an ExpressRoute connection, use this architecture:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-113">When the Process Server is on Azure and you have either a VPN or an ExpressRoute connection, use this architecture:</span></span>

![Architecture diagram for VPN](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-classic/architecture2.png)

<span data-ttu-id="1e8ff-115">For a complete list of ports and the failback architecture diagram, refer to the following image:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-115">For a complete list of ports and the failback architecture diagram, refer to the following image:</span></span>

![Failover-failback list of all ports](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

<span data-ttu-id="1e8ff-117">After you’ve failed over to Azure, you fail back to your on-premises site in three stages:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-117">After you’ve failed over to Azure, you fail back to your on-premises site in three stages:</span></span>

* <span data-ttu-id="1e8ff-118">**Stage 1**: You reprotect the Azure VMs so that they start replicating back to the VMware VMs that are running on your on-premises site.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-118">**Stage 1**: You reprotect the Azure VMs so that they start replicating back to the VMware VMs that are running on your on-premises site.</span></span>
* <span data-ttu-id="1e8ff-119">**Stage 2**: After your Azure VMs are replicated to your on-premises site, you run a failover to fail back from Azure.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-119">**Stage 2**: After your Azure VMs are replicated to your on-premises site, you run a failover to fail back from Azure.</span></span>
* <span data-ttu-id="1e8ff-120">**Stage 3**: After your data has failed back, you reprotect the on-premises VMs that you failed back to, so that they start replicating to Azure.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-120">**Stage 3**: After your data has failed back, you reprotect the on-premises VMs that you failed back to, so that they start replicating to Azure.</span></span>

### <a name="fail-back-to-the-original-location-or-an-alternate-location"></a><span data-ttu-id="1e8ff-121">Fail back to the original location or an alternate location</span><span class="sxs-lookup"><span data-stu-id="1e8ff-121">Fail back to the original location or an alternate location</span></span>
<span data-ttu-id="1e8ff-122">After you fail over a VMware VM, you can fail back to the same source VM if it still exists on-premises.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-122">After you fail over a VMware VM, you can fail back to the same source VM if it still exists on-premises.</span></span> <span data-ttu-id="1e8ff-123">In this scenario, only the deltas are failed back.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-123">In this scenario, only the deltas are failed back.</span></span>

<span data-ttu-id="1e8ff-124">If you failed over physical servers, failback is always to a new VMware VM.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-124">If you failed over physical servers, failback is always to a new VMware VM.</span></span> <span data-ttu-id="1e8ff-125">Before failing back a physical machine, note that:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-125">Before failing back a physical machine, note that:</span></span>
* <span data-ttu-id="1e8ff-126">A protected physical machine will come back as a virtual machine when it is failed over back from Azure to VMware.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-126">A protected physical machine will come back as a virtual machine when it is failed over back from Azure to VMware.</span></span> <span data-ttu-id="1e8ff-127">A Windows Server 2008 R2 SP1 physical machine, if it is protected and failed over to Azure, cannot be failed back.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-127">A Windows Server 2008 R2 SP1 physical machine, if it is protected and failed over to Azure, cannot be failed back.</span></span> <span data-ttu-id="1e8ff-128">A Windows Server 2008 R2 SP1 machine that started as a virtual machine on-premises will be able to fail back.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-128">A Windows Server 2008 R2 SP1 machine that started as a virtual machine on-premises will be able to fail back.</span></span>
* <span data-ttu-id="1e8ff-129">Ensure that you discover at least one master target server along with the necessary ESX/ESXi hosts that you need to fail back to.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-129">Ensure that you discover at least one master target server along with the necessary ESX/ESXi hosts that you need to fail back to.</span></span>

<span data-ttu-id="1e8ff-130">If you fail back to the original VM, the following are required:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-130">If you fail back to the original VM, the following are required:</span></span>

* <span data-ttu-id="1e8ff-131">If the VM is managed by a vCenter server, the master target's ESX host should have access to the VMs datastore.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-131">If the VM is managed by a vCenter server, the master target's ESX host should have access to the VMs datastore.</span></span>
* <span data-ttu-id="1e8ff-132">If the VM is on an ESX host but isn’t managed by vCenter, the hard disk of the VM must be in a datastore that's accessible by the MT's host.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-132">If the VM is on an ESX host but isn’t managed by vCenter, the hard disk of the VM must be in a datastore that's accessible by the MT's host.</span></span>
* <span data-ttu-id="1e8ff-133">If your VM is on an ESX host and doesn't use vCenter, you should complete discovery of the ESX host of the MT before you reprotect.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-133">If your VM is on an ESX host and doesn't use vCenter, you should complete discovery of the ESX host of the MT before you reprotect.</span></span> <span data-ttu-id="1e8ff-134">This applies if you're failing back physical servers too.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-134">This applies if you're failing back physical servers too.</span></span>
* <span data-ttu-id="1e8ff-135">Another option (if the on-premises VM exists) is to delete it before you do a failback.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-135">Another option (if the on-premises VM exists) is to delete it before you do a failback.</span></span> <span data-ttu-id="1e8ff-136">Failback then creates a new VM on the same host as the master target ESX host.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-136">Failback then creates a new VM on the same host as the master target ESX host.</span></span>

<span data-ttu-id="1e8ff-137">When you fail back to an alternate location, the data is recovered to the same datastore and the same ESX host as that used by the on-premises master target server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-137">When you fail back to an alternate location, the data is recovered to the same datastore and the same ESX host as that used by the on-premises master target server.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="1e8ff-138">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="1e8ff-138">Prerequisites</span></span>
* <span data-ttu-id="1e8ff-139">To fail back VMware VMs and physical servers, you need a VMware environment.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-139">To fail back VMware VMs and physical servers, you need a VMware environment.</span></span> <span data-ttu-id="1e8ff-140">Failing back to a physical server isn’t supported.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-140">Failing back to a physical server isn’t supported.</span></span>
* <span data-ttu-id="1e8ff-141">To fail back, you must have created an Azure network when you initially set up protection.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-141">To fail back, you must have created an Azure network when you initially set up protection.</span></span> <span data-ttu-id="1e8ff-142">Failback needs a VPN or ExpressRoute connection from the Azure network in which the Azure VMs are located to the on-premises site.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-142">Failback needs a VPN or ExpressRoute connection from the Azure network in which the Azure VMs are located to the on-premises site.</span></span>
* <span data-ttu-id="1e8ff-143">If the VMs that you want to fail back to are managed by a vCenter server, make sure that you have the required permissions for discovery of VMs on vCenter servers.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-143">If the VMs that you want to fail back to are managed by a vCenter server, make sure that you have the required permissions for discovery of VMs on vCenter servers.</span></span> <span data-ttu-id="1e8ff-144">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access).</span><span class="sxs-lookup"><span data-stu-id="1e8ff-144">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access).</span></span>
* <span data-ttu-id="1e8ff-145">If snapshots are present on a VM, reprotection fails.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-145">If snapshots are present on a VM, reprotection fails.</span></span> <span data-ttu-id="1e8ff-146">You can delete the snapshots or the disks.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-146">You can delete the snapshots or the disks.</span></span>
* <span data-ttu-id="1e8ff-147">Before you fail back, create these components:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-147">Before you fail back, create these components:</span></span>
  * <span data-ttu-id="1e8ff-148">**Create a Process Server in Azure**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-148">**Create a Process Server in Azure**.</span></span> <span data-ttu-id="1e8ff-149">This component is an Azure VM that you create and keep running during failback.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-149">This component is an Azure VM that you create and keep running during failback.</span></span> <span data-ttu-id="1e8ff-150">You can delete the VM after failback is complete.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-150">You can delete the VM after failback is complete.</span></span>
  * <span data-ttu-id="1e8ff-151">**Create a master target server**: The master target server sends and receives failback data.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-151">**Create a master target server**: The master target server sends and receives failback data.</span></span> <span data-ttu-id="1e8ff-152">The management server that you created on-premises has a master target server that's installed by default.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-152">The management server that you created on-premises has a master target server that's installed by default.</span></span> <span data-ttu-id="1e8ff-153">However, depending on the volume of failed-back traffic, you might need to create a separate master target server for failback.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-153">However, depending on the volume of failed-back traffic, you might need to create a separate master target server for failback.</span></span>
  * <span data-ttu-id="1e8ff-154">To create an additional master target server that runs on Linux, set up the Linux VM before you install the master target server, as described later.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-154">To create an additional master target server that runs on Linux, set up the Linux VM before you install the master target server, as described later.</span></span>
* <span data-ttu-id="1e8ff-155">A configuration server is required on-premises when you do a failback.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-155">A configuration server is required on-premises when you do a failback.</span></span> <span data-ttu-id="1e8ff-156">During failback, the virtual machine must exist in the configuration server database.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-156">During failback, the virtual machine must exist in the configuration server database.</span></span> <span data-ttu-id="1e8ff-157">If the configuration server database contains no VM, failback cannot succeed.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-157">If the configuration server database contains no VM, failback cannot succeed.</span></span> <span data-ttu-id="1e8ff-158">Therefore, ensure that you make regular scheduled backups of your server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-158">Therefore, ensure that you make regular scheduled backups of your server.</span></span> <span data-ttu-id="1e8ff-159">In a disaster, you need to restore it with the same IP address so that failback works.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-159">In a disaster, you need to restore it with the same IP address so that failback works.</span></span>
* <span data-ttu-id="1e8ff-160">Set the disk.enableUUID=true setting in **Configuration Parameters** of the master target VM in VMware.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-160">Set the disk.enableUUID=true setting in **Configuration Parameters** of the master target VM in VMware.</span></span> <span data-ttu-id="1e8ff-161">If this row does not exist, add it.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-161">If this row does not exist, add it.</span></span> <span data-ttu-id="1e8ff-162">This setting is required to provide a consistent universally unique identifier (UUID) to the virtual machine disk (VMDK) file so that it is mounted correctly.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-162">This setting is required to provide a consistent universally unique identifier (UUID) to the virtual machine disk (VMDK) file so that it is mounted correctly.</span></span>
* <span data-ttu-id="1e8ff-163">Be aware of a "Master target server cannot be storage vMotioned" condition, which can cause the failback to fail.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-163">Be aware of a "Master target server cannot be storage vMotioned" condition, which can cause the failback to fail.</span></span> <span data-ttu-id="1e8ff-164">The VM cannot come up because the disks aren't made available to it.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-164">The VM cannot come up because the disks aren't made available to it.</span></span>
* <span data-ttu-id="1e8ff-165">Add a drive, called a retention drive, onto the master target server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-165">Add a drive, called a retention drive, onto the master target server.</span></span> <span data-ttu-id="1e8ff-166">Add a disk, and format the drive.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-166">Add a disk, and format the drive.</span></span>

## <a name="failback-policy"></a><span data-ttu-id="1e8ff-167">Failback policy</span><span class="sxs-lookup"><span data-stu-id="1e8ff-167">Failback policy</span></span>
<span data-ttu-id="1e8ff-168">To replicate back to on-premises, you need a failback policy.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-168">To replicate back to on-premises, you need a failback policy.</span></span> <span data-ttu-id="1e8ff-169">The policy is automatically created when you create a forward direction policy, and it is automatically associated with the configuration server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-169">The policy is automatically created when you create a forward direction policy, and it is automatically associated with the configuration server.</span></span> <span data-ttu-id="1e8ff-170">It is not editable.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-170">It is not editable.</span></span> <span data-ttu-id="1e8ff-171">The policy has the following replication settings:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-171">The policy has the following replication settings:</span></span>

* <span data-ttu-id="1e8ff-172">RPO threshold = 15 minutes</span><span class="sxs-lookup"><span data-stu-id="1e8ff-172">RPO threshold = 15 minutes</span></span>
* <span data-ttu-id="1e8ff-173">Recovery point retention = 24 hours</span><span class="sxs-lookup"><span data-stu-id="1e8ff-173">Recovery point retention = 24 hours</span></span>
* <span data-ttu-id="1e8ff-174">App consistent snapshot frequency = 60 minutes</span><span class="sxs-lookup"><span data-stu-id="1e8ff-174">App consistent snapshot frequency = 60 minutes</span></span>

 ![Replication settings of the failback policy](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-new/failback-policy.png)

## <a name="set-up-a-process-server-in-azure"></a><span data-ttu-id="1e8ff-176">Set up a Process Server in Azure</span><span class="sxs-lookup"><span data-stu-id="1e8ff-176">Set up a Process Server in Azure</span></span>
<span data-ttu-id="1e8ff-177">Install a Process Server in Azure so that the Azure VMs can send the data back to the on-premises master target server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-177">Install a Process Server in Azure so that the Azure VMs can send the data back to the on-premises master target server.</span></span>

<span data-ttu-id="1e8ff-178">If you have protected your virtual machines as classic resources (that is, the VM recovered in Azure is a VM that was created by using the classic deployment model), you need a Process Server in Azure.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-178">If you have protected your virtual machines as classic resources (that is, the VM recovered in Azure is a VM that was created by using the classic deployment model), you need a Process Server in Azure.</span></span> <span data-ttu-id="1e8ff-179">If you have recovered the VMs with Azure Resource Manager as the deployment type, the Process Server must have Resource Manager as the deployment type.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-179">If you have recovered the VMs with Azure Resource Manager as the deployment type, the Process Server must have Resource Manager as the deployment type.</span></span> <span data-ttu-id="1e8ff-180">The deployment type is selected by the Azure virtual network that you deploy the Process Server to.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-180">The deployment type is selected by the Azure virtual network that you deploy the Process Server to.</span></span>

1. <span data-ttu-id="1e8ff-181">In **Vault** > **Settings** > **Site Recovery Infrastructure** (under **Manage**) > **Configuration Servers** (under **For VMware and Physical Machines**), select the configuration server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-181">In **Vault** > **Settings** > **Site Recovery Infrastructure** (under **Manage**) > **Configuration Servers** (under **For VMware and Physical Machines**), select the configuration server.</span></span>
2. <span data-ttu-id="1e8ff-182">Click **Process Server**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-182">Click **Process Server**.</span></span>

  ![Process Server button](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-classic/add-processserver.png)
3. <span data-ttu-id="1e8ff-184">Choose to deploy the Process Server as **Deploy a failback Process Server in Azure**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-184">Choose to deploy the Process Server as **Deploy a failback Process Server in Azure**.</span></span>
4. <span data-ttu-id="1e8ff-185">Select the subscription that you have recovered the VMs to.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-185">Select the subscription that you have recovered the VMs to.</span></span>
5. <span data-ttu-id="1e8ff-186">Select the Azure network that you have recovered the VMs to.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-186">Select the Azure network that you have recovered the VMs to.</span></span> <span data-ttu-id="1e8ff-187">The Process Server needs to be in the same network so that the recovered VMs and the Process Server can communicate.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-187">The Process Server needs to be in the same network so that the recovered VMs and the Process Server can communicate.</span></span>
6. <span data-ttu-id="1e8ff-188">If you selected a *classic deployment model* network, create a VM via the Azure Marketplace, and then install the Process Server in it.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-188">If you selected a *classic deployment model* network, create a VM via the Azure Marketplace, and then install the Process Server in it.</span></span>

 ![The "Add Process Server" window](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-classic/add-classic.png)

 <span data-ttu-id="1e8ff-190">As you're creating the Process Server, pay attention to the following:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-190">As you're creating the Process Server, pay attention to the following:</span></span>
 * <span data-ttu-id="1e8ff-191">The name of the image is *Microsoft Azure Site Recovery Process Server V2*.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-191">The name of the image is *Microsoft Azure Site Recovery Process Server V2*.</span></span> <span data-ttu-id="1e8ff-192">Select **Classic** as the deployment model.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-192">Select **Classic** as the deployment model.</span></span>

       ![Select "Classic" as the Process Server deployment model](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-classic/templatename.png)
 * <span data-ttu-id="1e8ff-193">Install the Process Server according to the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md#step-5-install-the-management-server).</span><span class="sxs-lookup"><span data-stu-id="1e8ff-193">Install the Process Server according to the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md#step-5-install-the-management-server).</span></span>
7. <span data-ttu-id="1e8ff-194">If you select the *Resource Manager* Azure network, deploy the Process Server by providing the following information:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-194">If you select the *Resource Manager* Azure network, deploy the Process Server by providing the following information:</span></span>

  * <span data-ttu-id="1e8ff-195">The name of the resource group that you want to deploy the server to</span><span class="sxs-lookup"><span data-stu-id="1e8ff-195">The name of the resource group that you want to deploy the server to</span></span>
  * <span data-ttu-id="1e8ff-196">The name of the server</span><span class="sxs-lookup"><span data-stu-id="1e8ff-196">The name of the server</span></span>
  * <span data-ttu-id="1e8ff-197">A username and password for signing in to the server</span><span class="sxs-lookup"><span data-stu-id="1e8ff-197">A username and password for signing in to the server</span></span>
  * <span data-ttu-id="1e8ff-198">The storage account that you want to deploy the server to</span><span class="sxs-lookup"><span data-stu-id="1e8ff-198">The storage account that you want to deploy the server to</span></span>
  * <span data-ttu-id="1e8ff-199">The subnet and the network interface that you want to connect to it</span><span class="sxs-lookup"><span data-stu-id="1e8ff-199">The subnet and the network interface that you want to connect to it</span></span>
   >[!NOTE]
   >You must create your own [network interface](../virtual-network/virtual-networks-multiple-nics.md) (NIC) and select it while you are deploying the Process Server.

    ![Enter information in the "Add Process Server" dialog box](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-classic/psinputsadd.png)

8. <span data-ttu-id="1e8ff-202">Click **OK**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-202">Click **OK**.</span></span> <span data-ttu-id="1e8ff-203">This action triggers a job that creates a Resource Manager deployment type virtual machine during the Process Server setup.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-203">This action triggers a job that creates a Resource Manager deployment type virtual machine during the Process Server setup.</span></span> <span data-ttu-id="1e8ff-204">To register the server to the configuration server, run the setup inside the VM by following the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md#step-5-install-the-management-server).</span><span class="sxs-lookup"><span data-stu-id="1e8ff-204">To register the server to the configuration server, run the setup inside the VM by following the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md#step-5-install-the-management-server).</span></span> <span data-ttu-id="1e8ff-205">A job to deploy the Process Server is also triggered.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-205">A job to deploy the Process Server is also triggered.</span></span>

  <span data-ttu-id="1e8ff-206">The Process Server is listed on the **Configuration servers** > **Associated servers** > **Process Servers** tab.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-206">The Process Server is listed on the **Configuration servers** > **Associated servers** > **Process Servers** tab.</span></span>

    ![](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-new/pslistingincs.png)

    > [!NOTE]
    > The Process Server isn't visible under **VM properties**. It's visible only on the **Servers** tab in the management server that it's registered to. It can take 10 to 15 minutes for the Process Server to appear.


## <a name="set-up-the-master-target-server-on-premises"></a><span data-ttu-id="1e8ff-210">Set up the master target server on-premises</span><span class="sxs-lookup"><span data-stu-id="1e8ff-210">Set up the master target server on-premises</span></span>
<span data-ttu-id="1e8ff-211">The master target server receives the failback data.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-211">The master target server receives the failback data.</span></span> <span data-ttu-id="1e8ff-212">The server is automatically installed on the on-premises management server, but if you're failing back too much data, you might need to set up an additional master target server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-212">The server is automatically installed on the on-premises management server, but if you're failing back too much data, you might need to set up an additional master target server.</span></span> <span data-ttu-id="1e8ff-213">To set up a master target server on-premises, do the following:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-213">To set up a master target server on-premises, do the following:</span></span>

> [!NOTE]
> To set up a master target server on Linux, skip to the next procedure. Use only CentOS 6.6 minimal operating system as the master target OS.

1. <span data-ttu-id="1e8ff-216">If you're setting up the master target server on Windows, open the quick-start page from the VM that you're installing the master target server on.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-216">If you're setting up the master target server on Windows, open the quick-start page from the VM that you're installing the master target server on.</span></span>
2. <span data-ttu-id="1e8ff-217">Download the installation file for the Azure Site Recovery Unified Setup wizard.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-217">Download the installation file for the Azure Site Recovery Unified Setup wizard.</span></span>
3. <span data-ttu-id="1e8ff-218">Run the setup and, in **Before you begin**, select **Add additional Process Servers to scale out deployment**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-218">Run the setup and, in **Before you begin**, select **Add additional Process Servers to scale out deployment**.</span></span>
4. <span data-ttu-id="1e8ff-219">Complete the wizard in the same way you did when you [set up the management server](site-recovery-vmware-to-azure-classic.md#step-5-install-the-management-server).</span><span class="sxs-lookup"><span data-stu-id="1e8ff-219">Complete the wizard in the same way you did when you [set up the management server](site-recovery-vmware-to-azure-classic.md#step-5-install-the-management-server).</span></span> <span data-ttu-id="1e8ff-220">On the **Configuration Server Details** page, specify the IP address of the master target server, and enter a passphrase to access the VM.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-220">On the **Configuration Server Details** page, specify the IP address of the master target server, and enter a passphrase to access the VM.</span></span>

### <a name="set-up-a-linux-vm-as-the-master-target-server"></a><span data-ttu-id="1e8ff-221">Set up a Linux VM as the master target server</span><span class="sxs-lookup"><span data-stu-id="1e8ff-221">Set up a Linux VM as the master target server</span></span>
<span data-ttu-id="1e8ff-222">To set up the management server running the master target server as a Linux VM, install the CentOS 6.6 minimal operating system.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-222">To set up the management server running the master target server as a Linux VM, install the CentOS 6.6 minimal operating system.</span></span> <span data-ttu-id="1e8ff-223">Next, retrieve the SCSI IDs for each SCSI hard disk, install some additional packages, and apply some custom changes.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-223">Next, retrieve the SCSI IDs for each SCSI hard disk, install some additional packages, and apply some custom changes.</span></span>

#### <a name="install-centos-66"></a><span data-ttu-id="1e8ff-224">Install CentOS 6.6</span><span class="sxs-lookup"><span data-stu-id="1e8ff-224">Install CentOS 6.6</span></span>

1. <span data-ttu-id="1e8ff-225">Install the CentOS 6.6 minimal operating system on the management server VM.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-225">Install the CentOS 6.6 minimal operating system on the management server VM.</span></span> <span data-ttu-id="1e8ff-226">Keep the ISO on a DVD drive, and boot the system.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-226">Keep the ISO on a DVD drive, and boot the system.</span></span> <span data-ttu-id="1e8ff-227">Skip the media testing.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-227">Skip the media testing.</span></span> <span data-ttu-id="1e8ff-228">Select **US English** as the language, select **Basic Storage Devices**, check that the hard drive doesn’t have any important data, click **Yes**, and discard any data.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-228">Select **US English** as the language, select **Basic Storage Devices**, check that the hard drive doesn’t have any important data, click **Yes**, and discard any data.</span></span> <span data-ttu-id="1e8ff-229">Enter the host name of the management server, and select the server network adapter.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-229">Enter the host name of the management server, and select the server network adapter.</span></span>  <span data-ttu-id="1e8ff-230">In the **Editing System** dialog box, select **Connect automatically**, and then add a static IP address, network, and DNS settings.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-230">In the **Editing System** dialog box, select **Connect automatically**, and then add a static IP address, network, and DNS settings.</span></span> <span data-ttu-id="1e8ff-231">Specify a time zone.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-231">Specify a time zone.</span></span> <span data-ttu-id="1e8ff-232">To access the management server, enter the root password.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-232">To access the management server, enter the root password.</span></span>
2. <span data-ttu-id="1e8ff-233">When you're asked what type of installation you want, select **Create Custom Layout** as the partition.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-233">When you're asked what type of installation you want, select **Create Custom Layout** as the partition.</span></span> <span data-ttu-id="1e8ff-234">Click **Next**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-234">Click **Next**.</span></span> <span data-ttu-id="1e8ff-235">Select **Free**, and then click **Create**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-235">Select **Free**, and then click **Create**.</span></span> <span data-ttu-id="1e8ff-236">Create **/**,  **/var/crash**, and **/home partitions** with **FS Type:** **ext4**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-236">Create **/**,  **/var/crash**, and **/home partitions** with **FS Type:** **ext4**.</span></span> <span data-ttu-id="1e8ff-237">Create the swap partition as **FS Type: swap**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-237">Create the swap partition as **FS Type: swap**.</span></span>
3. <span data-ttu-id="1e8ff-238">If pre-existing devices are found, a warning message appears.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-238">If pre-existing devices are found, a warning message appears.</span></span> <span data-ttu-id="1e8ff-239">Click **Format** to format the drive with the partition settings.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-239">Click **Format** to format the drive with the partition settings.</span></span> <span data-ttu-id="1e8ff-240">Click **Write change to disk** to apply the partition changes.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-240">Click **Write change to disk** to apply the partition changes.</span></span>
4. <span data-ttu-id="1e8ff-241">Select **Install boot loader** > **Next** to install the boot loader on the root partition.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-241">Select **Install boot loader** > **Next** to install the boot loader on the root partition.</span></span>
5. <span data-ttu-id="1e8ff-242">When the installation is complete, click **Reboot**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-242">When the installation is complete, click **Reboot**.</span></span>

#### <a name="retrieve-the-scsi-ids"></a><span data-ttu-id="1e8ff-243">Retrieve the SCSI IDs</span><span class="sxs-lookup"><span data-stu-id="1e8ff-243">Retrieve the SCSI IDs</span></span>

1. <span data-ttu-id="1e8ff-244">After the installation, retrieve the SCSI IDs for each SCSI hard disk in the VM.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-244">After the installation, retrieve the SCSI IDs for each SCSI hard disk in the VM.</span></span> <span data-ttu-id="1e8ff-245">To do so, shut down the management server VM.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-245">To do so, shut down the management server VM.</span></span> <span data-ttu-id="1e8ff-246">In the VM properties in VMware, right-click the VM entry > **Edit Settings** > **Options**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-246">In the VM properties in VMware, right-click the VM entry > **Edit Settings** > **Options**.</span></span>
2. <span data-ttu-id="1e8ff-247">Select **Advanced** > **General item**, and then click **Configuration Parameters**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-247">Select **Advanced** > **General item**, and then click **Configuration Parameters**.</span></span> <span data-ttu-id="1e8ff-248">This option is unavailable when the machine is running.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-248">This option is unavailable when the machine is running.</span></span> <span data-ttu-id="1e8ff-249">For the option to be available, the machine must be shut down.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-249">For the option to be available, the machine must be shut down.</span></span>
3. <span data-ttu-id="1e8ff-250">Do either of the following:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-250">Do either of the following:</span></span>
 * <span data-ttu-id="1e8ff-251">If the row **disk.EnableUUID** exists, make sure that the value is set to **True** (case sensitive).</span><span class="sxs-lookup"><span data-stu-id="1e8ff-251">If the row **disk.EnableUUID** exists, make sure that the value is set to **True** (case sensitive).</span></span> <span data-ttu-id="1e8ff-252">If the value is already set to True, you can cancel and test the SCSI command inside a guest operating system after it’s booted.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-252">If the value is already set to True, you can cancel and test the SCSI command inside a guest operating system after it’s booted.</span></span>
 * <span data-ttu-id="1e8ff-253">If the row **disk.EnableUUID** doesn’t exist, click **Add Row**, and then add it with the **True** value.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-253">If the row **disk.EnableUUID** doesn’t exist, click **Add Row**, and then add it with the **True** value.</span></span> <span data-ttu-id="1e8ff-254">Don’t use double quotation marks.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-254">Don’t use double quotation marks.</span></span>

#### <a name="install-additional-packages"></a><span data-ttu-id="1e8ff-255">Install additional packages</span><span class="sxs-lookup"><span data-stu-id="1e8ff-255">Install additional packages</span></span>
<span data-ttu-id="1e8ff-256">Download and install additional packages.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-256">Download and install additional packages.</span></span>

1. <span data-ttu-id="1e8ff-257">Make sure the master target server is connected to the Internet.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-257">Make sure the master target server is connected to the Internet.</span></span>
2. <span data-ttu-id="1e8ff-258">To download and install 15 packages from the CentOS repository, run this command: `# yum install –y xfsprogs perl lsscsi rsync wget kexec-tools`.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-258">To download and install 15 packages from the CentOS repository, run this command: `# yum install –y xfsprogs perl lsscsi rsync wget kexec-tools`.</span></span>
3. <span data-ttu-id="1e8ff-259">If the source machines you’re protecting are running Linux with a Reiser or XFS file system for the root or boot device, download and install additional packages as follows:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-259">If the source machines you’re protecting are running Linux with a Reiser or XFS file system for the root or boot device, download and install additional packages as follows:</span></span>

   * <span data-ttu-id="1e8ff-260">\# cd /usr/local</span><span class="sxs-lookup"><span data-stu-id="1e8ff-260">\# cd /usr/local</span></span>
   * <span data-ttu-id="1e8ff-261">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)</span><span class="sxs-lookup"><span data-stu-id="1e8ff-261">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)</span></span>
   * <span data-ttu-id="1e8ff-262">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)</span><span class="sxs-lookup"><span data-stu-id="1e8ff-262">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)</span></span>
   * <span data-ttu-id="1e8ff-263">\# rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm</span><span class="sxs-lookup"><span data-stu-id="1e8ff-263">\# rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm</span></span>
   * <span data-ttu-id="1e8ff-264">\# wget [http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)</span><span class="sxs-lookup"><span data-stu-id="1e8ff-264">\# wget [http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)</span></span>
   * <span data-ttu-id="1e8ff-265">\# rpm –ivh xfsprogs-3.1.1-16.el6.x86_64.rpm</span><span class="sxs-lookup"><span data-stu-id="1e8ff-265">\# rpm –ivh xfsprogs-3.1.1-16.el6.x86_64.rpm</span></span>
   * <span data-ttu-id="1e8ff-266">\# yum install device-mapper-multipath (required to enable multipath packages on the master target server)</span><span class="sxs-lookup"><span data-stu-id="1e8ff-266">\# yum install device-mapper-multipath (required to enable multipath packages on the master target server)</span></span>

#### <a name="apply-custom-changes"></a><span data-ttu-id="1e8ff-267">Apply custom changes</span><span class="sxs-lookup"><span data-stu-id="1e8ff-267">Apply custom changes</span></span>
<span data-ttu-id="1e8ff-268">After you’ve completed the post-installation steps and installed the packages, apply custom changes by doing the following:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-268">After you’ve completed the post-installation steps and installed the packages, apply custom changes by doing the following:</span></span>

1. <span data-ttu-id="1e8ff-269">Copy the RHEL 6-64 Unified Agent binary to the VM.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-269">Copy the RHEL 6-64 Unified Agent binary to the VM.</span></span> <span data-ttu-id="1e8ff-270">To untar the binary, run this command: `tar –zxvf <file name>`.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-270">To untar the binary, run this command: `tar –zxvf <file name>`.</span></span>
2. <span data-ttu-id="1e8ff-271">To give permissions, run this command: `# chmod 755 ./ApplyCustomChanges.sh`.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-271">To give permissions, run this command: `# chmod 755 ./ApplyCustomChanges.sh`.</span></span>
3. <span data-ttu-id="1e8ff-272">Run the following script: `# ./ApplyCustomChanges.sh`.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-272">Run the following script: `# ./ApplyCustomChanges.sh`.</span></span> <span data-ttu-id="1e8ff-273">Run it only once.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-273">Run it only once.</span></span> <span data-ttu-id="1e8ff-274">After it runs successfully, reboot the server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-274">After it runs successfully, reboot the server.</span></span>

## <a name="run-the-failback"></a><span data-ttu-id="1e8ff-275">Run the failback</span><span class="sxs-lookup"><span data-stu-id="1e8ff-275">Run the failback</span></span>
### <a name="reprotect-the-azure-vms"></a><span data-ttu-id="1e8ff-276">Reprotect the Azure VMs</span><span class="sxs-lookup"><span data-stu-id="1e8ff-276">Reprotect the Azure VMs</span></span>
1. <span data-ttu-id="1e8ff-277">In **Vault**, in **Replicated items**, right-click the VM that has been failed over, and then select **Re-Protect**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-277">In **Vault**, in **Replicated items**, right-click the VM that has been failed over, and then select **Re-Protect**.</span></span>
2. <span data-ttu-id="1e8ff-278">On the blade, you can see that the direction of protection **Azure to On-premises** is already selected.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-278">On the blade, you can see that the direction of protection **Azure to On-premises** is already selected.</span></span>
3. <span data-ttu-id="1e8ff-279">In **Master Target Server** and **Process Server**, select the on-premises master target server and the Azure VM Process Server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-279">In **Master Target Server** and **Process Server**, select the on-premises master target server and the Azure VM Process Server.</span></span>
4. <span data-ttu-id="1e8ff-280">Select the datastore that you want to recover the disks on-premises to.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-280">Select the datastore that you want to recover the disks on-premises to.</span></span> <span data-ttu-id="1e8ff-281">Use this option when the on-premises VM is deleted and you need to create new disks.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-281">Use this option when the on-premises VM is deleted and you need to create new disks.</span></span> <span data-ttu-id="1e8ff-282">Ignore the option if the disks already exist, but you still need to specify a value.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-282">Ignore the option if the disks already exist, but you still need to specify a value.</span></span>
5. <span data-ttu-id="1e8ff-283">Use a retention drive to stop the points in time when the VM is replicated back to on-premises.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-283">Use a retention drive to stop the points in time when the VM is replicated back to on-premises.</span></span> <span data-ttu-id="1e8ff-284">Some criteria of a retention drive are listed here.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-284">Some criteria of a retention drive are listed here.</span></span> <span data-ttu-id="1e8ff-285">Without these criteria, the drive is not listed for the master target server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-285">Without these criteria, the drive is not listed for the master target server.</span></span>

  * <span data-ttu-id="1e8ff-286">Volume shouldn't be in use for any other purpose (target of replication, and so forth).</span><span class="sxs-lookup"><span data-stu-id="1e8ff-286">Volume shouldn't be in use for any other purpose (target of replication, and so forth).</span></span>
  * <span data-ttu-id="1e8ff-287">Volume shouldn't be in lock mode.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-287">Volume shouldn't be in lock mode.</span></span>
  * <span data-ttu-id="1e8ff-288">Volume shouldn't be cache volume.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-288">Volume shouldn't be cache volume.</span></span> <span data-ttu-id="1e8ff-289">(The master target installation shouldn't exist on that volume.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-289">(The master target installation shouldn't exist on that volume.</span></span> <span data-ttu-id="1e8ff-290">The Process Server plus master target custom installation volume is not eligible for retention volume.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-290">The Process Server plus master target custom installation volume is not eligible for retention volume.</span></span> <span data-ttu-id="1e8ff-291">Here, the installed Process Server plus master target volume is the cache volume of the master target.)</span><span class="sxs-lookup"><span data-stu-id="1e8ff-291">Here, the installed Process Server plus master target volume is the cache volume of the master target.)</span></span>
  * <span data-ttu-id="1e8ff-292">The volume file system type shouldn't be FAT and FAT32.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-292">The volume file system type shouldn't be FAT and FAT32.</span></span>
  * <span data-ttu-id="1e8ff-293">The volume capacity should be non-zero.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-293">The volume capacity should be non-zero.</span></span>
  * <span data-ttu-id="1e8ff-294">The default retention volume for Windows is R volume.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-294">The default retention volume for Windows is R volume.</span></span>
  * <span data-ttu-id="1e8ff-295">The default retention volume for Linux is /mnt/retention.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-295">The default retention volume for Linux is /mnt/retention.</span></span>

6. <span data-ttu-id="1e8ff-296">The failback policy is automatically selected.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-296">The failback policy is automatically selected.</span></span>
7. <span data-ttu-id="1e8ff-297">After you click **OK** to begin reprotection, a job begins to replicate the VM from Azure to the on-premises site.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-297">After you click **OK** to begin reprotection, a job begins to replicate the VM from Azure to the on-premises site.</span></span> <span data-ttu-id="1e8ff-298">You can track the progress on the **Jobs** tab.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-298">You can track the progress on the **Jobs** tab.</span></span>

<span data-ttu-id="1e8ff-299">If you want to recover to an alternate location, select the retention drive and datastore that are configured for the master target server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-299">If you want to recover to an alternate location, select the retention drive and datastore that are configured for the master target server.</span></span> <span data-ttu-id="1e8ff-300">When you fail back to the on-premises site, the VMware VMs in the failback protection plan use the same datastore as the master target server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-300">When you fail back to the on-premises site, the VMware VMs in the failback protection plan use the same datastore as the master target server.</span></span> <span data-ttu-id="1e8ff-301">If you want to recover the replica Azure VM to the same on-premises VM, the on-premises VM should already be in the same datastore as the master target server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-301">If you want to recover the replica Azure VM to the same on-premises VM, the on-premises VM should already be in the same datastore as the master target server.</span></span> <span data-ttu-id="1e8ff-302">If there's no VM on-premises, a new one is created during reprotection.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-302">If there's no VM on-premises, a new one is created during reprotection.</span></span>

![Select "Azure to on-premises" in the drop-down menu](https://docstestmedia1.blob.core.windows.net/azure-media/articles/site-recovery/media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)

<span data-ttu-id="1e8ff-304">You can also reprotect at a recovery plan level.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-304">You can also reprotect at a recovery plan level.</span></span> <span data-ttu-id="1e8ff-305">If you have a replication group, you can reprotect it only by using a recovery plan.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-305">If you have a replication group, you can reprotect it only by using a recovery plan.</span></span> <span data-ttu-id="1e8ff-306">When you reprotect by using a recovery plan, use the previous values for every protected machine.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-306">When you reprotect by using a recovery plan, use the previous values for every protected machine.</span></span>

> [!NOTE]
> Replication groups should be protected back with the same master target. If they are protected back with different master target servers, a common point in time cannot be determined for them.

### <a name="run-a-failover-to-the-on-premises-site"></a><span data-ttu-id="1e8ff-309">Run a failover to the on-premises site</span><span class="sxs-lookup"><span data-stu-id="1e8ff-309">Run a failover to the on-premises site</span></span>
<span data-ttu-id="1e8ff-310">After you reprotect the VM, you can initiate a failover from Azure to on-premises.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-310">After you reprotect the VM, you can initiate a failover from Azure to on-premises.</span></span>

1. <span data-ttu-id="1e8ff-311">On the replicated items page, right-click the virtual machine, and then select **Unplanned Failover**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-311">On the replicated items page, right-click the virtual machine, and then select **Unplanned Failover**.</span></span>
2. <span data-ttu-id="1e8ff-312">In **Confirm Failover**, verify the failover direction (from Azure), and then select the recovery point that you want to use for the failover (the latest, or the latest app-consistent recovery point).</span><span class="sxs-lookup"><span data-stu-id="1e8ff-312">In **Confirm Failover**, verify the failover direction (from Azure), and then select the recovery point that you want to use for the failover (the latest, or the latest app-consistent recovery point).</span></span> <span data-ttu-id="1e8ff-313">An app-consistent recovery point occurs before the most recent point in time, and it will cause some data loss.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-313">An app-consistent recovery point occurs before the most recent point in time, and it will cause some data loss.</span></span>
3. <span data-ttu-id="1e8ff-314">During failover, Site Recovery shuts down the Azure VMs.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-314">During failover, Site Recovery shuts down the Azure VMs.</span></span> <span data-ttu-id="1e8ff-315">After you check that failback has been completed as expected, you can check to ensure that the Azure VMs have been shut down as expected.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-315">After you check that failback has been completed as expected, you can check to ensure that the Azure VMs have been shut down as expected.</span></span>

### <a name="reprotect-the-on-premises-site"></a><span data-ttu-id="1e8ff-316">Reprotect the on-premises site</span><span class="sxs-lookup"><span data-stu-id="1e8ff-316">Reprotect the on-premises site</span></span>
<span data-ttu-id="1e8ff-317">After failback has been completed, commit the virtual machine to ensure that the VMs recovered in Azure are deleted.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-317">After failback has been completed, commit the virtual machine to ensure that the VMs recovered in Azure are deleted.</span></span> <span data-ttu-id="1e8ff-318">To do so, right-click the protected item, and then click **Commit**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-318">To do so, right-click the protected item, and then click **Commit**.</span></span> <span data-ttu-id="1e8ff-319">This action triggers a job that removes the former recovered virtual machines in Azure.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-319">This action triggers a job that removes the former recovered virtual machines in Azure.</span></span>

<span data-ttu-id="1e8ff-320">After the commit is completed, your data should be back on the on-premises site, but it won’t be protected.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-320">After the commit is completed, your data should be back on the on-premises site, but it won’t be protected.</span></span> <span data-ttu-id="1e8ff-321">To start replicating to Azure again, do the following:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-321">To start replicating to Azure again, do the following:</span></span>

1. <span data-ttu-id="1e8ff-322">In **Vault**, in **Setting** > **Replicated items**, select the VMs that have failed back, and then click **Re-Protect**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-322">In **Vault**, in **Setting** > **Replicated items**, select the VMs that have failed back, and then click **Re-Protect**.</span></span>
2. <span data-ttu-id="1e8ff-323">Give the value of the Process Server that needs to be used to send data back to Azure.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-323">Give the value of the Process Server that needs to be used to send data back to Azure.</span></span>
3. <span data-ttu-id="1e8ff-324">Click **OK**.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-324">Click **OK**.</span></span>

<span data-ttu-id="1e8ff-325">After the reprotection is complete, the VM replicates back to Azure and you can do a failover.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-325">After the reprotection is complete, the VM replicates back to Azure and you can do a failover.</span></span>

### <a name="resolve-common-failback-issues"></a><span data-ttu-id="1e8ff-326">Resolve common failback issues</span><span class="sxs-lookup"><span data-stu-id="1e8ff-326">Resolve common failback issues</span></span>
* <span data-ttu-id="1e8ff-327">If you perform a read-only user vCenter discovery and protect virtual machines, it succeeds and failover works.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-327">If you perform a read-only user vCenter discovery and protect virtual machines, it succeeds and failover works.</span></span> <span data-ttu-id="1e8ff-328">During reprotection, failover fails because the datastores cannot be discovered.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-328">During reprotection, failover fails because the datastores cannot be discovered.</span></span> <span data-ttu-id="1e8ff-329">As a symptom, you will not see the datastores listed during reprotection.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-329">As a symptom, you will not see the datastores listed during reprotection.</span></span> <span data-ttu-id="1e8ff-330">To resolve this issue, you can update the vCenter credential with an appropriate account that has permissions and retry the job.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-330">To resolve this issue, you can update the vCenter credential with an appropriate account that has permissions and retry the job.</span></span> <span data-ttu-id="1e8ff-331">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access)</span><span class="sxs-lookup"><span data-stu-id="1e8ff-331">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md#vmware-permissions-for-vcenter-access)</span></span>
* <span data-ttu-id="1e8ff-332">When you fail back a Linux VM and run it on-premises, you can see that the Network Manager package has been uninstalled from the machine.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-332">When you fail back a Linux VM and run it on-premises, you can see that the Network Manager package has been uninstalled from the machine.</span></span> <span data-ttu-id="1e8ff-333">This uninstallation happens because the Network Manager package is removed when the VM is recovered in Azure.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-333">This uninstallation happens because the Network Manager package is removed when the VM is recovered in Azure.</span></span>
* <span data-ttu-id="1e8ff-334">When a VM is configured with a static IP address and is failed over to Azure, the IP address is acquired via DHCP.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-334">When a VM is configured with a static IP address and is failed over to Azure, the IP address is acquired via DHCP.</span></span> <span data-ttu-id="1e8ff-335">When you fail over back to on-premises, the VM continues to use DHCP to acquire the IP address.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-335">When you fail over back to on-premises, the VM continues to use DHCP to acquire the IP address.</span></span> <span data-ttu-id="1e8ff-336">Manually sign in to the machine and set the IP address back to a static address if necessary.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-336">Manually sign in to the machine and set the IP address back to a static address if necessary.</span></span>
* <span data-ttu-id="1e8ff-337">If you are using either ESXi 5.5 free edition or vSphere 6 Hypervisor free edition, failover would succeed, but failback would not succeed.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-337">If you are using either ESXi 5.5 free edition or vSphere 6 Hypervisor free edition, failover would succeed, but failback would not succeed.</span></span> <span data-ttu-id="1e8ff-338">To enable failback, upgrade to either program's evaluation license.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-338">To enable failback, upgrade to either program's evaluation license.</span></span>
* <span data-ttu-id="1e8ff-339">If you cannot reach the configuration server from the Process Server, check connectivity to the configuration server by Telnet to the configuration server machine on port 443.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-339">If you cannot reach the configuration server from the Process Server, check connectivity to the configuration server by Telnet to the configuration server machine on port 443.</span></span> <span data-ttu-id="1e8ff-340">You can also try to ping the configuration server from the Process Server machine.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-340">You can also try to ping the configuration server from the Process Server machine.</span></span> <span data-ttu-id="1e8ff-341">A Process Server should also have a heartbeat when it is connected to the configuration server.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-341">A Process Server should also have a heartbeat when it is connected to the configuration server.</span></span>
* <span data-ttu-id="1e8ff-342">If you are trying to fail back to an alternate vCenter, make sure that your new vCenter is discovered and that the master target server is also discovered.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-342">If you are trying to fail back to an alternate vCenter, make sure that your new vCenter is discovered and that the master target server is also discovered.</span></span> <span data-ttu-id="1e8ff-343">A typical symptom is that the datastores are not accessible or visible in the **Reprotect** dialog box.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-343">A typical symptom is that the datastores are not accessible or visible in the **Reprotect** dialog box.</span></span>
* <span data-ttu-id="1e8ff-344">A WS2008R2SP1 machine that is protected as a physical on-premises machine cannot be failed back from Azure to on-premises.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-344">A WS2008R2SP1 machine that is protected as a physical on-premises machine cannot be failed back from Azure to on-premises.</span></span>

## <a name="fail-back-with-expressroute"></a><span data-ttu-id="1e8ff-345">Fail back with ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="1e8ff-345">Fail back with ExpressRoute</span></span>
<span data-ttu-id="1e8ff-346">You can fail back over a VPN connection or by using an ExpressRoute connection.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-346">You can fail back over a VPN connection or by using an ExpressRoute connection.</span></span> <span data-ttu-id="1e8ff-347">If you want to use an ExpressRoute connection, note the following:</span><span class="sxs-lookup"><span data-stu-id="1e8ff-347">If you want to use an ExpressRoute connection, note the following:</span></span>

* <span data-ttu-id="1e8ff-348">The ExpressRoute connection should be set up on the Azure virtual network that the source machines fail over to and where the Azure VMs are located after the failover occurs.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-348">The ExpressRoute connection should be set up on the Azure virtual network that the source machines fail over to and where the Azure VMs are located after the failover occurs.</span></span>
* <span data-ttu-id="1e8ff-349">Data is replicated to an Azure storage account on a public endpoint.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-349">Data is replicated to an Azure storage account on a public endpoint.</span></span> <span data-ttu-id="1e8ff-350">To use an ExpressRoute connection, set up public peering in ExpressRoute with the target data center for Site Recovery replication.</span><span class="sxs-lookup"><span data-stu-id="1e8ff-350">To use an ExpressRoute connection, set up public peering in ExpressRoute with the target data center for Site Recovery replication.</span></span>










