---
title: Create recovery plans for failover and recovery in Azure Site Recovery | Microsoft Docs
description: Describes how to create and customize recovery plans to fail over and recover VMs and physical servers in Azure Site Recovery
services: site-recovery
documentationcenter: ''
author: rayne-wiselman
manager: jwhit
editor: ''
ms.assetid: 72408c62-fcb6-4ee2-8ff5-cab1218773f2
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 02/14/2017
ms.author: raynew
ms.openlocfilehash: e36f19e9c429c0e4b42e96b28b1ba995bd1bf167
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44551365"
---
# <a name="create-recovery-plans"></a><span data-ttu-id="e8a98-103">Create recovery plans</span><span class="sxs-lookup"><span data-stu-id="e8a98-103">Create recovery plans</span></span>


<span data-ttu-id="e8a98-104">This article provides information about creating and customizing recovery plans in [Azure Site Recovery?](site-recovery-overview.md).</span><span class="sxs-lookup"><span data-stu-id="e8a98-104">This article provides information about creating and customizing recovery plans in [Azure Site Recovery?](site-recovery-overview.md).</span></span>

<span data-ttu-id="e8a98-105">Post any comments or questions at the bottom of this article, or on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span><span class="sxs-lookup"><span data-stu-id="e8a98-105">Post any comments or questions at the bottom of this article, or on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>

 <span data-ttu-id="e8a98-106">Recovery plans do the following:</span><span class="sxs-lookup"><span data-stu-id="e8a98-106">Recovery plans do the following:</span></span>

* <span data-ttu-id="e8a98-107">Define groups of machines that fail over together, and then start up together.</span><span class="sxs-lookup"><span data-stu-id="e8a98-107">Define groups of machines that fail over together, and then start up together.</span></span>
* <span data-ttu-id="e8a98-108">Model dependencies between machines, by grouping them together into a recovery plan group.</span><span class="sxs-lookup"><span data-stu-id="e8a98-108">Model dependencies between machines, by grouping them together into a recovery plan group.</span></span> <span data-ttu-id="e8a98-109">For example, to fail over and bring up a specific application, you group all of the VMs for that application into the same recovery plan group.</span><span class="sxs-lookup"><span data-stu-id="e8a98-109">For example, to fail over and bring up a specific application, you group all of the VMs for that application into the same recovery plan group.</span></span>
* <span data-ttu-id="e8a98-110">Fail over.</span><span class="sxs-lookup"><span data-stu-id="e8a98-110">Fail over.</span></span> <span data-ttu-id="e8a98-111">You can run a test, planned, or unplanned failover on a recovery plan.</span><span class="sxs-lookup"><span data-stu-id="e8a98-111">You can run a test, planned, or unplanned failover on a recovery plan.</span></span>


## <a name="create-a-recovery-plan"></a><span data-ttu-id="e8a98-112">Create a recovery plan</span><span class="sxs-lookup"><span data-stu-id="e8a98-112">Create a recovery plan</span></span>

1. <span data-ttu-id="e8a98-113">Click **Recovery Plans** > **Create Recovery Plan**.</span><span class="sxs-lookup"><span data-stu-id="e8a98-113">Click **Recovery Plans** > **Create Recovery Plan**.</span></span>
   <span data-ttu-id="e8a98-114">Specify a name for the recovery plan, and a source and target.</span><span class="sxs-lookup"><span data-stu-id="e8a98-114">Specify a name for the recovery plan, and a source and target.</span></span> <span data-ttu-id="e8a98-115">The source location must have virtual machines that are enabled for failover and recovery.</span><span class="sxs-lookup"><span data-stu-id="e8a98-115">The source location must have virtual machines that are enabled for failover and recovery.</span></span>

    - <span data-ttu-id="e8a98-116">For VMM to VMM replication, select **Source Type** > **VMM**, and the source and target VMM servers.</span><span class="sxs-lookup"><span data-stu-id="e8a98-116">For VMM to VMM replication, select **Source Type** > **VMM**, and the source and target VMM servers.</span></span> <span data-ttu-id="e8a98-117">Click **Hyper-V** to see clouds that are protected.</span><span class="sxs-lookup"><span data-stu-id="e8a98-117">Click **Hyper-V** to see clouds that are protected.</span></span>
    - <span data-ttu-id="e8a98-118">For VMM to Azure, select **Source Type** > **VMM**.</span><span class="sxs-lookup"><span data-stu-id="e8a98-118">For VMM to Azure, select **Source Type** > **VMM**.</span></span>  <span data-ttu-id="e8a98-119">Select the source VMM server, and **Azure** as the target.</span><span class="sxs-lookup"><span data-stu-id="e8a98-119">Select the source VMM server, and **Azure** as the target.</span></span>
    - <span data-ttu-id="e8a98-120">For Hyper-V replication to Azure (without VMM), select **Source Type** > **Hyper-V site**.</span><span class="sxs-lookup"><span data-stu-id="e8a98-120">For Hyper-V replication to Azure (without VMM), select **Source Type** > **Hyper-V site**.</span></span> <span data-ttu-id="e8a98-121">Select the site as the source, and **Azure** as the target.</span><span class="sxs-lookup"><span data-stu-id="e8a98-121">Select the site as the source, and **Azure** as the target.</span></span>
    - <span data-ttu-id="e8a98-122">For a VMware VM or a physical on-premises server to Azure, select a configuration server as the source, and **Azure** as the target.</span><span class="sxs-lookup"><span data-stu-id="e8a98-122">For a VMware VM or a physical on-premises server to Azure, select a configuration server as the source, and **Azure** as the target.</span></span>
2. <span data-ttu-id="e8a98-123">In **Select virtual machines**, select the virtual machines (or replication group) that you want to add to the default group (Group 1) in the recovery plan.</span><span class="sxs-lookup"><span data-stu-id="e8a98-123">In **Select virtual machines**, select the virtual machines (or replication group) that you want to add to the default group (Group 1) in the recovery plan.</span></span>

## <a name="customize-and-extend-recovery-plans"></a><span data-ttu-id="e8a98-124">Customize and extend recovery plans</span><span class="sxs-lookup"><span data-stu-id="e8a98-124">Customize and extend recovery plans</span></span>

<span data-ttu-id="e8a98-125">You can customize and extend recovery plans:</span><span class="sxs-lookup"><span data-stu-id="e8a98-125">You can customize and extend recovery plans:</span></span>

- <span data-ttu-id="e8a98-126">**Add new groups**—Add additional recovery plan groups (up to seven) to the default group, and then add more machines or replication groups to those recovery plan groups.</span><span class="sxs-lookup"><span data-stu-id="e8a98-126">**Add new groups**—Add additional recovery plan groups (up to seven) to the default group, and then add more machines or replication groups to those recovery plan groups.</span></span> <span data-ttu-id="e8a98-127">Groups are numbered in the order in which you add them.</span><span class="sxs-lookup"><span data-stu-id="e8a98-127">Groups are numbered in the order in which you add them.</span></span> <span data-ttu-id="e8a98-128">A virtual machine, or replication group, can only be included in one recovery plan group.</span><span class="sxs-lookup"><span data-stu-id="e8a98-128">A virtual machine, or replication group, can only be included in one recovery plan group.</span></span>
- <span data-ttu-id="e8a98-129">**Add a manual action**—You can add manual actions that run before or after a recovery plan group.</span><span class="sxs-lookup"><span data-stu-id="e8a98-129">**Add a manual action**—You can add manual actions that run before or after a recovery plan group.</span></span> <span data-ttu-id="e8a98-130">When the recovery plan runs, it stops at the point at which you inserted the manual action.</span><span class="sxs-lookup"><span data-stu-id="e8a98-130">When the recovery plan runs, it stops at the point at which you inserted the manual action.</span></span> <span data-ttu-id="e8a98-131">A dialog box prompts you to specify that the manual action was completed.</span><span class="sxs-lookup"><span data-stu-id="e8a98-131">A dialog box prompts you to specify that the manual action was completed.</span></span>
- <span data-ttu-id="e8a98-132">**Add a script**—You can add scripts that run before or after a recovery plan group.</span><span class="sxs-lookup"><span data-stu-id="e8a98-132">**Add a script**—You can add scripts that run before or after a recovery plan group.</span></span> <span data-ttu-id="e8a98-133">When you add a script, it adds a new set of actions for the group.</span><span class="sxs-lookup"><span data-stu-id="e8a98-133">When you add a script, it adds a new set of actions for the group.</span></span> <span data-ttu-id="e8a98-134">For example, a set of pre-steps for Group 1 will be created with the name: Group 1: pre-steps.</span><span class="sxs-lookup"><span data-stu-id="e8a98-134">For example, a set of pre-steps for Group 1 will be created with the name: Group 1: pre-steps.</span></span> <span data-ttu-id="e8a98-135">All pre-steps will be listed inside this set.</span><span class="sxs-lookup"><span data-stu-id="e8a98-135">All pre-steps will be listed inside this set.</span></span> <span data-ttu-id="e8a98-136">You can only add a script on the primary site if you have a VMM server deployed.</span><span class="sxs-lookup"><span data-stu-id="e8a98-136">You can only add a script on the primary site if you have a VMM server deployed.</span></span>
- <span data-ttu-id="e8a98-137">**Add Azure runbooks**—You can extend recovery plans with Azure runbooks.</span><span class="sxs-lookup"><span data-stu-id="e8a98-137">**Add Azure runbooks**—You can extend recovery plans with Azure runbooks.</span></span> <span data-ttu-id="e8a98-138">For example, to automate tasks, or to create single-step recovery.</span><span class="sxs-lookup"><span data-stu-id="e8a98-138">For example, to automate tasks, or to create single-step recovery.</span></span> <span data-ttu-id="e8a98-139">[Learn more](site-recovery-runbook-automation.md).</span><span class="sxs-lookup"><span data-stu-id="e8a98-139">[Learn more](site-recovery-runbook-automation.md).</span></span>

## <a name="add-scripts"></a><span data-ttu-id="e8a98-140">Add scripts</span><span class="sxs-lookup"><span data-stu-id="e8a98-140">Add scripts</span></span>

<span data-ttu-id="e8a98-141">You can use PowerShell scripts in your recovery plans.</span><span class="sxs-lookup"><span data-stu-id="e8a98-141">You can use PowerShell scripts in your recovery plans.</span></span>

 - <span data-ttu-id="e8a98-142">Ensure that scripts use try-catch blocks so that the exceptions are handled gracefully.</span><span class="sxs-lookup"><span data-stu-id="e8a98-142">Ensure that scripts use try-catch blocks so that the exceptions are handled gracefully.</span></span>
    - <span data-ttu-id="e8a98-143">If there is an exception in the script, it stops running and the task shows as failed.</span><span class="sxs-lookup"><span data-stu-id="e8a98-143">If there is an exception in the script, it stops running and the task shows as failed.</span></span>
    - <span data-ttu-id="e8a98-144">If an error occurs, any remaining part of the script doesn't run.</span><span class="sxs-lookup"><span data-stu-id="e8a98-144">If an error occurs, any remaining part of the script doesn't run.</span></span>
    - <span data-ttu-id="e8a98-145">If an error occurs when you run an unplanned failover, the recovery plan continues.</span><span class="sxs-lookup"><span data-stu-id="e8a98-145">If an error occurs when you run an unplanned failover, the recovery plan continues.</span></span>
    - <span data-ttu-id="e8a98-146">If an error occurs when you run a planned failover, the recovery plan stops.</span><span class="sxs-lookup"><span data-stu-id="e8a98-146">If an error occurs when you run a planned failover, the recovery plan stops.</span></span> <span data-ttu-id="e8a98-147">You need to fix the script, check that it runs as expected, and then run the recovery plan again.</span><span class="sxs-lookup"><span data-stu-id="e8a98-147">You need to fix the script, check that it runs as expected, and then run the recovery plan again.</span></span>
- <span data-ttu-id="e8a98-148">The Write-Host command doesn’t work in a recovery plan script, and the script will fail.</span><span class="sxs-lookup"><span data-stu-id="e8a98-148">The Write-Host command doesn’t work in a recovery plan script, and the script will fail.</span></span> <span data-ttu-id="e8a98-149">To create output, create a proxy script that in turn runs your main script.</span><span class="sxs-lookup"><span data-stu-id="e8a98-149">To create output, create a proxy script that in turn runs your main script.</span></span> <span data-ttu-id="e8a98-150">Make sure that all output is piped out using the >> command.</span><span class="sxs-lookup"><span data-stu-id="e8a98-150">Make sure that all output is piped out using the >> command.</span></span>
  * <span data-ttu-id="e8a98-151">The script times out if it doesn't return within 600 seconds.</span><span class="sxs-lookup"><span data-stu-id="e8a98-151">The script times out if it doesn't return within 600 seconds.</span></span>
  * <span data-ttu-id="e8a98-152">If anything is written out to STDERR, the script is classified as failed.</span><span class="sxs-lookup"><span data-stu-id="e8a98-152">If anything is written out to STDERR, the script is classified as failed.</span></span> <span data-ttu-id="e8a98-153">This information is displayed in the script execution details.</span><span class="sxs-lookup"><span data-stu-id="e8a98-153">This information is displayed in the script execution details.</span></span>

<span data-ttu-id="e8a98-154">If you're using VMM in your deployment:</span><span class="sxs-lookup"><span data-stu-id="e8a98-154">If you're using VMM in your deployment:</span></span>

* <span data-ttu-id="e8a98-155">Scripts in a recovery plan run in the context of the VMM Service account.</span><span class="sxs-lookup"><span data-stu-id="e8a98-155">Scripts in a recovery plan run in the context of the VMM Service account.</span></span> <span data-ttu-id="e8a98-156">Make sure this account has Read permissions for the remote share on which the script is located.</span><span class="sxs-lookup"><span data-stu-id="e8a98-156">Make sure this account has Read permissions for the remote share on which the script is located.</span></span> <span data-ttu-id="e8a98-157">Test the script to run at the VMM service account privilege level.</span><span class="sxs-lookup"><span data-stu-id="e8a98-157">Test the script to run at the VMM service account privilege level.</span></span>
* <span data-ttu-id="e8a98-158">VMM cmdlets are delivered in a Windows PowerShell module.</span><span class="sxs-lookup"><span data-stu-id="e8a98-158">VMM cmdlets are delivered in a Windows PowerShell module.</span></span> <span data-ttu-id="e8a98-159">The module is installed when you install the VMM console.</span><span class="sxs-lookup"><span data-stu-id="e8a98-159">The module is installed when you install the VMM console.</span></span> <span data-ttu-id="e8a98-160">It can be loaded into your script, using the following command in the script:</span><span class="sxs-lookup"><span data-stu-id="e8a98-160">It can be loaded into your script, using the following command in the script:</span></span> 
   - <span data-ttu-id="e8a98-161">Import-Module -Name virtualmachinemanager.</span><span class="sxs-lookup"><span data-stu-id="e8a98-161">Import-Module -Name virtualmachinemanager.</span></span> <span data-ttu-id="e8a98-162">[Learn more](https://technet.microsoft.com/library/hh875013.aspx).</span><span class="sxs-lookup"><span data-stu-id="e8a98-162">[Learn more](https://technet.microsoft.com/library/hh875013.aspx).</span></span>
* <span data-ttu-id="e8a98-163">Ensure you have at least one library server in your VMM deployment.</span><span class="sxs-lookup"><span data-stu-id="e8a98-163">Ensure you have at least one library server in your VMM deployment.</span></span> <span data-ttu-id="e8a98-164">By default, the library share path for a VMM server is located locally on the VMM server, with the folder name MSCVMMLibrary.</span><span class="sxs-lookup"><span data-stu-id="e8a98-164">By default, the library share path for a VMM server is located locally on the VMM server, with the folder name MSCVMMLibrary.</span></span>
    * <span data-ttu-id="e8a98-165">If your library share path is remote (or local but not shared with MSCVMMLibrary), configure the share as follows (using \\libserver2.contoso.com\share\ as an example):</span><span class="sxs-lookup"><span data-stu-id="e8a98-165">If your library share path is remote (or local but not shared with MSCVMMLibrary), configure the share as follows (using \\libserver2.contoso.com\share\ as an example):</span></span>
      * <span data-ttu-id="e8a98-166">Open the Registry Editor and navigate to **HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\Azure Site Recovery\Registration**.</span><span class="sxs-lookup"><span data-stu-id="e8a98-166">Open the Registry Editor and navigate to **HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\Azure Site Recovery\Registration**.</span></span>
      * <span data-ttu-id="e8a98-167">Edit the value **ScriptLibraryPath** and place it as \\libserver2.contoso.com\share\.</span><span class="sxs-lookup"><span data-stu-id="e8a98-167">Edit the value **ScriptLibraryPath** and place it as \\libserver2.contoso.com\share\.</span></span> <span data-ttu-id="e8a98-168">Specify the full FQDN.</span><span class="sxs-lookup"><span data-stu-id="e8a98-168">Specify the full FQDN.</span></span> <span data-ttu-id="e8a98-169">Provide permissions to the share location.</span><span class="sxs-lookup"><span data-stu-id="e8a98-169">Provide permissions to the share location.</span></span>
      * <span data-ttu-id="e8a98-170">Ensure that you test the script with a user account that has the same permissions as the VMM service account.</span><span class="sxs-lookup"><span data-stu-id="e8a98-170">Ensure that you test the script with a user account that has the same permissions as the VMM service account.</span></span> <span data-ttu-id="e8a98-171">This checks that standalone tested scripts run in the same way as they will in recovery plans.</span><span class="sxs-lookup"><span data-stu-id="e8a98-171">This checks that standalone tested scripts run in the same way as they will in recovery plans.</span></span> <span data-ttu-id="e8a98-172">On the VMM server, set the execution policy to bypass as follows:</span><span class="sxs-lookup"><span data-stu-id="e8a98-172">On the VMM server, set the execution policy to bypass as follows:</span></span>
        * <span data-ttu-id="e8a98-173">Open the 64-bit Windows PowerShell console using elevated privileges.</span><span class="sxs-lookup"><span data-stu-id="e8a98-173">Open the 64-bit Windows PowerShell console using elevated privileges.</span></span>
        * <span data-ttu-id="e8a98-174">Type: **Set-executionpolicy bypass**.</span><span class="sxs-lookup"><span data-stu-id="e8a98-174">Type: **Set-executionpolicy bypass**.</span></span> <span data-ttu-id="e8a98-175">[Learn more](https://technet.microsoft.com/library/ee176961.aspx).</span><span class="sxs-lookup"><span data-stu-id="e8a98-175">[Learn more](https://technet.microsoft.com/library/ee176961.aspx).</span></span>

## <a name="add-a-script-or-manual-action-to-a-plan"></a><span data-ttu-id="e8a98-176">Add a script or manual action to a plan</span><span class="sxs-lookup"><span data-stu-id="e8a98-176">Add a script or manual action to a plan</span></span>

<span data-ttu-id="e8a98-177">You can add a script to the default recovery plan group after you've added VMs or replication groups to it, and created the plan.</span><span class="sxs-lookup"><span data-stu-id="e8a98-177">You can add a script to the default recovery plan group after you've added VMs or replication groups to it, and created the plan.</span></span>

1. <span data-ttu-id="e8a98-178">Open the recovery plan.</span><span class="sxs-lookup"><span data-stu-id="e8a98-178">Open the recovery plan.</span></span>
2. <span data-ttu-id="e8a98-179">Click an item in the **Step** list, and then click **Script** or **Manual Action**.</span><span class="sxs-lookup"><span data-stu-id="e8a98-179">Click an item in the **Step** list, and then click **Script** or **Manual Action**.</span></span>
3. <span data-ttu-id="e8a98-180">Specify whether to want to add the script or action before or after the selected item.</span><span class="sxs-lookup"><span data-stu-id="e8a98-180">Specify whether to want to add the script or action before or after the selected item.</span></span> <span data-ttu-id="e8a98-181">Use the **Move Up** and **Move Down**  buttons, to move the position of the script up or down.</span><span class="sxs-lookup"><span data-stu-id="e8a98-181">Use the **Move Up** and **Move Down**  buttons, to move the position of the script up or down.</span></span>
4. <span data-ttu-id="e8a98-182">If you add a VMM script, select **Failover to VMM script**.</span><span class="sxs-lookup"><span data-stu-id="e8a98-182">If you add a VMM script, select **Failover to VMM script**.</span></span> <span data-ttu-id="e8a98-183">In **Script Path**, type the relative path to the share.</span><span class="sxs-lookup"><span data-stu-id="e8a98-183">In **Script Path**, type the relative path to the share.</span></span> <span data-ttu-id="e8a98-184">In the VMM example below, you specify the path: **\RPScripts\RPScript.PS1**.</span><span class="sxs-lookup"><span data-stu-id="e8a98-184">In the VMM example below, you specify the path: **\RPScripts\RPScript.PS1**.</span></span>
5. <span data-ttu-id="e8a98-185">If you add an Azure automation run book, specify the Azure Automation account in which the runbook is located, and select the appropriate Azure runbook script.</span><span class="sxs-lookup"><span data-stu-id="e8a98-185">If you add an Azure automation run book, specify the Azure Automation account in which the runbook is located, and select the appropriate Azure runbook script.</span></span>
6. <span data-ttu-id="e8a98-186">Do a failover of the recovery plan, to make sure the script works as expected.</span><span class="sxs-lookup"><span data-stu-id="e8a98-186">Do a failover of the recovery plan, to make sure the script works as expected.</span></span>


### <a name="vmm-script"></a><span data-ttu-id="e8a98-187">VMM script</span><span class="sxs-lookup"><span data-stu-id="e8a98-187">VMM script</span></span>

<span data-ttu-id="e8a98-188">If you have a VMM source site, you can create a script on the VMM server, and include it in your recovery plan.</span><span class="sxs-lookup"><span data-stu-id="e8a98-188">If you have a VMM source site, you can create a script on the VMM server, and include it in your recovery plan.</span></span>

1. <span data-ttu-id="e8a98-189">Create a new folder in the library share.</span><span class="sxs-lookup"><span data-stu-id="e8a98-189">Create a new folder in the library share.</span></span> <span data-ttu-id="e8a98-190">For example, \<VMMServerName>\MSSCVMMLibrary\RPScripts.</span><span class="sxs-lookup"><span data-stu-id="e8a98-190">For example, \<VMMServerName>\MSSCVMMLibrary\RPScripts.</span></span> <span data-ttu-id="e8a98-191">Place it on the source and target VMM servers.</span><span class="sxs-lookup"><span data-stu-id="e8a98-191">Place it on the source and target VMM servers.</span></span>
2. <span data-ttu-id="e8a98-192">Create the script (for example RPScript), and check it works as expected.</span><span class="sxs-lookup"><span data-stu-id="e8a98-192">Create the script (for example RPScript), and check it works as expected.</span></span>
3. <span data-ttu-id="e8a98-193">Place the script in the location \<VMMServerName>\MSSCVMMLibrary, on the source and target VMM servers.</span><span class="sxs-lookup"><span data-stu-id="e8a98-193">Place the script in the location \<VMMServerName>\MSSCVMMLibrary, on the source and target VMM servers.</span></span>


## <a name="next-steps"></a><span data-ttu-id="e8a98-194">Next steps</span><span class="sxs-lookup"><span data-stu-id="e8a98-194">Next steps</span></span>

<span data-ttu-id="e8a98-195">[Learn more](site-recovery-failover.md) about running failovers.</span><span class="sxs-lookup"><span data-stu-id="e8a98-195">[Learn more](site-recovery-failover.md) about running failovers.</span></span>
