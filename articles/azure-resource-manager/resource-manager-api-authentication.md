---
title: Azure Active Directory authentication and Resource Manager | Microsoft Docs
description: A developer's guide to authentication with the Azure Resource Manager API and Azure Active Directory for integrating an app with other Azure subscriptions.
services: azure-resource-manager,active-directory
documentationcenter: na
author: dushyantgill
manager: timlt
editor: tysonn
ms.assetid: 17b2b40d-bf42-4c7d-9a88-9938409c5088
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 07/12/2018
ms.author: dugill
ms.openlocfilehash: 58309977c93864d52a3217919ac8d7fa9152a968
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44794773"
---
# <a name="use-resource-manager-authentication-api-to-access-subscriptions"></a><span data-ttu-id="5034d-103">Use Resource Manager authentication API to access subscriptions</span><span class="sxs-lookup"><span data-stu-id="5034d-103">Use Resource Manager authentication API to access subscriptions</span></span>
## <a name="introduction"></a><span data-ttu-id="5034d-104">Introduction</span><span class="sxs-lookup"><span data-stu-id="5034d-104">Introduction</span></span>
<span data-ttu-id="5034d-105">If you are a software developer who needs to create an app that manages a customer's Azure resources, this article shows you how to authenticate with the Azure Resource Manager APIs and gain access to resources in other subscriptions.</span><span class="sxs-lookup"><span data-stu-id="5034d-105">If you are a software developer who needs to create an app that manages a customer's Azure resources, this article shows you how to authenticate with the Azure Resource Manager APIs and gain access to resources in other subscriptions.</span></span>

<span data-ttu-id="5034d-106">Your app can access the Resource Manager APIs in couple of ways:</span><span class="sxs-lookup"><span data-stu-id="5034d-106">Your app can access the Resource Manager APIs in couple of ways:</span></span>

1. <span data-ttu-id="5034d-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span><span class="sxs-lookup"><span data-stu-id="5034d-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span></span> <span data-ttu-id="5034d-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span><span class="sxs-lookup"><span data-stu-id="5034d-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span></span>
2. <span data-ttu-id="5034d-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span><span class="sxs-lookup"><span data-stu-id="5034d-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span></span> <span data-ttu-id="5034d-110">The app's identity is granted direct access to the resources.</span><span class="sxs-lookup"><span data-stu-id="5034d-110">The app's identity is granted direct access to the resources.</span></span> <span data-ttu-id="5034d-111">This approach works for apps that need long-term headless (unattended) access to Azure.</span><span class="sxs-lookup"><span data-stu-id="5034d-111">This approach works for apps that need long-term headless (unattended) access to Azure.</span></span>

<span data-ttu-id="5034d-112">This article provides step-by-step instructions to create an app that employs both these authorization methods.</span><span class="sxs-lookup"><span data-stu-id="5034d-112">This article provides step-by-step instructions to create an app that employs both these authorization methods.</span></span> <span data-ttu-id="5034d-113">It shows how to perform each step with REST API or C#.</span><span class="sxs-lookup"><span data-stu-id="5034d-113">It shows how to perform each step with REST API or C#.</span></span> <span data-ttu-id="5034d-114">The complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span><span class="sxs-lookup"><span data-stu-id="5034d-114">The complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span></span>

## <a name="what-the-web-app-does"></a><span data-ttu-id="5034d-115">What the web app does</span><span class="sxs-lookup"><span data-stu-id="5034d-115">What the web app does</span></span>
<span data-ttu-id="5034d-116">The web app:</span><span class="sxs-lookup"><span data-stu-id="5034d-116">The web app:</span></span>

1. <span data-ttu-id="5034d-117">Signs-in an Azure user.</span><span class="sxs-lookup"><span data-stu-id="5034d-117">Signs-in an Azure user.</span></span>
2. <span data-ttu-id="5034d-118">Asks user to grant the web app access to Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="5034d-118">Asks user to grant the web app access to Resource Manager.</span></span>
3. <span data-ttu-id="5034d-119">Gets user + app access token for accessing Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="5034d-119">Gets user + app access token for accessing Resource Manager.</span></span>
4. <span data-ttu-id="5034d-120">Uses token (from step 3) to assign the app's service principal to a role in the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-120">Uses token (from step 3) to assign the app's service principal to a role in the subscription.</span></span> <span data-ttu-id="5034d-121">This step gives the app long-term access to the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-121">This step gives the app long-term access to the subscription.</span></span>
5. <span data-ttu-id="5034d-122">Gets app-only access token.</span><span class="sxs-lookup"><span data-stu-id="5034d-122">Gets app-only access token.</span></span>
6. <span data-ttu-id="5034d-123">Uses token (from step 5) to manage resources in the subscription through Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="5034d-123">Uses token (from step 5) to manage resources in the subscription through Resource Manager.</span></span>

<span data-ttu-id="5034d-124">Here's the flow of the web application.</span><span class="sxs-lookup"><span data-stu-id="5034d-124">Here's the flow of the web application.</span></span>

![Resource Manager Authentication flow](./media/resource-manager-api-authentication/Auth-Swim-Lane.png)

<span data-ttu-id="5034d-126">As a user, you provide the subscription ID for the subscription you want to use:</span><span class="sxs-lookup"><span data-stu-id="5034d-126">As a user, you provide the subscription ID for the subscription you want to use:</span></span>

![provide subscription ID](./media/resource-manager-api-authentication/sample-ux-1.png)

<span data-ttu-id="5034d-128">Select the account to use for logging in.</span><span class="sxs-lookup"><span data-stu-id="5034d-128">Select the account to use for logging in.</span></span>

![select account](./media/resource-manager-api-authentication/sample-ux-2.png)

<span data-ttu-id="5034d-130">Provide your credentials.</span><span class="sxs-lookup"><span data-stu-id="5034d-130">Provide your credentials.</span></span>

![provide credentials](./media/resource-manager-api-authentication/sample-ux-3.png)

<span data-ttu-id="5034d-132">Grant the app access to your Azure subscriptions:</span><span class="sxs-lookup"><span data-stu-id="5034d-132">Grant the app access to your Azure subscriptions:</span></span>

![Grant access](./media/resource-manager-api-authentication/sample-ux-4.png)

<span data-ttu-id="5034d-134">Manage your connected subscriptions:</span><span class="sxs-lookup"><span data-stu-id="5034d-134">Manage your connected subscriptions:</span></span>

![Connect subscription](./media/resource-manager-api-authentication/sample-ux-7.png)

## <a name="register-application"></a><span data-ttu-id="5034d-136">Register application</span><span class="sxs-lookup"><span data-stu-id="5034d-136">Register application</span></span>
<span data-ttu-id="5034d-137">Before you start coding, register your web app with Azure Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="5034d-137">Before you start coding, register your web app with Azure Active Directory (AD).</span></span> <span data-ttu-id="5034d-138">The app registration creates a central identity for your app in Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5034d-138">The app registration creates a central identity for your app in Azure AD.</span></span> <span data-ttu-id="5034d-139">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses to authenticate and access Azure Resource Manager APIs.</span><span class="sxs-lookup"><span data-stu-id="5034d-139">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses to authenticate and access Azure Resource Manager APIs.</span></span> <span data-ttu-id="5034d-140">The app registration also records the various delegated permissions that your application needs when accessing Microsoft APIs on behalf of the user.</span><span class="sxs-lookup"><span data-stu-id="5034d-140">The app registration also records the various delegated permissions that your application needs when accessing Microsoft APIs on behalf of the user.</span></span>

<span data-ttu-id="5034d-141">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span><span class="sxs-lookup"><span data-stu-id="5034d-141">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span></span> <span data-ttu-id="5034d-142">To pass validation, provide a domain associated with your Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="5034d-142">To pass validation, provide a domain associated with your Azure Active Directory.</span></span> <span data-ttu-id="5034d-143">To see the domains associated with your Azure Active Directory, sign in to the portal.</span><span class="sxs-lookup"><span data-stu-id="5034d-143">To see the domains associated with your Azure Active Directory, sign in to the portal.</span></span>

<span data-ttu-id="5034d-144">The following example shows how to register the app by using Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="5034d-144">The following example shows how to register the app by using Azure PowerShell.</span></span> <span data-ttu-id="5034d-145">You must have the latest version (August 2016) of Azure PowerShell for this command to work.</span><span class="sxs-lookup"><span data-stu-id="5034d-145">You must have the latest version (August 2016) of Azure PowerShell for this command to work.</span></span>

```azurepowershell-interactive
$app = New-AzureRmADApplication -DisplayName "{app name}" -HomePage "https://{your domain}/{app name}" -IdentifierUris "https://{your domain}/{app name}" -Password "{your password}" -AvailableToOtherTenants $true
```

<span data-ttu-id="5034d-146">To sign in as the AD application, you need the application ID and password.</span><span class="sxs-lookup"><span data-stu-id="5034d-146">To sign in as the AD application, you need the application ID and password.</span></span> <span data-ttu-id="5034d-147">To see the application ID that is returned from the previous command, use:</span><span class="sxs-lookup"><span data-stu-id="5034d-147">To see the application ID that is returned from the previous command, use:</span></span>

```azurepowershell-interactive
$app.ApplicationId
```

<span data-ttu-id="5034d-148">The following example shows how to register the app by using Azure CLI.</span><span class="sxs-lookup"><span data-stu-id="5034d-148">The following example shows how to register the app by using Azure CLI.</span></span>

```azurecli-interactive
az ad app create --display-name {app name} --homepage https://{your domain}/{app name} --identifier-uris https://{your domain}/{app name} --password {your password} --available-to-other-tenants true
```

<span data-ttu-id="5034d-149">The results include the AppId, which you need when authenticating as the application.</span><span class="sxs-lookup"><span data-stu-id="5034d-149">The results include the AppId, which you need when authenticating as the application.</span></span>

### <a name="optional-configuration---certificate-credential"></a><span data-ttu-id="5034d-150">Optional configuration - certificate credential</span><span class="sxs-lookup"><span data-stu-id="5034d-150">Optional configuration - certificate credential</span></span>
<span data-ttu-id="5034d-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep the private key, and add the public key to your Azure AD application registration.</span><span class="sxs-lookup"><span data-stu-id="5034d-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep the private key, and add the public key to your Azure AD application registration.</span></span> <span data-ttu-id="5034d-152">For authentication, your application sends a small payload to Azure AD signed using your private key, and Azure AD validates the signature using the public key that you registered.</span><span class="sxs-lookup"><span data-stu-id="5034d-152">For authentication, your application sends a small payload to Azure AD signed using your private key, and Azure AD validates the signature using the public key that you registered.</span></span>

<span data-ttu-id="5034d-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell to create a service principal to access resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI to create a service principal to access resources](resource-group-authenticate-service-principal-cli.md).</span><span class="sxs-lookup"><span data-stu-id="5034d-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell to create a service principal to access resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI to create a service principal to access resources](resource-group-authenticate-service-principal-cli.md).</span></span>

## <a name="get-tenant-id-from-subscription-id"></a><span data-ttu-id="5034d-154">Get tenant ID from subscription ID</span><span class="sxs-lookup"><span data-stu-id="5034d-154">Get tenant ID from subscription ID</span></span>
<span data-ttu-id="5034d-155">To request a token that can be used to call Resource Manager, your application needs to know the tenant ID of the Azure AD tenant that hosts the Azure subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-155">To request a token that can be used to call Resource Manager, your application needs to know the tenant ID of the Azure AD tenant that hosts the Azure subscription.</span></span> <span data-ttu-id="5034d-156">Most likely, your users know their subscription IDs, but they might not know their tenant IDs for Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="5034d-156">Most likely, your users know their subscription IDs, but they might not know their tenant IDs for Azure Active Directory.</span></span> <span data-ttu-id="5034d-157">To get the user's tenant ID, ask the user for the subscription ID.</span><span class="sxs-lookup"><span data-stu-id="5034d-157">To get the user's tenant ID, ask the user for the subscription ID.</span></span> <span data-ttu-id="5034d-158">Provide that subscription ID when sending a request about the subscription:</span><span class="sxs-lookup"><span data-stu-id="5034d-158">Provide that subscription ID when sending a request about the subscription:</span></span>

    https://management.azure.com/subscriptions/{subscription-id}?api-version=2015-01-01

<span data-ttu-id="5034d-159">The request fails because the user has not logged in yet, but you can retrieve the tenant ID from the response.</span><span class="sxs-lookup"><span data-stu-id="5034d-159">The request fails because the user has not logged in yet, but you can retrieve the tenant ID from the response.</span></span> <span data-ttu-id="5034d-160">In that exception, retrieve the tenant ID from the response header value for **WWW-Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="5034d-160">In that exception, retrieve the tenant ID from the response header value for **WWW-Authenticate**.</span></span> <span data-ttu-id="5034d-161">You see this implementation in the [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span><span class="sxs-lookup"><span data-stu-id="5034d-161">You see this implementation in the [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span></span>

## <a name="get-user--app-access-token"></a><span data-ttu-id="5034d-162">Get user + app access token</span><span class="sxs-lookup"><span data-stu-id="5034d-162">Get user + app access token</span></span>
<span data-ttu-id="5034d-163">Your application redirects the user to Azure AD with an OAuth 2.0 Authorize Request - to authenticate the user's credentials and get back an authorization code.</span><span class="sxs-lookup"><span data-stu-id="5034d-163">Your application redirects the user to Azure AD with an OAuth 2.0 Authorize Request - to authenticate the user's credentials and get back an authorization code.</span></span> <span data-ttu-id="5034d-164">Your application uses the authorization code to get an access token for Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="5034d-164">Your application uses the authorization code to get an access token for Resource Manager.</span></span> <span data-ttu-id="5034d-165">The [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates the authorization request.</span><span class="sxs-lookup"><span data-stu-id="5034d-165">The [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates the authorization request.</span></span>

<span data-ttu-id="5034d-166">This article shows the REST API requests to authenticate the user.</span><span class="sxs-lookup"><span data-stu-id="5034d-166">This article shows the REST API requests to authenticate the user.</span></span> <span data-ttu-id="5034d-167">You can also use helper libraries to perform authentication in your code.</span><span class="sxs-lookup"><span data-stu-id="5034d-167">You can also use helper libraries to perform authentication in your code.</span></span> <span data-ttu-id="5034d-168">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="5034d-168">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span></span> <span data-ttu-id="5034d-169">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/develop/azure-ad-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="5034d-169">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/develop/azure-ad-developers-guide.md).</span></span>

### <a name="auth-request-oauth-20"></a><span data-ttu-id="5034d-170">Auth request (OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="5034d-170">Auth request (OAuth 2.0)</span></span>
<span data-ttu-id="5034d-171">Issue an Open ID Connect/OAuth2.0 Authorize Request to the Azure AD Authorize endpoint:</span><span class="sxs-lookup"><span data-stu-id="5034d-171">Issue an Open ID Connect/OAuth2.0 Authorize Request to the Azure AD Authorize endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize

<span data-ttu-id="5034d-172">The query string parameters that are available for this request are described in the [request an authorization code](../active-directory/develop/v1-protocols-oauth-code.md#request-an-authorization-code) article.</span><span class="sxs-lookup"><span data-stu-id="5034d-172">The query string parameters that are available for this request are described in the [request an authorization code](../active-directory/develop/v1-protocols-oauth-code.md#request-an-authorization-code) article.</span></span>

<span data-ttu-id="5034d-173">The following example shows how to request OAuth2.0 authorization:</span><span class="sxs-lookup"><span data-stu-id="5034d-173">The following example shows how to request OAuth2.0 authorization:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=query&response_type=code&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&domain_hint=live.com

<span data-ttu-id="5034d-174">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span><span class="sxs-lookup"><span data-stu-id="5034d-174">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="5034d-175">It returns the authorization code to the Reply URL of your application.</span><span class="sxs-lookup"><span data-stu-id="5034d-175">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="5034d-176">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span><span class="sxs-lookup"><span data-stu-id="5034d-176">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

    code=AAABAAAAiL****FDMZBUwZ8eCAA&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="auth-request-open-id-connect"></a><span data-ttu-id="5034d-177">Auth request (Open ID Connect)</span><span class="sxs-lookup"><span data-stu-id="5034d-177">Auth request (Open ID Connect)</span></span>
<span data-ttu-id="5034d-178">If you not only wish to access Azure Resource Manager on behalf of the user, but also allow the user to sign in to your application using their Azure AD account, issue an Open ID Connect Authorize Request.</span><span class="sxs-lookup"><span data-stu-id="5034d-178">If you not only wish to access Azure Resource Manager on behalf of the user, but also allow the user to sign in to your application using their Azure AD account, issue an Open ID Connect Authorize Request.</span></span> <span data-ttu-id="5034d-179">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use to sign in the user.</span><span class="sxs-lookup"><span data-stu-id="5034d-179">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use to sign in the user.</span></span>

<span data-ttu-id="5034d-180">The query string parameters that are available for this request are described in the [Send the sign-in request](../active-directory/develop/v1-protocols-openid-connect-code.md#send-the-sign-in-request) article.</span><span class="sxs-lookup"><span data-stu-id="5034d-180">The query string parameters that are available for this request are described in the [Send the sign-in request](../active-directory/develop/v1-protocols-openid-connect-code.md#send-the-sign-in-request) article.</span></span>

<span data-ttu-id="5034d-181">An example Open ID Connect request is:</span><span class="sxs-lookup"><span data-stu-id="5034d-181">An example Open ID Connect request is:</span></span>

     https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=form_post&response_type=code+id_token&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&scope=openid+profile&nonce=63567Dc4MDAw&domain_hint=live.com&state=M_12tMyKaM8

<span data-ttu-id="5034d-182">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span><span class="sxs-lookup"><span data-stu-id="5034d-182">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="5034d-183">It returns the authorization code to the Reply URL of your application.</span><span class="sxs-lookup"><span data-stu-id="5034d-183">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="5034d-184">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span><span class="sxs-lookup"><span data-stu-id="5034d-184">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

<span data-ttu-id="5034d-185">An example Open ID Connect response is:</span><span class="sxs-lookup"><span data-stu-id="5034d-185">An example Open ID Connect response is:</span></span>

    code=AAABAAAAiL*****I4rDWd7zXsH6WUjlkIEQxIAA&id_token=eyJ0eXAiOiJKV1Q*****T3GrzzSFxg&state=M_12tMyKaM8&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="token-request-oauth20-code-grant-flow"></a><span data-ttu-id="5034d-186">Token request (OAuth2.0 Code Grant Flow)</span><span class="sxs-lookup"><span data-stu-id="5034d-186">Token request (OAuth2.0 Code Grant Flow)</span></span>
<span data-ttu-id="5034d-187">Now that your application has received the authorization code from Azure AD, it is time to get the access token for Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="5034d-187">Now that your application has received the authorization code from Azure AD, it is time to get the access token for Azure Resource Manager.</span></span>  <span data-ttu-id="5034d-188">Post an OAuth2.0 Code Grant Token Request to the Azure AD Token endpoint:</span><span class="sxs-lookup"><span data-stu-id="5034d-188">Post an OAuth2.0 Code Grant Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="5034d-189">The query string parameters that are available for this request are described in the [use the authorization code](../active-directory/develop/v1-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) article.</span><span class="sxs-lookup"><span data-stu-id="5034d-189">The query string parameters that are available for this request are described in the [use the authorization code](../active-directory/develop/v1-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) article.</span></span>

<span data-ttu-id="5034d-190">The following example shows a request for code grant token with password credential:</span><span class="sxs-lookup"><span data-stu-id="5034d-190">The following example shows a request for code grant token with password credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="5034d-191">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using the private key of your application's certificate credential.</span><span class="sxs-lookup"><span data-stu-id="5034d-191">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using the private key of your application's certificate credential.</span></span> <span data-ttu-id="5034d-192">The claim types for the token are shown in [JWT token claims](../active-directory/develop/v1-protocols-oauth-code.md#jwt-token-claims).</span><span class="sxs-lookup"><span data-stu-id="5034d-192">The claim types for the token are shown in [JWT token claims](../active-directory/develop/v1-protocols-oauth-code.md#jwt-token-claims).</span></span> <span data-ttu-id="5034d-193">For reference, see the [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) to sign Client Assertion JWT tokens.</span><span class="sxs-lookup"><span data-stu-id="5034d-193">For reference, see the [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) to sign Client Assertion JWT tokens.</span></span>

<span data-ttu-id="5034d-194">See the [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span><span class="sxs-lookup"><span data-stu-id="5034d-194">See the [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span></span>

<span data-ttu-id="5034d-195">The following example shows a request for code grant token with certificate credential:</span><span class="sxs-lookup"><span data-stu-id="5034d-195">The following example shows a request for code grant token with certificate credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&client_assertion=eyJhbG*****Y9cYo8nEjMyA

<span data-ttu-id="5034d-196">An example response for code grant token:</span><span class="sxs-lookup"><span data-stu-id="5034d-196">An example response for code grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039858","not_before":"1432035958","resource":"https://management.core.windows.net/","access_token":"eyJ0eXAiOiJKV1Q****M7Cw6JWtfY2lGc5A","refresh_token":"AAABAAAAiL9Kn2Z****55j-sjnyYgAA","scope":"user_impersonation","id_token":"eyJ0eXAiOiJKV*****-drP1J3P-HnHi9Rr46kGZnukEBH4dsg"}

#### <a name="handle-code-grant-token-response"></a><span data-ttu-id="5034d-197">Handle code grant token response</span><span class="sxs-lookup"><span data-stu-id="5034d-197">Handle code grant token response</span></span>
<span data-ttu-id="5034d-198">A successful token response contains the (user + app) access token for Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="5034d-198">A successful token response contains the (user + app) access token for Azure Resource Manager.</span></span> <span data-ttu-id="5034d-199">Your application uses this access token to access Resource Manager on behalf of the user.</span><span class="sxs-lookup"><span data-stu-id="5034d-199">Your application uses this access token to access Resource Manager on behalf of the user.</span></span> <span data-ttu-id="5034d-200">The lifetime of access tokens issued by Azure AD is one hour.</span><span class="sxs-lookup"><span data-stu-id="5034d-200">The lifetime of access tokens issued by Azure AD is one hour.</span></span> <span data-ttu-id="5034d-201">It is unlikely that your web application needs to renew the (user + app) access token.</span><span class="sxs-lookup"><span data-stu-id="5034d-201">It is unlikely that your web application needs to renew the (user + app) access token.</span></span> <span data-ttu-id="5034d-202">If it needs to renew the access token, use the refresh token that your application receives in the token response.</span><span class="sxs-lookup"><span data-stu-id="5034d-202">If it needs to renew the access token, use the refresh token that your application receives in the token response.</span></span> <span data-ttu-id="5034d-203">Post an OAuth2.0 Token Request to the Azure AD Token endpoint:</span><span class="sxs-lookup"><span data-stu-id="5034d-203">Post an OAuth2.0 Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="5034d-204">The parameters to use with the refresh request are described in [refreshing the access token](../active-directory/develop/v1-protocols-oauth-code.md#refreshing-the-access-tokens).</span><span class="sxs-lookup"><span data-stu-id="5034d-204">The parameters to use with the refresh request are described in [refreshing the access token](../active-directory/develop/v1-protocols-oauth-code.md#refreshing-the-access-tokens).</span></span>

<span data-ttu-id="5034d-205">The following example shows how to use the refresh token:</span><span class="sxs-lookup"><span data-stu-id="5034d-205">The following example shows how to use the refresh token:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=refresh_token&refresh_token=AAABAAAAiL9Kn2Z****55j-sjnyYgAA&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="5034d-206">Although refresh tokens can be used to get new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span><span class="sxs-lookup"><span data-stu-id="5034d-206">Although refresh tokens can be used to get new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span></span> <span data-ttu-id="5034d-207">The refresh tokens lifetime is limited, and refresh tokens are bound to the user.</span><span class="sxs-lookup"><span data-stu-id="5034d-207">The refresh tokens lifetime is limited, and refresh tokens are bound to the user.</span></span> <span data-ttu-id="5034d-208">If the user leaves the organization, the application using the refresh token loses access.</span><span class="sxs-lookup"><span data-stu-id="5034d-208">If the user leaves the organization, the application using the refresh token loses access.</span></span> <span data-ttu-id="5034d-209">This approach isn't suitable for applications that are used by teams to manage their Azure resources.</span><span class="sxs-lookup"><span data-stu-id="5034d-209">This approach isn't suitable for applications that are used by teams to manage their Azure resources.</span></span>

## <a name="check-if-user-can-assign-access-to-subscription"></a><span data-ttu-id="5034d-210">Check if user can assign access to subscription</span><span class="sxs-lookup"><span data-stu-id="5034d-210">Check if user can assign access to subscription</span></span>
<span data-ttu-id="5034d-211">Your application now has a token to access Azure Resource Manager on behalf of the user.</span><span class="sxs-lookup"><span data-stu-id="5034d-211">Your application now has a token to access Azure Resource Manager on behalf of the user.</span></span> <span data-ttu-id="5034d-212">The next step is to connect your app to the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-212">The next step is to connect your app to the subscription.</span></span> <span data-ttu-id="5034d-213">After connecting, your app can manage those subscriptions even when the user isn't present (long-term offline access).</span><span class="sxs-lookup"><span data-stu-id="5034d-213">After connecting, your app can manage those subscriptions even when the user isn't present (long-term offline access).</span></span>

<span data-ttu-id="5034d-214">For each subscription to connect, call the [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API to determine whether the user has access management rights for the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-214">For each subscription to connect, call the [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API to determine whether the user has access management rights for the subscription.</span></span>

<span data-ttu-id="5034d-215">The [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of the ASP.NET MVC sample app implements this call.</span><span class="sxs-lookup"><span data-stu-id="5034d-215">The [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of the ASP.NET MVC sample app implements this call.</span></span>

<span data-ttu-id="5034d-216">The following example shows how to request a user's permissions on a subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-216">The following example shows how to request a user's permissions on a subscription.</span></span> <span data-ttu-id="5034d-217">83cfe939-2402-4581-b761-4f59b0a041e4 is the ID of the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-217">83cfe939-2402-4581-b761-4f59b0a041e4 is the ID of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/83cfe939-2402-4581-b761-4f59b0a041e4/providers/microsoft.authorization/permissions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiLC***lwO1mM7Cw6JWtfY2lGc5A

<span data-ttu-id="5034d-218">An example of the response to get user's permissions on subscription is:</span><span class="sxs-lookup"><span data-stu-id="5034d-218">An example of the response to get user's permissions on subscription is:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"actions":["*"],"notActions":["Microsoft.Authorization/*/Write","Microsoft.Authorization/*/Delete"]},{"actions":["*/read"],"notActions":[]}]}

<span data-ttu-id="5034d-219">The permissions API returns multiple permissions.</span><span class="sxs-lookup"><span data-stu-id="5034d-219">The permissions API returns multiple permissions.</span></span> <span data-ttu-id="5034d-220">Each permission consists of allowed actions (**actions**) and disallowed actions (**notactions**).</span><span class="sxs-lookup"><span data-stu-id="5034d-220">Each permission consists of allowed actions (**actions**) and disallowed actions (**notactions**).</span></span> <span data-ttu-id="5034d-221">If an action is present in the allowed actions of any permission and not present in the disallowed actions of that permission, the user is allowed to perform that action.</span><span class="sxs-lookup"><span data-stu-id="5034d-221">If an action is present in the allowed actions of any permission and not present in the disallowed actions of that permission, the user is allowed to perform that action.</span></span> <span data-ttu-id="5034d-222">**microsoft.authorization/roleassignments/write** is the action that grants access management rights.</span><span class="sxs-lookup"><span data-stu-id="5034d-222">**microsoft.authorization/roleassignments/write** is the action that grants access management rights.</span></span> <span data-ttu-id="5034d-223">Your application must parse the permissions result to look for a regex match on this action string in the **actions** and **notactions** of each permission.</span><span class="sxs-lookup"><span data-stu-id="5034d-223">Your application must parse the permissions result to look for a regex match on this action string in the **actions** and **notactions** of each permission.</span></span>

## <a name="get-app-only-access-token"></a><span data-ttu-id="5034d-224">Get app-only access token</span><span class="sxs-lookup"><span data-stu-id="5034d-224">Get app-only access token</span></span>
<span data-ttu-id="5034d-225">Now, you know if the user can assign access to the Azure subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-225">Now, you know if the user can assign access to the Azure subscription.</span></span> <span data-ttu-id="5034d-226">The next steps are:</span><span class="sxs-lookup"><span data-stu-id="5034d-226">The next steps are:</span></span>

1. <span data-ttu-id="5034d-227">Assign the appropriate RBAC role to your application's identity on the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-227">Assign the appropriate RBAC role to your application's identity on the subscription.</span></span>
2. <span data-ttu-id="5034d-228">Validate the access assignment by querying for the application's permission on the subscription or by accessing Resource Manager using app-only token.</span><span class="sxs-lookup"><span data-stu-id="5034d-228">Validate the access assignment by querying for the application's permission on the subscription or by accessing Resource Manager using app-only token.</span></span>
3. <span data-ttu-id="5034d-229">Record the connection in your applications "connected subscriptions" data structure - persisting the ID of the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-229">Record the connection in your applications "connected subscriptions" data structure - persisting the ID of the subscription.</span></span>

<span data-ttu-id="5034d-230">Let's look closer at the first step.</span><span class="sxs-lookup"><span data-stu-id="5034d-230">Let's look closer at the first step.</span></span> <span data-ttu-id="5034d-231">To assign the appropriate RBAC role to the application's identity, you must determine:</span><span class="sxs-lookup"><span data-stu-id="5034d-231">To assign the appropriate RBAC role to the application's identity, you must determine:</span></span>

* <span data-ttu-id="5034d-232">The object ID of your application's identity in the user's Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="5034d-232">The object ID of your application's identity in the user's Azure Active Directory</span></span>
* <span data-ttu-id="5034d-233">The identifier of the RBAC role that your application requires on the subscription</span><span class="sxs-lookup"><span data-stu-id="5034d-233">The identifier of the RBAC role that your application requires on the subscription</span></span>

<span data-ttu-id="5034d-234">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5034d-234">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span></span> <span data-ttu-id="5034d-235">Azure allows RBAC roles to be assigned to service principals to grant direct access to corresponding applications on Azure resources.</span><span class="sxs-lookup"><span data-stu-id="5034d-235">Azure allows RBAC roles to be assigned to service principals to grant direct access to corresponding applications on Azure resources.</span></span> <span data-ttu-id="5034d-236">This action is exactly what you wish to do.</span><span class="sxs-lookup"><span data-stu-id="5034d-236">This action is exactly what you wish to do.</span></span> <span data-ttu-id="5034d-237">Query the Azure AD Graph API to determine the identifier of the service principal of your application in the signed-in user's Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5034d-237">Query the Azure AD Graph API to determine the identifier of the service principal of your application in the signed-in user's Azure AD.</span></span>

<span data-ttu-id="5034d-238">You only have an access token for Azure Resource Manager - you need a new access token to call the Azure AD Graph API.</span><span class="sxs-lookup"><span data-stu-id="5034d-238">You only have an access token for Azure Resource Manager - you need a new access token to call the Azure AD Graph API.</span></span> <span data-ttu-id="5034d-239">Every application in Azure AD has permission to query its own service principal object, so an app-only access token is sufficient.</span><span class="sxs-lookup"><span data-stu-id="5034d-239">Every application in Azure AD has permission to query its own service principal object, so an app-only access token is sufficient.</span></span>

<a id="app-azure-ad-graph" />

### <a name="get-app-only-access-token-for-azure-ad-graph-api"></a><span data-ttu-id="5034d-240">Get app-only access token for Azure AD Graph API</span><span class="sxs-lookup"><span data-stu-id="5034d-240">Get app-only access token for Azure AD Graph API</span></span>
<span data-ttu-id="5034d-241">To authenticate your app and get a token to Azure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request to Azure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span><span class="sxs-lookup"><span data-stu-id="5034d-241">To authenticate your app and get a token to Azure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request to Azure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span></span>

<span data-ttu-id="5034d-242">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of the ASP.net MVC sample application gets an app-only access token for Graph API using the Active Directory Authentication Library for .NET.</span><span class="sxs-lookup"><span data-stu-id="5034d-242">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of the ASP.net MVC sample application gets an app-only access token for Graph API using the Active Directory Authentication Library for .NET.</span></span>

<span data-ttu-id="5034d-243">The query string parameters that are available for this request are described in the [Request an Access Token](../active-directory/develop/v1-oauth2-client-creds-grant-flow.md#request-an-access-token) article.</span><span class="sxs-lookup"><span data-stu-id="5034d-243">The query string parameters that are available for this request are described in the [Request an Access Token](../active-directory/develop/v1-oauth2-client-creds-grant-flow.md#request-an-access-token) article.</span></span>

<span data-ttu-id="5034d-244">An example request for client credential grant token:</span><span class="sxs-lookup"><span data-stu-id="5034d-244">An example request for client credential grant token:</span></span>

    POST https://login.microsoftonline.com/62e173e9-301e-423e-bcd4-29121ec1aa24/oauth2/token HTTP/1.1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 187</pre>
    <pre>grant_type=client_credentials&client_id=a0448380-c346-4f9f-b897-c18733de9394&resource=https%3A%2F%2Fgraph.windows.net%2F &client_secret=olna8C*****Og%3D

<span data-ttu-id="5034d-245">An example response for client credential grant token:</span><span class="sxs-lookup"><span data-stu-id="5034d-245">An example response for client credential grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039862","not_before":"1432035962","resource":"https://graph.windows.net/","access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRv****G5gUTV-kKorR-pg"}

### <a name="get-objectid-of-application-service-principal-in-user-azure-ad"></a><span data-ttu-id="5034d-246">Get ObjectId of application service principal in user Azure AD</span><span class="sxs-lookup"><span data-stu-id="5034d-246">Get ObjectId of application service principal in user Azure AD</span></span>
<span data-ttu-id="5034d-247">Now, use the app-only access token to query the [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API to determine the Object ID of the application's service principal in the directory.</span><span class="sxs-lookup"><span data-stu-id="5034d-247">Now, use the app-only access token to query the [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API to determine the Object ID of the application's service principal in the directory.</span></span>

<span data-ttu-id="5034d-248">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of the ASP.net MVC sample application implements this call.</span><span class="sxs-lookup"><span data-stu-id="5034d-248">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of the ASP.net MVC sample application implements this call.</span></span>

<span data-ttu-id="5034d-249">The following example shows how to request an application's service principal.</span><span class="sxs-lookup"><span data-stu-id="5034d-249">The following example shows how to request an application's service principal.</span></span> <span data-ttu-id="5034d-250">a0448380-c346-4f9f-b897-c18733de9394 is the client ID of the application.</span><span class="sxs-lookup"><span data-stu-id="5034d-250">a0448380-c346-4f9f-b897-c18733de9394 is the client ID of the application.</span></span>

    GET https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/servicePrincipals?api-version=1.5&$filter=appId%20eq%20'a0448380-c346-4f9f-b897-c18733de9394' HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJK*****-kKorR-pg

<span data-ttu-id="5034d-251">The following example shows a response to the request for an application's service principal</span><span class="sxs-lookup"><span data-stu-id="5034d-251">The following example shows a response to the request for an application's service principal</span></span>

    HTTP/1.1 200 OK

    {"odata.metadata":"https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/$metadata#directoryObjects/Microsoft.DirectoryServices.ServicePrincipal","value":[{"odata.type":"Microsoft.DirectoryServices.ServicePrincipal","objectType":"ServicePrincipal","objectId":"9b5018d4-6951-42ed-8a92-f11ec283ccec","deletionTimestamp":null,"accountEnabled":true,"appDisplayName":"CloudSense","appId":"a0448380-c346-4f9f-b897-c18733de9394","appOwnerTenantId":"62e173e9-301e-423e-bcd4-29121ec1aa24","appRoleAssignmentRequired":false,"appRoles":[],"displayName":"CloudSense","errorUrl":null,"homepage":"http://www.vipswapper.com/cloudsense","keyCredentials":[],"logoutUrl":null,"oauth2Permissions":[{"adminConsentDescription":"Allow the application to access CloudSense on behalf of the signed-in user.","adminConsentDisplayName":"Access CloudSense","id":"b7b7338e-683a-4796-b95e-60c10380de1c","isEnabled":true,"type":"User","userConsentDescription":"Allow the application to access CloudSense on your behalf.","userConsentDisplayName":"Access CloudSense","value":"user_impersonation"}],"passwordCredentials":[],"preferredTokenSigningKeyThumbprint":null,"publisherName":"vipswapper"quot;,"replyUrls":["http://www.vipswapper.com/cloudsense","http://www.vipswapper.com","http://vipswapper.com","http://vipswapper.azurewebsites.net","http://localhost:62080"],"samlMetadataUrl":null,"servicePrincipalNames":["http://www.vipswapper.com/cloudsense","a0448380-c346-4f9f-b897-c18733de9394"],"tags":["WindowsAzureActiveDirectoryIntegratedApp"]}]}

### <a name="get-azure-rbac-role-identifier"></a><span data-ttu-id="5034d-252">Get Azure RBAC role identifier</span><span class="sxs-lookup"><span data-stu-id="5034d-252">Get Azure RBAC role identifier</span></span>
<span data-ttu-id="5034d-253">To assign the appropriate RBAC role to your service principal, you must determine the identifier of the Azure RBAC role.</span><span class="sxs-lookup"><span data-stu-id="5034d-253">To assign the appropriate RBAC role to your service principal, you must determine the identifier of the Azure RBAC role.</span></span>

<span data-ttu-id="5034d-254">The right RBAC role for your application:</span><span class="sxs-lookup"><span data-stu-id="5034d-254">The right RBAC role for your application:</span></span>

* <span data-ttu-id="5034d-255">If your application only monitors the subscription, without making any changes, it requires only reader permissions on the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-255">If your application only monitors the subscription, without making any changes, it requires only reader permissions on the subscription.</span></span> <span data-ttu-id="5034d-256">Assign the **Reader** role.</span><span class="sxs-lookup"><span data-stu-id="5034d-256">Assign the **Reader** role.</span></span>
* <span data-ttu-id="5034d-257">If your application manages Azure the subscription, creating/modifying/deleting entities, it requires one of the contributor permissions.</span><span class="sxs-lookup"><span data-stu-id="5034d-257">If your application manages Azure the subscription, creating/modifying/deleting entities, it requires one of the contributor permissions.</span></span>
  * <span data-ttu-id="5034d-258">To manage a particular type of resource, assign the resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span><span class="sxs-lookup"><span data-stu-id="5034d-258">To manage a particular type of resource, assign the resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span></span>
  * <span data-ttu-id="5034d-259">To manage any resource type, assign the **Contributor** role.</span><span class="sxs-lookup"><span data-stu-id="5034d-259">To manage any resource type, assign the **Contributor** role.</span></span>

<span data-ttu-id="5034d-260">The role assignment for your application is visible to users, so select the least-required privilege.</span><span class="sxs-lookup"><span data-stu-id="5034d-260">The role assignment for your application is visible to users, so select the least-required privilege.</span></span>

<span data-ttu-id="5034d-261">Call the [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) to list all Azure RBAC roles and search then iterate over the result to find the desired role definition by name.</span><span class="sxs-lookup"><span data-stu-id="5034d-261">Call the [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) to list all Azure RBAC roles and search then iterate over the result to find the desired role definition by name.</span></span>

<span data-ttu-id="5034d-262">The [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of the ASP.net MVC sample app implements this call.</span><span class="sxs-lookup"><span data-stu-id="5034d-262">The [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="5034d-263">The following request example shows how to get Azure RBAC role identifier.</span><span class="sxs-lookup"><span data-stu-id="5034d-263">The following request example shows how to get Azure RBAC role identifier.</span></span> <span data-ttu-id="5034d-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb is the ID of the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb is the ID of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV*****fY2lGc5

<span data-ttu-id="5034d-265">The response is in the following format:</span><span class="sxs-lookup"><span data-stu-id="5034d-265">The response is in the following format:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"properties":{"roleName":"API Management Service Contributor","type":"BuiltInRole","description":"Lets you manage API Management services, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.ApiManagement/Services/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/312a565d-c81f-4fd8-895a-4e21e48d571c","type":"Microsoft.Authorization/roleDefinitions","name":"312a565d-c81f-4fd8-895a-4e21e48d571c"},{"properties":{"roleName":"Application Insights Component Contributor","type":"BuiltInRole","description":"Lets you manage Application Insights components, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.Insights/components/*","Microsoft.Insights/webtests/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/ae349356-3a1b-4a5e-921d-050484c6347e","type":"Microsoft.Authorization/roleDefinitions","name":"ae349356-3a1b-4a5e-921d-050484c6347e"}]}

<span data-ttu-id="5034d-266">You do not need to call this API on an ongoing basis.</span><span class="sxs-lookup"><span data-stu-id="5034d-266">You do not need to call this API on an ongoing basis.</span></span> <span data-ttu-id="5034d-267">Once you've determined the well-known GUID of the role definition, you can construct the role definition ID as:</span><span class="sxs-lookup"><span data-stu-id="5034d-267">Once you've determined the well-known GUID of the role definition, you can construct the role definition ID as:</span></span>

    /subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{well-known-role-guid}

<span data-ttu-id="5034d-268">Here are the identifiers of commonly used built-in roles:</span><span class="sxs-lookup"><span data-stu-id="5034d-268">Here are the identifiers of commonly used built-in roles:</span></span>

| <span data-ttu-id="5034d-269">Role</span><span class="sxs-lookup"><span data-stu-id="5034d-269">Role</span></span> | <span data-ttu-id="5034d-270">GUID</span><span class="sxs-lookup"><span data-stu-id="5034d-270">GUID</span></span> |
| --- | --- |
| <span data-ttu-id="5034d-271">Reader</span><span class="sxs-lookup"><span data-stu-id="5034d-271">Reader</span></span> |<span data-ttu-id="5034d-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="5034d-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |
| <span data-ttu-id="5034d-273">Contributor</span><span class="sxs-lookup"><span data-stu-id="5034d-273">Contributor</span></span> |<span data-ttu-id="5034d-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span><span class="sxs-lookup"><span data-stu-id="5034d-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span></span> |
| <span data-ttu-id="5034d-275">Virtual Machine Contributor</span><span class="sxs-lookup"><span data-stu-id="5034d-275">Virtual Machine Contributor</span></span> |<span data-ttu-id="5034d-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span><span class="sxs-lookup"><span data-stu-id="5034d-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span></span> |
| <span data-ttu-id="5034d-277">Virtual Network Contributor</span><span class="sxs-lookup"><span data-stu-id="5034d-277">Virtual Network Contributor</span></span> |<span data-ttu-id="5034d-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span><span class="sxs-lookup"><span data-stu-id="5034d-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span></span> |
| <span data-ttu-id="5034d-279">Storage Account Contributor</span><span class="sxs-lookup"><span data-stu-id="5034d-279">Storage Account Contributor</span></span> |<span data-ttu-id="5034d-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span><span class="sxs-lookup"><span data-stu-id="5034d-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span></span> |
| <span data-ttu-id="5034d-281">Website Contributor</span><span class="sxs-lookup"><span data-stu-id="5034d-281">Website Contributor</span></span> |<span data-ttu-id="5034d-282">de139f84-1756-47ae-9be6-808fbbe84772</span><span class="sxs-lookup"><span data-stu-id="5034d-282">de139f84-1756-47ae-9be6-808fbbe84772</span></span> |
| <span data-ttu-id="5034d-283">Web Plan Contributor</span><span class="sxs-lookup"><span data-stu-id="5034d-283">Web Plan Contributor</span></span> |<span data-ttu-id="5034d-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span><span class="sxs-lookup"><span data-stu-id="5034d-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span></span> |
| <span data-ttu-id="5034d-285">SQL Server Contributor</span><span class="sxs-lookup"><span data-stu-id="5034d-285">SQL Server Contributor</span></span> |<span data-ttu-id="5034d-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span><span class="sxs-lookup"><span data-stu-id="5034d-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span></span> |
| <span data-ttu-id="5034d-287">SQL DB Contributor</span><span class="sxs-lookup"><span data-stu-id="5034d-287">SQL DB Contributor</span></span> |<span data-ttu-id="5034d-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span><span class="sxs-lookup"><span data-stu-id="5034d-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span></span> |

### <a name="assign-rbac-role-to-application"></a><span data-ttu-id="5034d-289">Assign RBAC role to application</span><span class="sxs-lookup"><span data-stu-id="5034d-289">Assign RBAC role to application</span></span>
<span data-ttu-id="5034d-290">You have everything you need to assign the appropriate RBAC role to your service principal by using the [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span><span class="sxs-lookup"><span data-stu-id="5034d-290">You have everything you need to assign the appropriate RBAC role to your service principal by using the [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span></span>

<span data-ttu-id="5034d-291">The [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of the ASP.net MVC sample app implements this call.</span><span class="sxs-lookup"><span data-stu-id="5034d-291">The [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="5034d-292">An example request to assign RBAC role to application:</span><span class="sxs-lookup"><span data-stu-id="5034d-292">An example request to assign RBAC role to application:</span></span>

    PUT https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/microsoft.authorization/roleassignments/4f87261d-2816-465d-8311-70a27558df4c?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiL*****FlwO1mM7Cw6JWtfY2lGc5
    Content-Type: application/json
    Content-Length: 230

    {"properties": {"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2"}}

<span data-ttu-id="5034d-293">In the request, the following values are used:</span><span class="sxs-lookup"><span data-stu-id="5034d-293">In the request, the following values are used:</span></span>

| <span data-ttu-id="5034d-294">Guid</span><span class="sxs-lookup"><span data-stu-id="5034d-294">Guid</span></span> | <span data-ttu-id="5034d-295">Description</span><span class="sxs-lookup"><span data-stu-id="5034d-295">Description</span></span> |
| --- | --- |
| <span data-ttu-id="5034d-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span><span class="sxs-lookup"><span data-stu-id="5034d-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span></span> |<span data-ttu-id="5034d-297">the ID of the subscription</span><span class="sxs-lookup"><span data-stu-id="5034d-297">the ID of the subscription</span></span> |
| <span data-ttu-id="5034d-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span><span class="sxs-lookup"><span data-stu-id="5034d-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span></span> |<span data-ttu-id="5034d-299">the object ID of the service principal of the application</span><span class="sxs-lookup"><span data-stu-id="5034d-299">the object ID of the service principal of the application</span></span> |
| <span data-ttu-id="5034d-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="5034d-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |<span data-ttu-id="5034d-301">the ID of the reader role</span><span class="sxs-lookup"><span data-stu-id="5034d-301">the ID of the reader role</span></span> |
| <span data-ttu-id="5034d-302">4f87261d-2816-465d-8311-70a27558df4c</span><span class="sxs-lookup"><span data-stu-id="5034d-302">4f87261d-2816-465d-8311-70a27558df4c</span></span> |<span data-ttu-id="5034d-303">a new guid created for the new role assignment</span><span class="sxs-lookup"><span data-stu-id="5034d-303">a new guid created for the new role assignment</span></span> |

<span data-ttu-id="5034d-304">The response is in the following format:</span><span class="sxs-lookup"><span data-stu-id="5034d-304">The response is in the following format:</span></span>

    HTTP/1.1 201 Created

    {"properties":{"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2","scope":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb"},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleAssignments/4f87261d-2816-465d-8311-70a27558df4c","type":"Microsoft.Authorization/roleAssignments","name":"4f87261d-2816-465d-8311-70a27558df4c"}

### <a name="get-app-only-access-token-for-azure-resource-manager"></a><span data-ttu-id="5034d-305">Get app-only access token for Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="5034d-305">Get app-only access token for Azure Resource Manager</span></span>
<span data-ttu-id="5034d-306">To validate that app has the desired access on the subscription, perform a test task on the subscription using an app-only token.</span><span class="sxs-lookup"><span data-stu-id="5034d-306">To validate that app has the desired access on the subscription, perform a test task on the subscription using an app-only token.</span></span>

<span data-ttu-id="5034d-307">To get an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for the resource parameter:</span><span class="sxs-lookup"><span data-stu-id="5034d-307">To get an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for the resource parameter:</span></span>

    https://management.core.windows.net/

<span data-ttu-id="5034d-308">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using the Active Directory Authentication Library for .net.</span><span class="sxs-lookup"><span data-stu-id="5034d-308">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using the Active Directory Authentication Library for .net.</span></span>

#### <a name="get-applications-permissions-on-subscription"></a><span data-ttu-id="5034d-309">Get Application's Permissions on Subscription</span><span class="sxs-lookup"><span data-stu-id="5034d-309">Get Application's Permissions on Subscription</span></span>
<span data-ttu-id="5034d-310">To check that your application has the desired access on an Azure subscription, you may also call the [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span><span class="sxs-lookup"><span data-stu-id="5034d-310">To check that your application has the desired access on an Azure subscription, you may also call the [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span></span> <span data-ttu-id="5034d-311">This approach is similar to how you determined whether the user has Access Management rights for the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-311">This approach is similar to how you determined whether the user has Access Management rights for the subscription.</span></span> <span data-ttu-id="5034d-312">However, this time, call the permissions API with the app-only access token that you received in the previous step.</span><span class="sxs-lookup"><span data-stu-id="5034d-312">However, this time, call the permissions API with the app-only access token that you received in the previous step.</span></span>

<span data-ttu-id="5034d-313">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample app implements this call.</span><span class="sxs-lookup"><span data-stu-id="5034d-313">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample app implements this call.</span></span>

## <a name="manage-connected-subscriptions"></a><span data-ttu-id="5034d-314">Manage connected subscriptions</span><span class="sxs-lookup"><span data-stu-id="5034d-314">Manage connected subscriptions</span></span>
<span data-ttu-id="5034d-315">When the appropriate RBAC role is assigned to your application's service principal on the subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="5034d-315">When the appropriate RBAC role is assigned to your application's service principal on the subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span></span>

<span data-ttu-id="5034d-316">If a subscription owner removes your application's role assignment using the portal or command-line tools, your application is no longer able to access that subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-316">If a subscription owner removes your application's role assignment using the portal or command-line tools, your application is no longer able to access that subscription.</span></span> <span data-ttu-id="5034d-317">In that case, you should notify the user that the connection with the subscription was severed from outside the application and give them an option to "repair" the connection.</span><span class="sxs-lookup"><span data-stu-id="5034d-317">In that case, you should notify the user that the connection with the subscription was severed from outside the application and give them an option to "repair" the connection.</span></span> <span data-ttu-id="5034d-318">"Repair" would re-create the role assignment that was deleted offline.</span><span class="sxs-lookup"><span data-stu-id="5034d-318">"Repair" would re-create the role assignment that was deleted offline.</span></span>

<span data-ttu-id="5034d-319">Just as you enabled the user to connect subscriptions to your application, you must allow the user to disconnect subscriptions too.</span><span class="sxs-lookup"><span data-stu-id="5034d-319">Just as you enabled the user to connect subscriptions to your application, you must allow the user to disconnect subscriptions too.</span></span> <span data-ttu-id="5034d-320">From an access management point of view, disconnect means removing the role assignment that the application's service principal has on the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-320">From an access management point of view, disconnect means removing the role assignment that the application's service principal has on the subscription.</span></span> <span data-ttu-id="5034d-321">Optionally, any state in the application for the subscription might be removed too.</span><span class="sxs-lookup"><span data-stu-id="5034d-321">Optionally, any state in the application for the subscription might be removed too.</span></span>
<span data-ttu-id="5034d-322">Only users with access management permission on the subscription are able to disconnect the subscription.</span><span class="sxs-lookup"><span data-stu-id="5034d-322">Only users with access management permission on the subscription are able to disconnect the subscription.</span></span>

<span data-ttu-id="5034d-323">The [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of the ASP.net MVC sample app implements this call.</span><span class="sxs-lookup"><span data-stu-id="5034d-323">The [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="5034d-324">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span><span class="sxs-lookup"><span data-stu-id="5034d-324">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span></span>
