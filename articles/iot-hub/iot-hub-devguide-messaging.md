---
title: Understand Azure IoT Hub messaging | Microsoft Docs
description: Developer guide - device-to-cloud and cloud-to-device messaging with IoT Hub. Includes information about message formats and supported communications protocols.
services: iot-hub
documentationcenter: .net
author: dominicbetts
manager: timlt
editor: ''
ms.assetid: 3fc5f1a3-3711-4611-9897-d4db079b4250
ms.service: iot-hub
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 01/31/2017
ms.author: dobett
ms.openlocfilehash: 2e6186985bc0a22191d73d1637ace2bdcc92b46a
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44564158"
---
# <a name="send-and-receive-messages-with-iot-hub"></a><span data-ttu-id="46e2c-104">Send and receive messages with IoT Hub</span><span class="sxs-lookup"><span data-stu-id="46e2c-104">Send and receive messages with IoT Hub</span></span>
## <a name="overview"></a><span data-ttu-id="46e2c-105">Overview</span><span class="sxs-lookup"><span data-stu-id="46e2c-105">Overview</span></span>
<span data-ttu-id="46e2c-106">IoT Hub provides the following messaging primitives to communicate with a device:</span><span class="sxs-lookup"><span data-stu-id="46e2c-106">IoT Hub provides the following messaging primitives to communicate with a device:</span></span>

* <span data-ttu-id="46e2c-107">[Device-to-cloud][lnk-d2c] from a device to a back-end app.</span><span class="sxs-lookup"><span data-stu-id="46e2c-107">[Device-to-cloud][lnk-d2c] from a device to a back-end app.</span></span>
* <span data-ttu-id="46e2c-108">[Cloud-to-device][lnk-c2d] from a back-end app (*service* or *cloud*).</span><span class="sxs-lookup"><span data-stu-id="46e2c-108">[Cloud-to-device][lnk-c2d] from a back-end app (*service* or *cloud*).</span></span>

<span data-ttu-id="46e2c-109">Core properties of IoT Hub messaging functionality are the reliability and durability of messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-109">Core properties of IoT Hub messaging functionality are the reliability and durability of messages.</span></span> <span data-ttu-id="46e2c-110">These properties enable resilience to intermittent connectivity on the device side, and to load spikes in event processing on the cloud side.</span><span class="sxs-lookup"><span data-stu-id="46e2c-110">These properties enable resilience to intermittent connectivity on the device side, and to load spikes in event processing on the cloud side.</span></span> <span data-ttu-id="46e2c-111">IoT Hub implements *at least once* delivery guarantees for both device-to-cloud and cloud-to-device messaging.</span><span class="sxs-lookup"><span data-stu-id="46e2c-111">IoT Hub implements *at least once* delivery guarantees for both device-to-cloud and cloud-to-device messaging.</span></span>

<span data-ttu-id="46e2c-112">IoT Hub supports multiple [device-facing protocols][lnk-protocols] (such as MQTT, AMQP, and HTTP).</span><span class="sxs-lookup"><span data-stu-id="46e2c-112">IoT Hub supports multiple [device-facing protocols][lnk-protocols] (such as MQTT, AMQP, and HTTP).</span></span> <span data-ttu-id="46e2c-113">To support seamless interoperability across protocols, IoT Hub defines a [common message format][lnk-message-format] that all device-facing protocols support.</span><span class="sxs-lookup"><span data-stu-id="46e2c-113">To support seamless interoperability across protocols, IoT Hub defines a [common message format][lnk-message-format] that all device-facing protocols support.</span></span>

<span data-ttu-id="46e2c-114">IoT Hub exposes a built-in [Event Hub-compatible endpoint][lnk-compatible-endpoint] to enable back-end apps to read the device-to-cloud messages received by the hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-114">IoT Hub exposes a built-in [Event Hub-compatible endpoint][lnk-compatible-endpoint] to enable back-end apps to read the device-to-cloud messages received by the hub.</span></span> <span data-ttu-id="46e2c-115">You can also create custom endpoints in your IoT hub by linking other services in your subscription to the hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-115">You can also create custom endpoints in your IoT hub by linking other services in your subscription to the hub.</span></span>

### <a name="when-to-use"></a><span data-ttu-id="46e2c-116">When to use</span><span class="sxs-lookup"><span data-stu-id="46e2c-116">When to use</span></span>
<span data-ttu-id="46e2c-117">Use device-to-cloud messages for sending time series telemetry and alerts from your device app, and cloud-to-device messages for one-way notifications to the device app.</span><span class="sxs-lookup"><span data-stu-id="46e2c-117">Use device-to-cloud messages for sending time series telemetry and alerts from your device app, and cloud-to-device messages for one-way notifications to the device app.</span></span>

<span data-ttu-id="46e2c-118">Refer to [Device-to-cloud communication guidance][lnk-d2c-guidance] if in doubt between using reported properties, device-to-cloud messages, or file upload.</span><span class="sxs-lookup"><span data-stu-id="46e2c-118">Refer to [Device-to-cloud communication guidance][lnk-d2c-guidance] if in doubt between using reported properties, device-to-cloud messages, or file upload.</span></span>
<span data-ttu-id="46e2c-119">Refer to [Cloud-to-device communication guidance][lnk-c2d-guidance] if in doubt between using desired properties, direct methods, or cloud-to-device messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-119">Refer to [Cloud-to-device communication guidance][lnk-c2d-guidance] if in doubt between using desired properties, direct methods, or cloud-to-device messages.</span></span>

<span data-ttu-id="46e2c-120">For a comparison of the IoT Hub and Event Hubs services, see [Comparison of IoT Hub and Event Hubs][lnk-compare].</span><span class="sxs-lookup"><span data-stu-id="46e2c-120">For a comparison of the IoT Hub and Event Hubs services, see [Comparison of IoT Hub and Event Hubs][lnk-compare].</span></span>

## <a name="device-to-cloud-messages"></a><span data-ttu-id="46e2c-121">Device-to-cloud messages</span><span class="sxs-lookup"><span data-stu-id="46e2c-121">Device-to-cloud messages</span></span>
<span data-ttu-id="46e2c-122">You send device-to-cloud messages through a device-facing endpoint (**/devices/{deviceId}/messages/events**).</span><span class="sxs-lookup"><span data-stu-id="46e2c-122">You send device-to-cloud messages through a device-facing endpoint (**/devices/{deviceId}/messages/events**).</span></span> <span data-ttu-id="46e2c-123">Routing rules then route your messages to one of the service-facing endpoints on your IoT hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-123">Routing rules then route your messages to one of the service-facing endpoints on your IoT hub.</span></span> <span data-ttu-id="46e2c-124">Routing rules use the properties of the device-to-cloud messages flowing through your hub to determine where to route them.</span><span class="sxs-lookup"><span data-stu-id="46e2c-124">Routing rules use the properties of the device-to-cloud messages flowing through your hub to determine where to route them.</span></span> <span data-ttu-id="46e2c-125">By default, messages are routed to the built-in service-facing endpoint (messages/events), that is compatible with [Event Hubs][lnk-event-hubs].</span><span class="sxs-lookup"><span data-stu-id="46e2c-125">By default, messages are routed to the built-in service-facing endpoint (messages/events), that is compatible with [Event Hubs][lnk-event-hubs].</span></span> <span data-ttu-id="46e2c-126">Therefore, you can use standard [Event Hubs integration and SDKs][lnk-compatible-endpoint] to receive device-to-cloud messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-126">Therefore, you can use standard [Event Hubs integration and SDKs][lnk-compatible-endpoint] to receive device-to-cloud messages.</span></span>

<span data-ttu-id="46e2c-127">IoT Hub implements device-to-cloud messaging using a streaming messaging pattern.</span><span class="sxs-lookup"><span data-stu-id="46e2c-127">IoT Hub implements device-to-cloud messaging using a streaming messaging pattern.</span></span> <span data-ttu-id="46e2c-128">IoT Hub's device-to-cloud messages are more like [Event Hubs][lnk-event-hubs] *events* than [Service Bus][lnk-servicebus] *messages* in that there is a high volume of events passing through the service that can be read by multiple readers.</span><span class="sxs-lookup"><span data-stu-id="46e2c-128">IoT Hub's device-to-cloud messages are more like [Event Hubs][lnk-event-hubs] *events* than [Service Bus][lnk-servicebus] *messages* in that there is a high volume of events passing through the service that can be read by multiple readers.</span></span>

<span data-ttu-id="46e2c-129">This implementation has the following implications:</span><span class="sxs-lookup"><span data-stu-id="46e2c-129">This implementation has the following implications:</span></span>

* <span data-ttu-id="46e2c-130">Like Event Hubs events, device-to-cloud messages are durable and retained in an IoT hub's default **messages/events** endpoint for up to seven days.</span><span class="sxs-lookup"><span data-stu-id="46e2c-130">Like Event Hubs events, device-to-cloud messages are durable and retained in an IoT hub's default **messages/events** endpoint for up to seven days.</span></span>
* <span data-ttu-id="46e2c-131">Like Event Hubs events, device-to-cloud messages can be at most 256 KB, and can be grouped in batches to optimize sends.</span><span class="sxs-lookup"><span data-stu-id="46e2c-131">Like Event Hubs events, device-to-cloud messages can be at most 256 KB, and can be grouped in batches to optimize sends.</span></span> <span data-ttu-id="46e2c-132">Batches can be at most 256 KB.</span><span class="sxs-lookup"><span data-stu-id="46e2c-132">Batches can be at most 256 KB.</span></span>

<span data-ttu-id="46e2c-133">There are, however, a few important distinctions between IoT Hub device-to-cloud messaging and Event Hubs:</span><span class="sxs-lookup"><span data-stu-id="46e2c-133">There are, however, a few important distinctions between IoT Hub device-to-cloud messaging and Event Hubs:</span></span>

* <span data-ttu-id="46e2c-134">As explained in the [Control access to IoT Hub][lnk-devguide-security] section, IoT Hub allows per-device authentication and access control.</span><span class="sxs-lookup"><span data-stu-id="46e2c-134">As explained in the [Control access to IoT Hub][lnk-devguide-security] section, IoT Hub allows per-device authentication and access control.</span></span>
* <span data-ttu-id="46e2c-135">IoT Hub allows you to create up to 10 custom endpoints.</span><span class="sxs-lookup"><span data-stu-id="46e2c-135">IoT Hub allows you to create up to 10 custom endpoints.</span></span> <span data-ttu-id="46e2c-136">Messages are delivered to the endpoints based on routes configured on your IoT hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-136">Messages are delivered to the endpoints based on routes configured on your IoT hub.</span></span>
* <span data-ttu-id="46e2c-137">IoT Hub allows millions of simultaneously connected devices (see [Quotas and throttling][lnk-quotas]), while Event Hubs is limited to 5000 AMQP connections per namespace.</span><span class="sxs-lookup"><span data-stu-id="46e2c-137">IoT Hub allows millions of simultaneously connected devices (see [Quotas and throttling][lnk-quotas]), while Event Hubs is limited to 5000 AMQP connections per namespace.</span></span>
* <span data-ttu-id="46e2c-138">IoT Hub does not allow arbitrary partitioning using a **PartitionKey**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-138">IoT Hub does not allow arbitrary partitioning using a **PartitionKey**.</span></span> <span data-ttu-id="46e2c-139">Device-to-cloud messages are partitioned based on their originating **deviceId**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-139">Device-to-cloud messages are partitioned based on their originating **deviceId**.</span></span>
* <span data-ttu-id="46e2c-140">Scaling IoT Hub is slightly different than scaling Event Hubs.</span><span class="sxs-lookup"><span data-stu-id="46e2c-140">Scaling IoT Hub is slightly different than scaling Event Hubs.</span></span> <span data-ttu-id="46e2c-141">For more information, see [Scaling IoT Hub][lnk-guidance-scale].</span><span class="sxs-lookup"><span data-stu-id="46e2c-141">For more information, see [Scaling IoT Hub][lnk-guidance-scale].</span></span>

<span data-ttu-id="46e2c-142">For details about how to use device-to-cloud messaging, see [Azure IoT SDKs][lnk-sdks].</span><span class="sxs-lookup"><span data-stu-id="46e2c-142">For details about how to use device-to-cloud messaging, see [Azure IoT SDKs][lnk-sdks].</span></span>

<span data-ttu-id="46e2c-143">For details about how to set up message routing, see [Routing rules](#routing-rules).</span><span class="sxs-lookup"><span data-stu-id="46e2c-143">For details about how to set up message routing, see [Routing rules](#routing-rules).</span></span>

> [!NOTE]
> <span data-ttu-id="46e2c-144">When using HTTP to send device-to-cloud messages, property names and values can only contain ASCII alphanumeric characters, plus ``{'!', '#', '$', '%, '&', "'", '*', '*', '+', '-', '.', '^', '_', '`', '|', '~'}``.</span><span class="sxs-lookup"><span data-stu-id="46e2c-144">When using HTTP to send device-to-cloud messages, property names and values can only contain ASCII alphanumeric characters, plus ``{'!', '#', '$', '%, '&', "'", '*', '*', '+', '-', '.', '^', '_', '`', '|', '~'}``.</span></span>
> 
> 

### <a name="non-telemetry-traffic"></a><span data-ttu-id="46e2c-145">Non-telemetry traffic</span><span class="sxs-lookup"><span data-stu-id="46e2c-145">Non-telemetry traffic</span></span>
<span data-ttu-id="46e2c-146">Often, in addition to telemetry data points, devices send messages and requests that require separate execution and handling from the application business logic layer.</span><span class="sxs-lookup"><span data-stu-id="46e2c-146">Often, in addition to telemetry data points, devices send messages and requests that require separate execution and handling from the application business logic layer.</span></span> <span data-ttu-id="46e2c-147">For example, critical alerts that must trigger a specific action in the back end.</span><span class="sxs-lookup"><span data-stu-id="46e2c-147">For example, critical alerts that must trigger a specific action in the back end.</span></span> <span data-ttu-id="46e2c-148">You can easily write a routing rule to send these types of messages to an endpoint dedicated to their processing.</span><span class="sxs-lookup"><span data-stu-id="46e2c-148">You can easily write a routing rule to send these types of messages to an endpoint dedicated to their processing.</span></span>

<span data-ttu-id="46e2c-149">For more information about the best way to process this kind of message, see the [Tutorial: How to process IoT Hub device-to-cloud messages][lnk-d2c-tutorial] tutorial.</span><span class="sxs-lookup"><span data-stu-id="46e2c-149">For more information about the best way to process this kind of message, see the [Tutorial: How to process IoT Hub device-to-cloud messages][lnk-d2c-tutorial] tutorial.</span></span>

### <a name="routing-rules"></a><span data-ttu-id="46e2c-150">Routing rules</span><span class="sxs-lookup"><span data-stu-id="46e2c-150">Routing rules</span></span>

<span data-ttu-id="46e2c-151">IoT Hub enables you to route messages to IoT Hub endpoints based on message properties.</span><span class="sxs-lookup"><span data-stu-id="46e2c-151">IoT Hub enables you to route messages to IoT Hub endpoints based on message properties.</span></span> <span data-ttu-id="46e2c-152">Routing rules give you the flexibility to send messages where they need to go without the need to stand up additional services to process messages or to write additional code.</span><span class="sxs-lookup"><span data-stu-id="46e2c-152">Routing rules give you the flexibility to send messages where they need to go without the need to stand up additional services to process messages or to write additional code.</span></span> <span data-ttu-id="46e2c-153">Each routing rule you configure has the following properties:</span><span class="sxs-lookup"><span data-stu-id="46e2c-153">Each routing rule you configure has the following properties:</span></span>

* <span data-ttu-id="46e2c-154">**Name**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-154">**Name**.</span></span> <span data-ttu-id="46e2c-155">The unique name that identifies the rule.</span><span class="sxs-lookup"><span data-stu-id="46e2c-155">The unique name that identifies the rule.</span></span>
* <span data-ttu-id="46e2c-156">**Source**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-156">**Source**.</span></span> <span data-ttu-id="46e2c-157">The origin of the data stream to be acted upon.</span><span class="sxs-lookup"><span data-stu-id="46e2c-157">The origin of the data stream to be acted upon.</span></span> <span data-ttu-id="46e2c-158">For example, device telemetry.</span><span class="sxs-lookup"><span data-stu-id="46e2c-158">For example, device telemetry.</span></span>
* <span data-ttu-id="46e2c-159">**Condition**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-159">**Condition**.</span></span> <span data-ttu-id="46e2c-160">The query expression for the routing rule that is run against the message's properties and used to determine whether it is a match for the endpoint.</span><span class="sxs-lookup"><span data-stu-id="46e2c-160">The query expression for the routing rule that is run against the message's properties and used to determine whether it is a match for the endpoint.</span></span> <span data-ttu-id="46e2c-161">For more information about constructing a route condition, see the [Reference - query language for device twins and jobs][lnk-devguide-query-language].</span><span class="sxs-lookup"><span data-stu-id="46e2c-161">For more information about constructing a route condition, see the [Reference - query language for device twins and jobs][lnk-devguide-query-language].</span></span>
* <span data-ttu-id="46e2c-162">**Endpoint**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-162">**Endpoint**.</span></span> <span data-ttu-id="46e2c-163">The name of the endpoint where IoT Hub sends messages that match the condition.</span><span class="sxs-lookup"><span data-stu-id="46e2c-163">The name of the endpoint where IoT Hub sends messages that match the condition.</span></span> <span data-ttu-id="46e2c-164">Endpoints should be in the same region as the IoT hub, otherwise you may be charged for cross-region writes.</span><span class="sxs-lookup"><span data-stu-id="46e2c-164">Endpoints should be in the same region as the IoT hub, otherwise you may be charged for cross-region writes.</span></span>

<span data-ttu-id="46e2c-165">A single message may match the condition on multiple routing rules, in which case IoT Hub delivers the message to the endpoint associated with each matched rule.</span><span class="sxs-lookup"><span data-stu-id="46e2c-165">A single message may match the condition on multiple routing rules, in which case IoT Hub delivers the message to the endpoint associated with each matched rule.</span></span> <span data-ttu-id="46e2c-166">IoT Hub also automatically deduplicates message delivery, so if a message matches multiple rules that all have the same destination, it is only written to that destination once.</span><span class="sxs-lookup"><span data-stu-id="46e2c-166">IoT Hub also automatically deduplicates message delivery, so if a message matches multiple rules that all have the same destination, it is only written to that destination once.</span></span>

<span data-ttu-id="46e2c-167">For more information about creating custom endpoints in IoT Hub, see [IoT Hub endpoints][lnk-devguide-endpoints].</span><span class="sxs-lookup"><span data-stu-id="46e2c-167">For more information about creating custom endpoints in IoT Hub, see [IoT Hub endpoints][lnk-devguide-endpoints].</span></span>

### <a name="built-in-endpoint-messagesevents"></a><span data-ttu-id="46e2c-168">Built-in endpoint: messages/events</span><span class="sxs-lookup"><span data-stu-id="46e2c-168">Built-in endpoint: messages/events</span></span>

<span data-ttu-id="46e2c-169">An IoT hub exposes the following properties to enable you to control the built-in Event Hub-compatible messaging endpoint **messages/events**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-169">An IoT hub exposes the following properties to enable you to control the built-in Event Hub-compatible messaging endpoint **messages/events**.</span></span>

* <span data-ttu-id="46e2c-170">**Partition count**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-170">**Partition count**.</span></span> <span data-ttu-id="46e2c-171">Set this property at creation to define the number of [partitions][lnk-event-hub-partitions] for device-to-cloud event ingestion.</span><span class="sxs-lookup"><span data-stu-id="46e2c-171">Set this property at creation to define the number of [partitions][lnk-event-hub-partitions] for device-to-cloud event ingestion.</span></span>
* <span data-ttu-id="46e2c-172">**Retention time**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-172">**Retention time**.</span></span> <span data-ttu-id="46e2c-173">This property specifies how long in days messages are retained by IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-173">This property specifies how long in days messages are retained by IoT Hub.</span></span> <span data-ttu-id="46e2c-174">The default is one day, but it can be increased to seven days.</span><span class="sxs-lookup"><span data-stu-id="46e2c-174">The default is one day, but it can be increased to seven days.</span></span>

<span data-ttu-id="46e2c-175">IoT Hub also enables you to manage consumer groups on the built-in device-to-cloud receive endpoint.</span><span class="sxs-lookup"><span data-stu-id="46e2c-175">IoT Hub also enables you to manage consumer groups on the built-in device-to-cloud receive endpoint.</span></span>

<span data-ttu-id="46e2c-176">By default, all messages that do not explicitly match a message routing rule are written to the built-in endpoint.</span><span class="sxs-lookup"><span data-stu-id="46e2c-176">By default, all messages that do not explicitly match a message routing rule are written to the built-in endpoint.</span></span> <span data-ttu-id="46e2c-177">If you disable this fallback route, messages that do not explicitly match any message routing rules are dropped.</span><span class="sxs-lookup"><span data-stu-id="46e2c-177">If you disable this fallback route, messages that do not explicitly match any message routing rules are dropped.</span></span>

<span data-ttu-id="46e2c-178">You can modify the retention time, either programmatically through the [IoT Hub resource provider REST APIs][lnk-resource-provider-apis], or by using the [Azure portal][lnk-management-portal].</span><span class="sxs-lookup"><span data-stu-id="46e2c-178">You can modify the retention time, either programmatically through the [IoT Hub resource provider REST APIs][lnk-resource-provider-apis], or by using the [Azure portal][lnk-management-portal].</span></span>

### <a name="anti-spoofing-properties"></a><span data-ttu-id="46e2c-179">Anti-spoofing properties</span><span class="sxs-lookup"><span data-stu-id="46e2c-179">Anti-spoofing properties</span></span>
<span data-ttu-id="46e2c-180">To avoid device spoofing in device-to-cloud messages, IoT Hub stamps all messages with the following properties:</span><span class="sxs-lookup"><span data-stu-id="46e2c-180">To avoid device spoofing in device-to-cloud messages, IoT Hub stamps all messages with the following properties:</span></span>

* <span data-ttu-id="46e2c-181">**ConnectionDeviceId**</span><span class="sxs-lookup"><span data-stu-id="46e2c-181">**ConnectionDeviceId**</span></span>
* <span data-ttu-id="46e2c-182">**ConnectionDeviceGenerationId**</span><span class="sxs-lookup"><span data-stu-id="46e2c-182">**ConnectionDeviceGenerationId**</span></span>
* <span data-ttu-id="46e2c-183">**ConnectionAuthMethod**</span><span class="sxs-lookup"><span data-stu-id="46e2c-183">**ConnectionAuthMethod**</span></span>

<span data-ttu-id="46e2c-184">The first two contain the **deviceId** and **generationId** of the originating device, as per [Device identity properties][lnk-device-properties].</span><span class="sxs-lookup"><span data-stu-id="46e2c-184">The first two contain the **deviceId** and **generationId** of the originating device, as per [Device identity properties][lnk-device-properties].</span></span>

<span data-ttu-id="46e2c-185">The **ConnectionAuthMethod** property contains a JSON serialized object, with the following properties:</span><span class="sxs-lookup"><span data-stu-id="46e2c-185">The **ConnectionAuthMethod** property contains a JSON serialized object, with the following properties:</span></span>

```
{
  "scope": "{ hub | device}",
  "type": "{ symkey | sas}",
  "issuer": "iothub"
}
```

## <a name="cloud-to-device-messages"></a><span data-ttu-id="46e2c-186">Cloud-to-device messages</span><span class="sxs-lookup"><span data-stu-id="46e2c-186">Cloud-to-device messages</span></span>
<span data-ttu-id="46e2c-187">You send cloud-to-device messages through a service-facing endpoint (**/messages/devicebound**).</span><span class="sxs-lookup"><span data-stu-id="46e2c-187">You send cloud-to-device messages through a service-facing endpoint (**/messages/devicebound**).</span></span> <span data-ttu-id="46e2c-188">A device receives them through a device-specific endpoint (**/devices/{deviceId}/messages/devicebound**).</span><span class="sxs-lookup"><span data-stu-id="46e2c-188">A device receives them through a device-specific endpoint (**/devices/{deviceId}/messages/devicebound**).</span></span>

<span data-ttu-id="46e2c-189">Each cloud-to-device message is targeted at a single device by setting the **to** property to **/devices/{deviceId}/messages/devicebound**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-189">Each cloud-to-device message is targeted at a single device by setting the **to** property to **/devices/{deviceId}/messages/devicebound**.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="46e2c-190">Each device queue holds at most 50 cloud-to-device messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-190">Each device queue holds at most 50 cloud-to-device messages.</span></span> <span data-ttu-id="46e2c-191">Trying to send more messages to the same device results in an error.</span><span class="sxs-lookup"><span data-stu-id="46e2c-191">Trying to send more messages to the same device results in an error.</span></span>
> 
> [!NOTE]
> <span data-ttu-id="46e2c-192">When you send cloud-to-device messages, property names and values can only contain ASCII alphanumeric characters, plus ``{'!', '#', '$', '%, '&', "'", '*', '*', '+', '-', '.', '^', '_', '`', '|', '~'}``.</span><span class="sxs-lookup"><span data-stu-id="46e2c-192">When you send cloud-to-device messages, property names and values can only contain ASCII alphanumeric characters, plus ``{'!', '#', '$', '%, '&', "'", '*', '*', '+', '-', '.', '^', '_', '`', '|', '~'}``.</span></span>
> 
> 

### <a name="message-lifecycle"></a><span data-ttu-id="46e2c-193">Message lifecycle</span><span class="sxs-lookup"><span data-stu-id="46e2c-193">Message lifecycle</span></span>
<span data-ttu-id="46e2c-194">To guarantee at least once message delivery, IoT Hub persists cloud-to-device messages in per-device queues.</span><span class="sxs-lookup"><span data-stu-id="46e2c-194">To guarantee at least once message delivery, IoT Hub persists cloud-to-device messages in per-device queues.</span></span> <span data-ttu-id="46e2c-195">Devices must explicitly acknowledge *completion* for IoT Hub to remove them from the queue.</span><span class="sxs-lookup"><span data-stu-id="46e2c-195">Devices must explicitly acknowledge *completion* for IoT Hub to remove them from the queue.</span></span> <span data-ttu-id="46e2c-196">This guarantees resiliency against connectivity and device failures.</span><span class="sxs-lookup"><span data-stu-id="46e2c-196">This guarantees resiliency against connectivity and device failures.</span></span>

<span data-ttu-id="46e2c-197">The following diagram shows the lifecycle state graph for a cloud-to-device message.</span><span class="sxs-lookup"><span data-stu-id="46e2c-197">The following diagram shows the lifecycle state graph for a cloud-to-device message.</span></span>

![Cloud-to-device message lifecycle][img-lifecycle]

<span data-ttu-id="46e2c-199">When the service sends a message, it is considered *Enqueued*.</span><span class="sxs-lookup"><span data-stu-id="46e2c-199">When the service sends a message, it is considered *Enqueued*.</span></span> <span data-ttu-id="46e2c-200">When a device wants to *receive* a message, IoT Hub *locks* the message (sets the state to **Invisible**) allowing other threads on the same device to start receiving other messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-200">When a device wants to *receive* a message, IoT Hub *locks* the message (sets the state to **Invisible**) allowing other threads on the same device to start receiving other messages.</span></span> <span data-ttu-id="46e2c-201">When a device thread completes the processing of a message, it notifies IoT Hub by *completing* the message.</span><span class="sxs-lookup"><span data-stu-id="46e2c-201">When a device thread completes the processing of a message, it notifies IoT Hub by *completing* the message.</span></span>

<span data-ttu-id="46e2c-202">A device can also:</span><span class="sxs-lookup"><span data-stu-id="46e2c-202">A device can also:</span></span>

* <span data-ttu-id="46e2c-203">*Reject* the message, which causes IoT Hub to set it to the **Deadlettered** state.</span><span class="sxs-lookup"><span data-stu-id="46e2c-203">*Reject* the message, which causes IoT Hub to set it to the **Deadlettered** state.</span></span> <span data-ttu-id="46e2c-204">Note: devices connecting with MQTT cannot reject cloud-to-device messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-204">Note: devices connecting with MQTT cannot reject cloud-to-device messages.</span></span>
* <span data-ttu-id="46e2c-205">*Abandon* the message, which causes IoT Hub to put the message back in the queue, with the state set to **Enqueued**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-205">*Abandon* the message, which causes IoT Hub to put the message back in the queue, with the state set to **Enqueued**.</span></span>

<span data-ttu-id="46e2c-206">A thread could fail to process a message without notifying IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-206">A thread could fail to process a message without notifying IoT Hub.</span></span> <span data-ttu-id="46e2c-207">In this case, messages automatically transition from the **Invisible** state back to the **Enqueued** state after a *visibility (or lock) timeout*.</span><span class="sxs-lookup"><span data-stu-id="46e2c-207">In this case, messages automatically transition from the **Invisible** state back to the **Enqueued** state after a *visibility (or lock) timeout*.</span></span> <span data-ttu-id="46e2c-208">The default value of this timeout is one minute.</span><span class="sxs-lookup"><span data-stu-id="46e2c-208">The default value of this timeout is one minute.</span></span>

<span data-ttu-id="46e2c-209">A message can transition between the **Enqueued** and **Invisible** states for, at most, the number of times specified in the **max delivery count** property on IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-209">A message can transition between the **Enqueued** and **Invisible** states for, at most, the number of times specified in the **max delivery count** property on IoT Hub.</span></span> <span data-ttu-id="46e2c-210">After that number of transitions, IoT Hub sets the state of the message to **Deadlettered**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-210">After that number of transitions, IoT Hub sets the state of the message to **Deadlettered**.</span></span> <span data-ttu-id="46e2c-211">Similarly, IoT Hub sets the state of a message to **Deadlettered** after its expiration time (see [Time to live][lnk-ttl]).</span><span class="sxs-lookup"><span data-stu-id="46e2c-211">Similarly, IoT Hub sets the state of a message to **Deadlettered** after its expiration time (see [Time to live][lnk-ttl]).</span></span>

<span data-ttu-id="46e2c-212">For a tutorial on cloud-to-device messages, see [Tutorial: How to send cloud-to-device messages with IoT Hub][lnk-c2d-tutorial].</span><span class="sxs-lookup"><span data-stu-id="46e2c-212">For a tutorial on cloud-to-device messages, see [Tutorial: How to send cloud-to-device messages with IoT Hub][lnk-c2d-tutorial].</span></span> <span data-ttu-id="46e2c-213">For reference topics on how the different Azure IoT SDKs expose the cloud-to-device functionality, see [Azure IoT SDKs][lnk-sdks].</span><span class="sxs-lookup"><span data-stu-id="46e2c-213">For reference topics on how the different Azure IoT SDKs expose the cloud-to-device functionality, see [Azure IoT SDKs][lnk-sdks].</span></span>

> [!NOTE]
> <span data-ttu-id="46e2c-214">Typically, cloud-to-device messages complete whenever the loss of the message would not affect the application logic.</span><span class="sxs-lookup"><span data-stu-id="46e2c-214">Typically, cloud-to-device messages complete whenever the loss of the message would not affect the application logic.</span></span> <span data-ttu-id="46e2c-215">For example, the message content has been successfully persisted in local storage, or an operation has been successfully executed.</span><span class="sxs-lookup"><span data-stu-id="46e2c-215">For example, the message content has been successfully persisted in local storage, or an operation has been successfully executed.</span></span> <span data-ttu-id="46e2c-216">The message could also be carrying transient information, whose loss would not impact the functionality of the application.</span><span class="sxs-lookup"><span data-stu-id="46e2c-216">The message could also be carrying transient information, whose loss would not impact the functionality of the application.</span></span> <span data-ttu-id="46e2c-217">Sometimes, for long-running tasks, you can complete the cloud-to-device message after persisting the task description in local storage.</span><span class="sxs-lookup"><span data-stu-id="46e2c-217">Sometimes, for long-running tasks, you can complete the cloud-to-device message after persisting the task description in local storage.</span></span> <span data-ttu-id="46e2c-218">Then you can notify the solution back end with one or more device-to-cloud messages at various stages of progress of the task.</span><span class="sxs-lookup"><span data-stu-id="46e2c-218">Then you can notify the solution back end with one or more device-to-cloud messages at various stages of progress of the task.</span></span>
> 
> 

### <a name="message-expiration-time-to-live"></a><span data-ttu-id="46e2c-219">Message expiration (time to live)</span><span class="sxs-lookup"><span data-stu-id="46e2c-219">Message expiration (time to live)</span></span>
<span data-ttu-id="46e2c-220">Every cloud-to-device message has an expiration time.</span><span class="sxs-lookup"><span data-stu-id="46e2c-220">Every cloud-to-device message has an expiration time.</span></span> <span data-ttu-id="46e2c-221">This time is set either by the service (in the **ExpiryTimeUtc** property), or by IoT Hub using the default *time to live* specified as an IoT Hub property.</span><span class="sxs-lookup"><span data-stu-id="46e2c-221">This time is set either by the service (in the **ExpiryTimeUtc** property), or by IoT Hub using the default *time to live* specified as an IoT Hub property.</span></span> <span data-ttu-id="46e2c-222">See [Cloud-to-device configuration options][lnk-c2d-configuration].</span><span class="sxs-lookup"><span data-stu-id="46e2c-222">See [Cloud-to-device configuration options][lnk-c2d-configuration].</span></span>

> [!NOTE]
> <span data-ttu-id="46e2c-223">A common way to take advantage of message expiration and avoid sending messages to disconnected devices, is to set short time to live values.</span><span class="sxs-lookup"><span data-stu-id="46e2c-223">A common way to take advantage of message expiration and avoid sending messages to disconnected devices, is to set short time to live values.</span></span> <span data-ttu-id="46e2c-224">This approach achieves the same result as maintaining the device connection state, while being more efficient.</span><span class="sxs-lookup"><span data-stu-id="46e2c-224">This approach achieves the same result as maintaining the device connection state, while being more efficient.</span></span> <span data-ttu-id="46e2c-225">When you request message acknowledgements, IoT Hub notifies you which devices are able to receive messages, and which devices are not online or have failed.</span><span class="sxs-lookup"><span data-stu-id="46e2c-225">When you request message acknowledgements, IoT Hub notifies you which devices are able to receive messages, and which devices are not online or have failed.</span></span>
> 
> 

### <a name="message-feedback"></a><span data-ttu-id="46e2c-226">Message feedback</span><span class="sxs-lookup"><span data-stu-id="46e2c-226">Message feedback</span></span>
<span data-ttu-id="46e2c-227">When you send a cloud-to-device message, the service can request the delivery of per-message feedback regarding the final state of that message.</span><span class="sxs-lookup"><span data-stu-id="46e2c-227">When you send a cloud-to-device message, the service can request the delivery of per-message feedback regarding the final state of that message.</span></span>

* <span data-ttu-id="46e2c-228">If you set the **Ack** property to **positive**, IoT Hub generates a feedback message if, and only if, the cloud-to-device message reached the **Completed** state.</span><span class="sxs-lookup"><span data-stu-id="46e2c-228">If you set the **Ack** property to **positive**, IoT Hub generates a feedback message if, and only if, the cloud-to-device message reached the **Completed** state.</span></span>
* <span data-ttu-id="46e2c-229">If you set the **Ack** property to **negative**, IoT Hub generates a feedback message, if and only if, the cloud-to-device message reaches the **Deadlettered** state.</span><span class="sxs-lookup"><span data-stu-id="46e2c-229">If you set the **Ack** property to **negative**, IoT Hub generates a feedback message, if and only if, the cloud-to-device message reaches the **Deadlettered** state.</span></span>
* <span data-ttu-id="46e2c-230">If you set the **Ack** property to **full**, IoT Hub generates a feedback message in either case.</span><span class="sxs-lookup"><span data-stu-id="46e2c-230">If you set the **Ack** property to **full**, IoT Hub generates a feedback message in either case.</span></span>

> [!NOTE]
> <span data-ttu-id="46e2c-231">If **Ack** is **full**, and you don't receive a feedback message, it means that the feedback message expired.</span><span class="sxs-lookup"><span data-stu-id="46e2c-231">If **Ack** is **full**, and you don't receive a feedback message, it means that the feedback message expired.</span></span> <span data-ttu-id="46e2c-232">The service can't know what happened to the original message.</span><span class="sxs-lookup"><span data-stu-id="46e2c-232">The service can't know what happened to the original message.</span></span> <span data-ttu-id="46e2c-233">In practice, a service should ensure that it can process the feedback before it expires.</span><span class="sxs-lookup"><span data-stu-id="46e2c-233">In practice, a service should ensure that it can process the feedback before it expires.</span></span> <span data-ttu-id="46e2c-234">The maximum expiry time is two days, which allows plenty of time to get the service running again if a failure occurs.</span><span class="sxs-lookup"><span data-stu-id="46e2c-234">The maximum expiry time is two days, which allows plenty of time to get the service running again if a failure occurs.</span></span>
> 
> 

<span data-ttu-id="46e2c-235">As explained in [Endpoints][lnk-endpoints], IoT Hub delivers feedback through a service-facing endpoint (**/messages/servicebound/feedback**) as messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-235">As explained in [Endpoints][lnk-endpoints], IoT Hub delivers feedback through a service-facing endpoint (**/messages/servicebound/feedback**) as messages.</span></span> <span data-ttu-id="46e2c-236">The semantics for receiving feedback are the same as for cloud-to-device messages, and have the same [Message lifecycle][lnk-lifecycle].</span><span class="sxs-lookup"><span data-stu-id="46e2c-236">The semantics for receiving feedback are the same as for cloud-to-device messages, and have the same [Message lifecycle][lnk-lifecycle].</span></span> <span data-ttu-id="46e2c-237">Whenever possible, message feedback is batched in a single message, with the following format:</span><span class="sxs-lookup"><span data-stu-id="46e2c-237">Whenever possible, message feedback is batched in a single message, with the following format:</span></span>

| <span data-ttu-id="46e2c-238">Property</span><span class="sxs-lookup"><span data-stu-id="46e2c-238">Property</span></span> | <span data-ttu-id="46e2c-239">Description</span><span class="sxs-lookup"><span data-stu-id="46e2c-239">Description</span></span> |
| --- | --- |
| <span data-ttu-id="46e2c-240">EnqueuedTime</span><span class="sxs-lookup"><span data-stu-id="46e2c-240">EnqueuedTime</span></span> |<span data-ttu-id="46e2c-241">Timestamp indicating when the message was created.</span><span class="sxs-lookup"><span data-stu-id="46e2c-241">Timestamp indicating when the message was created.</span></span> |
| <span data-ttu-id="46e2c-242">UserId</span><span class="sxs-lookup"><span data-stu-id="46e2c-242">UserId</span></span> |`{iot hub name}` |
| <span data-ttu-id="46e2c-243">ContentType</span><span class="sxs-lookup"><span data-stu-id="46e2c-243">ContentType</span></span> |`application/vnd.microsoft.iothub.feedback.json` |

<span data-ttu-id="46e2c-244">The body is a JSON-serialized array of records, each with the following properties:</span><span class="sxs-lookup"><span data-stu-id="46e2c-244">The body is a JSON-serialized array of records, each with the following properties:</span></span>

| <span data-ttu-id="46e2c-245">Property</span><span class="sxs-lookup"><span data-stu-id="46e2c-245">Property</span></span> | <span data-ttu-id="46e2c-246">Description</span><span class="sxs-lookup"><span data-stu-id="46e2c-246">Description</span></span> |
| --- | --- |
| <span data-ttu-id="46e2c-247">EnqueuedTimeUtc</span><span class="sxs-lookup"><span data-stu-id="46e2c-247">EnqueuedTimeUtc</span></span> |<span data-ttu-id="46e2c-248">Timestamp indicating when the outcome of the message happened.</span><span class="sxs-lookup"><span data-stu-id="46e2c-248">Timestamp indicating when the outcome of the message happened.</span></span> <span data-ttu-id="46e2c-249">For example, the device completed or the message expired.</span><span class="sxs-lookup"><span data-stu-id="46e2c-249">For example, the device completed or the message expired.</span></span> |
| <span data-ttu-id="46e2c-250">OriginalMessageId</span><span class="sxs-lookup"><span data-stu-id="46e2c-250">OriginalMessageId</span></span> |<span data-ttu-id="46e2c-251">**MessageId** of the cloud-to-device message to which this feedback information pertains.</span><span class="sxs-lookup"><span data-stu-id="46e2c-251">**MessageId** of the cloud-to-device message to which this feedback information pertains.</span></span> |
| <span data-ttu-id="46e2c-252">StatusCode</span><span class="sxs-lookup"><span data-stu-id="46e2c-252">StatusCode</span></span> |<span data-ttu-id="46e2c-253">Required string.</span><span class="sxs-lookup"><span data-stu-id="46e2c-253">Required string.</span></span> <span data-ttu-id="46e2c-254">Used in feedback messages generated by IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-254">Used in feedback messages generated by IoT Hub.</span></span> <br/> <span data-ttu-id="46e2c-255">'Success'</span><span class="sxs-lookup"><span data-stu-id="46e2c-255">'Success'</span></span> <br/> <span data-ttu-id="46e2c-256">'Expired'</span><span class="sxs-lookup"><span data-stu-id="46e2c-256">'Expired'</span></span> <br/> <span data-ttu-id="46e2c-257">'DeliveryCountExceeded'</span><span class="sxs-lookup"><span data-stu-id="46e2c-257">'DeliveryCountExceeded'</span></span> <br/> <span data-ttu-id="46e2c-258">'Rejected'</span><span class="sxs-lookup"><span data-stu-id="46e2c-258">'Rejected'</span></span> <br/> <span data-ttu-id="46e2c-259">'Purged'</span><span class="sxs-lookup"><span data-stu-id="46e2c-259">'Purged'</span></span> |
| <span data-ttu-id="46e2c-260">Description</span><span class="sxs-lookup"><span data-stu-id="46e2c-260">Description</span></span> |<span data-ttu-id="46e2c-261">String values for **StatusCode**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-261">String values for **StatusCode**.</span></span> |
| <span data-ttu-id="46e2c-262">DeviceId</span><span class="sxs-lookup"><span data-stu-id="46e2c-262">DeviceId</span></span> |<span data-ttu-id="46e2c-263">**DeviceId** of the target device of the cloud-to-device message to which this piece of feedback pertains.</span><span class="sxs-lookup"><span data-stu-id="46e2c-263">**DeviceId** of the target device of the cloud-to-device message to which this piece of feedback pertains.</span></span> |
| <span data-ttu-id="46e2c-264">DeviceGenerationId</span><span class="sxs-lookup"><span data-stu-id="46e2c-264">DeviceGenerationId</span></span> |<span data-ttu-id="46e2c-265">**DeviceGenerationId** of the target device of the cloud-to-device message to which this piece of feedback pertains.</span><span class="sxs-lookup"><span data-stu-id="46e2c-265">**DeviceGenerationId** of the target device of the cloud-to-device message to which this piece of feedback pertains.</span></span> |

> [!IMPORTANT]
> <span data-ttu-id="46e2c-266">The service must specify a **MessageId** for the cloud-to-device message to be able to correlate its feedback with the original message.</span><span class="sxs-lookup"><span data-stu-id="46e2c-266">The service must specify a **MessageId** for the cloud-to-device message to be able to correlate its feedback with the original message.</span></span>
> 
> 

<span data-ttu-id="46e2c-267">The following example shows the body of a feedback message.</span><span class="sxs-lookup"><span data-stu-id="46e2c-267">The following example shows the body of a feedback message.</span></span>

```
[
  {
    "OriginalMessageId": "0987654321",
    "EnqueuedTimeUtc": "2015-07-28T16:24:48.789Z",
    "StatusCode": 0
    "Description": "Success",
    "DeviceId": "123",
    "DeviceGenerationId": "abcdefghijklmnopqrstuvwxyz"
  },
  {
    ...
  },
  ...
]
```

### <a name="cloud-to-device-configuration-options"></a><span data-ttu-id="46e2c-268">Cloud-to-device configuration options</span><span class="sxs-lookup"><span data-stu-id="46e2c-268">Cloud-to-device configuration options</span></span>
<span data-ttu-id="46e2c-269">Each IoT hub exposes the following configuration options for cloud-to-device messaging.</span><span class="sxs-lookup"><span data-stu-id="46e2c-269">Each IoT hub exposes the following configuration options for cloud-to-device messaging.</span></span>

| <span data-ttu-id="46e2c-270">Property</span><span class="sxs-lookup"><span data-stu-id="46e2c-270">Property</span></span> | <span data-ttu-id="46e2c-271">Description</span><span class="sxs-lookup"><span data-stu-id="46e2c-271">Description</span></span> | <span data-ttu-id="46e2c-272">Range and default</span><span class="sxs-lookup"><span data-stu-id="46e2c-272">Range and default</span></span> |
| --- | --- | --- |
| <span data-ttu-id="46e2c-273">defaultTtlAsIso8601</span><span class="sxs-lookup"><span data-stu-id="46e2c-273">defaultTtlAsIso8601</span></span> |<span data-ttu-id="46e2c-274">Default TTL for cloud-to-device messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-274">Default TTL for cloud-to-device messages.</span></span> |<span data-ttu-id="46e2c-275">ISO_8601 interval up to 2D (minimum 1 minute).</span><span class="sxs-lookup"><span data-stu-id="46e2c-275">ISO_8601 interval up to 2D (minimum 1 minute).</span></span> <span data-ttu-id="46e2c-276">Default: 1 hour.</span><span class="sxs-lookup"><span data-stu-id="46e2c-276">Default: 1 hour.</span></span> |
| <span data-ttu-id="46e2c-277">maxDeliveryCount</span><span class="sxs-lookup"><span data-stu-id="46e2c-277">maxDeliveryCount</span></span> |<span data-ttu-id="46e2c-278">Maximum delivery count for cloud-to-device per-device queues.</span><span class="sxs-lookup"><span data-stu-id="46e2c-278">Maximum delivery count for cloud-to-device per-device queues.</span></span> |<span data-ttu-id="46e2c-279">1 to 100.</span><span class="sxs-lookup"><span data-stu-id="46e2c-279">1 to 100.</span></span> <span data-ttu-id="46e2c-280">Default: 10.</span><span class="sxs-lookup"><span data-stu-id="46e2c-280">Default: 10.</span></span> |
| <span data-ttu-id="46e2c-281">feedback.ttlAsIso8601</span><span class="sxs-lookup"><span data-stu-id="46e2c-281">feedback.ttlAsIso8601</span></span> |<span data-ttu-id="46e2c-282">Retention for service-bound feedback messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-282">Retention for service-bound feedback messages.</span></span> |<span data-ttu-id="46e2c-283">ISO_8601 interval up to 2D (minimum 1 minute).</span><span class="sxs-lookup"><span data-stu-id="46e2c-283">ISO_8601 interval up to 2D (minimum 1 minute).</span></span> <span data-ttu-id="46e2c-284">Default: 1 hour.</span><span class="sxs-lookup"><span data-stu-id="46e2c-284">Default: 1 hour.</span></span> |
| <span data-ttu-id="46e2c-285">feedback.maxDeliveryCount</span><span class="sxs-lookup"><span data-stu-id="46e2c-285">feedback.maxDeliveryCount</span></span> |<span data-ttu-id="46e2c-286">Maximum delivery count for feedback queue.</span><span class="sxs-lookup"><span data-stu-id="46e2c-286">Maximum delivery count for feedback queue.</span></span> |<span data-ttu-id="46e2c-287">1 to 100.</span><span class="sxs-lookup"><span data-stu-id="46e2c-287">1 to 100.</span></span> <span data-ttu-id="46e2c-288">Default: 100.</span><span class="sxs-lookup"><span data-stu-id="46e2c-288">Default: 100.</span></span> |

<span data-ttu-id="46e2c-289">For more information, see [Create IoT hubs][lnk-portal].</span><span class="sxs-lookup"><span data-stu-id="46e2c-289">For more information, see [Create IoT hubs][lnk-portal].</span></span>

## <a name="read-device-to-cloud-messages"></a><span data-ttu-id="46e2c-290">Read device-to-cloud messages</span><span class="sxs-lookup"><span data-stu-id="46e2c-290">Read device-to-cloud messages</span></span>
<span data-ttu-id="46e2c-291">IoT Hub exposes the **messages/events** built-in endpoint for your back-end services to read the device-to-cloud messages received by your hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-291">IoT Hub exposes the **messages/events** built-in endpoint for your back-end services to read the device-to-cloud messages received by your hub.</span></span> <span data-ttu-id="46e2c-292">This endpoint is Event Hub-compatible, which enables you to use any of the mechanisms the Event Hubs service supports for reading messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-292">This endpoint is Event Hub-compatible, which enables you to use any of the mechanisms the Event Hubs service supports for reading messages.</span></span>

<span data-ttu-id="46e2c-293">You can also create custom endpoints in IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-293">You can also create custom endpoints in IoT Hub.</span></span> <span data-ttu-id="46e2c-294">IoT Hub currently supports Event Hubs, Service Bus queues, and Service Bus topics as custom endpoints.</span><span class="sxs-lookup"><span data-stu-id="46e2c-294">IoT Hub currently supports Event Hubs, Service Bus queues, and Service Bus topics as custom endpoints.</span></span> <span data-ttu-id="46e2c-295">For more information about reading from those services, see: reading from [Event Hubs][lnk-getstarted-eh], reading from [Service Bus queues][lnk-getstarted-queue], reading from [Service Bus topics][lnk-getstarted-topic].</span><span class="sxs-lookup"><span data-stu-id="46e2c-295">For more information about reading from those services, see: reading from [Event Hubs][lnk-getstarted-eh], reading from [Service Bus queues][lnk-getstarted-queue], reading from [Service Bus topics][lnk-getstarted-topic].</span></span>

### <a name="reading-from-the-built-in-endpoint"></a><span data-ttu-id="46e2c-296">Reading from the built-in endpoint</span><span class="sxs-lookup"><span data-stu-id="46e2c-296">Reading from the built-in endpoint</span></span>

<span data-ttu-id="46e2c-297">When you use the [Azure Service Bus SDK for .NET][lnk-servicebus-sdk] or the [Event Hubs - Event Processor Host][lnk-eventprocessorhost], you can use any IoT Hub connection strings with the correct permissions.</span><span class="sxs-lookup"><span data-stu-id="46e2c-297">When you use the [Azure Service Bus SDK for .NET][lnk-servicebus-sdk] or the [Event Hubs - Event Processor Host][lnk-eventprocessorhost], you can use any IoT Hub connection strings with the correct permissions.</span></span> <span data-ttu-id="46e2c-298">Then use **messages/events** as the Event Hub name.</span><span class="sxs-lookup"><span data-stu-id="46e2c-298">Then use **messages/events** as the Event Hub name.</span></span>

<span data-ttu-id="46e2c-299">When you use SDKs (or product integrations) that are unaware of IoT Hub, you must retrieve an Event Hub-compatible endpoint and Event Hub-compatible name from the IoT Hub settings in the [Azure portal][lnk-management-portal]:</span><span class="sxs-lookup"><span data-stu-id="46e2c-299">When you use SDKs (or product integrations) that are unaware of IoT Hub, you must retrieve an Event Hub-compatible endpoint and Event Hub-compatible name from the IoT Hub settings in the [Azure portal][lnk-management-portal]:</span></span>

1. <span data-ttu-id="46e2c-300">In the IoT hub blade, click **Endpoints**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-300">In the IoT hub blade, click **Endpoints**.</span></span>
2. <span data-ttu-id="46e2c-301">In the **Built-in endpoints** section, click **Events**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-301">In the **Built-in endpoints** section, click **Events**.</span></span> <span data-ttu-id="46e2c-302">The blade contains the following values: **Event Hub-compatible endpoint**, **Event Hub-compatible name**, **Partitions**, **Retention time**, and **Consumer groups**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-302">The blade contains the following values: **Event Hub-compatible endpoint**, **Event Hub-compatible name**, **Partitions**, **Retention time**, and **Consumer groups**.</span></span>
   
    ![Device-to-cloud settings][img-eventhubcompatible]

> [!NOTE]
> <span data-ttu-id="46e2c-304">The IoT Hub SDK requires the IoT Hub endpoint name, which is **messages/events** as shown in the **Endpoints** blade.</span><span class="sxs-lookup"><span data-stu-id="46e2c-304">The IoT Hub SDK requires the IoT Hub endpoint name, which is **messages/events** as shown in the **Endpoints** blade.</span></span>
>
>

> [!NOTE]
> <span data-ttu-id="46e2c-305">If the SDK you are using requires a **Hostname** or **Namespace** value, remove the scheme from the **Event Hub-compatible endpoint**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-305">If the SDK you are using requires a **Hostname** or **Namespace** value, remove the scheme from the **Event Hub-compatible endpoint**.</span></span> <span data-ttu-id="46e2c-306">For example, if your Event Hub-compatible endpoint is **sb://iothub-ns-myiothub-1234.servicebus.windows.net/**, the **Hostname** would be **iothub-ns-myiothub-1234.servicebus.windows.net**, and the **Namespace** would be **iothub-ns-myiothub-1234**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-306">For example, if your Event Hub-compatible endpoint is **sb://iothub-ns-myiothub-1234.servicebus.windows.net/**, the **Hostname** would be **iothub-ns-myiothub-1234.servicebus.windows.net**, and the **Namespace** would be **iothub-ns-myiothub-1234**.</span></span>
> 
>

<span data-ttu-id="46e2c-307">You can then use any shared access policy that has the **ServiceConnect** permissions to connect to the specified Event Hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-307">You can then use any shared access policy that has the **ServiceConnect** permissions to connect to the specified Event Hub.</span></span>

<span data-ttu-id="46e2c-308">If you need to build an Event Hub connection string by using the previous information, use the following pattern:</span><span class="sxs-lookup"><span data-stu-id="46e2c-308">If you need to build an Event Hub connection string by using the previous information, use the following pattern:</span></span>

```
Endpoint={Event Hub-compatible endpoint};SharedAccessKeyName={iot hub policy name};SharedAccessKey={iot hub policy key}
```

<span data-ttu-id="46e2c-309">The following is a list of SDKs and integrations that you can use with Event Hub-compatible endpoints that IoT Hub exposes:</span><span class="sxs-lookup"><span data-stu-id="46e2c-309">The following is a list of SDKs and integrations that you can use with Event Hub-compatible endpoints that IoT Hub exposes:</span></span>

* [<span data-ttu-id="46e2c-310">Java Event Hubs client</span><span class="sxs-lookup"><span data-stu-id="46e2c-310">Java Event Hubs client</span></span>](https://github.com/hdinsight/eventhubs-client)
* <span data-ttu-id="46e2c-311">[Apache Storm spout](../hdinsight/hdinsight-storm-develop-csharp-event-hub-topology.md).</span><span class="sxs-lookup"><span data-stu-id="46e2c-311">[Apache Storm spout](../hdinsight/hdinsight-storm-develop-csharp-event-hub-topology.md).</span></span> <span data-ttu-id="46e2c-312">You can view the [spout source](https://github.com/apache/storm/tree/master/external/storm-eventhubs) on GitHub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-312">You can view the [spout source](https://github.com/apache/storm/tree/master/external/storm-eventhubs) on GitHub.</span></span>
* [<span data-ttu-id="46e2c-313">Apache Spark integration</span><span class="sxs-lookup"><span data-stu-id="46e2c-313">Apache Spark integration</span></span>](../hdinsight/hdinsight-apache-spark-eventhub-streaming.md)

## <a name="reference-topics"></a><span data-ttu-id="46e2c-314">Reference topics:</span><span class="sxs-lookup"><span data-stu-id="46e2c-314">Reference topics:</span></span>
<span data-ttu-id="46e2c-315">The following reference topics provide you with more information about exchanging messages with IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-315">The following reference topics provide you with more information about exchanging messages with IoT Hub.</span></span>

## <a name="message-format"></a><span data-ttu-id="46e2c-316">Message format</span><span class="sxs-lookup"><span data-stu-id="46e2c-316">Message format</span></span>
<span data-ttu-id="46e2c-317">IoT Hub messages comprise:</span><span class="sxs-lookup"><span data-stu-id="46e2c-317">IoT Hub messages comprise:</span></span>

* <span data-ttu-id="46e2c-318">A set of *system properties*.</span><span class="sxs-lookup"><span data-stu-id="46e2c-318">A set of *system properties*.</span></span> <span data-ttu-id="46e2c-319">Properties that IoT Hub interprets or sets.</span><span class="sxs-lookup"><span data-stu-id="46e2c-319">Properties that IoT Hub interprets or sets.</span></span> <span data-ttu-id="46e2c-320">This set is predetermined.</span><span class="sxs-lookup"><span data-stu-id="46e2c-320">This set is predetermined.</span></span>
* <span data-ttu-id="46e2c-321">A set of *application properties*.</span><span class="sxs-lookup"><span data-stu-id="46e2c-321">A set of *application properties*.</span></span> <span data-ttu-id="46e2c-322">A dictionary of string properties that the application can define and access, without needing to deserialize the message body.</span><span class="sxs-lookup"><span data-stu-id="46e2c-322">A dictionary of string properties that the application can define and access, without needing to deserialize the message body.</span></span> <span data-ttu-id="46e2c-323">IoT Hub never modifies these properties.</span><span class="sxs-lookup"><span data-stu-id="46e2c-323">IoT Hub never modifies these properties.</span></span>
* <span data-ttu-id="46e2c-324">An opaque binary body.</span><span class="sxs-lookup"><span data-stu-id="46e2c-324">An opaque binary body.</span></span>

<span data-ttu-id="46e2c-325">For more information about how the message is encoded in different protocols, see [Azure IoT SDKs][lnk-sdks].</span><span class="sxs-lookup"><span data-stu-id="46e2c-325">For more information about how the message is encoded in different protocols, see [Azure IoT SDKs][lnk-sdks].</span></span>

<span data-ttu-id="46e2c-326">The following table lists the set of system properties in IoT Hub messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-326">The following table lists the set of system properties in IoT Hub messages.</span></span>

| <span data-ttu-id="46e2c-327">Property</span><span class="sxs-lookup"><span data-stu-id="46e2c-327">Property</span></span> | <span data-ttu-id="46e2c-328">Description</span><span class="sxs-lookup"><span data-stu-id="46e2c-328">Description</span></span> |
| --- | --- |
| <span data-ttu-id="46e2c-329">MessageId</span><span class="sxs-lookup"><span data-stu-id="46e2c-329">MessageId</span></span> |<span data-ttu-id="46e2c-330">A user-settable identifier for the message, used for request-reply patterns.</span><span class="sxs-lookup"><span data-stu-id="46e2c-330">A user-settable identifier for the message, used for request-reply patterns.</span></span> <span data-ttu-id="46e2c-331">Format: A case-sensitive string (up to 128 characters long) of ASCII 7-bit alphanumeric characters + `{'-', ':',.', '+', '%', '_', '#', '*', '?', '!', '(', ')', ',', '=', '@', ';', '$', '''}`.</span><span class="sxs-lookup"><span data-stu-id="46e2c-331">Format: A case-sensitive string (up to 128 characters long) of ASCII 7-bit alphanumeric characters + `{'-', ':',.', '+', '%', '_', '#', '*', '?', '!', '(', ')', ',', '=', '@', ';', '$', '''}`.</span></span> |
| <span data-ttu-id="46e2c-332">Sequence number</span><span class="sxs-lookup"><span data-stu-id="46e2c-332">Sequence number</span></span> |<span data-ttu-id="46e2c-333">A number (unique per device-queue) assigned by IoT Hub to each cloud-to-device message.</span><span class="sxs-lookup"><span data-stu-id="46e2c-333">A number (unique per device-queue) assigned by IoT Hub to each cloud-to-device message.</span></span> |
| <span data-ttu-id="46e2c-334">To</span><span class="sxs-lookup"><span data-stu-id="46e2c-334">To</span></span> |<span data-ttu-id="46e2c-335">A destination specified in [Cloud-to-Device][lnk-c2d] messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-335">A destination specified in [Cloud-to-Device][lnk-c2d] messages.</span></span> |
| <span data-ttu-id="46e2c-336">ExpiryTimeUtc</span><span class="sxs-lookup"><span data-stu-id="46e2c-336">ExpiryTimeUtc</span></span> |<span data-ttu-id="46e2c-337">Date and time of message expiration.</span><span class="sxs-lookup"><span data-stu-id="46e2c-337">Date and time of message expiration.</span></span> |
| <span data-ttu-id="46e2c-338">EnqueuedTime</span><span class="sxs-lookup"><span data-stu-id="46e2c-338">EnqueuedTime</span></span> |<span data-ttu-id="46e2c-339">Date and time the [Cloud-to-Device][lnk-c2d] message was received by IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-339">Date and time the [Cloud-to-Device][lnk-c2d] message was received by IoT Hub.</span></span> |
| <span data-ttu-id="46e2c-340">CorrelationId</span><span class="sxs-lookup"><span data-stu-id="46e2c-340">CorrelationId</span></span> |<span data-ttu-id="46e2c-341">A string property in a response message that typically contains the MessageId of the request, in request-reply patterns.</span><span class="sxs-lookup"><span data-stu-id="46e2c-341">A string property in a response message that typically contains the MessageId of the request, in request-reply patterns.</span></span> |
| <span data-ttu-id="46e2c-342">UserId</span><span class="sxs-lookup"><span data-stu-id="46e2c-342">UserId</span></span> |<span data-ttu-id="46e2c-343">An ID used to specify the origin of messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-343">An ID used to specify the origin of messages.</span></span> <span data-ttu-id="46e2c-344">When messages are generated by IoT Hub, it is set to `{iot hub name}`.</span><span class="sxs-lookup"><span data-stu-id="46e2c-344">When messages are generated by IoT Hub, it is set to `{iot hub name}`.</span></span> |
| <span data-ttu-id="46e2c-345">Ack</span><span class="sxs-lookup"><span data-stu-id="46e2c-345">Ack</span></span> |<span data-ttu-id="46e2c-346">A feedback message generator.</span><span class="sxs-lookup"><span data-stu-id="46e2c-346">A feedback message generator.</span></span> <span data-ttu-id="46e2c-347">This property is used in cloud-to-device messages to request IoT Hub to generate feedback messages as a result of the consumption of the message by the device.</span><span class="sxs-lookup"><span data-stu-id="46e2c-347">This property is used in cloud-to-device messages to request IoT Hub to generate feedback messages as a result of the consumption of the message by the device.</span></span> <span data-ttu-id="46e2c-348">Possible values: **none** (default): no feedback message is generated, **positive**: receive a feedback message if the message was completed, **negative**: receive a feedback message if the message expired (or maximum delivery count was reached) without being completed by the device, or **full**: both positive and negative.</span><span class="sxs-lookup"><span data-stu-id="46e2c-348">Possible values: **none** (default): no feedback message is generated, **positive**: receive a feedback message if the message was completed, **negative**: receive a feedback message if the message expired (or maximum delivery count was reached) without being completed by the device, or **full**: both positive and negative.</span></span> <span data-ttu-id="46e2c-349">For more information, see [Message feedback][lnk-feedback].</span><span class="sxs-lookup"><span data-stu-id="46e2c-349">For more information, see [Message feedback][lnk-feedback].</span></span> |
| <span data-ttu-id="46e2c-350">ConnectionDeviceId</span><span class="sxs-lookup"><span data-stu-id="46e2c-350">ConnectionDeviceId</span></span> |<span data-ttu-id="46e2c-351">An ID set by IoT Hub on device-to-cloud messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-351">An ID set by IoT Hub on device-to-cloud messages.</span></span> <span data-ttu-id="46e2c-352">It contains the **deviceId** of the device that sent the message.</span><span class="sxs-lookup"><span data-stu-id="46e2c-352">It contains the **deviceId** of the device that sent the message.</span></span> |
| <span data-ttu-id="46e2c-353">ConnectionDeviceGenerationId</span><span class="sxs-lookup"><span data-stu-id="46e2c-353">ConnectionDeviceGenerationId</span></span> |<span data-ttu-id="46e2c-354">An ID set by IoT Hub on device-to-cloud messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-354">An ID set by IoT Hub on device-to-cloud messages.</span></span> <span data-ttu-id="46e2c-355">It contains the **generationId** (as per [Device identity properties][lnk-device-properties]) of the device that sent the message.</span><span class="sxs-lookup"><span data-stu-id="46e2c-355">It contains the **generationId** (as per [Device identity properties][lnk-device-properties]) of the device that sent the message.</span></span> |
| <span data-ttu-id="46e2c-356">ConnectionAuthMethod</span><span class="sxs-lookup"><span data-stu-id="46e2c-356">ConnectionAuthMethod</span></span> |<span data-ttu-id="46e2c-357">An authentication method set by IoT Hub on device-to-cloud messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-357">An authentication method set by IoT Hub on device-to-cloud messages.</span></span> <span data-ttu-id="46e2c-358">This property contains information about the authentication method used to authenticate the device sending the message.</span><span class="sxs-lookup"><span data-stu-id="46e2c-358">This property contains information about the authentication method used to authenticate the device sending the message.</span></span> <span data-ttu-id="46e2c-359">For more information, see [Device to cloud anti-spoofing][lnk-antispoofing].</span><span class="sxs-lookup"><span data-stu-id="46e2c-359">For more information, see [Device to cloud anti-spoofing][lnk-antispoofing].</span></span> |

## <a name="message-size"></a><span data-ttu-id="46e2c-360">Message size</span><span class="sxs-lookup"><span data-stu-id="46e2c-360">Message size</span></span>

<span data-ttu-id="46e2c-361">IoT Hub measures message size in a protocol-agnostic way, considering only the actual payload.</span><span class="sxs-lookup"><span data-stu-id="46e2c-361">IoT Hub measures message size in a protocol-agnostic way, considering only the actual payload.</span></span> <span data-ttu-id="46e2c-362">The size in bytes is calculated as the sum of the following:</span><span class="sxs-lookup"><span data-stu-id="46e2c-362">The size in bytes is calculated as the sum of the following:</span></span>

* <span data-ttu-id="46e2c-363">The body size in bytes, plus</span><span class="sxs-lookup"><span data-stu-id="46e2c-363">The body size in bytes, plus</span></span>
* <span data-ttu-id="46e2c-364">The size in bytes of all the values of the message system properties, plus</span><span class="sxs-lookup"><span data-stu-id="46e2c-364">The size in bytes of all the values of the message system properties, plus</span></span>
* <span data-ttu-id="46e2c-365">The size in bytes of all user property names and values.</span><span class="sxs-lookup"><span data-stu-id="46e2c-365">The size in bytes of all user property names and values.</span></span>

<span data-ttu-id="46e2c-366">Note that property names and values are limited to ASCII characters, so the length of the strings equals the size in bytes.</span><span class="sxs-lookup"><span data-stu-id="46e2c-366">Note that property names and values are limited to ASCII characters, so the length of the strings equals the size in bytes.</span></span>

## <a name="communication-protocols"></a><span data-ttu-id="46e2c-367">Communication protocols</span><span class="sxs-lookup"><span data-stu-id="46e2c-367">Communication protocols</span></span>
<span data-ttu-id="46e2c-368">IoT Hub allows devices to use [MQTT][lnk-mqtt], MQTT over WebSockets, [AMQP][lnk-amqp], AMQP over WebSockets, and HTTP protocols for device-side communications.</span><span class="sxs-lookup"><span data-stu-id="46e2c-368">IoT Hub allows devices to use [MQTT][lnk-mqtt], MQTT over WebSockets, [AMQP][lnk-amqp], AMQP over WebSockets, and HTTP protocols for device-side communications.</span></span> <span data-ttu-id="46e2c-369">The following table provides the high-level recommendations for your choice of protocol:</span><span class="sxs-lookup"><span data-stu-id="46e2c-369">The following table provides the high-level recommendations for your choice of protocol:</span></span>

| <span data-ttu-id="46e2c-370">Protocol</span><span class="sxs-lookup"><span data-stu-id="46e2c-370">Protocol</span></span> | <span data-ttu-id="46e2c-371">When you should choose this protocol</span><span class="sxs-lookup"><span data-stu-id="46e2c-371">When you should choose this protocol</span></span> |
| --- | --- |
| <span data-ttu-id="46e2c-372">MQTT</span><span class="sxs-lookup"><span data-stu-id="46e2c-372">MQTT</span></span> <br> <span data-ttu-id="46e2c-373">MQTT over WebSocket</span><span class="sxs-lookup"><span data-stu-id="46e2c-373">MQTT over WebSocket</span></span> |<span data-ttu-id="46e2c-374">Use on all devices that do not require to connect multiple devices (each with its own per-device credentials) over the same TLS connection.</span><span class="sxs-lookup"><span data-stu-id="46e2c-374">Use on all devices that do not require to connect multiple devices (each with its own per-device credentials) over the same TLS connection.</span></span> |
| <span data-ttu-id="46e2c-375">AMQP</span><span class="sxs-lookup"><span data-stu-id="46e2c-375">AMQP</span></span> <br> <span data-ttu-id="46e2c-376">AMQP over WebSocket</span><span class="sxs-lookup"><span data-stu-id="46e2c-376">AMQP over WebSocket</span></span> |<span data-ttu-id="46e2c-377">Use on field and cloud gateways to take advantage of connection multiplexing across devices.</span><span class="sxs-lookup"><span data-stu-id="46e2c-377">Use on field and cloud gateways to take advantage of connection multiplexing across devices.</span></span> |
| <span data-ttu-id="46e2c-378">HTTP</span><span class="sxs-lookup"><span data-stu-id="46e2c-378">HTTP</span></span> |<span data-ttu-id="46e2c-379">Use for devices that cannot support other protocols.</span><span class="sxs-lookup"><span data-stu-id="46e2c-379">Use for devices that cannot support other protocols.</span></span> |

<span data-ttu-id="46e2c-380">Consider the following points when you choose your protocol for device-side communications:</span><span class="sxs-lookup"><span data-stu-id="46e2c-380">Consider the following points when you choose your protocol for device-side communications:</span></span>

* <span data-ttu-id="46e2c-381">**Cloud-to-device pattern**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-381">**Cloud-to-device pattern**.</span></span> <span data-ttu-id="46e2c-382">HTTP does not have an efficient way to implement server push.</span><span class="sxs-lookup"><span data-stu-id="46e2c-382">HTTP does not have an efficient way to implement server push.</span></span> <span data-ttu-id="46e2c-383">As such, when you are using HTTP, devices poll IoT Hub for cloud-to-device messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-383">As such, when you are using HTTP, devices poll IoT Hub for cloud-to-device messages.</span></span> <span data-ttu-id="46e2c-384">This approach is inefficient for both the device and IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-384">This approach is inefficient for both the device and IoT Hub.</span></span> <span data-ttu-id="46e2c-385">Under current HTTP guidelines, each device should poll for messages every 25 minutes or more.</span><span class="sxs-lookup"><span data-stu-id="46e2c-385">Under current HTTP guidelines, each device should poll for messages every 25 minutes or more.</span></span> <span data-ttu-id="46e2c-386">On the other hand, MQTT and AMQP support server push when receiving cloud-to-device messages.</span><span class="sxs-lookup"><span data-stu-id="46e2c-386">On the other hand, MQTT and AMQP support server push when receiving cloud-to-device messages.</span></span> <span data-ttu-id="46e2c-387">They enable immediate pushes of messages from IoT Hub to the device.</span><span class="sxs-lookup"><span data-stu-id="46e2c-387">They enable immediate pushes of messages from IoT Hub to the device.</span></span> <span data-ttu-id="46e2c-388">If delivery latency is a concern, MQTT or AMQP are the best protocols to use.</span><span class="sxs-lookup"><span data-stu-id="46e2c-388">If delivery latency is a concern, MQTT or AMQP are the best protocols to use.</span></span> <span data-ttu-id="46e2c-389">For rarely connected devices, HTTP works as well.</span><span class="sxs-lookup"><span data-stu-id="46e2c-389">For rarely connected devices, HTTP works as well.</span></span>
* <span data-ttu-id="46e2c-390">**Field gateways**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-390">**Field gateways**.</span></span> <span data-ttu-id="46e2c-391">When using MQTT and HTTP, you cannot connect multiple devices (each with its own per-device credentials) using the same TLS connection.</span><span class="sxs-lookup"><span data-stu-id="46e2c-391">When using MQTT and HTTP, you cannot connect multiple devices (each with its own per-device credentials) using the same TLS connection.</span></span> <span data-ttu-id="46e2c-392">Thus, for [Field gateway scenarios][lnk-azure-gateway-guidance], these protocols are suboptimal because they require one TLS connection between the field gateway and IoT Hub for each device connected to the field gateway.</span><span class="sxs-lookup"><span data-stu-id="46e2c-392">Thus, for [Field gateway scenarios][lnk-azure-gateway-guidance], these protocols are suboptimal because they require one TLS connection between the field gateway and IoT Hub for each device connected to the field gateway.</span></span>
* <span data-ttu-id="46e2c-393">**Low resource devices**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-393">**Low resource devices**.</span></span> <span data-ttu-id="46e2c-394">The MQTT and HTTP libraries have a smaller footprint than the AMQP libraries.</span><span class="sxs-lookup"><span data-stu-id="46e2c-394">The MQTT and HTTP libraries have a smaller footprint than the AMQP libraries.</span></span> <span data-ttu-id="46e2c-395">As such, if the device has limited resources (for example, less than 1 MB RAM), these protocols might be the only protocol implementation available.</span><span class="sxs-lookup"><span data-stu-id="46e2c-395">As such, if the device has limited resources (for example, less than 1 MB RAM), these protocols might be the only protocol implementation available.</span></span>
* <span data-ttu-id="46e2c-396">**Network traversal**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-396">**Network traversal**.</span></span> <span data-ttu-id="46e2c-397">The standard AMQP protocol uses port 5671, while MQTT listens on port 8883, which could cause problems in networks that are closed to non-HTTP protocols.</span><span class="sxs-lookup"><span data-stu-id="46e2c-397">The standard AMQP protocol uses port 5671, while MQTT listens on port 8883, which could cause problems in networks that are closed to non-HTTP protocols.</span></span> <span data-ttu-id="46e2c-398">MQTT over WebSockets, AMQP over WebSockets, and HTTP are available to be used in this scenario.</span><span class="sxs-lookup"><span data-stu-id="46e2c-398">MQTT over WebSockets, AMQP over WebSockets, and HTTP are available to be used in this scenario.</span></span>
* <span data-ttu-id="46e2c-399">**Payload size**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-399">**Payload size**.</span></span> <span data-ttu-id="46e2c-400">MQTT and AMQP are binary protocols, which result in more compact payloads than HTTP.</span><span class="sxs-lookup"><span data-stu-id="46e2c-400">MQTT and AMQP are binary protocols, which result in more compact payloads than HTTP.</span></span>

> [!NOTE]
> <span data-ttu-id="46e2c-401">When using HTTP, each device should poll for cloud-to-device messages every 25 minutes or more.</span><span class="sxs-lookup"><span data-stu-id="46e2c-401">When using HTTP, each device should poll for cloud-to-device messages every 25 minutes or more.</span></span> <span data-ttu-id="46e2c-402">However, during development, it is acceptable to poll more frequently than every 25 minutes.</span><span class="sxs-lookup"><span data-stu-id="46e2c-402">However, during development, it is acceptable to poll more frequently than every 25 minutes.</span></span>
> 
> 

## <a name="port-numbers"></a><span data-ttu-id="46e2c-403">Port numbers</span><span class="sxs-lookup"><span data-stu-id="46e2c-403">Port numbers</span></span>
<span data-ttu-id="46e2c-404">Devices can communicate with IoT Hub in Azure using various protocols.</span><span class="sxs-lookup"><span data-stu-id="46e2c-404">Devices can communicate with IoT Hub in Azure using various protocols.</span></span> <span data-ttu-id="46e2c-405">Typically, the choice of protocol is driven by the specific requirements of the solution.</span><span class="sxs-lookup"><span data-stu-id="46e2c-405">Typically, the choice of protocol is driven by the specific requirements of the solution.</span></span> <span data-ttu-id="46e2c-406">The following table lists the outbound ports that must be open for a device to be able to use a specific protocol:</span><span class="sxs-lookup"><span data-stu-id="46e2c-406">The following table lists the outbound ports that must be open for a device to be able to use a specific protocol:</span></span>

| <span data-ttu-id="46e2c-407">Protocol</span><span class="sxs-lookup"><span data-stu-id="46e2c-407">Protocol</span></span> | <span data-ttu-id="46e2c-408">Port</span><span class="sxs-lookup"><span data-stu-id="46e2c-408">Port</span></span> |
| --- | --- |
| <span data-ttu-id="46e2c-409">MQTT</span><span class="sxs-lookup"><span data-stu-id="46e2c-409">MQTT</span></span> |<span data-ttu-id="46e2c-410">8883</span><span class="sxs-lookup"><span data-stu-id="46e2c-410">8883</span></span> |
| <span data-ttu-id="46e2c-411">MQTT over WebSockets</span><span class="sxs-lookup"><span data-stu-id="46e2c-411">MQTT over WebSockets</span></span> |<span data-ttu-id="46e2c-412">443</span><span class="sxs-lookup"><span data-stu-id="46e2c-412">443</span></span> |
| <span data-ttu-id="46e2c-413">AMQP</span><span class="sxs-lookup"><span data-stu-id="46e2c-413">AMQP</span></span> |<span data-ttu-id="46e2c-414">5671</span><span class="sxs-lookup"><span data-stu-id="46e2c-414">5671</span></span> |
| <span data-ttu-id="46e2c-415">AMQP over WebSockets</span><span class="sxs-lookup"><span data-stu-id="46e2c-415">AMQP over WebSockets</span></span> |<span data-ttu-id="46e2c-416">443</span><span class="sxs-lookup"><span data-stu-id="46e2c-416">443</span></span> |
| <span data-ttu-id="46e2c-417">HTTP</span><span class="sxs-lookup"><span data-stu-id="46e2c-417">HTTP</span></span> |<span data-ttu-id="46e2c-418">443</span><span class="sxs-lookup"><span data-stu-id="46e2c-418">443</span></span> |
| <span data-ttu-id="46e2c-419">LWM2M (Device management)</span><span class="sxs-lookup"><span data-stu-id="46e2c-419">LWM2M (Device management)</span></span> |<span data-ttu-id="46e2c-420">5684</span><span class="sxs-lookup"><span data-stu-id="46e2c-420">5684</span></span> |

<span data-ttu-id="46e2c-421">Once you have created an IoT hub in an Azure region, the IoT hub keeps the same IP address for the lifetime of that IoT hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-421">Once you have created an IoT hub in an Azure region, the IoT hub keeps the same IP address for the lifetime of that IoT hub.</span></span> <span data-ttu-id="46e2c-422">However, to maintain quality of service, if Microsoft moves the IoT hub to a different scale unit then it is assigned a new IP address.</span><span class="sxs-lookup"><span data-stu-id="46e2c-422">However, to maintain quality of service, if Microsoft moves the IoT hub to a different scale unit then it is assigned a new IP address.</span></span>

## <a name="notes-on-mqtt-support"></a><span data-ttu-id="46e2c-423">Notes on MQTT support</span><span class="sxs-lookup"><span data-stu-id="46e2c-423">Notes on MQTT support</span></span>
<span data-ttu-id="46e2c-424">IoT Hub implements the MQTT v3.1.1 protocol with the following limitations and specific behavior:</span><span class="sxs-lookup"><span data-stu-id="46e2c-424">IoT Hub implements the MQTT v3.1.1 protocol with the following limitations and specific behavior:</span></span>

* <span data-ttu-id="46e2c-425">**QoS 2 is not supported**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-425">**QoS 2 is not supported**.</span></span> <span data-ttu-id="46e2c-426">When a device app publishes a message with **QoS 2**, IoT Hub closes the network connection.</span><span class="sxs-lookup"><span data-stu-id="46e2c-426">When a device app publishes a message with **QoS 2**, IoT Hub closes the network connection.</span></span> <span data-ttu-id="46e2c-427">When a device app subscribes to a topic with **QoS 2**, IoT Hub grants maximum QoS level 1 in the **SUBACK** packet.</span><span class="sxs-lookup"><span data-stu-id="46e2c-427">When a device app subscribes to a topic with **QoS 2**, IoT Hub grants maximum QoS level 1 in the **SUBACK** packet.</span></span>
* <span data-ttu-id="46e2c-428">**Retain messages do not persist**.</span><span class="sxs-lookup"><span data-stu-id="46e2c-428">**Retain messages do not persist**.</span></span> <span data-ttu-id="46e2c-429">If a device app publishes a message with the RETAIN flag set to 1, IoT Hub adds the **x-opt-retain** application property to the message.</span><span class="sxs-lookup"><span data-stu-id="46e2c-429">If a device app publishes a message with the RETAIN flag set to 1, IoT Hub adds the **x-opt-retain** application property to the message.</span></span> <span data-ttu-id="46e2c-430">In this case, IoT Hub does not persist the retain message, but instead passes it to the back-end app.</span><span class="sxs-lookup"><span data-stu-id="46e2c-430">In this case, IoT Hub does not persist the retain message, but instead passes it to the back-end app.</span></span>

<span data-ttu-id="46e2c-431">For more information, see [IoT Hub MQTT support][lnk-devguide-mqtt].</span><span class="sxs-lookup"><span data-stu-id="46e2c-431">For more information, see [IoT Hub MQTT support][lnk-devguide-mqtt].</span></span>

<span data-ttu-id="46e2c-432">As a final consideration, you should review the [Azure IoT protocol gateway][lnk-azure-protocol-gateway] that enables you to deploy a high-performance custom protocol gateway that interfaces directly with IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-432">As a final consideration, you should review the [Azure IoT protocol gateway][lnk-azure-protocol-gateway] that enables you to deploy a high-performance custom protocol gateway that interfaces directly with IoT Hub.</span></span> <span data-ttu-id="46e2c-433">The Azure IoT protocol gateway enables you to customize the device protocol to accommodate brownfield MQTT deployments or other custom protocols.</span><span class="sxs-lookup"><span data-stu-id="46e2c-433">The Azure IoT protocol gateway enables you to customize the device protocol to accommodate brownfield MQTT deployments or other custom protocols.</span></span> <span data-ttu-id="46e2c-434">This approach does require, however, that you run and operate a custom protocol gateway.</span><span class="sxs-lookup"><span data-stu-id="46e2c-434">This approach does require, however, that you run and operate a custom protocol gateway.</span></span>

## <a name="additional-reference-material"></a><span data-ttu-id="46e2c-435">Additional reference material</span><span class="sxs-lookup"><span data-stu-id="46e2c-435">Additional reference material</span></span>
<span data-ttu-id="46e2c-436">Other reference topics in the IoT Hub developer guide include:</span><span class="sxs-lookup"><span data-stu-id="46e2c-436">Other reference topics in the IoT Hub developer guide include:</span></span>

* <span data-ttu-id="46e2c-437">[IoT Hub endpoints][lnk-endpoints] describes the various endpoints that each IoT hub exposes for run-time and management operations.</span><span class="sxs-lookup"><span data-stu-id="46e2c-437">[IoT Hub endpoints][lnk-endpoints] describes the various endpoints that each IoT hub exposes for run-time and management operations.</span></span>
* <span data-ttu-id="46e2c-438">[Throttling and quotas][lnk-quotas] describes the quotas that apply to the IoT Hub service and the throttling behavior to expect when you use the service.</span><span class="sxs-lookup"><span data-stu-id="46e2c-438">[Throttling and quotas][lnk-quotas] describes the quotas that apply to the IoT Hub service and the throttling behavior to expect when you use the service.</span></span>
* <span data-ttu-id="46e2c-439">[Azure IoT device and service SDKs][lnk-sdks] lists the various language SDKs you can use when you develop both device and service apps that interact with IoT Hub.</span><span class="sxs-lookup"><span data-stu-id="46e2c-439">[Azure IoT device and service SDKs][lnk-sdks] lists the various language SDKs you can use when you develop both device and service apps that interact with IoT Hub.</span></span>
* <span data-ttu-id="46e2c-440">[IoT Hub query language for device twins and jobs][lnk-query] describes the IoT Hub query language you can use to retrieve information from IoT Hub about your device twins and jobs.</span><span class="sxs-lookup"><span data-stu-id="46e2c-440">[IoT Hub query language for device twins and jobs][lnk-query] describes the IoT Hub query language you can use to retrieve information from IoT Hub about your device twins and jobs.</span></span>
* <span data-ttu-id="46e2c-441">[IoT Hub MQTT support][lnk-devguide-mqtt] provides more information about IoT Hub support for the MQTT protocol.</span><span class="sxs-lookup"><span data-stu-id="46e2c-441">[IoT Hub MQTT support][lnk-devguide-mqtt] provides more information about IoT Hub support for the MQTT protocol.</span></span>

## <a name="next-steps"></a><span data-ttu-id="46e2c-442">Next steps</span><span class="sxs-lookup"><span data-stu-id="46e2c-442">Next steps</span></span>
<span data-ttu-id="46e2c-443">Now you have learned how to send and receive messages with IoT Hub, you may be interested in the following IoT Hub developer guide topics:</span><span class="sxs-lookup"><span data-stu-id="46e2c-443">Now you have learned how to send and receive messages with IoT Hub, you may be interested in the following IoT Hub developer guide topics:</span></span>

* <span data-ttu-id="46e2c-444">[Upload files from a device][lnk-devguide-upload]</span><span class="sxs-lookup"><span data-stu-id="46e2c-444">[Upload files from a device][lnk-devguide-upload]</span></span>
* <span data-ttu-id="46e2c-445">[Manage device identities in IoT Hub][lnk-devguide-identities]</span><span class="sxs-lookup"><span data-stu-id="46e2c-445">[Manage device identities in IoT Hub][lnk-devguide-identities]</span></span>
* <span data-ttu-id="46e2c-446">[Control access to IoT Hub][lnk-devguide-security]</span><span class="sxs-lookup"><span data-stu-id="46e2c-446">[Control access to IoT Hub][lnk-devguide-security]</span></span>
* <span data-ttu-id="46e2c-447">[Use device twins to synchronize state and configurations][lnk-devguide-device-twins]</span><span class="sxs-lookup"><span data-stu-id="46e2c-447">[Use device twins to synchronize state and configurations][lnk-devguide-device-twins]</span></span>
* <span data-ttu-id="46e2c-448">[Invoke a direct method on a device][lnk-devguide-directmethods]</span><span class="sxs-lookup"><span data-stu-id="46e2c-448">[Invoke a direct method on a device][lnk-devguide-directmethods]</span></span>
* <span data-ttu-id="46e2c-449">[Schedule jobs on multiple devices][lnk-devguide-jobs]</span><span class="sxs-lookup"><span data-stu-id="46e2c-449">[Schedule jobs on multiple devices][lnk-devguide-jobs]</span></span>

<span data-ttu-id="46e2c-450">If you would like to try out some of the concepts described in this article, you may be interested in the following IoT Hub tutorials:</span><span class="sxs-lookup"><span data-stu-id="46e2c-450">If you would like to try out some of the concepts described in this article, you may be interested in the following IoT Hub tutorials:</span></span>

* <span data-ttu-id="46e2c-451">[Get started with Azure IoT Hub][lnk-getstarted-tutorial]</span><span class="sxs-lookup"><span data-stu-id="46e2c-451">[Get started with Azure IoT Hub][lnk-getstarted-tutorial]</span></span>
* <span data-ttu-id="46e2c-452">[How to send cloud-to-device messages with IoT Hub][lnk-c2d-tutorial]</span><span class="sxs-lookup"><span data-stu-id="46e2c-452">[How to send cloud-to-device messages with IoT Hub][lnk-c2d-tutorial]</span></span>
* <span data-ttu-id="46e2c-453">[How to process IoT Hub device-to-cloud messages][lnk-d2c-tutorial]</span><span class="sxs-lookup"><span data-stu-id="46e2c-453">[How to process IoT Hub device-to-cloud messages][lnk-d2c-tutorial]</span></span>

[img-lifecycle]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/iot-hub/media/iot-hub-devguide-messaging/lifecycle.png
[img-eventhubcompatible]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/iot-hub/media/iot-hub-devguide-messaging/eventhubcompatible.png

[lnk-resource-provider-apis]: https://msdn.microsoft.com/library/mt548492.aspx
[lnk-azure-gateway-guidance]: iot-hub-devguide-endpoints.md#field-gateways
[lnk-guidance-scale]: iot-hub-scaling.md
[lnk-azure-protocol-gateway]: iot-hub-protocol-gateway.md
[lnk-amqp]: http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-complete-v1.0-os.pdf
[lnk-mqtt]: http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.pdf
[lnk-event-hubs]: http://azure.microsoft.com/documentation/services/event-hubs/
[lnk-event-hubs-consuming-events]: ../event-hubs/event-hubs-programming-guide.md#event-consumers
[lnk-management-portal]: https://portal.azure.com
[lnk-servicebus]: http://azure.microsoft.com/documentation/services/service-bus/
[lnk-eventhub-partitions]: ../event-hubs/event-hubs-overview.md#partitions
[lnk-portal]: iot-hub-create-through-portal.md
[lnk-getstarted-eh]: ../event-hubs/event-hubs-csharp-ephcs-getstarted.md
[lnk-getstarted-queue]: ../service-bus-messaging/service-bus-dotnet-get-started-with-queues.md
[lnk-getstarted-topic]: ../service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions.md

[lnk-c2d-guidance]: iot-hub-devguide-c2d-guidance.md
[lnk-d2c-guidance]: iot-hub-devguide-d2c-guidance.md

[lnk-endpoints]: iot-hub-devguide-endpoints.md
[lnk-quotas]: iot-hub-devguide-quotas-throttling.md
[lnk-sdks]: iot-hub-devguide-sdks.md
[lnk-query]: iot-hub-devguide-query-language.md
[lnk-devguide-mqtt]: iot-hub-mqtt-support.md
[lnk-d2c]: iot-hub-devguide-messaging.md#device-to-cloud-messages
[lnk-c2d]: iot-hub-devguide-messaging.md#cloud-to-device-messages
[lnk-compatible-endpoint]: iot-hub-devguide-messaging.md#read-device-to-cloud-messages
[lnk-protocols]: iot-hub-devguide-messaging.md#communication-protocols
[lnk-message-format]: iot-hub-devguide-messaging.md#message-format
[lnk-device-properties]: iot-hub-devguide-identity-registry.md#device-identity-properties
[lnk-ttl]: iot-hub-devguide-messaging.md#message-expiration-time-to-live
[lnk-c2d-configuration]: iot-hub-devguide-messaging.md#cloud-to-device-configuration-options
[lnk-lifecycle]: iot-hub-devguide-messaging.md#message-lifecycle
[lnk-feedback]: iot-hub-devguide-messaging.md#message-feedback
[lnk-antispoofing]: iot-hub-devguide-messaging.md#anti-spoofing-properties
[lnk-compare]: iot-hub-compare-event-hubs.md

[lnk-devguide-upload]: iot-hub-devguide-file-upload.md
[lnk-devguide-identities]: iot-hub-devguide-identity-registry.md
[lnk-devguide-security]: iot-hub-devguide-security.md
[lnk-devguide-device-twins]: iot-hub-devguide-device-twins.md
[lnk-devguide-directmethods]: iot-hub-devguide-direct-methods.md
[lnk-devguide-jobs]: iot-hub-devguide-jobs.md
[lnk-servicebus-sdk]: https://www.nuget.org/packages/WindowsAzure.ServiceBus
[lnk-eventprocessorhost]: http://blogs.msdn.com/b/servicebus/archive/2015/01/16/event-processor-host-best-practices-part-1.aspx
[lnk-devguide-query-language]: iot-hub-devguide-query-language.md
[lnk-devguide-endpoints]: iot-hub-devguide-endpoints.md

[lnk-getstarted-tutorial]: iot-hub-csharp-csharp-getstarted.md
[lnk-c2d-tutorial]: iot-hub-csharp-csharp-c2d.md
[lnk-d2c-tutorial]: iot-hub-csharp-csharp-process-d2c.md
[lnk-event-hub-partitions]: ../event-hubs/event-hubs-what-is-event-hubs.md#partitions


