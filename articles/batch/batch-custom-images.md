---
title: Provision Azure Batch pools from custom images | Microsoft Docs
description: You can create a Batch pool from a custom image to provision compute nodes that contain the software and data that you need for your application. Custom images are an efficient way to configure compute nodes to run your Batch workloads.
services: batch
author: dlepow
manager: jeconnoc
ms.service: batch
ms.topic: article
ms.date: 04/23/2018
ms.author: danlep
ms.openlocfilehash: 78bc50a1189d8f42281f81643a5e907d94480082
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44866820"
---
# <a name="use-a-managed-custom-image-to-create-a-pool-of-virtual-machines"></a><span data-ttu-id="655dd-104">Use a managed custom image to create a pool of virtual machines</span><span class="sxs-lookup"><span data-stu-id="655dd-104">Use a managed custom image to create a pool of virtual machines</span></span> 

<span data-ttu-id="655dd-105">When you create an Azure Batch pool using the Virtual Machine Configuration, you specify a VM image that provides the operating system for each compute node in the pool.</span><span class="sxs-lookup"><span data-stu-id="655dd-105">When you create an Azure Batch pool using the Virtual Machine Configuration, you specify a VM image that provides the operating system for each compute node in the pool.</span></span> <span data-ttu-id="655dd-106">You can create a pool of virtual machines either with an Azure Marketplace image, or with a custom image (a VM image you have created and configured yourself).</span><span class="sxs-lookup"><span data-stu-id="655dd-106">You can create a pool of virtual machines either with an Azure Marketplace image, or with a custom image (a VM image you have created and configured yourself).</span></span> <span data-ttu-id="655dd-107">The custom image must be a *managed image* resource in the same Azure subscription and region as the Batch account.</span><span class="sxs-lookup"><span data-stu-id="655dd-107">The custom image must be a *managed image* resource in the same Azure subscription and region as the Batch account.</span></span>

## <a name="why-use-a-custom-image"></a><span data-ttu-id="655dd-108">Why use a custom image?</span><span class="sxs-lookup"><span data-stu-id="655dd-108">Why use a custom image?</span></span>
<span data-ttu-id="655dd-109">When you provide a custom image, you have control over the operating system configuration and the type of operating system and data disks to be used.</span><span class="sxs-lookup"><span data-stu-id="655dd-109">When you provide a custom image, you have control over the operating system configuration and the type of operating system and data disks to be used.</span></span> <span data-ttu-id="655dd-110">Your custom image can include applications and reference data that become available on all the Batch pool nodes as soon as they are provisioned.</span><span class="sxs-lookup"><span data-stu-id="655dd-110">Your custom image can include applications and reference data that become available on all the Batch pool nodes as soon as they are provisioned.</span></span>

<span data-ttu-id="655dd-111">Using a custom image saves time in preparing your pool's compute nodes to run your Batch workload.</span><span class="sxs-lookup"><span data-stu-id="655dd-111">Using a custom image saves time in preparing your pool's compute nodes to run your Batch workload.</span></span> <span data-ttu-id="655dd-112">While you can use an Azure Marketplace image and install software on each compute node after provisioning, using a custom image might be more efficient.</span><span class="sxs-lookup"><span data-stu-id="655dd-112">While you can use an Azure Marketplace image and install software on each compute node after provisioning, using a custom image might be more efficient.</span></span>

<span data-ttu-id="655dd-113">Using a custom image configured for your scenario can provide several advantages:</span><span class="sxs-lookup"><span data-stu-id="655dd-113">Using a custom image configured for your scenario can provide several advantages:</span></span>

- <span data-ttu-id="655dd-114">**Configure the operating system (OS)**.</span><span class="sxs-lookup"><span data-stu-id="655dd-114">**Configure the operating system (OS)**.</span></span> <span data-ttu-id="655dd-115">You can perform special configuration of the operating system on the custom image's operating system disk.</span><span class="sxs-lookup"><span data-stu-id="655dd-115">You can perform special configuration of the operating system on the custom image's operating system disk.</span></span> 
- <span data-ttu-id="655dd-116">**Pre-install applications.**</span><span class="sxs-lookup"><span data-stu-id="655dd-116">**Pre-install applications.**</span></span> <span data-ttu-id="655dd-117">You can create a custom image with pre-installed applications on the OS disk, which is more efficient and less error-prone than installing applications after provisioning the compute nodes using StartTask.</span><span class="sxs-lookup"><span data-stu-id="655dd-117">You can create a custom image with pre-installed applications on the OS disk, which is more efficient and less error-prone than installing applications after provisioning the compute nodes using StartTask.</span></span>
- <span data-ttu-id="655dd-118">**Save reboot time on VMs.**</span><span class="sxs-lookup"><span data-stu-id="655dd-118">**Save reboot time on VMs.**</span></span> <span data-ttu-id="655dd-119">Application installation typically requires rebooting the VM, which is time-consuming.</span><span class="sxs-lookup"><span data-stu-id="655dd-119">Application installation typically requires rebooting the VM, which is time-consuming.</span></span> <span data-ttu-id="655dd-120">You can save reboot time by pre-installing applications.</span><span class="sxs-lookup"><span data-stu-id="655dd-120">You can save reboot time by pre-installing applications.</span></span> 
- <span data-ttu-id="655dd-121">**Copy very large amounts of data once.**</span><span class="sxs-lookup"><span data-stu-id="655dd-121">**Copy very large amounts of data once.**</span></span> <span data-ttu-id="655dd-122">You can make static data part of the managed custom image by copying it to a managed image's data disks.</span><span class="sxs-lookup"><span data-stu-id="655dd-122">You can make static data part of the managed custom image by copying it to a managed image's data disks.</span></span> <span data-ttu-id="655dd-123">This only needs to be done once and makes data available to each node of the pool.</span><span class="sxs-lookup"><span data-stu-id="655dd-123">This only needs to be done once and makes data available to each node of the pool.</span></span>
- <span data-ttu-id="655dd-124">**Choice of disk types.**</span><span class="sxs-lookup"><span data-stu-id="655dd-124">**Choice of disk types.**</span></span> <span data-ttu-id="655dd-125">You can create a managed custom image from a VHD, from a managed disk of an Azure VM, a snapshot of these disks, or your own Linux or Windows installation that you have configured.</span><span class="sxs-lookup"><span data-stu-id="655dd-125">You can create a managed custom image from a VHD, from a managed disk of an Azure VM, a snapshot of these disks, or your own Linux or Windows installation that you have configured.</span></span> <span data-ttu-id="655dd-126">You have the choice of using premium storage for the OS disk and the data disk.</span><span class="sxs-lookup"><span data-stu-id="655dd-126">You have the choice of using premium storage for the OS disk and the data disk.</span></span>
- <span data-ttu-id="655dd-127">**Grow pools to any size.**</span><span class="sxs-lookup"><span data-stu-id="655dd-127">**Grow pools to any size.**</span></span> <span data-ttu-id="655dd-128">When you use a managed custom image to create a pool, the pool can grow to any size you request.</span><span class="sxs-lookup"><span data-stu-id="655dd-128">When you use a managed custom image to create a pool, the pool can grow to any size you request.</span></span> <span data-ttu-id="655dd-129">You do not need to make copies of image blob VHDs to accommodate the number of VMs.</span><span class="sxs-lookup"><span data-stu-id="655dd-129">You do not need to make copies of image blob VHDs to accommodate the number of VMs.</span></span> 


## <a name="prerequisites"></a><span data-ttu-id="655dd-130">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="655dd-130">Prerequisites</span></span>

- <span data-ttu-id="655dd-131">**A managed image resource**.</span><span class="sxs-lookup"><span data-stu-id="655dd-131">**A managed image resource**.</span></span> <span data-ttu-id="655dd-132">To create a pool of virtual machines using a custom image, you need to create a managed image resource in the same Azure subscription and region as the Batch account.</span><span class="sxs-lookup"><span data-stu-id="655dd-132">To create a pool of virtual machines using a custom image, you need to create a managed image resource in the same Azure subscription and region as the Batch account.</span></span> <span data-ttu-id="655dd-133">For options to prepare a managed image, see the following section.</span><span class="sxs-lookup"><span data-stu-id="655dd-133">For options to prepare a managed image, see the following section.</span></span>
- <span data-ttu-id="655dd-134">**Azure Active Directory (AAD) authentication**.</span><span class="sxs-lookup"><span data-stu-id="655dd-134">**Azure Active Directory (AAD) authentication**.</span></span> <span data-ttu-id="655dd-135">The Batch client API must use AAD authentication.</span><span class="sxs-lookup"><span data-stu-id="655dd-135">The Batch client API must use AAD authentication.</span></span> <span data-ttu-id="655dd-136">Azure Batch support for AAD is documented in [Authenticate Batch service solutions with Active Directory](batch-aad-auth.md).</span><span class="sxs-lookup"><span data-stu-id="655dd-136">Azure Batch support for AAD is documented in [Authenticate Batch service solutions with Active Directory](batch-aad-auth.md).</span></span>

    
## <a name="prepare-a-custom-image"></a><span data-ttu-id="655dd-137">Prepare a custom image</span><span class="sxs-lookup"><span data-stu-id="655dd-137">Prepare a custom image</span></span>
<span data-ttu-id="655dd-138">You can prepare a managed image from a VHD, from an Azure VM with managed disks, or from a VM snapshot.</span><span class="sxs-lookup"><span data-stu-id="655dd-138">You can prepare a managed image from a VHD, from an Azure VM with managed disks, or from a VM snapshot.</span></span> <span data-ttu-id="655dd-139">For Batch, we recommend creating a managed image from a VM with managed disks or a VM snapshot.</span><span class="sxs-lookup"><span data-stu-id="655dd-139">For Batch, we recommend creating a managed image from a VM with managed disks or a VM snapshot.</span></span> <span data-ttu-id="655dd-140">The managed image and the underlying resource should exist for the pools to scale up and can be removed after the pool is deleted.</span><span class="sxs-lookup"><span data-stu-id="655dd-140">The managed image and the underlying resource should exist for the pools to scale up and can be removed after the pool is deleted.</span></span> 

<span data-ttu-id="655dd-141">When preparing your image, keep in mind the following points:</span><span class="sxs-lookup"><span data-stu-id="655dd-141">When preparing your image, keep in mind the following points:</span></span>

* <span data-ttu-id="655dd-142">Ensure that the base OS image you use to provision your Batch pools does not have any pre-installed Azure extensions, such as the Custom Script extension.</span><span class="sxs-lookup"><span data-stu-id="655dd-142">Ensure that the base OS image you use to provision your Batch pools does not have any pre-installed Azure extensions, such as the Custom Script extension.</span></span> <span data-ttu-id="655dd-143">If the image contains a pre-installed extension, Azure may encounter problems deploying the VM.</span><span class="sxs-lookup"><span data-stu-id="655dd-143">If the image contains a pre-installed extension, Azure may encounter problems deploying the VM.</span></span>
* <span data-ttu-id="655dd-144">Ensure that the base OS image you provide uses the default temp drive.</span><span class="sxs-lookup"><span data-stu-id="655dd-144">Ensure that the base OS image you provide uses the default temp drive.</span></span> <span data-ttu-id="655dd-145">The Batch node agent currently expects the default temp drive.</span><span class="sxs-lookup"><span data-stu-id="655dd-145">The Batch node agent currently expects the default temp drive.</span></span>
* <span data-ttu-id="655dd-146">The managed image resource referenced by a Batch Pool cannot be deleted for the lifetime of the pool.</span><span class="sxs-lookup"><span data-stu-id="655dd-146">The managed image resource referenced by a Batch Pool cannot be deleted for the lifetime of the pool.</span></span> <span data-ttu-id="655dd-147">If the managed image resource is deleted, then the pool cannot grow any further.</span><span class="sxs-lookup"><span data-stu-id="655dd-147">If the managed image resource is deleted, then the pool cannot grow any further.</span></span> 

### <a name="to-create-a-managed-image"></a><span data-ttu-id="655dd-148">To create a managed image</span><span class="sxs-lookup"><span data-stu-id="655dd-148">To create a managed image</span></span>
<span data-ttu-id="655dd-149">You can use any existing prepared Windows or Linux operating system disk to create a managed image.</span><span class="sxs-lookup"><span data-stu-id="655dd-149">You can use any existing prepared Windows or Linux operating system disk to create a managed image.</span></span> <span data-ttu-id="655dd-150">For example, if you wish to use a local image, then upload the local disk to an Azure Storage account that is in the same subscription and region as your Batch account using AzCopy or another upload tool.</span><span class="sxs-lookup"><span data-stu-id="655dd-150">For example, if you wish to use a local image, then upload the local disk to an Azure Storage account that is in the same subscription and region as your Batch account using AzCopy or another upload tool.</span></span> <span data-ttu-id="655dd-151">For detailed steps to upload a VHD and create a managed image, see the guidance for [Windows](../virtual-machines/windows/upload-generalized-managed.md) or [Linux](../virtual-machines/linux/upload-vhd.md) VMs.</span><span class="sxs-lookup"><span data-stu-id="655dd-151">For detailed steps to upload a VHD and create a managed image, see the guidance for [Windows](../virtual-machines/windows/upload-generalized-managed.md) or [Linux](../virtual-machines/linux/upload-vhd.md) VMs.</span></span>

<span data-ttu-id="655dd-152">You can also prepare a managed image from a new or existing Azure VM, or VM snapshot.</span><span class="sxs-lookup"><span data-stu-id="655dd-152">You can also prepare a managed image from a new or existing Azure VM, or VM snapshot.</span></span> 

* <span data-ttu-id="655dd-153">If you are creating a new VM, you can use an Azure Marketplace image as the base image for your managed image and then customize it.</span><span class="sxs-lookup"><span data-stu-id="655dd-153">If you are creating a new VM, you can use an Azure Marketplace image as the base image for your managed image and then customize it.</span></span> 

* <span data-ttu-id="655dd-154">If you plan to capture the image using the portal, ensure that the VM is created with a managed disk.</span><span class="sxs-lookup"><span data-stu-id="655dd-154">If you plan to capture the image using the portal, ensure that the VM is created with a managed disk.</span></span> <span data-ttu-id="655dd-155">This is the default storage setting when you create a VM.</span><span class="sxs-lookup"><span data-stu-id="655dd-155">This is the default storage setting when you create a VM.</span></span>

* <span data-ttu-id="655dd-156">Once the VM is running, connect to it via RDP (for Windows) or SSH (for Linux).</span><span class="sxs-lookup"><span data-stu-id="655dd-156">Once the VM is running, connect to it via RDP (for Windows) or SSH (for Linux).</span></span> <span data-ttu-id="655dd-157">Install any necessary software or copy desired data, and then generalize the VM.</span><span class="sxs-lookup"><span data-stu-id="655dd-157">Install any necessary software or copy desired data, and then generalize the VM.</span></span>  

<span data-ttu-id="655dd-158">For steps to generalize an Azure VM and create a managed image, see the guidance for [Windows](../virtual-machines/windows/capture-image-resource.md) or [Linux](../virtual-machines/linux/capture-image.md) VMs.</span><span class="sxs-lookup"><span data-stu-id="655dd-158">For steps to generalize an Azure VM and create a managed image, see the guidance for [Windows](../virtual-machines/windows/capture-image-resource.md) or [Linux](../virtual-machines/linux/capture-image.md) VMs.</span></span>

<span data-ttu-id="655dd-159">Depending on how you plan to create a Batch pool with the image, you need the following identifier for the image:</span><span class="sxs-lookup"><span data-stu-id="655dd-159">Depending on how you plan to create a Batch pool with the image, you need the following identifier for the image:</span></span>

* <span data-ttu-id="655dd-160">If you plan to create a pool with the image using the Batch APIs, the **resource ID** of the image, which is of the form `/subscriptions/xxxx-xxxxxx-xxxxx-xxxxxx/resourceGroups/myResourceGroup/providers/Microsoft.Compute/images/myImage`.</span><span class="sxs-lookup"><span data-stu-id="655dd-160">If you plan to create a pool with the image using the Batch APIs, the **resource ID** of the image, which is of the form `/subscriptions/xxxx-xxxxxx-xxxxx-xxxxxx/resourceGroups/myResourceGroup/providers/Microsoft.Compute/images/myImage`.</span></span> 
* <span data-ttu-id="655dd-161">If you plan to use the portal, the **name** of the image.</span><span class="sxs-lookup"><span data-stu-id="655dd-161">If you plan to use the portal, the **name** of the image.</span></span> 





## <a name="create-a-pool-from-a-custom-image-in-the-portal"></a><span data-ttu-id="655dd-162">Create a pool from a custom image in the portal</span><span class="sxs-lookup"><span data-stu-id="655dd-162">Create a pool from a custom image in the portal</span></span>

<span data-ttu-id="655dd-163">Once you have saved your custom image and you know its resource ID or name, you can create a Batch pool from that image.</span><span class="sxs-lookup"><span data-stu-id="655dd-163">Once you have saved your custom image and you know its resource ID or name, you can create a Batch pool from that image.</span></span> <span data-ttu-id="655dd-164">The following steps show you how to create a pool from the Azure portal.</span><span class="sxs-lookup"><span data-stu-id="655dd-164">The following steps show you how to create a pool from the Azure portal.</span></span>

> [!NOTE]
> <span data-ttu-id="655dd-165">If you are creating the pool using one of the Batch APIs, make sure that the identity you use for AAD authentication has permissions to the image resource.</span><span class="sxs-lookup"><span data-stu-id="655dd-165">If you are creating the pool using one of the Batch APIs, make sure that the identity you use for AAD authentication has permissions to the image resource.</span></span> <span data-ttu-id="655dd-166">See [Authenticate Batch service solutions with Active Directory](batch-aad-auth.md).</span><span class="sxs-lookup"><span data-stu-id="655dd-166">See [Authenticate Batch service solutions with Active Directory](batch-aad-auth.md).</span></span>
>

1. <span data-ttu-id="655dd-167">Navigate to your Batch account in the Azure portal.</span><span class="sxs-lookup"><span data-stu-id="655dd-167">Navigate to your Batch account in the Azure portal.</span></span> <span data-ttu-id="655dd-168">This account must be in the same subscription and region as the resource group containing the custom image.</span><span class="sxs-lookup"><span data-stu-id="655dd-168">This account must be in the same subscription and region as the resource group containing the custom image.</span></span> 
2. <span data-ttu-id="655dd-169">In the **Settings** window on the left, select the **Pools** menu item.</span><span class="sxs-lookup"><span data-stu-id="655dd-169">In the **Settings** window on the left, select the **Pools** menu item.</span></span>
3. <span data-ttu-id="655dd-170">In the **Pools** window, select the **Add** command.</span><span class="sxs-lookup"><span data-stu-id="655dd-170">In the **Pools** window, select the **Add** command.</span></span>
4. <span data-ttu-id="655dd-171">On the **Add Pool** window, select **Custom Image (Linux/Windows)** from the **Image Type** dropdown.</span><span class="sxs-lookup"><span data-stu-id="655dd-171">On the **Add Pool** window, select **Custom Image (Linux/Windows)** from the **Image Type** dropdown.</span></span> <span data-ttu-id="655dd-172">From the **Custom VM image** dropdown, select the image name (short form of the resource ID).</span><span class="sxs-lookup"><span data-stu-id="655dd-172">From the **Custom VM image** dropdown, select the image name (short form of the resource ID).</span></span>
5. <span data-ttu-id="655dd-173">Select the correct **Publisher/Offer/Sku** for your custom image.</span><span class="sxs-lookup"><span data-stu-id="655dd-173">Select the correct **Publisher/Offer/Sku** for your custom image.</span></span>
6. <span data-ttu-id="655dd-174">Specify the remaining required settings, including the **Node size**, **Target dedicated nodes**, and **Low priority nodes**, as well as any desired optional settings.</span><span class="sxs-lookup"><span data-stu-id="655dd-174">Specify the remaining required settings, including the **Node size**, **Target dedicated nodes**, and **Low priority nodes**, as well as any desired optional settings.</span></span>

    <span data-ttu-id="655dd-175">For example, for a Microsoft Windows Server Datacenter 2016 custom image, the **Add Pool** window appears as shown below:</span><span class="sxs-lookup"><span data-stu-id="655dd-175">For example, for a Microsoft Windows Server Datacenter 2016 custom image, the **Add Pool** window appears as shown below:</span></span>

    ![Add pool from custom Windows image](media/batch-custom-images/add-pool-custom-image.png)
  
<span data-ttu-id="655dd-177">To check whether an existing pool is based on a custom image, see the **Operating System** property in the resource summary section of the **Pool** window.</span><span class="sxs-lookup"><span data-stu-id="655dd-177">To check whether an existing pool is based on a custom image, see the **Operating System** property in the resource summary section of the **Pool** window.</span></span> <span data-ttu-id="655dd-178">If the pool was created from a custom image, it is set to **Custom VM Image**.</span><span class="sxs-lookup"><span data-stu-id="655dd-178">If the pool was created from a custom image, it is set to **Custom VM Image**.</span></span>

<span data-ttu-id="655dd-179">All custom images associated with a pool are displayed on the pool's **Properties** window.</span><span class="sxs-lookup"><span data-stu-id="655dd-179">All custom images associated with a pool are displayed on the pool's **Properties** window.</span></span>
 
## <a name="next-steps"></a><span data-ttu-id="655dd-180">Next steps</span><span class="sxs-lookup"><span data-stu-id="655dd-180">Next steps</span></span>

- <span data-ttu-id="655dd-181">For an in-depth overview of Batch, see [Develop large-scale parallel compute solutions with Batch](batch-api-basics.md).</span><span class="sxs-lookup"><span data-stu-id="655dd-181">For an in-depth overview of Batch, see [Develop large-scale parallel compute solutions with Batch](batch-api-basics.md).</span></span>
