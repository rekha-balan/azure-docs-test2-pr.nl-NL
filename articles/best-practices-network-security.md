---
title: Azure network security best practices | Microsoft Docs
description: Learn some of the key features available in Azure to help create secure network environments
services: virtual-network
documentationcenter: na
author: tracsman
manager: rossort
editor: ''
ms.assetid: d169387a-1243-4867-a602-01d6f2d8a2a1
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/03/2017
ms.author: jonor
ms.openlocfilehash: 37f70ad9dcf0d99cf67534fd1f1f74db8b0bfb72
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44663007"
---
# <a name="microsoft-cloud-services-and-network-security"></a><span data-ttu-id="a09a4-103">Microsoft cloud services and network security</span><span class="sxs-lookup"><span data-stu-id="a09a4-103">Microsoft cloud services and network security</span></span>
<span data-ttu-id="a09a4-104">Microsoft cloud services deliver hyper-scale services and infrastructure, enterprise-grade capabilities, and many choices for hybrid connectivity.</span><span class="sxs-lookup"><span data-stu-id="a09a4-104">Microsoft cloud services deliver hyper-scale services and infrastructure, enterprise-grade capabilities, and many choices for hybrid connectivity.</span></span> <span data-ttu-id="a09a4-105">Customers can choose to access these services either via the Internet or with Azure ExpressRoute, which provides private network connectivity.</span><span class="sxs-lookup"><span data-stu-id="a09a4-105">Customers can choose to access these services either via the Internet or with Azure ExpressRoute, which provides private network connectivity.</span></span> <span data-ttu-id="a09a4-106">The Microsoft Azure platform allows customers to seamlessly extend their infrastructure into the cloud and build multi-tier architectures.</span><span class="sxs-lookup"><span data-stu-id="a09a4-106">The Microsoft Azure platform allows customers to seamlessly extend their infrastructure into the cloud and build multi-tier architectures.</span></span> <span data-ttu-id="a09a4-107">Additionally, third parties can enable enhanced capabilities by offering security services and virtual appliances.</span><span class="sxs-lookup"><span data-stu-id="a09a4-107">Additionally, third parties can enable enhanced capabilities by offering security services and virtual appliances.</span></span> <span data-ttu-id="a09a4-108">This white paper provides an overview of security and architectural issues that customers should consider when using Microsoft cloud services accessed via ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="a09a4-108">This white paper provides an overview of security and architectural issues that customers should consider when using Microsoft cloud services accessed via ExpressRoute.</span></span> <span data-ttu-id="a09a4-109">It also covers creating more secure services in Azure virtual networks.</span><span class="sxs-lookup"><span data-stu-id="a09a4-109">It also covers creating more secure services in Azure virtual networks.</span></span>

## <a name="fast-start"></a><span data-ttu-id="a09a4-110">Fast start</span><span class="sxs-lookup"><span data-stu-id="a09a4-110">Fast start</span></span>
<span data-ttu-id="a09a4-111">The following logic chart can direct you to a specific example of the many security techniques available with the Azure platform.</span><span class="sxs-lookup"><span data-stu-id="a09a4-111">The following logic chart can direct you to a specific example of the many security techniques available with the Azure platform.</span></span> <span data-ttu-id="a09a4-112">For quick reference, find the example that best fits your case.</span><span class="sxs-lookup"><span data-stu-id="a09a4-112">For quick reference, find the example that best fits your case.</span></span> <span data-ttu-id="a09a4-113">For expanded explanations, continue reading through the paper.</span><span class="sxs-lookup"><span data-stu-id="a09a4-113">For expanded explanations, continue reading through the paper.</span></span>
<span data-ttu-id="a09a4-114">[![0]][0]</span><span class="sxs-lookup"><span data-stu-id="a09a4-114">[![0]][0]</span></span>

[<span data-ttu-id="a09a4-115">Example 1: Build a perimeter network (also known as DMZ, demilitarized zone, or screened subnet) to help protect applications with network security groups (NSGs).</span><span class="sxs-lookup"><span data-stu-id="a09a4-115">Example 1: Build a perimeter network (also known as DMZ, demilitarized zone, or screened subnet) to help protect applications with network security groups (NSGs).</span></span>](#example-1-build-a-perimeter-network-to-help-protect-applications-with-nsgs)</br>
[<span data-ttu-id="a09a4-116">Example 2: Build a perimeter network to help protect applications with a firewall and NSGs.</span><span class="sxs-lookup"><span data-stu-id="a09a4-116">Example 2: Build a perimeter network to help protect applications with a firewall and NSGs.</span></span>](#example-2-build-a-perimeter-network-to-help-protect-applications-with-a-firewall-and-nsgs)</br>
[<span data-ttu-id="a09a4-117">Example 3: Build a perimeter network to help protect networks with a firewall, user-defined route (UDR), and NSG.</span><span class="sxs-lookup"><span data-stu-id="a09a4-117">Example 3: Build a perimeter network to help protect networks with a firewall, user-defined route (UDR), and NSG.</span></span>](#example-3-build-a-perimeter-network-to-help-protect-networks-with-a-firewall-and-udr-and-nsg)</br>
[<span data-ttu-id="a09a4-118">Example 4: Add a hybrid connection with a site-to-site, virtual appliance virtual private network (VPN).</span><span class="sxs-lookup"><span data-stu-id="a09a4-118">Example 4: Add a hybrid connection with a site-to-site, virtual appliance virtual private network (VPN).</span></span>](#example-4-add-a-hybrid-connection-with-a-site-to-site-virtual-appliance-vpn)</br>
[<span data-ttu-id="a09a4-119">Example 5: Add a hybrid connection with a site-to-site, Azure VPN gateway.</span><span class="sxs-lookup"><span data-stu-id="a09a4-119">Example 5: Add a hybrid connection with a site-to-site, Azure VPN gateway.</span></span>](#example-5-add-a-hybrid-connection-with-a-site-to-site-azure-vpn-gateway)</br>
[<span data-ttu-id="a09a4-120">Example 6: Add a hybrid connection with ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="a09a4-120">Example 6: Add a hybrid connection with ExpressRoute.</span></span>](#example-6-add-a-hybrid-connection-with-expressroute)</br>
<span data-ttu-id="a09a4-121">Examples for adding connections between virtual networks, high availability, and service chaining will be added to this document over the next few months.</span><span class="sxs-lookup"><span data-stu-id="a09a4-121">Examples for adding connections between virtual networks, high availability, and service chaining will be added to this document over the next few months.</span></span>

## <a name="microsoft-compliance-and-infrastructure-protection"></a><span data-ttu-id="a09a4-122">Microsoft compliance and infrastructure protection</span><span class="sxs-lookup"><span data-stu-id="a09a4-122">Microsoft compliance and infrastructure protection</span></span>
<span data-ttu-id="a09a4-123">To help organizations comply with national, regional, and industry-specific requirements governing the collection and use of individuals’ data, Microsoft offers over 40 certifications and attestations.</span><span class="sxs-lookup"><span data-stu-id="a09a4-123">To help organizations comply with national, regional, and industry-specific requirements governing the collection and use of individuals’ data, Microsoft offers over 40 certifications and attestations.</span></span> <span data-ttu-id="a09a4-124">The most comprehensive set of any cloud service provider.</span><span class="sxs-lookup"><span data-stu-id="a09a4-124">The most comprehensive set of any cloud service provider.</span></span>

<span data-ttu-id="a09a4-125">For more information, see the compliance information on the [Microsoft Trust Center][TrustCenter].</span><span class="sxs-lookup"><span data-stu-id="a09a4-125">For more information, see the compliance information on the [Microsoft Trust Center][TrustCenter].</span></span>

<span data-ttu-id="a09a4-126">Microsoft has a comprehensive approach to protect cloud infrastructure needed to run hyper-scale global services.</span><span class="sxs-lookup"><span data-stu-id="a09a4-126">Microsoft has a comprehensive approach to protect cloud infrastructure needed to run hyper-scale global services.</span></span> <span data-ttu-id="a09a4-127">Microsoft cloud infrastructure includes hardware, software, networks, and administrative and operations staff, in addition to the physical data centers.</span><span class="sxs-lookup"><span data-stu-id="a09a4-127">Microsoft cloud infrastructure includes hardware, software, networks, and administrative and operations staff, in addition to the physical data centers.</span></span>

<span data-ttu-id="a09a4-128">![2]</span><span class="sxs-lookup"><span data-stu-id="a09a4-128">![2]</span></span>

<span data-ttu-id="a09a4-129">This approach provides a more secure foundation for customers to deploy their services in the Microsoft cloud.</span><span class="sxs-lookup"><span data-stu-id="a09a4-129">This approach provides a more secure foundation for customers to deploy their services in the Microsoft cloud.</span></span> <span data-ttu-id="a09a4-130">The next step is for customers to design and create a security architecture to protect these services.</span><span class="sxs-lookup"><span data-stu-id="a09a4-130">The next step is for customers to design and create a security architecture to protect these services.</span></span>

## <a name="traditional-security-architectures-and-perimeter-networks"></a><span data-ttu-id="a09a4-131">Traditional security architectures and perimeter networks</span><span class="sxs-lookup"><span data-stu-id="a09a4-131">Traditional security architectures and perimeter networks</span></span>
<span data-ttu-id="a09a4-132">Although Microsoft invests heavily in protecting the cloud infrastructure, customers must also protect their cloud services and resource groups.</span><span class="sxs-lookup"><span data-stu-id="a09a4-132">Although Microsoft invests heavily in protecting the cloud infrastructure, customers must also protect their cloud services and resource groups.</span></span> <span data-ttu-id="a09a4-133">A multilayered approach to security provides the best defense.</span><span class="sxs-lookup"><span data-stu-id="a09a4-133">A multilayered approach to security provides the best defense.</span></span> <span data-ttu-id="a09a4-134">A perimeter network security zone protects internal network resources from an untrusted network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-134">A perimeter network security zone protects internal network resources from an untrusted network.</span></span> <span data-ttu-id="a09a4-135">A perimeter network refers to the edges or parts of the network that sit between the Internet and the protected enterprise IT infrastructure.</span><span class="sxs-lookup"><span data-stu-id="a09a4-135">A perimeter network refers to the edges or parts of the network that sit between the Internet and the protected enterprise IT infrastructure.</span></span>

<span data-ttu-id="a09a4-136">In typical enterprise networks, the core infrastructure is heavily fortified at the perimeters, with multiple layers of security devices.</span><span class="sxs-lookup"><span data-stu-id="a09a4-136">In typical enterprise networks, the core infrastructure is heavily fortified at the perimeters, with multiple layers of security devices.</span></span> <span data-ttu-id="a09a4-137">The boundary of each layer consists of devices and policy enforcement points.</span><span class="sxs-lookup"><span data-stu-id="a09a4-137">The boundary of each layer consists of devices and policy enforcement points.</span></span> <span data-ttu-id="a09a4-138">Each layer can include a combination of the following network security devices: firewalls, Denial of Service (DoS) prevention, Intrusion Detection or Protection Systems (IDS/IPS), and VPN devices.</span><span class="sxs-lookup"><span data-stu-id="a09a4-138">Each layer can include a combination of the following network security devices: firewalls, Denial of Service (DoS) prevention, Intrusion Detection or Protection Systems (IDS/IPS), and VPN devices.</span></span> <span data-ttu-id="a09a4-139">Policy enforcement can take the form of firewall policies, access control lists (ACLs), or specific routing.</span><span class="sxs-lookup"><span data-stu-id="a09a4-139">Policy enforcement can take the form of firewall policies, access control lists (ACLs), or specific routing.</span></span> <span data-ttu-id="a09a4-140">The first line of defense in the network, directly accepting incoming traffic from the Internet, is a combination of these mechanisms to block attacks and harmful traffic while allowing legitimate requests further into the network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-140">The first line of defense in the network, directly accepting incoming traffic from the Internet, is a combination of these mechanisms to block attacks and harmful traffic while allowing legitimate requests further into the network.</span></span> <span data-ttu-id="a09a4-141">This traffic routes directly to resources in the perimeter network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-141">This traffic routes directly to resources in the perimeter network.</span></span> <span data-ttu-id="a09a4-142">That resource may then “talk” to resources deeper in the network, transiting the next boundary for validation first.</span><span class="sxs-lookup"><span data-stu-id="a09a4-142">That resource may then “talk” to resources deeper in the network, transiting the next boundary for validation first.</span></span> <span data-ttu-id="a09a4-143">The outermost layer is called the perimeter network because this part of the network is exposed to the Internet, usually with some form of protection on both sides.</span><span class="sxs-lookup"><span data-stu-id="a09a4-143">The outermost layer is called the perimeter network because this part of the network is exposed to the Internet, usually with some form of protection on both sides.</span></span> <span data-ttu-id="a09a4-144">The following figure shows an example of a single subnet perimeter network in a corporate network, with two security boundaries.</span><span class="sxs-lookup"><span data-stu-id="a09a4-144">The following figure shows an example of a single subnet perimeter network in a corporate network, with two security boundaries.</span></span>

<span data-ttu-id="a09a4-145">![3]</span><span class="sxs-lookup"><span data-stu-id="a09a4-145">![3]</span></span>

<span data-ttu-id="a09a4-146">There are many architectures used to implement a perimeter network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-146">There are many architectures used to implement a perimeter network.</span></span> <span data-ttu-id="a09a4-147">These architectures can range from a simple load balancer to a multiple-subnet perimeter network with varied mechanisms at each boundary to block traffic and protect the deeper layers of the corporate network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-147">These architectures can range from a simple load balancer to a multiple-subnet perimeter network with varied mechanisms at each boundary to block traffic and protect the deeper layers of the corporate network.</span></span> <span data-ttu-id="a09a4-148">How the perimeter network is built depends on the specific needs of the organization and its overall risk tolerance.</span><span class="sxs-lookup"><span data-stu-id="a09a4-148">How the perimeter network is built depends on the specific needs of the organization and its overall risk tolerance.</span></span>

<span data-ttu-id="a09a4-149">As customers move their workloads to public clouds, it is critical to support similar capabilities for perimeter network architecture in Azure to meet compliance and security requirements.</span><span class="sxs-lookup"><span data-stu-id="a09a4-149">As customers move their workloads to public clouds, it is critical to support similar capabilities for perimeter network architecture in Azure to meet compliance and security requirements.</span></span> <span data-ttu-id="a09a4-150">This document provides guidelines on how customers can build a secure network environment in Azure.</span><span class="sxs-lookup"><span data-stu-id="a09a4-150">This document provides guidelines on how customers can build a secure network environment in Azure.</span></span> <span data-ttu-id="a09a4-151">It focuses on the perimeter network, but also includes a comprehensive discussion of many aspects of network security.</span><span class="sxs-lookup"><span data-stu-id="a09a4-151">It focuses on the perimeter network, but also includes a comprehensive discussion of many aspects of network security.</span></span> <span data-ttu-id="a09a4-152">The following questions inform this discussion:</span><span class="sxs-lookup"><span data-stu-id="a09a4-152">The following questions inform this discussion:</span></span>

* <span data-ttu-id="a09a4-153">How can a perimeter network in Azure be built?</span><span class="sxs-lookup"><span data-stu-id="a09a4-153">How can a perimeter network in Azure be built?</span></span>
* <span data-ttu-id="a09a4-154">What are some of the Azure features available to build the perimeter network?</span><span class="sxs-lookup"><span data-stu-id="a09a4-154">What are some of the Azure features available to build the perimeter network?</span></span>
* <span data-ttu-id="a09a4-155">How can back-end workloads be protected?</span><span class="sxs-lookup"><span data-stu-id="a09a4-155">How can back-end workloads be protected?</span></span>
* <span data-ttu-id="a09a4-156">How are Internet communications controlled to the workloads in Azure?</span><span class="sxs-lookup"><span data-stu-id="a09a4-156">How are Internet communications controlled to the workloads in Azure?</span></span>
* <span data-ttu-id="a09a4-157">How can the on-premises networks be protected from deployments in Azure?</span><span class="sxs-lookup"><span data-stu-id="a09a4-157">How can the on-premises networks be protected from deployments in Azure?</span></span>
* <span data-ttu-id="a09a4-158">When should native Azure security features be used versus third-party appliances or services?</span><span class="sxs-lookup"><span data-stu-id="a09a4-158">When should native Azure security features be used versus third-party appliances or services?</span></span>

<span data-ttu-id="a09a4-159">The following diagram shows various layers of security Azure provides to customers.</span><span class="sxs-lookup"><span data-stu-id="a09a4-159">The following diagram shows various layers of security Azure provides to customers.</span></span> <span data-ttu-id="a09a4-160">These layers are both native in the Azure platform itself and customer-defined features:</span><span class="sxs-lookup"><span data-stu-id="a09a4-160">These layers are both native in the Azure platform itself and customer-defined features:</span></span>

<span data-ttu-id="a09a4-161">![4]</span><span class="sxs-lookup"><span data-stu-id="a09a4-161">![4]</span></span>

<span data-ttu-id="a09a4-162">Inbound from the Internet, Azure DDoS helps protect against large-scale attacks against Azure.</span><span class="sxs-lookup"><span data-stu-id="a09a4-162">Inbound from the Internet, Azure DDoS helps protect against large-scale attacks against Azure.</span></span> <span data-ttu-id="a09a4-163">The next layer is customer-defined public IP addresses (endpoints), which are used to determine which traffic can pass through the cloud service to the virtual network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-163">The next layer is customer-defined public IP addresses (endpoints), which are used to determine which traffic can pass through the cloud service to the virtual network.</span></span> <span data-ttu-id="a09a4-164">Native Azure virtual network isolation ensures complete isolation from all other networks and that traffic only flows through user configured paths and methods.</span><span class="sxs-lookup"><span data-stu-id="a09a4-164">Native Azure virtual network isolation ensures complete isolation from all other networks and that traffic only flows through user configured paths and methods.</span></span> <span data-ttu-id="a09a4-165">These paths and methods are the next layer, where NSGs, UDR, and network virtual appliances can be used to create security boundaries to protect the application deployments in the protected network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-165">These paths and methods are the next layer, where NSGs, UDR, and network virtual appliances can be used to create security boundaries to protect the application deployments in the protected network.</span></span>

<span data-ttu-id="a09a4-166">The next section provides an overview of Azure virtual networks.</span><span class="sxs-lookup"><span data-stu-id="a09a4-166">The next section provides an overview of Azure virtual networks.</span></span> <span data-ttu-id="a09a4-167">These virtual networks are created by customers, and are what their deployed workloads are connected to.</span><span class="sxs-lookup"><span data-stu-id="a09a4-167">These virtual networks are created by customers, and are what their deployed workloads are connected to.</span></span> <span data-ttu-id="a09a4-168">Virtual networks are the basis of all the network security features required to establish a perimeter network to protect customer deployments in Azure.</span><span class="sxs-lookup"><span data-stu-id="a09a4-168">Virtual networks are the basis of all the network security features required to establish a perimeter network to protect customer deployments in Azure.</span></span>

## <a name="overview-of-azure-virtual-networks"></a><span data-ttu-id="a09a4-169">Overview of Azure virtual networks</span><span class="sxs-lookup"><span data-stu-id="a09a4-169">Overview of Azure virtual networks</span></span>
<span data-ttu-id="a09a4-170">Before Internet traffic can get to the Azure virtual networks, there are two layers of security inherent to the Azure platform:</span><span class="sxs-lookup"><span data-stu-id="a09a4-170">Before Internet traffic can get to the Azure virtual networks, there are two layers of security inherent to the Azure platform:</span></span>

1.    <span data-ttu-id="a09a4-171">**DDoS protection**: DDoS protection is a layer of the Azure physical network that protects the Azure platform itself from large-scale Internet-based attacks.</span><span class="sxs-lookup"><span data-stu-id="a09a4-171">**DDoS protection**: DDoS protection is a layer of the Azure physical network that protects the Azure platform itself from large-scale Internet-based attacks.</span></span> <span data-ttu-id="a09a4-172">These attacks use multiple “bot” nodes in an attempt to overwhelm an Internet service.</span><span class="sxs-lookup"><span data-stu-id="a09a4-172">These attacks use multiple “bot” nodes in an attempt to overwhelm an Internet service.</span></span> <span data-ttu-id="a09a4-173">Azure has a robust DDoS protection mesh on all inbound, outbound, and cross-Azure region connectivity.</span><span class="sxs-lookup"><span data-stu-id="a09a4-173">Azure has a robust DDoS protection mesh on all inbound, outbound, and cross-Azure region connectivity.</span></span> <span data-ttu-id="a09a4-174">This DDoS protection layer has no user configurable attributes and is not accessible to the customer.</span><span class="sxs-lookup"><span data-stu-id="a09a4-174">This DDoS protection layer has no user configurable attributes and is not accessible to the customer.</span></span> <span data-ttu-id="a09a4-175">The DDoS protection layer protects Azure as a platform from large-scale attacks, it also monitors out-bound traffic and cross-Azure region traffic.</span><span class="sxs-lookup"><span data-stu-id="a09a4-175">The DDoS protection layer protects Azure as a platform from large-scale attacks, it also monitors out-bound traffic and cross-Azure region traffic.</span></span> <span data-ttu-id="a09a4-176">Using network virtual appliances on the VNet, additional layers of resilience can be configured by the customer against a smaller scale attack that doesn't trip the platform level protection.</span><span class="sxs-lookup"><span data-stu-id="a09a4-176">Using network virtual appliances on the VNet, additional layers of resilience can be configured by the customer against a smaller scale attack that doesn't trip the platform level protection.</span></span> <span data-ttu-id="a09a4-177">An example of DDoS in action; if an internet facing IP address was attacked by a large-scale DDoS attack, Azure would detect the sources of the attacks and scrub the offending traffic before it reached its intended destination.</span><span class="sxs-lookup"><span data-stu-id="a09a4-177">An example of DDoS in action; if an internet facing IP address was attacked by a large-scale DDoS attack, Azure would detect the sources of the attacks and scrub the offending traffic before it reached its intended destination.</span></span> <span data-ttu-id="a09a4-178">In almost all cases, the attacked endpoint isn't affected by the attack.</span><span class="sxs-lookup"><span data-stu-id="a09a4-178">In almost all cases, the attacked endpoint isn't affected by the attack.</span></span> <span data-ttu-id="a09a4-179">In the rare cases that an endpoint is affected, no traffic is affected to other endpoints, only the attacked endpoint.</span><span class="sxs-lookup"><span data-stu-id="a09a4-179">In the rare cases that an endpoint is affected, no traffic is affected to other endpoints, only the attacked endpoint.</span></span> <span data-ttu-id="a09a4-180">Thus other customers and services would see no impact from that attack.</span><span class="sxs-lookup"><span data-stu-id="a09a4-180">Thus other customers and services would see no impact from that attack.</span></span> <span data-ttu-id="a09a4-181">It's critical to note that Azure DDoS is only looking for large-scale attacks.</span><span class="sxs-lookup"><span data-stu-id="a09a4-181">It's critical to note that Azure DDoS is only looking for large-scale attacks.</span></span> <span data-ttu-id="a09a4-182">It is possible that your specific service could be overwhelmed before the platform level protection thresholds are exceeded.</span><span class="sxs-lookup"><span data-stu-id="a09a4-182">It is possible that your specific service could be overwhelmed before the platform level protection thresholds are exceeded.</span></span> <span data-ttu-id="a09a4-183">For example, a web site on a single A0 IIS server, could be taken offline by a DDoS attack before Azure platform level DDoS protection registered a threat.</span><span class="sxs-lookup"><span data-stu-id="a09a4-183">For example, a web site on a single A0 IIS server, could be taken offline by a DDoS attack before Azure platform level DDoS protection registered a threat.</span></span>

2.  <span data-ttu-id="a09a4-184">**Public IP Addresses**: Public IP addresses (enabled via service endpoints, Public IP addresses, Application Gateway, and other Azure features that present a public IP address to the internet routed to your resource) allow cloud services or resource groups to have public Internet IP addresses and ports exposed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-184">**Public IP Addresses**: Public IP addresses (enabled via service endpoints, Public IP addresses, Application Gateway, and other Azure features that present a public IP address to the internet routed to your resource) allow cloud services or resource groups to have public Internet IP addresses and ports exposed.</span></span> <span data-ttu-id="a09a4-185">The endpoint uses Network Address Translation (NAT) to route traffic to the internal address and port on the Azure virtual network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-185">The endpoint uses Network Address Translation (NAT) to route traffic to the internal address and port on the Azure virtual network.</span></span> <span data-ttu-id="a09a4-186">This path is the primary way for external traffic to pass into the virtual network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-186">This path is the primary way for external traffic to pass into the virtual network.</span></span> <span data-ttu-id="a09a4-187">The Public IP addresses are configurable to determine which traffic is passed in, and how and where it's translated on to the virtual network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-187">The Public IP addresses are configurable to determine which traffic is passed in, and how and where it's translated on to the virtual network.</span></span>

<span data-ttu-id="a09a4-188">Once traffic reaches the virtual network, there are many features that come into play.</span><span class="sxs-lookup"><span data-stu-id="a09a4-188">Once traffic reaches the virtual network, there are many features that come into play.</span></span> <span data-ttu-id="a09a4-189">Azure virtual networks are the foundation for customers to attach their workloads and where basic network-level security applies.</span><span class="sxs-lookup"><span data-stu-id="a09a4-189">Azure virtual networks are the foundation for customers to attach their workloads and where basic network-level security applies.</span></span> <span data-ttu-id="a09a4-190">It is a private network (a virtual network overlay) in Azure for customers with the following features and characteristics:</span><span class="sxs-lookup"><span data-stu-id="a09a4-190">It is a private network (a virtual network overlay) in Azure for customers with the following features and characteristics:</span></span>

* <span data-ttu-id="a09a4-191">**Traffic isolation**: A virtual network is the traffic isolation boundary on the Azure platform.</span><span class="sxs-lookup"><span data-stu-id="a09a4-191">**Traffic isolation**: A virtual network is the traffic isolation boundary on the Azure platform.</span></span> <span data-ttu-id="a09a4-192">Virtual machines (VMs) in one virtual network cannot communicate directly to VMs in a different virtual network, even if both virtual networks are created by the same customer.</span><span class="sxs-lookup"><span data-stu-id="a09a4-192">Virtual machines (VMs) in one virtual network cannot communicate directly to VMs in a different virtual network, even if both virtual networks are created by the same customer.</span></span> <span data-ttu-id="a09a4-193">Isolation is a critical property that ensures customer VMs and communication remains private within a virtual network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-193">Isolation is a critical property that ensures customer VMs and communication remains private within a virtual network.</span></span>

>[!NOTE]
><span data-ttu-id="a09a4-194">Traffic isolation refers only to traffic *inbound* to the virtual network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-194">Traffic isolation refers only to traffic *inbound* to the virtual network.</span></span> <span data-ttu-id="a09a4-195">By default outbound traffic from the VNet to the internet is allowed, but can be prevented if desired by NSGs.</span><span class="sxs-lookup"><span data-stu-id="a09a4-195">By default outbound traffic from the VNet to the internet is allowed, but can be prevented if desired by NSGs.</span></span>
>
>

* <span data-ttu-id="a09a4-196">**Multi-tier topology**: Virtual networks allow customers to define multi-tier topology by allocating subnets and designating separate address spaces for different elements or “tiers” of their workloads.</span><span class="sxs-lookup"><span data-stu-id="a09a4-196">**Multi-tier topology**: Virtual networks allow customers to define multi-tier topology by allocating subnets and designating separate address spaces for different elements or “tiers” of their workloads.</span></span> <span data-ttu-id="a09a4-197">These logical groupings and topologies enable customers to define different access policy based on the workload types, and also control traffic flows between the tiers.</span><span class="sxs-lookup"><span data-stu-id="a09a4-197">These logical groupings and topologies enable customers to define different access policy based on the workload types, and also control traffic flows between the tiers.</span></span>
* <span data-ttu-id="a09a4-198">**Cross-premises connectivity**: Customers can establish cross-premises connectivity between a virtual network and multiple on-premises sites or other virtual networks in Azure.</span><span class="sxs-lookup"><span data-stu-id="a09a4-198">**Cross-premises connectivity**: Customers can establish cross-premises connectivity between a virtual network and multiple on-premises sites or other virtual networks in Azure.</span></span> <span data-ttu-id="a09a4-199">To construct a connection, customers can use VNet Peering, Azure VPN Gateways, third-party network virtual appliances, or ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="a09a4-199">To construct a connection, customers can use VNet Peering, Azure VPN Gateways, third-party network virtual appliances, or ExpressRoute.</span></span> <span data-ttu-id="a09a4-200">Azure supports site-to-site (S2S) VPNs using standard IPsec/IKE protocols and ExpressRoute private connectivity.</span><span class="sxs-lookup"><span data-stu-id="a09a4-200">Azure supports site-to-site (S2S) VPNs using standard IPsec/IKE protocols and ExpressRoute private connectivity.</span></span>
* <span data-ttu-id="a09a4-201">**NSG** allows customers to create rules (ACLs) at the desired level of granularity: network interfaces, individual VMs, or virtual subnets.</span><span class="sxs-lookup"><span data-stu-id="a09a4-201">**NSG** allows customers to create rules (ACLs) at the desired level of granularity: network interfaces, individual VMs, or virtual subnets.</span></span> <span data-ttu-id="a09a4-202">Customers can control access by permitting or denying communication between the workloads within a virtual network, from systems on customer’s networks via cross-premises connectivity, or direct Internet communication.</span><span class="sxs-lookup"><span data-stu-id="a09a4-202">Customers can control access by permitting or denying communication between the workloads within a virtual network, from systems on customer’s networks via cross-premises connectivity, or direct Internet communication.</span></span>
* <span data-ttu-id="a09a4-203">**UDR** and **IP Forwarding** allow customers to define the communication paths between different tiers within a virtual network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-203">**UDR** and **IP Forwarding** allow customers to define the communication paths between different tiers within a virtual network.</span></span> <span data-ttu-id="a09a4-204">Customers can deploy a firewall, IDS/IPS, and other virtual appliances, and route network traffic through these security appliances for security boundary policy enforcement, auditing, and inspection.</span><span class="sxs-lookup"><span data-stu-id="a09a4-204">Customers can deploy a firewall, IDS/IPS, and other virtual appliances, and route network traffic through these security appliances for security boundary policy enforcement, auditing, and inspection.</span></span>
* <span data-ttu-id="a09a4-205">**Network virtual appliances** in the Azure Marketplace: Security appliances such as firewalls, load balancers, and IDS/IPS are available in the Azure Marketplace and the VM Image Gallery.</span><span class="sxs-lookup"><span data-stu-id="a09a4-205">**Network virtual appliances** in the Azure Marketplace: Security appliances such as firewalls, load balancers, and IDS/IPS are available in the Azure Marketplace and the VM Image Gallery.</span></span> <span data-ttu-id="a09a4-206">Customers can deploy these appliances into their virtual networks, and specifically, at their security boundaries (including the perimeter network subnets) to complete a multi-tiered secure network environment.</span><span class="sxs-lookup"><span data-stu-id="a09a4-206">Customers can deploy these appliances into their virtual networks, and specifically, at their security boundaries (including the perimeter network subnets) to complete a multi-tiered secure network environment.</span></span>

<span data-ttu-id="a09a4-207">With these features and capabilities, one example of how a perimeter network architecture could be constructed in Azure is the following diagram:</span><span class="sxs-lookup"><span data-stu-id="a09a4-207">With these features and capabilities, one example of how a perimeter network architecture could be constructed in Azure is the following diagram:</span></span>

<span data-ttu-id="a09a4-208">![5]</span><span class="sxs-lookup"><span data-stu-id="a09a4-208">![5]</span></span>

## <a name="perimeter-network-characteristics-and-requirements"></a><span data-ttu-id="a09a4-209">Perimeter network characteristics and requirements</span><span class="sxs-lookup"><span data-stu-id="a09a4-209">Perimeter network characteristics and requirements</span></span>
<span data-ttu-id="a09a4-210">The perimeter network is the front end of the network, directly interfacing communication from the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-210">The perimeter network is the front end of the network, directly interfacing communication from the Internet.</span></span> <span data-ttu-id="a09a4-211">The incoming packets should flow through the security appliances, such as the firewall, IDS, and IPS, before reaching the back-end servers.</span><span class="sxs-lookup"><span data-stu-id="a09a4-211">The incoming packets should flow through the security appliances, such as the firewall, IDS, and IPS, before reaching the back-end servers.</span></span> <span data-ttu-id="a09a4-212">Internet-bound packets from the workloads can also flow through the security appliances in the perimeter network for policy enforcement, inspection, and auditing purposes, before leaving the network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-212">Internet-bound packets from the workloads can also flow through the security appliances in the perimeter network for policy enforcement, inspection, and auditing purposes, before leaving the network.</span></span> <span data-ttu-id="a09a4-213">Additionally, the perimeter network can host cross-premises VPN gateways between customer virtual networks and on-premises networks.</span><span class="sxs-lookup"><span data-stu-id="a09a4-213">Additionally, the perimeter network can host cross-premises VPN gateways between customer virtual networks and on-premises networks.</span></span>

### <a name="perimeter-network-characteristics"></a><span data-ttu-id="a09a4-214">Perimeter network characteristics</span><span class="sxs-lookup"><span data-stu-id="a09a4-214">Perimeter network characteristics</span></span>
<span data-ttu-id="a09a4-215">Referencing the previous figure, some of the characteristics of a good perimeter network are as follows:</span><span class="sxs-lookup"><span data-stu-id="a09a4-215">Referencing the previous figure, some of the characteristics of a good perimeter network are as follows:</span></span>

* <span data-ttu-id="a09a4-216">Internet-facing:</span><span class="sxs-lookup"><span data-stu-id="a09a4-216">Internet-facing:</span></span>
  * <span data-ttu-id="a09a4-217">The perimeter network subnet itself is Internet-facing, directly communicating with the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-217">The perimeter network subnet itself is Internet-facing, directly communicating with the Internet.</span></span>
  * <span data-ttu-id="a09a4-218">Public IP addresses, VIPs, and/or service endpoints pass Internet traffic to the front-end network and devices.</span><span class="sxs-lookup"><span data-stu-id="a09a4-218">Public IP addresses, VIPs, and/or service endpoints pass Internet traffic to the front-end network and devices.</span></span>
  * <span data-ttu-id="a09a4-219">Inbound traffic from the Internet passes through security devices before other resources on the front-end network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-219">Inbound traffic from the Internet passes through security devices before other resources on the front-end network.</span></span>
  * <span data-ttu-id="a09a4-220">If outbound security is enabled, traffic passes through security devices, as the final step, before passing to the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-220">If outbound security is enabled, traffic passes through security devices, as the final step, before passing to the Internet.</span></span>
* <span data-ttu-id="a09a4-221">Protected network:</span><span class="sxs-lookup"><span data-stu-id="a09a4-221">Protected network:</span></span>
  * <span data-ttu-id="a09a4-222">There is no direct path from the Internet to the core infrastructure.</span><span class="sxs-lookup"><span data-stu-id="a09a4-222">There is no direct path from the Internet to the core infrastructure.</span></span>
  * <span data-ttu-id="a09a4-223">Channels to the core infrastructure must traverse through security devices such as NSGs, firewalls, or VPN devices.</span><span class="sxs-lookup"><span data-stu-id="a09a4-223">Channels to the core infrastructure must traverse through security devices such as NSGs, firewalls, or VPN devices.</span></span>
  * <span data-ttu-id="a09a4-224">Other devices must not bridge Internet and the core infrastructure.</span><span class="sxs-lookup"><span data-stu-id="a09a4-224">Other devices must not bridge Internet and the core infrastructure.</span></span>
  * <span data-ttu-id="a09a4-225">Security devices on both the Internet-facing and the protected network facing boundaries of the perimeter network (for example, the two firewall icons shown in the previous figure) may actually be a single virtual appliance with differentiated rules or interfaces for each boundary.</span><span class="sxs-lookup"><span data-stu-id="a09a4-225">Security devices on both the Internet-facing and the protected network facing boundaries of the perimeter network (for example, the two firewall icons shown in the previous figure) may actually be a single virtual appliance with differentiated rules or interfaces for each boundary.</span></span> <span data-ttu-id="a09a4-226">For example, one physical device, logically separated, handling the load for both boundaries of the perimeter network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-226">For example, one physical device, logically separated, handling the load for both boundaries of the perimeter network.</span></span>
* <span data-ttu-id="a09a4-227">Other common practices and constraints:</span><span class="sxs-lookup"><span data-stu-id="a09a4-227">Other common practices and constraints:</span></span>
  * <span data-ttu-id="a09a4-228">Workloads must not store business critical information.</span><span class="sxs-lookup"><span data-stu-id="a09a4-228">Workloads must not store business critical information.</span></span>
  * <span data-ttu-id="a09a4-229">Access and updates to perimeter network configurations and deployments are limited to only authorized administrators.</span><span class="sxs-lookup"><span data-stu-id="a09a4-229">Access and updates to perimeter network configurations and deployments are limited to only authorized administrators.</span></span>

### <a name="perimeter-network-requirements"></a><span data-ttu-id="a09a4-230">Perimeter network requirements</span><span class="sxs-lookup"><span data-stu-id="a09a4-230">Perimeter network requirements</span></span>
<span data-ttu-id="a09a4-231">To enable these characteristics, follow these guidelines on virtual network requirements to implement a successful perimeter network:</span><span class="sxs-lookup"><span data-stu-id="a09a4-231">To enable these characteristics, follow these guidelines on virtual network requirements to implement a successful perimeter network:</span></span>

* <span data-ttu-id="a09a4-232">**Subnet architecture:** Specify the virtual network such that an entire subnet is dedicated as the perimeter network, separated from other subnets in the same virtual network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-232">**Subnet architecture:** Specify the virtual network such that an entire subnet is dedicated as the perimeter network, separated from other subnets in the same virtual network.</span></span> <span data-ttu-id="a09a4-233">This separation ensures the traffic between the perimeter network and other internal or private subnet tiers flows through a firewall or IDS/IPS virtual appliance.</span><span class="sxs-lookup"><span data-stu-id="a09a4-233">This separation ensures the traffic between the perimeter network and other internal or private subnet tiers flows through a firewall or IDS/IPS virtual appliance.</span></span>  <span data-ttu-id="a09a4-234">User-defined routes on the boundary subnets are required to forward this traffic to the virtual appliance.</span><span class="sxs-lookup"><span data-stu-id="a09a4-234">User-defined routes on the boundary subnets are required to forward this traffic to the virtual appliance.</span></span>
* <span data-ttu-id="a09a4-235">**NSG:** The perimeter network subnet itself should be open to allow communication with the Internet, but that does not mean customers should be bypassing NSGs.</span><span class="sxs-lookup"><span data-stu-id="a09a4-235">**NSG:** The perimeter network subnet itself should be open to allow communication with the Internet, but that does not mean customers should be bypassing NSGs.</span></span> <span data-ttu-id="a09a4-236">Follow common security practices to minimize the network surfaces exposed to the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-236">Follow common security practices to minimize the network surfaces exposed to the Internet.</span></span> <span data-ttu-id="a09a4-237">Lock down the remote address ranges allowed to access the deployments or the specific application protocols and ports that are open.</span><span class="sxs-lookup"><span data-stu-id="a09a4-237">Lock down the remote address ranges allowed to access the deployments or the specific application protocols and ports that are open.</span></span> <span data-ttu-id="a09a4-238">There may be circumstances, however, in which a complete lock-down is not possible.</span><span class="sxs-lookup"><span data-stu-id="a09a4-238">There may be circumstances, however, in which a complete lock-down is not possible.</span></span> <span data-ttu-id="a09a4-239">For example, if customers have an external website in Azure, the perimeter network should allow the incoming web requests from any public IP addresses, but should only open the web application ports: TCP on port 80 and/or TCP on port 443.</span><span class="sxs-lookup"><span data-stu-id="a09a4-239">For example, if customers have an external website in Azure, the perimeter network should allow the incoming web requests from any public IP addresses, but should only open the web application ports: TCP on port 80 and/or TCP on port 443.</span></span>
* <span data-ttu-id="a09a4-240">**Routing table:** The perimeter network subnet itself should be able to communicate to the Internet directly, but should not allow direct communication to and from the back end or on-premises networks without going through a firewall or security appliance.</span><span class="sxs-lookup"><span data-stu-id="a09a4-240">**Routing table:** The perimeter network subnet itself should be able to communicate to the Internet directly, but should not allow direct communication to and from the back end or on-premises networks without going through a firewall or security appliance.</span></span>
* <span data-ttu-id="a09a4-241">**Security appliance configuration:** To route and inspect packets between the perimeter network and the rest of the protected networks, the security appliances such as firewall, IDS, and IPS devices may be multi-homed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-241">**Security appliance configuration:** To route and inspect packets between the perimeter network and the rest of the protected networks, the security appliances such as firewall, IDS, and IPS devices may be multi-homed.</span></span> <span data-ttu-id="a09a4-242">They may have separate NICs for the perimeter network and the back-end subnets.</span><span class="sxs-lookup"><span data-stu-id="a09a4-242">They may have separate NICs for the perimeter network and the back-end subnets.</span></span> <span data-ttu-id="a09a4-243">The NICs in the perimeter network communicate directly to and from the Internet, with the corresponding NSGs and the perimeter network routing table.</span><span class="sxs-lookup"><span data-stu-id="a09a4-243">The NICs in the perimeter network communicate directly to and from the Internet, with the corresponding NSGs and the perimeter network routing table.</span></span> <span data-ttu-id="a09a4-244">The NICs connecting to the back-end subnets have more restricted NSGs and routing tables of the corresponding back-end subnets.</span><span class="sxs-lookup"><span data-stu-id="a09a4-244">The NICs connecting to the back-end subnets have more restricted NSGs and routing tables of the corresponding back-end subnets.</span></span>
* <span data-ttu-id="a09a4-245">**Security appliance functionality:** The security appliances deployed in the perimeter network typically perform the following functionality:</span><span class="sxs-lookup"><span data-stu-id="a09a4-245">**Security appliance functionality:** The security appliances deployed in the perimeter network typically perform the following functionality:</span></span>
  * <span data-ttu-id="a09a4-246">Firewall: Enforcing firewall rules or access control policies for the incoming requests.</span><span class="sxs-lookup"><span data-stu-id="a09a4-246">Firewall: Enforcing firewall rules or access control policies for the incoming requests.</span></span>
  * <span data-ttu-id="a09a4-247">Threat detection and prevention: Detecting and mitigating malicious attacks from the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-247">Threat detection and prevention: Detecting and mitigating malicious attacks from the Internet.</span></span>
  * <span data-ttu-id="a09a4-248">Auditing and logging: Maintaining detailed logs for auditing and analysis.</span><span class="sxs-lookup"><span data-stu-id="a09a4-248">Auditing and logging: Maintaining detailed logs for auditing and analysis.</span></span>
  * <span data-ttu-id="a09a4-249">Reverse proxy: Redirecting the incoming requests to the corresponding back-end servers.</span><span class="sxs-lookup"><span data-stu-id="a09a4-249">Reverse proxy: Redirecting the incoming requests to the corresponding back-end servers.</span></span> <span data-ttu-id="a09a4-250">This redirection involves mapping and translating the destination addresses on the front-end devices, typically firewalls, to the back-end server addresses.</span><span class="sxs-lookup"><span data-stu-id="a09a4-250">This redirection involves mapping and translating the destination addresses on the front-end devices, typically firewalls, to the back-end server addresses.</span></span>
  * <span data-ttu-id="a09a4-251">Forward proxy: Providing NAT and performing auditing for communication initiated from within the virtual network to the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-251">Forward proxy: Providing NAT and performing auditing for communication initiated from within the virtual network to the Internet.</span></span>
  * <span data-ttu-id="a09a4-252">Router: Forwarding incoming and cross-subnet traffic inside the virtual network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-252">Router: Forwarding incoming and cross-subnet traffic inside the virtual network.</span></span>
  * <span data-ttu-id="a09a4-253">VPN device: Acting as the cross-premises VPN gateways for cross-premises VPN connectivity between customer on-premises networks and Azure virtual networks.</span><span class="sxs-lookup"><span data-stu-id="a09a4-253">VPN device: Acting as the cross-premises VPN gateways for cross-premises VPN connectivity between customer on-premises networks and Azure virtual networks.</span></span>
  * <span data-ttu-id="a09a4-254">VPN server: Accepting VPN clients connecting to Azure virtual networks.</span><span class="sxs-lookup"><span data-stu-id="a09a4-254">VPN server: Accepting VPN clients connecting to Azure virtual networks.</span></span>

> [!TIP]
> <span data-ttu-id="a09a4-255">Keep the following two groups separate: the individuals authorized to access the perimeter network security gear and the individuals authorized as application development, deployment, or operations administrators.</span><span class="sxs-lookup"><span data-stu-id="a09a4-255">Keep the following two groups separate: the individuals authorized to access the perimeter network security gear and the individuals authorized as application development, deployment, or operations administrators.</span></span> <span data-ttu-id="a09a4-256">Keeping these groups separate allows for a segregation of duties and prevents a single person from bypassing both applications security and network security controls.</span><span class="sxs-lookup"><span data-stu-id="a09a4-256">Keeping these groups separate allows for a segregation of duties and prevents a single person from bypassing both applications security and network security controls.</span></span>
>
>

### <a name="questions-to-be-asked-when-building-network-boundaries"></a><span data-ttu-id="a09a4-257">Questions to be asked when building network boundaries</span><span class="sxs-lookup"><span data-stu-id="a09a4-257">Questions to be asked when building network boundaries</span></span>
<span data-ttu-id="a09a4-258">In this section, unless specifically mentioned, the term "networks" refers to private Azure virtual networks created by a subscription administrator.</span><span class="sxs-lookup"><span data-stu-id="a09a4-258">In this section, unless specifically mentioned, the term "networks" refers to private Azure virtual networks created by a subscription administrator.</span></span> <span data-ttu-id="a09a4-259">The term doesn't refer to the underlying physical networks within Azure.</span><span class="sxs-lookup"><span data-stu-id="a09a4-259">The term doesn't refer to the underlying physical networks within Azure.</span></span>

<span data-ttu-id="a09a4-260">Also, Azure virtual networks are often used to extend traditional on-premises networks.</span><span class="sxs-lookup"><span data-stu-id="a09a4-260">Also, Azure virtual networks are often used to extend traditional on-premises networks.</span></span> <span data-ttu-id="a09a4-261">It is possible to incorporate either site-to-site or ExpressRoute hybrid networking solutions with perimeter network architectures.</span><span class="sxs-lookup"><span data-stu-id="a09a4-261">It is possible to incorporate either site-to-site or ExpressRoute hybrid networking solutions with perimeter network architectures.</span></span> <span data-ttu-id="a09a4-262">This hybrid link is an important consideration in building network security boundaries.</span><span class="sxs-lookup"><span data-stu-id="a09a4-262">This hybrid link is an important consideration in building network security boundaries.</span></span>

<span data-ttu-id="a09a4-263">The following three questions are critical to answer when you're building a network with a perimeter network and multiple security boundaries.</span><span class="sxs-lookup"><span data-stu-id="a09a4-263">The following three questions are critical to answer when you're building a network with a perimeter network and multiple security boundaries.</span></span>

#### <a name="1-how-many-boundaries-are-needed"></a><span data-ttu-id="a09a4-264">1) How many boundaries are needed?</span><span class="sxs-lookup"><span data-stu-id="a09a4-264">1) How many boundaries are needed?</span></span>
<span data-ttu-id="a09a4-265">The first decision point is to decide how many security boundaries are needed in a given scenario:</span><span class="sxs-lookup"><span data-stu-id="a09a4-265">The first decision point is to decide how many security boundaries are needed in a given scenario:</span></span>

* <span data-ttu-id="a09a4-266">A single boundary: One on the front-end perimeter network, between the virtual network and the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-266">A single boundary: One on the front-end perimeter network, between the virtual network and the Internet.</span></span>
* <span data-ttu-id="a09a4-267">Two boundaries: One on the Internet side of the perimeter network, and another between the perimeter network subnet and the back-end subnets in the Azure virtual networks.</span><span class="sxs-lookup"><span data-stu-id="a09a4-267">Two boundaries: One on the Internet side of the perimeter network, and another between the perimeter network subnet and the back-end subnets in the Azure virtual networks.</span></span>
* <span data-ttu-id="a09a4-268">Three boundaries: One on the Internet side of the perimeter network, one between the perimeter network and back-end subnets, and one between the back-end subnets and the on-premises network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-268">Three boundaries: One on the Internet side of the perimeter network, one between the perimeter network and back-end subnets, and one between the back-end subnets and the on-premises network.</span></span>
* <span data-ttu-id="a09a4-269">N boundaries: A variable number.</span><span class="sxs-lookup"><span data-stu-id="a09a4-269">N boundaries: A variable number.</span></span> <span data-ttu-id="a09a4-270">Depending on security requirements, there is no limit to the number of security boundaries that can be applied in a given network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-270">Depending on security requirements, there is no limit to the number of security boundaries that can be applied in a given network.</span></span>

<span data-ttu-id="a09a4-271">The number and type of boundaries needed vary based on a company’s risk tolerance and the specific scenario being implemented.</span><span class="sxs-lookup"><span data-stu-id="a09a4-271">The number and type of boundaries needed vary based on a company’s risk tolerance and the specific scenario being implemented.</span></span> <span data-ttu-id="a09a4-272">This decision is often made together with multiple groups within an organization, often including a risk and compliance team, a network and platform team, and an application development team.</span><span class="sxs-lookup"><span data-stu-id="a09a4-272">This decision is often made together with multiple groups within an organization, often including a risk and compliance team, a network and platform team, and an application development team.</span></span> <span data-ttu-id="a09a4-273">People with knowledge of security, the data involved, and the technologies being used should have a say in this decision to ensure the appropriate security stance for each implementation.</span><span class="sxs-lookup"><span data-stu-id="a09a4-273">People with knowledge of security, the data involved, and the technologies being used should have a say in this decision to ensure the appropriate security stance for each implementation.</span></span>

> [!TIP]
> <span data-ttu-id="a09a4-274">Use the smallest number of boundaries that satisfy the security requirements for a given situation.</span><span class="sxs-lookup"><span data-stu-id="a09a4-274">Use the smallest number of boundaries that satisfy the security requirements for a given situation.</span></span> <span data-ttu-id="a09a4-275">With more boundaries, operations and troubleshooting can be more difficult, as well as the management overhead involved with managing the multiple boundary policies over time.</span><span class="sxs-lookup"><span data-stu-id="a09a4-275">With more boundaries, operations and troubleshooting can be more difficult, as well as the management overhead involved with managing the multiple boundary policies over time.</span></span> <span data-ttu-id="a09a4-276">However, insufficient boundaries increase risk.</span><span class="sxs-lookup"><span data-stu-id="a09a4-276">However, insufficient boundaries increase risk.</span></span> <span data-ttu-id="a09a4-277">Finding the balance is critical.</span><span class="sxs-lookup"><span data-stu-id="a09a4-277">Finding the balance is critical.</span></span>
>
>

<span data-ttu-id="a09a4-278">![6]</span><span class="sxs-lookup"><span data-stu-id="a09a4-278">![6]</span></span>

<span data-ttu-id="a09a4-279">The preceding figure shows a high-level view of a three security boundary network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-279">The preceding figure shows a high-level view of a three security boundary network.</span></span> <span data-ttu-id="a09a4-280">The boundaries are between the perimeter network and the Internet, the Azure front-end and back-end private subnets, and the Azure back-end subnet and the on-premises corporate network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-280">The boundaries are between the perimeter network and the Internet, the Azure front-end and back-end private subnets, and the Azure back-end subnet and the on-premises corporate network.</span></span>

#### <a name="2-where-are-the-boundaries-located"></a><span data-ttu-id="a09a4-281">2) Where are the boundaries located?</span><span class="sxs-lookup"><span data-stu-id="a09a4-281">2) Where are the boundaries located?</span></span>
<span data-ttu-id="a09a4-282">Once the number of boundaries are decided, where to implement them is the next decision point.</span><span class="sxs-lookup"><span data-stu-id="a09a4-282">Once the number of boundaries are decided, where to implement them is the next decision point.</span></span> <span data-ttu-id="a09a4-283">There are generally three choices:</span><span class="sxs-lookup"><span data-stu-id="a09a4-283">There are generally three choices:</span></span>

* <span data-ttu-id="a09a4-284">Using an Internet-based intermediary service (for example, a cloud-based Web application firewall, which is not discussed in this document)</span><span class="sxs-lookup"><span data-stu-id="a09a4-284">Using an Internet-based intermediary service (for example, a cloud-based Web application firewall, which is not discussed in this document)</span></span>
* <span data-ttu-id="a09a4-285">Using native features and/or network virtual appliances in Azure</span><span class="sxs-lookup"><span data-stu-id="a09a4-285">Using native features and/or network virtual appliances in Azure</span></span>
* <span data-ttu-id="a09a4-286">Using physical devices on the on-premises network</span><span class="sxs-lookup"><span data-stu-id="a09a4-286">Using physical devices on the on-premises network</span></span>

<span data-ttu-id="a09a4-287">On purely Azure networks, the options are native Azure features (for example, Azure Load Balancers) or network virtual appliances from the rich partner ecosystem of Azure (for example, Check Point firewalls).</span><span class="sxs-lookup"><span data-stu-id="a09a4-287">On purely Azure networks, the options are native Azure features (for example, Azure Load Balancers) or network virtual appliances from the rich partner ecosystem of Azure (for example, Check Point firewalls).</span></span>

<span data-ttu-id="a09a4-288">If a boundary is needed between Azure and an on-premises network, the security devices can reside on either side of the connection (or both sides).</span><span class="sxs-lookup"><span data-stu-id="a09a4-288">If a boundary is needed between Azure and an on-premises network, the security devices can reside on either side of the connection (or both sides).</span></span> <span data-ttu-id="a09a4-289">Thus a decision must be made on the location to place security gear.</span><span class="sxs-lookup"><span data-stu-id="a09a4-289">Thus a decision must be made on the location to place security gear.</span></span>

<span data-ttu-id="a09a4-290">In the previous figure, the Internet-to-perimeter network and the front-to-back-end boundaries are entirely contained within Azure, and must be either native Azure features or network virtual appliances.</span><span class="sxs-lookup"><span data-stu-id="a09a4-290">In the previous figure, the Internet-to-perimeter network and the front-to-back-end boundaries are entirely contained within Azure, and must be either native Azure features or network virtual appliances.</span></span> <span data-ttu-id="a09a4-291">Security devices on the boundary between Azure (back-end subnet) and the corporate network could be either on the Azure side or the on-premises side, or even a combination of devices on both sides.</span><span class="sxs-lookup"><span data-stu-id="a09a4-291">Security devices on the boundary between Azure (back-end subnet) and the corporate network could be either on the Azure side or the on-premises side, or even a combination of devices on both sides.</span></span> <span data-ttu-id="a09a4-292">There can be significant advantages and disadvantages to either option that must be seriously considered.</span><span class="sxs-lookup"><span data-stu-id="a09a4-292">There can be significant advantages and disadvantages to either option that must be seriously considered.</span></span>

<span data-ttu-id="a09a4-293">For example, using existing physical security gear on the on-premises network side has the advantage that no new gear is needed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-293">For example, using existing physical security gear on the on-premises network side has the advantage that no new gear is needed.</span></span> <span data-ttu-id="a09a4-294">It just needs reconfiguration.</span><span class="sxs-lookup"><span data-stu-id="a09a4-294">It just needs reconfiguration.</span></span> <span data-ttu-id="a09a4-295">The disadvantage, however, is that all traffic must come back from Azure to the on-premises network to be seen by the security gear.</span><span class="sxs-lookup"><span data-stu-id="a09a4-295">The disadvantage, however, is that all traffic must come back from Azure to the on-premises network to be seen by the security gear.</span></span> <span data-ttu-id="a09a4-296">Thus Azure-to-Azure traffic could incur significant latency, and affect application performance and user experience, if it was forced back to the on-premises network for security policy enforcement.</span><span class="sxs-lookup"><span data-stu-id="a09a4-296">Thus Azure-to-Azure traffic could incur significant latency, and affect application performance and user experience, if it was forced back to the on-premises network for security policy enforcement.</span></span>

#### <a name="3-how-are-the-boundaries-implemented"></a><span data-ttu-id="a09a4-297">3) How are the boundaries implemented?</span><span class="sxs-lookup"><span data-stu-id="a09a4-297">3) How are the boundaries implemented?</span></span>
<span data-ttu-id="a09a4-298">Each security boundary will likely have different capability requirements (for example, IDS and firewall rules on the Internet side of the perimeter network, but only ACLs between the perimeter network and back-end subnet).</span><span class="sxs-lookup"><span data-stu-id="a09a4-298">Each security boundary will likely have different capability requirements (for example, IDS and firewall rules on the Internet side of the perimeter network, but only ACLs between the perimeter network and back-end subnet).</span></span> <span data-ttu-id="a09a4-299">Deciding on which device (or how many devices) to use depends on the scenario and security requirements.</span><span class="sxs-lookup"><span data-stu-id="a09a4-299">Deciding on which device (or how many devices) to use depends on the scenario and security requirements.</span></span> <span data-ttu-id="a09a4-300">In the following section, examples 1, 2, and 3 discuss some options that could be used.</span><span class="sxs-lookup"><span data-stu-id="a09a4-300">In the following section, examples 1, 2, and 3 discuss some options that could be used.</span></span> <span data-ttu-id="a09a4-301">Reviewing the Azure native network features and the devices available in Azure from the partner ecosystem shows the myriad options available to solve virtually any scenario.</span><span class="sxs-lookup"><span data-stu-id="a09a4-301">Reviewing the Azure native network features and the devices available in Azure from the partner ecosystem shows the myriad options available to solve virtually any scenario.</span></span>

<span data-ttu-id="a09a4-302">Another key implementation decision point is how to connect the on-premises network with Azure.</span><span class="sxs-lookup"><span data-stu-id="a09a4-302">Another key implementation decision point is how to connect the on-premises network with Azure.</span></span> <span data-ttu-id="a09a4-303">Should you use the Azure virtual gateway or a network virtual appliance?</span><span class="sxs-lookup"><span data-stu-id="a09a4-303">Should you use the Azure virtual gateway or a network virtual appliance?</span></span> <span data-ttu-id="a09a4-304">These options are discussed in greater detail in the following section (examples 4, 5, and 6).</span><span class="sxs-lookup"><span data-stu-id="a09a4-304">These options are discussed in greater detail in the following section (examples 4, 5, and 6).</span></span>

<span data-ttu-id="a09a4-305">Additionally, traffic between virtual networks within Azure may be needed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-305">Additionally, traffic between virtual networks within Azure may be needed.</span></span> <span data-ttu-id="a09a4-306">These scenarios will be added in the future.</span><span class="sxs-lookup"><span data-stu-id="a09a4-306">These scenarios will be added in the future.</span></span>

<span data-ttu-id="a09a4-307">Once you know the answers to the previous questions, the [Fast Start](#fast-start) section can help identify which examples are most appropriate for a given scenario.</span><span class="sxs-lookup"><span data-stu-id="a09a4-307">Once you know the answers to the previous questions, the [Fast Start](#fast-start) section can help identify which examples are most appropriate for a given scenario.</span></span>

## <a name="examples-building-security-boundaries-with-azure-virtual-networks"></a><span data-ttu-id="a09a4-308">Examples: Building security boundaries with Azure virtual networks</span><span class="sxs-lookup"><span data-stu-id="a09a4-308">Examples: Building security boundaries with Azure virtual networks</span></span>
### <a name="example-1-build-a-perimeter-network-to-help-protect-applications-with-nsgs"></a><span data-ttu-id="a09a4-309">Example 1 Build a perimeter network to help protect applications with NSGs</span><span class="sxs-lookup"><span data-stu-id="a09a4-309">Example 1 Build a perimeter network to help protect applications with NSGs</span></span>
<span data-ttu-id="a09a4-310">[Back to Fast start](#fast-start) | [Detailed build instructions for this example][Example1]</span><span class="sxs-lookup"><span data-stu-id="a09a4-310">[Back to Fast start](#fast-start) | [Detailed build instructions for this example][Example1]</span></span>

<span data-ttu-id="a09a4-311">[![7]][7]</span><span class="sxs-lookup"><span data-stu-id="a09a4-311">[![7]][7]</span></span>

#### <a name="environment-description"></a><span data-ttu-id="a09a4-312">Environment description</span><span class="sxs-lookup"><span data-stu-id="a09a4-312">Environment description</span></span>
<span data-ttu-id="a09a4-313">In this example, there is a subscription that contains the following resources:</span><span class="sxs-lookup"><span data-stu-id="a09a4-313">In this example, there is a subscription that contains the following resources:</span></span>

- <span data-ttu-id="a09a4-314">A single resource group</span><span class="sxs-lookup"><span data-stu-id="a09a4-314">A single resource group</span></span>
- <span data-ttu-id="a09a4-315">A virtual network with two subnets: “FrontEnd” and “BackEnd”</span><span class="sxs-lookup"><span data-stu-id="a09a4-315">A virtual network with two subnets: “FrontEnd” and “BackEnd”</span></span>
- <span data-ttu-id="a09a4-316">A Network Security Group that is applied to both subnets</span><span class="sxs-lookup"><span data-stu-id="a09a4-316">A Network Security Group that is applied to both subnets</span></span>
- <span data-ttu-id="a09a4-317">A Windows server that represents an application web server (“IIS01”)</span><span class="sxs-lookup"><span data-stu-id="a09a4-317">A Windows server that represents an application web server (“IIS01”)</span></span>
- <span data-ttu-id="a09a4-318">Two Windows servers that represent application back-end servers (“AppVM01”, “AppVM02”)</span><span class="sxs-lookup"><span data-stu-id="a09a4-318">Two Windows servers that represent application back-end servers (“AppVM01”, “AppVM02”)</span></span>
- <span data-ttu-id="a09a4-319">A Windows server that represents a DNS server (“DNS01”)</span><span class="sxs-lookup"><span data-stu-id="a09a4-319">A Windows server that represents a DNS server (“DNS01”)</span></span>
- <span data-ttu-id="a09a4-320">A public IP associated with the application web server</span><span class="sxs-lookup"><span data-stu-id="a09a4-320">A public IP associated with the application web server</span></span>

<span data-ttu-id="a09a4-321">For scripts and an Azure Resource Manager template, see the [detailed build instructions][Example1].</span><span class="sxs-lookup"><span data-stu-id="a09a4-321">For scripts and an Azure Resource Manager template, see the [detailed build instructions][Example1].</span></span>

#### <a name="nsg-description"></a><span data-ttu-id="a09a4-322">NSG description</span><span class="sxs-lookup"><span data-stu-id="a09a4-322">NSG description</span></span>
<span data-ttu-id="a09a4-323">In this example, an NSG group is built and then loaded with six rules.</span><span class="sxs-lookup"><span data-stu-id="a09a4-323">In this example, an NSG group is built and then loaded with six rules.</span></span>

> [!TIP]
> <span data-ttu-id="a09a4-324">Generally speaking, you should create your specific “Allow” rules first, followed by the more generic “Deny” rules.</span><span class="sxs-lookup"><span data-stu-id="a09a4-324">Generally speaking, you should create your specific “Allow” rules first, followed by the more generic “Deny” rules.</span></span> <span data-ttu-id="a09a4-325">The given priority dictates which rules are evaluated first.</span><span class="sxs-lookup"><span data-stu-id="a09a4-325">The given priority dictates which rules are evaluated first.</span></span> <span data-ttu-id="a09a4-326">Once traffic is found to apply to a specific rule, no further rules are evaluated.</span><span class="sxs-lookup"><span data-stu-id="a09a4-326">Once traffic is found to apply to a specific rule, no further rules are evaluated.</span></span> <span data-ttu-id="a09a4-327">NSG rules can apply in either the inbound or outbound direction (from the perspective of the subnet).</span><span class="sxs-lookup"><span data-stu-id="a09a4-327">NSG rules can apply in either the inbound or outbound direction (from the perspective of the subnet).</span></span>
>
>

<span data-ttu-id="a09a4-328">Declaratively, the following rules are being built for inbound traffic:</span><span class="sxs-lookup"><span data-stu-id="a09a4-328">Declaratively, the following rules are being built for inbound traffic:</span></span>

1. <span data-ttu-id="a09a4-329">Internal DNS traffic (port 53) is allowed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-329">Internal DNS traffic (port 53) is allowed.</span></span>
2. <span data-ttu-id="a09a4-330">RDP traffic (port 3389) from the Internet to any Virtual Machine is allowed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-330">RDP traffic (port 3389) from the Internet to any Virtual Machine is allowed.</span></span>
3. <span data-ttu-id="a09a4-331">HTTP traffic (port 80) from the Internet to web server (IIS01) is allowed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-331">HTTP traffic (port 80) from the Internet to web server (IIS01) is allowed.</span></span>
4. <span data-ttu-id="a09a4-332">Any traffic (all ports) from IIS01 to AppVM1 is allowed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-332">Any traffic (all ports) from IIS01 to AppVM1 is allowed.</span></span>
5. <span data-ttu-id="a09a4-333">Any traffic (all ports) from the Internet to the entire virtual network (both subnets) is denied.</span><span class="sxs-lookup"><span data-stu-id="a09a4-333">Any traffic (all ports) from the Internet to the entire virtual network (both subnets) is denied.</span></span>
6. <span data-ttu-id="a09a4-334">Any traffic (all ports) from the front-end subnet to the back-end subnet is denied.</span><span class="sxs-lookup"><span data-stu-id="a09a4-334">Any traffic (all ports) from the front-end subnet to the back-end subnet is denied.</span></span>

<span data-ttu-id="a09a4-335">With these rules bound to each subnet, if an HTTP request was inbound from the Internet to the web server, both rules 3 (allow) and 5 (deny) would apply.</span><span class="sxs-lookup"><span data-stu-id="a09a4-335">With these rules bound to each subnet, if an HTTP request was inbound from the Internet to the web server, both rules 3 (allow) and 5 (deny) would apply.</span></span> <span data-ttu-id="a09a4-336">But because rule 3 has a higher priority, only it would apply, and rule 5 would not come into play.</span><span class="sxs-lookup"><span data-stu-id="a09a4-336">But because rule 3 has a higher priority, only it would apply, and rule 5 would not come into play.</span></span> <span data-ttu-id="a09a4-337">Thus the HTTP request would be allowed to the web server.</span><span class="sxs-lookup"><span data-stu-id="a09a4-337">Thus the HTTP request would be allowed to the web server.</span></span> <span data-ttu-id="a09a4-338">If that same traffic was trying to reach the DNS01 server, rule 5 (deny) would be the first to apply, and the traffic would not be allowed to pass to the server.</span><span class="sxs-lookup"><span data-stu-id="a09a4-338">If that same traffic was trying to reach the DNS01 server, rule 5 (deny) would be the first to apply, and the traffic would not be allowed to pass to the server.</span></span> <span data-ttu-id="a09a4-339">Rule 6 (deny) blocks the front-end subnet from talking to the back-end subnet (except for allowed traffic in rules 1 and 4).</span><span class="sxs-lookup"><span data-stu-id="a09a4-339">Rule 6 (deny) blocks the front-end subnet from talking to the back-end subnet (except for allowed traffic in rules 1 and 4).</span></span> <span data-ttu-id="a09a4-340">This rule-set protects the back-end network in case an attacker compromises the web application on the front end.</span><span class="sxs-lookup"><span data-stu-id="a09a4-340">This rule-set protects the back-end network in case an attacker compromises the web application on the front end.</span></span> <span data-ttu-id="a09a4-341">The attacker would have limited access to the back-end “protected” network (only to resources exposed on the AppVM01 server).</span><span class="sxs-lookup"><span data-stu-id="a09a4-341">The attacker would have limited access to the back-end “protected” network (only to resources exposed on the AppVM01 server).</span></span>

<span data-ttu-id="a09a4-342">There is a default outbound rule that allows traffic out to the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-342">There is a default outbound rule that allows traffic out to the Internet.</span></span> <span data-ttu-id="a09a4-343">For this example, we’re allowing outbound traffic and not modifying any outbound rules.</span><span class="sxs-lookup"><span data-stu-id="a09a4-343">For this example, we’re allowing outbound traffic and not modifying any outbound rules.</span></span> <span data-ttu-id="a09a4-344">To lock down traffic in both directions, user-defined routing is required (see example 3).</span><span class="sxs-lookup"><span data-stu-id="a09a4-344">To lock down traffic in both directions, user-defined routing is required (see example 3).</span></span>

#### <a name="conclusion"></a><span data-ttu-id="a09a4-345">Conclusion</span><span class="sxs-lookup"><span data-stu-id="a09a4-345">Conclusion</span></span>
<span data-ttu-id="a09a4-346">This example is a relatively simple and straightforward way of isolating the back-end subnet from inbound traffic.</span><span class="sxs-lookup"><span data-stu-id="a09a4-346">This example is a relatively simple and straightforward way of isolating the back-end subnet from inbound traffic.</span></span> <span data-ttu-id="a09a4-347">For more information, see the [detailed build instructions][Example1].</span><span class="sxs-lookup"><span data-stu-id="a09a4-347">For more information, see the [detailed build instructions][Example1].</span></span> <span data-ttu-id="a09a4-348">These instructions include:</span><span class="sxs-lookup"><span data-stu-id="a09a4-348">These instructions include:</span></span>

* <span data-ttu-id="a09a4-349">How to build this perimeter network with classic PowerShell scripts.</span><span class="sxs-lookup"><span data-stu-id="a09a4-349">How to build this perimeter network with classic PowerShell scripts.</span></span>
* <span data-ttu-id="a09a4-350">How to build this perimeter network with an Azure Resource Manager template.</span><span class="sxs-lookup"><span data-stu-id="a09a4-350">How to build this perimeter network with an Azure Resource Manager template.</span></span>
* <span data-ttu-id="a09a4-351">Detailed descriptions of each NSG command.</span><span class="sxs-lookup"><span data-stu-id="a09a4-351">Detailed descriptions of each NSG command.</span></span>
* <span data-ttu-id="a09a4-352">Detailed traffic flow scenarios, showing how traffic is allowed or denied in each layer.</span><span class="sxs-lookup"><span data-stu-id="a09a4-352">Detailed traffic flow scenarios, showing how traffic is allowed or denied in each layer.</span></span>


### <a name="example-2-build-a-perimeter-network-to-help-protect-applications-with-a-firewall-and-nsgs"></a><span data-ttu-id="a09a4-353">Example 2 Build a perimeter network to help protect applications with a firewall and NSGs</span><span class="sxs-lookup"><span data-stu-id="a09a4-353">Example 2 Build a perimeter network to help protect applications with a firewall and NSGs</span></span>
<span data-ttu-id="a09a4-354">[Back to Fast start](#fast-start) | [Detailed build instructions for this example][Example2]</span><span class="sxs-lookup"><span data-stu-id="a09a4-354">[Back to Fast start](#fast-start) | [Detailed build instructions for this example][Example2]</span></span>

<span data-ttu-id="a09a4-355">[![8]][8]</span><span class="sxs-lookup"><span data-stu-id="a09a4-355">[![8]][8]</span></span>

#### <a name="environment-description"></a><span data-ttu-id="a09a4-356">Environment description</span><span class="sxs-lookup"><span data-stu-id="a09a4-356">Environment description</span></span>
<span data-ttu-id="a09a4-357">In this example, there is a subscription that contains the following resources:</span><span class="sxs-lookup"><span data-stu-id="a09a4-357">In this example, there is a subscription that contains the following resources:</span></span>

* <span data-ttu-id="a09a4-358">A single resource group</span><span class="sxs-lookup"><span data-stu-id="a09a4-358">A single resource group</span></span>
* <span data-ttu-id="a09a4-359">A virtual network with two subnets: “FrontEnd” and “BackEnd”</span><span class="sxs-lookup"><span data-stu-id="a09a4-359">A virtual network with two subnets: “FrontEnd” and “BackEnd”</span></span>
* <span data-ttu-id="a09a4-360">A Network Security Group that is applied to both subnets</span><span class="sxs-lookup"><span data-stu-id="a09a4-360">A Network Security Group that is applied to both subnets</span></span>
* <span data-ttu-id="a09a4-361">A network virtual appliance, in this case a firewall, connected to the front-end subnet</span><span class="sxs-lookup"><span data-stu-id="a09a4-361">A network virtual appliance, in this case a firewall, connected to the front-end subnet</span></span>
* <span data-ttu-id="a09a4-362">A Windows server that represents an application web server (“IIS01”)</span><span class="sxs-lookup"><span data-stu-id="a09a4-362">A Windows server that represents an application web server (“IIS01”)</span></span>
* <span data-ttu-id="a09a4-363">Two Windows servers that represent application back-end servers (“AppVM01”, “AppVM02”)</span><span class="sxs-lookup"><span data-stu-id="a09a4-363">Two Windows servers that represent application back-end servers (“AppVM01”, “AppVM02”)</span></span>
* <span data-ttu-id="a09a4-364">A Windows server that represents a DNS server (“DNS01”)</span><span class="sxs-lookup"><span data-stu-id="a09a4-364">A Windows server that represents a DNS server (“DNS01”)</span></span>

<span data-ttu-id="a09a4-365">For scripts and an Azure Resource Manager template, see the [detailed build instructions][Example2].</span><span class="sxs-lookup"><span data-stu-id="a09a4-365">For scripts and an Azure Resource Manager template, see the [detailed build instructions][Example2].</span></span>

#### <a name="nsg-description"></a><span data-ttu-id="a09a4-366">NSG description</span><span class="sxs-lookup"><span data-stu-id="a09a4-366">NSG description</span></span>
<span data-ttu-id="a09a4-367">In this example, an NSG group is built and then loaded with six rules.</span><span class="sxs-lookup"><span data-stu-id="a09a4-367">In this example, an NSG group is built and then loaded with six rules.</span></span>

> [!TIP]
> <span data-ttu-id="a09a4-368">Generally speaking, you should create your specific “Allow” rules first, followed by the more generic “Deny” rules.</span><span class="sxs-lookup"><span data-stu-id="a09a4-368">Generally speaking, you should create your specific “Allow” rules first, followed by the more generic “Deny” rules.</span></span> <span data-ttu-id="a09a4-369">The given priority dictates which rules are evaluated first.</span><span class="sxs-lookup"><span data-stu-id="a09a4-369">The given priority dictates which rules are evaluated first.</span></span> <span data-ttu-id="a09a4-370">Once traffic is found to apply to a specific rule, no further rules are evaluated.</span><span class="sxs-lookup"><span data-stu-id="a09a4-370">Once traffic is found to apply to a specific rule, no further rules are evaluated.</span></span> <span data-ttu-id="a09a4-371">NSG rules can apply in either the inbound or outbound direction (from the perspective of the subnet).</span><span class="sxs-lookup"><span data-stu-id="a09a4-371">NSG rules can apply in either the inbound or outbound direction (from the perspective of the subnet).</span></span>
>
>

<span data-ttu-id="a09a4-372">Declaratively, the following rules are being built for inbound traffic:</span><span class="sxs-lookup"><span data-stu-id="a09a4-372">Declaratively, the following rules are being built for inbound traffic:</span></span>

1. <span data-ttu-id="a09a4-373">Internal DNS traffic (port 53) is allowed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-373">Internal DNS traffic (port 53) is allowed.</span></span>
2. <span data-ttu-id="a09a4-374">RDP traffic (port 3389) from the Internet to any Virtual Machine is allowed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-374">RDP traffic (port 3389) from the Internet to any Virtual Machine is allowed.</span></span>
3. <span data-ttu-id="a09a4-375">Any Internet traffic (all ports) to the network virtual appliance (firewall) is allowed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-375">Any Internet traffic (all ports) to the network virtual appliance (firewall) is allowed.</span></span>
4. <span data-ttu-id="a09a4-376">Any traffic (all ports) from IIS01 to AppVM1 is allowed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-376">Any traffic (all ports) from IIS01 to AppVM1 is allowed.</span></span>
5. <span data-ttu-id="a09a4-377">Any traffic (all ports) from the Internet to the entire virtual network (both subnets) is denied.</span><span class="sxs-lookup"><span data-stu-id="a09a4-377">Any traffic (all ports) from the Internet to the entire virtual network (both subnets) is denied.</span></span>
6. <span data-ttu-id="a09a4-378">Any traffic (all ports) from the front-end subnet to the back-end subnet is denied.</span><span class="sxs-lookup"><span data-stu-id="a09a4-378">Any traffic (all ports) from the front-end subnet to the back-end subnet is denied.</span></span>

<span data-ttu-id="a09a4-379">With these rules bound to each subnet, if an HTTP request was inbound from the Internet to the firewall, both rules 3 (allow) and 5 (deny) would apply.</span><span class="sxs-lookup"><span data-stu-id="a09a4-379">With these rules bound to each subnet, if an HTTP request was inbound from the Internet to the firewall, both rules 3 (allow) and 5 (deny) would apply.</span></span> <span data-ttu-id="a09a4-380">But because rule 3 has a higher priority, only it would apply, and rule 5 would not come into play.</span><span class="sxs-lookup"><span data-stu-id="a09a4-380">But because rule 3 has a higher priority, only it would apply, and rule 5 would not come into play.</span></span> <span data-ttu-id="a09a4-381">Thus the HTTP request would be allowed to the firewall.</span><span class="sxs-lookup"><span data-stu-id="a09a4-381">Thus the HTTP request would be allowed to the firewall.</span></span> <span data-ttu-id="a09a4-382">If that same traffic was trying to reach the IIS01 server, even though it’s on the front-end subnet, rule 5 (deny) would apply, and the traffic would not be allowed to pass to the server.</span><span class="sxs-lookup"><span data-stu-id="a09a4-382">If that same traffic was trying to reach the IIS01 server, even though it’s on the front-end subnet, rule 5 (deny) would apply, and the traffic would not be allowed to pass to the server.</span></span> <span data-ttu-id="a09a4-383">Rule 6 (deny) blocks the front-end subnet from talking to the back-end subnet (except for allowed traffic in rules 1 and 4).</span><span class="sxs-lookup"><span data-stu-id="a09a4-383">Rule 6 (deny) blocks the front-end subnet from talking to the back-end subnet (except for allowed traffic in rules 1 and 4).</span></span> <span data-ttu-id="a09a4-384">This rule-set protects the back-end network in case an attacker compromises the web application on the front end.</span><span class="sxs-lookup"><span data-stu-id="a09a4-384">This rule-set protects the back-end network in case an attacker compromises the web application on the front end.</span></span> <span data-ttu-id="a09a4-385">The attacker would have limited access to the back-end “protected” network (only to resources exposed on the AppVM01 server).</span><span class="sxs-lookup"><span data-stu-id="a09a4-385">The attacker would have limited access to the back-end “protected” network (only to resources exposed on the AppVM01 server).</span></span>

<span data-ttu-id="a09a4-386">There is a default outbound rule that allows traffic out to the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-386">There is a default outbound rule that allows traffic out to the Internet.</span></span> <span data-ttu-id="a09a4-387">For this example, we’re allowing outbound traffic and not modifying any outbound rules.</span><span class="sxs-lookup"><span data-stu-id="a09a4-387">For this example, we’re allowing outbound traffic and not modifying any outbound rules.</span></span> <span data-ttu-id="a09a4-388">To lock down traffic in both directions, user-defined routing is required (see example 3).</span><span class="sxs-lookup"><span data-stu-id="a09a4-388">To lock down traffic in both directions, user-defined routing is required (see example 3).</span></span>

#### <a name="firewall-rule-description"></a><span data-ttu-id="a09a4-389">Firewall rule description</span><span class="sxs-lookup"><span data-stu-id="a09a4-389">Firewall rule description</span></span>
<span data-ttu-id="a09a4-390">On the firewall, forwarding rules should be created.</span><span class="sxs-lookup"><span data-stu-id="a09a4-390">On the firewall, forwarding rules should be created.</span></span> <span data-ttu-id="a09a4-391">Since this example only routes Internet traffic in-bound to the firewall and then to the web server, only one forwarding network address translation (NAT) rule is needed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-391">Since this example only routes Internet traffic in-bound to the firewall and then to the web server, only one forwarding network address translation (NAT) rule is needed.</span></span>

<span data-ttu-id="a09a4-392">The forwarding rule accepts any inbound source address that hits the firewall trying to reach HTTP (port 80 or 443 for HTTPS).</span><span class="sxs-lookup"><span data-stu-id="a09a4-392">The forwarding rule accepts any inbound source address that hits the firewall trying to reach HTTP (port 80 or 443 for HTTPS).</span></span> <span data-ttu-id="a09a4-393">It's sent out of the firewall’s local interface and redirected to the web server with the IP Address of 10.0.1.5.</span><span class="sxs-lookup"><span data-stu-id="a09a4-393">It's sent out of the firewall’s local interface and redirected to the web server with the IP Address of 10.0.1.5.</span></span>

#### <a name="conclusion"></a><span data-ttu-id="a09a4-394">Conclusion</span><span class="sxs-lookup"><span data-stu-id="a09a4-394">Conclusion</span></span>
<span data-ttu-id="a09a4-395">This example is a relatively straightforward way of protecting your application with a firewall and isolating the back-end subnet from inbound traffic.</span><span class="sxs-lookup"><span data-stu-id="a09a4-395">This example is a relatively straightforward way of protecting your application with a firewall and isolating the back-end subnet from inbound traffic.</span></span> <span data-ttu-id="a09a4-396">For more information, see the [detailed build instructions][Example2].</span><span class="sxs-lookup"><span data-stu-id="a09a4-396">For more information, see the [detailed build instructions][Example2].</span></span> <span data-ttu-id="a09a4-397">These instructions include:</span><span class="sxs-lookup"><span data-stu-id="a09a4-397">These instructions include:</span></span>

* <span data-ttu-id="a09a4-398">How to build this perimeter network with classic PowerShell scripts.</span><span class="sxs-lookup"><span data-stu-id="a09a4-398">How to build this perimeter network with classic PowerShell scripts.</span></span>
* <span data-ttu-id="a09a4-399">How to build this example with an Azure Resource Manager template.</span><span class="sxs-lookup"><span data-stu-id="a09a4-399">How to build this example with an Azure Resource Manager template.</span></span>
* <span data-ttu-id="a09a4-400">Detailed descriptions of each NSG command and firewall rule.</span><span class="sxs-lookup"><span data-stu-id="a09a4-400">Detailed descriptions of each NSG command and firewall rule.</span></span>
* <span data-ttu-id="a09a4-401">Detailed traffic flow scenarios, showing how traffic is allowed or denied in each layer.</span><span class="sxs-lookup"><span data-stu-id="a09a4-401">Detailed traffic flow scenarios, showing how traffic is allowed or denied in each layer.</span></span>

### <a name="example-3-build-a-perimeter-network-to-help-protect-networks-with-a-firewall-and-udr-and-nsg"></a><span data-ttu-id="a09a4-402">Example 3 Build a perimeter network to help protect networks with a firewall and UDR and NSG</span><span class="sxs-lookup"><span data-stu-id="a09a4-402">Example 3 Build a perimeter network to help protect networks with a firewall and UDR and NSG</span></span>
<span data-ttu-id="a09a4-403">[Back to Fast start](#fast-start) | [Detailed build instructions for this example][Example3]</span><span class="sxs-lookup"><span data-stu-id="a09a4-403">[Back to Fast start](#fast-start) | [Detailed build instructions for this example][Example3]</span></span>

<span data-ttu-id="a09a4-404">[![9]][9]</span><span class="sxs-lookup"><span data-stu-id="a09a4-404">[![9]][9]</span></span>

#### <a name="environment-description"></a><span data-ttu-id="a09a4-405">Environment description</span><span class="sxs-lookup"><span data-stu-id="a09a4-405">Environment description</span></span>
<span data-ttu-id="a09a4-406">In this example, there is a subscription that contains the following resources:</span><span class="sxs-lookup"><span data-stu-id="a09a4-406">In this example, there is a subscription that contains the following resources:</span></span>

* <span data-ttu-id="a09a4-407">A single resource group</span><span class="sxs-lookup"><span data-stu-id="a09a4-407">A single resource group</span></span>
* <span data-ttu-id="a09a4-408">A virtual network with three subnets: “SecNet”, “FrontEnd”, and “BackEnd”</span><span class="sxs-lookup"><span data-stu-id="a09a4-408">A virtual network with three subnets: “SecNet”, “FrontEnd”, and “BackEnd”</span></span>
* <span data-ttu-id="a09a4-409">A network virtual appliance, in this case a firewall, connected to the SecNet subnet</span><span class="sxs-lookup"><span data-stu-id="a09a4-409">A network virtual appliance, in this case a firewall, connected to the SecNet subnet</span></span>
* <span data-ttu-id="a09a4-410">A Windows server that represents an application web server (“IIS01”)</span><span class="sxs-lookup"><span data-stu-id="a09a4-410">A Windows server that represents an application web server (“IIS01”)</span></span>
* <span data-ttu-id="a09a4-411">Two Windows servers that represent application back-end servers (“AppVM01”, “AppVM02”)</span><span class="sxs-lookup"><span data-stu-id="a09a4-411">Two Windows servers that represent application back-end servers (“AppVM01”, “AppVM02”)</span></span>
* <span data-ttu-id="a09a4-412">A Windows server that represents a DNS server (“DNS01”)</span><span class="sxs-lookup"><span data-stu-id="a09a4-412">A Windows server that represents a DNS server (“DNS01”)</span></span>

<span data-ttu-id="a09a4-413">For scripts and an Azure Resource Manager template, see the [detailed build instructions][Example3].</span><span class="sxs-lookup"><span data-stu-id="a09a4-413">For scripts and an Azure Resource Manager template, see the [detailed build instructions][Example3].</span></span>

#### <a name="udr-description"></a><span data-ttu-id="a09a4-414">UDR description</span><span class="sxs-lookup"><span data-stu-id="a09a4-414">UDR description</span></span>
<span data-ttu-id="a09a4-415">By default, the following system routes are defined as:</span><span class="sxs-lookup"><span data-stu-id="a09a4-415">By default, the following system routes are defined as:</span></span>

        Effective routes :
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.0.0/16}     VNETLocal                            Active   Default    
         {0.0.0.0/0}       Internet                             Active   Default    
         {10.0.0.0/8}      Null                                 Active   Default    
         {100.64.0.0/10}   Null                                 Active   Default    
         {172.16.0.0/12}   Null                                 Active   Default    
         {192.168.0.0/16}  Null                                 Active   Default

<span data-ttu-id="a09a4-416">The VNETLocal is always one or more defined address prefixes that make up the virtual network for that specific network (that is, it changes from virtual network to virtual network, depending on how each specific virtual network is defined).</span><span class="sxs-lookup"><span data-stu-id="a09a4-416">The VNETLocal is always one or more defined address prefixes that make up the virtual network for that specific network (that is, it changes from virtual network to virtual network, depending on how each specific virtual network is defined).</span></span> <span data-ttu-id="a09a4-417">The remaining system routes are static and default as indicated in the table.</span><span class="sxs-lookup"><span data-stu-id="a09a4-417">The remaining system routes are static and default as indicated in the table.</span></span>

<span data-ttu-id="a09a4-418">In this example, two routing tables are created, one each for the front-end and back-end subnets.</span><span class="sxs-lookup"><span data-stu-id="a09a4-418">In this example, two routing tables are created, one each for the front-end and back-end subnets.</span></span> <span data-ttu-id="a09a4-419">Each table is loaded with static routes appropriate for the given subnet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-419">Each table is loaded with static routes appropriate for the given subnet.</span></span> <span data-ttu-id="a09a4-420">In this example, each table has three routes that direct all traffic (0.0.0.0/0) through the firewall (Next hop = Virtual Appliance IP address):</span><span class="sxs-lookup"><span data-stu-id="a09a4-420">In this example, each table has three routes that direct all traffic (0.0.0.0/0) through the firewall (Next hop = Virtual Appliance IP address):</span></span>

1. <span data-ttu-id="a09a4-421">Local subnet traffic with no Next Hop defined to allow local subnet traffic to bypass the firewall.</span><span class="sxs-lookup"><span data-stu-id="a09a4-421">Local subnet traffic with no Next Hop defined to allow local subnet traffic to bypass the firewall.</span></span>
2. <span data-ttu-id="a09a4-422">Virtual network traffic with a Next Hop defined as firewall.</span><span class="sxs-lookup"><span data-stu-id="a09a4-422">Virtual network traffic with a Next Hop defined as firewall.</span></span> <span data-ttu-id="a09a4-423">This next hop overrides the default rule that allows local virtual network traffic to route directly.</span><span class="sxs-lookup"><span data-stu-id="a09a4-423">This next hop overrides the default rule that allows local virtual network traffic to route directly.</span></span>
3. <span data-ttu-id="a09a4-424">All remaining traffic (0/0) with a Next Hop defined as the firewall.</span><span class="sxs-lookup"><span data-stu-id="a09a4-424">All remaining traffic (0/0) with a Next Hop defined as the firewall.</span></span>

> [!TIP]
> <span data-ttu-id="a09a4-425">Not having the local subnet entry in the UDR breaks local subnet communications.</span><span class="sxs-lookup"><span data-stu-id="a09a4-425">Not having the local subnet entry in the UDR breaks local subnet communications.</span></span>
>
> * <span data-ttu-id="a09a4-426">In our example, 10.0.1.0/24 pointing to VNETLocal is critical!</span><span class="sxs-lookup"><span data-stu-id="a09a4-426">In our example, 10.0.1.0/24 pointing to VNETLocal is critical!</span></span> <span data-ttu-id="a09a4-427">Without it, packet leaving the Web Server (10.0.1.4) destined to another local server (for example) 10.0.1.25 will fail as they will be sent to the NVA.</span><span class="sxs-lookup"><span data-stu-id="a09a4-427">Without it, packet leaving the Web Server (10.0.1.4) destined to another local server (for example) 10.0.1.25 will fail as they will be sent to the NVA.</span></span> <span data-ttu-id="a09a4-428">The NVA will send it to the subnet, and the subnet will resend it to the NVA in an infinite loop.</span><span class="sxs-lookup"><span data-stu-id="a09a4-428">The NVA will send it to the subnet, and the subnet will resend it to the NVA in an infinite loop.</span></span>
> * <span data-ttu-id="a09a4-429">The chances of a routing loop are typically higher on appliances with multiple NICs that are connected to separate subnets, which is often of traditional, on-premises appliances.</span><span class="sxs-lookup"><span data-stu-id="a09a4-429">The chances of a routing loop are typically higher on appliances with multiple NICs that are connected to separate subnets, which is often of traditional, on-premises appliances.</span></span>
>
>

<span data-ttu-id="a09a4-430">Once the routing tables are created, they must be bound to their subnets.</span><span class="sxs-lookup"><span data-stu-id="a09a4-430">Once the routing tables are created, they must be bound to their subnets.</span></span> <span data-ttu-id="a09a4-431">The front-end subnet routing table, once created and bound to the subnet, would look like this output:</span><span class="sxs-lookup"><span data-stu-id="a09a4-431">The front-end subnet routing table, once created and bound to the subnet, would look like this output:</span></span>

        Effective routes :
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.1.0/24}     VNETLocal                            Active
         {10.0.0.0/16}     VirtualAppliance 10.0.0.4            Active    
         {0.0.0.0/0}       VirtualAppliance 10.0.0.4            Active

> [!NOTE]
> <span data-ttu-id="a09a4-432">UDR can now be applied to the gateway subnet on which the ExpressRoute circuit is connected.</span><span class="sxs-lookup"><span data-stu-id="a09a4-432">UDR can now be applied to the gateway subnet on which the ExpressRoute circuit is connected.</span></span>
>
> <span data-ttu-id="a09a4-433">Examples of how to enable your perimeter network with ExpressRoute or site-to-site networking are shown in examples 3 and 4.</span><span class="sxs-lookup"><span data-stu-id="a09a4-433">Examples of how to enable your perimeter network with ExpressRoute or site-to-site networking are shown in examples 3 and 4.</span></span>
>
>

#### <a name="ip-forwarding-description"></a><span data-ttu-id="a09a4-434">IP Forwarding description</span><span class="sxs-lookup"><span data-stu-id="a09a4-434">IP Forwarding description</span></span>
<span data-ttu-id="a09a4-435">IP Forwarding is a companion feature to UDR.</span><span class="sxs-lookup"><span data-stu-id="a09a4-435">IP Forwarding is a companion feature to UDR.</span></span> <span data-ttu-id="a09a4-436">IP Forwarding is a setting on a virtual appliance that allows it to receive traffic not specifically addressed to the appliance, and then forward that traffic to its ultimate destination.</span><span class="sxs-lookup"><span data-stu-id="a09a4-436">IP Forwarding is a setting on a virtual appliance that allows it to receive traffic not specifically addressed to the appliance, and then forward that traffic to its ultimate destination.</span></span>

<span data-ttu-id="a09a4-437">For example, if AppVM01 makes a request to the DNS01 server, UDR would route this traffic to the firewall.</span><span class="sxs-lookup"><span data-stu-id="a09a4-437">For example, if AppVM01 makes a request to the DNS01 server, UDR would route this traffic to the firewall.</span></span> <span data-ttu-id="a09a4-438">With IP Forwarding enabled, the traffic for the DNS01 destination (10.0.2.4) is accepted by the appliance (10.0.0.4) and then forwarded to its ultimate destination (10.0.2.4).</span><span class="sxs-lookup"><span data-stu-id="a09a4-438">With IP Forwarding enabled, the traffic for the DNS01 destination (10.0.2.4) is accepted by the appliance (10.0.0.4) and then forwarded to its ultimate destination (10.0.2.4).</span></span> <span data-ttu-id="a09a4-439">Without IP Forwarding enabled on the firewall, traffic would not be accepted by the appliance even though the route table has the firewall as the next hop.</span><span class="sxs-lookup"><span data-stu-id="a09a4-439">Without IP Forwarding enabled on the firewall, traffic would not be accepted by the appliance even though the route table has the firewall as the next hop.</span></span> <span data-ttu-id="a09a4-440">To use a virtual appliance, it’s critical to remember to enable IP Forwarding along with UDR.</span><span class="sxs-lookup"><span data-stu-id="a09a4-440">To use a virtual appliance, it’s critical to remember to enable IP Forwarding along with UDR.</span></span>

#### <a name="nsg-description"></a><span data-ttu-id="a09a4-441">NSG description</span><span class="sxs-lookup"><span data-stu-id="a09a4-441">NSG description</span></span>
<span data-ttu-id="a09a4-442">In this example, an NSG group is built and then loaded with a single rule.</span><span class="sxs-lookup"><span data-stu-id="a09a4-442">In this example, an NSG group is built and then loaded with a single rule.</span></span> <span data-ttu-id="a09a4-443">This group is then bound only to the front-end and back-end subnets (not the SecNet).</span><span class="sxs-lookup"><span data-stu-id="a09a4-443">This group is then bound only to the front-end and back-end subnets (not the SecNet).</span></span> <span data-ttu-id="a09a4-444">Declaratively the following rule is being built:</span><span class="sxs-lookup"><span data-stu-id="a09a4-444">Declaratively the following rule is being built:</span></span>

* <span data-ttu-id="a09a4-445">Any traffic (all ports) from the Internet to the entire virtual network (all subnets) is denied.</span><span class="sxs-lookup"><span data-stu-id="a09a4-445">Any traffic (all ports) from the Internet to the entire virtual network (all subnets) is denied.</span></span>

<span data-ttu-id="a09a4-446">Although NSGs are used in this example, its main purpose is as a secondary layer of defense against manual misconfiguration.</span><span class="sxs-lookup"><span data-stu-id="a09a4-446">Although NSGs are used in this example, its main purpose is as a secondary layer of defense against manual misconfiguration.</span></span> <span data-ttu-id="a09a4-447">The goal is to block all inbound traffic from the Internet to either the front-end or back-end subnets.</span><span class="sxs-lookup"><span data-stu-id="a09a4-447">The goal is to block all inbound traffic from the Internet to either the front-end or back-end subnets.</span></span> <span data-ttu-id="a09a4-448">Traffic should only flow through the SecNet subnet to the firewall (and then, if appropriate, on to the front-end or back-end subnets).</span><span class="sxs-lookup"><span data-stu-id="a09a4-448">Traffic should only flow through the SecNet subnet to the firewall (and then, if appropriate, on to the front-end or back-end subnets).</span></span> <span data-ttu-id="a09a4-449">Plus, with the UDR rules in place, any traffic that did make it into the front-end or back-end subnets would be directed out to the firewall (thanks to UDR).</span><span class="sxs-lookup"><span data-stu-id="a09a4-449">Plus, with the UDR rules in place, any traffic that did make it into the front-end or back-end subnets would be directed out to the firewall (thanks to UDR).</span></span> <span data-ttu-id="a09a4-450">The firewall would see this traffic as an asymmetric flow and would drop the outbound traffic.</span><span class="sxs-lookup"><span data-stu-id="a09a4-450">The firewall would see this traffic as an asymmetric flow and would drop the outbound traffic.</span></span> <span data-ttu-id="a09a4-451">Thus there are three layers of security protecting the subnets:</span><span class="sxs-lookup"><span data-stu-id="a09a4-451">Thus there are three layers of security protecting the subnets:</span></span>

* <span data-ttu-id="a09a4-452">No Public IP addresses on any FrontEnd or BackEnd NICs.</span><span class="sxs-lookup"><span data-stu-id="a09a4-452">No Public IP addresses on any FrontEnd or BackEnd NICs.</span></span>
* <span data-ttu-id="a09a4-453">NSGs denying traffic from the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-453">NSGs denying traffic from the Internet.</span></span>
* <span data-ttu-id="a09a4-454">The firewall dropping asymmetric traffic.</span><span class="sxs-lookup"><span data-stu-id="a09a4-454">The firewall dropping asymmetric traffic.</span></span>

<span data-ttu-id="a09a4-455">One interesting point regarding the NSG in this example is that it contains only one rule, which is to deny Internet traffic to the entire virtual network, including the Security subnet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-455">One interesting point regarding the NSG in this example is that it contains only one rule, which is to deny Internet traffic to the entire virtual network, including the Security subnet.</span></span> <span data-ttu-id="a09a4-456">However, since the NSG is only bound to the front-end and back-end subnets, the rule isn’t processed on traffic inbound to the Security subnet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-456">However, since the NSG is only bound to the front-end and back-end subnets, the rule isn’t processed on traffic inbound to the Security subnet.</span></span> <span data-ttu-id="a09a4-457">As a result, traffic flows to the Security subnet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-457">As a result, traffic flows to the Security subnet.</span></span>

#### <a name="firewall-rules"></a><span data-ttu-id="a09a4-458">Firewall rules</span><span class="sxs-lookup"><span data-stu-id="a09a4-458">Firewall rules</span></span>
<span data-ttu-id="a09a4-459">On the firewall, forwarding rules should be created.</span><span class="sxs-lookup"><span data-stu-id="a09a4-459">On the firewall, forwarding rules should be created.</span></span> <span data-ttu-id="a09a4-460">Since the firewall is blocking or forwarding all inbound, outbound, and intra-virtual network traffic, many firewall rules are needed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-460">Since the firewall is blocking or forwarding all inbound, outbound, and intra-virtual network traffic, many firewall rules are needed.</span></span> <span data-ttu-id="a09a4-461">Also, all inbound traffic hits the Security Service public IP address (on different ports), to be processed by the firewall.</span><span class="sxs-lookup"><span data-stu-id="a09a4-461">Also, all inbound traffic hits the Security Service public IP address (on different ports), to be processed by the firewall.</span></span> <span data-ttu-id="a09a4-462">A best practice is to diagram the logical flows before setting up the subnets and firewall rules, to avoid rework later.</span><span class="sxs-lookup"><span data-stu-id="a09a4-462">A best practice is to diagram the logical flows before setting up the subnets and firewall rules, to avoid rework later.</span></span> <span data-ttu-id="a09a4-463">The following figure is a logical view of the firewall rules for this example:</span><span class="sxs-lookup"><span data-stu-id="a09a4-463">The following figure is a logical view of the firewall rules for this example:</span></span>

<span data-ttu-id="a09a4-464">![10]</span><span class="sxs-lookup"><span data-stu-id="a09a4-464">![10]</span></span>

> [!NOTE]
> <span data-ttu-id="a09a4-465">Based on the Network Virtual Appliance used, the management ports vary.</span><span class="sxs-lookup"><span data-stu-id="a09a4-465">Based on the Network Virtual Appliance used, the management ports vary.</span></span> <span data-ttu-id="a09a4-466">In this example, a Barracuda NextGen Firewall is referenced, which uses ports 22, 801, and 807.</span><span class="sxs-lookup"><span data-stu-id="a09a4-466">In this example, a Barracuda NextGen Firewall is referenced, which uses ports 22, 801, and 807.</span></span> <span data-ttu-id="a09a4-467">Consult the appliance vendor documentation to find the exact ports used for management of the device being used.</span><span class="sxs-lookup"><span data-stu-id="a09a4-467">Consult the appliance vendor documentation to find the exact ports used for management of the device being used.</span></span>
>
>

#### <a name="firewall-rules-description"></a><span data-ttu-id="a09a4-468">Firewall rules description</span><span class="sxs-lookup"><span data-stu-id="a09a4-468">Firewall rules description</span></span>
<span data-ttu-id="a09a4-469">In the preceding logical diagram, the security subnet is not shown because the firewall is the only resource on that subnet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-469">In the preceding logical diagram, the security subnet is not shown because the firewall is the only resource on that subnet.</span></span> <span data-ttu-id="a09a4-470">The diagram is showing the firewall rules and how they logically allow or deny traffic flows, not the actual routed path.</span><span class="sxs-lookup"><span data-stu-id="a09a4-470">The diagram is showing the firewall rules and how they logically allow or deny traffic flows, not the actual routed path.</span></span> <span data-ttu-id="a09a4-471">Also, the external ports selected for the RDP traffic are higher ranged ports (8014 – 8026) and were selected to loosely align with the last two octets of the local IP address for easier readability (for example, local server address 10.0.1.4 is associated with external port 8014).</span><span class="sxs-lookup"><span data-stu-id="a09a4-471">Also, the external ports selected for the RDP traffic are higher ranged ports (8014 – 8026) and were selected to loosely align with the last two octets of the local IP address for easier readability (for example, local server address 10.0.1.4 is associated with external port 8014).</span></span> <span data-ttu-id="a09a4-472">Any higher non-conflicting ports, however, could be used.</span><span class="sxs-lookup"><span data-stu-id="a09a4-472">Any higher non-conflicting ports, however, could be used.</span></span>

<span data-ttu-id="a09a4-473">For this example, we need seven types of rules:</span><span class="sxs-lookup"><span data-stu-id="a09a4-473">For this example, we need seven types of rules:</span></span>

* <span data-ttu-id="a09a4-474">External rules (for inbound traffic):</span><span class="sxs-lookup"><span data-stu-id="a09a4-474">External rules (for inbound traffic):</span></span>
  1. <span data-ttu-id="a09a4-475">Firewall management rule: This App Redirect rule allows traffic to pass to the management ports of the network virtual appliance.</span><span class="sxs-lookup"><span data-stu-id="a09a4-475">Firewall management rule: This App Redirect rule allows traffic to pass to the management ports of the network virtual appliance.</span></span>
  2. <span data-ttu-id="a09a4-476">RDP rules (for each Windows server): These four rules (one for each server) allow management of the individual servers via RDP.</span><span class="sxs-lookup"><span data-stu-id="a09a4-476">RDP rules (for each Windows server): These four rules (one for each server) allow management of the individual servers via RDP.</span></span> <span data-ttu-id="a09a4-477">The four RDP rules could also be collapsed into one rule, depending on the capabilities of the network virtual appliance being used.</span><span class="sxs-lookup"><span data-stu-id="a09a4-477">The four RDP rules could also be collapsed into one rule, depending on the capabilities of the network virtual appliance being used.</span></span>
  3. <span data-ttu-id="a09a4-478">Application traffic rules: There are two of these rules, the first for the front-end web traffic, and the second for the back-end traffic (for example, web server to data tier).</span><span class="sxs-lookup"><span data-stu-id="a09a4-478">Application traffic rules: There are two of these rules, the first for the front-end web traffic, and the second for the back-end traffic (for example, web server to data tier).</span></span> <span data-ttu-id="a09a4-479">The configuration of these rules depends on the network architecture (where your servers are placed) and traffic flows (which direction the traffic flows, and which ports are used).</span><span class="sxs-lookup"><span data-stu-id="a09a4-479">The configuration of these rules depends on the network architecture (where your servers are placed) and traffic flows (which direction the traffic flows, and which ports are used).</span></span>
     * <span data-ttu-id="a09a4-480">The first rule allows the actual application traffic to reach the application server.</span><span class="sxs-lookup"><span data-stu-id="a09a4-480">The first rule allows the actual application traffic to reach the application server.</span></span> <span data-ttu-id="a09a4-481">While the other rules allow for security and management, application traffic rules are what allow external users or services to access the applications.</span><span class="sxs-lookup"><span data-stu-id="a09a4-481">While the other rules allow for security and management, application traffic rules are what allow external users or services to access the applications.</span></span> <span data-ttu-id="a09a4-482">For this example, there is a single web server on port 80.</span><span class="sxs-lookup"><span data-stu-id="a09a4-482">For this example, there is a single web server on port 80.</span></span> <span data-ttu-id="a09a4-483">Thus a single firewall application rule redirects inbound traffic to the external IP, to the web servers internal IP address.</span><span class="sxs-lookup"><span data-stu-id="a09a4-483">Thus a single firewall application rule redirects inbound traffic to the external IP, to the web servers internal IP address.</span></span> <span data-ttu-id="a09a4-484">The redirected traffic session would be translated via NAT to the internal server.</span><span class="sxs-lookup"><span data-stu-id="a09a4-484">The redirected traffic session would be translated via NAT to the internal server.</span></span>
     * <span data-ttu-id="a09a4-485">The second rule is the back-end rule to allow the web server to talk to the AppVM01 server (but not AppVM02) via any port.</span><span class="sxs-lookup"><span data-stu-id="a09a4-485">The second rule is the back-end rule to allow the web server to talk to the AppVM01 server (but not AppVM02) via any port.</span></span>
* <span data-ttu-id="a09a4-486">Internal rules (for intra-virtual network traffic)</span><span class="sxs-lookup"><span data-stu-id="a09a4-486">Internal rules (for intra-virtual network traffic)</span></span>
  1. <span data-ttu-id="a09a4-487">Outbound to Internet rule: This rule allows traffic from any network to pass to the selected networks.</span><span class="sxs-lookup"><span data-stu-id="a09a4-487">Outbound to Internet rule: This rule allows traffic from any network to pass to the selected networks.</span></span> <span data-ttu-id="a09a4-488">This rule is usually a default rule already on the firewall, but in a disabled state.</span><span class="sxs-lookup"><span data-stu-id="a09a4-488">This rule is usually a default rule already on the firewall, but in a disabled state.</span></span> <span data-ttu-id="a09a4-489">This rule should be enabled for this example.</span><span class="sxs-lookup"><span data-stu-id="a09a4-489">This rule should be enabled for this example.</span></span>
  2. <span data-ttu-id="a09a4-490">DNS rule: This rule allows only DNS (port 53) traffic to pass to the DNS server.</span><span class="sxs-lookup"><span data-stu-id="a09a4-490">DNS rule: This rule allows only DNS (port 53) traffic to pass to the DNS server.</span></span> <span data-ttu-id="a09a4-491">For this environment, most traffic from the front end to the back end is blocked.</span><span class="sxs-lookup"><span data-stu-id="a09a4-491">For this environment, most traffic from the front end to the back end is blocked.</span></span> <span data-ttu-id="a09a4-492">This rule specifically allows DNS from any local subnet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-492">This rule specifically allows DNS from any local subnet.</span></span>
  3. <span data-ttu-id="a09a4-493">Subnet to subnet rule: This rule is to allow any server on the back-end subnet to connect to any server on the front-end subnet (but not the reverse).</span><span class="sxs-lookup"><span data-stu-id="a09a4-493">Subnet to subnet rule: This rule is to allow any server on the back-end subnet to connect to any server on the front-end subnet (but not the reverse).</span></span>
* <span data-ttu-id="a09a4-494">Fail-safe rule (for traffic that doesn’t meet any of the previous):</span><span class="sxs-lookup"><span data-stu-id="a09a4-494">Fail-safe rule (for traffic that doesn’t meet any of the previous):</span></span>
  1. <span data-ttu-id="a09a4-495">Deny all traffic rule: This deny rule should always be the final rule (in terms of priority), and as such if a traffic flow fails to match any of the preceding rules it is dropped by this rule.</span><span class="sxs-lookup"><span data-stu-id="a09a4-495">Deny all traffic rule: This deny rule should always be the final rule (in terms of priority), and as such if a traffic flow fails to match any of the preceding rules it is dropped by this rule.</span></span> <span data-ttu-id="a09a4-496">This rule is a default rule and usually in-place and active.</span><span class="sxs-lookup"><span data-stu-id="a09a4-496">This rule is a default rule and usually in-place and active.</span></span> <span data-ttu-id="a09a4-497">No modifications are usually needed to this rule.</span><span class="sxs-lookup"><span data-stu-id="a09a4-497">No modifications are usually needed to this rule.</span></span>

> [!TIP]
> <span data-ttu-id="a09a4-498">On the second application traffic rule, to simplify this example, any port is allowed.</span><span class="sxs-lookup"><span data-stu-id="a09a4-498">On the second application traffic rule, to simplify this example, any port is allowed.</span></span> <span data-ttu-id="a09a4-499">In a real scenario, the most specific port and address ranges should be used to reduce the attack surface of this rule.</span><span class="sxs-lookup"><span data-stu-id="a09a4-499">In a real scenario, the most specific port and address ranges should be used to reduce the attack surface of this rule.</span></span>
>
>

<span data-ttu-id="a09a4-500">Once the previous rules are created, it’s important to review the priority of each rule to ensure traffic is allowed or denied as desired.</span><span class="sxs-lookup"><span data-stu-id="a09a4-500">Once the previous rules are created, it’s important to review the priority of each rule to ensure traffic is allowed or denied as desired.</span></span> <span data-ttu-id="a09a4-501">For this example, the rules are in priority order.</span><span class="sxs-lookup"><span data-stu-id="a09a4-501">For this example, the rules are in priority order.</span></span>

#### <a name="conclusion"></a><span data-ttu-id="a09a4-502">Conclusion</span><span class="sxs-lookup"><span data-stu-id="a09a4-502">Conclusion</span></span>
<span data-ttu-id="a09a4-503">This example is a more complex but complete way of protecting and isolating the network than the previous examples.</span><span class="sxs-lookup"><span data-stu-id="a09a4-503">This example is a more complex but complete way of protecting and isolating the network than the previous examples.</span></span> <span data-ttu-id="a09a4-504">(Example 2 protects just the application, and Example 1 just isolates subnets).</span><span class="sxs-lookup"><span data-stu-id="a09a4-504">(Example 2 protects just the application, and Example 1 just isolates subnets).</span></span> <span data-ttu-id="a09a4-505">This design allows for monitoring traffic in both directions, and protects not just the inbound application server but enforces network security policy for all servers on this network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-505">This design allows for monitoring traffic in both directions, and protects not just the inbound application server but enforces network security policy for all servers on this network.</span></span> <span data-ttu-id="a09a4-506">Also, depending on the appliance used, full traffic auditing and awareness can be achieved.</span><span class="sxs-lookup"><span data-stu-id="a09a4-506">Also, depending on the appliance used, full traffic auditing and awareness can be achieved.</span></span> <span data-ttu-id="a09a4-507">For more information, see the [detailed build instructions][Example3].</span><span class="sxs-lookup"><span data-stu-id="a09a4-507">For more information, see the [detailed build instructions][Example3].</span></span> <span data-ttu-id="a09a4-508">These instructions include:</span><span class="sxs-lookup"><span data-stu-id="a09a4-508">These instructions include:</span></span>

* <span data-ttu-id="a09a4-509">How to build this example perimeter network with classic PowerShell scripts.</span><span class="sxs-lookup"><span data-stu-id="a09a4-509">How to build this example perimeter network with classic PowerShell scripts.</span></span>
* <span data-ttu-id="a09a4-510">How to build this example with an Azure Resource Manager template.</span><span class="sxs-lookup"><span data-stu-id="a09a4-510">How to build this example with an Azure Resource Manager template.</span></span>
* <span data-ttu-id="a09a4-511">Detailed descriptions of each UDR, NSG command, and firewall rule.</span><span class="sxs-lookup"><span data-stu-id="a09a4-511">Detailed descriptions of each UDR, NSG command, and firewall rule.</span></span>
* <span data-ttu-id="a09a4-512">Detailed traffic flow scenarios, showing how traffic is allowed or denied in each layer.</span><span class="sxs-lookup"><span data-stu-id="a09a4-512">Detailed traffic flow scenarios, showing how traffic is allowed or denied in each layer.</span></span>

### <a name="example-4-add-a-hybrid-connection-with-a-site-to-site-virtual-appliance-vpn"></a><span data-ttu-id="a09a4-513">Example 4 Add a hybrid connection with a site-to-site, virtual appliance VPN</span><span class="sxs-lookup"><span data-stu-id="a09a4-513">Example 4 Add a hybrid connection with a site-to-site, virtual appliance VPN</span></span>
<span data-ttu-id="a09a4-514">[Back to Fast start](#fast-start) | Detailed build instructions available soon</span><span class="sxs-lookup"><span data-stu-id="a09a4-514">[Back to Fast start](#fast-start) | Detailed build instructions available soon</span></span>

<span data-ttu-id="a09a4-515">[![11]][11]</span><span class="sxs-lookup"><span data-stu-id="a09a4-515">[![11]][11]</span></span>

#### <a name="environment-description"></a><span data-ttu-id="a09a4-516">Environment description</span><span class="sxs-lookup"><span data-stu-id="a09a4-516">Environment description</span></span>
<span data-ttu-id="a09a4-517">Hybrid networking using a network virtual appliance (NVA) can be added to any of the perimeter network types described in examples 1, 2, or 3.</span><span class="sxs-lookup"><span data-stu-id="a09a4-517">Hybrid networking using a network virtual appliance (NVA) can be added to any of the perimeter network types described in examples 1, 2, or 3.</span></span>

<span data-ttu-id="a09a4-518">As shown in the previous figure, a VPN connection over the Internet (site-to-site) is used to connect an on-premises network to an Azure virtual network via an NVA.</span><span class="sxs-lookup"><span data-stu-id="a09a4-518">As shown in the previous figure, a VPN connection over the Internet (site-to-site) is used to connect an on-premises network to an Azure virtual network via an NVA.</span></span>

> [!NOTE]
> <span data-ttu-id="a09a4-519">If you use ExpressRoute with the Azure Public Peering option enabled, a static route should be created.</span><span class="sxs-lookup"><span data-stu-id="a09a4-519">If you use ExpressRoute with the Azure Public Peering option enabled, a static route should be created.</span></span> <span data-ttu-id="a09a4-520">This static route should route to the NVA VPN IP address out your corporate Internet and not via the ExpressRoute connection.</span><span class="sxs-lookup"><span data-stu-id="a09a4-520">This static route should route to the NVA VPN IP address out your corporate Internet and not via the ExpressRoute connection.</span></span> <span data-ttu-id="a09a4-521">The NAT required on the ExpressRoute Azure Public Peering option can break the VPN session.</span><span class="sxs-lookup"><span data-stu-id="a09a4-521">The NAT required on the ExpressRoute Azure Public Peering option can break the VPN session.</span></span>
>
>

<span data-ttu-id="a09a4-522">Once the VPN is in place, the NVA becomes the central hub for all networks and subnets.</span><span class="sxs-lookup"><span data-stu-id="a09a4-522">Once the VPN is in place, the NVA becomes the central hub for all networks and subnets.</span></span> <span data-ttu-id="a09a4-523">The firewall forwarding rules determine which traffic flows are allowed, are translated via NAT, are redirected, or are dropped (even for traffic flows between the on-premises network and Azure).</span><span class="sxs-lookup"><span data-stu-id="a09a4-523">The firewall forwarding rules determine which traffic flows are allowed, are translated via NAT, are redirected, or are dropped (even for traffic flows between the on-premises network and Azure).</span></span>

<span data-ttu-id="a09a4-524">Traffic flows should be considered carefully, as they can be optimized or degraded by this design pattern, depending on the specific use case.</span><span class="sxs-lookup"><span data-stu-id="a09a4-524">Traffic flows should be considered carefully, as they can be optimized or degraded by this design pattern, depending on the specific use case.</span></span>

<span data-ttu-id="a09a4-525">Using the environment built in example 3, and then adding a site-to-site VPN hybrid network connection, produces the following design:</span><span class="sxs-lookup"><span data-stu-id="a09a4-525">Using the environment built in example 3, and then adding a site-to-site VPN hybrid network connection, produces the following design:</span></span>

<span data-ttu-id="a09a4-526">[![12]][12]</span><span class="sxs-lookup"><span data-stu-id="a09a4-526">[![12]][12]</span></span>

<span data-ttu-id="a09a4-527">The on-premises router, or any other network device that is compatible with your NVA for VPN, would be the VPN client.</span><span class="sxs-lookup"><span data-stu-id="a09a4-527">The on-premises router, or any other network device that is compatible with your NVA for VPN, would be the VPN client.</span></span> <span data-ttu-id="a09a4-528">This physical device would be responsible for initiating and maintaining the VPN connection with your NVA.</span><span class="sxs-lookup"><span data-stu-id="a09a4-528">This physical device would be responsible for initiating and maintaining the VPN connection with your NVA.</span></span>

<span data-ttu-id="a09a4-529">Logically to the NVA, the network looks like four separate “security zones” with the rules on the NVA being the primary director of traffic between these zones:</span><span class="sxs-lookup"><span data-stu-id="a09a4-529">Logically to the NVA, the network looks like four separate “security zones” with the rules on the NVA being the primary director of traffic between these zones:</span></span>

<span data-ttu-id="a09a4-530">![13]</span><span class="sxs-lookup"><span data-stu-id="a09a4-530">![13]</span></span>

#### <a name="conclusion"></a><span data-ttu-id="a09a4-531">Conclusion</span><span class="sxs-lookup"><span data-stu-id="a09a4-531">Conclusion</span></span>
<span data-ttu-id="a09a4-532">The addition of a site-to-site VPN hybrid network connection to an Azure virtual network can extend the on-premises network into Azure in a secure manner.</span><span class="sxs-lookup"><span data-stu-id="a09a4-532">The addition of a site-to-site VPN hybrid network connection to an Azure virtual network can extend the on-premises network into Azure in a secure manner.</span></span> <span data-ttu-id="a09a4-533">In using a VPN connection, your traffic is encrypted and routes via the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-533">In using a VPN connection, your traffic is encrypted and routes via the Internet.</span></span> <span data-ttu-id="a09a4-534">The NVA in this example provides a central location to enforce and manage the security policy.</span><span class="sxs-lookup"><span data-stu-id="a09a4-534">The NVA in this example provides a central location to enforce and manage the security policy.</span></span> <span data-ttu-id="a09a4-535">For more information, see the detailed build instructions (forthcoming).</span><span class="sxs-lookup"><span data-stu-id="a09a4-535">For more information, see the detailed build instructions (forthcoming).</span></span> <span data-ttu-id="a09a4-536">These instructions include:</span><span class="sxs-lookup"><span data-stu-id="a09a4-536">These instructions include:</span></span>

* <span data-ttu-id="a09a4-537">How to build this example perimeter network with PowerShell scripts.</span><span class="sxs-lookup"><span data-stu-id="a09a4-537">How to build this example perimeter network with PowerShell scripts.</span></span>
* <span data-ttu-id="a09a4-538">How to build this example with an Azure Resource Manager template.</span><span class="sxs-lookup"><span data-stu-id="a09a4-538">How to build this example with an Azure Resource Manager template.</span></span>
* <span data-ttu-id="a09a4-539">Detailed traffic flow scenarios, showing how traffic flows through this design.</span><span class="sxs-lookup"><span data-stu-id="a09a4-539">Detailed traffic flow scenarios, showing how traffic flows through this design.</span></span>

### <a name="example-5-add-a-hybrid-connection-with-a-site-to-site-azure-vpn-gateway"></a><span data-ttu-id="a09a4-540">Example 5 Add a hybrid connection with a site-to-site, Azure VPN gateway</span><span class="sxs-lookup"><span data-stu-id="a09a4-540">Example 5 Add a hybrid connection with a site-to-site, Azure VPN gateway</span></span>
<span data-ttu-id="a09a4-541">[Back to Fast start](#fast-start) | Detailed build instructions available soon</span><span class="sxs-lookup"><span data-stu-id="a09a4-541">[Back to Fast start](#fast-start) | Detailed build instructions available soon</span></span>

<span data-ttu-id="a09a4-542">[![14]][14]</span><span class="sxs-lookup"><span data-stu-id="a09a4-542">[![14]][14]</span></span>

#### <a name="environment-description"></a><span data-ttu-id="a09a4-543">Environment description</span><span class="sxs-lookup"><span data-stu-id="a09a4-543">Environment description</span></span>
<span data-ttu-id="a09a4-544">Hybrid networking using an Azure VPN gateway can be added to either perimeter network type described in examples 1 or 2.</span><span class="sxs-lookup"><span data-stu-id="a09a4-544">Hybrid networking using an Azure VPN gateway can be added to either perimeter network type described in examples 1 or 2.</span></span>

<span data-ttu-id="a09a4-545">As shown in the preceding figure, a VPN connection over the Internet (site-to-site) is used to connect an on-premises network to an Azure virtual network via an Azure VPN gateway.</span><span class="sxs-lookup"><span data-stu-id="a09a4-545">As shown in the preceding figure, a VPN connection over the Internet (site-to-site) is used to connect an on-premises network to an Azure virtual network via an Azure VPN gateway.</span></span>

> [!NOTE]
> <span data-ttu-id="a09a4-546">If you use ExpressRoute with the Azure Public Peering option enabled, a static route should be created.</span><span class="sxs-lookup"><span data-stu-id="a09a4-546">If you use ExpressRoute with the Azure Public Peering option enabled, a static route should be created.</span></span> <span data-ttu-id="a09a4-547">This  static route should route to the NVA VPN IP address out your corporate Internet and not via the ExpressRoute WAN.</span><span class="sxs-lookup"><span data-stu-id="a09a4-547">This  static route should route to the NVA VPN IP address out your corporate Internet and not via the ExpressRoute WAN.</span></span> <span data-ttu-id="a09a4-548">The NAT required on the ExpressRoute Azure Public Peering option can break the VPN session.</span><span class="sxs-lookup"><span data-stu-id="a09a4-548">The NAT required on the ExpressRoute Azure Public Peering option can break the VPN session.</span></span>
>
>

<span data-ttu-id="a09a4-549">The following figure shows the two network edges in this example.</span><span class="sxs-lookup"><span data-stu-id="a09a4-549">The following figure shows the two network edges in this example.</span></span> <span data-ttu-id="a09a4-550">On the first edge, the NVA and NSGs control traffic flows for intra-Azure networks and between Azure and the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-550">On the first edge, the NVA and NSGs control traffic flows for intra-Azure networks and between Azure and the Internet.</span></span> <span data-ttu-id="a09a4-551">The second edge is the Azure VPN gateway, which is a separate and isolated network edge between on-premises and Azure.</span><span class="sxs-lookup"><span data-stu-id="a09a4-551">The second edge is the Azure VPN gateway, which is a separate and isolated network edge between on-premises and Azure.</span></span>

<span data-ttu-id="a09a4-552">Traffic flows should be considered carefully, as they can be optimized or degraded by this design pattern, depending on the specific use case.</span><span class="sxs-lookup"><span data-stu-id="a09a4-552">Traffic flows should be considered carefully, as they can be optimized or degraded by this design pattern, depending on the specific use case.</span></span>

<span data-ttu-id="a09a4-553">Using the environment built in example 1, and then adding a site-to-site VPN hybrid network connection, produces the following design:</span><span class="sxs-lookup"><span data-stu-id="a09a4-553">Using the environment built in example 1, and then adding a site-to-site VPN hybrid network connection, produces the following design:</span></span>

<span data-ttu-id="a09a4-554">[![15]][15]</span><span class="sxs-lookup"><span data-stu-id="a09a4-554">[![15]][15]</span></span>

#### <a name="conclusion"></a><span data-ttu-id="a09a4-555">Conclusion</span><span class="sxs-lookup"><span data-stu-id="a09a4-555">Conclusion</span></span>
<span data-ttu-id="a09a4-556">The addition of a site-to-site VPN hybrid network connection to an Azure virtual network can extend the on-premises network into Azure in a secure manner.</span><span class="sxs-lookup"><span data-stu-id="a09a4-556">The addition of a site-to-site VPN hybrid network connection to an Azure virtual network can extend the on-premises network into Azure in a secure manner.</span></span> <span data-ttu-id="a09a4-557">Using the native Azure VPN gateway, your traffic is IPSec encrypted and routes via the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-557">Using the native Azure VPN gateway, your traffic is IPSec encrypted and routes via the Internet.</span></span> <span data-ttu-id="a09a4-558">Also, using the Azure VPN gateway can provide a lower-cost option (no additional licensing cost as with third-party NVAs).</span><span class="sxs-lookup"><span data-stu-id="a09a4-558">Also, using the Azure VPN gateway can provide a lower-cost option (no additional licensing cost as with third-party NVAs).</span></span> <span data-ttu-id="a09a4-559">This option is most economical in example 1, where no NVA is used.</span><span class="sxs-lookup"><span data-stu-id="a09a4-559">This option is most economical in example 1, where no NVA is used.</span></span> <span data-ttu-id="a09a4-560">For more information, see the detailed build instructions (forthcoming).</span><span class="sxs-lookup"><span data-stu-id="a09a4-560">For more information, see the detailed build instructions (forthcoming).</span></span> <span data-ttu-id="a09a4-561">These instructions include:</span><span class="sxs-lookup"><span data-stu-id="a09a4-561">These instructions include:</span></span>

* <span data-ttu-id="a09a4-562">How to build this example perimeter network with PowerShell scripts.</span><span class="sxs-lookup"><span data-stu-id="a09a4-562">How to build this example perimeter network with PowerShell scripts.</span></span>
* <span data-ttu-id="a09a4-563">How to build this example with an Azure Resource Manager template.</span><span class="sxs-lookup"><span data-stu-id="a09a4-563">How to build this example with an Azure Resource Manager template.</span></span>
* <span data-ttu-id="a09a4-564">Detailed traffic flow scenarios, showing how traffic flows through this design.</span><span class="sxs-lookup"><span data-stu-id="a09a4-564">Detailed traffic flow scenarios, showing how traffic flows through this design.</span></span>

### <a name="example-6-add-a-hybrid-connection-with-expressroute"></a><span data-ttu-id="a09a4-565">Example 6 Add a hybrid connection with ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="a09a4-565">Example 6 Add a hybrid connection with ExpressRoute</span></span>
<span data-ttu-id="a09a4-566">[Back to Fast start](#fast-start) | Detailed build instructions available soon</span><span class="sxs-lookup"><span data-stu-id="a09a4-566">[Back to Fast start](#fast-start) | Detailed build instructions available soon</span></span>

<span data-ttu-id="a09a4-567">[![16]][16]</span><span class="sxs-lookup"><span data-stu-id="a09a4-567">[![16]][16]</span></span>

#### <a name="environment-description"></a><span data-ttu-id="a09a4-568">Environment description</span><span class="sxs-lookup"><span data-stu-id="a09a4-568">Environment description</span></span>
<span data-ttu-id="a09a4-569">Hybrid networking using an ExpressRoute private peering connection can be added to either perimeter network type described in examples 1 or 2.</span><span class="sxs-lookup"><span data-stu-id="a09a4-569">Hybrid networking using an ExpressRoute private peering connection can be added to either perimeter network type described in examples 1 or 2.</span></span>

<span data-ttu-id="a09a4-570">As shown in the preceding figure, ExpressRoute private peering provides a direct connection between your on-premises network and the Azure virtual network.</span><span class="sxs-lookup"><span data-stu-id="a09a4-570">As shown in the preceding figure, ExpressRoute private peering provides a direct connection between your on-premises network and the Azure virtual network.</span></span> <span data-ttu-id="a09a4-571">Traffic transits only the service provider network and the Microsoft Azure network, never touching the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-571">Traffic transits only the service provider network and the Microsoft Azure network, never touching the Internet.</span></span>

> [!TIP]
> <span data-ttu-id="a09a4-572">Using ExpressRoute keeps corporate network traffic off the Internet.</span><span class="sxs-lookup"><span data-stu-id="a09a4-572">Using ExpressRoute keeps corporate network traffic off the Internet.</span></span> <span data-ttu-id="a09a4-573">It also allows for service level agreements from your ExpressRoute provider.</span><span class="sxs-lookup"><span data-stu-id="a09a4-573">It also allows for service level agreements from your ExpressRoute provider.</span></span> <span data-ttu-id="a09a4-574">The Azure Gateway can pass up to 10 Gbps with ExpressRoute, whereas with site-to-site VPNs, the Azure Gateway maximum throughput is 200 Mbps.</span><span class="sxs-lookup"><span data-stu-id="a09a4-574">The Azure Gateway can pass up to 10 Gbps with ExpressRoute, whereas with site-to-site VPNs, the Azure Gateway maximum throughput is 200 Mbps.</span></span>
>
>

<span data-ttu-id="a09a4-575">As seen in the following diagram, with this option the environment now has two network edges.</span><span class="sxs-lookup"><span data-stu-id="a09a4-575">As seen in the following diagram, with this option the environment now has two network edges.</span></span> <span data-ttu-id="a09a4-576">The NVA and NSG control traffic flows for intra-Azure networks and between Azure and the Internet, while the gateway is a separate and isolated network edge between on-premises and Azure.</span><span class="sxs-lookup"><span data-stu-id="a09a4-576">The NVA and NSG control traffic flows for intra-Azure networks and between Azure and the Internet, while the gateway is a separate and isolated network edge between on-premises and Azure.</span></span>

<span data-ttu-id="a09a4-577">Traffic flows should be considered carefully, as they can be optimized or degraded by this design pattern, depending on the specific use case.</span><span class="sxs-lookup"><span data-stu-id="a09a4-577">Traffic flows should be considered carefully, as they can be optimized or degraded by this design pattern, depending on the specific use case.</span></span>

<span data-ttu-id="a09a4-578">Using the environment built in example 1, and then adding an ExpressRoute hybrid network connection, produces the following design:</span><span class="sxs-lookup"><span data-stu-id="a09a4-578">Using the environment built in example 1, and then adding an ExpressRoute hybrid network connection, produces the following design:</span></span>

<span data-ttu-id="a09a4-579">[![17]][17]</span><span class="sxs-lookup"><span data-stu-id="a09a4-579">[![17]][17]</span></span>

#### <a name="conclusion"></a><span data-ttu-id="a09a4-580">Conclusion</span><span class="sxs-lookup"><span data-stu-id="a09a4-580">Conclusion</span></span>
<span data-ttu-id="a09a4-581">The addition of an ExpressRoute Private Peering network connection can extend the on-premises network into Azure in a secure, lower latency, higher performing manner.</span><span class="sxs-lookup"><span data-stu-id="a09a4-581">The addition of an ExpressRoute Private Peering network connection can extend the on-premises network into Azure in a secure, lower latency, higher performing manner.</span></span> <span data-ttu-id="a09a4-582">Also, using the native Azure Gateway, as in this example, provides a lower-cost option (no additional licensing as with third-party NVAs).</span><span class="sxs-lookup"><span data-stu-id="a09a4-582">Also, using the native Azure Gateway, as in this example, provides a lower-cost option (no additional licensing as with third-party NVAs).</span></span> <span data-ttu-id="a09a4-583">For more information, see the detailed build instructions (forthcoming).</span><span class="sxs-lookup"><span data-stu-id="a09a4-583">For more information, see the detailed build instructions (forthcoming).</span></span> <span data-ttu-id="a09a4-584">These instructions include:</span><span class="sxs-lookup"><span data-stu-id="a09a4-584">These instructions include:</span></span>

* <span data-ttu-id="a09a4-585">How to build this example perimeter network with PowerShell scripts.</span><span class="sxs-lookup"><span data-stu-id="a09a4-585">How to build this example perimeter network with PowerShell scripts.</span></span>
* <span data-ttu-id="a09a4-586">How to build this example with an Azure Resource Manager template.</span><span class="sxs-lookup"><span data-stu-id="a09a4-586">How to build this example with an Azure Resource Manager template.</span></span>
* <span data-ttu-id="a09a4-587">Detailed traffic flow scenarios, showing how traffic flows through this design.</span><span class="sxs-lookup"><span data-stu-id="a09a4-587">Detailed traffic flow scenarios, showing how traffic flows through this design.</span></span>

## <a name="references"></a><span data-ttu-id="a09a4-588">References</span><span class="sxs-lookup"><span data-stu-id="a09a4-588">References</span></span>
### <a name="helpful-websites-and-documentation"></a><span data-ttu-id="a09a4-589">Helpful websites and documentation</span><span class="sxs-lookup"><span data-stu-id="a09a4-589">Helpful websites and documentation</span></span>
* <span data-ttu-id="a09a4-590">Access Azure with Azure Resource Manager:</span><span class="sxs-lookup"><span data-stu-id="a09a4-590">Access Azure with Azure Resource Manager:</span></span>
* <span data-ttu-id="a09a4-591">Accessing Azure with PowerShell: [https://docs.microsoft.com/powershell/azureps-cmdlets-docs/](/powershell/azureps-cmdlets-docs)</span><span class="sxs-lookup"><span data-stu-id="a09a4-591">Accessing Azure with PowerShell: [https://docs.microsoft.com/powershell/azureps-cmdlets-docs/](/powershell/azureps-cmdlets-docs)</span></span>
* <span data-ttu-id="a09a4-592">Virtual networking documentation: [https://docs.microsoft.com/azure/virtual-network/](https://docs.microsoft.com/azure/virtual-network/)</span><span class="sxs-lookup"><span data-stu-id="a09a4-592">Virtual networking documentation: [https://docs.microsoft.com/azure/virtual-network/](https://docs.microsoft.com/azure/virtual-network/)</span></span>
* <span data-ttu-id="a09a4-593">Network security group documentation: [https://docs.microsoft.com/azure/virtual-network/virtual-networks-nsg](virtual-network/virtual-networks-nsg.md)</span><span class="sxs-lookup"><span data-stu-id="a09a4-593">Network security group documentation: [https://docs.microsoft.com/azure/virtual-network/virtual-networks-nsg](virtual-network/virtual-networks-nsg.md)</span></span>
* <span data-ttu-id="a09a4-594">User-defined routing documentation: [https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview](virtual-network/virtual-networks-udr-overview.md)</span><span class="sxs-lookup"><span data-stu-id="a09a4-594">User-defined routing documentation: [https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview](virtual-network/virtual-networks-udr-overview.md)</span></span>
* <span data-ttu-id="a09a4-595">Azure virtual gateways: [https://docs.microsoft.com/azure/vpn-gateway/](https://docs.microsoft.com/azure/vpn-gateway/)</span><span class="sxs-lookup"><span data-stu-id="a09a4-595">Azure virtual gateways: [https://docs.microsoft.com/azure/vpn-gateway/](https://docs.microsoft.com/azure/vpn-gateway/)</span></span>
* <span data-ttu-id="a09a4-596">Site-to-Site VPNs: [https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell](vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell.md)</span><span class="sxs-lookup"><span data-stu-id="a09a4-596">Site-to-Site VPNs: [https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell](vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell.md)</span></span>
* <span data-ttu-id="a09a4-597">ExpressRoute documentation (be sure to check out the “Getting Started” and “How To” sections): [https://docs.microsoft.com/azure/expressroute/](https://docs.microsoft.com/azure/expressroute/)</span><span class="sxs-lookup"><span data-stu-id="a09a4-597">ExpressRoute documentation (be sure to check out the “Getting Started” and “How To” sections): [https://docs.microsoft.com/azure/expressroute/](https://docs.microsoft.com/azure/expressroute/)</span></span>

<!--Image References-->
[0]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/flowchart.png "Security Options Flowchart"
[2]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/azuresecurityfeatures.png "Azure Security Features"
[3]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/dmzcorporate.png "A DMZ in a Corporate network"
[4]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/azuresecurityarchitecture.png "Azure Security Architecture"
[5]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/dmzazure.png "A DMZ in an Azure Virtual Network"
[6]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/dmzhybrid.png "Hybrid Network with Three Security Boundaries"
[7]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/example1design.png "Inbound DMZ with NSG"
[8]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/example2design.png "Inbound DMZ with NVA and NSG"
[9]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/example3design.png "Bi-directional DMZ with NVA, NSG, and UDR"
[10]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/example3firewalllogical.png "Logical View of the Firewall Rules"
[11]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/example3designoptions.png "DMZ with NVA Connected Hybrid Network"
[12]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/example4designs2s.png "DMZ with NVA Connected Using a Site-to-Site VPN"
[13]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/example4networklogical.png "Logical Network from NVA Perspective"
[14]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/example5designoptions.png "DMZ with Azure Gateway Connected Site-to-Site Hybrid Network"
[15]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/example5designs2s.png "DMZ with Azure Gateway Using Site-to-Site VPN"
[16]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/example6designoptions.png "DMZ with Azure Gateway Connected ExpressRoute Hybrid Network"
[17]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/media/best-practices-network-security/example6designexpressroute.png "DMZ with Azure Gateway Using an ExpressRoute Connection"

<!--Link References-->
[TrustCenter]: https://azure.microsoft.com/support/trust-center/compliance/
[Example1]: ./virtual-network/virtual-networks-dmz-nsg.md
[Example2]: ./virtual-network/virtual-networks-dmz-nsg-fw-asm.md
[Example3]: ./virtual-network/virtual-networks-dmz-nsg-fw-udr-asm.md
[Example4]: ./virtual-network/virtual-networks-hybrid-s2s-nva-asm.md
[Example5]: ./virtual-network/virtual-networks-hybrid-s2s-agw-asm.md
[Example6]: ./virtual-network/virtual-networks-hybrid-expressroute-asm.md
[Example7]: ./virtual-network/virtual-networks-vnet2vnet-direct-asm.md
[Example8]: ./virtual-network/virtual-networks-vnet2vnet-transit-asm.md

















