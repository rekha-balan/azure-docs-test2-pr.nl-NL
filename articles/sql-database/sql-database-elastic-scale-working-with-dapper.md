---
title: Using elastic database client library with Dapper | Microsoft Docs
description: Using elastic database client library with Dapper.
services: sql-database
documentationcenter: ''
manager: jhubbard
author: torsteng
ms.assetid: 463d2676-3b19-47c2-83df-f8c50492c9d2
ms.service: sql-database
ms.custom: multiple databases
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/27/2016
ms.author: torsteng
ms.openlocfilehash: 3985e1439ac2699ee4a2a655b4673b7afaae2435
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44551917"
---
# <a name="using-elastic-database-client-library-with-dapper"></a><span data-ttu-id="e9980-103">Using elastic database client library with Dapper</span><span class="sxs-lookup"><span data-stu-id="e9980-103">Using elastic database client library with Dapper</span></span>
<span data-ttu-id="e9980-104">This document is for developers that rely on Dapper to build applications, but also want to embrace [elastic database tooling](sql-database-elastic-scale-introduction.md) to create applications that implement sharding to scale-out their data tier.</span><span class="sxs-lookup"><span data-stu-id="e9980-104">This document is for developers that rely on Dapper to build applications, but also want to embrace [elastic database tooling](sql-database-elastic-scale-introduction.md) to create applications that implement sharding to scale-out their data tier.</span></span>  <span data-ttu-id="e9980-105">This document illustrates the changes in Dapper-based applications that are necessary to integrate with elastic database tools.</span><span class="sxs-lookup"><span data-stu-id="e9980-105">This document illustrates the changes in Dapper-based applications that are necessary to integrate with elastic database tools.</span></span> <span data-ttu-id="e9980-106">Our focus is on composing the elastic database shard management and data dependent routing with Dapper.</span><span class="sxs-lookup"><span data-stu-id="e9980-106">Our focus is on composing the elastic database shard management and data dependent routing with Dapper.</span></span> 

<span data-ttu-id="e9980-107">**Sample Code**: [Elastic database tools for Azure SQL Database - Dapper integration](https://code.msdn.microsoft.com/Elastic-Scale-with-Azure-e19fc77f).</span><span class="sxs-lookup"><span data-stu-id="e9980-107">**Sample Code**: [Elastic database tools for Azure SQL Database - Dapper integration](https://code.msdn.microsoft.com/Elastic-Scale-with-Azure-e19fc77f).</span></span>

<span data-ttu-id="e9980-108">Integrating **Dapper** and **DapperExtensions** with the elastic database client library for Azure SQL Database is easy.</span><span class="sxs-lookup"><span data-stu-id="e9980-108">Integrating **Dapper** and **DapperExtensions** with the elastic database client library for Azure SQL Database is easy.</span></span> <span data-ttu-id="e9980-109">Your applications can use data dependent routing by changing the creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects to use the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call from the [client library](http://msdn.microsoft.com/library/azure/dn765902.aspx).</span><span class="sxs-lookup"><span data-stu-id="e9980-109">Your applications can use data dependent routing by changing the creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects to use the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call from the [client library](http://msdn.microsoft.com/library/azure/dn765902.aspx).</span></span> <span data-ttu-id="e9980-110">This limits changes in your application to only where new connections are created and opened.</span><span class="sxs-lookup"><span data-stu-id="e9980-110">This limits changes in your application to only where new connections are created and opened.</span></span> 

## <a name="dapper-overview"></a><span data-ttu-id="e9980-111">Dapper overview</span><span class="sxs-lookup"><span data-stu-id="e9980-111">Dapper overview</span></span>
<span data-ttu-id="e9980-112">**Dapper** is an object-relational mapper.</span><span class="sxs-lookup"><span data-stu-id="e9980-112">**Dapper** is an object-relational mapper.</span></span> <span data-ttu-id="e9980-113">It maps .NET objects from your application to a relational database (and vice versa).</span><span class="sxs-lookup"><span data-stu-id="e9980-113">It maps .NET objects from your application to a relational database (and vice versa).</span></span> <span data-ttu-id="e9980-114">The first part of the sample code illustrates how you can integrate the elastic database client library with Dapper-based applications.</span><span class="sxs-lookup"><span data-stu-id="e9980-114">The first part of the sample code illustrates how you can integrate the elastic database client library with Dapper-based applications.</span></span> <span data-ttu-id="e9980-115">The second part of the sample code illustrates how to integrate when using both Dapper and DapperExtensions.</span><span class="sxs-lookup"><span data-stu-id="e9980-115">The second part of the sample code illustrates how to integrate when using both Dapper and DapperExtensions.</span></span>  

<span data-ttu-id="e9980-116">The mapper functionality in Dapper provides extension methods on database connections that simplify submitting T-SQL statements for execution or querying the database.</span><span class="sxs-lookup"><span data-stu-id="e9980-116">The mapper functionality in Dapper provides extension methods on database connections that simplify submitting T-SQL statements for execution or querying the database.</span></span> <span data-ttu-id="e9980-117">For instance, Dapper makes it easy to map between your .NET objects and the parameters of SQL statements for **Execute** calls, or to consume the results of your SQL queries into .NET objects using **Query** calls from Dapper.</span><span class="sxs-lookup"><span data-stu-id="e9980-117">For instance, Dapper makes it easy to map between your .NET objects and the parameters of SQL statements for **Execute** calls, or to consume the results of your SQL queries into .NET objects using **Query** calls from Dapper.</span></span> 

<span data-ttu-id="e9980-118">When using DapperExtensions, you no longer need to provide the SQL statements.</span><span class="sxs-lookup"><span data-stu-id="e9980-118">When using DapperExtensions, you no longer need to provide the SQL statements.</span></span> <span data-ttu-id="e9980-119">Extensions methods such as **GetList** or **Insert** over the database connection create the SQL statements behind the scenes.</span><span class="sxs-lookup"><span data-stu-id="e9980-119">Extensions methods such as **GetList** or **Insert** over the database connection create the SQL statements behind the scenes.</span></span>

<span data-ttu-id="e9980-120">Another benefit of Dapper and also DapperExtensions is that the application controls the creation of the database connection.</span><span class="sxs-lookup"><span data-stu-id="e9980-120">Another benefit of Dapper and also DapperExtensions is that the application controls the creation of the database connection.</span></span> <span data-ttu-id="e9980-121">This helps interact with the elastic database client library which brokers database connections based on the mapping of shardlets to databases.</span><span class="sxs-lookup"><span data-stu-id="e9980-121">This helps interact with the elastic database client library which brokers database connections based on the mapping of shardlets to databases.</span></span>

<span data-ttu-id="e9980-122">To get the Dapper assemblies, see [Dapper dot net](http://www.nuget.org/packages/Dapper/).</span><span class="sxs-lookup"><span data-stu-id="e9980-122">To get the Dapper assemblies, see [Dapper dot net](http://www.nuget.org/packages/Dapper/).</span></span> <span data-ttu-id="e9980-123">For the Dapper extensions, see [DapperExtensions](http://www.nuget.org/packages/DapperExtensions).</span><span class="sxs-lookup"><span data-stu-id="e9980-123">For the Dapper extensions, see [DapperExtensions](http://www.nuget.org/packages/DapperExtensions).</span></span>

## <a name="a-quick-look-at-the-elastic-database-client-library"></a><span data-ttu-id="e9980-124">A quick Look at the elastic database client library</span><span class="sxs-lookup"><span data-stu-id="e9980-124">A quick Look at the elastic database client library</span></span>
<span data-ttu-id="e9980-125">With the elastic database client library, you define partitions of your application data called *shardlets* , map them to databases, and identify them by *sharding keys*.</span><span class="sxs-lookup"><span data-stu-id="e9980-125">With the elastic database client library, you define partitions of your application data called *shardlets* , map them to databases, and identify them by *sharding keys*.</span></span> <span data-ttu-id="e9980-126">You can have as many databases as you need and distribute your shardlets across these databases.</span><span class="sxs-lookup"><span data-stu-id="e9980-126">You can have as many databases as you need and distribute your shardlets across these databases.</span></span> <span data-ttu-id="e9980-127">The mapping of sharding key values to the databases is stored by a shard map provided by the library’s APIs.</span><span class="sxs-lookup"><span data-stu-id="e9980-127">The mapping of sharding key values to the databases is stored by a shard map provided by the library’s APIs.</span></span> <span data-ttu-id="e9980-128">This capability is called **shard map management**.</span><span class="sxs-lookup"><span data-stu-id="e9980-128">This capability is called **shard map management**.</span></span> <span data-ttu-id="e9980-129">The shard map also serves as the broker of database connections for requests that carry a sharding key.</span><span class="sxs-lookup"><span data-stu-id="e9980-129">The shard map also serves as the broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="e9980-130">This capability is referred to as **data dependent routing**.</span><span class="sxs-lookup"><span data-stu-id="e9980-130">This capability is referred to as **data dependent routing**.</span></span>

![Shard maps and data dependent routing][1]

<span data-ttu-id="e9980-132">The shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations are happening on the databases.</span><span class="sxs-lookup"><span data-stu-id="e9980-132">The shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations are happening on the databases.</span></span> <span data-ttu-id="e9980-133">To do so, the shard maps broker the database connections for an application built with the library.</span><span class="sxs-lookup"><span data-stu-id="e9980-133">To do so, the shard maps broker the database connections for an application built with the library.</span></span> <span data-ttu-id="e9980-134">When shard management operations could impact the shardlet, this allows the shard map functionality to automatically kill a database connection.</span><span class="sxs-lookup"><span data-stu-id="e9980-134">When shard management operations could impact the shardlet, this allows the shard map functionality to automatically kill a database connection.</span></span> 

<span data-ttu-id="e9980-135">Instead of using the traditional way to create connections for Dapper, we need to use the [OpenConnectionForKey method](http://msdn.microsoft.com/library/azure/dn824099.aspx).</span><span class="sxs-lookup"><span data-stu-id="e9980-135">Instead of using the traditional way to create connections for Dapper, we need to use the [OpenConnectionForKey method](http://msdn.microsoft.com/library/azure/dn824099.aspx).</span></span> <span data-ttu-id="e9980-136">This ensures that all the validation takes place and connections are managed properly when any data moves between shards.</span><span class="sxs-lookup"><span data-stu-id="e9980-136">This ensures that all the validation takes place and connections are managed properly when any data moves between shards.</span></span>

### <a name="requirements-for-dapper-integration"></a><span data-ttu-id="e9980-137">Requirements for Dapper integration</span><span class="sxs-lookup"><span data-stu-id="e9980-137">Requirements for Dapper integration</span></span>
<span data-ttu-id="e9980-138">When working with both the elastic database client library and the Dapper APIs, we want to retain the following properties:</span><span class="sxs-lookup"><span data-stu-id="e9980-138">When working with both the elastic database client library and the Dapper APIs, we want to retain the following properties:</span></span>

* <span data-ttu-id="e9980-139">**Scaleout**: We want to add or remove databases from the data tier of the sharded application as necessary for the capacity demands of the application.</span><span class="sxs-lookup"><span data-stu-id="e9980-139">**Scaleout**: We want to add or remove databases from the data tier of the sharded application as necessary for the capacity demands of the application.</span></span> 
* <span data-ttu-id="e9980-140">**Consistency**: Since our application is scaled out using sharding, we need to perform data dependent routing.</span><span class="sxs-lookup"><span data-stu-id="e9980-140">**Consistency**: Since our application is scaled out using sharding, we need to perform data dependent routing.</span></span> <span data-ttu-id="e9980-141">We want to use the Data dependent routing capabilities of the library to do so.</span><span class="sxs-lookup"><span data-stu-id="e9980-141">We want to use the Data dependent routing capabilities of the library to do so.</span></span> <span data-ttu-id="e9980-142">In particular, we want to retain the validation and consistency guarantees provided by connections that are brokered through the shard map manager in order to avoid corruption or wrong query results.</span><span class="sxs-lookup"><span data-stu-id="e9980-142">In particular, we want to retain the validation and consistency guarantees provided by connections that are brokered through the shard map manager in order to avoid corruption or wrong query results.</span></span> <span data-ttu-id="e9980-143">This ensures that connections to a given shardlet are rejected or stopped if (for instance) the shardlet is currently moved to a different shard using Split/Merge APIs.</span><span class="sxs-lookup"><span data-stu-id="e9980-143">This ensures that connections to a given shardlet are rejected or stopped if (for instance) the shardlet is currently moved to a different shard using Split/Merge APIs.</span></span>
* <span data-ttu-id="e9980-144">**Object Mapping**: We want to retain the convenience of the mappings provided by Dapper to translate between classes in the application and the underlying database structures.</span><span class="sxs-lookup"><span data-stu-id="e9980-144">**Object Mapping**: We want to retain the convenience of the mappings provided by Dapper to translate between classes in the application and the underlying database structures.</span></span> 

<span data-ttu-id="e9980-145">The following section provides guidance for these requirements for applications based on **Dapper** and **DapperExtensions**.</span><span class="sxs-lookup"><span data-stu-id="e9980-145">The following section provides guidance for these requirements for applications based on **Dapper** and **DapperExtensions**.</span></span>

## <a name="technical-guidance"></a><span data-ttu-id="e9980-146">Technical Guidance</span><span class="sxs-lookup"><span data-stu-id="e9980-146">Technical Guidance</span></span>
### <a name="data-dependent-routing-with-dapper"></a><span data-ttu-id="e9980-147">Data dependent routing with Dapper</span><span class="sxs-lookup"><span data-stu-id="e9980-147">Data dependent routing with Dapper</span></span>
<span data-ttu-id="e9980-148">With Dapper, the application is typically responsible for creating and opening the connections to the underlying database.</span><span class="sxs-lookup"><span data-stu-id="e9980-148">With Dapper, the application is typically responsible for creating and opening the connections to the underlying database.</span></span> <span data-ttu-id="e9980-149">Given a type T by the application, Dapper returns query results as .NET collections of type T. Dapper performs the mapping from the T-SQL result rows to the objects of type T. Similarly, Dapper maps .NET objects into SQL values or parameters for data manipulation language (DML) statements.</span><span class="sxs-lookup"><span data-stu-id="e9980-149">Given a type T by the application, Dapper returns query results as .NET collections of type T. Dapper performs the mapping from the T-SQL result rows to the objects of type T. Similarly, Dapper maps .NET objects into SQL values or parameters for data manipulation language (DML) statements.</span></span> <span data-ttu-id="e9980-150">Dapper offers this functionality via extension methods on the regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) object from the ADO .NET SQL Client libraries.</span><span class="sxs-lookup"><span data-stu-id="e9980-150">Dapper offers this functionality via extension methods on the regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) object from the ADO .NET SQL Client libraries.</span></span> <span data-ttu-id="e9980-151">The SQL connection returned by the Elastic Scale APIs for DDR are also regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects.</span><span class="sxs-lookup"><span data-stu-id="e9980-151">The SQL connection returned by the Elastic Scale APIs for DDR are also regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects.</span></span> <span data-ttu-id="e9980-152">This allows us to directly use Dapper extensions over the type returned by the client library’s DDR API, as it is also a simple SQL Client connection.</span><span class="sxs-lookup"><span data-stu-id="e9980-152">This allows us to directly use Dapper extensions over the type returned by the client library’s DDR API, as it is also a simple SQL Client connection.</span></span>

<span data-ttu-id="e9980-153">These observations make it straightforward to use connections brokered by the elastic database client library for Dapper.</span><span class="sxs-lookup"><span data-stu-id="e9980-153">These observations make it straightforward to use connections brokered by the elastic database client library for Dapper.</span></span>

<span data-ttu-id="e9980-154">This code example (from the accompanying sample) illustrates the approach where the sharding key is provided by the application to the library to broker the connection to the right shard.</span><span class="sxs-lookup"><span data-stu-id="e9980-154">This code example (from the accompanying sample) illustrates the approach where the sharding key is provided by the application to the library to broker the connection to the right shard.</span></span>   

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                     key: tenantId1, 
                     connectionString: connStrBldr.ConnectionString, 
                     options: ConnectionOptions.Validate))
    {
        var blog = new Blog { Name = name };
        sqlconn.Execute(@"
                      INSERT INTO
                            Blog (Name)
                            VALUES (@name)", new { name = blog.Name }
                        );
    }

<span data-ttu-id="e9980-155">The call to the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) API replaces the default creation and opening of a SQL Client connection.</span><span class="sxs-lookup"><span data-stu-id="e9980-155">The call to the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) API replaces the default creation and opening of a SQL Client connection.</span></span> <span data-ttu-id="e9980-156">The [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call takes the arguments that are required for data dependent routing:</span><span class="sxs-lookup"><span data-stu-id="e9980-156">The [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call takes the arguments that are required for data dependent routing:</span></span> 

* <span data-ttu-id="e9980-157">The shard map to access the data dependent routing interfaces</span><span class="sxs-lookup"><span data-stu-id="e9980-157">The shard map to access the data dependent routing interfaces</span></span>
* <span data-ttu-id="e9980-158">The sharding key to identify the shardlet</span><span class="sxs-lookup"><span data-stu-id="e9980-158">The sharding key to identify the shardlet</span></span>
* <span data-ttu-id="e9980-159">The credentials (user name and password) to connect to the shard</span><span class="sxs-lookup"><span data-stu-id="e9980-159">The credentials (user name and password) to connect to the shard</span></span>

<span data-ttu-id="e9980-160">The shard map object creates a connection to the shard that holds the shardlet for the given sharding key.</span><span class="sxs-lookup"><span data-stu-id="e9980-160">The shard map object creates a connection to the shard that holds the shardlet for the given sharding key.</span></span> <span data-ttu-id="e9980-161">The elastic database client APIs also tag the connection to implement its consistency guarantees.</span><span class="sxs-lookup"><span data-stu-id="e9980-161">The elastic database client APIs also tag the connection to implement its consistency guarantees.</span></span> <span data-ttu-id="e9980-162">Since the call to [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) returns a regular SQL Client connection object, the subsequent call to the **Execute** extension method from Dapper follows the standard Dapper practice.</span><span class="sxs-lookup"><span data-stu-id="e9980-162">Since the call to [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) returns a regular SQL Client connection object, the subsequent call to the **Execute** extension method from Dapper follows the standard Dapper practice.</span></span>

<span data-ttu-id="e9980-163">Queries work very much the same way - you first open the connection using [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) from the client API.</span><span class="sxs-lookup"><span data-stu-id="e9980-163">Queries work very much the same way - you first open the connection using [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) from the client API.</span></span> <span data-ttu-id="e9980-164">Then you use the regular Dapper extension methods to map the results of your SQL query into .NET objects:</span><span class="sxs-lookup"><span data-stu-id="e9980-164">Then you use the regular Dapper extension methods to map the results of your SQL query into .NET objects:</span></span>

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId1, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate ))
    {    
           // Display all Blogs for tenant 1
           IEnumerable<Blog> result = sqlconn.Query<Blog>(@"
                                SELECT * 
                                FROM Blog
                                ORDER BY Name");

           Console.WriteLine("All blogs for tenant id {0}:", tenantId1);
           foreach (var item in result)
           {
                Console.WriteLine(item.Name);
            }
    }

<span data-ttu-id="e9980-165">Note that the **using** block with the DDR connection scopes all database operations within the block to the one shard where tenantId1 is kept.</span><span class="sxs-lookup"><span data-stu-id="e9980-165">Note that the **using** block with the DDR connection scopes all database operations within the block to the one shard where tenantId1 is kept.</span></span> <span data-ttu-id="e9980-166">The query only returns blogs stored on the current shard, but not the ones stored on any other shards.</span><span class="sxs-lookup"><span data-stu-id="e9980-166">The query only returns blogs stored on the current shard, but not the ones stored on any other shards.</span></span> 

## <a name="data-dependent-routing-with-dapper-and-dapperextensions"></a><span data-ttu-id="e9980-167">Data dependent routing with Dapper and DapperExtensions</span><span class="sxs-lookup"><span data-stu-id="e9980-167">Data dependent routing with Dapper and DapperExtensions</span></span>
<span data-ttu-id="e9980-168">Dapper comes with an ecosystem of additional extensions that can provide further convenience and abstraction from the database when developing database applications.</span><span class="sxs-lookup"><span data-stu-id="e9980-168">Dapper comes with an ecosystem of additional extensions that can provide further convenience and abstraction from the database when developing database applications.</span></span> <span data-ttu-id="e9980-169">DapperExtensions is an example.</span><span class="sxs-lookup"><span data-stu-id="e9980-169">DapperExtensions is an example.</span></span> 

<span data-ttu-id="e9980-170">Using DapperExtensions in your application does not change how database connections are created and managed.</span><span class="sxs-lookup"><span data-stu-id="e9980-170">Using DapperExtensions in your application does not change how database connections are created and managed.</span></span> <span data-ttu-id="e9980-171">It is still the application’s responsibility to open connections, and regular SQL Client connection objects are expected by the extension methods.</span><span class="sxs-lookup"><span data-stu-id="e9980-171">It is still the application’s responsibility to open connections, and regular SQL Client connection objects are expected by the extension methods.</span></span> <span data-ttu-id="e9980-172">We can rely on the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) as outlined above.</span><span class="sxs-lookup"><span data-stu-id="e9980-172">We can rely on the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) as outlined above.</span></span> <span data-ttu-id="e9980-173">As the following code samples show, the only change is that we do no longer have to write the T-SQL statements:</span><span class="sxs-lookup"><span data-stu-id="e9980-173">As the following code samples show, the only change is that we do no longer have to write the T-SQL statements:</span></span>

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           var blog = new Blog { Name = name2 };
           sqlconn.Insert(blog);
    }

<span data-ttu-id="e9980-174">And here is the code sample for the query:</span><span class="sxs-lookup"><span data-stu-id="e9980-174">And here is the code sample for the query:</span></span> 

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           // Display all Blogs for tenant 2
           IEnumerable<Blog> result = sqlconn.GetList<Blog>();
           Console.WriteLine("All blogs for tenant id {0}:", tenantId2);
           foreach (var item in result)
           {
               Console.WriteLine(item.Name);
           }
    }

### <a name="handling-transient-faults"></a><span data-ttu-id="e9980-175">Handling transient faults</span><span class="sxs-lookup"><span data-stu-id="e9980-175">Handling transient faults</span></span>
<span data-ttu-id="e9980-176">The Microsoft Patterns & Practices team published the [Transient Fault Handling Application Block](http://msdn.microsoft.com/library/hh680934.aspx) to help application developers mitigate common transient fault conditions encountered when running in the cloud.</span><span class="sxs-lookup"><span data-stu-id="e9980-176">The Microsoft Patterns & Practices team published the [Transient Fault Handling Application Block](http://msdn.microsoft.com/library/hh680934.aspx) to help application developers mitigate common transient fault conditions encountered when running in the cloud.</span></span> <span data-ttu-id="e9980-177">For more information, see [Perseverance, Secret of All Triumphs: Using the Transient Fault Handling Application Block](http://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="e9980-177">For more information, see [Perseverance, Secret of All Triumphs: Using the Transient Fault Handling Application Block](http://msdn.microsoft.com/library/dn440719.aspx).</span></span>

<span data-ttu-id="e9980-178">The code sample relies on the transient fault library to protect against transient faults.</span><span class="sxs-lookup"><span data-stu-id="e9980-178">The code sample relies on the transient fault library to protect against transient faults.</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() =>
    {
       using (SqlConnection sqlconn = 
          shardingLayer.ShardMap.OpenConnectionForKey(tenantId2, connStrBldr.ConnectionString, ConnectionOptions.Validate))
          {
              var blog = new Blog { Name = name2 };
              sqlconn.Insert(blog);
          }
    });

<span data-ttu-id="e9980-179">**SqlDatabaseUtils.SqlRetryPolicy** in the code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span><span class="sxs-lookup"><span data-stu-id="e9980-179">**SqlDatabaseUtils.SqlRetryPolicy** in the code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="e9980-180">If you are using transactions, make sure that your retry scope goes back to the beginning of the transaction in the case of a transient fault.</span><span class="sxs-lookup"><span data-stu-id="e9980-180">If you are using transactions, make sure that your retry scope goes back to the beginning of the transaction in the case of a transient fault.</span></span>

## <a name="limitations"></a><span data-ttu-id="e9980-181">Limitations</span><span class="sxs-lookup"><span data-stu-id="e9980-181">Limitations</span></span>
<span data-ttu-id="e9980-182">The approaches outlined in this document entail a couple of limitations:</span><span class="sxs-lookup"><span data-stu-id="e9980-182">The approaches outlined in this document entail a couple of limitations:</span></span>

* <span data-ttu-id="e9980-183">The sample code for this document does not demonstrate how to manage schema across shards.</span><span class="sxs-lookup"><span data-stu-id="e9980-183">The sample code for this document does not demonstrate how to manage schema across shards.</span></span>
* <span data-ttu-id="e9980-184">Given a request, we assume that all its database processing is contained within a single shard as identified by the sharding key provided by the request.</span><span class="sxs-lookup"><span data-stu-id="e9980-184">Given a request, we assume that all its database processing is contained within a single shard as identified by the sharding key provided by the request.</span></span> <span data-ttu-id="e9980-185">However, this assumption does not always hold, for example, when it is not possible to make a sharding key available.</span><span class="sxs-lookup"><span data-stu-id="e9980-185">However, this assumption does not always hold, for example, when it is not possible to make a sharding key available.</span></span> <span data-ttu-id="e9980-186">To address this, the elastic database client library includes the [MultiShardQuery class](http://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardexception.aspx).</span><span class="sxs-lookup"><span data-stu-id="e9980-186">To address this, the elastic database client library includes the [MultiShardQuery class](http://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardexception.aspx).</span></span> <span data-ttu-id="e9980-187">The class implements a connection abstraction for querying over several shards.</span><span class="sxs-lookup"><span data-stu-id="e9980-187">The class implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="e9980-188">Using MultiShardQuery in combination with Dapper is beyond the scope of this document.</span><span class="sxs-lookup"><span data-stu-id="e9980-188">Using MultiShardQuery in combination with Dapper is beyond the scope of this document.</span></span>

## <a name="conclusion"></a><span data-ttu-id="e9980-189">Conclusion</span><span class="sxs-lookup"><span data-stu-id="e9980-189">Conclusion</span></span>
<span data-ttu-id="e9980-190">Applications using Dapper and DapperExtensions can easily benefit from elastic database tools for Azure SQL Database.</span><span class="sxs-lookup"><span data-stu-id="e9980-190">Applications using Dapper and DapperExtensions can easily benefit from elastic database tools for Azure SQL Database.</span></span> <span data-ttu-id="e9980-191">Through the steps outlined in this document, those applications can use the tool's capability for data dependent routing by changing the creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects to use the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call of the elastic database client library.</span><span class="sxs-lookup"><span data-stu-id="e9980-191">Through the steps outlined in this document, those applications can use the tool's capability for data dependent routing by changing the creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects to use the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call of the elastic database client library.</span></span> <span data-ttu-id="e9980-192">This limits the application changes required to those places where new connections are created and opened.</span><span class="sxs-lookup"><span data-stu-id="e9980-192">This limits the application changes required to those places where new connections are created and opened.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/sql-database/media/sql-database-elastic-scale-working-with-dapper/dapperimage1.png

