---
title: How to use Azure API Management with virtual networks
description: Learn how to setup a connection to a virtual network in Azure API Management and access web services through it.
services: api-management
documentationcenter: ''
author: antonba
manager: erikre
editor: ''
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/15/2016
ms.author: apimpm
ms.openlocfilehash: cc64e30e0aca764af6fad751500399bb9ed07760
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44554650"
---
# <a name="how-to-use-azure-api-management-with-virtual-networks"></a><span data-ttu-id="02ac4-103">How to use Azure API Management with virtual networks</span><span class="sxs-lookup"><span data-stu-id="02ac4-103">How to use Azure API Management with virtual networks</span></span>
<span data-ttu-id="02ac4-104">Azure Virtual Networks (VNETs) allow you to place any of your Azure resources in a non-internet routeable network that you control access to.</span><span class="sxs-lookup"><span data-stu-id="02ac4-104">Azure Virtual Networks (VNETs) allow you to place any of your Azure resources in a non-internet routeable network that you control access to.</span></span> <span data-ttu-id="02ac4-105">These networks can then be connected to your on-premise networks using various VPN technologies.</span><span class="sxs-lookup"><span data-stu-id="02ac4-105">These networks can then be connected to your on-premise networks using various VPN technologies.</span></span> <span data-ttu-id="02ac4-106">To learn more about Azure Virtual Networks start with the information here: [Azure Virtual Network Overview](../virtual-network/virtual-networks-overview.md).</span><span class="sxs-lookup"><span data-stu-id="02ac4-106">To learn more about Azure Virtual Networks start with the information here: [Azure Virtual Network Overview](../virtual-network/virtual-networks-overview.md).</span></span>

<span data-ttu-id="02ac4-107">Azure API Management can be deployed inside the virtual network (VNET), so it can access backend services within the network.</span><span class="sxs-lookup"><span data-stu-id="02ac4-107">Azure API Management can be deployed inside the virtual network (VNET), so it can access backend services within the network.</span></span> <span data-ttu-id="02ac4-108">The developer portal and API gateway, can be configured to be accessible either from the Internet or only within the virtual network.</span><span class="sxs-lookup"><span data-stu-id="02ac4-108">The developer portal and API gateway, can be configured to be accessible either from the Internet or only within the virtual network.</span></span>

> [!NOTE]
> <span data-ttu-id="02ac4-109">Azure API Management supports both classic and Azure Resource Manager VNets.</span><span class="sxs-lookup"><span data-stu-id="02ac4-109">Azure API Management supports both classic and Azure Resource Manager VNets.</span></span>
>
>

## <span data-ttu-id="02ac4-110"><a name="enable-vpn"> </a>Enable VNET connection</span><span class="sxs-lookup"><span data-stu-id="02ac4-110"><a name="enable-vpn"> </a>Enable VNET connection</span></span>
> [!NOTE]
> <span data-ttu-id="02ac4-111">VNET connectivity is available in the **Premium** and **Developer** tiers.</span><span class="sxs-lookup"><span data-stu-id="02ac4-111">VNET connectivity is available in the **Premium** and **Developer** tiers.</span></span> <span data-ttu-id="02ac4-112">To switch between the tiers, open your API Management service in the Azure portal and then open the **Scale and pricing** tab. Under the **Pricing tier** section, select the Premium or Developer tier and click Save.</span><span class="sxs-lookup"><span data-stu-id="02ac4-112">To switch between the tiers, open your API Management service in the Azure portal and then open the **Scale and pricing** tab. Under the **Pricing tier** section, select the Premium or Developer tier and click Save.</span></span>
>

<span data-ttu-id="02ac4-113">To enable VNET connectivity, open your API Management service in the Azure portal and open the **Virtual network** page.</span><span class="sxs-lookup"><span data-stu-id="02ac4-113">To enable VNET connectivity, open your API Management service in the Azure portal and open the **Virtual network** page.</span></span>

![Virtual network menu of API Management][api-management-using-vnet-menu]

<span data-ttu-id="02ac4-115">Select the desired access type:</span><span class="sxs-lookup"><span data-stu-id="02ac4-115">Select the desired access type:</span></span>

* <span data-ttu-id="02ac4-116">**External**: the API Management gateway and developer portal are accessible from the public internet via an external load balancer.</span><span class="sxs-lookup"><span data-stu-id="02ac4-116">**External**: the API Management gateway and developer portal are accessible from the public internet via an external load balancer.</span></span> <span data-ttu-id="02ac4-117">The gateway can access resources within the virtual network.</span><span class="sxs-lookup"><span data-stu-id="02ac4-117">The gateway can access resources within the virtual network.</span></span>

![Public peering][api-management-vnet-public]

* <span data-ttu-id="02ac4-119">**Internal**: the API Management gateway and developer portal are accessible only from within the virtual network via an internal load balancer.</span><span class="sxs-lookup"><span data-stu-id="02ac4-119">**Internal**: the API Management gateway and developer portal are accessible only from within the virtual network via an internal load balancer.</span></span> <span data-ttu-id="02ac4-120">The gateway can access resources within the virtual network.</span><span class="sxs-lookup"><span data-stu-id="02ac4-120">The gateway can access resources within the virtual network.</span></span>

![Private peering][api-management-vnet-private]

<span data-ttu-id="02ac4-122">You will now see a list of all regions where your API Management service is provisioned.</span><span class="sxs-lookup"><span data-stu-id="02ac4-122">You will now see a list of all regions where your API Management service is provisioned.</span></span> <span data-ttu-id="02ac4-123">Select a VNET and subnet for every region.</span><span class="sxs-lookup"><span data-stu-id="02ac4-123">Select a VNET and subnet for every region.</span></span> <span data-ttu-id="02ac4-124">The list is populated with both classic and Resource Manager virtual networks available in your Azure subscriptions that are setup in the region you are configuring.</span><span class="sxs-lookup"><span data-stu-id="02ac4-124">The list is populated with both classic and Resource Manager virtual networks available in your Azure subscriptions that are setup in the region you are configuring.</span></span>

> [!NOTE]
> <span data-ttu-id="02ac4-125">**Service Endpoint** in the above diagram includes Gateway/Proxy, Publisher Portal, Developer Portal, GIT, and the Direct Management Endpoint.</span><span class="sxs-lookup"><span data-stu-id="02ac4-125">**Service Endpoint** in the above diagram includes Gateway/Proxy, Publisher Portal, Developer Portal, GIT, and the Direct Management Endpoint.</span></span>
> <span data-ttu-id="02ac4-126">**Management Endpoint** in the above diagram is the endpoint hosted on the service to manage configuration via Azure portal and Powershell.</span><span class="sxs-lookup"><span data-stu-id="02ac4-126">**Management Endpoint** in the above diagram is the endpoint hosted on the service to manage configuration via Azure portal and Powershell.</span></span>
> <span data-ttu-id="02ac4-127">Also, note, that, even though, the diagram shows IP Addresses for its various endpoints, API Management service **only** responds on its configured Hostnames.</span><span class="sxs-lookup"><span data-stu-id="02ac4-127">Also, note, that, even though, the diagram shows IP Addresses for its various endpoints, API Management service **only** responds on its configured Hostnames.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="02ac4-128">When deploying an Azure API Management instance to a Resource Manager VNET, the service must be in a dedicated subnet that contains no other resources except for Azure API Management instances.</span><span class="sxs-lookup"><span data-stu-id="02ac4-128">When deploying an Azure API Management instance to a Resource Manager VNET, the service must be in a dedicated subnet that contains no other resources except for Azure API Management instances.</span></span> <span data-ttu-id="02ac4-129">If an attempt is made to deploy an Azure API Management instance to a Resource Manager VNET subnet that contains other resources, the deployment will fail.</span><span class="sxs-lookup"><span data-stu-id="02ac4-129">If an attempt is made to deploy an Azure API Management instance to a Resource Manager VNET subnet that contains other resources, the deployment will fail.</span></span>
>
>

![Select VPN][api-management-setup-vpn-select]

<span data-ttu-id="02ac4-131">Click **Save** at the top of the screen.</span><span class="sxs-lookup"><span data-stu-id="02ac4-131">Click **Save** at the top of the screen.</span></span>

> [!NOTE]
> <span data-ttu-id="02ac4-132">The VIP address of the API Management instance will change each time VNET is enabled or disabled.</span><span class="sxs-lookup"><span data-stu-id="02ac4-132">The VIP address of the API Management instance will change each time VNET is enabled or disabled.</span></span>  
> <span data-ttu-id="02ac4-133">The VIP address will also change when API Management is moved from **External** to **Internal** or vice-versa</span><span class="sxs-lookup"><span data-stu-id="02ac4-133">The VIP address will also change when API Management is moved from **External** to **Internal** or vice-versa</span></span>
>


> [!IMPORTANT]
> <span data-ttu-id="02ac4-134">If you remove API Management from a VNET or change the one it is deployed in, the previously used VNET can remain locked for up to 4 hours.</span><span class="sxs-lookup"><span data-stu-id="02ac4-134">If you remove API Management from a VNET or change the one it is deployed in, the previously used VNET can remain locked for up to 4 hours.</span></span> <span data-ttu-id="02ac4-135">During this period it will not be possible to delete the VNET or deploy a new resource to it.</span><span class="sxs-lookup"><span data-stu-id="02ac4-135">During this period it will not be possible to delete the VNET or deploy a new resource to it.</span></span>

## <span data-ttu-id="02ac4-136"><a name="enable-vnet-powershell"> </a>Enable VNET connection using PowerShell cmdlets</span><span class="sxs-lookup"><span data-stu-id="02ac4-136"><a name="enable-vnet-powershell"> </a>Enable VNET connection using PowerShell cmdlets</span></span>
<span data-ttu-id="02ac4-137">You can also enable VNET connectivity using the PowerShell cmdlets</span><span class="sxs-lookup"><span data-stu-id="02ac4-137">You can also enable VNET connectivity using the PowerShell cmdlets</span></span>

* <span data-ttu-id="02ac4-138">**Create an API Management service inside a VNET**: Use the cmdlet [New-AzureRmApiManagement](https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.apimanagement/v3.1.0/new-azurermapimanagement) to create an Azure API Management service inside a VNET.</span><span class="sxs-lookup"><span data-stu-id="02ac4-138">**Create an API Management service inside a VNET**: Use the cmdlet [New-AzureRmApiManagement](https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.apimanagement/v3.1.0/new-azurermapimanagement) to create an Azure API Management service inside a VNET.</span></span>

* <span data-ttu-id="02ac4-139">**Deploy an existing API Management service inside a VNET**: Use the cmdlet [Update-AzureRmApiManagementDeployment](https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.apimanagement/v3.1.0/update-azurermapimanagementdeployment) to move an existing Azure API Management service inside a Virtual Network.</span><span class="sxs-lookup"><span data-stu-id="02ac4-139">**Deploy an existing API Management service inside a VNET**: Use the cmdlet [Update-AzureRmApiManagementDeployment](https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.apimanagement/v3.1.0/update-azurermapimanagementdeployment) to move an existing Azure API Management service inside a Virtual Network.</span></span>

## <span data-ttu-id="02ac4-140"><a name="connect-vnet"> </a>Connect to a web service hosted within a virtual Network</span><span class="sxs-lookup"><span data-stu-id="02ac4-140"><a name="connect-vnet"> </a>Connect to a web service hosted within a virtual Network</span></span>
<span data-ttu-id="02ac4-141">After your API Management service is connected to the VNET, accessing backend services within it is no different than accessing public services.</span><span class="sxs-lookup"><span data-stu-id="02ac4-141">After your API Management service is connected to the VNET, accessing backend services within it is no different than accessing public services.</span></span> <span data-ttu-id="02ac4-142">Just type in the local IP address or the host name (if a DNS server is configured for the VNET) of your web service into the **Web service URL** field when creating a new API or editing an existing one.</span><span class="sxs-lookup"><span data-stu-id="02ac4-142">Just type in the local IP address or the host name (if a DNS server is configured for the VNET) of your web service into the **Web service URL** field when creating a new API or editing an existing one.</span></span>

![Add API from VPN][api-management-setup-vpn-add-api]

## <span data-ttu-id="02ac4-144"><a name="network-configuration-issues"> </a>Common Network Configuration Issues</span><span class="sxs-lookup"><span data-stu-id="02ac4-144"><a name="network-configuration-issues"> </a>Common Network Configuration Issues</span></span>
<span data-ttu-id="02ac4-145">Following is a list of common misconfiguration issues that can occur while deploying API Management service into a Virtual Network.</span><span class="sxs-lookup"><span data-stu-id="02ac4-145">Following is a list of common misconfiguration issues that can occur while deploying API Management service into a Virtual Network.</span></span>

* <span data-ttu-id="02ac4-146">**Custom DNS server setup**: The API Management service depends on several Azure services.</span><span class="sxs-lookup"><span data-stu-id="02ac4-146">**Custom DNS server setup**: The API Management service depends on several Azure services.</span></span> <span data-ttu-id="02ac4-147">When API Management is hosted in a VNET with a custom DNS server, it needs to resolve the hostnames of those Azure services.</span><span class="sxs-lookup"><span data-stu-id="02ac4-147">When API Management is hosted in a VNET with a custom DNS server, it needs to resolve the hostnames of those Azure services.</span></span> <span data-ttu-id="02ac4-148">Please follow [this](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) guidance on custom DNS setup.</span><span class="sxs-lookup"><span data-stu-id="02ac4-148">Please follow [this](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) guidance on custom DNS setup.</span></span> <span data-ttu-id="02ac4-149">See the ports table below and other network requirements for reference.</span><span class="sxs-lookup"><span data-stu-id="02ac4-149">See the ports table below and other network requirements for reference.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="02ac4-150">It is recommended that, if you are using a Custom DNS Server for the VNET, you set that up **before** deploying an API Management service into it.</span><span class="sxs-lookup"><span data-stu-id="02ac4-150">It is recommended that, if you are using a Custom DNS Server for the VNET, you set that up **before** deploying an API Management service into it.</span></span> <span data-ttu-id="02ac4-151">Otherwise we need to restart the CloudService hosting the service, for it to pick up the new DNS Server settings.</span><span class="sxs-lookup"><span data-stu-id="02ac4-151">Otherwise we need to restart the CloudService hosting the service, for it to pick up the new DNS Server settings.</span></span>
>

* <span data-ttu-id="02ac4-152">**Ports required for API Management**: Inbound and Outbound traffic into the Subnet in which API Management is deployed can be controlled using [Network Security Group][Network Security Group].</span><span class="sxs-lookup"><span data-stu-id="02ac4-152">**Ports required for API Management**: Inbound and Outbound traffic into the Subnet in which API Management is deployed can be controlled using [Network Security Group][Network Security Group].</span></span> <span data-ttu-id="02ac4-153">If any of these ports are unavailable, API Management may not operate properly and may become inaccessible.</span><span class="sxs-lookup"><span data-stu-id="02ac4-153">If any of these ports are unavailable, API Management may not operate properly and may become inaccessible.</span></span> <span data-ttu-id="02ac4-154">Having one or more of these ports blocked is another common misconfiguration issue when using API Management with a VNET.</span><span class="sxs-lookup"><span data-stu-id="02ac4-154">Having one or more of these ports blocked is another common misconfiguration issue when using API Management with a VNET.</span></span>

<span data-ttu-id="02ac4-155">When an API Management service instance is hosted in a VNET, the ports in the following table are used.</span><span class="sxs-lookup"><span data-stu-id="02ac4-155">When an API Management service instance is hosted in a VNET, the ports in the following table are used.</span></span>

| <span data-ttu-id="02ac4-156">Source / Destination Port(s)</span><span class="sxs-lookup"><span data-stu-id="02ac4-156">Source / Destination Port(s)</span></span> | <span data-ttu-id="02ac4-157">Direction</span><span class="sxs-lookup"><span data-stu-id="02ac4-157">Direction</span></span> | <span data-ttu-id="02ac4-158">Transport protocol</span><span class="sxs-lookup"><span data-stu-id="02ac4-158">Transport protocol</span></span> | <span data-ttu-id="02ac4-159">Purpose</span><span class="sxs-lookup"><span data-stu-id="02ac4-159">Purpose</span></span> | <span data-ttu-id="02ac4-160">Source / Destination</span><span class="sxs-lookup"><span data-stu-id="02ac4-160">Source / Destination</span></span> | <span data-ttu-id="02ac4-161">Access type</span><span class="sxs-lookup"><span data-stu-id="02ac4-161">Access type</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="02ac4-162">\* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="02ac4-162">\* / 80, 443</span></span> |<span data-ttu-id="02ac4-163">Inbound</span><span class="sxs-lookup"><span data-stu-id="02ac4-163">Inbound</span></span> |<span data-ttu-id="02ac4-164">TCP</span><span class="sxs-lookup"><span data-stu-id="02ac4-164">TCP</span></span> |<span data-ttu-id="02ac4-165">Client communication to API Management</span><span class="sxs-lookup"><span data-stu-id="02ac4-165">Client communication to API Management</span></span> |<span data-ttu-id="02ac4-166">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="02ac4-166">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="02ac4-167">External</span><span class="sxs-lookup"><span data-stu-id="02ac4-167">External</span></span> |
| <span data-ttu-id="02ac4-168">\* / 3443</span><span class="sxs-lookup"><span data-stu-id="02ac4-168">\* / 3443</span></span> |<span data-ttu-id="02ac4-169">Inbound</span><span class="sxs-lookup"><span data-stu-id="02ac4-169">Inbound</span></span> |<span data-ttu-id="02ac4-170">TCP</span><span class="sxs-lookup"><span data-stu-id="02ac4-170">TCP</span></span> |<span data-ttu-id="02ac4-171">Management endpoint for Azure portal and Powershell</span><span class="sxs-lookup"><span data-stu-id="02ac4-171">Management endpoint for Azure portal and Powershell</span></span> |<span data-ttu-id="02ac4-172">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="02ac4-172">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="02ac4-173">External & Internal</span><span class="sxs-lookup"><span data-stu-id="02ac4-173">External & Internal</span></span> |
| <span data-ttu-id="02ac4-174">\* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="02ac4-174">\* / 80, 443</span></span> |<span data-ttu-id="02ac4-175">Outbound</span><span class="sxs-lookup"><span data-stu-id="02ac4-175">Outbound</span></span> |<span data-ttu-id="02ac4-176">TCP</span><span class="sxs-lookup"><span data-stu-id="02ac4-176">TCP</span></span> |<span data-ttu-id="02ac4-177">Dependency on Azure Storage and Azure Service Bus</span><span class="sxs-lookup"><span data-stu-id="02ac4-177">Dependency on Azure Storage and Azure Service Bus</span></span> |<span data-ttu-id="02ac4-178">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="02ac4-178">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="02ac4-179">External & Internal</span><span class="sxs-lookup"><span data-stu-id="02ac4-179">External & Internal</span></span> |
| <span data-ttu-id="02ac4-180">\* / 1433</span><span class="sxs-lookup"><span data-stu-id="02ac4-180">\* / 1433</span></span> |<span data-ttu-id="02ac4-181">Outbound</span><span class="sxs-lookup"><span data-stu-id="02ac4-181">Outbound</span></span> |<span data-ttu-id="02ac4-182">TCP</span><span class="sxs-lookup"><span data-stu-id="02ac4-182">TCP</span></span> |<span data-ttu-id="02ac4-183">Dependency on Azure SQL</span><span class="sxs-lookup"><span data-stu-id="02ac4-183">Dependency on Azure SQL</span></span> |<span data-ttu-id="02ac4-184">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="02ac4-184">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="02ac4-185">External & Internal</span><span class="sxs-lookup"><span data-stu-id="02ac4-185">External & Internal</span></span> |
| <span data-ttu-id="02ac4-186">\* / 11000 - 11999</span><span class="sxs-lookup"><span data-stu-id="02ac4-186">\* / 11000 - 11999</span></span> |<span data-ttu-id="02ac4-187">Outbound</span><span class="sxs-lookup"><span data-stu-id="02ac4-187">Outbound</span></span> |<span data-ttu-id="02ac4-188">TCP</span><span class="sxs-lookup"><span data-stu-id="02ac4-188">TCP</span></span> |<span data-ttu-id="02ac4-189">Dependency on Azure SQL V12</span><span class="sxs-lookup"><span data-stu-id="02ac4-189">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="02ac4-190">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="02ac4-190">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="02ac4-191">External & Internal</span><span class="sxs-lookup"><span data-stu-id="02ac4-191">External & Internal</span></span> |
| <span data-ttu-id="02ac4-192">\* / 14000 - 14999</span><span class="sxs-lookup"><span data-stu-id="02ac4-192">\* / 14000 - 14999</span></span> |<span data-ttu-id="02ac4-193">Outbound</span><span class="sxs-lookup"><span data-stu-id="02ac4-193">Outbound</span></span> |<span data-ttu-id="02ac4-194">TCP</span><span class="sxs-lookup"><span data-stu-id="02ac4-194">TCP</span></span> |<span data-ttu-id="02ac4-195">Dependency on Azure SQL V12</span><span class="sxs-lookup"><span data-stu-id="02ac4-195">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="02ac4-196">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="02ac4-196">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="02ac4-197">External & Internal</span><span class="sxs-lookup"><span data-stu-id="02ac4-197">External & Internal</span></span> |
| <span data-ttu-id="02ac4-198">\* / 9350 - 9354</span><span class="sxs-lookup"><span data-stu-id="02ac4-198">\* / 9350 - 9354</span></span> |<span data-ttu-id="02ac4-199">Outbound</span><span class="sxs-lookup"><span data-stu-id="02ac4-199">Outbound</span></span> |<span data-ttu-id="02ac4-200">TCP</span><span class="sxs-lookup"><span data-stu-id="02ac4-200">TCP</span></span> |<span data-ttu-id="02ac4-201">Dependency on Service Bus</span><span class="sxs-lookup"><span data-stu-id="02ac4-201">Dependency on Service Bus</span></span> |<span data-ttu-id="02ac4-202">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="02ac4-202">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="02ac4-203">External & Internal</span><span class="sxs-lookup"><span data-stu-id="02ac4-203">External & Internal</span></span> |
| <span data-ttu-id="02ac4-204">\* / 5671</span><span class="sxs-lookup"><span data-stu-id="02ac4-204">\* / 5671</span></span> |<span data-ttu-id="02ac4-205">Outbound</span><span class="sxs-lookup"><span data-stu-id="02ac4-205">Outbound</span></span> |<span data-ttu-id="02ac4-206">AMQP</span><span class="sxs-lookup"><span data-stu-id="02ac4-206">AMQP</span></span> |<span data-ttu-id="02ac4-207">Dependency for Log to event Hub policy</span><span class="sxs-lookup"><span data-stu-id="02ac4-207">Dependency for Log to event Hub policy</span></span> |<span data-ttu-id="02ac4-208">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="02ac4-208">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="02ac4-209">External & Internal</span><span class="sxs-lookup"><span data-stu-id="02ac4-209">External & Internal</span></span> |
| <span data-ttu-id="02ac4-210">6381 - 6383 / 6381 - 6383</span><span class="sxs-lookup"><span data-stu-id="02ac4-210">6381 - 6383 / 6381 - 6383</span></span> |<span data-ttu-id="02ac4-211">Inbound & Outbound</span><span class="sxs-lookup"><span data-stu-id="02ac4-211">Inbound & Outbound</span></span> |<span data-ttu-id="02ac4-212">UDP</span><span class="sxs-lookup"><span data-stu-id="02ac4-212">UDP</span></span> |<span data-ttu-id="02ac4-213">Dependency on Redis Cache</span><span class="sxs-lookup"><span data-stu-id="02ac4-213">Dependency on Redis Cache</span></span> |<span data-ttu-id="02ac4-214">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="02ac4-214">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="02ac4-215">External & Internal</span><span class="sxs-lookup"><span data-stu-id="02ac4-215">External & Internal</span></span> |-
| <span data-ttu-id="02ac4-216">\* / 445</span><span class="sxs-lookup"><span data-stu-id="02ac4-216">\* / 445</span></span> |<span data-ttu-id="02ac4-217">Outbound</span><span class="sxs-lookup"><span data-stu-id="02ac4-217">Outbound</span></span> |<span data-ttu-id="02ac4-218">TCP</span><span class="sxs-lookup"><span data-stu-id="02ac4-218">TCP</span></span> |<span data-ttu-id="02ac4-219">Dependency on Azure File Share for GIT</span><span class="sxs-lookup"><span data-stu-id="02ac4-219">Dependency on Azure File Share for GIT</span></span> |<span data-ttu-id="02ac4-220">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="02ac4-220">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="02ac4-221">External & Internal</span><span class="sxs-lookup"><span data-stu-id="02ac4-221">External & Internal</span></span> |
| <span data-ttu-id="02ac4-222">\* / \*</span><span class="sxs-lookup"><span data-stu-id="02ac4-222">\* / \*</span></span> | <span data-ttu-id="02ac4-223">Inbound</span><span class="sxs-lookup"><span data-stu-id="02ac4-223">Inbound</span></span> |<span data-ttu-id="02ac4-224">TCP</span><span class="sxs-lookup"><span data-stu-id="02ac4-224">TCP</span></span> |<span data-ttu-id="02ac4-225">Azure Infrastructure Load Balancer</span><span class="sxs-lookup"><span data-stu-id="02ac4-225">Azure Infrastructure Load Balancer</span></span> | <span data-ttu-id="02ac4-226">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="02ac4-226">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="02ac4-227">External & Internal</span><span class="sxs-lookup"><span data-stu-id="02ac4-227">External & Internal</span></span> |

* <span data-ttu-id="02ac4-228">**SSL functionality**: To enable SSL certificate chain building and validation the API Management service needs Outbound network connectivity to ocsp.msocsp.com, mscrl.microsoft.com and crl.microsoft.com.</span><span class="sxs-lookup"><span data-stu-id="02ac4-228">**SSL functionality**: To enable SSL certificate chain building and validation the API Management service needs Outbound network connectivity to ocsp.msocsp.com, mscrl.microsoft.com and crl.microsoft.com.</span></span>

* <span data-ttu-id="02ac4-229">**Express Route Setup**: A common customer configuration is to define their own default route (0.0.0.0/0) which forces outbound Internet traffic to instead flow on-premises.</span><span class="sxs-lookup"><span data-stu-id="02ac4-229">**Express Route Setup**: A common customer configuration is to define their own default route (0.0.0.0/0) which forces outbound Internet traffic to instead flow on-premises.</span></span> <span data-ttu-id="02ac4-230">This traffic flow invariably breaks connectivity with Azure API Management because the outbound traffic is either blocked on-premises, or NAT'd to an unrecognizable set of addresses that no longer work with various Azure endpoints.</span><span class="sxs-lookup"><span data-stu-id="02ac4-230">This traffic flow invariably breaks connectivity with Azure API Management because the outbound traffic is either blocked on-premises, or NAT'd to an unrecognizable set of addresses that no longer work with various Azure endpoints.</span></span> <span data-ttu-id="02ac4-231">The solution is to define one (or more) user-defined routes ([UDRs][UDRs]) on the subnet that contains the Azure API Management.</span><span class="sxs-lookup"><span data-stu-id="02ac4-231">The solution is to define one (or more) user-defined routes ([UDRs][UDRs]) on the subnet that contains the Azure API Management.</span></span> <span data-ttu-id="02ac4-232">A UDR defines subnet-specific routes that will be honored instead of the default route.</span><span class="sxs-lookup"><span data-stu-id="02ac4-232">A UDR defines subnet-specific routes that will be honored instead of the default route.</span></span>
  <span data-ttu-id="02ac4-233">If possible, it is recommended to use the following configuration:</span><span class="sxs-lookup"><span data-stu-id="02ac4-233">If possible, it is recommended to use the following configuration:</span></span>
 * <span data-ttu-id="02ac4-234">The ExpressRoute configuration advertises 0.0.0.0/0 and by default force tunnels all outbound traffic on-premises.</span><span class="sxs-lookup"><span data-stu-id="02ac4-234">The ExpressRoute configuration advertises 0.0.0.0/0 and by default force tunnels all outbound traffic on-premises.</span></span>
 * <span data-ttu-id="02ac4-235">The UDR applied to the subnet containing the Azure API Management defines 0.0.0.0/0 with a next hop type of Internet.</span><span class="sxs-lookup"><span data-stu-id="02ac4-235">The UDR applied to the subnet containing the Azure API Management defines 0.0.0.0/0 with a next hop type of Internet.</span></span>
 <span data-ttu-id="02ac4-236">The combined effect of these steps is that the subnet level UDR takes precedence over the ExpressRoute forced tunneling, thus ensuring outbound Internet access from the Azure API Management.</span><span class="sxs-lookup"><span data-stu-id="02ac4-236">The combined effect of these steps is that the subnet level UDR takes precedence over the ExpressRoute forced tunneling, thus ensuring outbound Internet access from the Azure API Management.</span></span>

>[!WARNING]  
><span data-ttu-id="02ac4-237">Azure API Management is not supported with ExpressRoute configurations that **incorrectly cross-advertise routes from the public peering path to the private peering path**.</span><span class="sxs-lookup"><span data-stu-id="02ac4-237">Azure API Management is not supported with ExpressRoute configurations that **incorrectly cross-advertise routes from the public peering path to the private peering path**.</span></span> <span data-ttu-id="02ac4-238">ExpressRoute configurations that have public peering configured, will receive route advertisements from Microsoft for a large set of Microsoft Azure IP address ranges.</span><span class="sxs-lookup"><span data-stu-id="02ac4-238">ExpressRoute configurations that have public peering configured, will receive route advertisements from Microsoft for a large set of Microsoft Azure IP address ranges.</span></span> <span data-ttu-id="02ac4-239">If these address ranges are incorrectly cross-advertised on the private peering path, the end result is that all outbound network packets from the Azure API Management instance's subnet are incorrectly force-tunneled to a customer's on-premises network infrastructure.</span><span class="sxs-lookup"><span data-stu-id="02ac4-239">If these address ranges are incorrectly cross-advertised on the private peering path, the end result is that all outbound network packets from the Azure API Management instance's subnet are incorrectly force-tunneled to a customer's on-premises network infrastructure.</span></span> <span data-ttu-id="02ac4-240">This network flow breaks Azure API Management.</span><span class="sxs-lookup"><span data-stu-id="02ac4-240">This network flow breaks Azure API Management.</span></span> <span data-ttu-id="02ac4-241">The solution to this problem is to stop cross-advertising routes from the public peering path to the private peering path.</span><span class="sxs-lookup"><span data-stu-id="02ac4-241">The solution to this problem is to stop cross-advertising routes from the public peering path to the private peering path.</span></span>

## <span data-ttu-id="02ac4-242"><a name="limitations"> </a>Limitations</span><span class="sxs-lookup"><span data-stu-id="02ac4-242"><a name="limitations"> </a>Limitations</span></span>
* <span data-ttu-id="02ac4-243">A subnet containing API Management instances cannot contain any other Azure resource types.</span><span class="sxs-lookup"><span data-stu-id="02ac4-243">A subnet containing API Management instances cannot contain any other Azure resource types.</span></span>
* <span data-ttu-id="02ac4-244">The subnet and the API Management service must be in the same subscription.</span><span class="sxs-lookup"><span data-stu-id="02ac4-244">The subnet and the API Management service must be in the same subscription.</span></span>
* <span data-ttu-id="02ac4-245">A subnet containing API Management instances cannot be moved across subscriptions.</span><span class="sxs-lookup"><span data-stu-id="02ac4-245">A subnet containing API Management instances cannot be moved across subscriptions.</span></span>
* <span data-ttu-id="02ac4-246">When using an internal virtual network, only an internal IP address will be available from the range stated in [RFC 1918](https://tools.ietf.org/html/rfc1918), a public IP address cannot be provided.</span><span class="sxs-lookup"><span data-stu-id="02ac4-246">When using an internal virtual network, only an internal IP address will be available from the range stated in [RFC 1918](https://tools.ietf.org/html/rfc1918), a public IP address cannot be provided.</span></span>
* <span data-ttu-id="02ac4-247">For multi-region API Management deployments, with Internal virtual networks configured, users are responsible for managing their own load balancing as they own the DNS.</span><span class="sxs-lookup"><span data-stu-id="02ac4-247">For multi-region API Management deployments, with Internal virtual networks configured, users are responsible for managing their own load balancing as they own the DNS.</span></span>


## <span data-ttu-id="02ac4-248"><a name="related-content"> </a>Related content</span><span class="sxs-lookup"><span data-stu-id="02ac4-248"><a name="related-content"> </a>Related content</span></span>
* [<span data-ttu-id="02ac4-249">Connecting a Virtual Network to backend using Vpn Gateway</span><span class="sxs-lookup"><span data-stu-id="02ac4-249">Connecting a Virtual Network to backend using Vpn Gateway</span></span>](../vpn-gateway/vpn-gateway-about-vpngateways.md#site-to-site-and-multi-site-ipsecike-vpn-tunnel)
* [<span data-ttu-id="02ac4-250">Connecting a Virtual Network from different deployment models</span><span class="sxs-lookup"><span data-stu-id="02ac4-250">Connecting a Virtual Network from different deployment models</span></span>](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [<span data-ttu-id="02ac4-251">How to use the API Inspector to trace calls in Azure API Management</span><span class="sxs-lookup"><span data-stu-id="02ac4-251">How to use the API Inspector to trace calls in Azure API Management</span></span>](api-management-howto-api-inspector.md)

[api-management-using-vnet-menu]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/api-management/media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/api-management/media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/api-management/media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/api-management/media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/api-management/media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/api-management/media/api-management-using-with-vnet/api-management-vnet-public.png

[Enable VPN connections]: #enable-vpn
[Connect to a web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/virtual-networks-nsg.md






