---
title: Use Azure Managed Service Identity in Azure API Management | Microsoft Docs
description: Learn how to use Azure Managed Service Identity in API Management
services: api-management
documentationcenter: ''
author: miaojiang
manager: anneta
editor: ''
ms.service: api-management
ms.workload: integration
ms.topic: article
ms.date: 10/18/2017
ms.author: apimpm
ms.openlocfilehash: 98aa70935a3efbbe2edb07aade85fa3ea17ce786
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44866969"
---
# <a name="use-azure-managed-service-identity-in-azure-api-management"></a><span data-ttu-id="1b6c3-103">Use Azure Managed Service Identity in Azure API Management</span><span class="sxs-lookup"><span data-stu-id="1b6c3-103">Use Azure Managed Service Identity in Azure API Management</span></span>

<span data-ttu-id="1b6c3-104">This article shows you how to create a managed service identity for an API Management service instance and how to access other resources.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-104">This article shows you how to create a managed service identity for an API Management service instance and how to access other resources.</span></span> <span data-ttu-id="1b6c3-105">A managed service identity generated by Azure Active Directory (Azure AD) allows your API Management instance to easily and securely access other Azure AD-protected resources, such as Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-105">A managed service identity generated by Azure Active Directory (Azure AD) allows your API Management instance to easily and securely access other Azure AD-protected resources, such as Azure Key Vault.</span></span> <span data-ttu-id="1b6c3-106">This managed service identity is managed by Azure and does not require you to provision or rotate any secrets.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-106">This managed service identity is managed by Azure and does not require you to provision or rotate any secrets.</span></span> <span data-ttu-id="1b6c3-107">For more information about Azure Managed Service Identity, see [Managed Service Identity for Azure resources](../active-directory/msi-overview.md).</span><span class="sxs-lookup"><span data-stu-id="1b6c3-107">For more information about Azure Managed Service Identity, see [Managed Service Identity for Azure resources](../active-directory/msi-overview.md).</span></span>

## <a name="create-a-managed-service-identity-for-an-api-management-instance"></a><span data-ttu-id="1b6c3-108">Create a managed service identity for an API Management instance</span><span class="sxs-lookup"><span data-stu-id="1b6c3-108">Create a managed service identity for an API Management instance</span></span>

### <a name="using-the-azure-portal"></a><span data-ttu-id="1b6c3-109">Using the Azure portal</span><span class="sxs-lookup"><span data-stu-id="1b6c3-109">Using the Azure portal</span></span>

<span data-ttu-id="1b6c3-110">To set up a managed service identity in the portal, you will first create an API Management instance as normal and then enable the feature.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-110">To set up a managed service identity in the portal, you will first create an API Management instance as normal and then enable the feature.</span></span>

1. <span data-ttu-id="1b6c3-111">Create an API Management instance in the portal as you normally would.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-111">Create an API Management instance in the portal as you normally would.</span></span> <span data-ttu-id="1b6c3-112">Navigate to it in the portal.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-112">Navigate to it in the portal.</span></span>
2. <span data-ttu-id="1b6c3-113">Select **Managed service identity**.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-113">Select **Managed service identity**.</span></span>
3. <span data-ttu-id="1b6c3-114">Switch Register with Azure Active Directory to On.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-114">Switch Register with Azure Active Directory to On.</span></span> <span data-ttu-id="1b6c3-115">Click Save.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-115">Click Save.</span></span>

![Enable MSI](./media/api-management-msi/enable-msi.png)

### <a name="using-the-azure-resource-manager-template"></a><span data-ttu-id="1b6c3-117">Using the Azure Resource Manager template</span><span class="sxs-lookup"><span data-stu-id="1b6c3-117">Using the Azure Resource Manager template</span></span>

<span data-ttu-id="1b6c3-118">You can create an API Management instance with an identity by including the following property in the resource definition:</span><span class="sxs-lookup"><span data-stu-id="1b6c3-118">You can create an API Management instance with an identity by including the following property in the resource definition:</span></span> 

```json
"identity" : {
    "type" : "SystemAssigned"
}
```

<span data-ttu-id="1b6c3-119">This tells Azure to create and manage the identity for your API Management instance.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-119">This tells Azure to create and manage the identity for your API Management instance.</span></span> 

<span data-ttu-id="1b6c3-120">For example, a complete Azure Resource Manager template might look like the following:</span><span class="sxs-lookup"><span data-stu-id="1b6c3-120">For example, a complete Azure Resource Manager template might look like the following:</span></span>

```json
{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "0.9.0.0"
    },
    "resources": [
        {
            "apiVersion": "2017-03-01",
            "name": "contoso",
            "type": "Microsoft.ApiManagement/service",
            "location": "[resourceGroup().location]",
            "tags": {},
            "sku": {
                "name": "Developer",
                "capacity": "1"
            },
            "properties": {
                "publisherEmail": "admin@contoso.com",
                "publisherName": "Contoso"
            },
            "identity": { 
                "type": "systemAssigned" 
            }
        }
    ]
}
```
## <a name="use-the-managed-service-identity-to-access-other-resources"></a><span data-ttu-id="1b6c3-121">Use the managed service identity to access other resources</span><span class="sxs-lookup"><span data-stu-id="1b6c3-121">Use the managed service identity to access other resources</span></span>

> [!NOTE]
> <span data-ttu-id="1b6c3-122">Currently, managed service identity can be used to obtain certificates from Azure Key Vault for API Management custom domain names.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-122">Currently, managed service identity can be used to obtain certificates from Azure Key Vault for API Management custom domain names.</span></span> <span data-ttu-id="1b6c3-123">More scenarios will be supported soon.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-123">More scenarios will be supported soon.</span></span>
> 
>


### <a name="obtain-a-certificate-from-azure-key-vault"></a><span data-ttu-id="1b6c3-124">Obtain a certificate from Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="1b6c3-124">Obtain a certificate from Azure Key Vault</span></span>

#### <a name="prerequisites"></a><span data-ttu-id="1b6c3-125">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="1b6c3-125">Prerequisites</span></span>
1. <span data-ttu-id="1b6c3-126">The Key Vault containing the pfx certificate must be in the same Azure subscription and the same Resource Group as the API Management service.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-126">The Key Vault containing the pfx certificate must be in the same Azure subscription and the same Resource Group as the API Management service.</span></span> <span data-ttu-id="1b6c3-127">This is a requirement of the Azure Resource Manager template.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-127">This is a requirement of the Azure Resource Manager template.</span></span> 
2. <span data-ttu-id="1b6c3-128">The Content Type of the secret must be *application/x-pkcs12*.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-128">The Content Type of the secret must be *application/x-pkcs12*.</span></span> <span data-ttu-id="1b6c3-129">You can use the following script to upload the certificate:</span><span class="sxs-lookup"><span data-stu-id="1b6c3-129">You can use the following script to upload the certificate:</span></span>

```powershell
$pfxFilePath = "PFX_CERTIFICATE_FILE_PATH" # Change this path 
$pwd = "PFX_CERTIFICATE_PASSWORD" # Change this password 
$flag = [System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::Exportable 
$collection = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2Collection 
$collection.Import($pfxFilePath, $pwd, $flag) 
$pkcs12ContentType = [System.Security.Cryptography.X509Certificates.X509ContentType]::Pkcs12 
$clearBytes = $collection.Export($pkcs12ContentType) 
$fileContentEncoded = [System.Convert]::ToBase64String($clearBytes) 
$secret = ConvertTo-SecureString -String $fileContentEncoded -AsPlainText â€“Force 
$secretContentType = 'application/x-pkcs12' 
Set-AzureKeyVaultSecret -VaultName KEY_VAULT_NAME -Name KEY_VAULT_SECRET_NAME -SecretValue $Secret -ContentType $secretContentType
```

> [!Important]
> <span data-ttu-id="1b6c3-130">If the object version of the certificate is not provided, API Management will automatically obtain the newer version of the certificate after it is uploaded to Key Vault.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-130">If the object version of the certificate is not provided, API Management will automatically obtain the newer version of the certificate after it is uploaded to Key Vault.</span></span> 

<span data-ttu-id="1b6c3-131">The following example shows an Azure Resource Manager template that contains the following steps:</span><span class="sxs-lookup"><span data-stu-id="1b6c3-131">The following example shows an Azure Resource Manager template that contains the following steps:</span></span>

1. <span data-ttu-id="1b6c3-132">Create an API Management instance with a managed service identity.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-132">Create an API Management instance with a managed service identity.</span></span>
2. <span data-ttu-id="1b6c3-133">Update the access policies of an Azure Key Vault instance and allow the API Management instance to obtain secrets from it.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-133">Update the access policies of an Azure Key Vault instance and allow the API Management instance to obtain secrets from it.</span></span>
3. <span data-ttu-id="1b6c3-134">Update the API Management instance by setting a custom domain name through a certificate from the Key Vault instance.</span><span class="sxs-lookup"><span data-stu-id="1b6c3-134">Update the API Management instance by setting a custom domain name through a certificate from the Key Vault instance.</span></span>

```json
{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "publisherEmail": {
            "type": "string",
            "minLength": 1,
            "metadata": {
                "description": "The email address of the owner of the service"
            }
        },
        "publisherName": {
            "type": "string",
            "defaultValue": "Contoso",
            "minLength": 1,
            "metadata": {
                "description": "The name of the owner of the service"
            }
        },
        "sku": {
            "type": "string",
            "allowedValues": ["Developer",
            "Standard",
            "Premium"],
            "defaultValue": "Developer",
            "metadata": {
                "description": "The pricing tier of this API Management service"
            }
        },
        "skuCount": {
            "type": "int",
            "defaultValue": 1,
            "metadata": {
                "description": "The instance size of this API Management service."
            }
        },
        "keyVaultName": {
            "type": "string",
            "metadata": {
                "description": "Name of the vault"
            }
        },
        "proxyCustomHostname1": {
            "type": "string",
            "metadata": {
                "description": "Proxy Custom hostname."
            }
        },
        "keyVaultIdToCertificate": {
            "type": "string",
            "metadata": {
                "description": "Reference to the KeyVault certificate."
            }
        }
    },
    "variables": {
        "apiManagementServiceName": "[concat('apiservice', uniqueString(resourceGroup().id))]",
        "apimServiceIdentityResourceId": "[concat(resourceId('Microsoft.ApiManagement/service', variables('apiManagementServiceName')),'/providers/Microsoft.ManagedIdentity/Identities/default')]"
    },
    "resources": [{
        "apiVersion": "2017-03-01",
        "name": "[variables('apiManagementServiceName')]",
        "type": "Microsoft.ApiManagement/service",
        "location": "[resourceGroup().location]",
        "tags": {
            
        },
        "sku": {
            "name": "[parameters('sku')]",
            "capacity": "[parameters('skuCount')]"
        },
        "properties": {
            "publisherEmail": "[parameters('publisherEmail')]",
            "publisherName": "[parameters('publisherName')]"
        },
        "identity": {
            "type": "systemAssigned"
        }
    },
    {
        "type": "Microsoft.KeyVault/vaults/accessPolicies",
        "name": "[concat(parameters('keyVaultName'), '/add')]",
        "apiVersion": "2015-06-01",        
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service', variables('apiManagementServiceName'))]"
      ],
        "properties": {
            "accessPolicies": [{
                "tenantId": "[reference(variables('apimServiceIdentityResourceId'), '2015-08-31-PREVIEW').tenantId]",
                "objectId": "[reference(variables('apimServiceIdentityResourceId'), '2015-08-31-PREVIEW').principalId]",
                "permissions": {
                    "secrets": ["get"]
                }
            }]
        }
    },
    { 
      "apiVersion": "2017-05-10", 
      "name": "apimWithKeyVault", 
      "type": "Microsoft.Resources/deployments",
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service', variables('apiManagementServiceName'))]"
      ],
      "properties": { 
        "mode": "incremental", 
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/solankisamir/arm-templates/master/basicapim.keyvault.json",
          "contentVersion": "1.0.0.0"
        }, 
        "parameters": {
            "publisherEmail": { "value": "[parameters('publisherEmail')]"},
            "publisherName": { "value": "[parameters('publisherName')]"},
            "sku": { "value": "[parameters('sku')]"},
            "skuCount": { "value": "[parameters('skuCount')]"},
            "proxyCustomHostname1": {"value" : "[parameters('proxyCustomHostname1')]"},
            "keyVaultIdToCertificate": {"value" : "[parameters('keyVaultIdToCertificate')]"}
        }
      } 
    }]
}
```

## <a name="next-steps"></a><span data-ttu-id="1b6c3-135">Next steps</span><span class="sxs-lookup"><span data-stu-id="1b6c3-135">Next steps</span></span>

<span data-ttu-id="1b6c3-136">Learn more about Azure Managed Service Identity:</span><span class="sxs-lookup"><span data-stu-id="1b6c3-136">Learn more about Azure Managed Service Identity:</span></span>

* [<span data-ttu-id="1b6c3-137">Managed Service Identity for Azure resources</span><span class="sxs-lookup"><span data-stu-id="1b6c3-137">Managed Service Identity for Azure resources</span></span>](../active-directory/msi-overview.md)
* [<span data-ttu-id="1b6c3-138">Azure Resource Manager templates</span><span class="sxs-lookup"><span data-stu-id="1b6c3-138">Azure Resource Manager templates</span></span>](https://github.com/Azure/azure-quickstart-templates)

