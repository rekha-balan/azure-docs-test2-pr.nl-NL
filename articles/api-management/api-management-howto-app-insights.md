---
title: How to integrate Azure API Management with Azure Application Insights | Microsoft Docs
description: Learn how to log and view events from Azure API Management in Azure Application Insights.
services: api-management
documentationcenter: ''
author: mikebudzynski
manager: erikre
editor: ''
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/20/2018
ms.author: apimpm
ms.openlocfilehash: a660b36f383eaf1fd0e868200ad7f59aba0f8225
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44869074"
---
# <a name="how-to-integrate-azure-api-management-with-azure-application-insights"></a><span data-ttu-id="53960-103">How to integrate Azure API Management with Azure Application Insights</span><span class="sxs-lookup"><span data-stu-id="53960-103">How to integrate Azure API Management with Azure Application Insights</span></span>

<span data-ttu-id="53960-104">Azure API Management allows for easy integration with Azure Application Insights - an extensible service for web developers building and managing apps on multiple platforms.</span><span class="sxs-lookup"><span data-stu-id="53960-104">Azure API Management allows for easy integration with Azure Application Insights - an extensible service for web developers building and managing apps on multiple platforms.</span></span> <span data-ttu-id="53960-105">This guide walks through every step of such integration and describes strategies for reducing performance impact on your API Management service instance.</span><span class="sxs-lookup"><span data-stu-id="53960-105">This guide walks through every step of such integration and describes strategies for reducing performance impact on your API Management service instance.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="53960-106">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="53960-106">Prerequisites</span></span>

<span data-ttu-id="53960-107">To follow this guide, you need to have an Azure API Management instance.</span><span class="sxs-lookup"><span data-stu-id="53960-107">To follow this guide, you need to have an Azure API Management instance.</span></span> <span data-ttu-id="53960-108">If you don't have one, complete the [tutorial](get-started-create-service-instance.md) first.</span><span class="sxs-lookup"><span data-stu-id="53960-108">If you don't have one, complete the [tutorial](get-started-create-service-instance.md) first.</span></span>

## <a name="create-an-azure-application-insights-instance"></a><span data-ttu-id="53960-109">Create an Azure Application Insights instance</span><span class="sxs-lookup"><span data-stu-id="53960-109">Create an Azure Application Insights instance</span></span>

<span data-ttu-id="53960-110">Before you can use Azure Application Insights, you first need to create an instance of the service.</span><span class="sxs-lookup"><span data-stu-id="53960-110">Before you can use Azure Application Insights, you first need to create an instance of the service.</span></span>

1. <span data-ttu-id="53960-111">Open the **Azure portal** and navigate to **Application Insights**.</span><span class="sxs-lookup"><span data-stu-id="53960-111">Open the **Azure portal** and navigate to **Application Insights**.</span></span>  
    <span data-ttu-id="53960-112">![App Insights create](media/api-management-howto-app-insights/apim-app-insights-instance-1.png)</span><span class="sxs-lookup"><span data-stu-id="53960-112">![App Insights create](media/api-management-howto-app-insights/apim-app-insights-instance-1.png)</span></span>  
2. <span data-ttu-id="53960-113">Click **+ Add**.</span><span class="sxs-lookup"><span data-stu-id="53960-113">Click **+ Add**.</span></span>  
    <span data-ttu-id="53960-114">![App Insights create](media/api-management-howto-app-insights/apim-app-insights-instance-2.png)</span><span class="sxs-lookup"><span data-stu-id="53960-114">![App Insights create](media/api-management-howto-app-insights/apim-app-insights-instance-2.png)</span></span>  
3. <span data-ttu-id="53960-115">Fill the form.</span><span class="sxs-lookup"><span data-stu-id="53960-115">Fill the form.</span></span> <span data-ttu-id="53960-116">Select **General** as the **Application Type**.</span><span class="sxs-lookup"><span data-stu-id="53960-116">Select **General** as the **Application Type**.</span></span>
4. <span data-ttu-id="53960-117">Click **Create**.</span><span class="sxs-lookup"><span data-stu-id="53960-117">Click **Create**.</span></span>

## <a name="create-a-connection-between-azure-application-insights-and-azure-api-management-service-instance"></a><span data-ttu-id="53960-118">Create a connection between Azure Application Insights and Azure API Management service instance</span><span class="sxs-lookup"><span data-stu-id="53960-118">Create a connection between Azure Application Insights and Azure API Management service instance</span></span>

1. <span data-ttu-id="53960-119">Navigate to your **Azure API Management service instance** in the **Azure portal**.</span><span class="sxs-lookup"><span data-stu-id="53960-119">Navigate to your **Azure API Management service instance** in the **Azure portal**.</span></span>
2. <span data-ttu-id="53960-120">Select **Application Insights** from the menu on the left.</span><span class="sxs-lookup"><span data-stu-id="53960-120">Select **Application Insights** from the menu on the left.</span></span>
3. <span data-ttu-id="53960-121">Click **+ Add**.</span><span class="sxs-lookup"><span data-stu-id="53960-121">Click **+ Add**.</span></span>  
    <span data-ttu-id="53960-122">![App Insights logger](media/api-management-howto-app-insights/apim-app-insights-logger-1.png)</span><span class="sxs-lookup"><span data-stu-id="53960-122">![App Insights logger](media/api-management-howto-app-insights/apim-app-insights-logger-1.png)</span></span>  
4. <span data-ttu-id="53960-123">Select the previously created **Application Insights** instance and provide a short description.</span><span class="sxs-lookup"><span data-stu-id="53960-123">Select the previously created **Application Insights** instance and provide a short description.</span></span>
5. <span data-ttu-id="53960-124">Click **Create**.</span><span class="sxs-lookup"><span data-stu-id="53960-124">Click **Create**.</span></span>
6. <span data-ttu-id="53960-125">You have just created an Azure Application Insights logger with an instrumentation key.</span><span class="sxs-lookup"><span data-stu-id="53960-125">You have just created an Azure Application Insights logger with an instrumentation key.</span></span> <span data-ttu-id="53960-126">It should now appear in the list.</span><span class="sxs-lookup"><span data-stu-id="53960-126">It should now appear in the list.</span></span>  
    ![App Insights logger](media/api-management-howto-app-insights/apim-app-insights-logger-2.png)  

> [!NOTE]
> <span data-ttu-id="53960-128">Behind the scene, a [Logger](https://docs.microsoft.com/en-us/rest/api/apimanagement/logger/createorupdate) entity is created in your API Management instance, containing the Instrumentation Key of the Application Insights instance.</span><span class="sxs-lookup"><span data-stu-id="53960-128">Behind the scene, a [Logger](https://docs.microsoft.com/en-us/rest/api/apimanagement/logger/createorupdate) entity is created in your API Management instance, containing the Instrumentation Key of the Application Insights instance.</span></span>

## <a name="enable-application-insights-logging-for-your-api"></a><span data-ttu-id="53960-129">Enable Application Insights logging for your API</span><span class="sxs-lookup"><span data-stu-id="53960-129">Enable Application Insights logging for your API</span></span>

1. <span data-ttu-id="53960-130">Navigate to your **Azure API Management service instance** in the **Azure portal**.</span><span class="sxs-lookup"><span data-stu-id="53960-130">Navigate to your **Azure API Management service instance** in the **Azure portal**.</span></span>
2. <span data-ttu-id="53960-131">Select **APIs** from the menu on the left.</span><span class="sxs-lookup"><span data-stu-id="53960-131">Select **APIs** from the menu on the left.</span></span>
3. <span data-ttu-id="53960-132">Click on your API, in this case **Demo Conference API**.</span><span class="sxs-lookup"><span data-stu-id="53960-132">Click on your API, in this case **Demo Conference API**.</span></span>
4. <span data-ttu-id="53960-133">Go to the **Settings** tab from the top bar.</span><span class="sxs-lookup"><span data-stu-id="53960-133">Go to the **Settings** tab from the top bar.</span></span>
5. <span data-ttu-id="53960-134">Scroll down to the **Diagnostics Logs** section.</span><span class="sxs-lookup"><span data-stu-id="53960-134">Scroll down to the **Diagnostics Logs** section.</span></span>  
    <span data-ttu-id="53960-135">![App Insights logger](media/api-management-howto-app-insights/apim-app-insights-api-1.png)</span><span class="sxs-lookup"><span data-stu-id="53960-135">![App Insights logger](media/api-management-howto-app-insights/apim-app-insights-api-1.png)</span></span>  
6. <span data-ttu-id="53960-136">Check the **Enable** box.</span><span class="sxs-lookup"><span data-stu-id="53960-136">Check the **Enable** box.</span></span>
7. <span data-ttu-id="53960-137">Select your attached logger in the **Destination** dropdown.</span><span class="sxs-lookup"><span data-stu-id="53960-137">Select your attached logger in the **Destination** dropdown.</span></span>
8. <span data-ttu-id="53960-138">Input **100** as **Sampling (%)** and tick the **Always log errors** checkbox.</span><span class="sxs-lookup"><span data-stu-id="53960-138">Input **100** as **Sampling (%)** and tick the **Always log errors** checkbox.</span></span>
9. <span data-ttu-id="53960-139">Input **1024** in the **First bytes of body** field.</span><span class="sxs-lookup"><span data-stu-id="53960-139">Input **1024** in the **First bytes of body** field.</span></span>
10. <span data-ttu-id="53960-140">Click **Save**.</span><span class="sxs-lookup"><span data-stu-id="53960-140">Click **Save**.</span></span>

> [!NOTE]
> <span data-ttu-id="53960-141">Behind the scene, a [Diagnostic](https://docs.microsoft.com/en-us/rest/api/apimanagement/diagnostic/createorupdate) entity named 'applicationinsights' is created at the API level.</span><span class="sxs-lookup"><span data-stu-id="53960-141">Behind the scene, a [Diagnostic](https://docs.microsoft.com/en-us/rest/api/apimanagement/diagnostic/createorupdate) entity named 'applicationinsights' is created at the API level.</span></span>

| <span data-ttu-id="53960-142">Setting name</span><span class="sxs-lookup"><span data-stu-id="53960-142">Setting name</span></span>                        | <span data-ttu-id="53960-143">Value type</span><span class="sxs-lookup"><span data-stu-id="53960-143">Value type</span></span>                        | <span data-ttu-id="53960-144">Description</span><span class="sxs-lookup"><span data-stu-id="53960-144">Description</span></span>                                                                                                                                                                                                                                                                                                                                      |
|-------------------------------------|-----------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="53960-145">Enable</span><span class="sxs-lookup"><span data-stu-id="53960-145">Enable</span></span>                              | <span data-ttu-id="53960-146">boolean</span><span class="sxs-lookup"><span data-stu-id="53960-146">boolean</span></span>                           | <span data-ttu-id="53960-147">Specifies whether logging of this API is enabled.</span><span class="sxs-lookup"><span data-stu-id="53960-147">Specifies whether logging of this API is enabled.</span></span>                                                                                                                                                                                                                                                                                                |
| <span data-ttu-id="53960-148">Destination</span><span class="sxs-lookup"><span data-stu-id="53960-148">Destination</span></span>                         | <span data-ttu-id="53960-149">Azure Application Insights logger</span><span class="sxs-lookup"><span data-stu-id="53960-149">Azure Application Insights logger</span></span> | <span data-ttu-id="53960-150">Specifies Azure Application Insights logger to be used</span><span class="sxs-lookup"><span data-stu-id="53960-150">Specifies Azure Application Insights logger to be used</span></span>                                                                                                                                                                                                                                                                                           |
| <span data-ttu-id="53960-151">Sampling (%)</span><span class="sxs-lookup"><span data-stu-id="53960-151">Sampling (%)</span></span>                        | <span data-ttu-id="53960-152">decimal</span><span class="sxs-lookup"><span data-stu-id="53960-152">decimal</span></span>                           | <span data-ttu-id="53960-153">Values from 0 to 100 (percent).</span><span class="sxs-lookup"><span data-stu-id="53960-153">Values from 0 to 100 (percent).</span></span> <br/> <span data-ttu-id="53960-154">Specifies what percentage of requests will be logged to Azure Application Insights.</span><span class="sxs-lookup"><span data-stu-id="53960-154">Specifies what percentage of requests will be logged to Azure Application Insights.</span></span> <span data-ttu-id="53960-155">0% sampling means zero requests logged, while 100% sampling means all requests logged.</span><span class="sxs-lookup"><span data-stu-id="53960-155">0% sampling means zero requests logged, while 100% sampling means all requests logged.</span></span> <br/> <span data-ttu-id="53960-156">This setting is used for reducing performance implications of logging requests to Azure Application Insights (see the section below).</span><span class="sxs-lookup"><span data-stu-id="53960-156">This setting is used for reducing performance implications of logging requests to Azure Application Insights (see the section below).</span></span> |
| <span data-ttu-id="53960-157">Always log errors</span><span class="sxs-lookup"><span data-stu-id="53960-157">Always log errors</span></span>                   | <span data-ttu-id="53960-158">boolean</span><span class="sxs-lookup"><span data-stu-id="53960-158">boolean</span></span>                           | <span data-ttu-id="53960-159">If this setting is selected, all failures will be logged to Azure Application Insights, regardless of the **Sampling** setting.</span><span class="sxs-lookup"><span data-stu-id="53960-159">If this setting is selected, all failures will be logged to Azure Application Insights, regardless of the **Sampling** setting.</span></span>                                                                                                                                                                                                                  |
| <span data-ttu-id="53960-160">Basic Options: Headers</span><span class="sxs-lookup"><span data-stu-id="53960-160">Basic Options: Headers</span></span>              | <span data-ttu-id="53960-161">list</span><span class="sxs-lookup"><span data-stu-id="53960-161">list</span></span>                              | <span data-ttu-id="53960-162">Specifies the headers that will be logged to Azure Application Insights for requests and responses.</span><span class="sxs-lookup"><span data-stu-id="53960-162">Specifies the headers that will be logged to Azure Application Insights for requests and responses.</span></span>  <span data-ttu-id="53960-163">Default: no headers are logged.</span><span class="sxs-lookup"><span data-stu-id="53960-163">Default: no headers are logged.</span></span>                                                                                                                                                                                                             |
| <span data-ttu-id="53960-164">Basic Options: First bytes of body</span><span class="sxs-lookup"><span data-stu-id="53960-164">Basic Options: First bytes of body</span></span>  | <span data-ttu-id="53960-165">integer</span><span class="sxs-lookup"><span data-stu-id="53960-165">integer</span></span>                           | <span data-ttu-id="53960-166">Specifies how many first bytes of the body are logged to Azure Application Insights for requests and responses.</span><span class="sxs-lookup"><span data-stu-id="53960-166">Specifies how many first bytes of the body are logged to Azure Application Insights for requests and responses.</span></span>  <span data-ttu-id="53960-167">Default: body is not logged.</span><span class="sxs-lookup"><span data-stu-id="53960-167">Default: body is not logged.</span></span>                                                                                                                                                                                              |
| <span data-ttu-id="53960-168">Advanced Options: Frontend Request</span><span class="sxs-lookup"><span data-stu-id="53960-168">Advanced Options: Frontend Request</span></span>  |                                   | <span data-ttu-id="53960-169">Specifies whether and how *frontend requests* will be logged to Azure Application Insights.</span><span class="sxs-lookup"><span data-stu-id="53960-169">Specifies whether and how *frontend requests* will be logged to Azure Application Insights.</span></span> <span data-ttu-id="53960-170">*Frontend request* is a request incoming to the Azure API Management service.</span><span class="sxs-lookup"><span data-stu-id="53960-170">*Frontend request* is a request incoming to the Azure API Management service.</span></span>                                                                                                                                                                        |
| <span data-ttu-id="53960-171">Advanced Options: Frontend Response</span><span class="sxs-lookup"><span data-stu-id="53960-171">Advanced Options: Frontend Response</span></span> |                                   | <span data-ttu-id="53960-172">Specifies whether and how *frontend responses* will be logged to Azure Application Insights.</span><span class="sxs-lookup"><span data-stu-id="53960-172">Specifies whether and how *frontend responses* will be logged to Azure Application Insights.</span></span> <span data-ttu-id="53960-173">*Frontend response* is a response outgoing from the Azure API Management service.</span><span class="sxs-lookup"><span data-stu-id="53960-173">*Frontend response* is a response outgoing from the Azure API Management service.</span></span>                                                                                                                                                                   |
| <span data-ttu-id="53960-174">Advanced Options: Backend Request</span><span class="sxs-lookup"><span data-stu-id="53960-174">Advanced Options: Backend Request</span></span>   |                                   | <span data-ttu-id="53960-175">Specifies whether and how *backend requests* will be logged to Azure Application Insights.</span><span class="sxs-lookup"><span data-stu-id="53960-175">Specifies whether and how *backend requests* will be logged to Azure Application Insights.</span></span> <span data-ttu-id="53960-176">*Backend request* is a request outgoing from the Azure API Management service.</span><span class="sxs-lookup"><span data-stu-id="53960-176">*Backend request* is a request outgoing from the Azure API Management service.</span></span>                                                                                                                                                                        |
| <span data-ttu-id="53960-177">Advanced Options: Backend Response</span><span class="sxs-lookup"><span data-stu-id="53960-177">Advanced Options: Backend Response</span></span>  |                                   | <span data-ttu-id="53960-178">Specifies whether and how *backend responses* will be logged to Azure Application Insights.</span><span class="sxs-lookup"><span data-stu-id="53960-178">Specifies whether and how *backend responses* will be logged to Azure Application Insights.</span></span> <span data-ttu-id="53960-179">*Backend response* is a response incoming to the Azure API Management service.</span><span class="sxs-lookup"><span data-stu-id="53960-179">*Backend response* is a response incoming to the Azure API Management service.</span></span>                                                                                                                                                                       |

> [!NOTE]
> <span data-ttu-id="53960-180">You can specify loggers on different levels - single API logger or a logger for all APIs.</span><span class="sxs-lookup"><span data-stu-id="53960-180">You can specify loggers on different levels - single API logger or a logger for all APIs.</span></span>
>  
> <span data-ttu-id="53960-181">If you specify both:</span><span class="sxs-lookup"><span data-stu-id="53960-181">If you specify both:</span></span>
> + <span data-ttu-id="53960-182">if they are different loggers, then both of them will be used (multiplexing logs),</span><span class="sxs-lookup"><span data-stu-id="53960-182">if they are different loggers, then both of them will be used (multiplexing logs),</span></span>
> + <span data-ttu-id="53960-183">if they are the same loggers but have different settings, then the one for single API (more granular level) will override the one for all APIs.</span><span class="sxs-lookup"><span data-stu-id="53960-183">if they are the same loggers but have different settings, then the one for single API (more granular level) will override the one for all APIs.</span></span>

## <a name="what-data-is-added-to-azure-application-insights"></a><span data-ttu-id="53960-184">What data is added to Azure Application Insights</span><span class="sxs-lookup"><span data-stu-id="53960-184">What data is added to Azure Application Insights</span></span>

<span data-ttu-id="53960-185">Azure Application Insights receives:</span><span class="sxs-lookup"><span data-stu-id="53960-185">Azure Application Insights receives:</span></span>

+ <span data-ttu-id="53960-186">*Request* telemetry item, for every incoming request (*frontend request*, *frontend response*),</span><span class="sxs-lookup"><span data-stu-id="53960-186">*Request* telemetry item, for every incoming request (*frontend request*, *frontend response*),</span></span>
+ <span data-ttu-id="53960-187">*Dependency* telemetry item, for every request forwarded to a backend service (*backend request*, *backend response*),</span><span class="sxs-lookup"><span data-stu-id="53960-187">*Dependency* telemetry item, for every request forwarded to a backend service (*backend request*, *backend response*),</span></span>
+ <span data-ttu-id="53960-188">*Exception* telemetry item, for every failed request.</span><span class="sxs-lookup"><span data-stu-id="53960-188">*Exception* telemetry item, for every failed request.</span></span>

<span data-ttu-id="53960-189">A failed request is a request, which:</span><span class="sxs-lookup"><span data-stu-id="53960-189">A failed request is a request, which:</span></span>

+ <span data-ttu-id="53960-190">failed because of a closed client connection, or</span><span class="sxs-lookup"><span data-stu-id="53960-190">failed because of a closed client connection, or</span></span>
+ <span data-ttu-id="53960-191">triggered an *on-error* section of the API policies, or</span><span class="sxs-lookup"><span data-stu-id="53960-191">triggered an *on-error* section of the API policies, or</span></span>
+ <span data-ttu-id="53960-192">has a response HTTP status code matching 4xx or 5xx.</span><span class="sxs-lookup"><span data-stu-id="53960-192">has a response HTTP status code matching 4xx or 5xx.</span></span>

## <a name="performance-implications-and-log-sampling"></a><span data-ttu-id="53960-193">Performance implications and log sampling</span><span class="sxs-lookup"><span data-stu-id="53960-193">Performance implications and log sampling</span></span>

> [!WARNING]
> <span data-ttu-id="53960-194">Logging all events may have serious performance implications, depending on incoming requests rate.</span><span class="sxs-lookup"><span data-stu-id="53960-194">Logging all events may have serious performance implications, depending on incoming requests rate.</span></span>

<span data-ttu-id="53960-195">Based on internal load tests, enabling this feature caused a 40%-50% reduction in throughput when request rate exceeded 1,000 requests per second.</span><span class="sxs-lookup"><span data-stu-id="53960-195">Based on internal load tests, enabling this feature caused a 40%-50% reduction in throughput when request rate exceeded 1,000 requests per second.</span></span> <span data-ttu-id="53960-196">Azure Application Insights is designed to use statistical analysis for assessing application performances.</span><span class="sxs-lookup"><span data-stu-id="53960-196">Azure Application Insights is designed to use statistical analysis for assessing application performances.</span></span> <span data-ttu-id="53960-197">It is not intended to be an audit system and is not suited for logging each individual request for high-volume APIs.</span><span class="sxs-lookup"><span data-stu-id="53960-197">It is not intended to be an audit system and is not suited for logging each individual request for high-volume APIs.</span></span>

<span data-ttu-id="53960-198">You can manipulate the number of requests being logged by adjusting the **Sampling** setting (see the steps above).</span><span class="sxs-lookup"><span data-stu-id="53960-198">You can manipulate the number of requests being logged by adjusting the **Sampling** setting (see the steps above).</span></span> <span data-ttu-id="53960-199">Value 100% means all requests are logged, while 0% reflects no logging at all.</span><span class="sxs-lookup"><span data-stu-id="53960-199">Value 100% means all requests are logged, while 0% reflects no logging at all.</span></span> <span data-ttu-id="53960-200">**Sampling** helps to reduce volume of telemetry, effectively preventing from significant performance degradation, while still carrying the benefits of logging.</span><span class="sxs-lookup"><span data-stu-id="53960-200">**Sampling** helps to reduce volume of telemetry, effectively preventing from significant performance degradation, while still carrying the benefits of logging.</span></span>

<span data-ttu-id="53960-201">Skipping logging of headers and body of requests and responses will also have positive impact on alleviating performance issues.</span><span class="sxs-lookup"><span data-stu-id="53960-201">Skipping logging of headers and body of requests and responses will also have positive impact on alleviating performance issues.</span></span>

## <a name="video"></a><span data-ttu-id="53960-202">Video</span><span class="sxs-lookup"><span data-stu-id="53960-202">Video</span></span>

> [!VIDEO https://www.microsoft.com/en-us/videoplayer/embed/RE2pkXv]
>
>

## <a name="next-steps"></a><span data-ttu-id="53960-203">Next steps</span><span class="sxs-lookup"><span data-stu-id="53960-203">Next steps</span></span>

+ <span data-ttu-id="53960-204">Learn more about [Azure Application Insights](https://docs.microsoft.com/en-us/azure/application-insights/).</span><span class="sxs-lookup"><span data-stu-id="53960-204">Learn more about [Azure Application Insights](https://docs.microsoft.com/en-us/azure/application-insights/).</span></span>
+ <span data-ttu-id="53960-205">Consider [logging with Azure Event Hubs](api-management-howto-log-event-hubs.md).</span><span class="sxs-lookup"><span data-stu-id="53960-205">Consider [logging with Azure Event Hubs](api-management-howto-log-event-hubs.md).</span></span>
