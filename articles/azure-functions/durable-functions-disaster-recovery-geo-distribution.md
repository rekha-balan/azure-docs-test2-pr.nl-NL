---
title: Disaster recovery and geo-distribution in Durable Functions - Azure
description: Learn about disaster recovery and geo-distribution in Durable Functions.
services: functions
author: MS-Santi
manager: jeconnoc
keywords: ''
ms.service: azure-functions
ms.devlang: multiple
ms.topic: conceptual
ms.date: 04/25/2018
ms.author: azfuncdf
ms.openlocfilehash: c3eae78b613916d05009ecdd567c2f73e5e78c66
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44870704"
---
# <a name="disaster-recovery-and-geo-distribution"></a><span data-ttu-id="e8361-103">Disaster recovery and geo-distribution</span><span class="sxs-lookup"><span data-stu-id="e8361-103">Disaster recovery and geo-distribution</span></span>

## <a name="overview"></a><span data-ttu-id="e8361-104">Overview</span><span class="sxs-lookup"><span data-stu-id="e8361-104">Overview</span></span>
<span data-ttu-id="e8361-105">In Azure Durable Functions, all state is persisted in Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="e8361-105">In Azure Durable Functions, all state is persisted in Azure Storage.</span></span> <span data-ttu-id="e8361-106">A [task hub](durable-functions-task-hubs.md) is a logical container for Azure Storage resources that are used for orchestrations.</span><span class="sxs-lookup"><span data-stu-id="e8361-106">A [task hub](durable-functions-task-hubs.md) is a logical container for Azure Storage resources that are used for orchestrations.</span></span> <span data-ttu-id="e8361-107">Orchestrator and activity functions can only interact with each other when they belong to the same task hub.</span><span class="sxs-lookup"><span data-stu-id="e8361-107">Orchestrator and activity functions can only interact with each other when they belong to the same task hub.</span></span>
<span data-ttu-id="e8361-108">The described scenarios propose deployment options to increase availability and minimize downtime during disaster recovery activities.</span><span class="sxs-lookup"><span data-stu-id="e8361-108">The described scenarios propose deployment options to increase availability and minimize downtime during disaster recovery activities.</span></span>
<span data-ttu-id="e8361-109">It's important to notice that these scenarios are based on Active-Passive configurations, since they are guided by the usage of Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="e8361-109">It's important to notice that these scenarios are based on Active-Passive configurations, since they are guided by the usage of Azure Storage.</span></span> <span data-ttu-id="e8361-110">This pattern consists of deploying a backup (passive) function app to a different region.</span><span class="sxs-lookup"><span data-stu-id="e8361-110">This pattern consists of deploying a backup (passive) function app to a different region.</span></span> <span data-ttu-id="e8361-111">Traffic Manager will monitor the primary (active) function app for availability.</span><span class="sxs-lookup"><span data-stu-id="e8361-111">Traffic Manager will monitor the primary (active) function app for availability.</span></span> <span data-ttu-id="e8361-112">It will fail over to the backup function app if the primary fails.</span><span class="sxs-lookup"><span data-stu-id="e8361-112">It will fail over to the backup function app if the primary fails.</span></span> <span data-ttu-id="e8361-113">For more information,  see [Traffic Manager](https://azure.microsoft.com/services/traffic-manager/)'s [Priority Traffic-Routing Method.](../traffic-manager/traffic-manager-routing-methods.md#a-name--priorityapriority-traffic-routing-method)</span><span class="sxs-lookup"><span data-stu-id="e8361-113">For more information,  see [Traffic Manager](https://azure.microsoft.com/services/traffic-manager/)'s [Priority Traffic-Routing Method.](../traffic-manager/traffic-manager-routing-methods.md#a-name--priorityapriority-traffic-routing-method)</span></span>


>[!NOTE]
>- <span data-ttu-id="e8361-114">The proposed Active-Passive configuration ensures that a client is always able to trigger new orchestrations via HTTP.</span><span class="sxs-lookup"><span data-stu-id="e8361-114">The proposed Active-Passive configuration ensures that a client is always able to trigger new orchestrations via HTTP.</span></span> <span data-ttu-id="e8361-115">However, as a consequence of having two function apps sharing the same storage, background processing will be distributed between both of them, competing for messages on the same queues.</span><span class="sxs-lookup"><span data-stu-id="e8361-115">However, as a consequence of having two function apps sharing the same storage, background processing will be distributed between both of them, competing for messages on the same queues.</span></span> <span data-ttu-id="e8361-116">This configuration incurs in added egress costs for the secondary function app.</span><span class="sxs-lookup"><span data-stu-id="e8361-116">This configuration incurs in added egress costs for the secondary function app.</span></span>
>- <span data-ttu-id="e8361-117">The underlying storage account and task hub are created in the primary region, and are shared by both function apps.</span><span class="sxs-lookup"><span data-stu-id="e8361-117">The underlying storage account and task hub are created in the primary region, and are shared by both function apps.</span></span>
>- <span data-ttu-id="e8361-118">All function apps that are redundantly deployed, must share the same function access keys in the case of being activated via HTTP.</span><span class="sxs-lookup"><span data-stu-id="e8361-118">All function apps that are redundantly deployed, must share the same function access keys in the case of being activated via HTTP.</span></span> <span data-ttu-id="e8361-119">The Functions Runtime exposes a [management API](https://github.com/Azure/azure-functions-host/wiki/Key-management-API) that enables consumers to programmatically add, delete, and update function keys.</span><span class="sxs-lookup"><span data-stu-id="e8361-119">The Functions Runtime exposes a [management API](https://github.com/Azure/azure-functions-host/wiki/Key-management-API) that enables consumers to programmatically add, delete, and update function keys.</span></span>

## <a name="scenario-1---load-balanced-compute-with-shared-storage"></a><span data-ttu-id="e8361-120">Scenario 1 - Load balanced compute with shared storage</span><span class="sxs-lookup"><span data-stu-id="e8361-120">Scenario 1 - Load balanced compute with shared storage</span></span>
<span data-ttu-id="e8361-121">If the compute infrastructure in Azure fails, the function app may become unavailable.</span><span class="sxs-lookup"><span data-stu-id="e8361-121">If the compute infrastructure in Azure fails, the function app may become unavailable.</span></span> <span data-ttu-id="e8361-122">To minimize the possibility of such downtime, this scenario uses two function apps deployed to different regions.</span><span class="sxs-lookup"><span data-stu-id="e8361-122">To minimize the possibility of such downtime, this scenario uses two function apps deployed to different regions.</span></span> <span data-ttu-id="e8361-123">Traffic Manager is configured to detect problems in the primary function app and automatically redirect traffic to the function app in the secondary region.</span><span class="sxs-lookup"><span data-stu-id="e8361-123">Traffic Manager is configured to detect problems in the primary function app and automatically redirect traffic to the function app in the secondary region.</span></span> <span data-ttu-id="e8361-124">This function app shares the same Azure Storage account and Task Hub.</span><span class="sxs-lookup"><span data-stu-id="e8361-124">This function app shares the same Azure Storage account and Task Hub.</span></span> <span data-ttu-id="e8361-125">Therefore, the state of the function apps isn't lost and work can resume normally.</span><span class="sxs-lookup"><span data-stu-id="e8361-125">Therefore, the state of the function apps isn't lost and work can resume normally.</span></span> <span data-ttu-id="e8361-126">Once health is restored to the primary region, Azure Traffic Manager will start routing requests to that function app automatically.</span><span class="sxs-lookup"><span data-stu-id="e8361-126">Once health is restored to the primary region, Azure Traffic Manager will start routing requests to that function app automatically.</span></span>


![Diagram showing scenario 1.](media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario01.png)

<span data-ttu-id="e8361-128">There are several benefits when using this deployment scenario:</span><span class="sxs-lookup"><span data-stu-id="e8361-128">There are several benefits when using this deployment scenario:</span></span>
- <span data-ttu-id="e8361-129">If the compute infrastructure fails, work can resume in the fail over region without state loss.</span><span class="sxs-lookup"><span data-stu-id="e8361-129">If the compute infrastructure fails, work can resume in the fail over region without state loss.</span></span>
- <span data-ttu-id="e8361-130">Traffic Manager takes care of the automatic fail over to the healthy function app automatically.</span><span class="sxs-lookup"><span data-stu-id="e8361-130">Traffic Manager takes care of the automatic fail over to the healthy function app automatically.</span></span>
- <span data-ttu-id="e8361-131">Traffic Manager automatically re-establishes traffic to the primary function app after the outage has been corrected.</span><span class="sxs-lookup"><span data-stu-id="e8361-131">Traffic Manager automatically re-establishes traffic to the primary function app after the outage has been corrected.</span></span>

<span data-ttu-id="e8361-132">However,  using this scenario consider:</span><span class="sxs-lookup"><span data-stu-id="e8361-132">However,  using this scenario consider:</span></span>
- <span data-ttu-id="e8361-133">If the function app is deployed using a dedicated App Service plan, replicating the compute infrastructure in the fail over datacenter increases costs.</span><span class="sxs-lookup"><span data-stu-id="e8361-133">If the function app is deployed using a dedicated App Service plan, replicating the compute infrastructure in the fail over datacenter increases costs.</span></span>
- <span data-ttu-id="e8361-134">This scenario covers outages at the compute infrastructure, but the storage account continues to be the single point of failure for the function App.</span><span class="sxs-lookup"><span data-stu-id="e8361-134">This scenario covers outages at the compute infrastructure, but the storage account continues to be the single point of failure for the function App.</span></span> <span data-ttu-id="e8361-135">If there is a Storage outage, the application suffers a downtime.</span><span class="sxs-lookup"><span data-stu-id="e8361-135">If there is a Storage outage, the application suffers a downtime.</span></span>
- <span data-ttu-id="e8361-136">If the function app is failed over, there will be increased latency since it will access its storage account across regions.</span><span class="sxs-lookup"><span data-stu-id="e8361-136">If the function app is failed over, there will be increased latency since it will access its storage account across regions.</span></span>
- <span data-ttu-id="e8361-137">Accessing the storage service from a different region where it's located incurs in higher cost due to network egress traffic.</span><span class="sxs-lookup"><span data-stu-id="e8361-137">Accessing the storage service from a different region where it's located incurs in higher cost due to network egress traffic.</span></span>
- <span data-ttu-id="e8361-138">This scenario depends on Traffic Manager.</span><span class="sxs-lookup"><span data-stu-id="e8361-138">This scenario depends on Traffic Manager.</span></span> <span data-ttu-id="e8361-139">Considering [how Traffic Manager works](../traffic-manager/traffic-manager-how-it-works.md), it may be some time until a client application that consumes a Durable Function needs to query again the function app address from Traffic Manager.</span><span class="sxs-lookup"><span data-stu-id="e8361-139">Considering [how Traffic Manager works](../traffic-manager/traffic-manager-how-it-works.md), it may be some time until a client application that consumes a Durable Function needs to query again the function app address from Traffic Manager.</span></span> 


## <a name="scenario-2---load-balanced-compute-with-regional-storage"></a><span data-ttu-id="e8361-140">Scenario 2 - Load balanced compute with regional storage</span><span class="sxs-lookup"><span data-stu-id="e8361-140">Scenario 2 - Load balanced compute with regional storage</span></span>
<span data-ttu-id="e8361-141">The preceding scenario covers only the case of failure in the compute infrastructure.</span><span class="sxs-lookup"><span data-stu-id="e8361-141">The preceding scenario covers only the case of failure in the compute infrastructure.</span></span> <span data-ttu-id="e8361-142">If the storage service fails, it will result in an outage of the function app.</span><span class="sxs-lookup"><span data-stu-id="e8361-142">If the storage service fails, it will result in an outage of the function app.</span></span>
<span data-ttu-id="e8361-143">To ensure continuous operation of the durable functions, this scenario uses a local storage account on each region to which the function apps are deployed.</span><span class="sxs-lookup"><span data-stu-id="e8361-143">To ensure continuous operation of the durable functions, this scenario uses a local storage account on each region to which the function apps are deployed.</span></span>

![Diagram showing scenario 2.](media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario02.png)

<span data-ttu-id="e8361-145">This approach adds improvements on the previous scenario:</span><span class="sxs-lookup"><span data-stu-id="e8361-145">This approach adds improvements on the previous scenario:</span></span>
- <span data-ttu-id="e8361-146">If the function app fails, Traffic Manager takes care of failing over to the secondary region.</span><span class="sxs-lookup"><span data-stu-id="e8361-146">If the function app fails, Traffic Manager takes care of failing over to the secondary region.</span></span> <span data-ttu-id="e8361-147">However, because the function app relies on its own storage account, the durable functions continue to work.</span><span class="sxs-lookup"><span data-stu-id="e8361-147">However, because the function app relies on its own storage account, the durable functions continue to work.</span></span>
- <span data-ttu-id="e8361-148">During a fail over, there is no additional latency in the fail over region, since the function app and the storage account are co-located.</span><span class="sxs-lookup"><span data-stu-id="e8361-148">During a fail over, there is no additional latency in the fail over region, since the function app and the storage account are co-located.</span></span>
- <span data-ttu-id="e8361-149">Failure of the storage layer will cause failures in the durable functions, which, in turn, will trigger a redirection to the fail over region.</span><span class="sxs-lookup"><span data-stu-id="e8361-149">Failure of the storage layer will cause failures in the durable functions, which, in turn, will trigger a redirection to the fail over region.</span></span> <span data-ttu-id="e8361-150">Again, since the function app and storage are isolated per region, the durable functions will continue to work.</span><span class="sxs-lookup"><span data-stu-id="e8361-150">Again, since the function app and storage are isolated per region, the durable functions will continue to work.</span></span>
 
<span data-ttu-id="e8361-151">Important considerations for this scenario:</span><span class="sxs-lookup"><span data-stu-id="e8361-151">Important considerations for this scenario:</span></span>
- <span data-ttu-id="e8361-152">If the function app is deployed using a dedicated AppService plan, replicating the compute infrastructure in the fail over datacenter increases costs.</span><span class="sxs-lookup"><span data-stu-id="e8361-152">If the function app is deployed using a dedicated AppService plan, replicating the compute infrastructure in the fail over datacenter increases costs.</span></span>
- <span data-ttu-id="e8361-153">Current state isn't failed over, which implies that executing and checkpointed functions will fail.</span><span class="sxs-lookup"><span data-stu-id="e8361-153">Current state isn't failed over, which implies that executing and checkpointed functions will fail.</span></span> <span data-ttu-id="e8361-154">It's up to the client application to retry/restart the work.</span><span class="sxs-lookup"><span data-stu-id="e8361-154">It's up to the client application to retry/restart the work.</span></span>

## <a name="scenario-3---load-balanced-compute-with-grs-shared-storage"></a><span data-ttu-id="e8361-155">Scenario 3 - Load balanced compute with GRS shared storage</span><span class="sxs-lookup"><span data-stu-id="e8361-155">Scenario 3 - Load balanced compute with GRS shared storage</span></span>
<span data-ttu-id="e8361-156">This scenario is a modification over the first scenario, implementing a shared storage account.</span><span class="sxs-lookup"><span data-stu-id="e8361-156">This scenario is a modification over the first scenario, implementing a shared storage account.</span></span> <span data-ttu-id="e8361-157">The main difference that the storage account is created with geo-replication enabled.</span><span class="sxs-lookup"><span data-stu-id="e8361-157">The main difference that the storage account is created with geo-replication enabled.</span></span>
<span data-ttu-id="e8361-158">Functionally, this scenario provides the same advantages as Scenario 1, but it enables additional data recovery advantages:</span><span class="sxs-lookup"><span data-stu-id="e8361-158">Functionally, this scenario provides the same advantages as Scenario 1, but it enables additional data recovery advantages:</span></span>
- <span data-ttu-id="e8361-159">Geo-redundant storage (GRS) and Read-access GRS (RA-GRS) maximize availability for your storage account.</span><span class="sxs-lookup"><span data-stu-id="e8361-159">Geo-redundant storage (GRS) and Read-access GRS (RA-GRS) maximize availability for your storage account.</span></span>
- <span data-ttu-id="e8361-160">If there is a region outage of the storage service, one of the possibilities is that the datacenter operations determine that storage must be failed over to the secondary region.</span><span class="sxs-lookup"><span data-stu-id="e8361-160">If there is a region outage of the storage service, one of the possibilities is that the datacenter operations determine that storage must be failed over to the secondary region.</span></span> <span data-ttu-id="e8361-161">In this case, storage account access will be redirected transparently to the geo-replicated copy of the storage account, without user intervention.</span><span class="sxs-lookup"><span data-stu-id="e8361-161">In this case, storage account access will be redirected transparently to the geo-replicated copy of the storage account, without user intervention.</span></span>
- <span data-ttu-id="e8361-162">In this case, state of the durable functions will be preserved up to the last replication of the storage account, which occurs every few minutes.</span><span class="sxs-lookup"><span data-stu-id="e8361-162">In this case, state of the durable functions will be preserved up to the last replication of the storage account, which occurs every few minutes.</span></span>
<span data-ttu-id="e8361-163">As with the other scenarios, there are important considerations:</span><span class="sxs-lookup"><span data-stu-id="e8361-163">As with the other scenarios, there are important considerations:</span></span>
- <span data-ttu-id="e8361-164">Fail over to the replica is done by datacenter operators and it may take some time.</span><span class="sxs-lookup"><span data-stu-id="e8361-164">Fail over to the replica is done by datacenter operators and it may take some time.</span></span> <span data-ttu-id="e8361-165">Until that time, the function app will suffer an outage.</span><span class="sxs-lookup"><span data-stu-id="e8361-165">Until that time, the function app will suffer an outage.</span></span>
- <span data-ttu-id="e8361-166">There is an increased cost for using geo-replicated storage accounts.</span><span class="sxs-lookup"><span data-stu-id="e8361-166">There is an increased cost for using geo-replicated storage accounts.</span></span>
- <span data-ttu-id="e8361-167">GRS occurs asynchronously.</span><span class="sxs-lookup"><span data-stu-id="e8361-167">GRS occurs asynchronously.</span></span> <span data-ttu-id="e8361-168">Some of the latest transactions might be lost because of the latency of the replication process.</span><span class="sxs-lookup"><span data-stu-id="e8361-168">Some of the latest transactions might be lost because of the latency of the replication process.</span></span>

![Diagram showing scenario 3.](media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario03.png)


## <a name="next-steps"></a><span data-ttu-id="e8361-170">Next steps</span><span class="sxs-lookup"><span data-stu-id="e8361-170">Next steps</span></span>

<span data-ttu-id="e8361-171">You can read more about [Designing Highly Available Applications using RA-GRS](../storage/common/storage-designing-ha-apps-with-ragrs.md)</span><span class="sxs-lookup"><span data-stu-id="e8361-171">You can read more about [Designing Highly Available Applications using RA-GRS](../storage/common/storage-designing-ha-apps-with-ragrs.md)</span></span>
