---
title: SQL VM connection to Azure Search | Microsoft Docs
description: Enable encrypted connections and configure the firewall to allow connections to SQL Server on an Azure virtual machine (VM) from an indexer on Azure Search.
services: search
documentationcenter: ''
author: HeidiSteen
manager: pablocas
editor: ''
ms.assetid: 46e42e0e-c8de-4fec-b11a-ed132db7e7bc
ms.service: search
ms.devlang: rest-api
ms.workload: search
ms.topic: article
ms.tgt_pltfrm: na
ms.date: 01/23/2017
ms.author: heidist
ms.openlocfilehash: be73e3d009cfcbdd585d81512afaed752ae07364
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44540866"
---
# <a name="configure-a-connection-from-an-azure-search-indexer-to-sql-server-on-an-azure-vm"></a><span data-ttu-id="106ab-103">Configure a connection from an Azure Search indexer to SQL Server on an Azure VM</span><span class="sxs-lookup"><span data-stu-id="106ab-103">Configure a connection from an Azure Search indexer to SQL Server on an Azure VM</span></span>
<span data-ttu-id="106ab-104">As noted in [Connecting Azure SQL Database to Azure Search using indexers](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md#frequently-asked-questions), creating indexers against **SQL Server on Azure VMs** (or **SQL Azure VMs** for short) is supported by Azure Search, but there are a few security-related prerequisites to take care of first.</span><span class="sxs-lookup"><span data-stu-id="106ab-104">As noted in [Connecting Azure SQL Database to Azure Search using indexers](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md#frequently-asked-questions), creating indexers against **SQL Server on Azure VMs** (or **SQL Azure VMs** for short) is supported by Azure Search, but there are a few security-related prerequisites to take care of first.</span></span> 

<span data-ttu-id="106ab-105">**Task Duration:** About 30 minutes, assuming you already installed a certificate on the VM.</span><span class="sxs-lookup"><span data-stu-id="106ab-105">**Task Duration:** About 30 minutes, assuming you already installed a certificate on the VM.</span></span>

## <a name="enable-encrypted-connections"></a><span data-ttu-id="106ab-106">Enable encrypted connections</span><span class="sxs-lookup"><span data-stu-id="106ab-106">Enable encrypted connections</span></span>
<span data-ttu-id="106ab-107">Azure Search requires an encrypted channel for all indexer requests over a public internet connection.</span><span class="sxs-lookup"><span data-stu-id="106ab-107">Azure Search requires an encrypted channel for all indexer requests over a public internet connection.</span></span> <span data-ttu-id="106ab-108">This section lists the steps to make this work.</span><span class="sxs-lookup"><span data-stu-id="106ab-108">This section lists the steps to make this work.</span></span>

1. <span data-ttu-id="106ab-109">Check the properties of the certificate to verify the subject name is the fully qualified domain name (FQDN) of the Azure VM.</span><span class="sxs-lookup"><span data-stu-id="106ab-109">Check the properties of the certificate to verify the subject name is the fully qualified domain name (FQDN) of the Azure VM.</span></span> <span data-ttu-id="106ab-110">You can use a tool like CertUtils or the Certificates snap-in to view the properties.</span><span class="sxs-lookup"><span data-stu-id="106ab-110">You can use a tool like CertUtils or the Certificates snap-in to view the properties.</span></span> <span data-ttu-id="106ab-111">You can get the FQDN from the VM service blade's Essentials section, in the **Public IP address/DNS name label** field, in the [Azure portal](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="106ab-111">You can get the FQDN from the VM service blade's Essentials section, in the **Public IP address/DNS name label** field, in the [Azure portal](https://portal.azure.com/).</span></span>
   
   * <span data-ttu-id="106ab-112">For VMs created using the newer **Resource Manager** template, the FQDN is formatted as `<your-VM-name>.<region>.cloudapp.azure.com`.</span><span class="sxs-lookup"><span data-stu-id="106ab-112">For VMs created using the newer **Resource Manager** template, the FQDN is formatted as `<your-VM-name>.<region>.cloudapp.azure.com`.</span></span> 
   * <span data-ttu-id="106ab-113">For older VMs created as a **Classic** VM, the FQDN is formatted as `<your-cloud-service-name.cloudapp.net>`.</span><span class="sxs-lookup"><span data-stu-id="106ab-113">For older VMs created as a **Classic** VM, the FQDN is formatted as `<your-cloud-service-name.cloudapp.net>`.</span></span> 
2. <span data-ttu-id="106ab-114">Configure SQL Server to use the certificate using the Registry Editor (regedit).</span><span class="sxs-lookup"><span data-stu-id="106ab-114">Configure SQL Server to use the certificate using the Registry Editor (regedit).</span></span> 
   
    <span data-ttu-id="106ab-115">Although SQL Server Configuration Manager is often used for this task, you can't use it for this scenario.</span><span class="sxs-lookup"><span data-stu-id="106ab-115">Although SQL Server Configuration Manager is often used for this task, you can't use it for this scenario.</span></span> <span data-ttu-id="106ab-116">It won't find the imported certificate because the FQDN of the VM on Azure doesn't match the FQDN as determined by the VM (it identifies the domain as either the local computer or the network domain to which it is joined).</span><span class="sxs-lookup"><span data-stu-id="106ab-116">It won't find the imported certificate because the FQDN of the VM on Azure doesn't match the FQDN as determined by the VM (it identifies the domain as either the local computer or the network domain to which it is joined).</span></span> <span data-ttu-id="106ab-117">When names don't match, use regedit to specify the certificate.</span><span class="sxs-lookup"><span data-stu-id="106ab-117">When names don't match, use regedit to specify the certificate.</span></span>
   
   * <span data-ttu-id="106ab-118">In regedit, browse to this registry key: `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft SQL Server\[MSSQL13.MSSQLSERVER]\MSSQLServer\SuperSocketNetLib\Certificate`.</span><span class="sxs-lookup"><span data-stu-id="106ab-118">In regedit, browse to this registry key: `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft SQL Server\[MSSQL13.MSSQLSERVER]\MSSQLServer\SuperSocketNetLib\Certificate`.</span></span>
     
     <span data-ttu-id="106ab-119">The `[MSSQL13.MSSQLSERVER]` part varies based on version and instance name.</span><span class="sxs-lookup"><span data-stu-id="106ab-119">The `[MSSQL13.MSSQLSERVER]` part varies based on version and instance name.</span></span> 
   * <span data-ttu-id="106ab-120">Set the value of the **Certificate** key to the **thumbprint** of the SSL certificate you imported to the VM.</span><span class="sxs-lookup"><span data-stu-id="106ab-120">Set the value of the **Certificate** key to the **thumbprint** of the SSL certificate you imported to the VM.</span></span>
     
     <span data-ttu-id="106ab-121">There are several ways to get the thumbprint, some better than others.</span><span class="sxs-lookup"><span data-stu-id="106ab-121">There are several ways to get the thumbprint, some better than others.</span></span> <span data-ttu-id="106ab-122">If you copy it from the **Certificates** snap-in in MMC, you will probably pick up an invisible leading character [as described in this support article](https://support.microsoft.com/kb/2023869/), which results in an error when you attempt a connection.</span><span class="sxs-lookup"><span data-stu-id="106ab-122">If you copy it from the **Certificates** snap-in in MMC, you will probably pick up an invisible leading character [as described in this support article](https://support.microsoft.com/kb/2023869/), which results in an error when you attempt a connection.</span></span> <span data-ttu-id="106ab-123">Several workarounds exist for correcting this problem.</span><span class="sxs-lookup"><span data-stu-id="106ab-123">Several workarounds exist for correcting this problem.</span></span> <span data-ttu-id="106ab-124">The easiest is to backspace over and then retype the first character of the thumbprint to remove the leading character in the key value field in regedit.</span><span class="sxs-lookup"><span data-stu-id="106ab-124">The easiest is to backspace over and then retype the first character of the thumbprint to remove the leading character in the key value field in regedit.</span></span> <span data-ttu-id="106ab-125">Alternatively, you can use a different tool to copy the thumbprint.</span><span class="sxs-lookup"><span data-stu-id="106ab-125">Alternatively, you can use a different tool to copy the thumbprint.</span></span>
3. <span data-ttu-id="106ab-126">Grant permissions to the service account.</span><span class="sxs-lookup"><span data-stu-id="106ab-126">Grant permissions to the service account.</span></span> 
   
    <span data-ttu-id="106ab-127">Make sure the SQL Server service account is granted appropriate permission on the private key of the SSL certificate.</span><span class="sxs-lookup"><span data-stu-id="106ab-127">Make sure the SQL Server service account is granted appropriate permission on the private key of the SSL certificate.</span></span> <span data-ttu-id="106ab-128">If you overlook this step, SQL Server will not start.</span><span class="sxs-lookup"><span data-stu-id="106ab-128">If you overlook this step, SQL Server will not start.</span></span> <span data-ttu-id="106ab-129">You can use the **Certificates** snap-in or **CertUtils** for this task.</span><span class="sxs-lookup"><span data-stu-id="106ab-129">You can use the **Certificates** snap-in or **CertUtils** for this task.</span></span>
4. <span data-ttu-id="106ab-130">Restart the SQL Server service.</span><span class="sxs-lookup"><span data-stu-id="106ab-130">Restart the SQL Server service.</span></span>

## <a name="configure-sql-server-connectivity-in-the-vm"></a><span data-ttu-id="106ab-131">Configure SQL Server connectivity in the VM</span><span class="sxs-lookup"><span data-stu-id="106ab-131">Configure SQL Server connectivity in the VM</span></span>
<span data-ttu-id="106ab-132">After you set up the encrypted connection required by Azure Search, there are additional configuration steps intrinsic to SQL Server on Azure VMs.</span><span class="sxs-lookup"><span data-stu-id="106ab-132">After you set up the encrypted connection required by Azure Search, there are additional configuration steps intrinsic to SQL Server on Azure VMs.</span></span> <span data-ttu-id="106ab-133">If you haven't done so already , the next step is to finish configuration using either one of these articles:</span><span class="sxs-lookup"><span data-stu-id="106ab-133">If you haven't done so already , the next step is to finish configuration using either one of these articles:</span></span>

* <span data-ttu-id="106ab-134">For a **Resource Manager** VM, see [Connect to a SQL Server Virtual Machine on Azure using Resource Manager](../virtual-machines/windows/sql/virtual-machines-windows-sql-connect.md).</span><span class="sxs-lookup"><span data-stu-id="106ab-134">For a **Resource Manager** VM, see [Connect to a SQL Server Virtual Machine on Azure using Resource Manager](../virtual-machines/windows/sql/virtual-machines-windows-sql-connect.md).</span></span> 
* <span data-ttu-id="106ab-135">For a **Classic** VM, see [Connect to a SQL Server Virtual Machine on Azure Classic](../virtual-machines/windows/classic/sql-connect.md).</span><span class="sxs-lookup"><span data-stu-id="106ab-135">For a **Classic** VM, see [Connect to a SQL Server Virtual Machine on Azure Classic](../virtual-machines/windows/classic/sql-connect.md).</span></span>

<span data-ttu-id="106ab-136">In particular, review the section in each article for "connecting over the internet".</span><span class="sxs-lookup"><span data-stu-id="106ab-136">In particular, review the section in each article for "connecting over the internet".</span></span>

## <a name="configure-the-network-security-group-nsg"></a><span data-ttu-id="106ab-137">Configure the Network Security Group (NSG)</span><span class="sxs-lookup"><span data-stu-id="106ab-137">Configure the Network Security Group (NSG)</span></span>
<span data-ttu-id="106ab-138">It is not unusual to configure the NSG and corresponding Azure endpoint or Access Control List (ACL) to make your Azure VM accessible to other parties.</span><span class="sxs-lookup"><span data-stu-id="106ab-138">It is not unusual to configure the NSG and corresponding Azure endpoint or Access Control List (ACL) to make your Azure VM accessible to other parties.</span></span> <span data-ttu-id="106ab-139">Chances are you've done this before to allow your own application logic to connect to your SQL Azure VM.</span><span class="sxs-lookup"><span data-stu-id="106ab-139">Chances are you've done this before to allow your own application logic to connect to your SQL Azure VM.</span></span> <span data-ttu-id="106ab-140">It's no different for an Azure Search connection to your SQL Azure VM.</span><span class="sxs-lookup"><span data-stu-id="106ab-140">It's no different for an Azure Search connection to your SQL Azure VM.</span></span> 

<span data-ttu-id="106ab-141">The links below provide instructions on NSG configuration for VM deployments.</span><span class="sxs-lookup"><span data-stu-id="106ab-141">The links below provide instructions on NSG configuration for VM deployments.</span></span> <span data-ttu-id="106ab-142">Use these instructions to ACL an Azure SEarch endpoint based on its IP address.</span><span class="sxs-lookup"><span data-stu-id="106ab-142">Use these instructions to ACL an Azure SEarch endpoint based on its IP address.</span></span>

> [!NOTE]
> <span data-ttu-id="106ab-143">For background, see [What is a Network Security Group?](../virtual-network/virtual-networks-nsg.md)</span><span class="sxs-lookup"><span data-stu-id="106ab-143">For background, see [What is a Network Security Group?](../virtual-network/virtual-networks-nsg.md)</span></span>
> 
> 

* <span data-ttu-id="106ab-144">For a **Resource Manager** VM, see [How to create NSGs for ARM deployments](../virtual-network/virtual-networks-create-nsg-arm-pportal.md).</span><span class="sxs-lookup"><span data-stu-id="106ab-144">For a **Resource Manager** VM, see [How to create NSGs for ARM deployments](../virtual-network/virtual-networks-create-nsg-arm-pportal.md).</span></span> 
* <span data-ttu-id="106ab-145">For a **Classic** VM, see [How to create NSGs for Classic deployments](../virtual-network/virtual-networks-create-nsg-classic-ps.md).</span><span class="sxs-lookup"><span data-stu-id="106ab-145">For a **Classic** VM, see [How to create NSGs for Classic deployments](../virtual-network/virtual-networks-create-nsg-classic-ps.md).</span></span>

<span data-ttu-id="106ab-146">IP addressing can pose a few challenges that are easily overcome if you are aware of the issue and potential workarounds.</span><span class="sxs-lookup"><span data-stu-id="106ab-146">IP addressing can pose a few challenges that are easily overcome if you are aware of the issue and potential workarounds.</span></span> <span data-ttu-id="106ab-147">The remaining sections provide recommendations for handling issues related to IP addresses in the ACL.</span><span class="sxs-lookup"><span data-stu-id="106ab-147">The remaining sections provide recommendations for handling issues related to IP addresses in the ACL.</span></span>

#### <a name="restrict-access-to-the-search-service-ip-address"></a><span data-ttu-id="106ab-148">Restrict access to the search service IP address</span><span class="sxs-lookup"><span data-stu-id="106ab-148">Restrict access to the search service IP address</span></span>
<span data-ttu-id="106ab-149">We strongly recommend that you restrict the access to the IP address of your search service in the ACL instead of making your SQL Azure VMs wide open to any connection requests.</span><span class="sxs-lookup"><span data-stu-id="106ab-149">We strongly recommend that you restrict the access to the IP address of your search service in the ACL instead of making your SQL Azure VMs wide open to any connection requests.</span></span> <span data-ttu-id="106ab-150">You can easily find out the IP address by pinging the FQDN (for example, `<your-search-service-name>.search.windows.net`) of your search service.</span><span class="sxs-lookup"><span data-stu-id="106ab-150">You can easily find out the IP address by pinging the FQDN (for example, `<your-search-service-name>.search.windows.net`) of your search service.</span></span>

#### <a name="managing-ip-address-fluctuations"></a><span data-ttu-id="106ab-151">Managing IP address fluctuations</span><span class="sxs-lookup"><span data-stu-id="106ab-151">Managing IP address fluctuations</span></span>
<span data-ttu-id="106ab-152">If your search service has only one search unit (that is, one replica and one partition), the IP address will change during routine service restarts, invalidating an existing ACL with your search service's IP address.</span><span class="sxs-lookup"><span data-stu-id="106ab-152">If your search service has only one search unit (that is, one replica and one partition), the IP address will change during routine service restarts, invalidating an existing ACL with your search service's IP address.</span></span>

<span data-ttu-id="106ab-153">One way to avoid the subsequent connectivity error is to use more than one replica and one partition in Azure Search.</span><span class="sxs-lookup"><span data-stu-id="106ab-153">One way to avoid the subsequent connectivity error is to use more than one replica and one partition in Azure Search.</span></span> <span data-ttu-id="106ab-154">Doing so increases the cost, but it also solves the IP address problem.</span><span class="sxs-lookup"><span data-stu-id="106ab-154">Doing so increases the cost, but it also solves the IP address problem.</span></span> <span data-ttu-id="106ab-155">In Azure Search, IP addresses don't change when you have more than one search unit.</span><span class="sxs-lookup"><span data-stu-id="106ab-155">In Azure Search, IP addresses don't change when you have more than one search unit.</span></span>

<span data-ttu-id="106ab-156">A second approach is to allow the connection to fail, and then reconfigure the ACLs in the NSG.</span><span class="sxs-lookup"><span data-stu-id="106ab-156">A second approach is to allow the connection to fail, and then reconfigure the ACLs in the NSG.</span></span> <span data-ttu-id="106ab-157">On average, you can expect IP addresses to change every few weeks.</span><span class="sxs-lookup"><span data-stu-id="106ab-157">On average, you can expect IP addresses to change every few weeks.</span></span> <span data-ttu-id="106ab-158">For customers who do controlled indexing on an infrequent basis, this approach might be viable.</span><span class="sxs-lookup"><span data-stu-id="106ab-158">For customers who do controlled indexing on an infrequent basis, this approach might be viable.</span></span>

<span data-ttu-id="106ab-159">A third viable (but not particularly secure) approach is to specify the IP address range of the Azure region where your search service is provisioned.</span><span class="sxs-lookup"><span data-stu-id="106ab-159">A third viable (but not particularly secure) approach is to specify the IP address range of the Azure region where your search service is provisioned.</span></span> <span data-ttu-id="106ab-160">The list of IP ranges from which public IP addresses are allocated to Azure resources is published at [Azure Datacenter IP ranges](https://www.microsoft.com/download/details.aspx?id=41653).</span><span class="sxs-lookup"><span data-stu-id="106ab-160">The list of IP ranges from which public IP addresses are allocated to Azure resources is published at [Azure Datacenter IP ranges](https://www.microsoft.com/download/details.aspx?id=41653).</span></span> 

#### <a name="include-the-azure-search-portal-ip-addresses"></a><span data-ttu-id="106ab-161">Include the Azure Search portal IP addresses</span><span class="sxs-lookup"><span data-stu-id="106ab-161">Include the Azure Search portal IP addresses</span></span>
<span data-ttu-id="106ab-162">If you are using the Azure portal to create an indexer, Azure Search portal logic also needs access to your SQL Azure VM during creation time.</span><span class="sxs-lookup"><span data-stu-id="106ab-162">If you are using the Azure portal to create an indexer, Azure Search portal logic also needs access to your SQL Azure VM during creation time.</span></span> <span data-ttu-id="106ab-163">Azure search portal IP addresses can be found by pinging `stamp2.search.ext.azure.com`.</span><span class="sxs-lookup"><span data-stu-id="106ab-163">Azure search portal IP addresses can be found by pinging `stamp2.search.ext.azure.com`.</span></span>

## <a name="next-steps"></a><span data-ttu-id="106ab-164">Next steps</span><span class="sxs-lookup"><span data-stu-id="106ab-164">Next steps</span></span>
<span data-ttu-id="106ab-165">With configuration out of the way, you can now specify a SQL Server on Azure VM as the data source for an Azure Search indexer.</span><span class="sxs-lookup"><span data-stu-id="106ab-165">With configuration out of the way, you can now specify a SQL Server on Azure VM as the data source for an Azure Search indexer.</span></span> <span data-ttu-id="106ab-166">See [Connecting Azure SQL Database to Azure Search using indexers](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md) for more information.</span><span class="sxs-lookup"><span data-stu-id="106ab-166">See [Connecting Azure SQL Database to Azure Search using indexers](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md) for more information.</span></span>

