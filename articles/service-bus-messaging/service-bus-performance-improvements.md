---
title: Best practices for improving performance using Azure Service Bus | Microsoft Docs
description: Describes how to use Service Bus to optimize performance when exchanging brokered messages.
services: service-bus-messaging
documentationcenter: na
author: sethmanheim
manager: timlt
editor: ''
ms.assetid: e756c15d-31fc-45c0-8df4-0bca0da10bb2
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 02/02/2017
ms.author: sethm
ms.openlocfilehash: d077099a9fdc50cf78157bcb7f28d1d28583bea1
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44553507"
---
# <a name="best-practices-for-performance-improvements-using-service-bus-messaging"></a><span data-ttu-id="1bde6-103">Best Practices for performance improvements using Service Bus Messaging</span><span class="sxs-lookup"><span data-stu-id="1bde6-103">Best Practices for performance improvements using Service Bus Messaging</span></span>
<span data-ttu-id="1bde6-104">This article describes how to use [Azure Service Bus Messaging](https://azure.microsoft.com/services/service-bus/) to optimize performance when exchanging brokered messages.</span><span class="sxs-lookup"><span data-stu-id="1bde6-104">This article describes how to use [Azure Service Bus Messaging](https://azure.microsoft.com/services/service-bus/) to optimize performance when exchanging brokered messages.</span></span> <span data-ttu-id="1bde6-105">The first part of this topic describes the different mechanisms that are offered to help increase performance.</span><span class="sxs-lookup"><span data-stu-id="1bde6-105">The first part of this topic describes the different mechanisms that are offered to help increase performance.</span></span> <span data-ttu-id="1bde6-106">The second part provides guidance on how to use Service Bus in a way that can offer the best performance in a given scenario.</span><span class="sxs-lookup"><span data-stu-id="1bde6-106">The second part provides guidance on how to use Service Bus in a way that can offer the best performance in a given scenario.</span></span>

<span data-ttu-id="1bde6-107">Throughout this topic, the term "client" refers to any entity that accesses Service Bus.</span><span class="sxs-lookup"><span data-stu-id="1bde6-107">Throughout this topic, the term "client" refers to any entity that accesses Service Bus.</span></span> <span data-ttu-id="1bde6-108">A client can take the role of a sender or a receiver.</span><span class="sxs-lookup"><span data-stu-id="1bde6-108">A client can take the role of a sender or a receiver.</span></span> <span data-ttu-id="1bde6-109">The term "sender" is used for a Service Bus queue or topic client that sends messages to a Service Bus queue or topic.</span><span class="sxs-lookup"><span data-stu-id="1bde6-109">The term "sender" is used for a Service Bus queue or topic client that sends messages to a Service Bus queue or topic.</span></span> <span data-ttu-id="1bde6-110">The term "receiver" refers to a Service Bus queue or subscription client that receives messages from a Service Bus queue or subscription.</span><span class="sxs-lookup"><span data-stu-id="1bde6-110">The term "receiver" refers to a Service Bus queue or subscription client that receives messages from a Service Bus queue or subscription.</span></span>

<span data-ttu-id="1bde6-111">These sections introduce several concepts that Service Bus uses to help boost performance.</span><span class="sxs-lookup"><span data-stu-id="1bde6-111">These sections introduce several concepts that Service Bus uses to help boost performance.</span></span>

## <a name="protocols"></a><span data-ttu-id="1bde6-112">Protocols</span><span class="sxs-lookup"><span data-stu-id="1bde6-112">Protocols</span></span>
<span data-ttu-id="1bde6-113">Service Bus enables clients to send and receive messages via one of three protocols:</span><span class="sxs-lookup"><span data-stu-id="1bde6-113">Service Bus enables clients to send and receive messages via one of three protocols:</span></span>

1. <span data-ttu-id="1bde6-114">Advanced Message Queuing Protocol (AMQP)</span><span class="sxs-lookup"><span data-stu-id="1bde6-114">Advanced Message Queuing Protocol (AMQP)</span></span>
2. <span data-ttu-id="1bde6-115">Service Bus Messaging Protocol (SBMP)</span><span class="sxs-lookup"><span data-stu-id="1bde6-115">Service Bus Messaging Protocol (SBMP)</span></span>
3. <span data-ttu-id="1bde6-116">HTTP</span><span class="sxs-lookup"><span data-stu-id="1bde6-116">HTTP</span></span>

<span data-ttu-id="1bde6-117">AMQP and SBMP are more efficient, because they maintain the connection to Service Bus as long as the messaging factory exists.</span><span class="sxs-lookup"><span data-stu-id="1bde6-117">AMQP and SBMP are more efficient, because they maintain the connection to Service Bus as long as the messaging factory exists.</span></span> <span data-ttu-id="1bde6-118">It also implements batching and prefetching.</span><span class="sxs-lookup"><span data-stu-id="1bde6-118">It also implements batching and prefetching.</span></span> <span data-ttu-id="1bde6-119">Unless explicitly mentioned, all content in this topic assumes the use of AMQP or SBMP.</span><span class="sxs-lookup"><span data-stu-id="1bde6-119">Unless explicitly mentioned, all content in this topic assumes the use of AMQP or SBMP.</span></span>

## <a name="reusing-factories-and-clients"></a><span data-ttu-id="1bde6-120">Reusing factories and clients</span><span class="sxs-lookup"><span data-stu-id="1bde6-120">Reusing factories and clients</span></span>
<span data-ttu-id="1bde6-121">Service Bus client objects, such as [QueueClient][QueueClient] or [MessageSender][MessageSender], are created through a [MessagingFactory][MessagingFactory] object, which also provides internal management of connections.</span><span class="sxs-lookup"><span data-stu-id="1bde6-121">Service Bus client objects, such as [QueueClient][QueueClient] or [MessageSender][MessageSender], are created through a [MessagingFactory][MessagingFactory] object, which also provides internal management of connections.</span></span> <span data-ttu-id="1bde6-122">You should not close messaging factories or queue, topic, and subscription clients after you send a message, and then re-create them when you send the next message.</span><span class="sxs-lookup"><span data-stu-id="1bde6-122">You should not close messaging factories or queue, topic, and subscription clients after you send a message, and then re-create them when you send the next message.</span></span> <span data-ttu-id="1bde6-123">Closing a messaging factory deletes the connection to the Service Bus service, and a new connection is established when recreating the factory.</span><span class="sxs-lookup"><span data-stu-id="1bde6-123">Closing a messaging factory deletes the connection to the Service Bus service, and a new connection is established when recreating the factory.</span></span> <span data-ttu-id="1bde6-124">Establishing a connection is an expensive operation that you can avoid by re-using the same factory and client objects for multiple operations.</span><span class="sxs-lookup"><span data-stu-id="1bde6-124">Establishing a connection is an expensive operation that you can avoid by re-using the same factory and client objects for multiple operations.</span></span> <span data-ttu-id="1bde6-125">You can safely use the [QueueClient][QueueClient] object for sending messages from concurrent asynchronous operations and multiple threads.</span><span class="sxs-lookup"><span data-stu-id="1bde6-125">You can safely use the [QueueClient][QueueClient] object for sending messages from concurrent asynchronous operations and multiple threads.</span></span> 

## <a name="concurrent-operations"></a><span data-ttu-id="1bde6-126">Concurrent operations</span><span class="sxs-lookup"><span data-stu-id="1bde6-126">Concurrent operations</span></span>
<span data-ttu-id="1bde6-127">Performing an operation (send, receive, delete, etc.) takes some time.</span><span class="sxs-lookup"><span data-stu-id="1bde6-127">Performing an operation (send, receive, delete, etc.) takes some time.</span></span> <span data-ttu-id="1bde6-128">This time includes the processing of the operation by the Service Bus service in addition to the latency of the request and the reply.</span><span class="sxs-lookup"><span data-stu-id="1bde6-128">This time includes the processing of the operation by the Service Bus service in addition to the latency of the request and the reply.</span></span> <span data-ttu-id="1bde6-129">To increase the number of operations per time, operations must execute concurrently.</span><span class="sxs-lookup"><span data-stu-id="1bde6-129">To increase the number of operations per time, operations must execute concurrently.</span></span> <span data-ttu-id="1bde6-130">You can do this in several different ways:</span><span class="sxs-lookup"><span data-stu-id="1bde6-130">You can do this in several different ways:</span></span>

* <span data-ttu-id="1bde6-131">**Asynchronous operations**: the client schedules operations by performing asynchronous operations.</span><span class="sxs-lookup"><span data-stu-id="1bde6-131">**Asynchronous operations**: the client schedules operations by performing asynchronous operations.</span></span> <span data-ttu-id="1bde6-132">The next request is started before the previous request is completed.</span><span class="sxs-lookup"><span data-stu-id="1bde6-132">The next request is started before the previous request is completed.</span></span> <span data-ttu-id="1bde6-133">The following is an example of an asynchronous send operation:</span><span class="sxs-lookup"><span data-stu-id="1bde6-133">The following is an example of an asynchronous send operation:</span></span>
  
 ```csharp
  BrokeredMessage m1 = new BrokeredMessage(body);
  BrokeredMessage m2 = new BrokeredMessage(body);
  
  Task send1 = queueClient.SendAsync(m1).ContinueWith((t) => 
    {
      Console.WriteLine("Sent message #1");
    });
  Task send2 = queueClient.SendAsync(m2).ContinueWith((t) => 
    {
      Console.WriteLine("Sent message #2");
    });
  Task.WaitAll(send1, send2);
  Console.WriteLine("All messages sent");
  ```
  
  <span data-ttu-id="1bde6-134">This is an example of an asynchronous receive operation:</span><span class="sxs-lookup"><span data-stu-id="1bde6-134">This is an example of an asynchronous receive operation:</span></span>
  
  ```csharp
  Task receive1 = queueClient.ReceiveAsync().ContinueWith(ProcessReceivedMessage);
  Task receive2 = queueClient.ReceiveAsync().ContinueWith(ProcessReceivedMessage);
  
  Task.WaitAll(receive1, receive2);
  Console.WriteLine("All messages received");
  
  async void ProcessReceivedMessage(Task<BrokeredMessage> t)
  {
    BrokeredMessage m = t.Result;
    Console.WriteLine("{0} received", m.Label);
    await m.CompleteAsync();
    Console.WriteLine("{0} complete", m.Label);
  }
  ```
* <span data-ttu-id="1bde6-135">**Multiple factories**: all clients (senders in addition to receivers) that are created by the same factory share one TCP connection.</span><span class="sxs-lookup"><span data-stu-id="1bde6-135">**Multiple factories**: all clients (senders in addition to receivers) that are created by the same factory share one TCP connection.</span></span> <span data-ttu-id="1bde6-136">The maximum message throughput is limited by the number of operations that can go through this TCP connection.</span><span class="sxs-lookup"><span data-stu-id="1bde6-136">The maximum message throughput is limited by the number of operations that can go through this TCP connection.</span></span> <span data-ttu-id="1bde6-137">The throughput that can be obtained with a single factory varies greatly with TCP round-trip times and message size.</span><span class="sxs-lookup"><span data-stu-id="1bde6-137">The throughput that can be obtained with a single factory varies greatly with TCP round-trip times and message size.</span></span> <span data-ttu-id="1bde6-138">To obtain higher throughput rates, you should use multiple messaging factories.</span><span class="sxs-lookup"><span data-stu-id="1bde6-138">To obtain higher throughput rates, you should use multiple messaging factories.</span></span>

## <a name="receive-mode"></a><span data-ttu-id="1bde6-139">Receive mode</span><span class="sxs-lookup"><span data-stu-id="1bde6-139">Receive mode</span></span>
<span data-ttu-id="1bde6-140">When creating a queue or subscription client, you can specify a receive mode: *Peek-lock* or *Receive and Delete*.</span><span class="sxs-lookup"><span data-stu-id="1bde6-140">When creating a queue or subscription client, you can specify a receive mode: *Peek-lock* or *Receive and Delete*.</span></span> <span data-ttu-id="1bde6-141">The default receive mode is [PeekLock][PeekLock].</span><span class="sxs-lookup"><span data-stu-id="1bde6-141">The default receive mode is [PeekLock][PeekLock].</span></span> <span data-ttu-id="1bde6-142">When operating in this mode, the client sends a request to receive a message from Service Bus.</span><span class="sxs-lookup"><span data-stu-id="1bde6-142">When operating in this mode, the client sends a request to receive a message from Service Bus.</span></span> <span data-ttu-id="1bde6-143">After the client has received the message, it sends a request to complete the message.</span><span class="sxs-lookup"><span data-stu-id="1bde6-143">After the client has received the message, it sends a request to complete the message.</span></span>

<span data-ttu-id="1bde6-144">When setting the receive mode to [ReceiveAndDelete][ReceiveAndDelete], both steps are combined in a single request.</span><span class="sxs-lookup"><span data-stu-id="1bde6-144">When setting the receive mode to [ReceiveAndDelete][ReceiveAndDelete], both steps are combined in a single request.</span></span> <span data-ttu-id="1bde6-145">This reduces the overall number of operations, and can improve the overall message throughput.</span><span class="sxs-lookup"><span data-stu-id="1bde6-145">This reduces the overall number of operations, and can improve the overall message throughput.</span></span> <span data-ttu-id="1bde6-146">This performance gain comes at the risk of losing messages.</span><span class="sxs-lookup"><span data-stu-id="1bde6-146">This performance gain comes at the risk of losing messages.</span></span>

<span data-ttu-id="1bde6-147">Service Bus does not support transactions for receive-and-delete operations.</span><span class="sxs-lookup"><span data-stu-id="1bde6-147">Service Bus does not support transactions for receive-and-delete operations.</span></span> <span data-ttu-id="1bde6-148">In addition, peek-lock semantics are required for any scenarios in which the client wants to defer or [dead-letter](service-bus-dead-letter-queues.md) a message.</span><span class="sxs-lookup"><span data-stu-id="1bde6-148">In addition, peek-lock semantics are required for any scenarios in which the client wants to defer or [dead-letter](service-bus-dead-letter-queues.md) a message.</span></span>

## <a name="client-side-batching"></a><span data-ttu-id="1bde6-149">Client-side batching</span><span class="sxs-lookup"><span data-stu-id="1bde6-149">Client-side batching</span></span>
<span data-ttu-id="1bde6-150">Client-side batching enables a queue or topic client to delay the sending of a message for a certain period of time.</span><span class="sxs-lookup"><span data-stu-id="1bde6-150">Client-side batching enables a queue or topic client to delay the sending of a message for a certain period of time.</span></span> <span data-ttu-id="1bde6-151">If the client sends additional messages during this time period, it transmits the messages in a single batch.</span><span class="sxs-lookup"><span data-stu-id="1bde6-151">If the client sends additional messages during this time period, it transmits the messages in a single batch.</span></span> <span data-ttu-id="1bde6-152">Client-side batching also causes a queue or subscription client to batch multiple **Complete** requests into a single request.</span><span class="sxs-lookup"><span data-stu-id="1bde6-152">Client-side batching also causes a queue or subscription client to batch multiple **Complete** requests into a single request.</span></span> <span data-ttu-id="1bde6-153">Batching is only available for asynchronous **Send** and **Complete** operations.</span><span class="sxs-lookup"><span data-stu-id="1bde6-153">Batching is only available for asynchronous **Send** and **Complete** operations.</span></span> <span data-ttu-id="1bde6-154">Synchronous operations are immediately sent to the Service Bus service.</span><span class="sxs-lookup"><span data-stu-id="1bde6-154">Synchronous operations are immediately sent to the Service Bus service.</span></span> <span data-ttu-id="1bde6-155">Batching does not occur for peek or receive operations, nor does batching occur across clients.</span><span class="sxs-lookup"><span data-stu-id="1bde6-155">Batching does not occur for peek or receive operations, nor does batching occur across clients.</span></span>

<span data-ttu-id="1bde6-156">By default, a client uses a batch interval of 20ms.</span><span class="sxs-lookup"><span data-stu-id="1bde6-156">By default, a client uses a batch interval of 20ms.</span></span> <span data-ttu-id="1bde6-157">You can change the batch interval by setting the [BatchFlushInterval][BatchFlushInterval] property before creating the messaging factory.</span><span class="sxs-lookup"><span data-stu-id="1bde6-157">You can change the batch interval by setting the [BatchFlushInterval][BatchFlushInterval] property before creating the messaging factory.</span></span> <span data-ttu-id="1bde6-158">This setting affects all clients that are created by this factory.</span><span class="sxs-lookup"><span data-stu-id="1bde6-158">This setting affects all clients that are created by this factory.</span></span>

<span data-ttu-id="1bde6-159">To disable batching, set the [BatchFlushInterval][BatchFlushInterval] property to **TimeSpan.Zero**.</span><span class="sxs-lookup"><span data-stu-id="1bde6-159">To disable batching, set the [BatchFlushInterval][BatchFlushInterval] property to **TimeSpan.Zero**.</span></span> <span data-ttu-id="1bde6-160">For example:</span><span class="sxs-lookup"><span data-stu-id="1bde6-160">For example:</span></span>

```csharp
MessagingFactorySettings mfs = new MessagingFactorySettings();
mfs.TokenProvider = tokenProvider;
mfs.NetMessagingTransportSettings.BatchFlushInterval = TimeSpan.FromSeconds(0.05);
MessagingFactory messagingFactory = MessagingFactory.Create(namespaceUri, mfs);
```

<span data-ttu-id="1bde6-161">Batching does not affect the number of billable messaging operations, and is available only for the Service Bus client protocol.</span><span class="sxs-lookup"><span data-stu-id="1bde6-161">Batching does not affect the number of billable messaging operations, and is available only for the Service Bus client protocol.</span></span> <span data-ttu-id="1bde6-162">The HTTP protocol does not support batching.</span><span class="sxs-lookup"><span data-stu-id="1bde6-162">The HTTP protocol does not support batching.</span></span>

## <a name="batching-store-access"></a><span data-ttu-id="1bde6-163">Batching store access</span><span class="sxs-lookup"><span data-stu-id="1bde6-163">Batching store access</span></span>
<span data-ttu-id="1bde6-164">To increase the throughput of a queue, topic, or subscription, Service Bus batches multiple messages when it writes to its internal store.</span><span class="sxs-lookup"><span data-stu-id="1bde6-164">To increase the throughput of a queue, topic, or subscription, Service Bus batches multiple messages when it writes to its internal store.</span></span> <span data-ttu-id="1bde6-165">If enabled on a queue or topic, writing messages into the store will be batched.</span><span class="sxs-lookup"><span data-stu-id="1bde6-165">If enabled on a queue or topic, writing messages into the store will be batched.</span></span> <span data-ttu-id="1bde6-166">If enabled on a queue or subscription, deleting messages from the store will be batched.</span><span class="sxs-lookup"><span data-stu-id="1bde6-166">If enabled on a queue or subscription, deleting messages from the store will be batched.</span></span> <span data-ttu-id="1bde6-167">If batched store access is enabled for an entity, Service Bus delays a store write operation regarding that entity by up to 20ms.</span><span class="sxs-lookup"><span data-stu-id="1bde6-167">If batched store access is enabled for an entity, Service Bus delays a store write operation regarding that entity by up to 20ms.</span></span> <span data-ttu-id="1bde6-168">Additional store operations that occur during this interval are added to the batch.</span><span class="sxs-lookup"><span data-stu-id="1bde6-168">Additional store operations that occur during this interval are added to the batch.</span></span> <span data-ttu-id="1bde6-169">Batched store access only affects **Send** and **Complete** operations; receive operations are not affected.</span><span class="sxs-lookup"><span data-stu-id="1bde6-169">Batched store access only affects **Send** and **Complete** operations; receive operations are not affected.</span></span> <span data-ttu-id="1bde6-170">Batched store access is a property on an entity.</span><span class="sxs-lookup"><span data-stu-id="1bde6-170">Batched store access is a property on an entity.</span></span> <span data-ttu-id="1bde6-171">Batching occurs across all entities that enable batched store access.</span><span class="sxs-lookup"><span data-stu-id="1bde6-171">Batching occurs across all entities that enable batched store access.</span></span>

<span data-ttu-id="1bde6-172">When creating a new queue, topic or subscription, batched store access is enabled by default.</span><span class="sxs-lookup"><span data-stu-id="1bde6-172">When creating a new queue, topic or subscription, batched store access is enabled by default.</span></span> <span data-ttu-id="1bde6-173">To disable batched store access, set the [EnableBatchedOperations][EnableBatchedOperations] property to **false** before creating the entity.</span><span class="sxs-lookup"><span data-stu-id="1bde6-173">To disable batched store access, set the [EnableBatchedOperations][EnableBatchedOperations] property to **false** before creating the entity.</span></span> <span data-ttu-id="1bde6-174">For example:</span><span class="sxs-lookup"><span data-stu-id="1bde6-174">For example:</span></span>

```csharp
QueueDescription qd = new QueueDescription();
qd.EnableBatchedOperations = false;
Queue q = namespaceManager.CreateQueue(qd);
```

<span data-ttu-id="1bde6-175">Batched store access does not affect the number of billable messaging operations, and is a property of a queue, topic, or subscription.</span><span class="sxs-lookup"><span data-stu-id="1bde6-175">Batched store access does not affect the number of billable messaging operations, and is a property of a queue, topic, or subscription.</span></span> <span data-ttu-id="1bde6-176">It is independent of the receive mode and the protocol that is used between a client and the Service Bus service.</span><span class="sxs-lookup"><span data-stu-id="1bde6-176">It is independent of the receive mode and the protocol that is used between a client and the Service Bus service.</span></span>

## <a name="prefetching"></a><span data-ttu-id="1bde6-177">Prefetching</span><span class="sxs-lookup"><span data-stu-id="1bde6-177">Prefetching</span></span>
<span data-ttu-id="1bde6-178">Prefetching enables the queue or subscription client to load additional messages from the service when it performs a receive operation.</span><span class="sxs-lookup"><span data-stu-id="1bde6-178">Prefetching enables the queue or subscription client to load additional messages from the service when it performs a receive operation.</span></span> <span data-ttu-id="1bde6-179">The client stores these messages in a local cache.</span><span class="sxs-lookup"><span data-stu-id="1bde6-179">The client stores these messages in a local cache.</span></span> <span data-ttu-id="1bde6-180">The size of the cache is determined by the [QueueClient.PrefetchCount][QueueClient.PrefetchCount] or [SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount] properties.</span><span class="sxs-lookup"><span data-stu-id="1bde6-180">The size of the cache is determined by the [QueueClient.PrefetchCount][QueueClient.PrefetchCount] or [SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount] properties.</span></span> <span data-ttu-id="1bde6-181">Each client that enables prefetching maintains its own cache.</span><span class="sxs-lookup"><span data-stu-id="1bde6-181">Each client that enables prefetching maintains its own cache.</span></span> <span data-ttu-id="1bde6-182">A cache is not shared across clients.</span><span class="sxs-lookup"><span data-stu-id="1bde6-182">A cache is not shared across clients.</span></span> <span data-ttu-id="1bde6-183">If the client initiates a receive operation and its cache is empty, the service transmits a batch of messages.</span><span class="sxs-lookup"><span data-stu-id="1bde6-183">If the client initiates a receive operation and its cache is empty, the service transmits a batch of messages.</span></span> <span data-ttu-id="1bde6-184">The size of the batch equals the size of the cache or 256 KB, whichever is smaller.</span><span class="sxs-lookup"><span data-stu-id="1bde6-184">The size of the batch equals the size of the cache or 256 KB, whichever is smaller.</span></span> <span data-ttu-id="1bde6-185">If the client initiates a receive operation and the cache contains a message, the message is taken from the cache.</span><span class="sxs-lookup"><span data-stu-id="1bde6-185">If the client initiates a receive operation and the cache contains a message, the message is taken from the cache.</span></span>

<span data-ttu-id="1bde6-186">When a message is prefetched, the service locks the prefetched message.</span><span class="sxs-lookup"><span data-stu-id="1bde6-186">When a message is prefetched, the service locks the prefetched message.</span></span> <span data-ttu-id="1bde6-187">By doing this, the prefetched message cannot be received by a different receiver.</span><span class="sxs-lookup"><span data-stu-id="1bde6-187">By doing this, the prefetched message cannot be received by a different receiver.</span></span> <span data-ttu-id="1bde6-188">If the receiver cannot complete the message before the lock expires, the message becomes available to other receivers.</span><span class="sxs-lookup"><span data-stu-id="1bde6-188">If the receiver cannot complete the message before the lock expires, the message becomes available to other receivers.</span></span> <span data-ttu-id="1bde6-189">The prefetched copy of the message remains in the cache.</span><span class="sxs-lookup"><span data-stu-id="1bde6-189">The prefetched copy of the message remains in the cache.</span></span> <span data-ttu-id="1bde6-190">The receiver that consumes the expired cached copy will receive an exception when it tries to complete that message.</span><span class="sxs-lookup"><span data-stu-id="1bde6-190">The receiver that consumes the expired cached copy will receive an exception when it tries to complete that message.</span></span> <span data-ttu-id="1bde6-191">By default, the message lock expires after 60 seconds.</span><span class="sxs-lookup"><span data-stu-id="1bde6-191">By default, the message lock expires after 60 seconds.</span></span> <span data-ttu-id="1bde6-192">This value can be extended to 5 minutes.</span><span class="sxs-lookup"><span data-stu-id="1bde6-192">This value can be extended to 5 minutes.</span></span> <span data-ttu-id="1bde6-193">To prevent the consumption of expired messages, the cache size should always be smaller than the number of messages that can be consumed by a client within the lock time-out interval.</span><span class="sxs-lookup"><span data-stu-id="1bde6-193">To prevent the consumption of expired messages, the cache size should always be smaller than the number of messages that can be consumed by a client within the lock time-out interval.</span></span>

<span data-ttu-id="1bde6-194">When using the default lock expiration of 60 seconds, a good value for [SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount] is 20 times the maximum processing rates of all receivers of the factory.</span><span class="sxs-lookup"><span data-stu-id="1bde6-194">When using the default lock expiration of 60 seconds, a good value for [SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount] is 20 times the maximum processing rates of all receivers of the factory.</span></span> <span data-ttu-id="1bde6-195">For example, a factory creates 3 receivers, and each receiver can process up to 10 messages per second.</span><span class="sxs-lookup"><span data-stu-id="1bde6-195">For example, a factory creates 3 receivers, and each receiver can process up to 10 messages per second.</span></span> <span data-ttu-id="1bde6-196">The prefetch count should not exceed 20 X 3 X 10 = 600.</span><span class="sxs-lookup"><span data-stu-id="1bde6-196">The prefetch count should not exceed 20 X 3 X 10 = 600.</span></span> <span data-ttu-id="1bde6-197">By default, [QueueClient.PrefetchCount][QueueClient.PrefetchCount] is set to 0, which means that no additional messages are fetched from the service.</span><span class="sxs-lookup"><span data-stu-id="1bde6-197">By default, [QueueClient.PrefetchCount][QueueClient.PrefetchCount] is set to 0, which means that no additional messages are fetched from the service.</span></span>

<span data-ttu-id="1bde6-198">Prefetching messages increases the overall throughput for a queue or subscription because it reduces the overall number of message operations, or round trips.</span><span class="sxs-lookup"><span data-stu-id="1bde6-198">Prefetching messages increases the overall throughput for a queue or subscription because it reduces the overall number of message operations, or round trips.</span></span> <span data-ttu-id="1bde6-199">Fetching the first message, however, will take longer (due to the increased message size).</span><span class="sxs-lookup"><span data-stu-id="1bde6-199">Fetching the first message, however, will take longer (due to the increased message size).</span></span> <span data-ttu-id="1bde6-200">Receiving prefetched messages will be faster because these messages have already been downloaded by the client.</span><span class="sxs-lookup"><span data-stu-id="1bde6-200">Receiving prefetched messages will be faster because these messages have already been downloaded by the client.</span></span>

<span data-ttu-id="1bde6-201">The time-to-live (TTL) property of a message is checked by the server at the time the server sends the message to the client.</span><span class="sxs-lookup"><span data-stu-id="1bde6-201">The time-to-live (TTL) property of a message is checked by the server at the time the server sends the message to the client.</span></span> <span data-ttu-id="1bde6-202">The client does not check the message’s TTL property when the message is received.</span><span class="sxs-lookup"><span data-stu-id="1bde6-202">The client does not check the message’s TTL property when the message is received.</span></span> <span data-ttu-id="1bde6-203">Instead, the message can be received even if the message’s TTL has passed while the message was cached by the client.</span><span class="sxs-lookup"><span data-stu-id="1bde6-203">Instead, the message can be received even if the message’s TTL has passed while the message was cached by the client.</span></span>

<span data-ttu-id="1bde6-204">Prefetching does not affect the number of billable messaging operations, and is available only for the Service Bus client protocol.</span><span class="sxs-lookup"><span data-stu-id="1bde6-204">Prefetching does not affect the number of billable messaging operations, and is available only for the Service Bus client protocol.</span></span> <span data-ttu-id="1bde6-205">The HTTP protocol does not support prefetching.</span><span class="sxs-lookup"><span data-stu-id="1bde6-205">The HTTP protocol does not support prefetching.</span></span> <span data-ttu-id="1bde6-206">Prefetching is available for both synchronous and asynchronous receive operations.</span><span class="sxs-lookup"><span data-stu-id="1bde6-206">Prefetching is available for both synchronous and asynchronous receive operations.</span></span>

## <a name="express-queues-and-topics"></a><span data-ttu-id="1bde6-207">Express queues and topics</span><span class="sxs-lookup"><span data-stu-id="1bde6-207">Express queues and topics</span></span>
<span data-ttu-id="1bde6-208">Express entities enable high throughput and reduced latency scenarios.</span><span class="sxs-lookup"><span data-stu-id="1bde6-208">Express entities enable high throughput and reduced latency scenarios.</span></span> <span data-ttu-id="1bde6-209">With express entities, if a message is sent to a queue or topic, the message is not immediately stored in the messaging store.</span><span class="sxs-lookup"><span data-stu-id="1bde6-209">With express entities, if a message is sent to a queue or topic, the message is not immediately stored in the messaging store.</span></span> <span data-ttu-id="1bde6-210">Instead, it is cached in memory.</span><span class="sxs-lookup"><span data-stu-id="1bde6-210">Instead, it is cached in memory.</span></span> <span data-ttu-id="1bde6-211">If a message remains in the queue for more than a few seconds, it is automatically written to stable storage, thus protecting it against loss due to an outage.</span><span class="sxs-lookup"><span data-stu-id="1bde6-211">If a message remains in the queue for more than a few seconds, it is automatically written to stable storage, thus protecting it against loss due to an outage.</span></span> <span data-ttu-id="1bde6-212">Writing the message into a memory cache increases throughput and reduces latency because there is no access to stable storage at the time the message is sent.</span><span class="sxs-lookup"><span data-stu-id="1bde6-212">Writing the message into a memory cache increases throughput and reduces latency because there is no access to stable storage at the time the message is sent.</span></span> <span data-ttu-id="1bde6-213">Messages that are consumed within a few seconds are not written to the messaging store.</span><span class="sxs-lookup"><span data-stu-id="1bde6-213">Messages that are consumed within a few seconds are not written to the messaging store.</span></span> <span data-ttu-id="1bde6-214">The following example creates an express topic.</span><span class="sxs-lookup"><span data-stu-id="1bde6-214">The following example creates an express topic.</span></span>

```csharp
TopicDescription td = new TopicDescription(TopicName);
td.EnableExpress = true;
namespaceManager.CreateTopic(td);
```

<span data-ttu-id="1bde6-215">If a message containing critical information that must not be lost is sent to an express entity, the sender can force Service Bus to immediately persist the message to stable storage by setting the [ForcePersistence][ForcePersistence] property to **true**.</span><span class="sxs-lookup"><span data-stu-id="1bde6-215">If a message containing critical information that must not be lost is sent to an express entity, the sender can force Service Bus to immediately persist the message to stable storage by setting the [ForcePersistence][ForcePersistence] property to **true**.</span></span>

> [!NOTE]
> <span data-ttu-id="1bde6-216">Please note that express entities do not support transactions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-216">Please note that express entities do not support transactions.</span></span>

## <a name="use-of-partitioned-queues-or-topics"></a><span data-ttu-id="1bde6-217">Use of partitioned queues or topics</span><span class="sxs-lookup"><span data-stu-id="1bde6-217">Use of partitioned queues or topics</span></span>
<span data-ttu-id="1bde6-218">Internally, Service Bus uses the same node and messaging store to process and store all messages for a messaging entity (queue or topic).</span><span class="sxs-lookup"><span data-stu-id="1bde6-218">Internally, Service Bus uses the same node and messaging store to process and store all messages for a messaging entity (queue or topic).</span></span> <span data-ttu-id="1bde6-219">A partitioned queue or topic, on the other hand, is distributed across multiple nodes and messaging stores.</span><span class="sxs-lookup"><span data-stu-id="1bde6-219">A partitioned queue or topic, on the other hand, is distributed across multiple nodes and messaging stores.</span></span> <span data-ttu-id="1bde6-220">Partitioned queues and topics not only yield a higher throughput than regular queues and topics, they also exhibit superior availability.</span><span class="sxs-lookup"><span data-stu-id="1bde6-220">Partitioned queues and topics not only yield a higher throughput than regular queues and topics, they also exhibit superior availability.</span></span> <span data-ttu-id="1bde6-221">To create a partitioned entity, set the [EnablePartitioning][EnablePartitioning] property to **true**, as shown in the following example.</span><span class="sxs-lookup"><span data-stu-id="1bde6-221">To create a partitioned entity, set the [EnablePartitioning][EnablePartitioning] property to **true**, as shown in the following example.</span></span> <span data-ttu-id="1bde6-222">For more information about partitioned entities, see [Partitioned messaging entities][Partitioned messaging entities].</span><span class="sxs-lookup"><span data-stu-id="1bde6-222">For more information about partitioned entities, see [Partitioned messaging entities][Partitioned messaging entities].</span></span>

```csharp
// Create partitioned queue.
QueueDescription qd = new QueueDescription(QueueName);
qd.EnablePartitioning = true;
namespaceManager.CreateQueue(qd);
```

## <a name="use-of-multiple-queues"></a><span data-ttu-id="1bde6-223">Use of multiple queues</span><span class="sxs-lookup"><span data-stu-id="1bde6-223">Use of multiple queues</span></span>

<span data-ttu-id="1bde6-224">If it is not possible to use a partitioned queue or topic, or the expected load cannot be handled by a single partitioned queue or topic, you must use multiple messaging entities.</span><span class="sxs-lookup"><span data-stu-id="1bde6-224">If it is not possible to use a partitioned queue or topic, or the expected load cannot be handled by a single partitioned queue or topic, you must use multiple messaging entities.</span></span> <span data-ttu-id="1bde6-225">When using multiple entities, create a dedicated client for each entity, instead of using the same client for all entities.</span><span class="sxs-lookup"><span data-stu-id="1bde6-225">When using multiple entities, create a dedicated client for each entity, instead of using the same client for all entities.</span></span>

## <a name="development-and-testing-features"></a><span data-ttu-id="1bde6-226">Development and testing features</span><span class="sxs-lookup"><span data-stu-id="1bde6-226">Development and testing features</span></span>

<span data-ttu-id="1bde6-227">Service Bus has one feature that is used specifically for development which **should never be used in production configurations**: [TopicDescription.EnableFilteringMessagesBeforePublishing][].</span><span class="sxs-lookup"><span data-stu-id="1bde6-227">Service Bus has one feature that is used specifically for development which **should never be used in production configurations**: [TopicDescription.EnableFilteringMessagesBeforePublishing][].</span></span>

<span data-ttu-id="1bde6-228">When new rules or filters are added to the topic, you can use [TopicDescription.EnableFilteringMessagesBeforePublishing][] to verify that the new filter expression is working as expected.</span><span class="sxs-lookup"><span data-stu-id="1bde6-228">When new rules or filters are added to the topic, you can use [TopicDescription.EnableFilteringMessagesBeforePublishing][] to verify that the new filter expression is working as expected.</span></span>

## <a name="scenarios"></a><span data-ttu-id="1bde6-229">Scenarios</span><span class="sxs-lookup"><span data-stu-id="1bde6-229">Scenarios</span></span>
<span data-ttu-id="1bde6-230">The following sections describe typical messaging scenarios and outline the preferred Service Bus settings.</span><span class="sxs-lookup"><span data-stu-id="1bde6-230">The following sections describe typical messaging scenarios and outline the preferred Service Bus settings.</span></span> <span data-ttu-id="1bde6-231">Throughput rates are classified as small (less than 1 message/second), moderate (1 message/second or greater but less than 100 messages/second) and high (100 messages/second or greater).</span><span class="sxs-lookup"><span data-stu-id="1bde6-231">Throughput rates are classified as small (less than 1 message/second), moderate (1 message/second or greater but less than 100 messages/second) and high (100 messages/second or greater).</span></span> <span data-ttu-id="1bde6-232">The number of clients are classified as small (5 or fewer), moderate (more than 5 but less than or equal to 20), and large (more than 20).</span><span class="sxs-lookup"><span data-stu-id="1bde6-232">The number of clients are classified as small (5 or fewer), moderate (more than 5 but less than or equal to 20), and large (more than 20).</span></span>

### <a name="high-throughput-queue"></a><span data-ttu-id="1bde6-233">High-throughput queue</span><span class="sxs-lookup"><span data-stu-id="1bde6-233">High-throughput queue</span></span>
<span data-ttu-id="1bde6-234">Goal: Maximize the throughput of a single queue.</span><span class="sxs-lookup"><span data-stu-id="1bde6-234">Goal: Maximize the throughput of a single queue.</span></span> <span data-ttu-id="1bde6-235">The number of senders and receivers is small.</span><span class="sxs-lookup"><span data-stu-id="1bde6-235">The number of senders and receivers is small.</span></span>

* <span data-ttu-id="1bde6-236">Use a partitioned queue for improved performance and availability.</span><span class="sxs-lookup"><span data-stu-id="1bde6-236">Use a partitioned queue for improved performance and availability.</span></span>
* <span data-ttu-id="1bde6-237">To increase the overall send rate into the queue, use multiple message factories to create senders.</span><span class="sxs-lookup"><span data-stu-id="1bde6-237">To increase the overall send rate into the queue, use multiple message factories to create senders.</span></span> <span data-ttu-id="1bde6-238">For each sender, use asynchronous operations or multiple threads.</span><span class="sxs-lookup"><span data-stu-id="1bde6-238">For each sender, use asynchronous operations or multiple threads.</span></span>
* <span data-ttu-id="1bde6-239">To increase the overall receive rate from the queue, use multiple message factories to create receivers.</span><span class="sxs-lookup"><span data-stu-id="1bde6-239">To increase the overall receive rate from the queue, use multiple message factories to create receivers.</span></span>
* <span data-ttu-id="1bde6-240">Use asynchronous operations to take advantage of client-side batching.</span><span class="sxs-lookup"><span data-stu-id="1bde6-240">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="1bde6-241">Set the batching interval to 50ms to reduce the number of Service Bus client protocol transmissions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-241">Set the batching interval to 50ms to reduce the number of Service Bus client protocol transmissions.</span></span> <span data-ttu-id="1bde6-242">If multiple senders are used, increase the batching interval to 100ms.</span><span class="sxs-lookup"><span data-stu-id="1bde6-242">If multiple senders are used, increase the batching interval to 100ms.</span></span>
* <span data-ttu-id="1bde6-243">Leave batched store access enabled.</span><span class="sxs-lookup"><span data-stu-id="1bde6-243">Leave batched store access enabled.</span></span> <span data-ttu-id="1bde6-244">This increases the overall rate at which messages can be written into the queue.</span><span class="sxs-lookup"><span data-stu-id="1bde6-244">This increases the overall rate at which messages can be written into the queue.</span></span>
* <span data-ttu-id="1bde6-245">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span><span class="sxs-lookup"><span data-stu-id="1bde6-245">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span></span> <span data-ttu-id="1bde6-246">This reduces the number of Service Bus client protocol transmissions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-246">This reduces the number of Service Bus client protocol transmissions.</span></span>

### <a name="multiple-high-throughput-queues"></a><span data-ttu-id="1bde6-247">Multiple high-throughput queues</span><span class="sxs-lookup"><span data-stu-id="1bde6-247">Multiple high-throughput queues</span></span>
<span data-ttu-id="1bde6-248">Goal: Maximize overall throughput of multiple queues.</span><span class="sxs-lookup"><span data-stu-id="1bde6-248">Goal: Maximize overall throughput of multiple queues.</span></span> <span data-ttu-id="1bde6-249">The throughput of an individual queue is moderate or high.</span><span class="sxs-lookup"><span data-stu-id="1bde6-249">The throughput of an individual queue is moderate or high.</span></span>

<span data-ttu-id="1bde6-250">To obtain maximum throughput across multiple queues, use the settings outlined to maximize the throughput of a single queue.</span><span class="sxs-lookup"><span data-stu-id="1bde6-250">To obtain maximum throughput across multiple queues, use the settings outlined to maximize the throughput of a single queue.</span></span> <span data-ttu-id="1bde6-251">In addition, use different factories to create clients that send or receive from different queues.</span><span class="sxs-lookup"><span data-stu-id="1bde6-251">In addition, use different factories to create clients that send or receive from different queues.</span></span>

### <a name="low-latency-queue"></a><span data-ttu-id="1bde6-252">Low latency queue</span><span class="sxs-lookup"><span data-stu-id="1bde6-252">Low latency queue</span></span>
<span data-ttu-id="1bde6-253">Goal: Minimize end-to-end latency of a queue or topic.</span><span class="sxs-lookup"><span data-stu-id="1bde6-253">Goal: Minimize end-to-end latency of a queue or topic.</span></span> <span data-ttu-id="1bde6-254">The number of senders and receivers is small.</span><span class="sxs-lookup"><span data-stu-id="1bde6-254">The number of senders and receivers is small.</span></span> <span data-ttu-id="1bde6-255">The throughput of the queue is small or moderate.</span><span class="sxs-lookup"><span data-stu-id="1bde6-255">The throughput of the queue is small or moderate.</span></span>

* <span data-ttu-id="1bde6-256">Use a partitioned queue for improved availability.</span><span class="sxs-lookup"><span data-stu-id="1bde6-256">Use a partitioned queue for improved availability.</span></span>
* <span data-ttu-id="1bde6-257">Disable client-side batching.</span><span class="sxs-lookup"><span data-stu-id="1bde6-257">Disable client-side batching.</span></span> <span data-ttu-id="1bde6-258">The client immediately sends a message.</span><span class="sxs-lookup"><span data-stu-id="1bde6-258">The client immediately sends a message.</span></span>
* <span data-ttu-id="1bde6-259">Disable batched store access.</span><span class="sxs-lookup"><span data-stu-id="1bde6-259">Disable batched store access.</span></span> <span data-ttu-id="1bde6-260">The service immediately writes the message to the store.</span><span class="sxs-lookup"><span data-stu-id="1bde6-260">The service immediately writes the message to the store.</span></span>
* <span data-ttu-id="1bde6-261">If using a single client, set the prefetch count to 20 times the processing rate of the receiver.</span><span class="sxs-lookup"><span data-stu-id="1bde6-261">If using a single client, set the prefetch count to 20 times the processing rate of the receiver.</span></span> <span data-ttu-id="1bde6-262">If multiple messages arrive at the queue at the same time, the Service Bus client protocol transmits them all at the same time.</span><span class="sxs-lookup"><span data-stu-id="1bde6-262">If multiple messages arrive at the queue at the same time, the Service Bus client protocol transmits them all at the same time.</span></span> <span data-ttu-id="1bde6-263">When the client receives the next message, that message is already in the local cache.</span><span class="sxs-lookup"><span data-stu-id="1bde6-263">When the client receives the next message, that message is already in the local cache.</span></span> <span data-ttu-id="1bde6-264">The cache should be small.</span><span class="sxs-lookup"><span data-stu-id="1bde6-264">The cache should be small.</span></span>
* <span data-ttu-id="1bde6-265">If using multiple clients, set the prefetch count to 0.</span><span class="sxs-lookup"><span data-stu-id="1bde6-265">If using multiple clients, set the prefetch count to 0.</span></span> <span data-ttu-id="1bde6-266">By doing this, the second client can receive the second message while the first client is still processing the first message.</span><span class="sxs-lookup"><span data-stu-id="1bde6-266">By doing this, the second client can receive the second message while the first client is still processing the first message.</span></span>

### <a name="queue-with-a-large-number-of-senders"></a><span data-ttu-id="1bde6-267">Queue with a large number of senders</span><span class="sxs-lookup"><span data-stu-id="1bde6-267">Queue with a large number of senders</span></span>
<span data-ttu-id="1bde6-268">Goal: Maximize throughput of a queue or topic with a large number of senders.</span><span class="sxs-lookup"><span data-stu-id="1bde6-268">Goal: Maximize throughput of a queue or topic with a large number of senders.</span></span> <span data-ttu-id="1bde6-269">Each sender sends messages with a moderate rate.</span><span class="sxs-lookup"><span data-stu-id="1bde6-269">Each sender sends messages with a moderate rate.</span></span> <span data-ttu-id="1bde6-270">The number of receivers is small.</span><span class="sxs-lookup"><span data-stu-id="1bde6-270">The number of receivers is small.</span></span>

<span data-ttu-id="1bde6-271">Service Bus enables up to 1000 concurrent connections to a messaging entity (or 5000 using AMQP).</span><span class="sxs-lookup"><span data-stu-id="1bde6-271">Service Bus enables up to 1000 concurrent connections to a messaging entity (or 5000 using AMQP).</span></span> <span data-ttu-id="1bde6-272">This limit is enforced at the namespace level, and queues/topics/subscriptions are capped by the limit of concurrent connections per namespace.</span><span class="sxs-lookup"><span data-stu-id="1bde6-272">This limit is enforced at the namespace level, and queues/topics/subscriptions are capped by the limit of concurrent connections per namespace.</span></span> <span data-ttu-id="1bde6-273">For queues, this number is shared between senders and receivers.</span><span class="sxs-lookup"><span data-stu-id="1bde6-273">For queues, this number is shared between senders and receivers.</span></span> <span data-ttu-id="1bde6-274">If all 1000 connections are required for senders, you should replace the queue with a topic and a single subscription.</span><span class="sxs-lookup"><span data-stu-id="1bde6-274">If all 1000 connections are required for senders, you should replace the queue with a topic and a single subscription.</span></span> <span data-ttu-id="1bde6-275">A topic accepts up to 1000 concurrent connections from senders, whereas the subscription accepts an additional 1000 concurrent connections from receivers.</span><span class="sxs-lookup"><span data-stu-id="1bde6-275">A topic accepts up to 1000 concurrent connections from senders, whereas the subscription accepts an additional 1000 concurrent connections from receivers.</span></span> <span data-ttu-id="1bde6-276">If more than 1000 concurrent senders are required, the senders should send messages to the Service Bus protocol via HTTP.</span><span class="sxs-lookup"><span data-stu-id="1bde6-276">If more than 1000 concurrent senders are required, the senders should send messages to the Service Bus protocol via HTTP.</span></span>

<span data-ttu-id="1bde6-277">To maximize throughput, do the following:</span><span class="sxs-lookup"><span data-stu-id="1bde6-277">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="1bde6-278">Use a partitioned queue for improved performance and availability.</span><span class="sxs-lookup"><span data-stu-id="1bde6-278">Use a partitioned queue for improved performance and availability.</span></span>
* <span data-ttu-id="1bde6-279">If each sender resides in a different process, use only a single factory per process.</span><span class="sxs-lookup"><span data-stu-id="1bde6-279">If each sender resides in a different process, use only a single factory per process.</span></span>
* <span data-ttu-id="1bde6-280">Use asynchronous operations to take advantage of client-side batching.</span><span class="sxs-lookup"><span data-stu-id="1bde6-280">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="1bde6-281">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-281">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span></span>
* <span data-ttu-id="1bde6-282">Leave batched store access enabled.</span><span class="sxs-lookup"><span data-stu-id="1bde6-282">Leave batched store access enabled.</span></span> <span data-ttu-id="1bde6-283">This increases the overall rate at which messages can be written into the queue or topic.</span><span class="sxs-lookup"><span data-stu-id="1bde6-283">This increases the overall rate at which messages can be written into the queue or topic.</span></span>
* <span data-ttu-id="1bde6-284">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span><span class="sxs-lookup"><span data-stu-id="1bde6-284">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span></span> <span data-ttu-id="1bde6-285">This reduces the number of Service Bus client protocol transmissions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-285">This reduces the number of Service Bus client protocol transmissions.</span></span>

### <a name="queue-with-a-large-number-of-receivers"></a><span data-ttu-id="1bde6-286">Queue with a large number of receivers</span><span class="sxs-lookup"><span data-stu-id="1bde6-286">Queue with a large number of receivers</span></span>
<span data-ttu-id="1bde6-287">Goal: Maximize the receive rate of a queue or subscription with a large number of receivers.</span><span class="sxs-lookup"><span data-stu-id="1bde6-287">Goal: Maximize the receive rate of a queue or subscription with a large number of receivers.</span></span> <span data-ttu-id="1bde6-288">Each receiver receives messages at a moderate rate.</span><span class="sxs-lookup"><span data-stu-id="1bde6-288">Each receiver receives messages at a moderate rate.</span></span> <span data-ttu-id="1bde6-289">The number of senders is small.</span><span class="sxs-lookup"><span data-stu-id="1bde6-289">The number of senders is small.</span></span>

<span data-ttu-id="1bde6-290">Service Bus enables up to 1000 concurrent connections to an entity.</span><span class="sxs-lookup"><span data-stu-id="1bde6-290">Service Bus enables up to 1000 concurrent connections to an entity.</span></span> <span data-ttu-id="1bde6-291">If a queue requires more than 1000 receivers, you should replace the queue with a topic and multiple subscriptions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-291">If a queue requires more than 1000 receivers, you should replace the queue with a topic and multiple subscriptions.</span></span> <span data-ttu-id="1bde6-292">Each subscription can support up to 1000 concurrent connections.</span><span class="sxs-lookup"><span data-stu-id="1bde6-292">Each subscription can support up to 1000 concurrent connections.</span></span> <span data-ttu-id="1bde6-293">Alternatively, receivers can access the queue via the HTTP protocol.</span><span class="sxs-lookup"><span data-stu-id="1bde6-293">Alternatively, receivers can access the queue via the HTTP protocol.</span></span>

<span data-ttu-id="1bde6-294">To maximize throughput, do the following:</span><span class="sxs-lookup"><span data-stu-id="1bde6-294">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="1bde6-295">Use a partitioned queue for improved performance and availability.</span><span class="sxs-lookup"><span data-stu-id="1bde6-295">Use a partitioned queue for improved performance and availability.</span></span>
* <span data-ttu-id="1bde6-296">If each receiver resides in a different process, use only a single factory per process.</span><span class="sxs-lookup"><span data-stu-id="1bde6-296">If each receiver resides in a different process, use only a single factory per process.</span></span>
* <span data-ttu-id="1bde6-297">Receivers can use synchronous or asynchronous operations.</span><span class="sxs-lookup"><span data-stu-id="1bde6-297">Receivers can use synchronous or asynchronous operations.</span></span> <span data-ttu-id="1bde6-298">Given the moderate receive rate of an individual receiver, client-side batching of a Complete request does not affect receiver throughput.</span><span class="sxs-lookup"><span data-stu-id="1bde6-298">Given the moderate receive rate of an individual receiver, client-side batching of a Complete request does not affect receiver throughput.</span></span>
* <span data-ttu-id="1bde6-299">Leave batched store access enabled.</span><span class="sxs-lookup"><span data-stu-id="1bde6-299">Leave batched store access enabled.</span></span> <span data-ttu-id="1bde6-300">This reduces the overall load of the entity.</span><span class="sxs-lookup"><span data-stu-id="1bde6-300">This reduces the overall load of the entity.</span></span> <span data-ttu-id="1bde6-301">It also reduces the overall rate at which messages can be written into the queue or topic.</span><span class="sxs-lookup"><span data-stu-id="1bde6-301">It also reduces the overall rate at which messages can be written into the queue or topic.</span></span>
* <span data-ttu-id="1bde6-302">Set the prefetch count to a small value (for example, PrefetchCount = 10).</span><span class="sxs-lookup"><span data-stu-id="1bde6-302">Set the prefetch count to a small value (for example, PrefetchCount = 10).</span></span> <span data-ttu-id="1bde6-303">This prevents receivers from being idle while other receivers have large numbers of messages cached.</span><span class="sxs-lookup"><span data-stu-id="1bde6-303">This prevents receivers from being idle while other receivers have large numbers of messages cached.</span></span>

### <a name="topic-with-a-small-number-of-subscriptions"></a><span data-ttu-id="1bde6-304">Topic with a small number of subscriptions</span><span class="sxs-lookup"><span data-stu-id="1bde6-304">Topic with a small number of subscriptions</span></span>
<span data-ttu-id="1bde6-305">Goal: Maximize the throughput of a topic with a small number of subscriptions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-305">Goal: Maximize the throughput of a topic with a small number of subscriptions.</span></span> <span data-ttu-id="1bde6-306">A message is received by many subscriptions, which means the combined receive rate over all subscriptions is larger than the send rate.</span><span class="sxs-lookup"><span data-stu-id="1bde6-306">A message is received by many subscriptions, which means the combined receive rate over all subscriptions is larger than the send rate.</span></span> <span data-ttu-id="1bde6-307">The number of senders is small.</span><span class="sxs-lookup"><span data-stu-id="1bde6-307">The number of senders is small.</span></span> <span data-ttu-id="1bde6-308">The number of receivers per subscription is small.</span><span class="sxs-lookup"><span data-stu-id="1bde6-308">The number of receivers per subscription is small.</span></span>

<span data-ttu-id="1bde6-309">To maximize throughput, do the following:</span><span class="sxs-lookup"><span data-stu-id="1bde6-309">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="1bde6-310">Use a partitioned topic for improved performance and availability.</span><span class="sxs-lookup"><span data-stu-id="1bde6-310">Use a partitioned topic for improved performance and availability.</span></span>
* <span data-ttu-id="1bde6-311">To increase the overall send rate into the topic, use multiple message factories to create senders.</span><span class="sxs-lookup"><span data-stu-id="1bde6-311">To increase the overall send rate into the topic, use multiple message factories to create senders.</span></span> <span data-ttu-id="1bde6-312">For each sender, use asynchronous operations or multiple threads.</span><span class="sxs-lookup"><span data-stu-id="1bde6-312">For each sender, use asynchronous operations or multiple threads.</span></span>
* <span data-ttu-id="1bde6-313">To increase the overall receive rate from a subscription, use multiple message factories to create receivers.</span><span class="sxs-lookup"><span data-stu-id="1bde6-313">To increase the overall receive rate from a subscription, use multiple message factories to create receivers.</span></span> <span data-ttu-id="1bde6-314">For each receiver, use asynchronous operations or multiple threads.</span><span class="sxs-lookup"><span data-stu-id="1bde6-314">For each receiver, use asynchronous operations or multiple threads.</span></span>
* <span data-ttu-id="1bde6-315">Use asynchronous operations to take advantage of client-side batching.</span><span class="sxs-lookup"><span data-stu-id="1bde6-315">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="1bde6-316">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-316">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span></span>
* <span data-ttu-id="1bde6-317">Leave batched store access enabled.</span><span class="sxs-lookup"><span data-stu-id="1bde6-317">Leave batched store access enabled.</span></span> <span data-ttu-id="1bde6-318">This increases the overall rate at which messages can be written into the topic.</span><span class="sxs-lookup"><span data-stu-id="1bde6-318">This increases the overall rate at which messages can be written into the topic.</span></span>
* <span data-ttu-id="1bde6-319">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span><span class="sxs-lookup"><span data-stu-id="1bde6-319">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span></span> <span data-ttu-id="1bde6-320">This reduces the number of Service Bus client protocol transmissions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-320">This reduces the number of Service Bus client protocol transmissions.</span></span>

### <a name="topic-with-a-large-number-of-subscriptions"></a><span data-ttu-id="1bde6-321">Topic with a large number of subscriptions</span><span class="sxs-lookup"><span data-stu-id="1bde6-321">Topic with a large number of subscriptions</span></span>
<span data-ttu-id="1bde6-322">Goal: Maximize the throughput of a topic with a large number of subscriptions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-322">Goal: Maximize the throughput of a topic with a large number of subscriptions.</span></span> <span data-ttu-id="1bde6-323">A message is received by many subscriptions, which means the combined receive rate over all subscriptions is much larger than the send rate.</span><span class="sxs-lookup"><span data-stu-id="1bde6-323">A message is received by many subscriptions, which means the combined receive rate over all subscriptions is much larger than the send rate.</span></span> <span data-ttu-id="1bde6-324">The number of senders is small.</span><span class="sxs-lookup"><span data-stu-id="1bde6-324">The number of senders is small.</span></span> <span data-ttu-id="1bde6-325">The number of receivers per subscription is small.</span><span class="sxs-lookup"><span data-stu-id="1bde6-325">The number of receivers per subscription is small.</span></span>

<span data-ttu-id="1bde6-326">Topics with a large number of subscriptions typically expose a low overall throughput if all messages are routed to all subscriptions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-326">Topics with a large number of subscriptions typically expose a low overall throughput if all messages are routed to all subscriptions.</span></span> <span data-ttu-id="1bde6-327">This is caused by the fact that each message is received many times, and all messages that are contained in a topic and all its subscriptions are stored in the same store.</span><span class="sxs-lookup"><span data-stu-id="1bde6-327">This is caused by the fact that each message is received many times, and all messages that are contained in a topic and all its subscriptions are stored in the same store.</span></span> <span data-ttu-id="1bde6-328">It is assumed that the number of senders and number of receivers per subscription is small.</span><span class="sxs-lookup"><span data-stu-id="1bde6-328">It is assumed that the number of senders and number of receivers per subscription is small.</span></span> <span data-ttu-id="1bde6-329">Service Bus supports up to 2,000 subscriptions per topic.</span><span class="sxs-lookup"><span data-stu-id="1bde6-329">Service Bus supports up to 2,000 subscriptions per topic.</span></span>

<span data-ttu-id="1bde6-330">To maximize throughput, do the following:</span><span class="sxs-lookup"><span data-stu-id="1bde6-330">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="1bde6-331">Use a partitioned topic for improved performance and availability.</span><span class="sxs-lookup"><span data-stu-id="1bde6-331">Use a partitioned topic for improved performance and availability.</span></span>
* <span data-ttu-id="1bde6-332">Use asynchronous operations to take advantage of client-side batching.</span><span class="sxs-lookup"><span data-stu-id="1bde6-332">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="1bde6-333">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-333">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span></span>
* <span data-ttu-id="1bde6-334">Leave batched store access enabled.</span><span class="sxs-lookup"><span data-stu-id="1bde6-334">Leave batched store access enabled.</span></span> <span data-ttu-id="1bde6-335">This increases the overall rate at which messages can be written into the topic.</span><span class="sxs-lookup"><span data-stu-id="1bde6-335">This increases the overall rate at which messages can be written into the topic.</span></span>
* <span data-ttu-id="1bde6-336">Set the prefetch count to 20 times the expected receive rate in seconds.</span><span class="sxs-lookup"><span data-stu-id="1bde6-336">Set the prefetch count to 20 times the expected receive rate in seconds.</span></span> <span data-ttu-id="1bde6-337">This reduces the number of Service Bus client protocol transmissions.</span><span class="sxs-lookup"><span data-stu-id="1bde6-337">This reduces the number of Service Bus client protocol transmissions.</span></span>

## <a name="next-steps"></a><span data-ttu-id="1bde6-338">Next steps</span><span class="sxs-lookup"><span data-stu-id="1bde6-338">Next steps</span></span>
<span data-ttu-id="1bde6-339">To learn more about optimizing Service Bus performance, see [Partitioned messaging entities][Partitioned messaging entities].</span><span class="sxs-lookup"><span data-stu-id="1bde6-339">To learn more about optimizing Service Bus performance, see [Partitioned messaging entities][Partitioned messaging entities].</span></span>

[QueueClient]: /dotnet/api/microsoft.servicebus.messaging.queueclient
[MessageSender]: /dotnet/api/microsoft.servicebus.messaging.messagesender
[MessagingFactory]: /dotnet/api/microsoft.servicebus.messaging.messagingfactory
[PeekLock]: /dotnet/api/microsoft.servicebus.messaging.receivemode
[ReceiveAndDelete]: /dotnet/api/microsoft.servicebus.messaging.receivemode
[BatchFlushInterval]: /dotnet/api/microsoft.servicebus.messaging.netmessagingtransportsettings#Microsoft_ServiceBus_Messaging_NetMessagingTransportSettings_BatchFlushInterval
[EnableBatchedOperations]: /dotnet/api/microsoft.servicebus.messaging.queuedescription#Microsoft_ServiceBus_Messaging_QueueDescription_EnableBatchedOperations
[QueueClient.PrefetchCount]: /dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_PrefetchCount
[SubscriptionClient.PrefetchCount]: /dotnet/api/microsoft.servicebus.messaging.subscriptionclient#Microsoft_ServiceBus_Messaging_SubscriptionClient_PrefetchCount
[ForcePersistence]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_ForcePersistence
[EnablePartitioning]: /dotnet/api/microsoft.servicebus.messaging.queuedescription#Microsoft_ServiceBus_Messaging_QueueDescription_EnablePartitioning
[Partitioned messaging entities]: service-bus-partitioning.md
[TopicDescription.EnableFilteringMessagesBeforePublishing]: /dotnet/api/microsoft.servicebus.messaging.topicdescription#Microsoft_ServiceBus_Messaging_TopicDescription_EnableFilteringMessagesBeforePublishing
