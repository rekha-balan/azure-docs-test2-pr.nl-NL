---
title: Create partitioned Azure Service Bus queues and topics | Microsoft Docs
description: Describes how to partition Service Bus queues and topics by using multiple message brokers.
services: service-bus-messaging
documentationcenter: na
author: sethmanheim
manager: timlt
editor: ''
ms.assetid: a0c7d5a2-4876-42cb-8344-a1fc988746e7
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 03/28/2017
ms.author: sethm;hillaryc
ms.openlocfilehash: 946f3ac069db436828427e575be5a14efac9dda9
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44556363"
---
# <a name="partitioned-queues-and-topics"></a><span data-ttu-id="93b55-103">Partitioned queues and topics</span><span class="sxs-lookup"><span data-stu-id="93b55-103">Partitioned queues and topics</span></span>
<span data-ttu-id="93b55-104">Azure Service Bus employs multiple message brokers to process messages and multiple messaging stores to store messages.</span><span class="sxs-lookup"><span data-stu-id="93b55-104">Azure Service Bus employs multiple message brokers to process messages and multiple messaging stores to store messages.</span></span> <span data-ttu-id="93b55-105">A conventional queue or topic is handled by a single message broker and stored in one messaging store.</span><span class="sxs-lookup"><span data-stu-id="93b55-105">A conventional queue or topic is handled by a single message broker and stored in one messaging store.</span></span> <span data-ttu-id="93b55-106">Service Bus *partitions* enable queues or topics to be partitioned across multiple message brokers and messaging stores.</span><span class="sxs-lookup"><span data-stu-id="93b55-106">Service Bus *partitions* enable queues or topics to be partitioned across multiple message brokers and messaging stores.</span></span> <span data-ttu-id="93b55-107">This means that the overall throughput of a partitioned queue or topic is no longer limited by the performance of a single message broker or messaging store.</span><span class="sxs-lookup"><span data-stu-id="93b55-107">This means that the overall throughput of a partitioned queue or topic is no longer limited by the performance of a single message broker or messaging store.</span></span> <span data-ttu-id="93b55-108">In addition, a temporary outage of a messaging store does not render a partitioned queue or topic unavailable.</span><span class="sxs-lookup"><span data-stu-id="93b55-108">In addition, a temporary outage of a messaging store does not render a partitioned queue or topic unavailable.</span></span> <span data-ttu-id="93b55-109">Partitioned queues and topics can contain all advanced Service Bus features, such as support for transactions and sessions.</span><span class="sxs-lookup"><span data-stu-id="93b55-109">Partitioned queues and topics can contain all advanced Service Bus features, such as support for transactions and sessions.</span></span>

<span data-ttu-id="93b55-110">For more information about Service Bus internals, see the [Service Bus architecture][Service Bus architecture] article.</span><span class="sxs-lookup"><span data-stu-id="93b55-110">For more information about Service Bus internals, see the [Service Bus architecture][Service Bus architecture] article.</span></span>

## <a name="how-it-works"></a><span data-ttu-id="93b55-111">How it works</span><span class="sxs-lookup"><span data-stu-id="93b55-111">How it works</span></span>
<span data-ttu-id="93b55-112">Each partitioned queue or topic consists of multiple fragments.</span><span class="sxs-lookup"><span data-stu-id="93b55-112">Each partitioned queue or topic consists of multiple fragments.</span></span> <span data-ttu-id="93b55-113">Each fragment is stored in a different messaging store and handled by a different message broker.</span><span class="sxs-lookup"><span data-stu-id="93b55-113">Each fragment is stored in a different messaging store and handled by a different message broker.</span></span> <span data-ttu-id="93b55-114">When a message is sent to a partitioned queue or topic, Service Bus assigns the message to one of the fragments.</span><span class="sxs-lookup"><span data-stu-id="93b55-114">When a message is sent to a partitioned queue or topic, Service Bus assigns the message to one of the fragments.</span></span> <span data-ttu-id="93b55-115">The selection is done randomly by Service Bus or by using a partition key that the sender can specify.</span><span class="sxs-lookup"><span data-stu-id="93b55-115">The selection is done randomly by Service Bus or by using a partition key that the sender can specify.</span></span>

<span data-ttu-id="93b55-116">When a client wants to receive a message from a partitioned queue, or from a subscription to a partitioned topic, Service Bus queries all fragments for messages, then returns the first message that is obtained from any of the messaging stores to the receiver.</span><span class="sxs-lookup"><span data-stu-id="93b55-116">When a client wants to receive a message from a partitioned queue, or from a subscription to a partitioned topic, Service Bus queries all fragments for messages, then returns the first message that is obtained from any of the messaging stores to the receiver.</span></span> <span data-ttu-id="93b55-117">Service Bus caches the other messages and returns them when it receives additional receive requests.</span><span class="sxs-lookup"><span data-stu-id="93b55-117">Service Bus caches the other messages and returns them when it receives additional receive requests.</span></span> <span data-ttu-id="93b55-118">A receiving client is not aware of the partitioning; the client-facing behavior of a partitioned queue or topic (for example, read, complete, defer, deadletter, prefetching) is identical to the behavior of a regular entity.</span><span class="sxs-lookup"><span data-stu-id="93b55-118">A receiving client is not aware of the partitioning; the client-facing behavior of a partitioned queue or topic (for example, read, complete, defer, deadletter, prefetching) is identical to the behavior of a regular entity.</span></span>

<span data-ttu-id="93b55-119">There is no additional cost when sending a message to, or receiving a message from, a partitioned queue or topic.</span><span class="sxs-lookup"><span data-stu-id="93b55-119">There is no additional cost when sending a message to, or receiving a message from, a partitioned queue or topic.</span></span>

## <a name="enable-partitioning"></a><span data-ttu-id="93b55-120">Enable partitioning</span><span class="sxs-lookup"><span data-stu-id="93b55-120">Enable partitioning</span></span>
<span data-ttu-id="93b55-121">To use partitioned queues and topics with Azure Service Bus, use the Azure SDK version 2.2 or later, or specify `api-version=2013-10` in your HTTP requests.</span><span class="sxs-lookup"><span data-stu-id="93b55-121">To use partitioned queues and topics with Azure Service Bus, use the Azure SDK version 2.2 or later, or specify `api-version=2013-10` in your HTTP requests.</span></span>

<span data-ttu-id="93b55-122">You can create Service Bus queues and topics in 1, 2, 3, 4, or 5 GB sizes (the default is 1 GB).</span><span class="sxs-lookup"><span data-stu-id="93b55-122">You can create Service Bus queues and topics in 1, 2, 3, 4, or 5 GB sizes (the default is 1 GB).</span></span> <span data-ttu-id="93b55-123">With partitioning enabled, Service Bus creates 16 partitions for each GB you specify.</span><span class="sxs-lookup"><span data-stu-id="93b55-123">With partitioning enabled, Service Bus creates 16 partitions for each GB you specify.</span></span> <span data-ttu-id="93b55-124">As such, if you create a queue that's 5 GB in size, with 16 partitions the maximum queue size becomes (5 \* 16) = 80 GB.</span><span class="sxs-lookup"><span data-stu-id="93b55-124">As such, if you create a queue that's 5 GB in size, with 16 partitions the maximum queue size becomes (5 \* 16) = 80 GB.</span></span> <span data-ttu-id="93b55-125">You can see the maximum size of your partitioned queue or topic by looking at its entry on the [Azure portal][Azure portal].</span><span class="sxs-lookup"><span data-stu-id="93b55-125">You can see the maximum size of your partitioned queue or topic by looking at its entry on the [Azure portal][Azure portal].</span></span>

<span data-ttu-id="93b55-126">There are several ways to create a partitioned queue or topic.</span><span class="sxs-lookup"><span data-stu-id="93b55-126">There are several ways to create a partitioned queue or topic.</span></span> <span data-ttu-id="93b55-127">When you create the queue or topic from your application, you can enable partitioning for the queue or topic by respectively setting the [QueueDescription.EnablePartitioning][QueueDescription.EnablePartitioning] or [TopicDescription.EnablePartitioning][TopicDescription.EnablePartitioning] property to **true**.</span><span class="sxs-lookup"><span data-stu-id="93b55-127">When you create the queue or topic from your application, you can enable partitioning for the queue or topic by respectively setting the [QueueDescription.EnablePartitioning][QueueDescription.EnablePartitioning] or [TopicDescription.EnablePartitioning][TopicDescription.EnablePartitioning] property to **true**.</span></span> <span data-ttu-id="93b55-128">These properties must be set at the time the queue or topic is created.</span><span class="sxs-lookup"><span data-stu-id="93b55-128">These properties must be set at the time the queue or topic is created.</span></span> <span data-ttu-id="93b55-129">It is not possible to change these properties on an existing queue or topic.</span><span class="sxs-lookup"><span data-stu-id="93b55-129">It is not possible to change these properties on an existing queue or topic.</span></span> <span data-ttu-id="93b55-130">For example:</span><span class="sxs-lookup"><span data-stu-id="93b55-130">For example:</span></span>

```csharp
// Create partitioned topic
NamespaceManager ns = NamespaceManager.CreateFromConnectionString(myConnectionString);
TopicDescription td = new TopicDescription(TopicName);
td.EnablePartitioning = true;
ns.CreateTopic(td);
```

<span data-ttu-id="93b55-131">Alternatively, you can create a partitioned queue or topic in Visual Studio or in the [Azure portal][Azure portal].</span><span class="sxs-lookup"><span data-stu-id="93b55-131">Alternatively, you can create a partitioned queue or topic in Visual Studio or in the [Azure portal][Azure portal].</span></span> <span data-ttu-id="93b55-132">When you create a queue or topic in the portal, set the **Enable Partitioning** option in the **General settings** blade of the queue or topic **Settings** window to **true**.</span><span class="sxs-lookup"><span data-stu-id="93b55-132">When you create a queue or topic in the portal, set the **Enable Partitioning** option in the **General settings** blade of the queue or topic **Settings** window to **true**.</span></span> <span data-ttu-id="93b55-133">In Visual Studio, click the **Enable Partitioning** checkbox in the **New Queue** or **New Topic** dialog box.</span><span class="sxs-lookup"><span data-stu-id="93b55-133">In Visual Studio, click the **Enable Partitioning** checkbox in the **New Queue** or **New Topic** dialog box.</span></span>

## <a name="use-of-partition-keys"></a><span data-ttu-id="93b55-134">Use of partition keys</span><span class="sxs-lookup"><span data-stu-id="93b55-134">Use of partition keys</span></span>
<span data-ttu-id="93b55-135">When a message is enqueued into a partitioned queue or topic, Service Bus checks for the presence of a partition key.</span><span class="sxs-lookup"><span data-stu-id="93b55-135">When a message is enqueued into a partitioned queue or topic, Service Bus checks for the presence of a partition key.</span></span> <span data-ttu-id="93b55-136">If it finds one, it selects the fragment based on that key.</span><span class="sxs-lookup"><span data-stu-id="93b55-136">If it finds one, it selects the fragment based on that key.</span></span> <span data-ttu-id="93b55-137">If it does not find a partition key, it selects the fragment based on an internal algorithm.</span><span class="sxs-lookup"><span data-stu-id="93b55-137">If it does not find a partition key, it selects the fragment based on an internal algorithm.</span></span>

### <a name="using-a-partition-key"></a><span data-ttu-id="93b55-138">Using a partition key</span><span class="sxs-lookup"><span data-stu-id="93b55-138">Using a partition key</span></span>
<span data-ttu-id="93b55-139">Some scenarios, such as sessions or transactions, require messages to be stored in a specific fragment.</span><span class="sxs-lookup"><span data-stu-id="93b55-139">Some scenarios, such as sessions or transactions, require messages to be stored in a specific fragment.</span></span> <span data-ttu-id="93b55-140">All these scenarios require the use of a partition key.</span><span class="sxs-lookup"><span data-stu-id="93b55-140">All these scenarios require the use of a partition key.</span></span> <span data-ttu-id="93b55-141">All messages that use the same partition key are assigned to the same fragment.</span><span class="sxs-lookup"><span data-stu-id="93b55-141">All messages that use the same partition key are assigned to the same fragment.</span></span> <span data-ttu-id="93b55-142">If the fragment is temporarily unavailable, Service Bus returns an error.</span><span class="sxs-lookup"><span data-stu-id="93b55-142">If the fragment is temporarily unavailable, Service Bus returns an error.</span></span>

<span data-ttu-id="93b55-143">Depending on the scenario, different message properties are used as a partition key:</span><span class="sxs-lookup"><span data-stu-id="93b55-143">Depending on the scenario, different message properties are used as a partition key:</span></span>

<span data-ttu-id="93b55-144">**SessionId**: If a message has the [BrokeredMessage.SessionId][BrokeredMessage.SessionId] property set, then Service Bus uses this property as the partition key.</span><span class="sxs-lookup"><span data-stu-id="93b55-144">**SessionId**: If a message has the [BrokeredMessage.SessionId][BrokeredMessage.SessionId] property set, then Service Bus uses this property as the partition key.</span></span> <span data-ttu-id="93b55-145">This way, all messages that belong to the same session are handled by the same message broker.</span><span class="sxs-lookup"><span data-stu-id="93b55-145">This way, all messages that belong to the same session are handled by the same message broker.</span></span> <span data-ttu-id="93b55-146">This enables Service Bus to guarantee message ordering as well as the consistency of session states.</span><span class="sxs-lookup"><span data-stu-id="93b55-146">This enables Service Bus to guarantee message ordering as well as the consistency of session states.</span></span>

<span data-ttu-id="93b55-147">**PartitionKey**: If a message has the [BrokeredMessage.PartitionKey][BrokeredMessage.PartitionKey] property but not the [BrokeredMessage.SessionId][BrokeredMessage.SessionId] property set, then Service Bus uses the [PartitionKey][PartitionKey] property as the partition key.</span><span class="sxs-lookup"><span data-stu-id="93b55-147">**PartitionKey**: If a message has the [BrokeredMessage.PartitionKey][BrokeredMessage.PartitionKey] property but not the [BrokeredMessage.SessionId][BrokeredMessage.SessionId] property set, then Service Bus uses the [PartitionKey][PartitionKey] property as the partition key.</span></span> <span data-ttu-id="93b55-148">If the message has both the [SessionId][SessionId] and the [PartitionKey][PartitionKey] properties set, both properties must be identical.</span><span class="sxs-lookup"><span data-stu-id="93b55-148">If the message has both the [SessionId][SessionId] and the [PartitionKey][PartitionKey] properties set, both properties must be identical.</span></span> <span data-ttu-id="93b55-149">If the [PartitionKey][PartitionKey] property is set to a different value than the [SessionId][SessionId] property, Service Bus returns an invalid operation exception.</span><span class="sxs-lookup"><span data-stu-id="93b55-149">If the [PartitionKey][PartitionKey] property is set to a different value than the [SessionId][SessionId] property, Service Bus returns an invalid operation exception.</span></span> <span data-ttu-id="93b55-150">The [PartitionKey][PartitionKey] property should be used if a sender sends non-session aware transactional messages.</span><span class="sxs-lookup"><span data-stu-id="93b55-150">The [PartitionKey][PartitionKey] property should be used if a sender sends non-session aware transactional messages.</span></span> <span data-ttu-id="93b55-151">The partition key ensures that all messages that are sent within a transaction are handled by the same messaging broker.</span><span class="sxs-lookup"><span data-stu-id="93b55-151">The partition key ensures that all messages that are sent within a transaction are handled by the same messaging broker.</span></span>

<span data-ttu-id="93b55-152">**MessageId**: If the queue or topic has the [QueueDescription.RequiresDuplicateDetection][QueueDescription.RequiresDuplicateDetection] property set to **true** and the [BrokeredMessage.SessionId][BrokeredMessage.SessionId] or [BrokeredMessage.PartitionKey][BrokeredMessage.PartitionKey] properties are not set, then the [BrokeredMessage.MessageId][BrokeredMessage.MessageId] property serves as the partition key.</span><span class="sxs-lookup"><span data-stu-id="93b55-152">**MessageId**: If the queue or topic has the [QueueDescription.RequiresDuplicateDetection][QueueDescription.RequiresDuplicateDetection] property set to **true** and the [BrokeredMessage.SessionId][BrokeredMessage.SessionId] or [BrokeredMessage.PartitionKey][BrokeredMessage.PartitionKey] properties are not set, then the [BrokeredMessage.MessageId][BrokeredMessage.MessageId] property serves as the partition key.</span></span> <span data-ttu-id="93b55-153">(Note that the Microsoft .NET and AMQP libraries automatically assign a message ID if the sending application does not.) In this case, all copies of the same message are handled by the same message broker.</span><span class="sxs-lookup"><span data-stu-id="93b55-153">(Note that the Microsoft .NET and AMQP libraries automatically assign a message ID if the sending application does not.) In this case, all copies of the same message are handled by the same message broker.</span></span> <span data-ttu-id="93b55-154">This enables Service Bus to detect and eliminate duplicate messages.</span><span class="sxs-lookup"><span data-stu-id="93b55-154">This enables Service Bus to detect and eliminate duplicate messages.</span></span> <span data-ttu-id="93b55-155">If the [QueueDescription.RequiresDuplicateDetection][QueueDescription.RequiresDuplicateDetection] property is not set to **true**, Service Bus does not consider the [MessageId][MessageId] property as a partition key.</span><span class="sxs-lookup"><span data-stu-id="93b55-155">If the [QueueDescription.RequiresDuplicateDetection][QueueDescription.RequiresDuplicateDetection] property is not set to **true**, Service Bus does not consider the [MessageId][MessageId] property as a partition key.</span></span>

### <a name="not-using-a-partition-key"></a><span data-ttu-id="93b55-156">Not using a partition key</span><span class="sxs-lookup"><span data-stu-id="93b55-156">Not using a partition key</span></span>
<span data-ttu-id="93b55-157">In the absence of a partition key, Service Bus distributes messages in a round-robin fashion to all the fragments of the partitioned queue or topic.</span><span class="sxs-lookup"><span data-stu-id="93b55-157">In the absence of a partition key, Service Bus distributes messages in a round-robin fashion to all the fragments of the partitioned queue or topic.</span></span> <span data-ttu-id="93b55-158">If the chosen fragment is not available, Service Bus assigns the message to a different fragment.</span><span class="sxs-lookup"><span data-stu-id="93b55-158">If the chosen fragment is not available, Service Bus assigns the message to a different fragment.</span></span> <span data-ttu-id="93b55-159">This way, the send operation succeeds despite the temporary unavailability of a messaging store.</span><span class="sxs-lookup"><span data-stu-id="93b55-159">This way, the send operation succeeds despite the temporary unavailability of a messaging store.</span></span> <span data-ttu-id="93b55-160">However, you will not achieve the guaranteed ordering that a partition key provides.</span><span class="sxs-lookup"><span data-stu-id="93b55-160">However, you will not achieve the guaranteed ordering that a partition key provides.</span></span>

<span data-ttu-id="93b55-161">For a more in-depth discussion of the tradeoff between availability (no partition key) and consistency (using a partition key), see [this article](../event-hubs/event-hubs-availability-and-consistency.md).</span><span class="sxs-lookup"><span data-stu-id="93b55-161">For a more in-depth discussion of the tradeoff between availability (no partition key) and consistency (using a partition key), see [this article](../event-hubs/event-hubs-availability-and-consistency.md).</span></span> <span data-ttu-id="93b55-162">This information applies equally to partitioned Service Bus entities and Event Hubs partitions.</span><span class="sxs-lookup"><span data-stu-id="93b55-162">This information applies equally to partitioned Service Bus entities and Event Hubs partitions.</span></span>

<span data-ttu-id="93b55-163">To give Service Bus enough time to enqueue the message into a different fragment, the [MessagingFactorySettings.OperationTimeout][MessagingFactorySettings.OperationTimeout] value specified by the client that sends the message must be greater than 15 seconds.</span><span class="sxs-lookup"><span data-stu-id="93b55-163">To give Service Bus enough time to enqueue the message into a different fragment, the [MessagingFactorySettings.OperationTimeout][MessagingFactorySettings.OperationTimeout] value specified by the client that sends the message must be greater than 15 seconds.</span></span> <span data-ttu-id="93b55-164">It is recommended that you set the [OperationTimeout][OperationTimeout] property to the default value of 60 seconds.</span><span class="sxs-lookup"><span data-stu-id="93b55-164">It is recommended that you set the [OperationTimeout][OperationTimeout] property to the default value of 60 seconds.</span></span>

<span data-ttu-id="93b55-165">Note that a partition key "pins" a message to a specific fragment.</span><span class="sxs-lookup"><span data-stu-id="93b55-165">Note that a partition key "pins" a message to a specific fragment.</span></span> <span data-ttu-id="93b55-166">If the messaging store that holds this fragment is unavailable, Service Bus returns an error.</span><span class="sxs-lookup"><span data-stu-id="93b55-166">If the messaging store that holds this fragment is unavailable, Service Bus returns an error.</span></span> <span data-ttu-id="93b55-167">In the absence of a partition key, Service Bus can choose a different fragment and the operation succeeds.</span><span class="sxs-lookup"><span data-stu-id="93b55-167">In the absence of a partition key, Service Bus can choose a different fragment and the operation succeeds.</span></span> <span data-ttu-id="93b55-168">Therefore, it is recommended that you do not supply a partition key unless it is required.</span><span class="sxs-lookup"><span data-stu-id="93b55-168">Therefore, it is recommended that you do not supply a partition key unless it is required.</span></span>

## <a name="advanced-topics-use-transactions-with-partitioned-entities"></a><span data-ttu-id="93b55-169">Advanced topics: use transactions with partitioned entities</span><span class="sxs-lookup"><span data-stu-id="93b55-169">Advanced topics: use transactions with partitioned entities</span></span>
<span data-ttu-id="93b55-170">Messages that are sent as part of a transaction must specify a partition key.</span><span class="sxs-lookup"><span data-stu-id="93b55-170">Messages that are sent as part of a transaction must specify a partition key.</span></span> <span data-ttu-id="93b55-171">This can be one of the following properties: [BrokeredMessage.SessionId][BrokeredMessage.SessionId], [BrokeredMessage.PartitionKey][BrokeredMessage.PartitionKey], or [BrokeredMessage.MessageId][BrokeredMessage.MessageId].</span><span class="sxs-lookup"><span data-stu-id="93b55-171">This can be one of the following properties: [BrokeredMessage.SessionId][BrokeredMessage.SessionId], [BrokeredMessage.PartitionKey][BrokeredMessage.PartitionKey], or [BrokeredMessage.MessageId][BrokeredMessage.MessageId].</span></span> <span data-ttu-id="93b55-172">All messages that are sent as part of the same transaction must specify the same partition key.</span><span class="sxs-lookup"><span data-stu-id="93b55-172">All messages that are sent as part of the same transaction must specify the same partition key.</span></span> <span data-ttu-id="93b55-173">If you attempt to send a message without a partition key within a transaction, Service Bus returns an invalid operation exception.</span><span class="sxs-lookup"><span data-stu-id="93b55-173">If you attempt to send a message without a partition key within a transaction, Service Bus returns an invalid operation exception.</span></span> <span data-ttu-id="93b55-174">If you attempt to send multiple messages within the same transaction that have different partition keys, Service Bus returns an invalid operation exception.</span><span class="sxs-lookup"><span data-stu-id="93b55-174">If you attempt to send multiple messages within the same transaction that have different partition keys, Service Bus returns an invalid operation exception.</span></span> <span data-ttu-id="93b55-175">For example:</span><span class="sxs-lookup"><span data-stu-id="93b55-175">For example:</span></span>

```csharp
CommittableTransaction committableTransaction = new CommittableTransaction();
using (TransactionScope ts = new TransactionScope(committableTransaction))
{
    BrokeredMessage msg = new BrokeredMessage("This is a message");
    msg.PartitionKey = "myPartitionKey";
    messageSender.Send(msg); 
    ts.Complete();
}
committableTransaction.Commit();
```

<span data-ttu-id="93b55-176">If any of the properties that serve as a partition key are set, Service Bus pins the message to a specific fragment.</span><span class="sxs-lookup"><span data-stu-id="93b55-176">If any of the properties that serve as a partition key are set, Service Bus pins the message to a specific fragment.</span></span> <span data-ttu-id="93b55-177">This behavior occurs whether or not a transaction is used.</span><span class="sxs-lookup"><span data-stu-id="93b55-177">This behavior occurs whether or not a transaction is used.</span></span> <span data-ttu-id="93b55-178">It is recommended that you do not specify a partition key if it is not necessary.</span><span class="sxs-lookup"><span data-stu-id="93b55-178">It is recommended that you do not specify a partition key if it is not necessary.</span></span>

## <a name="using-sessions-with-partitioned-entities"></a><span data-ttu-id="93b55-179">Using sessions with partitioned entities</span><span class="sxs-lookup"><span data-stu-id="93b55-179">Using sessions with partitioned entities</span></span>
<span data-ttu-id="93b55-180">To send a transactional message to a session-aware topic or queue, the message must have the [BrokeredMessage.SessionId][BrokeredMessage.SessionId] property set.</span><span class="sxs-lookup"><span data-stu-id="93b55-180">To send a transactional message to a session-aware topic or queue, the message must have the [BrokeredMessage.SessionId][BrokeredMessage.SessionId] property set.</span></span> <span data-ttu-id="93b55-181">If the [BrokeredMessage.PartitionKey][BrokeredMessage.PartitionKey] property is specified as well, it must be identical to the [SessionId][SessionId] property.</span><span class="sxs-lookup"><span data-stu-id="93b55-181">If the [BrokeredMessage.PartitionKey][BrokeredMessage.PartitionKey] property is specified as well, it must be identical to the [SessionId][SessionId] property.</span></span> <span data-ttu-id="93b55-182">If they differ, Service Bus returns an invalid operation exception.</span><span class="sxs-lookup"><span data-stu-id="93b55-182">If they differ, Service Bus returns an invalid operation exception.</span></span>

<span data-ttu-id="93b55-183">Unlike regular (non-partitioned) queues or topics, it is not possible to use a single transaction to send multiple messages to different sessions.</span><span class="sxs-lookup"><span data-stu-id="93b55-183">Unlike regular (non-partitioned) queues or topics, it is not possible to use a single transaction to send multiple messages to different sessions.</span></span> <span data-ttu-id="93b55-184">If attempted, Service Bus returns an invalid operation exception.</span><span class="sxs-lookup"><span data-stu-id="93b55-184">If attempted, Service Bus returns an invalid operation exception.</span></span> <span data-ttu-id="93b55-185">For example:</span><span class="sxs-lookup"><span data-stu-id="93b55-185">For example:</span></span>

```csharp
CommittableTransaction committableTransaction = new CommittableTransaction();
using (TransactionScope ts = new TransactionScope(committableTransaction))
{
    BrokeredMessage msg = new BrokeredMessage("This is a message");
    msg.SessionId = "mySession";
    messageSender.Send(msg); 
    ts.Complete();
}
committableTransaction.Commit();
```

## <a name="automatic-message-forwarding-with-partitioned-entities"></a><span data-ttu-id="93b55-186">Automatic message forwarding with partitioned entities</span><span class="sxs-lookup"><span data-stu-id="93b55-186">Automatic message forwarding with partitioned entities</span></span>
<span data-ttu-id="93b55-187">Service Bus supports automatic message forwarding from, to, or between partitioned entities.</span><span class="sxs-lookup"><span data-stu-id="93b55-187">Service Bus supports automatic message forwarding from, to, or between partitioned entities.</span></span> <span data-ttu-id="93b55-188">To enable automatic message forwarding, set the [QueueDescription.ForwardTo][QueueDescription.ForwardTo] property on the source queue or subscription.</span><span class="sxs-lookup"><span data-stu-id="93b55-188">To enable automatic message forwarding, set the [QueueDescription.ForwardTo][QueueDescription.ForwardTo] property on the source queue or subscription.</span></span> <span data-ttu-id="93b55-189">If the message specifies a partition key ([SessionId][SessionId], [PartitionKey][PartitionKey], or [MessageId][MessageId]), that partition key is used for the destination entity.</span><span class="sxs-lookup"><span data-stu-id="93b55-189">If the message specifies a partition key ([SessionId][SessionId], [PartitionKey][PartitionKey], or [MessageId][MessageId]), that partition key is used for the destination entity.</span></span>

## <a name="considerations-and-guidelines"></a><span data-ttu-id="93b55-190">Considerations and guidelines</span><span class="sxs-lookup"><span data-stu-id="93b55-190">Considerations and guidelines</span></span>
* <span data-ttu-id="93b55-191">**High consistency features**: If an entity uses features such as sessions, duplicate detection, or explicit control of partitioning key, then the messaging operations are always routed to specific fragments.</span><span class="sxs-lookup"><span data-stu-id="93b55-191">**High consistency features**: If an entity uses features such as sessions, duplicate detection, or explicit control of partitioning key, then the messaging operations are always routed to specific fragments.</span></span> <span data-ttu-id="93b55-192">If any of the fragments experience high traffic or the underlying store is unhealthy, those operations fail and availability is reduced.</span><span class="sxs-lookup"><span data-stu-id="93b55-192">If any of the fragments experience high traffic or the underlying store is unhealthy, those operations fail and availability is reduced.</span></span> <span data-ttu-id="93b55-193">Overall, the consistency is still much higher than non-partitioned entities; only a subset of traffic is experiencing issues, as opposed to all the traffic.</span><span class="sxs-lookup"><span data-stu-id="93b55-193">Overall, the consistency is still much higher than non-partitioned entities; only a subset of traffic is experiencing issues, as opposed to all the traffic.</span></span> <span data-ttu-id="93b55-194">For more information, see this [discussion of availability and consistency](../event-hubs/event-hubs-availability-and-consistency.md).</span><span class="sxs-lookup"><span data-stu-id="93b55-194">For more information, see this [discussion of availability and consistency](../event-hubs/event-hubs-availability-and-consistency.md).</span></span>
* <span data-ttu-id="93b55-195">**Management**: Operations such as Create, Update and Delete must be performed on all the fragments of the entity.</span><span class="sxs-lookup"><span data-stu-id="93b55-195">**Management**: Operations such as Create, Update and Delete must be performed on all the fragments of the entity.</span></span> <span data-ttu-id="93b55-196">If any fragment is unhealthy it could result in failures for these operations.</span><span class="sxs-lookup"><span data-stu-id="93b55-196">If any fragment is unhealthy it could result in failures for these operations.</span></span> <span data-ttu-id="93b55-197">For the Get operation, information such as message counts must be aggregated from all fragments.</span><span class="sxs-lookup"><span data-stu-id="93b55-197">For the Get operation, information such as message counts must be aggregated from all fragments.</span></span> <span data-ttu-id="93b55-198">If any fragment is unhealthy, the entity availability status is reported as limited.</span><span class="sxs-lookup"><span data-stu-id="93b55-198">If any fragment is unhealthy, the entity availability status is reported as limited.</span></span>
* <span data-ttu-id="93b55-199">**Low volume message scenarios**: For such scenarios, especially when using the HTTP protocol, you may have to perform multiple receive operations in order to obtain all the messages.</span><span class="sxs-lookup"><span data-stu-id="93b55-199">**Low volume message scenarios**: For such scenarios, especially when using the HTTP protocol, you may have to perform multiple receive operations in order to obtain all the messages.</span></span> <span data-ttu-id="93b55-200">For receive requests, the front end performs a receive on all the fragments and caches all the responses received.</span><span class="sxs-lookup"><span data-stu-id="93b55-200">For receive requests, the front end performs a receive on all the fragments and caches all the responses received.</span></span> <span data-ttu-id="93b55-201">A subsequent receive request on the same connection would benefit from this caching and receive latencies will be lower.</span><span class="sxs-lookup"><span data-stu-id="93b55-201">A subsequent receive request on the same connection would benefit from this caching and receive latencies will be lower.</span></span> <span data-ttu-id="93b55-202">However, if you have multiple connections or use HTTP, that establishes a new connection for each request.</span><span class="sxs-lookup"><span data-stu-id="93b55-202">However, if you have multiple connections or use HTTP, that establishes a new connection for each request.</span></span> <span data-ttu-id="93b55-203">As such, there is no guarantee that it would land on the same node.</span><span class="sxs-lookup"><span data-stu-id="93b55-203">As such, there is no guarantee that it would land on the same node.</span></span> <span data-ttu-id="93b55-204">If all existing messages are locked and cached in another front end, the receive operation returns **null**.</span><span class="sxs-lookup"><span data-stu-id="93b55-204">If all existing messages are locked and cached in another front end, the receive operation returns **null**.</span></span> <span data-ttu-id="93b55-205">Messages eventually expire and you can receive them again.</span><span class="sxs-lookup"><span data-stu-id="93b55-205">Messages eventually expire and you can receive them again.</span></span> <span data-ttu-id="93b55-206">HTTP keep-alive is recommended.</span><span class="sxs-lookup"><span data-stu-id="93b55-206">HTTP keep-alive is recommended.</span></span>
* <span data-ttu-id="93b55-207">**Browse/Peek messages**: [PeekBatch](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_PeekBatch_System_Int32_) does not always return the number of messages specified in the [MessageCount](/dotnet/api/microsoft.servicebus.messaging.queuedescription#Microsoft_ServiceBus_Messaging_QueueDescription_MessageCount) property.</span><span class="sxs-lookup"><span data-stu-id="93b55-207">**Browse/Peek messages**: [PeekBatch](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_PeekBatch_System_Int32_) does not always return the number of messages specified in the [MessageCount](/dotnet/api/microsoft.servicebus.messaging.queuedescription#Microsoft_ServiceBus_Messaging_QueueDescription_MessageCount) property.</span></span> <span data-ttu-id="93b55-208">There are two common reasons for this.</span><span class="sxs-lookup"><span data-stu-id="93b55-208">There are two common reasons for this.</span></span> <span data-ttu-id="93b55-209">One reason is that the aggregated size of the collection of messages exceeds the maximum size of 256KB.</span><span class="sxs-lookup"><span data-stu-id="93b55-209">One reason is that the aggregated size of the collection of messages exceeds the maximum size of 256KB.</span></span> <span data-ttu-id="93b55-210">Another reason is that if the queue or topic has the [EnablePartitioning property](/dotnet/api/microsoft.servicebus.messaging.queuedescription#Microsoft_ServiceBus_Messaging_QueueDescription_EnablePartitioning) set to **true**, a partition may not have enough messages to complete the requested number of messages.</span><span class="sxs-lookup"><span data-stu-id="93b55-210">Another reason is that if the queue or topic has the [EnablePartitioning property](/dotnet/api/microsoft.servicebus.messaging.queuedescription#Microsoft_ServiceBus_Messaging_QueueDescription_EnablePartitioning) set to **true**, a partition may not have enough messages to complete the requested number of messages.</span></span> <span data-ttu-id="93b55-211">In general, if an application wants to receive a specific number of messages, it should call [PeekBatch](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_PeekBatch_System_Int32_) repeatedly until it gets that number of messages, or there are no more messages to peek.</span><span class="sxs-lookup"><span data-stu-id="93b55-211">In general, if an application wants to receive a specific number of messages, it should call [PeekBatch](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_PeekBatch_System_Int32_) repeatedly until it gets that number of messages, or there are no more messages to peek.</span></span> <span data-ttu-id="93b55-212">For more information, including code samples, see [QueueClient.PeekBatch](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_PeekBatch_System_Int32_) or [SubscriptionClient.PeekBatch](/dotnet/api/microsoft.servicebus.messaging.subscriptionclient#Microsoft_ServiceBus_Messaging_SubscriptionClient_PeekBatch_System_Int32_).</span><span class="sxs-lookup"><span data-stu-id="93b55-212">For more information, including code samples, see [QueueClient.PeekBatch](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_PeekBatch_System_Int32_) or [SubscriptionClient.PeekBatch](/dotnet/api/microsoft.servicebus.messaging.subscriptionclient#Microsoft_ServiceBus_Messaging_SubscriptionClient_PeekBatch_System_Int32_).</span></span>

## <a name="latest-added-features"></a><span data-ttu-id="93b55-213">Latest added features</span><span class="sxs-lookup"><span data-stu-id="93b55-213">Latest added features</span></span>
* <span data-ttu-id="93b55-214">Add or remove rule is now supported with partitioned entities.</span><span class="sxs-lookup"><span data-stu-id="93b55-214">Add or remove rule is now supported with partitioned entities.</span></span> <span data-ttu-id="93b55-215">Different from non-partitioned entities, these operations are not supported under transactions.</span><span class="sxs-lookup"><span data-stu-id="93b55-215">Different from non-partitioned entities, these operations are not supported under transactions.</span></span> 
* <span data-ttu-id="93b55-216">AMQP is now supported for sending and receiving messages to and from a partitioned entity.</span><span class="sxs-lookup"><span data-stu-id="93b55-216">AMQP is now supported for sending and receiving messages to and from a partitioned entity.</span></span>
* <span data-ttu-id="93b55-217">AMQP is now supported for the following operations: [Batch Send](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_SendBatch_System_Collections_Generic_IEnumerable_Microsoft_ServiceBus_Messaging_BrokeredMessage__), [Batch Receive](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_ReceiveBatch_System_Int32_), [Receive by Sequence Number](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_Receive_System_Int64_), [Peek](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_Peek), [Renew Lock](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_RenewMessageLock_System_Guid_), [Schedule Message](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_ScheduleMessageAsync_Microsoft_ServiceBus_Messaging_BrokeredMessage_System_DateTimeOffset_), [Cancel Scheduled Message](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_CancelScheduledMessageAsync_System_Int64_), [Add Rule](/dotnet/api/microsoft.servicebus.messaging.ruledescription), [Remove Rule](/dotnet/api/microsoft.servicebus.messaging.ruledescription), [Session Renew Lock](/dotnet/api/microsoft.servicebus.messaging.messagesession#Microsoft_ServiceBus_Messaging_MessageSession_RenewLock), [Set Session State](/dotnet/api/microsoft.servicebus.messaging.messagesession#Microsoft_ServiceBus_Messaging_MessageSession_SetState_System_IO_Stream_), [Get Session State](/dotnet/api/microsoft.servicebus.messaging.messagesession#Microsoft_ServiceBus_Messaging_MessageSession_GetState), and [Enumerate Sessions](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_GetMessageSessionsAsync).</span><span class="sxs-lookup"><span data-stu-id="93b55-217">AMQP is now supported for the following operations: [Batch Send](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_SendBatch_System_Collections_Generic_IEnumerable_Microsoft_ServiceBus_Messaging_BrokeredMessage__), [Batch Receive](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_ReceiveBatch_System_Int32_), [Receive by Sequence Number](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_Receive_System_Int64_), [Peek](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_Peek), [Renew Lock](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_RenewMessageLock_System_Guid_), [Schedule Message](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_ScheduleMessageAsync_Microsoft_ServiceBus_Messaging_BrokeredMessage_System_DateTimeOffset_), [Cancel Scheduled Message](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_CancelScheduledMessageAsync_System_Int64_), [Add Rule](/dotnet/api/microsoft.servicebus.messaging.ruledescription), [Remove Rule](/dotnet/api/microsoft.servicebus.messaging.ruledescription), [Session Renew Lock](/dotnet/api/microsoft.servicebus.messaging.messagesession#Microsoft_ServiceBus_Messaging_MessageSession_RenewLock), [Set Session State](/dotnet/api/microsoft.servicebus.messaging.messagesession#Microsoft_ServiceBus_Messaging_MessageSession_SetState_System_IO_Stream_), [Get Session State](/dotnet/api/microsoft.servicebus.messaging.messagesession#Microsoft_ServiceBus_Messaging_MessageSession_GetState), and [Enumerate Sessions](/dotnet/api/microsoft.servicebus.messaging.queueclient#Microsoft_ServiceBus_Messaging_QueueClient_GetMessageSessionsAsync).</span></span>

## <a name="partitioned-entities-limitations"></a><span data-ttu-id="93b55-218">Partitioned entities limitations</span><span class="sxs-lookup"><span data-stu-id="93b55-218">Partitioned entities limitations</span></span>
<span data-ttu-id="93b55-219">Currently Service Bus imposes the following limitations on partitioned queues and topics:</span><span class="sxs-lookup"><span data-stu-id="93b55-219">Currently Service Bus imposes the following limitations on partitioned queues and topics:</span></span>

* <span data-ttu-id="93b55-220">Partitioned queues and topics do not support sending messages that belong to different sessions in a single transaction.</span><span class="sxs-lookup"><span data-stu-id="93b55-220">Partitioned queues and topics do not support sending messages that belong to different sessions in a single transaction.</span></span>
* <span data-ttu-id="93b55-221">Service Bus currently allows up to 100 partitioned queues or topics per namespace.</span><span class="sxs-lookup"><span data-stu-id="93b55-221">Service Bus currently allows up to 100 partitioned queues or topics per namespace.</span></span> <span data-ttu-id="93b55-222">Each partitioned queue or topic counts towards the quota of 10,000 entities per namespace (does not apply to Premium tier).</span><span class="sxs-lookup"><span data-stu-id="93b55-222">Each partitioned queue or topic counts towards the quota of 10,000 entities per namespace (does not apply to Premium tier).</span></span>

## <a name="next-steps"></a><span data-ttu-id="93b55-223">Next steps</span><span class="sxs-lookup"><span data-stu-id="93b55-223">Next steps</span></span>
<span data-ttu-id="93b55-224">See the discussion of [AMQP 1.0 support for Service Bus partitioned queues and topics][AMQP 1.0 support for Service Bus partitioned queues and topics] to learn more about partitioning messaging entities.</span><span class="sxs-lookup"><span data-stu-id="93b55-224">See the discussion of [AMQP 1.0 support for Service Bus partitioned queues and topics][AMQP 1.0 support for Service Bus partitioned queues and topics] to learn more about partitioning messaging entities.</span></span> 

[Service Bus architecture]: service-bus-architecture.md
[Azure portal]: https://portal.azure.com
[QueueDescription.EnablePartitioning]: /dotnet/api/microsoft.servicebus.messaging.queuedescription#Microsoft_ServiceBus_Messaging_QueueDescription_EnablePartitioning
[TopicDescription.EnablePartitioning]: /dotnet/api/microsoft.servicebus.messaging.topicdescription#Microsoft_ServiceBus_Messaging_TopicDescription_EnablePartitioning
[BrokeredMessage.SessionId]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_SessionId
[BrokeredMessage.PartitionKey]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_PartitionKey
[SessionId]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_SessionId
[PartitionKey]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_PartitionKey
[QueueDescription.RequiresDuplicateDetection]: /dotnet/api/microsoft.servicebus.messaging.queuedescription#Microsoft_ServiceBus_Messaging_QueueDescription_RequiresDuplicateDetection
[BrokeredMessage.MessageId]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_MessageId
[MessageId]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Microsoft_ServiceBus_Messaging_BrokeredMessage_MessageId
[MessagingFactorySettings.OperationTimeout]: /dotnet/api/microsoft.servicebus.messaging.messagingfactorysettings#Microsoft_ServiceBus_Messaging_MessagingFactorySettings_OperationTimeout
[OperationTimeout]: /dotnet/api/microsoft.servicebus.messaging.messagingfactorysettings#Microsoft_ServiceBus_Messaging_MessagingFactorySettings_OperationTimeout
[QueueDescription.ForwardTo]: /dotnet/api/microsoft.servicebus.messaging.queuedescription#Microsoft_ServiceBus_Messaging_QueueDescription_ForwardTo
[AMQP 1.0 support for Service Bus partitioned queues and topics]: service-bus-partitioned-queues-and-topics-amqp-overview.md
