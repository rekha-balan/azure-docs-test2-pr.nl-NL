---
title: Azure IoT Hub Device Provisioning Service - TPM Attestation
description: This article provides a conceptual overview of the TPM attestation flow using IoT Device Provisioning Service.
author: nberdy
ms.author: nberdy
ms.date: 04/23/2018
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
manager: briz
ms.openlocfilehash: cb763327eb292feb9d58fb21b1ca808a3f2909aa
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44866119"
---
# <a name="tpm-attestation"></a><span data-ttu-id="220a7-103">TPM attestation</span><span class="sxs-lookup"><span data-stu-id="220a7-103">TPM attestation</span></span>

<span data-ttu-id="220a7-104">IoT Hub Device Provisioning Service is a helper service for IoT Hub that you use to configure zero-touch device provisioning to a specified IoT hub.</span><span class="sxs-lookup"><span data-stu-id="220a7-104">IoT Hub Device Provisioning Service is a helper service for IoT Hub that you use to configure zero-touch device provisioning to a specified IoT hub.</span></span> <span data-ttu-id="220a7-105">With the Device Provisioning Service, you can provision millions of devices in a secure manner.</span><span class="sxs-lookup"><span data-stu-id="220a7-105">With the Device Provisioning Service, you can provision millions of devices in a secure manner.</span></span>

<span data-ttu-id="220a7-106">This article describes the identity attestation process when using a [TPM](./concepts-device.md).</span><span class="sxs-lookup"><span data-stu-id="220a7-106">This article describes the identity attestation process when using a [TPM](./concepts-device.md).</span></span> <span data-ttu-id="220a7-107">TPM stands for Trusted Platform Module and is a type of hardware security module (HSM).</span><span class="sxs-lookup"><span data-stu-id="220a7-107">TPM stands for Trusted Platform Module and is a type of hardware security module (HSM).</span></span> <span data-ttu-id="220a7-108">This article assumes you are using a discrete, firmware, or integrated TPM.</span><span class="sxs-lookup"><span data-stu-id="220a7-108">This article assumes you are using a discrete, firmware, or integrated TPM.</span></span> <span data-ttu-id="220a7-109">Software emulated TPMs are well-suited for prototyping or testing, but they do not provide the same level of security as discrete, firmware, or integrated TPMs do.</span><span class="sxs-lookup"><span data-stu-id="220a7-109">Software emulated TPMs are well-suited for prototyping or testing, but they do not provide the same level of security as discrete, firmware, or integrated TPMs do.</span></span> <span data-ttu-id="220a7-110">We do not recommend using software TPMs in production.</span><span class="sxs-lookup"><span data-stu-id="220a7-110">We do not recommend using software TPMs in production.</span></span> <span data-ttu-id="220a7-111">For more information about types of TPMs, see [A Brief Introduction to TPM](http://trustedcomputinggroup.org/wp-content/uploads/TPM-2.0-A-Brief-Introduction.pdf).</span><span class="sxs-lookup"><span data-stu-id="220a7-111">For more information about types of TPMs, see [A Brief Introduction to TPM](http://trustedcomputinggroup.org/wp-content/uploads/TPM-2.0-A-Brief-Introduction.pdf).</span></span>

<span data-ttu-id="220a7-112">This article is only relevant for devices using TPM 2.0 with HMAC key support and their endorsement keys.</span><span class="sxs-lookup"><span data-stu-id="220a7-112">This article is only relevant for devices using TPM 2.0 with HMAC key support and their endorsement keys.</span></span> <span data-ttu-id="220a7-113">It is not for devices using X.509 certificates for authentication.</span><span class="sxs-lookup"><span data-stu-id="220a7-113">It is not for devices using X.509 certificates for authentication.</span></span> <span data-ttu-id="220a7-114">TPM is an industry-wide, ISO standard from the Trusted Computing Group, and you can read more about TPM at the [complete TPM 2.0 spec](https://trustedcomputinggroup.org/tpm-library-specification/) or the [ISO/IEC 11889 spec](https://www.iso.org/standard/66510.html). This article also assumes you are familiar with public and private key pairs, and how they are used for encryption.</span><span class="sxs-lookup"><span data-stu-id="220a7-114">TPM is an industry-wide, ISO standard from the Trusted Computing Group, and you can read more about TPM at the [complete TPM 2.0 spec](https://trustedcomputinggroup.org/tpm-library-specification/) or the [ISO/IEC 11889 spec](https://www.iso.org/standard/66510.html). This article also assumes you are familiar with public and private key pairs, and how they are used for encryption.</span></span>

<span data-ttu-id="220a7-115">The Device Provisioning Service device SDKs handle everything that is described in this article for you.</span><span class="sxs-lookup"><span data-stu-id="220a7-115">The Device Provisioning Service device SDKs handle everything that is described in this article for you.</span></span> <span data-ttu-id="220a7-116">There is no need for you to implement anything additional if you are using the SDKs on your devices.</span><span class="sxs-lookup"><span data-stu-id="220a7-116">There is no need for you to implement anything additional if you are using the SDKs on your devices.</span></span> <span data-ttu-id="220a7-117">This article helps you understand conceptually what’s going on with your TPM security chip when your device provisions and why it’s so secure.</span><span class="sxs-lookup"><span data-stu-id="220a7-117">This article helps you understand conceptually what’s going on with your TPM security chip when your device provisions and why it’s so secure.</span></span>

## <a name="overview"></a><span data-ttu-id="220a7-118">Overview</span><span class="sxs-lookup"><span data-stu-id="220a7-118">Overview</span></span>

<span data-ttu-id="220a7-119">TPMs use something called the endorsement key (EK) as the secure root of trust.</span><span class="sxs-lookup"><span data-stu-id="220a7-119">TPMs use something called the endorsement key (EK) as the secure root of trust.</span></span> <span data-ttu-id="220a7-120">The EK is unique to the TPM and changing it essentially changes the device into a new one.</span><span class="sxs-lookup"><span data-stu-id="220a7-120">The EK is unique to the TPM and changing it essentially changes the device into a new one.</span></span>

<span data-ttu-id="220a7-121">There's another type of key that TPMs have, called the storage root key (SRK).</span><span class="sxs-lookup"><span data-stu-id="220a7-121">There's another type of key that TPMs have, called the storage root key (SRK).</span></span> <span data-ttu-id="220a7-122">An SRK may be generated by the TPM's owner after it takes ownership of the TPM.</span><span class="sxs-lookup"><span data-stu-id="220a7-122">An SRK may be generated by the TPM's owner after it takes ownership of the TPM.</span></span> <span data-ttu-id="220a7-123">Taking ownership of the TPM is the TPM-specific way of saying "someone sets a password on the HSM."</span><span class="sxs-lookup"><span data-stu-id="220a7-123">Taking ownership of the TPM is the TPM-specific way of saying "someone sets a password on the HSM."</span></span> <span data-ttu-id="220a7-124">If a TPM device is sold to a new owner, the new owner can take ownership of the TPM to generate a new SRK.</span><span class="sxs-lookup"><span data-stu-id="220a7-124">If a TPM device is sold to a new owner, the new owner can take ownership of the TPM to generate a new SRK.</span></span> <span data-ttu-id="220a7-125">The new SRK generation ensures the previous owner can't use the TPM.</span><span class="sxs-lookup"><span data-stu-id="220a7-125">The new SRK generation ensures the previous owner can't use the TPM.</span></span> <span data-ttu-id="220a7-126">Because the SRK is unique to the owner of the TPM, the SRK can be used to seal data into the TPM itself for that owner.</span><span class="sxs-lookup"><span data-stu-id="220a7-126">Because the SRK is unique to the owner of the TPM, the SRK can be used to seal data into the TPM itself for that owner.</span></span> <span data-ttu-id="220a7-127">The SRK provides a sandbox for the owner to store their keys and provides access revocability if the device or TPM is sold.</span><span class="sxs-lookup"><span data-stu-id="220a7-127">The SRK provides a sandbox for the owner to store their keys and provides access revocability if the device or TPM is sold.</span></span> <span data-ttu-id="220a7-128">It's like moving into a new house: taking ownership is changing the locks on the doors and destroying all furniture left by the previous owners (SRK), but you can't change the address of the house (EK).</span><span class="sxs-lookup"><span data-stu-id="220a7-128">It's like moving into a new house: taking ownership is changing the locks on the doors and destroying all furniture left by the previous owners (SRK), but you can't change the address of the house (EK).</span></span>

<span data-ttu-id="220a7-129">Once a device has been set up and ready to use, it will have both an EK and an SRK available for use.</span><span class="sxs-lookup"><span data-stu-id="220a7-129">Once a device has been set up and ready to use, it will have both an EK and an SRK available for use.</span></span>

![Taking ownership of a TPM](./media/concepts-tpm-attestation/tpm-ownership.png)

<span data-ttu-id="220a7-131">One note on taking ownership of the TPM: Taking ownership of a TPM depends on many things, including TPM manufacturer, the set of TPM tools being used, and the device OS.</span><span class="sxs-lookup"><span data-stu-id="220a7-131">One note on taking ownership of the TPM: Taking ownership of a TPM depends on many things, including TPM manufacturer, the set of TPM tools being used, and the device OS.</span></span> <span data-ttu-id="220a7-132">Follow the instructions relevant to your system to take ownership.</span><span class="sxs-lookup"><span data-stu-id="220a7-132">Follow the instructions relevant to your system to take ownership.</span></span>

<span data-ttu-id="220a7-133">The Device Provisioning Service uses the public part of the EK (EK_pub) to identify and enroll devices.</span><span class="sxs-lookup"><span data-stu-id="220a7-133">The Device Provisioning Service uses the public part of the EK (EK_pub) to identify and enroll devices.</span></span> <span data-ttu-id="220a7-134">The device vendor can read the EK_pub during manufacture or final testing and upload the EK_pub to the provisioning service so that the device will be recognized when it connects to provision.</span><span class="sxs-lookup"><span data-stu-id="220a7-134">The device vendor can read the EK_pub during manufacture or final testing and upload the EK_pub to the provisioning service so that the device will be recognized when it connects to provision.</span></span> <span data-ttu-id="220a7-135">The Device Provisioning Service does not check the SRK or owner, so “clearing” the TPM erases customer data, but the EK (and other vendor data) is preserved and the device will still be recognized by the Device Provisioning Service when it connects to provision.</span><span class="sxs-lookup"><span data-stu-id="220a7-135">The Device Provisioning Service does not check the SRK or owner, so “clearing” the TPM erases customer data, but the EK (and other vendor data) is preserved and the device will still be recognized by the Device Provisioning Service when it connects to provision.</span></span>

## <a name="detailed-attestation-process"></a><span data-ttu-id="220a7-136">Detailed attestation process</span><span class="sxs-lookup"><span data-stu-id="220a7-136">Detailed attestation process</span></span>

<span data-ttu-id="220a7-137">When a device with a TPM first connects to the Device Provisioning Service, the service first checks the provided EK_pub against the EK_pub stored in the enrollment list.</span><span class="sxs-lookup"><span data-stu-id="220a7-137">When a device with a TPM first connects to the Device Provisioning Service, the service first checks the provided EK_pub against the EK_pub stored in the enrollment list.</span></span> <span data-ttu-id="220a7-138">If the EK_pubs do not match, the device is not allowed to provision.</span><span class="sxs-lookup"><span data-stu-id="220a7-138">If the EK_pubs do not match, the device is not allowed to provision.</span></span> <span data-ttu-id="220a7-139">If the EK_pubs do match, the service then requires the device to prove ownership of the private portion of the EK via a nonce challenge, which is a secure challenge used to prove identity.</span><span class="sxs-lookup"><span data-stu-id="220a7-139">If the EK_pubs do match, the service then requires the device to prove ownership of the private portion of the EK via a nonce challenge, which is a secure challenge used to prove identity.</span></span> <span data-ttu-id="220a7-140">The Device Provisioning Service generates a nonce and then encrypts it with the SRK and then the EK_pub, both of which are provided by the device during the initial registration call.</span><span class="sxs-lookup"><span data-stu-id="220a7-140">The Device Provisioning Service generates a nonce and then encrypts it with the SRK and then the EK_pub, both of which are provided by the device during the initial registration call.</span></span> <span data-ttu-id="220a7-141">The TPM always keeps the private portion of the EK secure.</span><span class="sxs-lookup"><span data-stu-id="220a7-141">The TPM always keeps the private portion of the EK secure.</span></span> <span data-ttu-id="220a7-142">This prevents counterfeiting and ensures SAS tokens are securely provisioned to authorized devices.</span><span class="sxs-lookup"><span data-stu-id="220a7-142">This prevents counterfeiting and ensures SAS tokens are securely provisioned to authorized devices.</span></span>

<span data-ttu-id="220a7-143">Let’s walk through the attestation process in detail.</span><span class="sxs-lookup"><span data-stu-id="220a7-143">Let’s walk through the attestation process in detail.</span></span>

### <a name="device-requests-an-iot-hub-assignment"></a><span data-ttu-id="220a7-144">Device requests an IoT Hub assignment</span><span class="sxs-lookup"><span data-stu-id="220a7-144">Device requests an IoT Hub assignment</span></span>

<span data-ttu-id="220a7-145">First the device connects to the Device Provisioning Service and requests to provision.</span><span class="sxs-lookup"><span data-stu-id="220a7-145">First the device connects to the Device Provisioning Service and requests to provision.</span></span> <span data-ttu-id="220a7-146">In doing so, the device provides the service with its registration ID, an ID scope, and the EK_pub and SRK_pub from the TPM.</span><span class="sxs-lookup"><span data-stu-id="220a7-146">In doing so, the device provides the service with its registration ID, an ID scope, and the EK_pub and SRK_pub from the TPM.</span></span> <span data-ttu-id="220a7-147">The service passes the encrypted nonce back to the device and asks the device to decrypt the nonce and use that to sign a SAS token to connect again and finish provisioning.</span><span class="sxs-lookup"><span data-stu-id="220a7-147">The service passes the encrypted nonce back to the device and asks the device to decrypt the nonce and use that to sign a SAS token to connect again and finish provisioning.</span></span>

![Device requests provisioning](./media/concepts-tpm-attestation/step-one-request-provisioning.png)

### <a name="nonce-challenge"></a><span data-ttu-id="220a7-149">Nonce challenge</span><span class="sxs-lookup"><span data-stu-id="220a7-149">Nonce challenge</span></span>

<span data-ttu-id="220a7-150">The device takes the nonce and uses the private portions of the EK and SRK to decrypt the nonce into the TPM; the order of nonce encryption delegates trust from the EK, which is immutable, to the SRK, which can change if a new owner takes ownership of the TPM.</span><span class="sxs-lookup"><span data-stu-id="220a7-150">The device takes the nonce and uses the private portions of the EK and SRK to decrypt the nonce into the TPM; the order of nonce encryption delegates trust from the EK, which is immutable, to the SRK, which can change if a new owner takes ownership of the TPM.</span></span>

![Decrypting the nonce](./media/concepts-tpm-attestation/step-two-nonce.png)

### <a name="validate-the-nonce-and-receive-credentials"></a><span data-ttu-id="220a7-152">Validate the nonce and receive credentials</span><span class="sxs-lookup"><span data-stu-id="220a7-152">Validate the nonce and receive credentials</span></span>

<span data-ttu-id="220a7-153">The device can then sign a SAS token using the decrypted nonce and reestablish a connection to the Device Provisioning Service using the signed SAS token.</span><span class="sxs-lookup"><span data-stu-id="220a7-153">The device can then sign a SAS token using the decrypted nonce and reestablish a connection to the Device Provisioning Service using the signed SAS token.</span></span> <span data-ttu-id="220a7-154">With the Nonce challenge completed, the service allows the device to provision.</span><span class="sxs-lookup"><span data-stu-id="220a7-154">With the Nonce challenge completed, the service allows the device to provision.</span></span>

![Device reestablishes connection to Device Provisioning Service to validate EK ownership](./media/concepts-tpm-attestation/step-three-validation.png)

## <a name="next-steps"></a><span data-ttu-id="220a7-156">Next steps</span><span class="sxs-lookup"><span data-stu-id="220a7-156">Next steps</span></span>

<span data-ttu-id="220a7-157">Now the device connects to IoT Hub, and you rest secure in the knowledge that your devices’ keys are securely stored.</span><span class="sxs-lookup"><span data-stu-id="220a7-157">Now the device connects to IoT Hub, and you rest secure in the knowledge that your devices’ keys are securely stored.</span></span> <span data-ttu-id="220a7-158">Now that you know how the Device Provisioning Service securely verifies a device’s identity using TPM, check out the following articles to learn more:</span><span class="sxs-lookup"><span data-stu-id="220a7-158">Now that you know how the Device Provisioning Service securely verifies a device’s identity using TPM, check out the following articles to learn more:</span></span>

* [<span data-ttu-id="220a7-159">Learn about all the concepts in auto-provisioning</span><span class="sxs-lookup"><span data-stu-id="220a7-159">Learn about all the concepts in auto-provisioning</span></span>](./concepts-auto-provisioning.md)
* <span data-ttu-id="220a7-160">[Get started using auto-provisioning](./quick-setup-auto-provision.md) using the SDKs to take care of the flow.</span><span class="sxs-lookup"><span data-stu-id="220a7-160">[Get started using auto-provisioning](./quick-setup-auto-provision.md) using the SDKs to take care of the flow.</span></span>
