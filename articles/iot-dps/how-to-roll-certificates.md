---
title: How to roll X.509 certificates in Azure IoT Hub Device Provisioning Service | Microsoft Docs
description: How to roll X.509 certificates with your Device Provisioning service instance
author: wesmc7777
ms.author: wesmc
ms.date: 08/06/2018
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
manager: timlt
ms.openlocfilehash: a8ba667e6af316620d7a8530f29a6640edada13d
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44870507"
---
# <a name="how-to-roll-x509-device-certificates"></a><span data-ttu-id="7903f-103">How to roll X.509 device certificates</span><span class="sxs-lookup"><span data-stu-id="7903f-103">How to roll X.509 device certificates</span></span>

<span data-ttu-id="7903f-104">During the lifecycle of your IoT solution, you'll need to roll certificates.</span><span class="sxs-lookup"><span data-stu-id="7903f-104">During the lifecycle of your IoT solution, you'll need to roll certificates.</span></span> <span data-ttu-id="7903f-105">Two of the main reasons for rolling certificates would be a security breach, and certificate expirations.</span><span class="sxs-lookup"><span data-stu-id="7903f-105">Two of the main reasons for rolling certificates would be a security breach, and certificate expirations.</span></span> 

<span data-ttu-id="7903f-106">Rolling certificates is a security best practice to help secure your system in the event of a breach.</span><span class="sxs-lookup"><span data-stu-id="7903f-106">Rolling certificates is a security best practice to help secure your system in the event of a breach.</span></span> <span data-ttu-id="7903f-107">As part of [Assume Breach Methodology](http://download.microsoft.com/download/C/1/9/C1990DBA-502F-4C2A-848D-392B93D9B9C3/Microsoft_Enterprise_Cloud_Red_Teaming.pdf), Microsoft advocates the need for having reactive security processes in place along with preventative measures.</span><span class="sxs-lookup"><span data-stu-id="7903f-107">As part of [Assume Breach Methodology](http://download.microsoft.com/download/C/1/9/C1990DBA-502F-4C2A-848D-392B93D9B9C3/Microsoft_Enterprise_Cloud_Red_Teaming.pdf), Microsoft advocates the need for having reactive security processes in place along with preventative measures.</span></span> <span data-ttu-id="7903f-108">Rolling your device certificates should be included as part of these security processes.</span><span class="sxs-lookup"><span data-stu-id="7903f-108">Rolling your device certificates should be included as part of these security processes.</span></span> <span data-ttu-id="7903f-109">The frequency in which you roll your certificates will depend on the security needs of your solution.</span><span class="sxs-lookup"><span data-stu-id="7903f-109">The frequency in which you roll your certificates will depend on the security needs of your solution.</span></span> <span data-ttu-id="7903f-110">Customers with solutions involving highly sensitive data may roll certificate daily, while others roll their certificates every couple years.</span><span class="sxs-lookup"><span data-stu-id="7903f-110">Customers with solutions involving highly sensitive data may roll certificate daily, while others roll their certificates every couple years.</span></span>

<span data-ttu-id="7903f-111">Rolling device certificates will involve updating the certificate stored on the device and the IoT hub.</span><span class="sxs-lookup"><span data-stu-id="7903f-111">Rolling device certificates will involve updating the certificate stored on the device and the IoT hub.</span></span> <span data-ttu-id="7903f-112">Afterwards, the device can reprovision itself with the IoT hub using normal [auto-provisioning](concepts-auto-provisioning.md) with the Device Provisioning Service.</span><span class="sxs-lookup"><span data-stu-id="7903f-112">Afterwards, the device can reprovision itself with the IoT hub using normal [auto-provisioning](concepts-auto-provisioning.md) with the Device Provisioning Service.</span></span>


## <a name="obtain-new-certificates"></a><span data-ttu-id="7903f-113">Obtain new certificates</span><span class="sxs-lookup"><span data-stu-id="7903f-113">Obtain new certificates</span></span>

<span data-ttu-id="7903f-114">There are many ways to obtain new certificates for your IoT devices.</span><span class="sxs-lookup"><span data-stu-id="7903f-114">There are many ways to obtain new certificates for your IoT devices.</span></span> <span data-ttu-id="7903f-115">These include obtaining certificates from the device factory, generating your own certificates, and having a third party manage certificate creation for you.</span><span class="sxs-lookup"><span data-stu-id="7903f-115">These include obtaining certificates from the device factory, generating your own certificates, and having a third party manage certificate creation for you.</span></span> 

<span data-ttu-id="7903f-116">Certificates are signed by each other to form a chain of trust from a root CA certificate to a [leaf certificate](concepts-security.md#end-entity-leaf-certificate).</span><span class="sxs-lookup"><span data-stu-id="7903f-116">Certificates are signed by each other to form a chain of trust from a root CA certificate to a [leaf certificate](concepts-security.md#end-entity-leaf-certificate).</span></span> <span data-ttu-id="7903f-117">A signing certificate is the certificate used to sign the leaf certificate at the end of the chain of trust.</span><span class="sxs-lookup"><span data-stu-id="7903f-117">A signing certificate is the certificate used to sign the leaf certificate at the end of the chain of trust.</span></span> <span data-ttu-id="7903f-118">A signing certificate can be a root CA certificate, or an intermediate certificate in chain of trust.</span><span class="sxs-lookup"><span data-stu-id="7903f-118">A signing certificate can be a root CA certificate, or an intermediate certificate in chain of trust.</span></span> <span data-ttu-id="7903f-119">For more information, see [X.509 certificates](concepts-security.md#x509-certificates).</span><span class="sxs-lookup"><span data-stu-id="7903f-119">For more information, see [X.509 certificates](concepts-security.md#x509-certificates).</span></span>
 
<span data-ttu-id="7903f-120">There are two different ways to obtain a signing certificate.</span><span class="sxs-lookup"><span data-stu-id="7903f-120">There are two different ways to obtain a signing certificate.</span></span> <span data-ttu-id="7903f-121">The first way, which is recommended for production systems, is to purchase a signing certificate from a root certificate authority (CA).</span><span class="sxs-lookup"><span data-stu-id="7903f-121">The first way, which is recommended for production systems, is to purchase a signing certificate from a root certificate authority (CA).</span></span> <span data-ttu-id="7903f-122">This way chains security down to a trusted source.</span><span class="sxs-lookup"><span data-stu-id="7903f-122">This way chains security down to a trusted source.</span></span> 

<span data-ttu-id="7903f-123">The second way is to create your own X.509 certificates using a tool like OpenSSL.</span><span class="sxs-lookup"><span data-stu-id="7903f-123">The second way is to create your own X.509 certificates using a tool like OpenSSL.</span></span> <span data-ttu-id="7903f-124">This approach is great for testing X.509 certificates but provides few guarantees around security.</span><span class="sxs-lookup"><span data-stu-id="7903f-124">This approach is great for testing X.509 certificates but provides few guarantees around security.</span></span> <span data-ttu-id="7903f-125">We recommend you only use this approach for testing unless you prepared to act as your own CA provider.</span><span class="sxs-lookup"><span data-stu-id="7903f-125">We recommend you only use this approach for testing unless you prepared to act as your own CA provider.</span></span>
 

## <a name="roll-the-certificate-on-the-device"></a><span data-ttu-id="7903f-126">Roll the certificate on the device</span><span class="sxs-lookup"><span data-stu-id="7903f-126">Roll the certificate on the device</span></span>

<span data-ttu-id="7903f-127">Certificates on a device should always be stored in a safe place like a [hardware security module (HSM)](concepts-device.md#hardware-security-module).</span><span class="sxs-lookup"><span data-stu-id="7903f-127">Certificates on a device should always be stored in a safe place like a [hardware security module (HSM)](concepts-device.md#hardware-security-module).</span></span> <span data-ttu-id="7903f-128">The way you roll device certificates will depend on how they were created and installed in the devices in the first place.</span><span class="sxs-lookup"><span data-stu-id="7903f-128">The way you roll device certificates will depend on how they were created and installed in the devices in the first place.</span></span> 

<span data-ttu-id="7903f-129">If you got your certificates from a third party, you must look into how they roll their certificates.</span><span class="sxs-lookup"><span data-stu-id="7903f-129">If you got your certificates from a third party, you must look into how they roll their certificates.</span></span> <span data-ttu-id="7903f-130">The process may be included in your arrangement with them, or it may be a separate service they offer.</span><span class="sxs-lookup"><span data-stu-id="7903f-130">The process may be included in your arrangement with them, or it may be a separate service they offer.</span></span> 

<span data-ttu-id="7903f-131">If you're managing your own device certificates, you'll have to build your own pipeline for updating certificates.</span><span class="sxs-lookup"><span data-stu-id="7903f-131">If you're managing your own device certificates, you'll have to build your own pipeline for updating certificates.</span></span> <span data-ttu-id="7903f-132">Make sure both old and new leaf certificates have the same common name (CN).</span><span class="sxs-lookup"><span data-stu-id="7903f-132">Make sure both old and new leaf certificates have the same common name (CN).</span></span> <span data-ttu-id="7903f-133">By having the same CN, the device can reprovision itself without creating a duplicate registration record.</span><span class="sxs-lookup"><span data-stu-id="7903f-133">By having the same CN, the device can reprovision itself without creating a duplicate registration record.</span></span>


## <a name="roll-the-certificate-in-the-iot-hub"></a><span data-ttu-id="7903f-134">Roll the certificate in the IoT hub</span><span class="sxs-lookup"><span data-stu-id="7903f-134">Roll the certificate in the IoT hub</span></span>

<span data-ttu-id="7903f-135">The device certificate can be manually added to an IoT hub.</span><span class="sxs-lookup"><span data-stu-id="7903f-135">The device certificate can be manually added to an IoT hub.</span></span> <span data-ttu-id="7903f-136">The certificate can also be automated using a Device Provisioning service instance.</span><span class="sxs-lookup"><span data-stu-id="7903f-136">The certificate can also be automated using a Device Provisioning service instance.</span></span> <span data-ttu-id="7903f-137">In this article, we'll assume a Device Provisioning service instance is being used to support auto-provisioning.</span><span class="sxs-lookup"><span data-stu-id="7903f-137">In this article, we'll assume a Device Provisioning service instance is being used to support auto-provisioning.</span></span>

<span data-ttu-id="7903f-138">When a device is initially provisioned through auto-provisioning, it boots-up, and contacts the provisioning service.</span><span class="sxs-lookup"><span data-stu-id="7903f-138">When a device is initially provisioned through auto-provisioning, it boots-up, and contacts the provisioning service.</span></span> <span data-ttu-id="7903f-139">The provisioning service responds by performing an identity check before creating a device identity in an IoT hub using the device’s leaf certificate as the credential.</span><span class="sxs-lookup"><span data-stu-id="7903f-139">The provisioning service responds by performing an identity check before creating a device identity in an IoT hub using the device’s leaf certificate as the credential.</span></span> <span data-ttu-id="7903f-140">The provisioning service then tells the device which IoT hub it's assigned to, and the device then uses its leaf certificate to authenticate and connect to the IoT hub.</span><span class="sxs-lookup"><span data-stu-id="7903f-140">The provisioning service then tells the device which IoT hub it's assigned to, and the device then uses its leaf certificate to authenticate and connect to the IoT hub.</span></span> 

<span data-ttu-id="7903f-141">Once a new leaf certificate has been rolled to the device, it can no longer connect to the IoT hub because it’s using a new certificate to connect.</span><span class="sxs-lookup"><span data-stu-id="7903f-141">Once a new leaf certificate has been rolled to the device, it can no longer connect to the IoT hub because it’s using a new certificate to connect.</span></span> <span data-ttu-id="7903f-142">The IoT hub only recognizes the device with the old certificate.</span><span class="sxs-lookup"><span data-stu-id="7903f-142">The IoT hub only recognizes the device with the old certificate.</span></span> <span data-ttu-id="7903f-143">The result of the device's connection attempt will be an "unauthorized" connection error.</span><span class="sxs-lookup"><span data-stu-id="7903f-143">The result of the device's connection attempt will be an "unauthorized" connection error.</span></span> <span data-ttu-id="7903f-144">To resolve this error, you must update the enrollment entry for the device to account for the device's new leaf certificate.</span><span class="sxs-lookup"><span data-stu-id="7903f-144">To resolve this error, you must update the enrollment entry for the device to account for the device's new leaf certificate.</span></span> <span data-ttu-id="7903f-145">Then the provisioning service can update the IoT Hub device registry information as needed when the device is reprovisioned.</span><span class="sxs-lookup"><span data-stu-id="7903f-145">Then the provisioning service can update the IoT Hub device registry information as needed when the device is reprovisioned.</span></span> 

<span data-ttu-id="7903f-146">One possible exception to this connection failure would be a scenario where you've created an [Enrollment Group](concepts-service.md#enrollment-group) for your device in the provisioning service.</span><span class="sxs-lookup"><span data-stu-id="7903f-146">One possible exception to this connection failure would be a scenario where you've created an [Enrollment Group](concepts-service.md#enrollment-group) for your device in the provisioning service.</span></span> <span data-ttu-id="7903f-147">In this case, if you aren't rolling the root or intermediate certificates in the device's certificate chain of trust, then the device will be recognized if the new certificate is part of the chain of trust defined in the enrollment group.</span><span class="sxs-lookup"><span data-stu-id="7903f-147">In this case, if you aren't rolling the root or intermediate certificates in the device's certificate chain of trust, then the device will be recognized if the new certificate is part of the chain of trust defined in the enrollment group.</span></span> <span data-ttu-id="7903f-148">If this scenario arises as a reaction to a security breach, you should at least blacklist the specific device certificates in the group that are considered to be breached.</span><span class="sxs-lookup"><span data-stu-id="7903f-148">If this scenario arises as a reaction to a security breach, you should at least blacklist the specific device certificates in the group that are considered to be breached.</span></span> <span data-ttu-id="7903f-149">For more information, see [Blacklist specific devices in an enrollment group](https://docs.microsoft.com/en-us/azure/iot-dps/how-to-revoke-device-access-portal#blacklist-specific-devices-in-an-enrollment-group).</span><span class="sxs-lookup"><span data-stu-id="7903f-149">For more information, see [Blacklist specific devices in an enrollment group](https://docs.microsoft.com/en-us/azure/iot-dps/how-to-revoke-device-access-portal#blacklist-specific-devices-in-an-enrollment-group).</span></span>

<span data-ttu-id="7903f-150">Updating enrollment entries for rolled certificates is accomplished on the **Manage enrollments** page.</span><span class="sxs-lookup"><span data-stu-id="7903f-150">Updating enrollment entries for rolled certificates is accomplished on the **Manage enrollments** page.</span></span> <span data-ttu-id="7903f-151">To access that page, follow these steps:</span><span class="sxs-lookup"><span data-stu-id="7903f-151">To access that page, follow these steps:</span></span>

1. <span data-ttu-id="7903f-152">Sign in to the [Azure portal](https://portal.azure.com) and navigate to the IoT Hub Device Provisioning Service instance that has the enrollment entry for your device.</span><span class="sxs-lookup"><span data-stu-id="7903f-152">Sign in to the [Azure portal](https://portal.azure.com) and navigate to the IoT Hub Device Provisioning Service instance that has the enrollment entry for your device.</span></span>

2. <span data-ttu-id="7903f-153">Click **Manage enrollments**.</span><span class="sxs-lookup"><span data-stu-id="7903f-153">Click **Manage enrollments**.</span></span>

    ![Manage enrollments](./media/how-to-roll-certificates/manage-enrollments-portal.png)


<span data-ttu-id="7903f-155">How you handle updating the enrollment entry will depend on whether you're using individual enrollments, or group enrollments.</span><span class="sxs-lookup"><span data-stu-id="7903f-155">How you handle updating the enrollment entry will depend on whether you're using individual enrollments, or group enrollments.</span></span> <span data-ttu-id="7903f-156">Also the recommended procedures differ depending on whether you're rolling certificates because of a security breach, or certificate expiration.</span><span class="sxs-lookup"><span data-stu-id="7903f-156">Also the recommended procedures differ depending on whether you're rolling certificates because of a security breach, or certificate expiration.</span></span> <span data-ttu-id="7903f-157">The following sections describe how to handle these updates.</span><span class="sxs-lookup"><span data-stu-id="7903f-157">The following sections describe how to handle these updates.</span></span>


## <a name="individual-enrollments-and-security-breaches"></a><span data-ttu-id="7903f-158">Individual enrollments and security breaches</span><span class="sxs-lookup"><span data-stu-id="7903f-158">Individual enrollments and security breaches</span></span>

<span data-ttu-id="7903f-159">If you're rolling certificates in response to a security breach, you should use the following approach that deletes the current certificate immediately:</span><span class="sxs-lookup"><span data-stu-id="7903f-159">If you're rolling certificates in response to a security breach, you should use the following approach that deletes the current certificate immediately:</span></span>

1. <span data-ttu-id="7903f-160">Click **Individual Enrollments**, and click the registration ID entry in the list.</span><span class="sxs-lookup"><span data-stu-id="7903f-160">Click **Individual Enrollments**, and click the registration ID entry in the list.</span></span> 

2. <span data-ttu-id="7903f-161">Click the **Delete current certificate** button and then, click the folder icon to select the new certificate to be uploaded for the enrollment entry.</span><span class="sxs-lookup"><span data-stu-id="7903f-161">Click the **Delete current certificate** button and then, click the folder icon to select the new certificate to be uploaded for the enrollment entry.</span></span> <span data-ttu-id="7903f-162">Click **Save** when finished.</span><span class="sxs-lookup"><span data-stu-id="7903f-162">Click **Save** when finished.</span></span>

    <span data-ttu-id="7903f-163">These steps should be completed for the primary and secondary certificate, if both are compromised.</span><span class="sxs-lookup"><span data-stu-id="7903f-163">These steps should be completed for the primary and secondary certificate, if both are compromised.</span></span>

    ![Manage individual enrollments](./media/how-to-roll-certificates/manage-individual-enrollments-portal.png)

3. <span data-ttu-id="7903f-165">Once the compromised certificate has been removed from the provisioning service, navigate to your IoT hub and remove the device registration associated with the compromised certificate.</span><span class="sxs-lookup"><span data-stu-id="7903f-165">Once the compromised certificate has been removed from the provisioning service, navigate to your IoT hub and remove the device registration associated with the compromised certificate.</span></span>     

    ![Remove IoT hub device registration](./media/how-to-roll-certificates/remove-hub-device-registration.png)


## <a name="individual-enrollments-and-certificate-expiration"></a><span data-ttu-id="7903f-167">Individual enrollments and certificate expiration</span><span class="sxs-lookup"><span data-stu-id="7903f-167">Individual enrollments and certificate expiration</span></span>

<span data-ttu-id="7903f-168">If you're rolling certificates to handle certificate expirations, you should use the secondary certificate configuration as follows to reduce downtime for devices attempting to provision.</span><span class="sxs-lookup"><span data-stu-id="7903f-168">If you're rolling certificates to handle certificate expirations, you should use the secondary certificate configuration as follows to reduce downtime for devices attempting to provision.</span></span>

<span data-ttu-id="7903f-169">Later when the secondary certificate also nears expiration, and needs to be rolled, you can rotate to using the primary configuration.</span><span class="sxs-lookup"><span data-stu-id="7903f-169">Later when the secondary certificate also nears expiration, and needs to be rolled, you can rotate to using the primary configuration.</span></span> <span data-ttu-id="7903f-170">Rotating between the primary and secondary certificates in this way reduces downtime for devices attempting to provision.</span><span class="sxs-lookup"><span data-stu-id="7903f-170">Rotating between the primary and secondary certificates in this way reduces downtime for devices attempting to provision.</span></span>


1. <span data-ttu-id="7903f-171">Click **Individual Enrollments**, and click the registration ID entry in the list.</span><span class="sxs-lookup"><span data-stu-id="7903f-171">Click **Individual Enrollments**, and click the registration ID entry in the list.</span></span> 

2. <span data-ttu-id="7903f-172">Click **Secondary Certificate** and then, click the folder icon to select the new certificate to be uploaded for the enrollment entry.</span><span class="sxs-lookup"><span data-stu-id="7903f-172">Click **Secondary Certificate** and then, click the folder icon to select the new certificate to be uploaded for the enrollment entry.</span></span> <span data-ttu-id="7903f-173">Click **Save**.</span><span class="sxs-lookup"><span data-stu-id="7903f-173">Click **Save**.</span></span>

    ![Manage individual enrollments using the secondary certificate](./media/how-to-roll-certificates/manage-individual-enrollments-secondary-portal.png)

3. <span data-ttu-id="7903f-175">Later when the primary certificate has expired, come back and delete that primary certificate by clicking the **Delete current certificate** button.</span><span class="sxs-lookup"><span data-stu-id="7903f-175">Later when the primary certificate has expired, come back and delete that primary certificate by clicking the **Delete current certificate** button.</span></span>

## <a name="enrollment-groups-and-security-breaches"></a><span data-ttu-id="7903f-176">Enrollment groups and security breaches</span><span class="sxs-lookup"><span data-stu-id="7903f-176">Enrollment groups and security breaches</span></span>

<span data-ttu-id="7903f-177">To update a group enrollment in response to a security breach, you should use one of the following approaches that will delete the current root CA, or intermediate certificate immediately.</span><span class="sxs-lookup"><span data-stu-id="7903f-177">To update a group enrollment in response to a security breach, you should use one of the following approaches that will delete the current root CA, or intermediate certificate immediately.</span></span>

#### <a name="update-compromised-root-ca-certificates"></a><span data-ttu-id="7903f-178">Update compromised root CA certificates</span><span class="sxs-lookup"><span data-stu-id="7903f-178">Update compromised root CA certificates</span></span>

1. <span data-ttu-id="7903f-179">Click the **Certificates** tab for your Device Provisioning service instance.</span><span class="sxs-lookup"><span data-stu-id="7903f-179">Click the **Certificates** tab for your Device Provisioning service instance.</span></span>

2. <span data-ttu-id="7903f-180">Click the compromised certificate in the list, and then click the **Delete** button.</span><span class="sxs-lookup"><span data-stu-id="7903f-180">Click the compromised certificate in the list, and then click the **Delete** button.</span></span> <span data-ttu-id="7903f-181">Confirm the delete by entering the certificate name and click **OK**.</span><span class="sxs-lookup"><span data-stu-id="7903f-181">Confirm the delete by entering the certificate name and click **OK**.</span></span> <span data-ttu-id="7903f-182">Repeat this process for all compromised certificates.</span><span class="sxs-lookup"><span data-stu-id="7903f-182">Repeat this process for all compromised certificates.</span></span>

    ![Delete root CA certificate](./media/how-to-roll-certificates/delete-root-cert.png)

3. <span data-ttu-id="7903f-184">Follow steps outlined in [Configure verified CA certificates](how-to-verify-certificates.md) to add and verify new root CA certificates.</span><span class="sxs-lookup"><span data-stu-id="7903f-184">Follow steps outlined in [Configure verified CA certificates](how-to-verify-certificates.md) to add and verify new root CA certificates.</span></span>

4. <span data-ttu-id="7903f-185">Click the **Manage enrollments** tab for your Device Provisioning service instance, and click the **Enrollment Groups** list.</span><span class="sxs-lookup"><span data-stu-id="7903f-185">Click the **Manage enrollments** tab for your Device Provisioning service instance, and click the **Enrollment Groups** list.</span></span> <span data-ttu-id="7903f-186">Click your enrollment group name in the list.</span><span class="sxs-lookup"><span data-stu-id="7903f-186">Click your enrollment group name in the list.</span></span>

5. <span data-ttu-id="7903f-187">Click **CA Certificate**, and select your new root CA certificate.</span><span class="sxs-lookup"><span data-stu-id="7903f-187">Click **CA Certificate**, and select your new root CA certificate.</span></span> <span data-ttu-id="7903f-188">Then click **Save**.</span><span class="sxs-lookup"><span data-stu-id="7903f-188">Then click **Save**.</span></span> 

    ![Select the new root CA certificate](./media/how-to-roll-certificates/select-new-root-cert.png)

6. <span data-ttu-id="7903f-190">Once the compromised certificate has been removed from the provisioning service, navigate to the linked IoT hub that contains  the compromised device registrations and remove the registrations associated with the compromised certificate.</span><span class="sxs-lookup"><span data-stu-id="7903f-190">Once the compromised certificate has been removed from the provisioning service, navigate to the linked IoT hub that contains  the compromised device registrations and remove the registrations associated with the compromised certificate.</span></span>

    ![Remove IoT hub device registration](./media/how-to-roll-certificates/remove-hub-device-registration.png)


#### <a name="update-compromised-intermediate-certificates"></a><span data-ttu-id="7903f-192">Update compromised intermediate certificates</span><span class="sxs-lookup"><span data-stu-id="7903f-192">Update compromised intermediate certificates</span></span>

1. <span data-ttu-id="7903f-193">Click **Enrollment Groups**, and then click the group name in the list.</span><span class="sxs-lookup"><span data-stu-id="7903f-193">Click **Enrollment Groups**, and then click the group name in the list.</span></span> 

2. <span data-ttu-id="7903f-194">Click **Intermediate Certificate**, and **Delete current certificate**.</span><span class="sxs-lookup"><span data-stu-id="7903f-194">Click **Intermediate Certificate**, and **Delete current certificate**.</span></span> <span data-ttu-id="7903f-195">Click the folder icon to navigate to the new intermediate certificate to be uploaded for the enrollment group.</span><span class="sxs-lookup"><span data-stu-id="7903f-195">Click the folder icon to navigate to the new intermediate certificate to be uploaded for the enrollment group.</span></span> <span data-ttu-id="7903f-196">Click **Save** when you're finished.</span><span class="sxs-lookup"><span data-stu-id="7903f-196">Click **Save** when you're finished.</span></span> <span data-ttu-id="7903f-197">These steps should be completed for both the primary and secondary certificate, if both are compromised.</span><span class="sxs-lookup"><span data-stu-id="7903f-197">These steps should be completed for both the primary and secondary certificate, if both are compromised.</span></span>

    <span data-ttu-id="7903f-198">This new intermediate certificate should be signed by a verified root CA certificate that has already been added into provisioning service.</span><span class="sxs-lookup"><span data-stu-id="7903f-198">This new intermediate certificate should be signed by a verified root CA certificate that has already been added into provisioning service.</span></span> <span data-ttu-id="7903f-199">For more information, see [X.509 certificates](concepts-security.md#x509-certificates).</span><span class="sxs-lookup"><span data-stu-id="7903f-199">For more information, see [X.509 certificates](concepts-security.md#x509-certificates).</span></span>

    ![Manage individual enrollments](./media/how-to-roll-certificates/enrollment-group-delete-intermediate-cert.png)


3. <span data-ttu-id="7903f-201">Once the compromised certificate has been removed from the provisioning service, navigate to the linked IoT hub that contains  the device registration and remove the registration associated with the compromised certificate.</span><span class="sxs-lookup"><span data-stu-id="7903f-201">Once the compromised certificate has been removed from the provisioning service, navigate to the linked IoT hub that contains  the device registration and remove the registration associated with the compromised certificate.</span></span>

    ![Remove IoT hub device registration](./media/how-to-roll-certificates/remove-hub-device-registration.png)


## <a name="enrollment-groups-and-certificate-expiration"></a><span data-ttu-id="7903f-203">Enrollment groups and certificate expiration</span><span class="sxs-lookup"><span data-stu-id="7903f-203">Enrollment groups and certificate expiration</span></span>

<span data-ttu-id="7903f-204">If you are rolling certificates to handle certificate expirations, you should use the secondary certificate configuration as follows to ensure no downtime for devices attempting to provision.</span><span class="sxs-lookup"><span data-stu-id="7903f-204">If you are rolling certificates to handle certificate expirations, you should use the secondary certificate configuration as follows to ensure no downtime for devices attempting to provision.</span></span>

<span data-ttu-id="7903f-205">Later when the secondary certificate also nears expiration, and needs to be rolled, you can rotate to using the primary configuration.</span><span class="sxs-lookup"><span data-stu-id="7903f-205">Later when the secondary certificate also nears expiration, and needs to be rolled, you can rotate to using the primary configuration.</span></span> <span data-ttu-id="7903f-206">Rotating between the primary and secondary certificates in this way ensures no downtime for devices attempting to provision.</span><span class="sxs-lookup"><span data-stu-id="7903f-206">Rotating between the primary and secondary certificates in this way ensures no downtime for devices attempting to provision.</span></span> 

#### <a name="update-expiring-root-ca-certificates"></a><span data-ttu-id="7903f-207">Update expiring root CA certificates</span><span class="sxs-lookup"><span data-stu-id="7903f-207">Update expiring root CA certificates</span></span>

1. <span data-ttu-id="7903f-208">Follow steps outlined in [Configure verified CA certificates](how-to-verify-certificates.md) to add and verify new root CA certificates.</span><span class="sxs-lookup"><span data-stu-id="7903f-208">Follow steps outlined in [Configure verified CA certificates](how-to-verify-certificates.md) to add and verify new root CA certificates.</span></span>

2. <span data-ttu-id="7903f-209">Click the **Manage enrollments** tab for your Device Provisioning service instance, and click the **Enrollment Groups** list.</span><span class="sxs-lookup"><span data-stu-id="7903f-209">Click the **Manage enrollments** tab for your Device Provisioning service instance, and click the **Enrollment Groups** list.</span></span> <span data-ttu-id="7903f-210">Click your enrollment group name in the list.</span><span class="sxs-lookup"><span data-stu-id="7903f-210">Click your enrollment group name in the list.</span></span>

3. <span data-ttu-id="7903f-211">Click **CA Certificate**, and select your new root CA certificate under the **Secondary Certificate** configuration.</span><span class="sxs-lookup"><span data-stu-id="7903f-211">Click **CA Certificate**, and select your new root CA certificate under the **Secondary Certificate** configuration.</span></span> <span data-ttu-id="7903f-212">Then click **Save**.</span><span class="sxs-lookup"><span data-stu-id="7903f-212">Then click **Save**.</span></span> 

    ![Select the new root CA certificate](./media/how-to-roll-certificates/select-new-root-secondary-cert.png)

4. <span data-ttu-id="7903f-214">Later when the primary certificate has expired, click the **Certificates** tab for your Device Provisioning service instance.</span><span class="sxs-lookup"><span data-stu-id="7903f-214">Later when the primary certificate has expired, click the **Certificates** tab for your Device Provisioning service instance.</span></span> <span data-ttu-id="7903f-215">Click the expired certificate in the list, and then click the **Delete** button.</span><span class="sxs-lookup"><span data-stu-id="7903f-215">Click the expired certificate in the list, and then click the **Delete** button.</span></span> <span data-ttu-id="7903f-216">Confirm the delete by entering the certificate name, and click **OK**.</span><span class="sxs-lookup"><span data-stu-id="7903f-216">Confirm the delete by entering the certificate name, and click **OK**.</span></span>

    ![Delete root CA certificate](./media/how-to-roll-certificates/delete-root-cert.png)



#### <a name="update-expiring-intermediate-certificates"></a><span data-ttu-id="7903f-218">Update expiring intermediate certificates</span><span class="sxs-lookup"><span data-stu-id="7903f-218">Update expiring intermediate certificates</span></span>


1. <span data-ttu-id="7903f-219">Click **Enrollment Groups**, and click the group name in the list.</span><span class="sxs-lookup"><span data-stu-id="7903f-219">Click **Enrollment Groups**, and click the group name in the list.</span></span> 

2. <span data-ttu-id="7903f-220">Click **Secondary Certificate** and then, click the folder icon to select the new certificate to be uploaded for the enrollment entry.</span><span class="sxs-lookup"><span data-stu-id="7903f-220">Click **Secondary Certificate** and then, click the folder icon to select the new certificate to be uploaded for the enrollment entry.</span></span> <span data-ttu-id="7903f-221">Click **Save**.</span><span class="sxs-lookup"><span data-stu-id="7903f-221">Click **Save**.</span></span>

    <span data-ttu-id="7903f-222">This new intermediate certificate should be signed by a verified root CA certificate that has already been added into provisioning service.</span><span class="sxs-lookup"><span data-stu-id="7903f-222">This new intermediate certificate should be signed by a verified root CA certificate that has already been added into provisioning service.</span></span> <span data-ttu-id="7903f-223">For more information, see [X.509 certificates](concepts-security.md#x509-certificates).</span><span class="sxs-lookup"><span data-stu-id="7903f-223">For more information, see [X.509 certificates](concepts-security.md#x509-certificates).</span></span>

   ![Manage individual enrollments using the secondary certificate](./media/how-to-roll-certificates/manage-enrollment-group-secondary-portal.png)

3. <span data-ttu-id="7903f-225">Later when the primary certificate has expired, come back and delete that primary certificate by clicking the **Delete current certificate** button.</span><span class="sxs-lookup"><span data-stu-id="7903f-225">Later when the primary certificate has expired, come back and delete that primary certificate by clicking the **Delete current certificate** button.</span></span>


## <a name="reprovision-the-device"></a><span data-ttu-id="7903f-226">Reprovision the device</span><span class="sxs-lookup"><span data-stu-id="7903f-226">Reprovision the device</span></span>

<span data-ttu-id="7903f-227">Once the certificate is rolled on both the device and the Device Provisioning Service, the device can reprovision itself by contacting the Device Provisioning service.</span><span class="sxs-lookup"><span data-stu-id="7903f-227">Once the certificate is rolled on both the device and the Device Provisioning Service, the device can reprovision itself by contacting the Device Provisioning service.</span></span> 

<span data-ttu-id="7903f-228">One easy way of programming devices to reprovision is to program the device to contact the provisioning service to go through the provisioning flow if the device receives an “unauthorized” error from attempting to connect to the IoT hub.</span><span class="sxs-lookup"><span data-stu-id="7903f-228">One easy way of programming devices to reprovision is to program the device to contact the provisioning service to go through the provisioning flow if the device receives an “unauthorized” error from attempting to connect to the IoT hub.</span></span>

<span data-ttu-id="7903f-229">Another way is for both the old and the new certificates to be valid for a short overlap, and use the IoT hub to send a command to devices to have them re-register via the provisioning service to update their IoT Hub connection information.</span><span class="sxs-lookup"><span data-stu-id="7903f-229">Another way is for both the old and the new certificates to be valid for a short overlap, and use the IoT hub to send a command to devices to have them re-register via the provisioning service to update their IoT Hub connection information.</span></span> <span data-ttu-id="7903f-230">Because each device can process commands differently, you will have to program your device to know what to do when the command is invoked.</span><span class="sxs-lookup"><span data-stu-id="7903f-230">Because each device can process commands differently, you will have to program your device to know what to do when the command is invoked.</span></span> <span data-ttu-id="7903f-231">There are several ways you can command your device via IoT Hub, and we recommend using [direct methods](../iot-hub/iot-hub-devguide-direct-methods.md) or [jobs](../iot-hub/iot-hub-devguide-jobs.md) to initiate the process.</span><span class="sxs-lookup"><span data-stu-id="7903f-231">There are several ways you can command your device via IoT Hub, and we recommend using [direct methods](../iot-hub/iot-hub-devguide-direct-methods.md) or [jobs](../iot-hub/iot-hub-devguide-jobs.md) to initiate the process.</span></span>

<span data-ttu-id="7903f-232">Once reprovisioning is complete, devices will be able to connect to IoT Hub using their new certificates.</span><span class="sxs-lookup"><span data-stu-id="7903f-232">Once reprovisioning is complete, devices will be able to connect to IoT Hub using their new certificates.</span></span>


## <a name="blacklist-certificates"></a><span data-ttu-id="7903f-233">Blacklist certificates</span><span class="sxs-lookup"><span data-stu-id="7903f-233">Blacklist certificates</span></span>

<span data-ttu-id="7903f-234">In response to a security breach, you may need to blacklist a device certificate.</span><span class="sxs-lookup"><span data-stu-id="7903f-234">In response to a security breach, you may need to blacklist a device certificate.</span></span> <span data-ttu-id="7903f-235">To blacklist a device certificate, disable the enrollment entry for the target device/certificate.</span><span class="sxs-lookup"><span data-stu-id="7903f-235">To blacklist a device certificate, disable the enrollment entry for the target device/certificate.</span></span> <span data-ttu-id="7903f-236">For more information, see blacklisting devices in the [Manage disenrollment](how-to-revoke-device-access-portal.md) article.</span><span class="sxs-lookup"><span data-stu-id="7903f-236">For more information, see blacklisting devices in the [Manage disenrollment](how-to-revoke-device-access-portal.md) article.</span></span>

<span data-ttu-id="7903f-237">Once a certificate is included as part of a disabled enrollment entry, any attempts to register with an IoT hub using that certificates will fail even if it is enabled as part of another enrollment entry.</span><span class="sxs-lookup"><span data-stu-id="7903f-237">Once a certificate is included as part of a disabled enrollment entry, any attempts to register with an IoT hub using that certificates will fail even if it is enabled as part of another enrollment entry.</span></span>
 



## <a name="next-steps"></a><span data-ttu-id="7903f-238">Next steps</span><span class="sxs-lookup"><span data-stu-id="7903f-238">Next steps</span></span>

- <span data-ttu-id="7903f-239">To learn more about X.509 certificates in the Device Provisioning Service, see [Security](concepts-security.md)</span><span class="sxs-lookup"><span data-stu-id="7903f-239">To learn more about X.509 certificates in the Device Provisioning Service, see [Security](concepts-security.md)</span></span> 
- <span data-ttu-id="7903f-240">To learn about how to do proof-of-possession for X.509 CA certificates with the Azure IoT Hub Device Provisioning Service, see [How to verify certificates](how-to-verify-certificates.md)</span><span class="sxs-lookup"><span data-stu-id="7903f-240">To learn about how to do proof-of-possession for X.509 CA certificates with the Azure IoT Hub Device Provisioning Service, see [How to verify certificates](how-to-verify-certificates.md)</span></span>
- <span data-ttu-id="7903f-241">To learn about how to use the portal to create an enrollment group, see [Managing device enrollments with Azure portal](how-to-manage-enrollments.md).</span><span class="sxs-lookup"><span data-stu-id="7903f-241">To learn about how to use the portal to create an enrollment group, see [Managing device enrollments with Azure portal](how-to-manage-enrollments.md).</span></span>










