---
title: Azure Service Fabric disaster recovery | Microsoft Docs
description: Azure Service Fabric offers the capabilities necessary to deal with all types of disasters. This article describes the types of disasters that can occur and how to deal with them.
services: service-fabric
documentationcenter: .net
author: seanmck
manager: timlt
editor: ''
ms.assetid: ab49c4b9-74a8-4907-b75b-8d2ee84c6d90
ms.service: service-fabric
ms.devlang: dotNet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 03/01/2017
ms.author: seanmck
ms.openlocfilehash: aacfefd7f410346e90d1ea61be6465bb4c8fabcb
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44550081"
---
# <a name="disaster-recovery-in-azure-service-fabric"></a><span data-ttu-id="55487-104">Disaster recovery in Azure Service Fabric</span><span class="sxs-lookup"><span data-stu-id="55487-104">Disaster recovery in Azure Service Fabric</span></span>
<span data-ttu-id="55487-105">A critical part of delivering a high-availability cloud application is ensuring that it can survive all different types of failures, including those that are outside of your control.</span><span class="sxs-lookup"><span data-stu-id="55487-105">A critical part of delivering a high-availability cloud application is ensuring that it can survive all different types of failures, including those that are outside of your control.</span></span> <span data-ttu-id="55487-106">This article describes the physical layout of an Azure Service Fabric cluster in the context of potential disasters and provides guidance on how to deal with such disasters to limit or eliminate the risk of downtime or data loss.</span><span class="sxs-lookup"><span data-stu-id="55487-106">This article describes the physical layout of an Azure Service Fabric cluster in the context of potential disasters and provides guidance on how to deal with such disasters to limit or eliminate the risk of downtime or data loss.</span></span>

## <a name="physical-layout-of-service-fabric-clusters-in-azure"></a><span data-ttu-id="55487-107">Physical layout of Service Fabric clusters in Azure</span><span class="sxs-lookup"><span data-stu-id="55487-107">Physical layout of Service Fabric clusters in Azure</span></span>
<span data-ttu-id="55487-108">To understand the risk posed by different types of failures, it is useful to know how clusters are physically laid out in Azure.</span><span class="sxs-lookup"><span data-stu-id="55487-108">To understand the risk posed by different types of failures, it is useful to know how clusters are physically laid out in Azure.</span></span>

<span data-ttu-id="55487-109">When you create a Service Fabric cluster in Azure, you are required to choose a region where it will be hosted.</span><span class="sxs-lookup"><span data-stu-id="55487-109">When you create a Service Fabric cluster in Azure, you are required to choose a region where it will be hosted.</span></span> <span data-ttu-id="55487-110">The Azure infrastructure then provisions the resources for that cluster within the region, most notably the number of virtual machines (VMs) requested.</span><span class="sxs-lookup"><span data-stu-id="55487-110">The Azure infrastructure then provisions the resources for that cluster within the region, most notably the number of virtual machines (VMs) requested.</span></span> <span data-ttu-id="55487-111">Let's look more closely at how and where those VMs are provisioned.</span><span class="sxs-lookup"><span data-stu-id="55487-111">Let's look more closely at how and where those VMs are provisioned.</span></span>

### <a name="fault-domains"></a><span data-ttu-id="55487-112">Fault domains</span><span class="sxs-lookup"><span data-stu-id="55487-112">Fault domains</span></span>
<span data-ttu-id="55487-113">By default, the VMs in the cluster are evenly spread across logical groups known as fault domains (FDs), which segment the machines based on potential failures in the host hardware.</span><span class="sxs-lookup"><span data-stu-id="55487-113">By default, the VMs in the cluster are evenly spread across logical groups known as fault domains (FDs), which segment the machines based on potential failures in the host hardware.</span></span> <span data-ttu-id="55487-114">Specifically, if two VMs reside in two distinct FDs, you can be sure that they do not share the same power source or network switch.</span><span class="sxs-lookup"><span data-stu-id="55487-114">Specifically, if two VMs reside in two distinct FDs, you can be sure that they do not share the same power source or network switch.</span></span> <span data-ttu-id="55487-115">As a result, a local network or power failure affecting one VM will not affect the other, allowing Service Fabric to rebalance the work load of the unresponsive machine within the cluster.</span><span class="sxs-lookup"><span data-stu-id="55487-115">As a result, a local network or power failure affecting one VM will not affect the other, allowing Service Fabric to rebalance the work load of the unresponsive machine within the cluster.</span></span>

<span data-ttu-id="55487-116">You can visualize the layout of your cluster across fault domains using the cluster map provided in [Service Fabric Explorer](service-fabric-visualizing-your-cluster.md):</span><span class="sxs-lookup"><span data-stu-id="55487-116">You can visualize the layout of your cluster across fault domains using the cluster map provided in [Service Fabric Explorer](service-fabric-visualizing-your-cluster.md):</span></span>

![Nodes spread across fault domains in Service Fabric Explorer][sfx-cluster-map]

> [!NOTE]
> <span data-ttu-id="55487-118">The other axis in the cluster map shows upgrade domains, which logically group nodes based on planned maintenance activities.</span><span class="sxs-lookup"><span data-stu-id="55487-118">The other axis in the cluster map shows upgrade domains, which logically group nodes based on planned maintenance activities.</span></span> <span data-ttu-id="55487-119">Service Fabric clusters in Azure are always laid out across five upgrade domains.</span><span class="sxs-lookup"><span data-stu-id="55487-119">Service Fabric clusters in Azure are always laid out across five upgrade domains.</span></span>
> 
> 

### <a name="geographic-distribution"></a><span data-ttu-id="55487-120">Geographic distribution</span><span class="sxs-lookup"><span data-stu-id="55487-120">Geographic distribution</span></span>
<span data-ttu-id="55487-121">There are currently [30 Azure regions throughout the world][azure-regions], with several more announced.</span><span class="sxs-lookup"><span data-stu-id="55487-121">There are currently [30 Azure regions throughout the world][azure-regions], with several more announced.</span></span> <span data-ttu-id="55487-122">An individual region can contain one or more physical data centers depending on demand and the availability of suitable locations, among other factors.</span><span class="sxs-lookup"><span data-stu-id="55487-122">An individual region can contain one or more physical data centers depending on demand and the availability of suitable locations, among other factors.</span></span> <span data-ttu-id="55487-123">Note, however, that even in regions that contain multiple physical data centers, there is no guarantee that your cluster's VMs will be evenly spread across those physical locations.</span><span class="sxs-lookup"><span data-stu-id="55487-123">Note, however, that even in regions that contain multiple physical data centers, there is no guarantee that your cluster's VMs will be evenly spread across those physical locations.</span></span> <span data-ttu-id="55487-124">Indeed, currently, all VMs for a given cluster are provisioned within a single physical site.</span><span class="sxs-lookup"><span data-stu-id="55487-124">Indeed, currently, all VMs for a given cluster are provisioned within a single physical site.</span></span>

## <a name="dealing-with-failures"></a><span data-ttu-id="55487-125">Dealing with failures</span><span class="sxs-lookup"><span data-stu-id="55487-125">Dealing with failures</span></span>
<span data-ttu-id="55487-126">There are several types of failures that can impact your cluster, each with its own mitigation.</span><span class="sxs-lookup"><span data-stu-id="55487-126">There are several types of failures that can impact your cluster, each with its own mitigation.</span></span> <span data-ttu-id="55487-127">We will look at them in order of likelihood to occur.</span><span class="sxs-lookup"><span data-stu-id="55487-127">We will look at them in order of likelihood to occur.</span></span>

### <a name="individual-machine-failures"></a><span data-ttu-id="55487-128">Individual machine failures</span><span class="sxs-lookup"><span data-stu-id="55487-128">Individual machine failures</span></span>
<span data-ttu-id="55487-129">As mentioned, individual machine failures, either within the VM or in the hardware or software hosting it within a fault domain, pose no risk on their own.</span><span class="sxs-lookup"><span data-stu-id="55487-129">As mentioned, individual machine failures, either within the VM or in the hardware or software hosting it within a fault domain, pose no risk on their own.</span></span> <span data-ttu-id="55487-130">Service Fabric will typically detect the failure within seconds and respond accordingly based on the state of the cluster.</span><span class="sxs-lookup"><span data-stu-id="55487-130">Service Fabric will typically detect the failure within seconds and respond accordingly based on the state of the cluster.</span></span> <span data-ttu-id="55487-131">For instance, if the node was hosting the primary replicas for a partition, a new primary is elected from the partition's secondary replicas.</span><span class="sxs-lookup"><span data-stu-id="55487-131">For instance, if the node was hosting the primary replicas for a partition, a new primary is elected from the partition's secondary replicas.</span></span> <span data-ttu-id="55487-132">When Azure brings the failed machine back up, it will rejoin the cluster automatically and once again take on its share of the workload.</span><span class="sxs-lookup"><span data-stu-id="55487-132">When Azure brings the failed machine back up, it will rejoin the cluster automatically and once again take on its share of the workload.</span></span>

### <a name="multiple-concurrent-machine-failures"></a><span data-ttu-id="55487-133">Multiple concurrent machine failures</span><span class="sxs-lookup"><span data-stu-id="55487-133">Multiple concurrent machine failures</span></span>
<span data-ttu-id="55487-134">While fault domains significantly reduce the risk of concurrent machine failures, there is always the potential for multiple random failures to bring down several machines in a cluster simultaneously.</span><span class="sxs-lookup"><span data-stu-id="55487-134">While fault domains significantly reduce the risk of concurrent machine failures, there is always the potential for multiple random failures to bring down several machines in a cluster simultaneously.</span></span>

<span data-ttu-id="55487-135">In general, as long as a majority of the nodes remain available, the cluster will continue to operate, albeit at lower capacity as stateful replicas get packed into a smaller set of machines and fewer stateless instances are available to spread load.</span><span class="sxs-lookup"><span data-stu-id="55487-135">In general, as long as a majority of the nodes remain available, the cluster will continue to operate, albeit at lower capacity as stateful replicas get packed into a smaller set of machines and fewer stateless instances are available to spread load.</span></span>

#### <a name="quorum-loss"></a><span data-ttu-id="55487-136">Quorum loss</span><span class="sxs-lookup"><span data-stu-id="55487-136">Quorum loss</span></span>
<span data-ttu-id="55487-137">If a majority of the replicas for a stateful service's partition go down, that partition enters a state known as "quorum loss."</span><span class="sxs-lookup"><span data-stu-id="55487-137">If a majority of the replicas for a stateful service's partition go down, that partition enters a state known as "quorum loss."</span></span> <span data-ttu-id="55487-138">At this point, Service Fabric stops allowing writes to that partition to ensure that its state remains consistent and reliable.</span><span class="sxs-lookup"><span data-stu-id="55487-138">At this point, Service Fabric stops allowing writes to that partition to ensure that its state remains consistent and reliable.</span></span> <span data-ttu-id="55487-139">In effect, we are choosing to accept a period of unavailability to ensure that clients are not told that their data was saved when in fact it was not.</span><span class="sxs-lookup"><span data-stu-id="55487-139">In effect, we are choosing to accept a period of unavailability to ensure that clients are not told that their data was saved when in fact it was not.</span></span> <span data-ttu-id="55487-140">Note that if you have opted in to allowing reads from secondary replicas for that stateful service, you can continue to perform those read operations while in this state.</span><span class="sxs-lookup"><span data-stu-id="55487-140">Note that if you have opted in to allowing reads from secondary replicas for that stateful service, you can continue to perform those read operations while in this state.</span></span> <span data-ttu-id="55487-141">A partition remains in quorum loss until a sufficient number of replicas come back or until the cluster administrator forces the system to move on using the [Repair-ServiceFabricPartition API][repair-partition-ps].</span><span class="sxs-lookup"><span data-stu-id="55487-141">A partition remains in quorum loss until a sufficient number of replicas come back or until the cluster administrator forces the system to move on using the [Repair-ServiceFabricPartition API][repair-partition-ps].</span></span>

> [!WARNING]
> <span data-ttu-id="55487-142">Performing a repair action while the primary replica is down will result in data loss.</span><span class="sxs-lookup"><span data-stu-id="55487-142">Performing a repair action while the primary replica is down will result in data loss.</span></span>
> 
> 

<span data-ttu-id="55487-143">System services can also suffer quorum loss, with the impact being specific to the service in question.</span><span class="sxs-lookup"><span data-stu-id="55487-143">System services can also suffer quorum loss, with the impact being specific to the service in question.</span></span> <span data-ttu-id="55487-144">For instance, quorum loss in the naming service will impact name resolution, whereas quorum loss in the failover manager service will block new service creation and failovers.</span><span class="sxs-lookup"><span data-stu-id="55487-144">For instance, quorum loss in the naming service will impact name resolution, whereas quorum loss in the failover manager service will block new service creation and failovers.</span></span> <span data-ttu-id="55487-145">Note that unlike for your own services, attempting to repair system services is *not* recommended.</span><span class="sxs-lookup"><span data-stu-id="55487-145">Note that unlike for your own services, attempting to repair system services is *not* recommended.</span></span> <span data-ttu-id="55487-146">Instead, it is preferable to simply wait until the down replicas return.</span><span class="sxs-lookup"><span data-stu-id="55487-146">Instead, it is preferable to simply wait until the down replicas return.</span></span>

#### <a name="minimizing-the-risk-of-quorum-loss"></a><span data-ttu-id="55487-147">Minimizing the risk of quorum loss</span><span class="sxs-lookup"><span data-stu-id="55487-147">Minimizing the risk of quorum loss</span></span>
<span data-ttu-id="55487-148">You can minimize your risk of quorum loss by increasing the target replica set size for your service.</span><span class="sxs-lookup"><span data-stu-id="55487-148">You can minimize your risk of quorum loss by increasing the target replica set size for your service.</span></span> <span data-ttu-id="55487-149">It is helpful to think of the number of replicas you need in terms of the number of unavailable nodes you can tolerate at once while remaining available for writes, keeping in mind that application or cluster upgrades can make nodes temporarily unavailable, in addition to hardware failures.</span><span class="sxs-lookup"><span data-stu-id="55487-149">It is helpful to think of the number of replicas you need in terms of the number of unavailable nodes you can tolerate at once while remaining available for writes, keeping in mind that application or cluster upgrades can make nodes temporarily unavailable, in addition to hardware failures.</span></span>

<span data-ttu-id="55487-150">Consider the following examples assuming that you've configured your services to have a MinReplicaSetSize of three, the smallest number recommended for production services.</span><span class="sxs-lookup"><span data-stu-id="55487-150">Consider the following examples assuming that you've configured your services to have a MinReplicaSetSize of three, the smallest number recommended for production services.</span></span> <span data-ttu-id="55487-151">With a TargetReplicaSetSize of three (one primary and two secondaries), a hardware failure during an upgrade (two replicas down) will result in quorum loss and your service will become read-only.</span><span class="sxs-lookup"><span data-stu-id="55487-151">With a TargetReplicaSetSize of three (one primary and two secondaries), a hardware failure during an upgrade (two replicas down) will result in quorum loss and your service will become read-only.</span></span> <span data-ttu-id="55487-152">Alternatively, if you have five replicas, you would be able to withstand two failures during upgrade (three replicas down) as the remaining two replicas can still form a quorum within the minimum replica set.</span><span class="sxs-lookup"><span data-stu-id="55487-152">Alternatively, if you have five replicas, you would be able to withstand two failures during upgrade (three replicas down) as the remaining two replicas can still form a quorum within the minimum replica set.</span></span>

### <a name="data-center-outages-or-destruction"></a><span data-ttu-id="55487-153">Data center outages or destruction</span><span class="sxs-lookup"><span data-stu-id="55487-153">Data center outages or destruction</span></span>
<span data-ttu-id="55487-154">In rare cases, physical data centers can become temporarily unavailable due to loss of power or network connectivity.</span><span class="sxs-lookup"><span data-stu-id="55487-154">In rare cases, physical data centers can become temporarily unavailable due to loss of power or network connectivity.</span></span> <span data-ttu-id="55487-155">In these cases, your Service Fabric clusters and applications will likewise be unavailable but your data will be preserved.</span><span class="sxs-lookup"><span data-stu-id="55487-155">In these cases, your Service Fabric clusters and applications will likewise be unavailable but your data will be preserved.</span></span> <span data-ttu-id="55487-156">For clusters running in Azure, you can view updates on outages on the [Azure status page][azure-status-dashboard].</span><span class="sxs-lookup"><span data-stu-id="55487-156">For clusters running in Azure, you can view updates on outages on the [Azure status page][azure-status-dashboard].</span></span>

<span data-ttu-id="55487-157">In the highly unlikely event that an entire physical data center is destroyed, any Service Fabric clusters hosted there will be lost, along with their state.</span><span class="sxs-lookup"><span data-stu-id="55487-157">In the highly unlikely event that an entire physical data center is destroyed, any Service Fabric clusters hosted there will be lost, along with their state.</span></span>

<span data-ttu-id="55487-158">To protect against this possibility, it is critically important to periodically [backup your state](service-fabric-reliable-services-backup-restore.md) to a geo-redundant store and ensure that you have validated the ability to restore it.</span><span class="sxs-lookup"><span data-stu-id="55487-158">To protect against this possibility, it is critically important to periodically [backup your state](service-fabric-reliable-services-backup-restore.md) to a geo-redundant store and ensure that you have validated the ability to restore it.</span></span> <span data-ttu-id="55487-159">How often you perform a backup will be dependent on your recovery point objective (RPO).</span><span class="sxs-lookup"><span data-stu-id="55487-159">How often you perform a backup will be dependent on your recovery point objective (RPO).</span></span> <span data-ttu-id="55487-160">Even if you have not fully implemented backup and restore yet, you should implement a handler for the `OnDataLoss` event so that you can log when it occurs as follows:</span><span class="sxs-lookup"><span data-stu-id="55487-160">Even if you have not fully implemented backup and restore yet, you should implement a handler for the `OnDataLoss` event so that you can log when it occurs as follows:</span></span>

```c#
protected virtual Task<bool> OnDataLoss(CancellationToken cancellationToken)
{
  ServiceEventSource.Current.ServiceMessage(this, "OnDataLoss event received.");
  return Task.FromResult(false);
}
```


### <a name="software-failures-and-other-sources-of-data-loss"></a><span data-ttu-id="55487-161">Software failures and other sources of data loss</span><span class="sxs-lookup"><span data-stu-id="55487-161">Software failures and other sources of data loss</span></span>
<span data-ttu-id="55487-162">As a cause of data loss, code defects in services, human operational errors, and security breaches are more common than widespread data center failures.</span><span class="sxs-lookup"><span data-stu-id="55487-162">As a cause of data loss, code defects in services, human operational errors, and security breaches are more common than widespread data center failures.</span></span> <span data-ttu-id="55487-163">However, in all cases, the recovery strategy is the same: take regular backups of all stateful services and exercise your ability to restore that state.</span><span class="sxs-lookup"><span data-stu-id="55487-163">However, in all cases, the recovery strategy is the same: take regular backups of all stateful services and exercise your ability to restore that state.</span></span>

## <a name="next-steps"></a><span data-ttu-id="55487-164">Next Steps</span><span class="sxs-lookup"><span data-stu-id="55487-164">Next Steps</span></span>
* <span data-ttu-id="55487-165">Learn how to simulate various failures using the [testability framework](service-fabric-testability-overview.md)</span><span class="sxs-lookup"><span data-stu-id="55487-165">Learn how to simulate various failures using the [testability framework](service-fabric-testability-overview.md)</span></span>
* <span data-ttu-id="55487-166">Read other disaster-recovery and high-availability resources.</span><span class="sxs-lookup"><span data-stu-id="55487-166">Read other disaster-recovery and high-availability resources.</span></span> <span data-ttu-id="55487-167">Microsoft has published a large amount of guidance on these topics.</span><span class="sxs-lookup"><span data-stu-id="55487-167">Microsoft has published a large amount of guidance on these topics.</span></span> <span data-ttu-id="55487-168">While some of these documents refer to specific techniques for use in other products, they contain many general best practices you can apply in the Service Fabric context as well:</span><span class="sxs-lookup"><span data-stu-id="55487-168">While some of these documents refer to specific techniques for use in other products, they contain many general best practices you can apply in the Service Fabric context as well:</span></span>
  * [<span data-ttu-id="55487-169">Availability checklist</span><span class="sxs-lookup"><span data-stu-id="55487-169">Availability checklist</span></span>](../best-practices-availability-checklist.md)
  * [<span data-ttu-id="55487-170">Performing a disaster recovery drill</span><span class="sxs-lookup"><span data-stu-id="55487-170">Performing a disaster recovery drill</span></span>](../sql-database/sql-database-disaster-recovery-drills.md)
  * <span data-ttu-id="55487-171">[Disaster recovery and high availability for Azure applications][dr-ha-guide]</span><span class="sxs-lookup"><span data-stu-id="55487-171">[Disaster recovery and high availability for Azure applications][dr-ha-guide]</span></span>
* <span data-ttu-id="55487-172">Learn about [Service Fabric support options](service-fabric-support.md)</span><span class="sxs-lookup"><span data-stu-id="55487-172">Learn about [Service Fabric support options](service-fabric-support.md)</span></span>

<!-- External links -->

[repair-partition-ps]: https://msdn.microsoft.com/library/mt163522.aspx
[azure-status-dashboard]:https://azure.microsoft.com/status/
[azure-regions]: https://azure.microsoft.com/regions/
[dr-ha-guide]: https://msdn.microsoft.com/library/azure/dn251004.aspx


<!-- Images -->

[sfx-cluster-map]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/service-fabric/media/service-fabric-disaster-recovery/sfx-clustermap.png

