---
title: Service Fabric application upgrade | Microsoft Docs
description: This article provides an introduction to upgrading a Service Fabric application, including choosing upgrade modes and performing health checks.
services: service-fabric
documentationcenter: .net
author: mani-ramaswamy
manager: timlt
editor: ''
ms.assetid: 803c9c63-373a-4d6a-8ef2-ea97e16e88dd
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: conceptual
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 2/23/2018
ms.author: subramar
ms.openlocfilehash: 79408c9936000aa18dba9347b8a10fa7dcd8e8ee
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44815781"
---
# <a name="service-fabric-application-upgrade"></a><span data-ttu-id="b10a9-103">Service Fabric application upgrade</span><span class="sxs-lookup"><span data-stu-id="b10a9-103">Service Fabric application upgrade</span></span>
<span data-ttu-id="b10a9-104">An Azure Service Fabric application is a collection of services.</span><span class="sxs-lookup"><span data-stu-id="b10a9-104">An Azure Service Fabric application is a collection of services.</span></span> <span data-ttu-id="b10a9-105">During an upgrade, Service Fabric compares the new [application manifest](service-fabric-application-and-service-manifests.md) with the previous version and determines which services in the application require updates.</span><span class="sxs-lookup"><span data-stu-id="b10a9-105">During an upgrade, Service Fabric compares the new [application manifest](service-fabric-application-and-service-manifests.md) with the previous version and determines which services in the application require updates.</span></span> <span data-ttu-id="b10a9-106">Service Fabric compares the version numbers in the service manifests with the version numbers in the previous version.</span><span class="sxs-lookup"><span data-stu-id="b10a9-106">Service Fabric compares the version numbers in the service manifests with the version numbers in the previous version.</span></span> <span data-ttu-id="b10a9-107">If a service has not changed, that service is not upgraded.</span><span class="sxs-lookup"><span data-stu-id="b10a9-107">If a service has not changed, that service is not upgraded.</span></span>

## <a name="rolling-upgrades-overview"></a><span data-ttu-id="b10a9-108">Rolling upgrades overview</span><span class="sxs-lookup"><span data-stu-id="b10a9-108">Rolling upgrades overview</span></span>
<span data-ttu-id="b10a9-109">In a rolling application upgrade, the upgrade is performed in stages.</span><span class="sxs-lookup"><span data-stu-id="b10a9-109">In a rolling application upgrade, the upgrade is performed in stages.</span></span> <span data-ttu-id="b10a9-110">At each stage, the upgrade is applied to a subset of nodes in the cluster, called an update domain.</span><span class="sxs-lookup"><span data-stu-id="b10a9-110">At each stage, the upgrade is applied to a subset of nodes in the cluster, called an update domain.</span></span> <span data-ttu-id="b10a9-111">As a result, the application remains available throughout the upgrade.</span><span class="sxs-lookup"><span data-stu-id="b10a9-111">As a result, the application remains available throughout the upgrade.</span></span> <span data-ttu-id="b10a9-112">During the upgrade, the cluster may contain a mix of the old and new versions.</span><span class="sxs-lookup"><span data-stu-id="b10a9-112">During the upgrade, the cluster may contain a mix of the old and new versions.</span></span>

<span data-ttu-id="b10a9-113">For that reason, the two versions must be forward and backward compatible.</span><span class="sxs-lookup"><span data-stu-id="b10a9-113">For that reason, the two versions must be forward and backward compatible.</span></span> <span data-ttu-id="b10a9-114">If they are not compatible, the application administrator is responsible for staging a multiple-phase upgrade to maintain availability.</span><span class="sxs-lookup"><span data-stu-id="b10a9-114">If they are not compatible, the application administrator is responsible for staging a multiple-phase upgrade to maintain availability.</span></span> <span data-ttu-id="b10a9-115">In a multiple-phase upgrade, the first step is upgrading to an intermediate version of the application that is compatible with the previous version.</span><span class="sxs-lookup"><span data-stu-id="b10a9-115">In a multiple-phase upgrade, the first step is upgrading to an intermediate version of the application that is compatible with the previous version.</span></span> <span data-ttu-id="b10a9-116">The second step is to upgrade the final version that breaks compatibility with the pre-update version, but is compatible with the intermediate version.</span><span class="sxs-lookup"><span data-stu-id="b10a9-116">The second step is to upgrade the final version that breaks compatibility with the pre-update version, but is compatible with the intermediate version.</span></span>

<span data-ttu-id="b10a9-117">Update domains are specified in the cluster manifest when you configure the cluster.</span><span class="sxs-lookup"><span data-stu-id="b10a9-117">Update domains are specified in the cluster manifest when you configure the cluster.</span></span> <span data-ttu-id="b10a9-118">Update domains do not receive updates in a particular order.</span><span class="sxs-lookup"><span data-stu-id="b10a9-118">Update domains do not receive updates in a particular order.</span></span> <span data-ttu-id="b10a9-119">An update domain is a logical unit of deployment for an application.</span><span class="sxs-lookup"><span data-stu-id="b10a9-119">An update domain is a logical unit of deployment for an application.</span></span> <span data-ttu-id="b10a9-120">Update domains allow the services to remain at high availability during an upgrade.</span><span class="sxs-lookup"><span data-stu-id="b10a9-120">Update domains allow the services to remain at high availability during an upgrade.</span></span>

<span data-ttu-id="b10a9-121">Non-rolling upgrades are possible if the upgrade is applied to all nodes in the cluster, which is the case when the application has only one update domain.</span><span class="sxs-lookup"><span data-stu-id="b10a9-121">Non-rolling upgrades are possible if the upgrade is applied to all nodes in the cluster, which is the case when the application has only one update domain.</span></span> <span data-ttu-id="b10a9-122">This approach is not recommended, since the service goes down and isn't available at the time of upgrade.</span><span class="sxs-lookup"><span data-stu-id="b10a9-122">This approach is not recommended, since the service goes down and isn't available at the time of upgrade.</span></span> <span data-ttu-id="b10a9-123">Additionally, Azure doesn't provide any guarantees when a cluster is set up with only one update domain.</span><span class="sxs-lookup"><span data-stu-id="b10a9-123">Additionally, Azure doesn't provide any guarantees when a cluster is set up with only one update domain.</span></span>

<span data-ttu-id="b10a9-124">After the upgrade completes, all the services and replicas(instances) would stay in the same version-i.e., if the upgrade succeeds, they will be updated to the new version; if the upgrade fails and is rolled back, they would be rolled back to the old version.</span><span class="sxs-lookup"><span data-stu-id="b10a9-124">After the upgrade completes, all the services and replicas(instances) would stay in the same version-i.e., if the upgrade succeeds, they will be updated to the new version; if the upgrade fails and is rolled back, they would be rolled back to the old version.</span></span>

## <a name="health-checks-during-upgrades"></a><span data-ttu-id="b10a9-125">Health checks during upgrades</span><span class="sxs-lookup"><span data-stu-id="b10a9-125">Health checks during upgrades</span></span>
<span data-ttu-id="b10a9-126">For an upgrade, health policies have to be set (or default values may be used).</span><span class="sxs-lookup"><span data-stu-id="b10a9-126">For an upgrade, health policies have to be set (or default values may be used).</span></span> <span data-ttu-id="b10a9-127">An upgrade is termed successful when all update domains are upgraded within the specified time-outs, and when all update domains are deemed healthy.</span><span class="sxs-lookup"><span data-stu-id="b10a9-127">An upgrade is termed successful when all update domains are upgraded within the specified time-outs, and when all update domains are deemed healthy.</span></span>  <span data-ttu-id="b10a9-128">A healthy update domain means that the update domain passed all the health checks specified in the health policy.</span><span class="sxs-lookup"><span data-stu-id="b10a9-128">A healthy update domain means that the update domain passed all the health checks specified in the health policy.</span></span> <span data-ttu-id="b10a9-129">For example, a health policy may mandate that all services within an application instance must be *healthy*, as health is defined by Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="b10a9-129">For example, a health policy may mandate that all services within an application instance must be *healthy*, as health is defined by Service Fabric.</span></span>

<span data-ttu-id="b10a9-130">Health policies and checks during upgrade by Service Fabric are service and application agnostic.</span><span class="sxs-lookup"><span data-stu-id="b10a9-130">Health policies and checks during upgrade by Service Fabric are service and application agnostic.</span></span> <span data-ttu-id="b10a9-131">That is, no service-specific tests are done.</span><span class="sxs-lookup"><span data-stu-id="b10a9-131">That is, no service-specific tests are done.</span></span>  <span data-ttu-id="b10a9-132">For example, your service might have a throughput requirement, but Service Fabric does not have the information to check throughput.</span><span class="sxs-lookup"><span data-stu-id="b10a9-132">For example, your service might have a throughput requirement, but Service Fabric does not have the information to check throughput.</span></span> <span data-ttu-id="b10a9-133">Refer to the [health articles](service-fabric-health-introduction.md) for the checks that are performed.</span><span class="sxs-lookup"><span data-stu-id="b10a9-133">Refer to the [health articles](service-fabric-health-introduction.md) for the checks that are performed.</span></span> <span data-ttu-id="b10a9-134">The checks that happen during an upgrade include tests for whether the application package was copied correctly, whether the instance was started, and so on.</span><span class="sxs-lookup"><span data-stu-id="b10a9-134">The checks that happen during an upgrade include tests for whether the application package was copied correctly, whether the instance was started, and so on.</span></span>

<span data-ttu-id="b10a9-135">The application health is an aggregation of the child entities of the application.</span><span class="sxs-lookup"><span data-stu-id="b10a9-135">The application health is an aggregation of the child entities of the application.</span></span> <span data-ttu-id="b10a9-136">In short, Service Fabric evaluates the health of the application through the health that is reported on the application.</span><span class="sxs-lookup"><span data-stu-id="b10a9-136">In short, Service Fabric evaluates the health of the application through the health that is reported on the application.</span></span> <span data-ttu-id="b10a9-137">It also evaluates the health of all the services for the application this way.</span><span class="sxs-lookup"><span data-stu-id="b10a9-137">It also evaluates the health of all the services for the application this way.</span></span> <span data-ttu-id="b10a9-138">Service Fabric further evaluates the health of the application services by aggregating the health of their children, such as the service replica.</span><span class="sxs-lookup"><span data-stu-id="b10a9-138">Service Fabric further evaluates the health of the application services by aggregating the health of their children, such as the service replica.</span></span> <span data-ttu-id="b10a9-139">Once the application health policy is satisfied, the upgrade can proceed.</span><span class="sxs-lookup"><span data-stu-id="b10a9-139">Once the application health policy is satisfied, the upgrade can proceed.</span></span> <span data-ttu-id="b10a9-140">If the health policy is violated, the application upgrade fails.</span><span class="sxs-lookup"><span data-stu-id="b10a9-140">If the health policy is violated, the application upgrade fails.</span></span>

## <a name="upgrade-modes"></a><span data-ttu-id="b10a9-141">Upgrade modes</span><span class="sxs-lookup"><span data-stu-id="b10a9-141">Upgrade modes</span></span>
<span data-ttu-id="b10a9-142">The mode that we recommend for application upgrade is the monitored mode, which is the commonly used mode.</span><span class="sxs-lookup"><span data-stu-id="b10a9-142">The mode that we recommend for application upgrade is the monitored mode, which is the commonly used mode.</span></span> <span data-ttu-id="b10a9-143">Monitored mode performs the upgrade on one update domain, and if all health checks pass (per the policy specified), moves on to the next update domain automatically.</span><span class="sxs-lookup"><span data-stu-id="b10a9-143">Monitored mode performs the upgrade on one update domain, and if all health checks pass (per the policy specified), moves on to the next update domain automatically.</span></span>  <span data-ttu-id="b10a9-144">If health checks fail and/or time-outs are reached, the upgrade is either rolled back for the update domain, or the mode is changed to unmonitored manual.</span><span class="sxs-lookup"><span data-stu-id="b10a9-144">If health checks fail and/or time-outs are reached, the upgrade is either rolled back for the update domain, or the mode is changed to unmonitored manual.</span></span> <span data-ttu-id="b10a9-145">You can configure the upgrade to choose one of those two modes for failed upgrades.</span><span class="sxs-lookup"><span data-stu-id="b10a9-145">You can configure the upgrade to choose one of those two modes for failed upgrades.</span></span> 

<span data-ttu-id="b10a9-146">Unmonitored manual mode needs manual intervention after every upgrade on an update domain, to kick off the upgrade on the next update domain.</span><span class="sxs-lookup"><span data-stu-id="b10a9-146">Unmonitored manual mode needs manual intervention after every upgrade on an update domain, to kick off the upgrade on the next update domain.</span></span> <span data-ttu-id="b10a9-147">No Service Fabric health checks are performed.</span><span class="sxs-lookup"><span data-stu-id="b10a9-147">No Service Fabric health checks are performed.</span></span> <span data-ttu-id="b10a9-148">The administrator performs the health or status checks before starting the upgrade in the next update domain.</span><span class="sxs-lookup"><span data-stu-id="b10a9-148">The administrator performs the health or status checks before starting the upgrade in the next update domain.</span></span>

## <a name="upgrade-default-services"></a><span data-ttu-id="b10a9-149">Upgrade default services</span><span class="sxs-lookup"><span data-stu-id="b10a9-149">Upgrade default services</span></span>
<span data-ttu-id="b10a9-150">Some default service parameters defined in the [application manifest](service-fabric-application-and-service-manifests.md) can also be upgraded as part of an application upgrade.</span><span class="sxs-lookup"><span data-stu-id="b10a9-150">Some default service parameters defined in the [application manifest](service-fabric-application-and-service-manifests.md) can also be upgraded as part of an application upgrade.</span></span> <span data-ttu-id="b10a9-151">Only the service parameters that support being changed through [Update-ServiceFabricService](https://docs.microsoft.com/powershell/module/servicefabric/update-servicefabricservice?view=azureservicefabricps) can be changed as part of an upgrade.</span><span class="sxs-lookup"><span data-stu-id="b10a9-151">Only the service parameters that support being changed through [Update-ServiceFabricService](https://docs.microsoft.com/powershell/module/servicefabric/update-servicefabricservice?view=azureservicefabricps) can be changed as part of an upgrade.</span></span> <span data-ttu-id="b10a9-152">The behavior of changing default services during application upgrade is as follows:</span><span class="sxs-lookup"><span data-stu-id="b10a9-152">The behavior of changing default services during application upgrade is as follows:</span></span>

1. <span data-ttu-id="b10a9-153">Default services in the new application manifest that do not already exist in the cluster are created.</span><span class="sxs-lookup"><span data-stu-id="b10a9-153">Default services in the new application manifest that do not already exist in the cluster are created.</span></span>
2. <span data-ttu-id="b10a9-154">Default services that exist in both the previous and new application manifests are updated.</span><span class="sxs-lookup"><span data-stu-id="b10a9-154">Default services that exist in both the previous and new application manifests are updated.</span></span> <span data-ttu-id="b10a9-155">The parameters of the default service in the new application manifest overwrite the parameters of the existing service.</span><span class="sxs-lookup"><span data-stu-id="b10a9-155">The parameters of the default service in the new application manifest overwrite the parameters of the existing service.</span></span> <span data-ttu-id="b10a9-156">The application upgrade will rollback automatically if updating a default service fails.</span><span class="sxs-lookup"><span data-stu-id="b10a9-156">The application upgrade will rollback automatically if updating a default service fails.</span></span>
3. <span data-ttu-id="b10a9-157">Default services that do not exist in the new application manifest are deleted if they exist in the cluster.</span><span class="sxs-lookup"><span data-stu-id="b10a9-157">Default services that do not exist in the new application manifest are deleted if they exist in the cluster.</span></span> <span data-ttu-id="b10a9-158">**Note that deleting a default service will result in deleting all that service's state and cannot be undone.**</span><span class="sxs-lookup"><span data-stu-id="b10a9-158">**Note that deleting a default service will result in deleting all that service's state and cannot be undone.**</span></span>

<span data-ttu-id="b10a9-159">When an application upgrade is rolled back, default service parameters are reverted back to their old values before the upgrade started but deleted services cannot be re-created with their old state.</span><span class="sxs-lookup"><span data-stu-id="b10a9-159">When an application upgrade is rolled back, default service parameters are reverted back to their old values before the upgrade started but deleted services cannot be re-created with their old state.</span></span>

> [!TIP]
> <span data-ttu-id="b10a9-160">The [EnableDefaultServicesUpgrade](service-fabric-cluster-fabric-settings.md) cluster config setting must be *true* to enable rules 2) and 3) above (default service update and deletion).</span><span class="sxs-lookup"><span data-stu-id="b10a9-160">The [EnableDefaultServicesUpgrade](service-fabric-cluster-fabric-settings.md) cluster config setting must be *true* to enable rules 2) and 3) above (default service update and deletion).</span></span> <span data-ttu-id="b10a9-161">This feature is supported starting in Service Fabric version 5.5.</span><span class="sxs-lookup"><span data-stu-id="b10a9-161">This feature is supported starting in Service Fabric version 5.5.</span></span>

## <a name="upgrading-multiple-applications-with-https-endpoints"></a><span data-ttu-id="b10a9-162">Upgrading multiple applications with HTTPS endpoints</span><span class="sxs-lookup"><span data-stu-id="b10a9-162">Upgrading multiple applications with HTTPS endpoints</span></span>
<span data-ttu-id="b10a9-163">You need to be careful not to use the **same port** for different instances of the same application when using HTTP**S**.</span><span class="sxs-lookup"><span data-stu-id="b10a9-163">You need to be careful not to use the **same port** for different instances of the same application when using HTTP**S**.</span></span> <span data-ttu-id="b10a9-164">The reason is that Service Fabric won't be able to upgrade the cert for one of the application instances.</span><span class="sxs-lookup"><span data-stu-id="b10a9-164">The reason is that Service Fabric won't be able to upgrade the cert for one of the application instances.</span></span> <span data-ttu-id="b10a9-165">For example, if application 1 or application 2 both want to upgrade their cert 1 to cert 2.</span><span class="sxs-lookup"><span data-stu-id="b10a9-165">For example, if application 1 or application 2 both want to upgrade their cert 1 to cert 2.</span></span> <span data-ttu-id="b10a9-166">When the upgrade happens, Service Fabric might have cleaned up the cert 1 registration with http.sys even though the other application is still using it.</span><span class="sxs-lookup"><span data-stu-id="b10a9-166">When the upgrade happens, Service Fabric might have cleaned up the cert 1 registration with http.sys even though the other application is still using it.</span></span> <span data-ttu-id="b10a9-167">To prevent this, Service Fabric detects that there is already another application instance registered on the port with the certificate (due to http.sys) and fails the operation.</span><span class="sxs-lookup"><span data-stu-id="b10a9-167">To prevent this, Service Fabric detects that there is already another application instance registered on the port with the certificate (due to http.sys) and fails the operation.</span></span>

<span data-ttu-id="b10a9-168">Hence Service Fabric does not support upgrading two different services using **the same port** in different application instances.</span><span class="sxs-lookup"><span data-stu-id="b10a9-168">Hence Service Fabric does not support upgrading two different services using **the same port** in different application instances.</span></span> <span data-ttu-id="b10a9-169">In other words, you cannot use the same certificate on different services on the same port.</span><span class="sxs-lookup"><span data-stu-id="b10a9-169">In other words, you cannot use the same certificate on different services on the same port.</span></span> <span data-ttu-id="b10a9-170">If you need to have a shared certificate on the same port, you need to ensure that the services are placed on different machines with placement constraints.</span><span class="sxs-lookup"><span data-stu-id="b10a9-170">If you need to have a shared certificate on the same port, you need to ensure that the services are placed on different machines with placement constraints.</span></span> <span data-ttu-id="b10a9-171">Or consider using Service Fabric dynamic ports if possible for each service in each application instance.</span><span class="sxs-lookup"><span data-stu-id="b10a9-171">Or consider using Service Fabric dynamic ports if possible for each service in each application instance.</span></span> 

<span data-ttu-id="b10a9-172">If you see an upgrade fail with https, an error warning saying "The Windows HTTP Server API does not support multiple certificates for applications that share a port.”</span><span class="sxs-lookup"><span data-stu-id="b10a9-172">If you see an upgrade fail with https, an error warning saying "The Windows HTTP Server API does not support multiple certificates for applications that share a port.”</span></span>

## <a name="application-upgrade-flowchart"></a><span data-ttu-id="b10a9-173">Application upgrade flowchart</span><span class="sxs-lookup"><span data-stu-id="b10a9-173">Application upgrade flowchart</span></span>
<span data-ttu-id="b10a9-174">The flowchart following this paragraph can help you understand the upgrade process of a Service Fabric application.</span><span class="sxs-lookup"><span data-stu-id="b10a9-174">The flowchart following this paragraph can help you understand the upgrade process of a Service Fabric application.</span></span> <span data-ttu-id="b10a9-175">In particular, the flow describes how the time-outs, including *HealthCheckStableDuration*, *HealthCheckRetryTimeout*, and *UpgradeHealthCheckInterval*, help control when the upgrade in one update domain is considered a success or a failure.</span><span class="sxs-lookup"><span data-stu-id="b10a9-175">In particular, the flow describes how the time-outs, including *HealthCheckStableDuration*, *HealthCheckRetryTimeout*, and *UpgradeHealthCheckInterval*, help control when the upgrade in one update domain is considered a success or a failure.</span></span>

![The upgrade process for a Service Fabric Application][image]

## <a name="next-steps"></a><span data-ttu-id="b10a9-177">Next steps</span><span class="sxs-lookup"><span data-stu-id="b10a9-177">Next steps</span></span>
<span data-ttu-id="b10a9-178">[Upgrading your Application Using Visual Studio](service-fabric-application-upgrade-tutorial.md) walks you through an application upgrade using Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="b10a9-178">[Upgrading your Application Using Visual Studio](service-fabric-application-upgrade-tutorial.md) walks you through an application upgrade using Visual Studio.</span></span>

<span data-ttu-id="b10a9-179">[Upgrading your Application Using PowerShell](service-fabric-application-upgrade-tutorial-powershell.md) walks you through an application upgrade using PowerShell.</span><span class="sxs-lookup"><span data-stu-id="b10a9-179">[Upgrading your Application Using PowerShell](service-fabric-application-upgrade-tutorial-powershell.md) walks you through an application upgrade using PowerShell.</span></span>

<span data-ttu-id="b10a9-180">Control how your application upgrades by using [Upgrade Parameters](service-fabric-application-upgrade-parameters.md).</span><span class="sxs-lookup"><span data-stu-id="b10a9-180">Control how your application upgrades by using [Upgrade Parameters](service-fabric-application-upgrade-parameters.md).</span></span>

<span data-ttu-id="b10a9-181">Make your application upgrades compatible by learning how to use [Data Serialization](service-fabric-application-upgrade-data-serialization.md).</span><span class="sxs-lookup"><span data-stu-id="b10a9-181">Make your application upgrades compatible by learning how to use [Data Serialization](service-fabric-application-upgrade-data-serialization.md).</span></span>

<span data-ttu-id="b10a9-182">Learn how to use advanced functionality while upgrading your application by referring to [Advanced Topics](service-fabric-application-upgrade-advanced.md).</span><span class="sxs-lookup"><span data-stu-id="b10a9-182">Learn how to use advanced functionality while upgrading your application by referring to [Advanced Topics](service-fabric-application-upgrade-advanced.md).</span></span>

<span data-ttu-id="b10a9-183">Fix common problems in application upgrades by referring to the steps in [Troubleshooting Application Upgrades](service-fabric-application-upgrade-troubleshooting.md).</span><span class="sxs-lookup"><span data-stu-id="b10a9-183">Fix common problems in application upgrades by referring to the steps in [Troubleshooting Application Upgrades](service-fabric-application-upgrade-troubleshooting.md).</span></span>

[image]: media/service-fabric-application-upgrade/service-fabric-application-upgrade-flowchart.png
