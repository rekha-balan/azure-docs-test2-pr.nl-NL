---
title: Overview of the lifecycle of Azure Service Fabric Reliable Services | Microsoft Docs
description: Learn about the different lifecycle events in Service Fabric reliable services
services: Service-Fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: vturecek;
ms.assetid: ''
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 01/05/2017
ms.author: masnider;
ms.openlocfilehash: 1237f467cf993170eaf1345134fb732d4f0b1171
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44563897"
---
# <a name="reliable-services-lifecycle-overview"></a><span data-ttu-id="1b130-103">Reliable services lifecycle overview</span><span class="sxs-lookup"><span data-stu-id="1b130-103">Reliable services lifecycle overview</span></span>
> [!div class="op_single_selector"]
> * [C# on Windows](service-fabric-reliable-services-lifecycle.md)
> * [Java on Linux](service-fabric-reliable-services-lifecycle-java.md)
>
>

<span data-ttu-id="1b130-106">When thinking about the lifecycles of Reliable Services, the basics of the lifecycle are the most important.</span><span class="sxs-lookup"><span data-stu-id="1b130-106">When thinking about the lifecycles of Reliable Services, the basics of the lifecycle are the most important.</span></span> <span data-ttu-id="1b130-107">In general:</span><span class="sxs-lookup"><span data-stu-id="1b130-107">In general:</span></span>

* <span data-ttu-id="1b130-108">During Startup</span><span class="sxs-lookup"><span data-stu-id="1b130-108">During Startup</span></span>
  * <span data-ttu-id="1b130-109">Services are constructed</span><span class="sxs-lookup"><span data-stu-id="1b130-109">Services are constructed</span></span>
  * <span data-ttu-id="1b130-110">They have an opportunity to construct and return zero or more listeners</span><span class="sxs-lookup"><span data-stu-id="1b130-110">They have an opportunity to construct and return zero or more listeners</span></span>
  * <span data-ttu-id="1b130-111">Any returned listeners are opened, allowing communication with the service</span><span class="sxs-lookup"><span data-stu-id="1b130-111">Any returned listeners are opened, allowing communication with the service</span></span>
  * <span data-ttu-id="1b130-112">The Service's RunAsync method is called, allowing the service to do long running or background work</span><span class="sxs-lookup"><span data-stu-id="1b130-112">The Service's RunAsync method is called, allowing the service to do long running or background work</span></span>
* <span data-ttu-id="1b130-113">During shutdown</span><span class="sxs-lookup"><span data-stu-id="1b130-113">During shutdown</span></span>
  * <span data-ttu-id="1b130-114">The cancellation token passed to RunAsync is canceled, and the listeners are closed</span><span class="sxs-lookup"><span data-stu-id="1b130-114">The cancellation token passed to RunAsync is canceled, and the listeners are closed</span></span>
  * <span data-ttu-id="1b130-115">Once that is complete, the service object itself is destructed</span><span class="sxs-lookup"><span data-stu-id="1b130-115">Once that is complete, the service object itself is destructed</span></span>

<span data-ttu-id="1b130-116">There are details around the exact ordering of these events.</span><span class="sxs-lookup"><span data-stu-id="1b130-116">There are details around the exact ordering of these events.</span></span> <span data-ttu-id="1b130-117">In particular, the order of events may change slightly depending on whether the Reliable Service is Stateless or Stateful.</span><span class="sxs-lookup"><span data-stu-id="1b130-117">In particular, the order of events may change slightly depending on whether the Reliable Service is Stateless or Stateful.</span></span> <span data-ttu-id="1b130-118">In addition, for stateful services, we have to deal with the Primary swap scenario.</span><span class="sxs-lookup"><span data-stu-id="1b130-118">In addition, for stateful services, we have to deal with the Primary swap scenario.</span></span> <span data-ttu-id="1b130-119">During this sequence, the role of Primary is transferred to another replica (or comes back) without the service shutting down.</span><span class="sxs-lookup"><span data-stu-id="1b130-119">During this sequence, the role of Primary is transferred to another replica (or comes back) without the service shutting down.</span></span> <span data-ttu-id="1b130-120">Finally, we have to think about error or failure conditions.</span><span class="sxs-lookup"><span data-stu-id="1b130-120">Finally, we have to think about error or failure conditions.</span></span>

## <a name="stateless-service-startup"></a><span data-ttu-id="1b130-121">Stateless service startup</span><span class="sxs-lookup"><span data-stu-id="1b130-121">Stateless service startup</span></span>
<span data-ttu-id="1b130-122">The lifecycle of a stateless service is fairly straightforward.</span><span class="sxs-lookup"><span data-stu-id="1b130-122">The lifecycle of a stateless service is fairly straightforward.</span></span> <span data-ttu-id="1b130-123">Here's the order of events:</span><span class="sxs-lookup"><span data-stu-id="1b130-123">Here's the order of events:</span></span>

1. <span data-ttu-id="1b130-124">The Service is constructed</span><span class="sxs-lookup"><span data-stu-id="1b130-124">The Service is constructed</span></span>
2. <span data-ttu-id="1b130-125">Then, in parallel two things happen:</span><span class="sxs-lookup"><span data-stu-id="1b130-125">Then, in parallel two things happen:</span></span>
    - <span data-ttu-id="1b130-126">`StatelessService.CreateServiceInstanceListeners()` is invoked and any returned listeners are Opened (`ICommunicationListener.OpenAsync()` is called on each listener)</span><span class="sxs-lookup"><span data-stu-id="1b130-126">`StatelessService.CreateServiceInstanceListeners()` is invoked and any returned listeners are Opened (`ICommunicationListener.OpenAsync()` is called on each listener)</span></span>
    - <span data-ttu-id="1b130-127">The service's RunAsync method (`StatelessService.RunAsync()`) is called</span><span class="sxs-lookup"><span data-stu-id="1b130-127">The service's RunAsync method (`StatelessService.RunAsync()`) is called</span></span>
3. <span data-ttu-id="1b130-128">If present, the service's own OnOpenAsync method is called (Specifically, `StatelessService.OnOpenAsync()` is called.</span><span class="sxs-lookup"><span data-stu-id="1b130-128">If present, the service's own OnOpenAsync method is called (Specifically, `StatelessService.OnOpenAsync()` is called.</span></span> <span data-ttu-id="1b130-129">This is an uncommon override but it is available).</span><span class="sxs-lookup"><span data-stu-id="1b130-129">This is an uncommon override but it is available).</span></span>

<span data-ttu-id="1b130-130">It is important to note that there is no ordering between the calls to create and open the listeners and RunAsync.</span><span class="sxs-lookup"><span data-stu-id="1b130-130">It is important to note that there is no ordering between the calls to create and open the listeners and RunAsync.</span></span> <span data-ttu-id="1b130-131">The listeners may open before RunAsync is started.</span><span class="sxs-lookup"><span data-stu-id="1b130-131">The listeners may open before RunAsync is started.</span></span> <span data-ttu-id="1b130-132">Similarly, RunAsync may end up invoked before the communication listeners are open or have even been constructed.</span><span class="sxs-lookup"><span data-stu-id="1b130-132">Similarly, RunAsync may end up invoked before the communication listeners are open or have even been constructed.</span></span> <span data-ttu-id="1b130-133">If any synchronization is required, it is left as an exercise to the implementer.</span><span class="sxs-lookup"><span data-stu-id="1b130-133">If any synchronization is required, it is left as an exercise to the implementer.</span></span> <span data-ttu-id="1b130-134">Common solutions:</span><span class="sxs-lookup"><span data-stu-id="1b130-134">Common solutions:</span></span>

* <span data-ttu-id="1b130-135">Sometimes listeners can't function until some other information is created or work done.</span><span class="sxs-lookup"><span data-stu-id="1b130-135">Sometimes listeners can't function until some other information is created or work done.</span></span> <span data-ttu-id="1b130-136">For stateless services that work can usually be done in the service's constructor, during the `CreateServiceInstanceListeners()` call, or as a part of the construction of the listener itself.</span><span class="sxs-lookup"><span data-stu-id="1b130-136">For stateless services that work can usually be done in the service's constructor, during the `CreateServiceInstanceListeners()` call, or as a part of the construction of the listener itself.</span></span>
* <span data-ttu-id="1b130-137">Sometimes the code in RunAsync does not want to start until the listeners are open.</span><span class="sxs-lookup"><span data-stu-id="1b130-137">Sometimes the code in RunAsync does not want to start until the listeners are open.</span></span> <span data-ttu-id="1b130-138">In this case additional coordination is necessary.</span><span class="sxs-lookup"><span data-stu-id="1b130-138">In this case additional coordination is necessary.</span></span> <span data-ttu-id="1b130-139">One common solution is some flag within the listeners indicating when they have completed, which is checked in RunAsync before continuing to actual work.</span><span class="sxs-lookup"><span data-stu-id="1b130-139">One common solution is some flag within the listeners indicating when they have completed, which is checked in RunAsync before continuing to actual work.</span></span>

## <a name="stateless-service-shutdown"></a><span data-ttu-id="1b130-140">Stateless service shutdown</span><span class="sxs-lookup"><span data-stu-id="1b130-140">Stateless service shutdown</span></span>
<span data-ttu-id="1b130-141">When shutting down a stateless service, the same pattern is followed, just in reverse:</span><span class="sxs-lookup"><span data-stu-id="1b130-141">When shutting down a stateless service, the same pattern is followed, just in reverse:</span></span>

1. <span data-ttu-id="1b130-142">In parallel</span><span class="sxs-lookup"><span data-stu-id="1b130-142">In parallel</span></span>
    - <span data-ttu-id="1b130-143">Any open listeners are Closed (`ICommunicationListener.CloseAsync()` is called on each listener)</span><span class="sxs-lookup"><span data-stu-id="1b130-143">Any open listeners are Closed (`ICommunicationListener.CloseAsync()` is called on each listener)</span></span>
    - <span data-ttu-id="1b130-144">The cancellation token passed to `RunAsync()` is canceled (checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method returns an `OperationCanceledException`)</span><span class="sxs-lookup"><span data-stu-id="1b130-144">The cancellation token passed to `RunAsync()` is canceled (checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method returns an `OperationCanceledException`)</span></span>
2. <span data-ttu-id="1b130-145">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, the service's `StatelessService.OnCloseAsync()` method is called, if present (again this is an uncommon override).</span><span class="sxs-lookup"><span data-stu-id="1b130-145">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, the service's `StatelessService.OnCloseAsync()` method is called, if present (again this is an uncommon override).</span></span>
3. <span data-ttu-id="1b130-146">After `StatelessService.OnCloseAsync()` completes, the service object is destructed</span><span class="sxs-lookup"><span data-stu-id="1b130-146">After `StatelessService.OnCloseAsync()` completes, the service object is destructed</span></span>

## <a name="stateful-service-startup"></a><span data-ttu-id="1b130-147">Stateful service Startup</span><span class="sxs-lookup"><span data-stu-id="1b130-147">Stateful service Startup</span></span>
<span data-ttu-id="1b130-148">Stateful services have a similar pattern to stateless services, with a few changes.</span><span class="sxs-lookup"><span data-stu-id="1b130-148">Stateful services have a similar pattern to stateless services, with a few changes.</span></span> <span data-ttu-id="1b130-149">When starting up a stateful service, the order of events is as follows:</span><span class="sxs-lookup"><span data-stu-id="1b130-149">When starting up a stateful service, the order of events is as follows:</span></span>

1. <span data-ttu-id="1b130-150">The Service is constructed</span><span class="sxs-lookup"><span data-stu-id="1b130-150">The Service is constructed</span></span>
2. <span data-ttu-id="1b130-151">`StatefulServiceBase.OnOpenAsync()` is called.</span><span class="sxs-lookup"><span data-stu-id="1b130-151">`StatefulServiceBase.OnOpenAsync()` is called.</span></span> <span data-ttu-id="1b130-152">(This is uncommonly overridden in the service.)</span><span class="sxs-lookup"><span data-stu-id="1b130-152">(This is uncommonly overridden in the service.)</span></span>
3. <span data-ttu-id="1b130-153">If the service replica in question is the Primary, then the following things happen in parallel, otherwise the service skips to step 4</span><span class="sxs-lookup"><span data-stu-id="1b130-153">If the service replica in question is the Primary, then the following things happen in parallel, otherwise the service skips to step 4</span></span>
    - <span data-ttu-id="1b130-154">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened (`ICommunicationListener.OpenAsync()` is called on each listener)</span><span class="sxs-lookup"><span data-stu-id="1b130-154">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened (`ICommunicationListener.OpenAsync()` is called on each listener)</span></span>
    - <span data-ttu-id="1b130-155">The service's RunAsync method (`StatefulServiceBase.RunAsync()`) is called</span><span class="sxs-lookup"><span data-stu-id="1b130-155">The service's RunAsync method (`StatefulServiceBase.RunAsync()`) is called</span></span>
4. <span data-ttu-id="1b130-156">Once all the replica listener's `OpenAsync()` calls complete and `RunAsync()` has been started (or these steps were skipped because this replica is currently a secondary), `StatefulServiceBase.OnChangeRoleAsync()` is called.</span><span class="sxs-lookup"><span data-stu-id="1b130-156">Once all the replica listener's `OpenAsync()` calls complete and `RunAsync()` has been started (or these steps were skipped because this replica is currently a secondary), `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="1b130-157">(This is uncommonly overridden in the service.)</span><span class="sxs-lookup"><span data-stu-id="1b130-157">(This is uncommonly overridden in the service.)</span></span>

<span data-ttu-id="1b130-158">Similarly to stateless services, there's no coordination between the order in which the listeners are created and opened and RunAsync being called.</span><span class="sxs-lookup"><span data-stu-id="1b130-158">Similarly to stateless services, there's no coordination between the order in which the listeners are created and opened and RunAsync being called.</span></span> <span data-ttu-id="1b130-159">The solutions are much the same, with one additional case: say that the calls arriving at the communication listeners require information kept inside some [Reliable Collections](service-fabric-reliable-services-reliable-collections.md) to work.</span><span class="sxs-lookup"><span data-stu-id="1b130-159">The solutions are much the same, with one additional case: say that the calls arriving at the communication listeners require information kept inside some [Reliable Collections](service-fabric-reliable-services-reliable-collections.md) to work.</span></span> <span data-ttu-id="1b130-160">Because the communication listeners could open before the reliable collections are readable or writeable, and before RunAsync could start, some additional coordination is necessary.</span><span class="sxs-lookup"><span data-stu-id="1b130-160">Because the communication listeners could open before the reliable collections are readable or writeable, and before RunAsync could start, some additional coordination is necessary.</span></span> <span data-ttu-id="1b130-161">The simplest and most common solution is for the communication listeners to return some error code that the client uses to know to retry the request.</span><span class="sxs-lookup"><span data-stu-id="1b130-161">The simplest and most common solution is for the communication listeners to return some error code that the client uses to know to retry the request.</span></span>

## <a name="stateful-service-shutdown"></a><span data-ttu-id="1b130-162">Stateful service Shutdown</span><span class="sxs-lookup"><span data-stu-id="1b130-162">Stateful service Shutdown</span></span>
<span data-ttu-id="1b130-163">Similarly to Stateless services, the lifecycle events during shutdown are the same as during startup, but reversed.</span><span class="sxs-lookup"><span data-stu-id="1b130-163">Similarly to Stateless services, the lifecycle events during shutdown are the same as during startup, but reversed.</span></span> <span data-ttu-id="1b130-164">When a stateful service is being shut down, the following events occur:</span><span class="sxs-lookup"><span data-stu-id="1b130-164">When a stateful service is being shut down, the following events occur:</span></span>

1. <span data-ttu-id="1b130-165">In parallel</span><span class="sxs-lookup"><span data-stu-id="1b130-165">In parallel</span></span>
    - <span data-ttu-id="1b130-166">Any open listeners are Closed (`ICommunicationListener.CloseAsync()` is called on each listener)</span><span class="sxs-lookup"><span data-stu-id="1b130-166">Any open listeners are Closed (`ICommunicationListener.CloseAsync()` is called on each listener)</span></span>
    - <span data-ttu-id="1b130-167">The cancellation token passed to `RunAsync()` is canceled (checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method returns an `OperationCanceledException`)</span><span class="sxs-lookup"><span data-stu-id="1b130-167">The cancellation token passed to `RunAsync()` is canceled (checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method returns an `OperationCanceledException`)</span></span>
2. <span data-ttu-id="1b130-168">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes (which should only have been necessary if this service replica was a Primary), the service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span><span class="sxs-lookup"><span data-stu-id="1b130-168">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes (which should only have been necessary if this service replica was a Primary), the service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="1b130-169">(This is uncommonly overridden in the service.)</span><span class="sxs-lookup"><span data-stu-id="1b130-169">(This is uncommonly overridden in the service.)</span></span>
3. <span data-ttu-id="1b130-170">Once the `StatefulServiceBase.OnChangeRoleAsync()` method completes, the `StatefulServiceBase.OnCloseAsync()` method is called (again this is an uncommon override but it is available).</span><span class="sxs-lookup"><span data-stu-id="1b130-170">Once the `StatefulServiceBase.OnChangeRoleAsync()` method completes, the `StatefulServiceBase.OnCloseAsync()` method is called (again this is an uncommon override but it is available).</span></span>
3. <span data-ttu-id="1b130-171">After `StatefulServiceBase.OnCloseAsync()` completes, the service object is destructed.</span><span class="sxs-lookup"><span data-stu-id="1b130-171">After `StatefulServiceBase.OnCloseAsync()` completes, the service object is destructed.</span></span>

## <a name="stateful-service-primary-swaps"></a><span data-ttu-id="1b130-172">Stateful service primary swaps</span><span class="sxs-lookup"><span data-stu-id="1b130-172">Stateful service primary swaps</span></span>
<span data-ttu-id="1b130-173">While a stateful service is running, only the Primary replicas of that stateful services have their communication listeners opened and their RunAsync method called.</span><span class="sxs-lookup"><span data-stu-id="1b130-173">While a stateful service is running, only the Primary replicas of that stateful services have their communication listeners opened and their RunAsync method called.</span></span> <span data-ttu-id="1b130-174">Secondary are constructed but see no further calls.</span><span class="sxs-lookup"><span data-stu-id="1b130-174">Secondary are constructed but see no further calls.</span></span> <span data-ttu-id="1b130-175">While a stateful service is running however, which replica is currently the Primary can change.</span><span class="sxs-lookup"><span data-stu-id="1b130-175">While a stateful service is running however, which replica is currently the Primary can change.</span></span> <span data-ttu-id="1b130-176">What does this mean in terms of the lifecycle events that a replica can see?</span><span class="sxs-lookup"><span data-stu-id="1b130-176">What does this mean in terms of the lifecycle events that a replica can see?</span></span> <span data-ttu-id="1b130-177">The behavior the stateful replica sees depends on whether it is the replica being demoted or promoted during the swap.</span><span class="sxs-lookup"><span data-stu-id="1b130-177">The behavior the stateful replica sees depends on whether it is the replica being demoted or promoted during the swap.</span></span>

### <a name="for-the-primary-being-demoted"></a><span data-ttu-id="1b130-178">For the primary being demoted</span><span class="sxs-lookup"><span data-stu-id="1b130-178">For the primary being demoted</span></span>
<span data-ttu-id="1b130-179">Service Fabric needs this replica to stop processing messages and quit any background work it is doing.</span><span class="sxs-lookup"><span data-stu-id="1b130-179">Service Fabric needs this replica to stop processing messages and quit any background work it is doing.</span></span> <span data-ttu-id="1b130-180">As a result, this step looks similar to when the service is being shut down.</span><span class="sxs-lookup"><span data-stu-id="1b130-180">As a result, this step looks similar to when the service is being shut down.</span></span> <span data-ttu-id="1b130-181">One difference is that the Service isn't destructed or closed since it remains as a Secondary.</span><span class="sxs-lookup"><span data-stu-id="1b130-181">One difference is that the Service isn't destructed or closed since it remains as a Secondary.</span></span> <span data-ttu-id="1b130-182">The following APIs are called:</span><span class="sxs-lookup"><span data-stu-id="1b130-182">The following APIs are called:</span></span>

1. <span data-ttu-id="1b130-183">In parallel</span><span class="sxs-lookup"><span data-stu-id="1b130-183">In parallel</span></span>
    - <span data-ttu-id="1b130-184">Any open listeners are Closed (`ICommunicationListener.CloseAsync()` is called on each listener)</span><span class="sxs-lookup"><span data-stu-id="1b130-184">Any open listeners are Closed (`ICommunicationListener.CloseAsync()` is called on each listener)</span></span>
    - <span data-ttu-id="1b130-185">The cancellation token passed to `RunAsync()` is canceled (checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method returns an `OperationCanceledException`)</span><span class="sxs-lookup"><span data-stu-id="1b130-185">The cancellation token passed to `RunAsync()` is canceled (checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method returns an `OperationCanceledException`)</span></span>
2. <span data-ttu-id="1b130-186">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, the service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span><span class="sxs-lookup"><span data-stu-id="1b130-186">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, the service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="1b130-187">(This is uncommonly overridden in the service.)</span><span class="sxs-lookup"><span data-stu-id="1b130-187">(This is uncommonly overridden in the service.)</span></span>

### <a name="for-the-secondary-being-promoted"></a><span data-ttu-id="1b130-188">For the secondary being promoted</span><span class="sxs-lookup"><span data-stu-id="1b130-188">For the secondary being promoted</span></span>
<span data-ttu-id="1b130-189">Similarly, Service Fabric needs this replica to start listening for messages on the wire (if it does that) and start any background tasks it cares about.</span><span class="sxs-lookup"><span data-stu-id="1b130-189">Similarly, Service Fabric needs this replica to start listening for messages on the wire (if it does that) and start any background tasks it cares about.</span></span> <span data-ttu-id="1b130-190">As a result, this process looks similar to when the service is created, except that the replica itself already exists.</span><span class="sxs-lookup"><span data-stu-id="1b130-190">As a result, this process looks similar to when the service is created, except that the replica itself already exists.</span></span> <span data-ttu-id="1b130-191">The following APIs are called:</span><span class="sxs-lookup"><span data-stu-id="1b130-191">The following APIs are called:</span></span>

1. <span data-ttu-id="1b130-192">In parallel</span><span class="sxs-lookup"><span data-stu-id="1b130-192">In parallel</span></span>
    - <span data-ttu-id="1b130-193">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened (`ICommunicationListener.OpenAsync()` is called on each listener)</span><span class="sxs-lookup"><span data-stu-id="1b130-193">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened (`ICommunicationListener.OpenAsync()` is called on each listener)</span></span>
    - <span data-ttu-id="1b130-194">The service's RunAsync method (`StatefulServiceBase.RunAsync()`) is called</span><span class="sxs-lookup"><span data-stu-id="1b130-194">The service's RunAsync method (`StatefulServiceBase.RunAsync()`) is called</span></span>
4. <span data-ttu-id="1b130-195">Once all the replica listener's `OpenAsync()` calls complete and `RunAsync()` has been started (or these steps were skipped because this is a secondary), `StatefulServiceBase.OnChangeRoleAsync()` is called.</span><span class="sxs-lookup"><span data-stu-id="1b130-195">Once all the replica listener's `OpenAsync()` calls complete and `RunAsync()` has been started (or these steps were skipped because this is a secondary), `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="1b130-196">(This is uncommonly overridden in the service.)</span><span class="sxs-lookup"><span data-stu-id="1b130-196">(This is uncommonly overridden in the service.)</span></span>

## <a name="notes-on-service-lifecycle"></a><span data-ttu-id="1b130-197">Notes on service lifecycle</span><span class="sxs-lookup"><span data-stu-id="1b130-197">Notes on service lifecycle</span></span>
* <span data-ttu-id="1b130-198">Both the `RunAsync()` method and the `CreateServiceReplicaListeners/CreateServiceInstanceListeners` calls are optional.</span><span class="sxs-lookup"><span data-stu-id="1b130-198">Both the `RunAsync()` method and the `CreateServiceReplicaListeners/CreateServiceInstanceListeners` calls are optional.</span></span> <span data-ttu-id="1b130-199">A service may have one of them, both, or neither.</span><span class="sxs-lookup"><span data-stu-id="1b130-199">A service may have one of them, both, or neither.</span></span> <span data-ttu-id="1b130-200">For example, if the service does all its work in response to user calls, there is no need for it to implement `RunAsync()`.</span><span class="sxs-lookup"><span data-stu-id="1b130-200">For example, if the service does all its work in response to user calls, there is no need for it to implement `RunAsync()`.</span></span> <span data-ttu-id="1b130-201">Only the communication listeners and their associated code are necessary.</span><span class="sxs-lookup"><span data-stu-id="1b130-201">Only the communication listeners and their associated code are necessary.</span></span> <span data-ttu-id="1b130-202">Similarly, creating and returning communication listeners is optional, as the service may have only background work to do, and so only needs to implement `RunAsync()`</span><span class="sxs-lookup"><span data-stu-id="1b130-202">Similarly, creating and returning communication listeners is optional, as the service may have only background work to do, and so only needs to implement `RunAsync()`</span></span>
* <span data-ttu-id="1b130-203">It is valid for a service to complete `RunAsync()` successfully and return from it.</span><span class="sxs-lookup"><span data-stu-id="1b130-203">It is valid for a service to complete `RunAsync()` successfully and return from it.</span></span> <span data-ttu-id="1b130-204">This is not considered a failure condition and would represent the background work of the service completing.</span><span class="sxs-lookup"><span data-stu-id="1b130-204">This is not considered a failure condition and would represent the background work of the service completing.</span></span> <span data-ttu-id="1b130-205">For stateful reliable services `RunAsync()` would be called again if the service were demoted from primary and then promoted back to primary.</span><span class="sxs-lookup"><span data-stu-id="1b130-205">For stateful reliable services `RunAsync()` would be called again if the service were demoted from primary and then promoted back to primary.</span></span>
* <span data-ttu-id="1b130-206">If a service exits from `RunAsync()` by throwing some unexpected exception, this is a failure and the service object is shut down and a health error reported.</span><span class="sxs-lookup"><span data-stu-id="1b130-206">If a service exits from `RunAsync()` by throwing some unexpected exception, this is a failure and the service object is shut down and a health error reported.</span></span>
* <span data-ttu-id="1b130-207">While there is no time limit on returning from these methods, you immediately lose the ability to write to Reliable Collections and therefore cannot complete any real work.</span><span class="sxs-lookup"><span data-stu-id="1b130-207">While there is no time limit on returning from these methods, you immediately lose the ability to write to Reliable Collections and therefore cannot complete any real work.</span></span> <span data-ttu-id="1b130-208">It is recommended that you return as quickly as possible upon receiving the cancellation request.</span><span class="sxs-lookup"><span data-stu-id="1b130-208">It is recommended that you return as quickly as possible upon receiving the cancellation request.</span></span> <span data-ttu-id="1b130-209">If your service does not respond to these API calls in a reasonable amount of time Service Fabric may forcibly terminate your service.</span><span class="sxs-lookup"><span data-stu-id="1b130-209">If your service does not respond to these API calls in a reasonable amount of time Service Fabric may forcibly terminate your service.</span></span> <span data-ttu-id="1b130-210">Usually this only happens during application upgrades or when a service is being deleted.</span><span class="sxs-lookup"><span data-stu-id="1b130-210">Usually this only happens during application upgrades or when a service is being deleted.</span></span> <span data-ttu-id="1b130-211">This timeout is 15 minutes by default.</span><span class="sxs-lookup"><span data-stu-id="1b130-211">This timeout is 15 minutes by default.</span></span>
* <span data-ttu-id="1b130-212">For stateful services, there's an additional option on ServiceReplicaListeners that allows them to start on secondary replicas.</span><span class="sxs-lookup"><span data-stu-id="1b130-212">For stateful services, there's an additional option on ServiceReplicaListeners that allows them to start on secondary replicas.</span></span> <span data-ttu-id="1b130-213">This is uncommon, but the only change in lifecycles is that `CreateServiceReplicaListeners()` is called (and the resulting listeners Opened) even if the replica is a Secondary.</span><span class="sxs-lookup"><span data-stu-id="1b130-213">This is uncommon, but the only change in lifecycles is that `CreateServiceReplicaListeners()` is called (and the resulting listeners Opened) even if the replica is a Secondary.</span></span> <span data-ttu-id="1b130-214">Similarly, if the replica is later converted into a primary, the listeners are closed, destructed, and new ones created and Opened as a part of the change to Primary.</span><span class="sxs-lookup"><span data-stu-id="1b130-214">Similarly, if the replica is later converted into a primary, the listeners are closed, destructed, and new ones created and Opened as a part of the change to Primary.</span></span>
* <span data-ttu-id="1b130-215">Failures in the `OnCloseAsync()` path result in `OnAbort()` being called which is a last-chance best-effort opportunity for the service to clean up and release any resources that they have claimed.</span><span class="sxs-lookup"><span data-stu-id="1b130-215">Failures in the `OnCloseAsync()` path result in `OnAbort()` being called which is a last-chance best-effort opportunity for the service to clean up and release any resources that they have claimed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="1b130-216">Next steps</span><span class="sxs-lookup"><span data-stu-id="1b130-216">Next steps</span></span>
* [<span data-ttu-id="1b130-217">Introduction to Reliable Services</span><span class="sxs-lookup"><span data-stu-id="1b130-217">Introduction to Reliable Services</span></span>](service-fabric-reliable-services-introduction.md)
* [<span data-ttu-id="1b130-218">Reliable Services quick start</span><span class="sxs-lookup"><span data-stu-id="1b130-218">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
* [<span data-ttu-id="1b130-219">Reliable Services advanced usage</span><span class="sxs-lookup"><span data-stu-id="1b130-219">Reliable Services advanced usage</span></span>](service-fabric-reliable-services-advanced-usage.md)
