---
title: Service Fabric Cluster Resource Manager - Management Integration | Microsoft Docs
description: An overview of the integration points between the Cluster Resource Manager and Service Fabric Management.
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: ''
ms.assetid: 956cd0b8-b6e3-4436-a224-8766320e8cd7
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 01/05/2017
ms.author: masnider
ms.openlocfilehash: 9d67f089f4aba03e846a8fe020a91b6b1ac6ea48
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44669791"
---
# <a name="cluster-resource-manager-integration-with-service-fabric-cluster-management"></a><span data-ttu-id="ec7ac-103">Cluster resource manager integration with Service Fabric cluster management</span><span class="sxs-lookup"><span data-stu-id="ec7ac-103">Cluster resource manager integration with Service Fabric cluster management</span></span>
<span data-ttu-id="ec7ac-104">The Service Fabric Cluster Resource Manager isn’t the main component of Service Fabric that handles management operations (like application upgrades) but it is involved.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-104">The Service Fabric Cluster Resource Manager isn’t the main component of Service Fabric that handles management operations (like application upgrades) but it is involved.</span></span> <span data-ttu-id="ec7ac-105">The first way that the Cluster Resource Manager helps with management is by tracking the desired state of the cluster and the services inside it.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-105">The first way that the Cluster Resource Manager helps with management is by tracking the desired state of the cluster and the services inside it.</span></span> <span data-ttu-id="ec7ac-106">The Cluster Resource Manager sends out health reports when it cannot put the cluster into the desired configuration.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-106">The Cluster Resource Manager sends out health reports when it cannot put the cluster into the desired configuration.</span></span> <span data-ttu-id="ec7ac-107">An example would be if there is insufficient capacity, or conflicting rules about where a service should be placed.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-107">An example would be if there is insufficient capacity, or conflicting rules about where a service should be placed.</span></span> <span data-ttu-id="ec7ac-108">Another piece of integration has to do with how upgrades work.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-108">Another piece of integration has to do with how upgrades work.</span></span> <span data-ttu-id="ec7ac-109">During upgrades the Cluster Resource Manager alters its behavior slightly.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-109">During upgrades the Cluster Resource Manager alters its behavior slightly.</span></span> <span data-ttu-id="ec7ac-110">We’ll talk about both of these integration points below.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-110">We’ll talk about both of these integration points below.</span></span>

## <a name="health-integration"></a><span data-ttu-id="ec7ac-111">Health integration</span><span class="sxs-lookup"><span data-stu-id="ec7ac-111">Health integration</span></span>
<span data-ttu-id="ec7ac-112">The Cluster Resource Manager constantly tracks the rules you have defined for your services and the capacities available on the nodes and in the cluster.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-112">The Cluster Resource Manager constantly tracks the rules you have defined for your services and the capacities available on the nodes and in the cluster.</span></span> <span data-ttu-id="ec7ac-113">If it cannot satisfy those rules or if there is insufficient capacity, health warnings and errors are emitted.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-113">If it cannot satisfy those rules or if there is insufficient capacity, health warnings and errors are emitted.</span></span> <span data-ttu-id="ec7ac-114">For example, if a node is over capacity and the Cluster Resource Manager will try to fix the situation by moving services.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-114">For example, if a node is over capacity and the Cluster Resource Manager will try to fix the situation by moving services.</span></span> <span data-ttu-id="ec7ac-115">If it can't correct the situation it emits a health warning indicating which node is over capacity, and for which metrics.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-115">If it can't correct the situation it emits a health warning indicating which node is over capacity, and for which metrics.</span></span>

<span data-ttu-id="ec7ac-116">Another example of the Resource Manager's health warnings is violations of placement constraints.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-116">Another example of the Resource Manager's health warnings is violations of placement constraints.</span></span> <span data-ttu-id="ec7ac-117">For example, if you have defined a placement constraint (such as `“NodeColor == Blue”`) and the Resource Manager detects a violation of that constraint, it will emit a health warning.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-117">For example, if you have defined a placement constraint (such as `“NodeColor == Blue”`) and the Resource Manager detects a violation of that constraint, it will emit a health warning.</span></span> <span data-ttu-id="ec7ac-118">This is true for custom constraints and the default constraints (like fault and upgrade domain constraints).</span><span class="sxs-lookup"><span data-stu-id="ec7ac-118">This is true for custom constraints and the default constraints (like fault and upgrade domain constraints).</span></span>

<span data-ttu-id="ec7ac-119">Here’s an example of one such health report.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-119">Here’s an example of one such health report.</span></span> <span data-ttu-id="ec7ac-120">In this case, the health report is for one of the system service’s partitions.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-120">In this case, the health report is for one of the system service’s partitions.</span></span> <span data-ttu-id="ec7ac-121">The health message indicates the replicas of that partition are temporarily packed into too few Upgrade Domains.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-121">The health message indicates the replicas of that partition are temporarily packed into too few Upgrade Domains.</span></span>

```posh
PS C:\Users\User > Get-WindowsFabricPartitionHealth -PartitionId '00000000-0000-0000-0000-000000000001'


PartitionId           : 00000000-0000-0000-0000-000000000001
AggregatedHealthState : Warning
UnhealthyEvaluations  :
                        Unhealthy event: SourceId='System.PLB', Property='ReplicaConstraintViolation_UpgradeDomain', HealthState='Warning', ConsiderWarningAsError=false.

ReplicaHealthStates   :
                        ReplicaId             : 130766528804733380
                        AggregatedHealthState : Ok

                        ReplicaId             : 130766528804577821
                        AggregatedHealthState : Ok

                        ReplicaId             : 130766528854889931
                        AggregatedHealthState : Ok

                        ReplicaId             : 130766528804577822
                        AggregatedHealthState : Ok

                        ReplicaId             : 130837073190680024
                        AggregatedHealthState : Ok

HealthEvents          :
                        SourceId              : System.PLB
                        Property              : ReplicaConstraintViolation_UpgradeDomain
                        HealthState           : Warning
                        SequenceNumber        : 130837100116930204
                        SentAt                : 8/10/2015 7:53:31 PM
                        ReceivedAt            : 8/10/2015 7:53:33 PM
                        TTL                   : 00:01:05
                        Description           : The Load Balancer has detected a Constraint Violation for this Replica: fabric:/System/FailoverManagerService Secondary Partition 00000000-0000-0000-0000-000000000001 is
                        violating the Constraint: UpgradeDomain Details: Node -- 3d1a4a68b2592f55125328cd0f8ed477  Policy -- Packing
                        RemoveWhenExpired     : True
                        IsExpired             : False
                        Transitions           : Ok->Warning = 8/10/2015 7:13:02 PM, LastError = 1/1/0001 12:00:00 AM
```

<span data-ttu-id="ec7ac-122">Here's what this health message is telling us is:</span><span class="sxs-lookup"><span data-stu-id="ec7ac-122">Here's what this health message is telling us is:</span></span>

1. <span data-ttu-id="ec7ac-123">All the replicas themselves are healthy (this is Service Fabric’s first priority)</span><span class="sxs-lookup"><span data-stu-id="ec7ac-123">All the replicas themselves are healthy (this is Service Fabric’s first priority)</span></span>
2. <span data-ttu-id="ec7ac-124">That the Upgrade Domain distribution constraint is currently being violated (meaning that a particular Upgrade Domain has more of the replicas for this partition than it should)</span><span class="sxs-lookup"><span data-stu-id="ec7ac-124">That the Upgrade Domain distribution constraint is currently being violated (meaning that a particular Upgrade Domain has more of the replicas for this partition than it should)</span></span>
3. <span data-ttu-id="ec7ac-125">Which node contains the replica causing the violation (The node with ID: 3d1a4a68b2592f55125328cd0f8ed477)</span><span class="sxs-lookup"><span data-stu-id="ec7ac-125">Which node contains the replica causing the violation (The node with ID: 3d1a4a68b2592f55125328cd0f8ed477)</span></span>
4. <span data-ttu-id="ec7ac-126">When the report happened (8/10/2015 7:13:02 PM)</span><span class="sxs-lookup"><span data-stu-id="ec7ac-126">When the report happened (8/10/2015 7:13:02 PM)</span></span>

<span data-ttu-id="ec7ac-127">Information like this powers alerts that fire in production to let you know something has gone wrong.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-127">Information like this powers alerts that fire in production to let you know something has gone wrong.</span></span> <span data-ttu-id="ec7ac-128">In this case, we’d want to see if we can figure out why the Resource Manager had to pack the replicas into the Upgrade Domain.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-128">In this case, we’d want to see if we can figure out why the Resource Manager had to pack the replicas into the Upgrade Domain.</span></span> <span data-ttu-id="ec7ac-129">This could be because the nodes in the other Upgrade Domains were down, for example.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-129">This could be because the nodes in the other Upgrade Domains were down, for example.</span></span>

<span data-ttu-id="ec7ac-130">Let’s say you want to create a service, or the Resource Manager is trying to find a place to place some services, but there aren't any solutions that work.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-130">Let’s say you want to create a service, or the Resource Manager is trying to find a place to place some services, but there aren't any solutions that work.</span></span> <span data-ttu-id="ec7ac-131">This could be for many reasons, but usually it is due to one of the two following conditions:</span><span class="sxs-lookup"><span data-stu-id="ec7ac-131">This could be for many reasons, but usually it is due to one of the two following conditions:</span></span>

1. <span data-ttu-id="ec7ac-132">Some transient condition has made it impossible to place this service instance or replica correctly</span><span class="sxs-lookup"><span data-stu-id="ec7ac-132">Some transient condition has made it impossible to place this service instance or replica correctly</span></span>
2. <span data-ttu-id="ec7ac-133">The service’s requirements are misconfigured in a way that causes its requirements to be unsatisfiable.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-133">The service’s requirements are misconfigured in a way that causes its requirements to be unsatisfiable.</span></span>

<span data-ttu-id="ec7ac-134">In each of these conditions, you’ll see a health report from the Cluster Resource Manager providing information to help you determine what is going on and why the service can’t be placed.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-134">In each of these conditions, you’ll see a health report from the Cluster Resource Manager providing information to help you determine what is going on and why the service can’t be placed.</span></span> <span data-ttu-id="ec7ac-135">We call this process the “Constraint Elimination Sequence”.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-135">We call this process the “Constraint Elimination Sequence”.</span></span> <span data-ttu-id="ec7ac-136">During it, the system walks through the configured constraints affecting the service and records what they eliminate.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-136">During it, the system walks through the configured constraints affecting the service and records what they eliminate.</span></span> <span data-ttu-id="ec7ac-137">This way when services aren’t able to be placed, you can see which nodes were eliminated and why.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-137">This way when services aren’t able to be placed, you can see which nodes were eliminated and why.</span></span>

## <a name="constraint-types"></a><span data-ttu-id="ec7ac-138">Constraint types</span><span class="sxs-lookup"><span data-stu-id="ec7ac-138">Constraint types</span></span>
<span data-ttu-id="ec7ac-139">Let’s talk about each of the different constraints you can see in these health reports.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-139">Let’s talk about each of the different constraints you can see in these health reports.</span></span> <span data-ttu-id="ec7ac-140">Most of the time these constraints won't eliminate nodes since they are at the soft or optimize level by default.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-140">Most of the time these constraints won't eliminate nodes since they are at the soft or optimize level by default.</span></span> <span data-ttu-id="ec7ac-141">You could however see health messages related to these constraints if they are configured as hard constraints or in the rare cases that they do cause nodes to be eliminated.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-141">You could however see health messages related to these constraints if they are configured as hard constraints or in the rare cases that they do cause nodes to be eliminated.</span></span>

* <span data-ttu-id="ec7ac-142">**ReplicaExclusionStatic** and **ReplicaExclusionDynamic**: This constraint indicates that two stateful replicas or stateless instances from the same partition would have to be placed on the same node (which isn’t allowed).</span><span class="sxs-lookup"><span data-stu-id="ec7ac-142">**ReplicaExclusionStatic** and **ReplicaExclusionDynamic**: This constraint indicates that two stateful replicas or stateless instances from the same partition would have to be placed on the same node (which isn’t allowed).</span></span> <span data-ttu-id="ec7ac-143">ReplicaExclusionStatic and ReplicaExclusionDynamic are almost the same rule.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-143">ReplicaExclusionStatic and ReplicaExclusionDynamic are almost the same rule.</span></span> <span data-ttu-id="ec7ac-144">The ReplicaExclusionDynamic constraint says “we couldn’t place this replica here because the only proposed solution had already placed a replica here”.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-144">The ReplicaExclusionDynamic constraint says “we couldn’t place this replica here because the only proposed solution had already placed a replica here”.</span></span> <span data-ttu-id="ec7ac-145">This is different from the ReplicaExclusionStatic constraint that indicates not a proposed conflict but an actual one.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-145">This is different from the ReplicaExclusionStatic constraint that indicates not a proposed conflict but an actual one.</span></span> <span data-ttu-id="ec7ac-146">In this case, there is a replica already on the node.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-146">In this case, there is a replica already on the node.</span></span> <span data-ttu-id="ec7ac-147">Is this confusing?</span><span class="sxs-lookup"><span data-stu-id="ec7ac-147">Is this confusing?</span></span> <span data-ttu-id="ec7ac-148">Yes.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-148">Yes.</span></span> <span data-ttu-id="ec7ac-149">Does it matter a lot?</span><span class="sxs-lookup"><span data-stu-id="ec7ac-149">Does it matter a lot?</span></span> <span data-ttu-id="ec7ac-150">No.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-150">No.</span></span> <span data-ttu-id="ec7ac-151">If you are seeing a constraint elimination sequence containing either the ReplicaExclusionStatic or ReplicaExclusionDynamic constraint the Cluster Resource Manager thinks that there aren’t enough nodes.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-151">If you are seeing a constraint elimination sequence containing either the ReplicaExclusionStatic or ReplicaExclusionDynamic constraint the Cluster Resource Manager thinks that there aren’t enough nodes.</span></span> <span data-ttu-id="ec7ac-152">The further constraints can usually tell us how we’re ending up with too few nodes.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-152">The further constraints can usually tell us how we’re ending up with too few nodes.</span></span>
* <span data-ttu-id="ec7ac-153">**PlacementConstraint**: If you see this message, it means that we eliminated some nodes because they didn’t match the service’s placement constraints.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-153">**PlacementConstraint**: If you see this message, it means that we eliminated some nodes because they didn’t match the service’s placement constraints.</span></span> <span data-ttu-id="ec7ac-154">We trace out the currently configured placement constraints as a part of this message.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-154">We trace out the currently configured placement constraints as a part of this message.</span></span> <span data-ttu-id="ec7ac-155">This is normal if you have a placement constraints defined.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-155">This is normal if you have a placement constraints defined.</span></span> <span data-ttu-id="ec7ac-156">However, if there is a bug in the placement constraint causing too many nodes to be eliminated this is where you would notice.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-156">However, if there is a bug in the placement constraint causing too many nodes to be eliminated this is where you would notice.</span></span>
* <span data-ttu-id="ec7ac-157">**NodeCapacity**: This constraint means that the Cluster Resource Manager couldn’t place the replicas on the indicated nodes because doing so would cause the node to go over capacity.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-157">**NodeCapacity**: This constraint means that the Cluster Resource Manager couldn’t place the replicas on the indicated nodes because doing so would cause the node to go over capacity.</span></span>
* <span data-ttu-id="ec7ac-158">**Affinity**: This constraint indicates that we couldn’t place the replica on the affected nodes since it would cause a violation of the affinity constraint.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-158">**Affinity**: This constraint indicates that we couldn’t place the replica on the affected nodes since it would cause a violation of the affinity constraint.</span></span> <span data-ttu-id="ec7ac-159">More information on affinity is in [this article](service-fabric-cluster-resource-manager-advanced-placement-rules-affinity.md)</span><span class="sxs-lookup"><span data-stu-id="ec7ac-159">More information on affinity is in [this article](service-fabric-cluster-resource-manager-advanced-placement-rules-affinity.md)</span></span>
* <span data-ttu-id="ec7ac-160">**FaultDomain** and **UpgradeDomain**: This constraint eliminates nodes if placing the replica on the indicated nodes would cause packing in a particular fault or upgrade domain.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-160">**FaultDomain** and **UpgradeDomain**: This constraint eliminates nodes if placing the replica on the indicated nodes would cause packing in a particular fault or upgrade domain.</span></span> <span data-ttu-id="ec7ac-161">Several examples discussing this constraint are presented in the topic on [fault and upgrade domain constraints and resulting behavior](service-fabric-cluster-resource-manager-cluster-description.md)</span><span class="sxs-lookup"><span data-stu-id="ec7ac-161">Several examples discussing this constraint are presented in the topic on [fault and upgrade domain constraints and resulting behavior](service-fabric-cluster-resource-manager-cluster-description.md)</span></span>
* <span data-ttu-id="ec7ac-162">**PreferredLocation**: You shouldn’t normally see this constraint causing nodes to get removed from the solution since it is set at the optimization level by default.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-162">**PreferredLocation**: You shouldn’t normally see this constraint causing nodes to get removed from the solution since it is set at the optimization level by default.</span></span> <span data-ttu-id="ec7ac-163">Further, the preferred location constraint is usually present during upgrades.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-163">Further, the preferred location constraint is usually present during upgrades.</span></span> <span data-ttu-id="ec7ac-164">During upgrade it is used to move replicas back to where they were when the upgrade started.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-164">During upgrade it is used to move replicas back to where they were when the upgrade started.</span></span>

### <a name="constraint-priorities"></a><span data-ttu-id="ec7ac-165">Constraint priorities</span><span class="sxs-lookup"><span data-stu-id="ec7ac-165">Constraint priorities</span></span>
<span data-ttu-id="ec7ac-166">With all of these constraints, you may have been thinking “Hey – I think that placement constraints are the most important thing in my system.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-166">With all of these constraints, you may have been thinking “Hey – I think that placement constraints are the most important thing in my system.</span></span> <span data-ttu-id="ec7ac-167">I’m willing to violate other constraints, even things like affinity and capacity, if it ensures that the placement constraints aren’t ever violated.”</span><span class="sxs-lookup"><span data-stu-id="ec7ac-167">I’m willing to violate other constraints, even things like affinity and capacity, if it ensures that the placement constraints aren’t ever violated.”</span></span>

<span data-ttu-id="ec7ac-168">Well it turns out we can do that!</span><span class="sxs-lookup"><span data-stu-id="ec7ac-168">Well it turns out we can do that!</span></span> <span data-ttu-id="ec7ac-169">Constraints can be configured with a few different levels of enforcement, but they boil down to “hard” (0), “soft” (1), “optimization” (2), and “off” (-1).</span><span class="sxs-lookup"><span data-stu-id="ec7ac-169">Constraints can be configured with a few different levels of enforcement, but they boil down to “hard” (0), “soft” (1), “optimization” (2), and “off” (-1).</span></span> <span data-ttu-id="ec7ac-170">Most of the constraints we’ve defined as hard by default.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-170">Most of the constraints we’ve defined as hard by default.</span></span> <span data-ttu-id="ec7ac-171">For example, most people don’t normally think about capacity as something they are willing to relax, and almost all are either hard or soft.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-171">For example, most people don’t normally think about capacity as something they are willing to relax, and almost all are either hard or soft.</span></span>

<span data-ttu-id="ec7ac-172">The different constraint priorities are why some constraint violation warnings show up more often than others: there are certain constraints that we're willing to relax (violate) temporarily.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-172">The different constraint priorities are why some constraint violation warnings show up more often than others: there are certain constraints that we're willing to relax (violate) temporarily.</span></span> <span data-ttu-id="ec7ac-173">These levels don't really mean that a given constraint will be violated, just that there's an order in which they are preferentially enforced.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-173">These levels don't really mean that a given constraint will be violated, just that there's an order in which they are preferentially enforced.</span></span> <span data-ttu-id="ec7ac-174">This allows the Cluster Resource Manager to make the right tradeoffs if it is impossible to satisfy all constraints.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-174">This allows the Cluster Resource Manager to make the right tradeoffs if it is impossible to satisfy all constraints.</span></span>

<span data-ttu-id="ec7ac-175">In advanced situations constraint priorities can be changed.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-175">In advanced situations constraint priorities can be changed.</span></span> <span data-ttu-id="ec7ac-176">For example, say you wanted to ensure that affinity would be violated to solve node capacity issues.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-176">For example, say you wanted to ensure that affinity would be violated to solve node capacity issues.</span></span> <span data-ttu-id="ec7ac-177">To achieve this, you could set the priority of the affinity constraint to “soft” (1) and leave the capacity constraint set to “hard” (0).</span><span class="sxs-lookup"><span data-stu-id="ec7ac-177">To achieve this, you could set the priority of the affinity constraint to “soft” (1) and leave the capacity constraint set to “hard” (0).</span></span>

<span data-ttu-id="ec7ac-178">The default priority values for the different constraints are specified in config:</span><span class="sxs-lookup"><span data-stu-id="ec7ac-178">The default priority values for the different constraints are specified in config:</span></span>

<span data-ttu-id="ec7ac-179">ClusterManifest.xml</span><span class="sxs-lookup"><span data-stu-id="ec7ac-179">ClusterManifest.xml</span></span>

```xml
        <Section Name="PlacementAndLoadBalancing">
            <Parameter Name="PlacementConstraintPriority" Value="0" />
            <Parameter Name="CapacityConstraintPriority" Value="0" />
            <Parameter Name="AffinityConstraintPriority" Value="0" />
            <Parameter Name="FaultDomainConstraintPriority" Value="0" />
            <Parameter Name="UpgradeDomainConstraintPriority" Value="1" />
            <Parameter Name="PreferredLocationConstraintPriority" Value="2" />
        </Section>
```

<span data-ttu-id="ec7ac-180">via ClusterConfig.json for Standalone deployments or Template.json for Azure hosted clusters:</span><span class="sxs-lookup"><span data-stu-id="ec7ac-180">via ClusterConfig.json for Standalone deployments or Template.json for Azure hosted clusters:</span></span>

```json
"fabricSettings": [
  {
    "name": "PlacementAndLoadBalancing",
    "parameters": [
      {
          "name": "PlacementConstraintPriority",
          "value": "0"
      },
      {
          "name": "CapacityConstraintPriority",
          "value": "0"
      },
      {
          "name": "AffinityConstraintPriority",
          "value": "0"
      },
      {
          "name": "FaultDomainConstraintPriority",
          "value": "0"
      },
      {
          "name": "UpgradeDomainConstraintPriority",
          "value": "1"
      },
      {
          "name": "PreferredLocationConstraintPriority",
          "value": "2"
      }
    ]
  }
]
```

## <a name="fault-domain-and-upgrade-domain-constraints"></a><span data-ttu-id="ec7ac-181">Fault domain and upgrade domain constraints</span><span class="sxs-lookup"><span data-stu-id="ec7ac-181">Fault domain and upgrade domain constraints</span></span>
<span data-ttu-id="ec7ac-182">The Cluster Resource Manager models the desire to keep services spread out among fault and upgrade domains as a constraint inside the Resource Manager’s engine.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-182">The Cluster Resource Manager models the desire to keep services spread out among fault and upgrade domains as a constraint inside the Resource Manager’s engine.</span></span> <span data-ttu-id="ec7ac-183">For more information on how they are used, check out the article on [cluster configuration](service-fabric-cluster-resource-manager-cluster-description.md).</span><span class="sxs-lookup"><span data-stu-id="ec7ac-183">For more information on how they are used, check out the article on [cluster configuration](service-fabric-cluster-resource-manager-cluster-description.md).</span></span>

<span data-ttu-id="ec7ac-184">There have been times where we needed either to get strict about Fault and Upgrade domains to prevent something bad from happening.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-184">There have been times where we needed either to get strict about Fault and Upgrade domains to prevent something bad from happening.</span></span> <span data-ttu-id="ec7ac-185">There have also been cases where we needed to ignore them entirely (though briefly!).</span><span class="sxs-lookup"><span data-stu-id="ec7ac-185">There have also been cases where we needed to ignore them entirely (though briefly!).</span></span> <span data-ttu-id="ec7ac-186">Generally the flexibility of the constraint priority infrastructure has worked very well, but it isn't needed often.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-186">Generally the flexibility of the constraint priority infrastructure has worked very well, but it isn't needed often.</span></span> <span data-ttu-id="ec7ac-187">Most of the time everything sits at their default priorities.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-187">Most of the time everything sits at their default priorities.</span></span> <span data-ttu-id="ec7ac-188">Upgrade domains remain a soft constraint.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-188">Upgrade domains remain a soft constraint.</span></span> <span data-ttu-id="ec7ac-189">The Cluster Resource Manager may need to pack a couple replicas into an upgrade domain in order to deal with an upgrade, failures, or constraint violations.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-189">The Cluster Resource Manager may need to pack a couple replicas into an upgrade domain in order to deal with an upgrade, failures, or constraint violations.</span></span> <span data-ttu-id="ec7ac-190">This normally happens only when there are several failures or other churn in the system preventing correct placement.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-190">This normally happens only when there are several failures or other churn in the system preventing correct placement.</span></span> <span data-ttu-id="ec7ac-191">If the environment is configured correctly, all constraints, including fault and upgrade constraints, are fully respected, even during upgrades.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-191">If the environment is configured correctly, all constraints, including fault and upgrade constraints, are fully respected, even during upgrades.</span></span> <span data-ttu-id="ec7ac-192">The key thing is that the Cluster Resource Manager is watching out for your constraints, and immediately reporting when it detects violations.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-192">The key thing is that the Cluster Resource Manager is watching out for your constraints, and immediately reporting when it detects violations.</span></span>

## <a name="the-preferred-location-constraint"></a><span data-ttu-id="ec7ac-193">The preferred location constraint</span><span class="sxs-lookup"><span data-stu-id="ec7ac-193">The preferred location constraint</span></span>
<span data-ttu-id="ec7ac-194">The PreferredLocation constraint is a little different, and hence it is the only constraint set to “Optimization”.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-194">The PreferredLocation constraint is a little different, and hence it is the only constraint set to “Optimization”.</span></span> <span data-ttu-id="ec7ac-195">We use this constraint while upgrades in flight to prefer putting services back where we found them before the upgrade.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-195">We use this constraint while upgrades in flight to prefer putting services back where we found them before the upgrade.</span></span> <span data-ttu-id="ec7ac-196">There’s all sorts of reasons why this may not work in practice, but it’s a nice optimization.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-196">There’s all sorts of reasons why this may not work in practice, but it’s a nice optimization.</span></span>

## <a name="upgrades"></a><span data-ttu-id="ec7ac-197">Upgrades</span><span class="sxs-lookup"><span data-stu-id="ec7ac-197">Upgrades</span></span>
<span data-ttu-id="ec7ac-198">The Cluster Resource Manager also helps during application and cluster upgrades, during which it has two jobs:</span><span class="sxs-lookup"><span data-stu-id="ec7ac-198">The Cluster Resource Manager also helps during application and cluster upgrades, during which it has two jobs:</span></span>

* <span data-ttu-id="ec7ac-199">ensure that the rules and performance of the cluster are not compromised</span><span class="sxs-lookup"><span data-stu-id="ec7ac-199">ensure that the rules and performance of the cluster are not compromised</span></span>
* <span data-ttu-id="ec7ac-200">try to help the upgrade go smoothly</span><span class="sxs-lookup"><span data-stu-id="ec7ac-200">try to help the upgrade go smoothly</span></span>

### <a name="keep-enforcing-the-rules"></a><span data-ttu-id="ec7ac-201">Keep enforcing the rules</span><span class="sxs-lookup"><span data-stu-id="ec7ac-201">Keep enforcing the rules</span></span>
<span data-ttu-id="ec7ac-202">The main thing to be aware of is that the rules – the strict constraints around things like placement constraints are still enforced during upgrades.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-202">The main thing to be aware of is that the rules – the strict constraints around things like placement constraints are still enforced during upgrades.</span></span> <span data-ttu-id="ec7ac-203">Placement constraints ensure that your workloads only run where they are allowed to, even during upgrades.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-203">Placement constraints ensure that your workloads only run where they are allowed to, even during upgrades.</span></span> <span data-ttu-id="ec7ac-204">If your environment is highly constrained upgrades may take a long time.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-204">If your environment is highly constrained upgrades may take a long time.</span></span> <span data-ttu-id="ec7ac-205">This is because there may be few options for where a service can go if it (or the node it sits on) needs to be brought down for an update.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-205">This is because there may be few options for where a service can go if it (or the node it sits on) needs to be brought down for an update.</span></span>

### <a name="smart-replacements"></a><span data-ttu-id="ec7ac-206">Smart replacements</span><span class="sxs-lookup"><span data-stu-id="ec7ac-206">Smart replacements</span></span>
<span data-ttu-id="ec7ac-207">When an upgrade starts, the Resource Manager takes a snapshot of the current arrangement of the cluster.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-207">When an upgrade starts, the Resource Manager takes a snapshot of the current arrangement of the cluster.</span></span> <span data-ttu-id="ec7ac-208">As each Upgrade Domain completes, it attempts to return things to the original arrangement.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-208">As each Upgrade Domain completes, it attempts to return things to the original arrangement.</span></span> <span data-ttu-id="ec7ac-209">This way there are at most two transitions during the upgrade (the move out of the affected node and the move back in).</span><span class="sxs-lookup"><span data-stu-id="ec7ac-209">This way there are at most two transitions during the upgrade (the move out of the affected node and the move back in).</span></span> <span data-ttu-id="ec7ac-210">Returning the cluster to how it was before the upgrade also ensures the upgrade doesn’t impact the layout of the cluster.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-210">Returning the cluster to how it was before the upgrade also ensures the upgrade doesn’t impact the layout of the cluster.</span></span> <span data-ttu-id="ec7ac-211">If the cluster was arranged well before the upgrade it will be arranged well after it, or at least no worse.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-211">If the cluster was arranged well before the upgrade it will be arranged well after it, or at least no worse.</span></span>

### <a name="reduced-churn"></a><span data-ttu-id="ec7ac-212">Reduced churn</span><span class="sxs-lookup"><span data-stu-id="ec7ac-212">Reduced churn</span></span>
<span data-ttu-id="ec7ac-213">Another thing that happens during upgrades is that the Cluster Resource Manager turns off balancing for the entity being upgraded.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-213">Another thing that happens during upgrades is that the Cluster Resource Manager turns off balancing for the entity being upgraded.</span></span> <span data-ttu-id="ec7ac-214">This means that if you have two different application instances and upgrade on one of them, then balancing is paused for that application instance, but not the other one.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-214">This means that if you have two different application instances and upgrade on one of them, then balancing is paused for that application instance, but not the other one.</span></span> <span data-ttu-id="ec7ac-215">Preventing balancing prevents unnecessary reactions to the upgrade itself, like moving services into nodes that were emptied for the upgrade.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-215">Preventing balancing prevents unnecessary reactions to the upgrade itself, like moving services into nodes that were emptied for the upgrade.</span></span> <span data-ttu-id="ec7ac-216">If the upgrade in question is a Cluster upgrade, then the entire cluster is not balanced during the upgrade.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-216">If the upgrade in question is a Cluster upgrade, then the entire cluster is not balanced during the upgrade.</span></span> <span data-ttu-id="ec7ac-217">Constraint checks – ensuring the rules are enforced – stay active, only rebalancing is disabled.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-217">Constraint checks – ensuring the rules are enforced – stay active, only rebalancing is disabled.</span></span>

### <a name="relaxed-rules"></a><span data-ttu-id="ec7ac-218">Relaxed rules</span><span class="sxs-lookup"><span data-stu-id="ec7ac-218">Relaxed rules</span></span>
<span data-ttu-id="ec7ac-219">Generally that you want the upgrade to complete even if the cluster is constrained or full overall.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-219">Generally that you want the upgrade to complete even if the cluster is constrained or full overall.</span></span> <span data-ttu-id="ec7ac-220">During upgrades being able to manage the capacity of the cluster is even more important than usual.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-220">During upgrades being able to manage the capacity of the cluster is even more important than usual.</span></span> <span data-ttu-id="ec7ac-221">This is because there is typically between 5 and 20 percent of the capacity down at a time as the upgrade rolls through the cluster.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-221">This is because there is typically between 5 and 20 percent of the capacity down at a time as the upgrade rolls through the cluster.</span></span> <span data-ttu-id="ec7ac-222">That work usually has to go somewhere.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-222">That work usually has to go somewhere.</span></span> <span data-ttu-id="ec7ac-223">This is where the notion of [buffered capacities](service-fabric-cluster-resource-manager-cluster-description.md#buffered-capacity) really comes into play.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-223">This is where the notion of [buffered capacities](service-fabric-cluster-resource-manager-cluster-description.md#buffered-capacity) really comes into play.</span></span> <span data-ttu-id="ec7ac-224">While the buffered capacity is respected during normal operation (leaving some overhead), the Cluster Resource Manager fills up to the total capacity (taking up the buffer) during upgrades.</span><span class="sxs-lookup"><span data-stu-id="ec7ac-224">While the buffered capacity is respected during normal operation (leaving some overhead), the Cluster Resource Manager fills up to the total capacity (taking up the buffer) during upgrades.</span></span>

## <a name="next-steps"></a><span data-ttu-id="ec7ac-225">Next steps</span><span class="sxs-lookup"><span data-stu-id="ec7ac-225">Next steps</span></span>
* <span data-ttu-id="ec7ac-226">Start from the beginning and [get an Introduction to the Service Fabric Cluster Resource Manager](service-fabric-cluster-resource-manager-introduction.md)</span><span class="sxs-lookup"><span data-stu-id="ec7ac-226">Start from the beginning and [get an Introduction to the Service Fabric Cluster Resource Manager](service-fabric-cluster-resource-manager-introduction.md)</span></span>
