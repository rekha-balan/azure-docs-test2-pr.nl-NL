---
title: Manage Azure microservice load using metrics | Microsoft Docs
description: Learn about how to configure and use metrics in Service Fabric to manage service resource consumption.
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: ''
ms.assetid: 0d622ea6-a7c7-4bef-886b-06e6b85a97fb
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 01/05/2017
ms.author: masnider
ms.openlocfilehash: b62d39a55b370410ecebf6573bd417783c0a7d57
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44551128"
---
# <a name="managing-resource-consumption-and-load-in-service-fabric-with-metrics"></a><span data-ttu-id="7a152-103">Managing resource consumption and load in Service Fabric with metrics</span><span class="sxs-lookup"><span data-stu-id="7a152-103">Managing resource consumption and load in Service Fabric with metrics</span></span>
<span data-ttu-id="7a152-104">Metrics are the generic term within Service Fabric for the resources that your services care about and which are provided by the nodes in the cluster.</span><span class="sxs-lookup"><span data-stu-id="7a152-104">Metrics are the generic term within Service Fabric for the resources that your services care about and which are provided by the nodes in the cluster.</span></span> <span data-ttu-id="7a152-105">Generally, a metric is anything that you want to manage to deal with the performance of your services.</span><span class="sxs-lookup"><span data-stu-id="7a152-105">Generally, a metric is anything that you want to manage to deal with the performance of your services.</span></span>

<span data-ttu-id="7a152-106">Things like Memory, Disk, and CPU usage are examples of metrics.</span><span class="sxs-lookup"><span data-stu-id="7a152-106">Things like Memory, Disk, and CPU usage are examples of metrics.</span></span> <span data-ttu-id="7a152-107">These are physical metrics, resources that correspond to physical resources on the node that need to be managed.</span><span class="sxs-lookup"><span data-stu-id="7a152-107">These are physical metrics, resources that correspond to physical resources on the node that need to be managed.</span></span> <span data-ttu-id="7a152-108">Metrics can also be (and commonly are) logical metrics.</span><span class="sxs-lookup"><span data-stu-id="7a152-108">Metrics can also be (and commonly are) logical metrics.</span></span> <span data-ttu-id="7a152-109">Logical metrics are things like “MyWorkQueueDepth” or "MessagesToProcess" or "TotalRecords".</span><span class="sxs-lookup"><span data-stu-id="7a152-109">Logical metrics are things like “MyWorkQueueDepth” or "MessagesToProcess" or "TotalRecords".</span></span> <span data-ttu-id="7a152-110">Logical metrics are application-defined and correspond to some physical resource consumption, but the application doesn't really know how to measure it.</span><span class="sxs-lookup"><span data-stu-id="7a152-110">Logical metrics are application-defined and correspond to some physical resource consumption, but the application doesn't really know how to measure it.</span></span> <span data-ttu-id="7a152-111">This is common.</span><span class="sxs-lookup"><span data-stu-id="7a152-111">This is common.</span></span> <span data-ttu-id="7a152-112">Most metrics that we see people use are logical metrics.</span><span class="sxs-lookup"><span data-stu-id="7a152-112">Most metrics that we see people use are logical metrics.</span></span> <span data-ttu-id="7a152-113">Most commonly this is because today many services are written in managed code.</span><span class="sxs-lookup"><span data-stu-id="7a152-113">Most commonly this is because today many services are written in managed code.</span></span> <span data-ttu-id="7a152-114">Managed code means that from within a host process it can be hard to measure and report a single service object's consumption of physical resources.</span><span class="sxs-lookup"><span data-stu-id="7a152-114">Managed code means that from within a host process it can be hard to measure and report a single service object's consumption of physical resources.</span></span> <span data-ttu-id="7a152-115">The complexity of measuring and reporting your own metrics is also why we provide some default metrics out of the box.</span><span class="sxs-lookup"><span data-stu-id="7a152-115">The complexity of measuring and reporting your own metrics is also why we provide some default metrics out of the box.</span></span>

## <a name="default-metrics"></a><span data-ttu-id="7a152-116">Default metrics</span><span class="sxs-lookup"><span data-stu-id="7a152-116">Default metrics</span></span>
<span data-ttu-id="7a152-117">Let’s say that you want to get started and don’t know what resources you are going to consume or even which ones would be important to you.</span><span class="sxs-lookup"><span data-stu-id="7a152-117">Let’s say that you want to get started and don’t know what resources you are going to consume or even which ones would be important to you.</span></span> <span data-ttu-id="7a152-118">So you go implement and then create your services without specifying any metrics.</span><span class="sxs-lookup"><span data-stu-id="7a152-118">So you go implement and then create your services without specifying any metrics.</span></span> <span data-ttu-id="7a152-119">That’s fine!</span><span class="sxs-lookup"><span data-stu-id="7a152-119">That’s fine!</span></span> <span data-ttu-id="7a152-120">The Service Fabric Cluster Resource Manager picks some simple metrics for you.</span><span class="sxs-lookup"><span data-stu-id="7a152-120">The Service Fabric Cluster Resource Manager picks some simple metrics for you.</span></span> <span data-ttu-id="7a152-121">The default metrics that we use today when you don’t specify any are called PrimaryCount, ReplicaCount, and Count.</span><span class="sxs-lookup"><span data-stu-id="7a152-121">The default metrics that we use today when you don’t specify any are called PrimaryCount, ReplicaCount, and Count.</span></span> <span data-ttu-id="7a152-122">The following table shows how much load for each of these metrics is associated with each service object:</span><span class="sxs-lookup"><span data-stu-id="7a152-122">The following table shows how much load for each of these metrics is associated with each service object:</span></span>

| <span data-ttu-id="7a152-123">Metric</span><span class="sxs-lookup"><span data-stu-id="7a152-123">Metric</span></span> | <span data-ttu-id="7a152-124">Stateless Instance Load</span><span class="sxs-lookup"><span data-stu-id="7a152-124">Stateless Instance Load</span></span> | <span data-ttu-id="7a152-125">Stateful Secondary Load</span><span class="sxs-lookup"><span data-stu-id="7a152-125">Stateful Secondary Load</span></span> | <span data-ttu-id="7a152-126">Stateful Primary Load</span><span class="sxs-lookup"><span data-stu-id="7a152-126">Stateful Primary Load</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="7a152-127">PrimaryCount</span><span class="sxs-lookup"><span data-stu-id="7a152-127">PrimaryCount</span></span> |<span data-ttu-id="7a152-128">0</span><span class="sxs-lookup"><span data-stu-id="7a152-128">0</span></span> |<span data-ttu-id="7a152-129">0</span><span class="sxs-lookup"><span data-stu-id="7a152-129">0</span></span> |<span data-ttu-id="7a152-130">1</span><span class="sxs-lookup"><span data-stu-id="7a152-130">1</span></span> |
| <span data-ttu-id="7a152-131">ReplicaCount</span><span class="sxs-lookup"><span data-stu-id="7a152-131">ReplicaCount</span></span> |<span data-ttu-id="7a152-132">0</span><span class="sxs-lookup"><span data-stu-id="7a152-132">0</span></span> |<span data-ttu-id="7a152-133">1</span><span class="sxs-lookup"><span data-stu-id="7a152-133">1</span></span> |<span data-ttu-id="7a152-134">1</span><span class="sxs-lookup"><span data-stu-id="7a152-134">1</span></span> |
| <span data-ttu-id="7a152-135">Count</span><span class="sxs-lookup"><span data-stu-id="7a152-135">Count</span></span> |<span data-ttu-id="7a152-136">1</span><span class="sxs-lookup"><span data-stu-id="7a152-136">1</span></span> |<span data-ttu-id="7a152-137">1</span><span class="sxs-lookup"><span data-stu-id="7a152-137">1</span></span> |<span data-ttu-id="7a152-138">1</span><span class="sxs-lookup"><span data-stu-id="7a152-138">1</span></span> |

<span data-ttu-id="7a152-139">Ok, so with these default metrics, what do you get?</span><span class="sxs-lookup"><span data-stu-id="7a152-139">Ok, so with these default metrics, what do you get?</span></span> <span data-ttu-id="7a152-140">Well it turns out that for basic workloads you get a decent distribution of work.</span><span class="sxs-lookup"><span data-stu-id="7a152-140">Well it turns out that for basic workloads you get a decent distribution of work.</span></span> <span data-ttu-id="7a152-141">In the following example, let’s see what happens when we create two services.</span><span class="sxs-lookup"><span data-stu-id="7a152-141">In the following example, let’s see what happens when we create two services.</span></span> <span data-ttu-id="7a152-142">The first one a stateful service with three partitions and a target replica set size of three.</span><span class="sxs-lookup"><span data-stu-id="7a152-142">The first one a stateful service with three partitions and a target replica set size of three.</span></span> <span data-ttu-id="7a152-143">The second one a stateless service with one partition and an instance count of three:</span><span class="sxs-lookup"><span data-stu-id="7a152-143">The second one a stateless service with one partition and an instance count of three:</span></span>

<span data-ttu-id="7a152-144"><center>
![Cluster Layout with Default Metrics][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="7a152-144"><center>
![Cluster Layout with Default Metrics][Image1]
</center></span></span>

<span data-ttu-id="7a152-145">Here's what you get:</span><span class="sxs-lookup"><span data-stu-id="7a152-145">Here's what you get:</span></span>

* <span data-ttu-id="7a152-146">Primary replicas for the stateful service are not stacked up on a single node</span><span class="sxs-lookup"><span data-stu-id="7a152-146">Primary replicas for the stateful service are not stacked up on a single node</span></span>
* <span data-ttu-id="7a152-147">Replicas for the same partition are not on the same node</span><span class="sxs-lookup"><span data-stu-id="7a152-147">Replicas for the same partition are not on the same node</span></span>
* <span data-ttu-id="7a152-148">The total number of primaries and secondaries is distributed in the cluster</span><span class="sxs-lookup"><span data-stu-id="7a152-148">The total number of primaries and secondaries is distributed in the cluster</span></span>
* <span data-ttu-id="7a152-149">The total number of service objects are evenly allocated on each node</span><span class="sxs-lookup"><span data-stu-id="7a152-149">The total number of service objects are evenly allocated on each node</span></span>

<span data-ttu-id="7a152-150">Good!</span><span class="sxs-lookup"><span data-stu-id="7a152-150">Good!</span></span>

<span data-ttu-id="7a152-151">This works great until you start to run large numbers of real workloads: What's the likelihood that the partitioning scheme you picked results in perfectly even utilization by all partitions?</span><span class="sxs-lookup"><span data-stu-id="7a152-151">This works great until you start to run large numbers of real workloads: What's the likelihood that the partitioning scheme you picked results in perfectly even utilization by all partitions?</span></span> <span data-ttu-id="7a152-152">What’s the chance that the load for a given service is constant over time, or even just the same right now?</span><span class="sxs-lookup"><span data-stu-id="7a152-152">What’s the chance that the load for a given service is constant over time, or even just the same right now?</span></span>

<span data-ttu-id="7a152-153">Realistically, you could run with just the default metrics, but doing so usually means that your cluster utilization is lower than you’d like.</span><span class="sxs-lookup"><span data-stu-id="7a152-153">Realistically, you could run with just the default metrics, but doing so usually means that your cluster utilization is lower than you’d like.</span></span> <span data-ttu-id="7a152-154">This is because the default metric reporting isn’t adaptive and presumes everything is equivalent.</span><span class="sxs-lookup"><span data-stu-id="7a152-154">This is because the default metric reporting isn’t adaptive and presumes everything is equivalent.</span></span> <span data-ttu-id="7a152-155">In the worst case, using just the defaults can also result in overscheduled nodes resulting in performance issues.</span><span class="sxs-lookup"><span data-stu-id="7a152-155">In the worst case, using just the defaults can also result in overscheduled nodes resulting in performance issues.</span></span> <span data-ttu-id="7a152-156">We can do better with custom metrics and dynamic load reports, which we'll cover next.</span><span class="sxs-lookup"><span data-stu-id="7a152-156">We can do better with custom metrics and dynamic load reports, which we'll cover next.</span></span> <span data-ttu-id="7a152-157">For any serious workload, the odds of all services being equivalent forever is low.</span><span class="sxs-lookup"><span data-stu-id="7a152-157">For any serious workload, the odds of all services being equivalent forever is low.</span></span> <span data-ttu-id="7a152-158">If you're interested in getting the most out of your cluster and avoiding performance issues, you'll want to start looking into custom metrics.</span><span class="sxs-lookup"><span data-stu-id="7a152-158">If you're interested in getting the most out of your cluster and avoiding performance issues, you'll want to start looking into custom metrics.</span></span>

## <a name="custom-metrics"></a><span data-ttu-id="7a152-159">Custom metrics</span><span class="sxs-lookup"><span data-stu-id="7a152-159">Custom metrics</span></span>
<span data-ttu-id="7a152-160">Metrics are configured on a per-named-service-instance basis when you’re creating the service.</span><span class="sxs-lookup"><span data-stu-id="7a152-160">Metrics are configured on a per-named-service-instance basis when you’re creating the service.</span></span>

<span data-ttu-id="7a152-161">Any metric has some properties that describe it: a name, a default load, and a weight.</span><span class="sxs-lookup"><span data-stu-id="7a152-161">Any metric has some properties that describe it: a name, a default load, and a weight.</span></span>

* <span data-ttu-id="7a152-162">Metric Name: The name of the metric.</span><span class="sxs-lookup"><span data-stu-id="7a152-162">Metric Name: The name of the metric.</span></span> <span data-ttu-id="7a152-163">The metric name is a unique identifier for the metric within the cluster from the Resource Manager’s perspective.</span><span class="sxs-lookup"><span data-stu-id="7a152-163">The metric name is a unique identifier for the metric within the cluster from the Resource Manager’s perspective.</span></span>
* <span data-ttu-id="7a152-164">Default Load: The default load is represented differently depending on whether the service is stateless or stateful.</span><span class="sxs-lookup"><span data-stu-id="7a152-164">Default Load: The default load is represented differently depending on whether the service is stateless or stateful.</span></span>
  * <span data-ttu-id="7a152-165">For stateless services, each metric has a single property named DefaultLoad</span><span class="sxs-lookup"><span data-stu-id="7a152-165">For stateless services, each metric has a single property named DefaultLoad</span></span>
  * <span data-ttu-id="7a152-166">For stateful services you define:</span><span class="sxs-lookup"><span data-stu-id="7a152-166">For stateful services you define:</span></span>
    * <span data-ttu-id="7a152-167">PrimaryDefaultLoad: The default amount of this metric this service consumes when it is a Primary</span><span class="sxs-lookup"><span data-stu-id="7a152-167">PrimaryDefaultLoad: The default amount of this metric this service consumes when it is a Primary</span></span>
    * <span data-ttu-id="7a152-168">SecondaryDefaultLoad: The default amount of this metric this service consumes when it is a Secondary</span><span class="sxs-lookup"><span data-stu-id="7a152-168">SecondaryDefaultLoad: The default amount of this metric this service consumes when it is a Secondary</span></span>
* <span data-ttu-id="7a152-169">Weight: Metric weight defines how important this metric is relative to the other metrics for this service.</span><span class="sxs-lookup"><span data-stu-id="7a152-169">Weight: Metric weight defines how important this metric is relative to the other metrics for this service.</span></span>

<span data-ttu-id="7a152-170">If you define custom metrics and you want to also use the default metrics, you'll need to explicitly add them back.</span><span class="sxs-lookup"><span data-stu-id="7a152-170">If you define custom metrics and you want to also use the default metrics, you'll need to explicitly add them back.</span></span> <span data-ttu-id="7a152-171">This is because you want to be clear about the relationship between the default metrics and your custom metrics.</span><span class="sxs-lookup"><span data-stu-id="7a152-171">This is because you want to be clear about the relationship between the default metrics and your custom metrics.</span></span> <span data-ttu-id="7a152-172">For example, maybe you care about Memory consumption or WorkQueueDepth way more than you care about Primary distribution.</span><span class="sxs-lookup"><span data-stu-id="7a152-172">For example, maybe you care about Memory consumption or WorkQueueDepth way more than you care about Primary distribution.</span></span>

### <a name="defining-metrics-for-your-service---an-example"></a><span data-ttu-id="7a152-173">Defining metrics for your service - an example</span><span class="sxs-lookup"><span data-stu-id="7a152-173">Defining metrics for your service - an example</span></span>
<span data-ttu-id="7a152-174">Let’s say you wanted to configure a service that reports a metric called “MemoryInMb”, and that you also want to use the default metrics.</span><span class="sxs-lookup"><span data-stu-id="7a152-174">Let’s say you wanted to configure a service that reports a metric called “MemoryInMb”, and that you also want to use the default metrics.</span></span> <span data-ttu-id="7a152-175">Let’s also say that you’ve done some measurements and know that normally a Primary replica of that service takes up 20 units of "MemoryInMb", while secondaries take up 5.</span><span class="sxs-lookup"><span data-stu-id="7a152-175">Let’s also say that you’ve done some measurements and know that normally a Primary replica of that service takes up 20 units of "MemoryInMb", while secondaries take up 5.</span></span> <span data-ttu-id="7a152-176">You know that Memory is the most important metric in terms of managing the performance of this particular service, but you still want primary replicas to be balanced.</span><span class="sxs-lookup"><span data-stu-id="7a152-176">You know that Memory is the most important metric in terms of managing the performance of this particular service, but you still want primary replicas to be balanced.</span></span> <span data-ttu-id="7a152-177">Balancing Primaries is a good idea so that the loss of some node or fault domain doesn’t impact a majority of primary replicas along with it.</span><span class="sxs-lookup"><span data-stu-id="7a152-177">Balancing Primaries is a good idea so that the loss of some node or fault domain doesn’t impact a majority of primary replicas along with it.</span></span> <span data-ttu-id="7a152-178">Other than these tweaks, you want to use the default metrics.</span><span class="sxs-lookup"><span data-stu-id="7a152-178">Other than these tweaks, you want to use the default metrics.</span></span>

<span data-ttu-id="7a152-179">Here’s the code that you would write to create a service with that metric configuration:</span><span class="sxs-lookup"><span data-stu-id="7a152-179">Here’s the code that you would write to create a service with that metric configuration:</span></span>

<span data-ttu-id="7a152-180">Code:</span><span class="sxs-lookup"><span data-stu-id="7a152-180">Code:</span></span>

```csharp
StatefulServiceDescription serviceDescription = new StatefulServiceDescription();
StatefulServiceLoadMetricDescription memoryMetric = new StatefulServiceLoadMetricDescription();
memoryMetric.Name = "MemoryInMb";
memoryMetric.PrimaryDefaultLoad = 20;
memoryMetric.SecondaryDefaultLoad = 5;
memoryMetric.Weight = ServiceLoadMetricWeight.High;

StatefulServiceLoadMetricDescription primaryCountMetric = new StatefulServiceLoadMetricDescription();
primaryCountMetric.Name = "PrimaryCount";
primaryCountMetric.PrimaryDefaultLoad = 1;
primaryCountMetric.SecondaryDefaultLoad = 0;
primaryCountMetric.Weight = ServiceLoadMetricWeight.Medium;

StatefulServiceLoadMetricDescription replicaCountMetric = new StatefulServiceLoadMetricDescription();
replicaCountMetric.Name = "ReplicaCount";
replicaCountMetric.PrimaryDefaultLoad = 1;
replicaCountMetric.SecondaryDefaultLoad = 1;
replicaCountMetric.Weight = ServiceLoadMetricWeight.Low;

StatefulServiceLoadMetricDescription totalCountMetric = new StatefulServiceLoadMetricDescription();
totalCountMetric.Name = "Count";
totalCountMetric.PrimaryDefaultLoad = 1;
totalCountMetric.SecondaryDefaultLoad = 1;
totalCountMetric.Weight = ServiceLoadMetricWeight.Low;

serviceDescription.Metrics.Add(memoryMetric);
serviceDescription.Metrics.Add(primaryCountMetric);
serviceDescription.Metrics.Add(replicaCountMetric);
serviceDescription.Metrics.Add(totalCountMetric);

await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

<span data-ttu-id="7a152-181">Powershell:</span><span class="sxs-lookup"><span data-stu-id="7a152-181">Powershell:</span></span>

```posh
New-ServiceFabricService -ApplicationName $applicationName -ServiceName $serviceName -ServiceTypeName $serviceTypeName –Stateful -MinReplicaSetSize 2 -TargetReplicaSetSize 3 -PartitionSchemeSingleton –Metric @("MemoryInMb,High,20,5”,"PrimaryCount,Medium,1,0”,"ReplicaCount,Low,1,1”,"Count,Low,1,1”)
```

<span data-ttu-id="7a152-182">(Reminder: if you just want to use the default metrics, you don’t need to touch the metrics collection at all or do anything special when creating your service.)</span><span class="sxs-lookup"><span data-stu-id="7a152-182">(Reminder: if you just want to use the default metrics, you don’t need to touch the metrics collection at all or do anything special when creating your service.)</span></span>

<span data-ttu-id="7a152-183">Now that we've gotten an introduction and seen an example, let's go through each of these settings in more detail and talk about the behavior you'll get.</span><span class="sxs-lookup"><span data-stu-id="7a152-183">Now that we've gotten an introduction and seen an example, let's go through each of these settings in more detail and talk about the behavior you'll get.</span></span>

## <a name="load"></a><span data-ttu-id="7a152-184">Load</span><span class="sxs-lookup"><span data-stu-id="7a152-184">Load</span></span>
<span data-ttu-id="7a152-185">The whole point of defining metrics is to represent some load.</span><span class="sxs-lookup"><span data-stu-id="7a152-185">The whole point of defining metrics is to represent some load.</span></span> <span data-ttu-id="7a152-186">"Load" is how much of a given metric is consumed by some service instance or replica on a given node.</span><span class="sxs-lookup"><span data-stu-id="7a152-186">"Load" is how much of a given metric is consumed by some service instance or replica on a given node.</span></span> <span data-ttu-id="7a152-187">The expected load can be configured when a service is created, updated after the service is created, reported on a per service object basis, or all of the above.</span><span class="sxs-lookup"><span data-stu-id="7a152-187">The expected load can be configured when a service is created, updated after the service is created, reported on a per service object basis, or all of the above.</span></span>

## <a name="default-load"></a><span data-ttu-id="7a152-188">Default load</span><span class="sxs-lookup"><span data-stu-id="7a152-188">Default load</span></span>
<span data-ttu-id="7a152-189">Default load is how much load each service object (instance or replica) of this service consumes by default.</span><span class="sxs-lookup"><span data-stu-id="7a152-189">Default load is how much load each service object (instance or replica) of this service consumes by default.</span></span> <span data-ttu-id="7a152-190">For simpler services, the default load is a static definition that is never updated and that is used for the lifetime of the service.</span><span class="sxs-lookup"><span data-stu-id="7a152-190">For simpler services, the default load is a static definition that is never updated and that is used for the lifetime of the service.</span></span> <span data-ttu-id="7a152-191">Default load works great for simple capacity planning scenarios where certain amounts of resources are dedicated to different workloads.</span><span class="sxs-lookup"><span data-stu-id="7a152-191">Default load works great for simple capacity planning scenarios where certain amounts of resources are dedicated to different workloads.</span></span>

<span data-ttu-id="7a152-192">The Cluster Resource Manager allows stateful services to specify a different default load for both their Primaries and Secondaries, while stateless services can only specify one value.</span><span class="sxs-lookup"><span data-stu-id="7a152-192">The Cluster Resource Manager allows stateful services to specify a different default load for both their Primaries and Secondaries, while stateless services can only specify one value.</span></span> <span data-ttu-id="7a152-193">For stateful services the default load for primary and secondary replicas are typically different since replicas do different kinds of work in each role.</span><span class="sxs-lookup"><span data-stu-id="7a152-193">For stateful services the default load for primary and secondary replicas are typically different since replicas do different kinds of work in each role.</span></span> <span data-ttu-id="7a152-194">For example, primaries usually serve both reads and writes (and most of the computational burden), while secondaries don't.</span><span class="sxs-lookup"><span data-stu-id="7a152-194">For example, primaries usually serve both reads and writes (and most of the computational burden), while secondaries don't.</span></span> <span data-ttu-id="7a152-195">It's expected that the default load for a primary replica is higher than for secondary replicas, but the real numbers should depend on your own measurements.</span><span class="sxs-lookup"><span data-stu-id="7a152-195">It's expected that the default load for a primary replica is higher than for secondary replicas, but the real numbers should depend on your own measurements.</span></span>

## <a name="dynamic-load"></a><span data-ttu-id="7a152-196">Dynamic load</span><span class="sxs-lookup"><span data-stu-id="7a152-196">Dynamic load</span></span>
<span data-ttu-id="7a152-197">Let’s say that you’ve been running your service for a while.</span><span class="sxs-lookup"><span data-stu-id="7a152-197">Let’s say that you’ve been running your service for a while.</span></span> <span data-ttu-id="7a152-198">With some monitoring, you’ve noticed that:</span><span class="sxs-lookup"><span data-stu-id="7a152-198">With some monitoring, you’ve noticed that:</span></span>

1. <span data-ttu-id="7a152-199">Some partitions or instances of a given service consume more resources than others</span><span class="sxs-lookup"><span data-stu-id="7a152-199">Some partitions or instances of a given service consume more resources than others</span></span>
2. <span data-ttu-id="7a152-200">Some services have load that varies over time.</span><span class="sxs-lookup"><span data-stu-id="7a152-200">Some services have load that varies over time.</span></span>

<span data-ttu-id="7a152-201">There's lots of things that could cause these types of load fluctuations.</span><span class="sxs-lookup"><span data-stu-id="7a152-201">There's lots of things that could cause these types of load fluctuations.</span></span> <span data-ttu-id="7a152-202">The service or partition could be associated with a particular customer, or maybe they correspond to workloads that vary over the course of the day.</span><span class="sxs-lookup"><span data-stu-id="7a152-202">The service or partition could be associated with a particular customer, or maybe they correspond to workloads that vary over the course of the day.</span></span> <span data-ttu-id="7a152-203">Regardless of the reason, there’s no single number that you can use for default load.</span><span class="sxs-lookup"><span data-stu-id="7a152-203">Regardless of the reason, there’s no single number that you can use for default load.</span></span> <span data-ttu-id="7a152-204">Any value you pick for default load is wrong some of the time.</span><span class="sxs-lookup"><span data-stu-id="7a152-204">Any value you pick for default load is wrong some of the time.</span></span> <span data-ttu-id="7a152-205">This is a problem since incorrect default loads result in the Cluster Resource Manager either over or under allocating resources for your service.</span><span class="sxs-lookup"><span data-stu-id="7a152-205">This is a problem since incorrect default loads result in the Cluster Resource Manager either over or under allocating resources for your service.</span></span> <span data-ttu-id="7a152-206">As a result, you have nodes that are over or under utilized even if the Cluster Resource Manager thinks the cluster is balanced.</span><span class="sxs-lookup"><span data-stu-id="7a152-206">As a result, you have nodes that are over or under utilized even if the Cluster Resource Manager thinks the cluster is balanced.</span></span> <span data-ttu-id="7a152-207">Default loads are still good since they provide some information, but they're not a complete story for real workloads most of the time.</span><span class="sxs-lookup"><span data-stu-id="7a152-207">Default loads are still good since they provide some information, but they're not a complete story for real workloads most of the time.</span></span> <span data-ttu-id="7a152-208">This is why the Cluster Resource Manager allows each service object to update its own load during runtime.</span><span class="sxs-lookup"><span data-stu-id="7a152-208">This is why the Cluster Resource Manager allows each service object to update its own load during runtime.</span></span> <span data-ttu-id="7a152-209">This is called dynamic load reporting.</span><span class="sxs-lookup"><span data-stu-id="7a152-209">This is called dynamic load reporting.</span></span>

<span data-ttu-id="7a152-210">Dynamic load reports allow replicas or instances to adjust their allocation/reported load of metrics over their lifetime.</span><span class="sxs-lookup"><span data-stu-id="7a152-210">Dynamic load reports allow replicas or instances to adjust their allocation/reported load of metrics over their lifetime.</span></span> <span data-ttu-id="7a152-211">A service replica or instance that was cold and not doing any work would usually report that it was using low amounts of a given metric.</span><span class="sxs-lookup"><span data-stu-id="7a152-211">A service replica or instance that was cold and not doing any work would usually report that it was using low amounts of a given metric.</span></span> <span data-ttu-id="7a152-212">A busy replica or instance would report that they are using more.</span><span class="sxs-lookup"><span data-stu-id="7a152-212">A busy replica or instance would report that they are using more.</span></span>

<span data-ttu-id="7a152-213">Reporting per replica or instance allows the Cluster Resource Manager to reorganize the individual service objects in the cluster to ensure that the services get the resources they require.</span><span class="sxs-lookup"><span data-stu-id="7a152-213">Reporting per replica or instance allows the Cluster Resource Manager to reorganize the individual service objects in the cluster to ensure that the services get the resources they require.</span></span> <span data-ttu-id="7a152-214">Busy services effectively get to "reclaim" resources from other replicas or instances that are currently cold or doing less work.</span><span class="sxs-lookup"><span data-stu-id="7a152-214">Busy services effectively get to "reclaim" resources from other replicas or instances that are currently cold or doing less work.</span></span>

<span data-ttu-id="7a152-215">Within your Reliable Service the code to report load dynamically would look like this:</span><span class="sxs-lookup"><span data-stu-id="7a152-215">Within your Reliable Service the code to report load dynamically would look like this:</span></span>

<span data-ttu-id="7a152-216">Code:</span><span class="sxs-lookup"><span data-stu-id="7a152-216">Code:</span></span>

```csharp
this.ServicePartition.ReportLoad(new List<LoadMetric> { new LoadMetric("MemoryInMb", 1234), new LoadMetric("metric1", 42) });
```

<span data-ttu-id="7a152-217">Services replicas or instances may only report load for the metrics that they were configured to use when they were created.</span><span class="sxs-lookup"><span data-stu-id="7a152-217">Services replicas or instances may only report load for the metrics that they were configured to use when they were created.</span></span> <span data-ttu-id="7a152-218">The list of metrics a service can report is the same set specified when the service is created.</span><span class="sxs-lookup"><span data-stu-id="7a152-218">The list of metrics a service can report is the same set specified when the service is created.</span></span> <span data-ttu-id="7a152-219">The list of metrics associated with the service may also be updated dynamically.</span><span class="sxs-lookup"><span data-stu-id="7a152-219">The list of metrics associated with the service may also be updated dynamically.</span></span> <span data-ttu-id="7a152-220">If a service replica or instance tries to report load for a metric that it is not currently configured to use, Service Fabric logs that report but ignores it.</span><span class="sxs-lookup"><span data-stu-id="7a152-220">If a service replica or instance tries to report load for a metric that it is not currently configured to use, Service Fabric logs that report but ignores it.</span></span> <span data-ttu-id="7a152-221">If there are other metrics reported in the same API call that are valid, those reports are accepted and used.</span><span class="sxs-lookup"><span data-stu-id="7a152-221">If there are other metrics reported in the same API call that are valid, those reports are accepted and used.</span></span> <span data-ttu-id="7a152-222">This is neat because it allows for greater experimentation.</span><span class="sxs-lookup"><span data-stu-id="7a152-222">This is neat because it allows for greater experimentation.</span></span> <span data-ttu-id="7a152-223">The code can measure and report all metrics it knows about, and the operator can specify and update the metric configuration for that service without having to change the code.</span><span class="sxs-lookup"><span data-stu-id="7a152-223">The code can measure and report all metrics it knows about, and the operator can specify and update the metric configuration for that service without having to change the code.</span></span> <span data-ttu-id="7a152-224">For example, the administrator or ops team could disable a metric with a buggy report for a particular service, reconfigure the weights of metrics based on behavior, or enable a new metric only after the code has already been deployed and validated via other mechanisms.</span><span class="sxs-lookup"><span data-stu-id="7a152-224">For example, the administrator or ops team could disable a metric with a buggy report for a particular service, reconfigure the weights of metrics based on behavior, or enable a new metric only after the code has already been deployed and validated via other mechanisms.</span></span>

## <a name="mixing-default-load-values-and-dynamic-load-reports"></a><span data-ttu-id="7a152-225">Mixing default load values and dynamic load reports</span><span class="sxs-lookup"><span data-stu-id="7a152-225">Mixing default load values and dynamic load reports</span></span>
<span data-ttu-id="7a152-226">If default load isn't sufficient, and reporting load dynamically is recommended, can both be used?</span><span class="sxs-lookup"><span data-stu-id="7a152-226">If default load isn't sufficient, and reporting load dynamically is recommended, can both be used?</span></span> <span data-ttu-id="7a152-227">Yes!</span><span class="sxs-lookup"><span data-stu-id="7a152-227">Yes!</span></span> <span data-ttu-id="7a152-228">In fact, this is the recommended configuration.</span><span class="sxs-lookup"><span data-stu-id="7a152-228">In fact, this is the recommended configuration.</span></span> <span data-ttu-id="7a152-229">When both default load is set and dynamic load reports are utilized, the default load serves as an estimate until dynamic reports show up.</span><span class="sxs-lookup"><span data-stu-id="7a152-229">When both default load is set and dynamic load reports are utilized, the default load serves as an estimate until dynamic reports show up.</span></span> <span data-ttu-id="7a152-230">This is good because it gives the Cluster Resource Manager something to work with.</span><span class="sxs-lookup"><span data-stu-id="7a152-230">This is good because it gives the Cluster Resource Manager something to work with.</span></span> <span data-ttu-id="7a152-231">The default load allows the Cluster Resource Manager to place the service objects in good places when they are created.</span><span class="sxs-lookup"><span data-stu-id="7a152-231">The default load allows the Cluster Resource Manager to place the service objects in good places when they are created.</span></span> <span data-ttu-id="7a152-232">If no default load information is provided placement of services is random.</span><span class="sxs-lookup"><span data-stu-id="7a152-232">If no default load information is provided placement of services is random.</span></span> <span data-ttu-id="7a152-233">When load reports come in later the Cluster Resource Manager almost always has to move services around.</span><span class="sxs-lookup"><span data-stu-id="7a152-233">When load reports come in later the Cluster Resource Manager almost always has to move services around.</span></span>

<span data-ttu-id="7a152-234">Let’s take our previous example and see what happens when we add some custom metrics and dynamic load reporting.</span><span class="sxs-lookup"><span data-stu-id="7a152-234">Let’s take our previous example and see what happens when we add some custom metrics and dynamic load reporting.</span></span> <span data-ttu-id="7a152-235">In this example, we use “Memory” as an example metric.</span><span class="sxs-lookup"><span data-stu-id="7a152-235">In this example, we use “Memory” as an example metric.</span></span> <span data-ttu-id="7a152-236">Let’s presume that we initially created the stateful service with the following command:</span><span class="sxs-lookup"><span data-stu-id="7a152-236">Let’s presume that we initially created the stateful service with the following command:</span></span>

<span data-ttu-id="7a152-237">Powershell:</span><span class="sxs-lookup"><span data-stu-id="7a152-237">Powershell:</span></span>

```posh
New-ServiceFabricService -ApplicationName $applicationName -ServiceName $serviceName -ServiceTypeName $serviceTypeName –Stateful -MinReplicaSetSize 2 -TargetReplicaSetSize 3 -PartitionSchemeSingleton –Metric @("MemoryInMb,High,21,11”,"PrimaryCount,Medium,1,0”,"ReplicaCount,Low,1,1”,"Count,Low,1,1”)
```

<span data-ttu-id="7a152-238">As a reminder, this syntax is ("MetricName, MetricWeight, PrimaryDefaultLoad, SecondaryDefaultLoad").</span><span class="sxs-lookup"><span data-stu-id="7a152-238">As a reminder, this syntax is ("MetricName, MetricWeight, PrimaryDefaultLoad, SecondaryDefaultLoad").</span></span>

<span data-ttu-id="7a152-239">Let's see what one possible cluster layout could look like:</span><span class="sxs-lookup"><span data-stu-id="7a152-239">Let's see what one possible cluster layout could look like:</span></span>

<span data-ttu-id="7a152-240"><center>
![Cluster Balanced with both Default and Custom metrics][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="7a152-240"><center>
![Cluster Balanced with both Default and Custom metrics][Image2]
</center></span></span>

<span data-ttu-id="7a152-241">Some things that are worth noting:</span><span class="sxs-lookup"><span data-stu-id="7a152-241">Some things that are worth noting:</span></span>

* <span data-ttu-id="7a152-242">Because replicas or instances use the service’s default load until they report their own, we know that the replicas inside partition 1 of the stateful service haven’t reported load dynamically</span><span class="sxs-lookup"><span data-stu-id="7a152-242">Because replicas or instances use the service’s default load until they report their own, we know that the replicas inside partition 1 of the stateful service haven’t reported load dynamically</span></span>
* <span data-ttu-id="7a152-243">Secondary replicas within a partition can have their own load</span><span class="sxs-lookup"><span data-stu-id="7a152-243">Secondary replicas within a partition can have their own load</span></span>
* <span data-ttu-id="7a152-244">Overall the metrics look balanced.</span><span class="sxs-lookup"><span data-stu-id="7a152-244">Overall the metrics look balanced.</span></span> <span data-ttu-id="7a152-245">For memory, the ratio between the maximum and minimum load is 1.75 (the node with the most load is N3, the least is N2, and 28/16 = 1.75).</span><span class="sxs-lookup"><span data-stu-id="7a152-245">For memory, the ratio between the maximum and minimum load is 1.75 (the node with the most load is N3, the least is N2, and 28/16 = 1.75).</span></span>

<span data-ttu-id="7a152-246">There are some things that we still need to explain:</span><span class="sxs-lookup"><span data-stu-id="7a152-246">There are some things that we still need to explain:</span></span>

* <span data-ttu-id="7a152-247">What determined whether a ratio of 1.75 was reasonable or not?</span><span class="sxs-lookup"><span data-stu-id="7a152-247">What determined whether a ratio of 1.75 was reasonable or not?</span></span> <span data-ttu-id="7a152-248">How does the Cluster Resource Manager know if that’s good enough or if there is more work to do?</span><span class="sxs-lookup"><span data-stu-id="7a152-248">How does the Cluster Resource Manager know if that’s good enough or if there is more work to do?</span></span>
* <span data-ttu-id="7a152-249">When does balancing happen?</span><span class="sxs-lookup"><span data-stu-id="7a152-249">When does balancing happen?</span></span>
* <span data-ttu-id="7a152-250">What does it mean that Memory was weighted “High”?</span><span class="sxs-lookup"><span data-stu-id="7a152-250">What does it mean that Memory was weighted “High”?</span></span>

## <a name="metric-weights"></a><span data-ttu-id="7a152-251">Metric weights</span><span class="sxs-lookup"><span data-stu-id="7a152-251">Metric weights</span></span>
<span data-ttu-id="7a152-252">Being able to track the same metrics across different services is important.</span><span class="sxs-lookup"><span data-stu-id="7a152-252">Being able to track the same metrics across different services is important.</span></span> <span data-ttu-id="7a152-253">That view is what allows the Cluster Resource Manager to track consumption in the cluster, balance consumption across nodes, and ensure that nodes don’t go over capacity.</span><span class="sxs-lookup"><span data-stu-id="7a152-253">That view is what allows the Cluster Resource Manager to track consumption in the cluster, balance consumption across nodes, and ensure that nodes don’t go over capacity.</span></span> <span data-ttu-id="7a152-254">However, services may have different views as to the importance of the same metric.</span><span class="sxs-lookup"><span data-stu-id="7a152-254">However, services may have different views as to the importance of the same metric.</span></span> <span data-ttu-id="7a152-255">Also, in a cluster with many metrics and lots of services, perfectly balanced solutions may not exist for all metrics.</span><span class="sxs-lookup"><span data-stu-id="7a152-255">Also, in a cluster with many metrics and lots of services, perfectly balanced solutions may not exist for all metrics.</span></span> <span data-ttu-id="7a152-256">How should the Cluster Resource Manager handle these situations?</span><span class="sxs-lookup"><span data-stu-id="7a152-256">How should the Cluster Resource Manager handle these situations?</span></span>

<span data-ttu-id="7a152-257">Metric weights allow the Cluster Resource Manager to decide how to balance the cluster when there’s no perfect answer.</span><span class="sxs-lookup"><span data-stu-id="7a152-257">Metric weights allow the Cluster Resource Manager to decide how to balance the cluster when there’s no perfect answer.</span></span> <span data-ttu-id="7a152-258">Metric weights also allow the Cluster Resource Manager to balance specific services differently.</span><span class="sxs-lookup"><span data-stu-id="7a152-258">Metric weights also allow the Cluster Resource Manager to balance specific services differently.</span></span> <span data-ttu-id="7a152-259">Metrics can have four different weight levels: Zero, Low, Medium, and High.</span><span class="sxs-lookup"><span data-stu-id="7a152-259">Metrics can have four different weight levels: Zero, Low, Medium, and High.</span></span> <span data-ttu-id="7a152-260">A metric with a weight of Zero contributes nothing when considering whether things are balanced or not, but its load does still contribute to things like capacity.</span><span class="sxs-lookup"><span data-stu-id="7a152-260">A metric with a weight of Zero contributes nothing when considering whether things are balanced or not, but its load does still contribute to things like capacity.</span></span>

<span data-ttu-id="7a152-261">The real impact of different metric weights in the cluster is that the Cluster Resource Manager generates different solutions.</span><span class="sxs-lookup"><span data-stu-id="7a152-261">The real impact of different metric weights in the cluster is that the Cluster Resource Manager generates different solutions.</span></span> <span data-ttu-id="7a152-262">Metric weights tell the Cluster Resource Manager that certain metrics are more important than others.</span><span class="sxs-lookup"><span data-stu-id="7a152-262">Metric weights tell the Cluster Resource Manager that certain metrics are more important than others.</span></span> <span data-ttu-id="7a152-263">When there's no perfect solution the Cluster Resource Manager can prefer solutions which balance the higher weighted metrics better.</span><span class="sxs-lookup"><span data-stu-id="7a152-263">When there's no perfect solution the Cluster Resource Manager can prefer solutions which balance the higher weighted metrics better.</span></span> <span data-ttu-id="7a152-264">If one service thinks a metric is unimportant, it may find their use of that metric imbalanced.</span><span class="sxs-lookup"><span data-stu-id="7a152-264">If one service thinks a metric is unimportant, it may find their use of that metric imbalanced.</span></span> <span data-ttu-id="7a152-265">This allows another service to get an even distribution that is important to it.</span><span class="sxs-lookup"><span data-stu-id="7a152-265">This allows another service to get an even distribution that is important to it.</span></span>

<span data-ttu-id="7a152-266">Let’s look at an example of some load reports and how different metric weights can result in different allocations in the cluster.</span><span class="sxs-lookup"><span data-stu-id="7a152-266">Let’s look at an example of some load reports and how different metric weights can result in different allocations in the cluster.</span></span> <span data-ttu-id="7a152-267">In this example, we see that switching the relative weight of the metrics results in the Cluster Resource Manager preferring different solutions and creating different arrangements of services.</span><span class="sxs-lookup"><span data-stu-id="7a152-267">In this example, we see that switching the relative weight of the metrics results in the Cluster Resource Manager preferring different solutions and creating different arrangements of services.</span></span>

<span data-ttu-id="7a152-268"><center>
![Metric Weight Example and Its Impact on Balancing Solutions][Image3]
</center></span><span class="sxs-lookup"><span data-stu-id="7a152-268"><center>
![Metric Weight Example and Its Impact on Balancing Solutions][Image3]
</center></span></span>

<span data-ttu-id="7a152-269">In this example, there are four different services, all reporting different values for two different metrics A and B. In one case all the services define Metric A is the most important one (Weight = High) and MetricB as unimportant (Weight = Low).</span><span class="sxs-lookup"><span data-stu-id="7a152-269">In this example, there are four different services, all reporting different values for two different metrics A and B. In one case all the services define Metric A is the most important one (Weight = High) and MetricB as unimportant (Weight = Low).</span></span> <span data-ttu-id="7a152-270">In this case, we see that the Cluster Resource Manager places the services so that MetricA is better balanced (has a lower standard deviation) than MetricB.</span><span class="sxs-lookup"><span data-stu-id="7a152-270">In this case, we see that the Cluster Resource Manager places the services so that MetricA is better balanced (has a lower standard deviation) than MetricB.</span></span> <span data-ttu-id="7a152-271">In the second case, we reverse the metric weights.</span><span class="sxs-lookup"><span data-stu-id="7a152-271">In the second case, we reverse the metric weights.</span></span> <span data-ttu-id="7a152-272">As a result, the Cluster Resource Manager would probably swap services A and B to come up with an allocation where MetricB is better balanced than MetricA.</span><span class="sxs-lookup"><span data-stu-id="7a152-272">As a result, the Cluster Resource Manager would probably swap services A and B to come up with an allocation where MetricB is better balanced than MetricA.</span></span>

### <a name="global-metric-weights"></a><span data-ttu-id="7a152-273">Global metric weights</span><span class="sxs-lookup"><span data-stu-id="7a152-273">Global metric weights</span></span>
<span data-ttu-id="7a152-274">So if ServiceA defines MetricA as most important, and ServiceB doesn’t care about it at all, what’s the actual weight that ends up getting used?</span><span class="sxs-lookup"><span data-stu-id="7a152-274">So if ServiceA defines MetricA as most important, and ServiceB doesn’t care about it at all, what’s the actual weight that ends up getting used?</span></span>

<span data-ttu-id="7a152-275">There are actually multiple weights that are tracked for every metric.</span><span class="sxs-lookup"><span data-stu-id="7a152-275">There are actually multiple weights that are tracked for every metric.</span></span> <span data-ttu-id="7a152-276">The first set are the weights that each service defined for the metric.</span><span class="sxs-lookup"><span data-stu-id="7a152-276">The first set are the weights that each service defined for the metric.</span></span> <span data-ttu-id="7a152-277">The other weight is a global weight, which is the average from all the services that report that metric.</span><span class="sxs-lookup"><span data-stu-id="7a152-277">The other weight is a global weight, which is the average from all the services that report that metric.</span></span> <span data-ttu-id="7a152-278">The Cluster Resource Manager uses both these weights when calculating the scores of the solutions.</span><span class="sxs-lookup"><span data-stu-id="7a152-278">The Cluster Resource Manager uses both these weights when calculating the scores of the solutions.</span></span> <span data-ttu-id="7a152-279">This is because it is important that a service is balanced according to its own priorities, but also that the cluster as a whole is allocated correctly.</span><span class="sxs-lookup"><span data-stu-id="7a152-279">This is because it is important that a service is balanced according to its own priorities, but also that the cluster as a whole is allocated correctly.</span></span>

<span data-ttu-id="7a152-280">What would happen if the Cluster Resource Manager didn’t care about both global and local balance?</span><span class="sxs-lookup"><span data-stu-id="7a152-280">What would happen if the Cluster Resource Manager didn’t care about both global and local balance?</span></span> <span data-ttu-id="7a152-281">Well, it’s trivial to construct solutions that are globally balanced but which result in poor resource allocations for individual services.</span><span class="sxs-lookup"><span data-stu-id="7a152-281">Well, it’s trivial to construct solutions that are globally balanced but which result in poor resource allocations for individual services.</span></span> <span data-ttu-id="7a152-282">In the following example, let’s look at the default metrics that a stateful service is configured with and see what happens when if only global balance is considered:</span><span class="sxs-lookup"><span data-stu-id="7a152-282">In the following example, let’s look at the default metrics that a stateful service is configured with and see what happens when if only global balance is considered:</span></span>

<span data-ttu-id="7a152-283"><center>
![The Impact of a Global Only Solution][Image4]
</center></span><span class="sxs-lookup"><span data-stu-id="7a152-283"><center>
![The Impact of a Global Only Solution][Image4]
</center></span></span>

<span data-ttu-id="7a152-284">In the top example where we only looked at global balance, the cluster as a whole is indeed balanced.</span><span class="sxs-lookup"><span data-stu-id="7a152-284">In the top example where we only looked at global balance, the cluster as a whole is indeed balanced.</span></span> <span data-ttu-id="7a152-285">All nodes have the same count of primaries and the same number total replicas.</span><span class="sxs-lookup"><span data-stu-id="7a152-285">All nodes have the same count of primaries and the same number total replicas.</span></span> <span data-ttu-id="7a152-286">However, if you look at the actual impact of this allocation it’s not so good: the loss of any node impacts a particular workload disproportionately, because it takes out all its primaries.</span><span class="sxs-lookup"><span data-stu-id="7a152-286">However, if you look at the actual impact of this allocation it’s not so good: the loss of any node impacts a particular workload disproportionately, because it takes out all its primaries.</span></span> <span data-ttu-id="7a152-287">For example, if the first node fails the three primaries for the three different partitions of the Circle service would all be lost.</span><span class="sxs-lookup"><span data-stu-id="7a152-287">For example, if the first node fails the three primaries for the three different partitions of the Circle service would all be lost.</span></span> <span data-ttu-id="7a152-288">Conversely, the other two services (Triangle and Hexagon) have their partitions lose a replica, which causes no disruption (other than having to recover the down replica).</span><span class="sxs-lookup"><span data-stu-id="7a152-288">Conversely, the other two services (Triangle and Hexagon) have their partitions lose a replica, which causes no disruption (other than having to recover the down replica).</span></span>

<span data-ttu-id="7a152-289">In the bottom example, the Cluster Resource Manager has distributed the replicas based on both the global and per-service balance.</span><span class="sxs-lookup"><span data-stu-id="7a152-289">In the bottom example, the Cluster Resource Manager has distributed the replicas based on both the global and per-service balance.</span></span> <span data-ttu-id="7a152-290">When calculating the score of the solution it gives most of the weight to the global solution, and a (configurable) portion to individual services.</span><span class="sxs-lookup"><span data-stu-id="7a152-290">When calculating the score of the solution it gives most of the weight to the global solution, and a (configurable) portion to individual services.</span></span> <span data-ttu-id="7a152-291">Global balance is calculated based on the average of the metric weights configured for each of the services.</span><span class="sxs-lookup"><span data-stu-id="7a152-291">Global balance is calculated based on the average of the metric weights configured for each of the services.</span></span> <span data-ttu-id="7a152-292">Each service is balanced according to its own defined metric weights.</span><span class="sxs-lookup"><span data-stu-id="7a152-292">Each service is balanced according to its own defined metric weights.</span></span> <span data-ttu-id="7a152-293">This ensures that the services are balanced within themselves according to their own needs as much as possible.</span><span class="sxs-lookup"><span data-stu-id="7a152-293">This ensures that the services are balanced within themselves according to their own needs as much as possible.</span></span> <span data-ttu-id="7a152-294">As a result, if the same first node fails the loss of primaries (and secondaries) is distributed across all partitions of all services.</span><span class="sxs-lookup"><span data-stu-id="7a152-294">As a result, if the same first node fails the loss of primaries (and secondaries) is distributed across all partitions of all services.</span></span> <span data-ttu-id="7a152-295">The impact to each is the same.</span><span class="sxs-lookup"><span data-stu-id="7a152-295">The impact to each is the same.</span></span>

## <a name="next-steps"></a><span data-ttu-id="7a152-296">Next steps</span><span class="sxs-lookup"><span data-stu-id="7a152-296">Next steps</span></span>
* <span data-ttu-id="7a152-297">For more information about the other options available for configuring services, check out the topic on the other Cluster Resource Manager configurations available [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)</span><span class="sxs-lookup"><span data-stu-id="7a152-297">For more information about the other options available for configuring services, check out the topic on the other Cluster Resource Manager configurations available [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)</span></span>
* <span data-ttu-id="7a152-298">Defining Defragmentation Metrics is one way to consolidate load on nodes instead of spreading it out. To learn how to configure defragmentation, refer to [this article](service-fabric-cluster-resource-manager-defragmentation-metrics.md)</span><span class="sxs-lookup"><span data-stu-id="7a152-298">Defining Defragmentation Metrics is one way to consolidate load on nodes instead of spreading it out. To learn how to configure defragmentation, refer to [this article](service-fabric-cluster-resource-manager-defragmentation-metrics.md)</span></span>
* <span data-ttu-id="7a152-299">To find out about how the Cluster Resource Manager manages and balances load in the cluster, check out the article on [balancing load](service-fabric-cluster-resource-manager-balancing.md)</span><span class="sxs-lookup"><span data-stu-id="7a152-299">To find out about how the Cluster Resource Manager manages and balances load in the cluster, check out the article on [balancing load](service-fabric-cluster-resource-manager-balancing.md)</span></span>
* <span data-ttu-id="7a152-300">Start from the beginning and [get an Introduction to the Service Fabric Cluster Resource Manager](service-fabric-cluster-resource-manager-introduction.md)</span><span class="sxs-lookup"><span data-stu-id="7a152-300">Start from the beginning and [get an Introduction to the Service Fabric Cluster Resource Manager](service-fabric-cluster-resource-manager-introduction.md)</span></span>
* <span data-ttu-id="7a152-301">Movement Cost is one way of signaling to the Cluster Resource Manager that certain services are more expensive to move than others.</span><span class="sxs-lookup"><span data-stu-id="7a152-301">Movement Cost is one way of signaling to the Cluster Resource Manager that certain services are more expensive to move than others.</span></span> <span data-ttu-id="7a152-302">To learn more about movement cost, refer to [this article](service-fabric-cluster-resource-manager-movement-cost.md)</span><span class="sxs-lookup"><span data-stu-id="7a152-302">To learn more about movement cost, refer to [this article](service-fabric-cluster-resource-manager-movement-cost.md)</span></span>

[Image1]:https://docstestmedia1.blob.core.windows.net/azure-media/articles/service-fabric/media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-cluster-layout-with-default-metrics.png
[Image2]:https://docstestmedia1.blob.core.windows.net/azure-media/articles/service-fabric/media/service-fabric-cluster-resource-manager-metrics/Service-Fabric-Resource-Manager-Dynamic-Load-Reports.png
[Image3]:https://docstestmedia1.blob.core.windows.net/azure-media/articles/service-fabric/media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-metric-weights-impact.png
[Image4]:https://docstestmedia1.blob.core.windows.net/azure-media/articles/service-fabric/media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-global-vs-local-balancing.png




