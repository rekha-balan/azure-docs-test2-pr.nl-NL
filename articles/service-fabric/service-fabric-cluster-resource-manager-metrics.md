---
title: Manage Azure Service Fabric app load using metrics | Microsoft Docs
description: Learn about how to configure and use metrics in Service Fabric to manage service resource consumption.
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: ''
ms.assetid: 0d622ea6-a7c7-4bef-886b-06e6b85a97fb
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: conceptual
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 0c9b7626cc62a7349d84eed21a2f0b7c6ac732a8
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44808833"
---
# <a name="managing-resource-consumption-and-load-in-service-fabric-with-metrics"></a><span data-ttu-id="e2c8f-103">Managing resource consumption and load in Service Fabric with metrics</span><span class="sxs-lookup"><span data-stu-id="e2c8f-103">Managing resource consumption and load in Service Fabric with metrics</span></span>
<span data-ttu-id="e2c8f-104">*Metrics* are the resources that your services care about and which are provided by the nodes in the cluster.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-104">*Metrics* are the resources that your services care about and which are provided by the nodes in the cluster.</span></span> <span data-ttu-id="e2c8f-105">A metric is anything that you want to manage in order to improve or monitor the performance of your services.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-105">A metric is anything that you want to manage in order to improve or monitor the performance of your services.</span></span> <span data-ttu-id="e2c8f-106">For example, you might watch memory consumption to know if your service is overloaded.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-106">For example, you might watch memory consumption to know if your service is overloaded.</span></span> <span data-ttu-id="e2c8f-107">Another use is to figure out whether the service could move elsewhere where memory is less constrained in order to get better performance.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-107">Another use is to figure out whether the service could move elsewhere where memory is less constrained in order to get better performance.</span></span>

<span data-ttu-id="e2c8f-108">Things like Memory, Disk, and CPU usage are examples of metrics.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-108">Things like Memory, Disk, and CPU usage are examples of metrics.</span></span> <span data-ttu-id="e2c8f-109">These metrics are physical metrics, resources that correspond to physical resources on the node that need to be managed.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-109">These metrics are physical metrics, resources that correspond to physical resources on the node that need to be managed.</span></span> <span data-ttu-id="e2c8f-110">Metrics can also be (and commonly are) logical metrics.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-110">Metrics can also be (and commonly are) logical metrics.</span></span> <span data-ttu-id="e2c8f-111">Logical metrics are things like “MyWorkQueueDepth” or "MessagesToProcess" or "TotalRecords".</span><span class="sxs-lookup"><span data-stu-id="e2c8f-111">Logical metrics are things like “MyWorkQueueDepth” or "MessagesToProcess" or "TotalRecords".</span></span> <span data-ttu-id="e2c8f-112">Logical metrics are application-defined and indirectly correspond to some physical resource consumption.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-112">Logical metrics are application-defined and indirectly correspond to some physical resource consumption.</span></span> <span data-ttu-id="e2c8f-113">Logical metrics are common because it can be hard to measure and report consumption of physical resources on a per-service basis.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-113">Logical metrics are common because it can be hard to measure and report consumption of physical resources on a per-service basis.</span></span> <span data-ttu-id="e2c8f-114">The complexity of measuring and reporting your own physical metrics is also why Service Fabric provides some default metrics.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-114">The complexity of measuring and reporting your own physical metrics is also why Service Fabric provides some default metrics.</span></span>

## <a name="default-metrics"></a><span data-ttu-id="e2c8f-115">Default metrics</span><span class="sxs-lookup"><span data-stu-id="e2c8f-115">Default metrics</span></span>
<span data-ttu-id="e2c8f-116">Let’s say that you want to get started writing and deploying your service.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-116">Let’s say that you want to get started writing and deploying your service.</span></span> <span data-ttu-id="e2c8f-117">At this point you don’t know what physical or logical resources it consumes.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-117">At this point you don’t know what physical or logical resources it consumes.</span></span> <span data-ttu-id="e2c8f-118">That’s fine!</span><span class="sxs-lookup"><span data-stu-id="e2c8f-118">That’s fine!</span></span> <span data-ttu-id="e2c8f-119">The Service Fabric Cluster Resource Manager uses some default metrics when no other metrics are specified.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-119">The Service Fabric Cluster Resource Manager uses some default metrics when no other metrics are specified.</span></span> <span data-ttu-id="e2c8f-120">They are:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-120">They are:</span></span>

  - <span data-ttu-id="e2c8f-121">PrimaryCount - count of Primary replicas on the node</span><span class="sxs-lookup"><span data-stu-id="e2c8f-121">PrimaryCount - count of Primary replicas on the node</span></span> 
  - <span data-ttu-id="e2c8f-122">ReplicaCount - count of total stateful replicas on the node</span><span class="sxs-lookup"><span data-stu-id="e2c8f-122">ReplicaCount - count of total stateful replicas on the node</span></span>
  - <span data-ttu-id="e2c8f-123">Count - count of all service objects (stateless and stateful) on the node</span><span class="sxs-lookup"><span data-stu-id="e2c8f-123">Count - count of all service objects (stateless and stateful) on the node</span></span>

| <span data-ttu-id="e2c8f-124">Metric</span><span class="sxs-lookup"><span data-stu-id="e2c8f-124">Metric</span></span> | <span data-ttu-id="e2c8f-125">Stateless Instance Load</span><span class="sxs-lookup"><span data-stu-id="e2c8f-125">Stateless Instance Load</span></span> | <span data-ttu-id="e2c8f-126">Stateful Secondary Load</span><span class="sxs-lookup"><span data-stu-id="e2c8f-126">Stateful Secondary Load</span></span> | <span data-ttu-id="e2c8f-127">Stateful Primary Load</span><span class="sxs-lookup"><span data-stu-id="e2c8f-127">Stateful Primary Load</span></span> | <span data-ttu-id="e2c8f-128">Weight</span><span class="sxs-lookup"><span data-stu-id="e2c8f-128">Weight</span></span> |
| --- | --- | --- | --- | --- |
| <span data-ttu-id="e2c8f-129">PrimaryCount</span><span class="sxs-lookup"><span data-stu-id="e2c8f-129">PrimaryCount</span></span> |<span data-ttu-id="e2c8f-130">0</span><span class="sxs-lookup"><span data-stu-id="e2c8f-130">0</span></span> |<span data-ttu-id="e2c8f-131">0</span><span class="sxs-lookup"><span data-stu-id="e2c8f-131">0</span></span> |<span data-ttu-id="e2c8f-132">1</span><span class="sxs-lookup"><span data-stu-id="e2c8f-132">1</span></span> |<span data-ttu-id="e2c8f-133">High</span><span class="sxs-lookup"><span data-stu-id="e2c8f-133">High</span></span> |
| <span data-ttu-id="e2c8f-134">ReplicaCount</span><span class="sxs-lookup"><span data-stu-id="e2c8f-134">ReplicaCount</span></span> |<span data-ttu-id="e2c8f-135">0</span><span class="sxs-lookup"><span data-stu-id="e2c8f-135">0</span></span> |<span data-ttu-id="e2c8f-136">1</span><span class="sxs-lookup"><span data-stu-id="e2c8f-136">1</span></span> |<span data-ttu-id="e2c8f-137">1</span><span class="sxs-lookup"><span data-stu-id="e2c8f-137">1</span></span> |<span data-ttu-id="e2c8f-138">Medium</span><span class="sxs-lookup"><span data-stu-id="e2c8f-138">Medium</span></span> |
| <span data-ttu-id="e2c8f-139">Count</span><span class="sxs-lookup"><span data-stu-id="e2c8f-139">Count</span></span> |<span data-ttu-id="e2c8f-140">1</span><span class="sxs-lookup"><span data-stu-id="e2c8f-140">1</span></span> |<span data-ttu-id="e2c8f-141">1</span><span class="sxs-lookup"><span data-stu-id="e2c8f-141">1</span></span> |<span data-ttu-id="e2c8f-142">1</span><span class="sxs-lookup"><span data-stu-id="e2c8f-142">1</span></span> |<span data-ttu-id="e2c8f-143">Low</span><span class="sxs-lookup"><span data-stu-id="e2c8f-143">Low</span></span> |


<span data-ttu-id="e2c8f-144">For basic workloads, the default metrics provide a decent distribution of work in the cluster.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-144">For basic workloads, the default metrics provide a decent distribution of work in the cluster.</span></span> <span data-ttu-id="e2c8f-145">In the following example, let’s see what happens when we create two services and rely on the default metrics for balancing.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-145">In the following example, let’s see what happens when we create two services and rely on the default metrics for balancing.</span></span> <span data-ttu-id="e2c8f-146">The first service is a stateful service with three partitions and a target replica set size of three.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-146">The first service is a stateful service with three partitions and a target replica set size of three.</span></span> <span data-ttu-id="e2c8f-147">The second service is a stateless service with one partition and an instance count of three.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-147">The second service is a stateless service with one partition and an instance count of three.</span></span>

<span data-ttu-id="e2c8f-148">Here's what you get:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-148">Here's what you get:</span></span>

<span data-ttu-id="e2c8f-149"><center>
![Cluster Layout with Default Metrics][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="e2c8f-149"><center>
![Cluster Layout with Default Metrics][Image1]
</center></span></span>

<span data-ttu-id="e2c8f-150">Some things to note:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-150">Some things to note:</span></span>
  - <span data-ttu-id="e2c8f-151">Primary replicas for the stateful service are distributed across several nodes</span><span class="sxs-lookup"><span data-stu-id="e2c8f-151">Primary replicas for the stateful service are distributed across several nodes</span></span>
  - <span data-ttu-id="e2c8f-152">Replicas for the same partition are on different nodes</span><span class="sxs-lookup"><span data-stu-id="e2c8f-152">Replicas for the same partition are on different nodes</span></span>
  - <span data-ttu-id="e2c8f-153">The total number of primaries and secondaries is distributed in the cluster</span><span class="sxs-lookup"><span data-stu-id="e2c8f-153">The total number of primaries and secondaries is distributed in the cluster</span></span>
  - <span data-ttu-id="e2c8f-154">The total number of service objects are evenly allocated on each node</span><span class="sxs-lookup"><span data-stu-id="e2c8f-154">The total number of service objects are evenly allocated on each node</span></span>

<span data-ttu-id="e2c8f-155">Good!</span><span class="sxs-lookup"><span data-stu-id="e2c8f-155">Good!</span></span>

<span data-ttu-id="e2c8f-156">The default metrics work great as a start.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-156">The default metrics work great as a start.</span></span> <span data-ttu-id="e2c8f-157">However, the default metrics will only carry you so far.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-157">However, the default metrics will only carry you so far.</span></span> <span data-ttu-id="e2c8f-158">For example: What's the likelihood that the partitioning scheme you picked results in perfectly even utilization by all partitions?</span><span class="sxs-lookup"><span data-stu-id="e2c8f-158">For example: What's the likelihood that the partitioning scheme you picked results in perfectly even utilization by all partitions?</span></span> <span data-ttu-id="e2c8f-159">What’s the chance that the load for a given service is constant over time, or even just the same across multiple partitions right now?</span><span class="sxs-lookup"><span data-stu-id="e2c8f-159">What’s the chance that the load for a given service is constant over time, or even just the same across multiple partitions right now?</span></span>

<span data-ttu-id="e2c8f-160">You could run with just the default metrics.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-160">You could run with just the default metrics.</span></span> <span data-ttu-id="e2c8f-161">However, doing so usually means that your cluster utilization is lower and more uneven than you’d like.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-161">However, doing so usually means that your cluster utilization is lower and more uneven than you’d like.</span></span> <span data-ttu-id="e2c8f-162">This is because the default metrics aren't adaptive and presume everything is equivalent.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-162">This is because the default metrics aren't adaptive and presume everything is equivalent.</span></span> <span data-ttu-id="e2c8f-163">For example, a Primary that is busy and one that is not both contribute "1" to the PrimaryCount metric.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-163">For example, a Primary that is busy and one that is not both contribute "1" to the PrimaryCount metric.</span></span> <span data-ttu-id="e2c8f-164">In the worst case, using only the default metrics can also result in overscheduled nodes resulting in performance issues.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-164">In the worst case, using only the default metrics can also result in overscheduled nodes resulting in performance issues.</span></span> <span data-ttu-id="e2c8f-165">If you're interested in getting the most out of your cluster and avoiding performance issues, you need to use custom metrics and dynamic load reporting.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-165">If you're interested in getting the most out of your cluster and avoiding performance issues, you need to use custom metrics and dynamic load reporting.</span></span>

## <a name="custom-metrics"></a><span data-ttu-id="e2c8f-166">Custom metrics</span><span class="sxs-lookup"><span data-stu-id="e2c8f-166">Custom metrics</span></span>
<span data-ttu-id="e2c8f-167">Metrics are configured on a per-named-service-instance basis when you’re creating the service.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-167">Metrics are configured on a per-named-service-instance basis when you’re creating the service.</span></span>

<span data-ttu-id="e2c8f-168">Any metric has some properties that describe it: a name, a weight, and a default load.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-168">Any metric has some properties that describe it: a name, a weight, and a default load.</span></span>

* <span data-ttu-id="e2c8f-169">Metric Name: The name of the metric.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-169">Metric Name: The name of the metric.</span></span> <span data-ttu-id="e2c8f-170">The metric name is a unique identifier for the metric within the cluster from the Resource Manager’s perspective.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-170">The metric name is a unique identifier for the metric within the cluster from the Resource Manager’s perspective.</span></span>
* <span data-ttu-id="e2c8f-171">Weight: Metric weight defines how important this metric is relative to the other metrics for this service.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-171">Weight: Metric weight defines how important this metric is relative to the other metrics for this service.</span></span>
* <span data-ttu-id="e2c8f-172">Default Load: The default load is represented differently depending on whether the service is stateless or stateful.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-172">Default Load: The default load is represented differently depending on whether the service is stateless or stateful.</span></span>
  * <span data-ttu-id="e2c8f-173">For stateless services, each metric has a single property named DefaultLoad</span><span class="sxs-lookup"><span data-stu-id="e2c8f-173">For stateless services, each metric has a single property named DefaultLoad</span></span>
  * <span data-ttu-id="e2c8f-174">For stateful services you define:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-174">For stateful services you define:</span></span>
    * <span data-ttu-id="e2c8f-175">PrimaryDefaultLoad: The default amount of this metric this service consumes when it is a Primary</span><span class="sxs-lookup"><span data-stu-id="e2c8f-175">PrimaryDefaultLoad: The default amount of this metric this service consumes when it is a Primary</span></span>
    * <span data-ttu-id="e2c8f-176">SecondaryDefaultLoad: The default amount of this metric this service consumes when it is a Secondary</span><span class="sxs-lookup"><span data-stu-id="e2c8f-176">SecondaryDefaultLoad: The default amount of this metric this service consumes when it is a Secondary</span></span>

> [!NOTE]
> <span data-ttu-id="e2c8f-177">If you define custom metrics and you want to _also_ use the default metrics, you need to _explicitly_ add the default metrics back and define weights and values for them.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-177">If you define custom metrics and you want to _also_ use the default metrics, you need to _explicitly_ add the default metrics back and define weights and values for them.</span></span> <span data-ttu-id="e2c8f-178">This is because you must define the relationship between the default metrics and your custom metrics.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-178">This is because you must define the relationship between the default metrics and your custom metrics.</span></span> <span data-ttu-id="e2c8f-179">For example, maybe you care about ConnectionCount or WorkQueueDepth more than Primary distribution.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-179">For example, maybe you care about ConnectionCount or WorkQueueDepth more than Primary distribution.</span></span> <span data-ttu-id="e2c8f-180">By default the weight of the PrimaryCount metric is High, so you want to reduce it to Medium when you add your other metrics to ensure they take precedence.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-180">By default the weight of the PrimaryCount metric is High, so you want to reduce it to Medium when you add your other metrics to ensure they take precedence.</span></span>
>

### <a name="defining-metrics-for-your-service---an-example"></a><span data-ttu-id="e2c8f-181">Defining metrics for your service - an example</span><span class="sxs-lookup"><span data-stu-id="e2c8f-181">Defining metrics for your service - an example</span></span>
<span data-ttu-id="e2c8f-182">Let’s say you want the following configuration:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-182">Let’s say you want the following configuration:</span></span>

  - <span data-ttu-id="e2c8f-183">Your service reports a metric named "ConnectionCount”</span><span class="sxs-lookup"><span data-stu-id="e2c8f-183">Your service reports a metric named "ConnectionCount”</span></span>
  - <span data-ttu-id="e2c8f-184">You also want to use the default metrics</span><span class="sxs-lookup"><span data-stu-id="e2c8f-184">You also want to use the default metrics</span></span> 
  - <span data-ttu-id="e2c8f-185">You’ve done some measurements and know that normally a Primary replica of that service takes up 20 units of "ConnectionCount"</span><span class="sxs-lookup"><span data-stu-id="e2c8f-185">You’ve done some measurements and know that normally a Primary replica of that service takes up 20 units of "ConnectionCount"</span></span>
  - <span data-ttu-id="e2c8f-186">Secondaries use 5 units of "ConnectionCount"</span><span class="sxs-lookup"><span data-stu-id="e2c8f-186">Secondaries use 5 units of "ConnectionCount"</span></span>
  - <span data-ttu-id="e2c8f-187">You know that "ConnectionCount" is the most important metric in terms of managing the performance of this particular service</span><span class="sxs-lookup"><span data-stu-id="e2c8f-187">You know that "ConnectionCount" is the most important metric in terms of managing the performance of this particular service</span></span>
  - <span data-ttu-id="e2c8f-188">You still want Primary replicas balanced.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-188">You still want Primary replicas balanced.</span></span> <span data-ttu-id="e2c8f-189">Balancing primary replicas is generally a good idea no matter what.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-189">Balancing primary replicas is generally a good idea no matter what.</span></span> <span data-ttu-id="e2c8f-190">This helps prevent the loss of some node or fault domain from impacting a majority of primary replicas along with it.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-190">This helps prevent the loss of some node or fault domain from impacting a majority of primary replicas along with it.</span></span> 
  - <span data-ttu-id="e2c8f-191">Otherwise, the default metrics are fine</span><span class="sxs-lookup"><span data-stu-id="e2c8f-191">Otherwise, the default metrics are fine</span></span>

<span data-ttu-id="e2c8f-192">Here’s the code that you would write to create a service with that metric configuration:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-192">Here’s the code that you would write to create a service with that metric configuration:</span></span>

<span data-ttu-id="e2c8f-193">Code:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-193">Code:</span></span>

```csharp
StatefulServiceDescription serviceDescription = new StatefulServiceDescription();
StatefulServiceLoadMetricDescription connectionMetric = new StatefulServiceLoadMetricDescription();
connectionMetric.Name = "ConnectionCount";
connectionMetric.PrimaryDefaultLoad = 20;
connectionMetric.SecondaryDefaultLoad = 5;
connectionMetric.Weight = ServiceLoadMetricWeight.High;

StatefulServiceLoadMetricDescription primaryCountMetric = new StatefulServiceLoadMetricDescription();
primaryCountMetric.Name = "PrimaryCount";
primaryCountMetric.PrimaryDefaultLoad = 1;
primaryCountMetric.SecondaryDefaultLoad = 0;
primaryCountMetric.Weight = ServiceLoadMetricWeight.Medium;

StatefulServiceLoadMetricDescription replicaCountMetric = new StatefulServiceLoadMetricDescription();
replicaCountMetric.Name = "ReplicaCount";
replicaCountMetric.PrimaryDefaultLoad = 1;
replicaCountMetric.SecondaryDefaultLoad = 1;
replicaCountMetric.Weight = ServiceLoadMetricWeight.Low;

StatefulServiceLoadMetricDescription totalCountMetric = new StatefulServiceLoadMetricDescription();
totalCountMetric.Name = "Count";
totalCountMetric.PrimaryDefaultLoad = 1;
totalCountMetric.SecondaryDefaultLoad = 1;
totalCountMetric.Weight = ServiceLoadMetricWeight.Low;

serviceDescription.Metrics.Add(connectionMetric);
serviceDescription.Metrics.Add(primaryCountMetric);
serviceDescription.Metrics.Add(replicaCountMetric);
serviceDescription.Metrics.Add(totalCountMetric);

await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

<span data-ttu-id="e2c8f-194">Powershell:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-194">Powershell:</span></span>

```posh
New-ServiceFabricService -ApplicationName $applicationName -ServiceName $serviceName -ServiceTypeName $serviceTypeName –Stateful -MinReplicaSetSize 3 -TargetReplicaSetSize 3 -PartitionSchemeSingleton –Metric @("ConnectionCount,High,20,5”,"PrimaryCount,Medium,1,0”,"ReplicaCount,Low,1,1”,"Count,Low,1,1”)
```

> [!NOTE]
> <span data-ttu-id="e2c8f-195">The above examples and the rest of this document describe managing metrics on a per-named-service basis.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-195">The above examples and the rest of this document describe managing metrics on a per-named-service basis.</span></span> <span data-ttu-id="e2c8f-196">It is also possible to define metrics for your services at the service _type_ level.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-196">It is also possible to define metrics for your services at the service _type_ level.</span></span> <span data-ttu-id="e2c8f-197">This is accomplished by specifying them in your service manifests.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-197">This is accomplished by specifying them in your service manifests.</span></span> <span data-ttu-id="e2c8f-198">Defining type level metrics is not recommended for several reasons.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-198">Defining type level metrics is not recommended for several reasons.</span></span> <span data-ttu-id="e2c8f-199">The first reason is that metric names are frequently environment-specific.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-199">The first reason is that metric names are frequently environment-specific.</span></span> <span data-ttu-id="e2c8f-200">Unless there is a firm contract in place, you cannot be sure that the metric "Cores" in one environment isn't "MiliCores" or "CoReS" in others.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-200">Unless there is a firm contract in place, you cannot be sure that the metric "Cores" in one environment isn't "MiliCores" or "CoReS" in others.</span></span> <span data-ttu-id="e2c8f-201">If your metrics are defined in your manifest you need to create new manifests per environment.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-201">If your metrics are defined in your manifest you need to create new manifests per environment.</span></span> <span data-ttu-id="e2c8f-202">This usually leads to a proliferation of different manifests with only minor differences, which can lead to management difficulties.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-202">This usually leads to a proliferation of different manifests with only minor differences, which can lead to management difficulties.</span></span>  
>
> <span data-ttu-id="e2c8f-203">Metric loads are commonly assigned on a per-named-service-instance basis.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-203">Metric loads are commonly assigned on a per-named-service-instance basis.</span></span> <span data-ttu-id="e2c8f-204">For example, let's say you create one instance of the service for CustomerA who plans to use it only lightly.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-204">For example, let's say you create one instance of the service for CustomerA who plans to use it only lightly.</span></span> <span data-ttu-id="e2c8f-205">Let's also say you create another for CustomerB who has a larger workload.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-205">Let's also say you create another for CustomerB who has a larger workload.</span></span> <span data-ttu-id="e2c8f-206">In this case, you'd probably want to tweak the default loads for those services.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-206">In this case, you'd probably want to tweak the default loads for those services.</span></span> <span data-ttu-id="e2c8f-207">If you have metrics and loads defined via manifests and you want to support this scenario, it requires different application and service types for each customer.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-207">If you have metrics and loads defined via manifests and you want to support this scenario, it requires different application and service types for each customer.</span></span> <span data-ttu-id="e2c8f-208">The values defined at service creation time override those defined in the manifest, so you could use that to set the specific defaults.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-208">The values defined at service creation time override those defined in the manifest, so you could use that to set the specific defaults.</span></span> <span data-ttu-id="e2c8f-209">However, doing that causes the values declared in the manifests to not match those the service actually runs with.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-209">However, doing that causes the values declared in the manifests to not match those the service actually runs with.</span></span> <span data-ttu-id="e2c8f-210">This can lead to confusion.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-210">This can lead to confusion.</span></span> 
>

<span data-ttu-id="e2c8f-211">As a reminder: if you just want to use the default metrics, you don’t need to touch the metrics collection at all or do anything special when creating your service.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-211">As a reminder: if you just want to use the default metrics, you don’t need to touch the metrics collection at all or do anything special when creating your service.</span></span> <span data-ttu-id="e2c8f-212">The default metrics get used automatically when no others are defined.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-212">The default metrics get used automatically when no others are defined.</span></span> 

<span data-ttu-id="e2c8f-213">Now, let's go through each of these settings in more detail and talk about the behavior that it influences.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-213">Now, let's go through each of these settings in more detail and talk about the behavior that it influences.</span></span>

## <a name="load"></a><span data-ttu-id="e2c8f-214">Load</span><span class="sxs-lookup"><span data-stu-id="e2c8f-214">Load</span></span>
<span data-ttu-id="e2c8f-215">The whole point of defining metrics is to represent some load.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-215">The whole point of defining metrics is to represent some load.</span></span> <span data-ttu-id="e2c8f-216">*Load* is how much of a given metric is consumed by some service instance or replica on a given node.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-216">*Load* is how much of a given metric is consumed by some service instance or replica on a given node.</span></span> <span data-ttu-id="e2c8f-217">Load can be configured at almost any point.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-217">Load can be configured at almost any point.</span></span> <span data-ttu-id="e2c8f-218">For example:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-218">For example:</span></span>

  - <span data-ttu-id="e2c8f-219">Load can be defined when a service is created.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-219">Load can be defined when a service is created.</span></span> <span data-ttu-id="e2c8f-220">This is called _default load_.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-220">This is called _default load_.</span></span>
  - <span data-ttu-id="e2c8f-221">The metric information, including default loads, for a service can updated after the service is created.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-221">The metric information, including default loads, for a service can updated after the service is created.</span></span> <span data-ttu-id="e2c8f-222">This is called _updating a service_.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-222">This is called _updating a service_.</span></span> 
  - <span data-ttu-id="e2c8f-223">The loads for a given partition can be reset to the default values for that service.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-223">The loads for a given partition can be reset to the default values for that service.</span></span> <span data-ttu-id="e2c8f-224">This is called _resetting partition load_.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-224">This is called _resetting partition load_.</span></span>
  - <span data-ttu-id="e2c8f-225">Load can be reported on a per service object basis dynamically during runtime.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-225">Load can be reported on a per service object basis dynamically during runtime.</span></span> <span data-ttu-id="e2c8f-226">This is called _reporting load_.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-226">This is called _reporting load_.</span></span> 
  
<span data-ttu-id="e2c8f-227">All of these strategies can be used within the same service over its lifetime.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-227">All of these strategies can be used within the same service over its lifetime.</span></span> 

## <a name="default-load"></a><span data-ttu-id="e2c8f-228">Default load</span><span class="sxs-lookup"><span data-stu-id="e2c8f-228">Default load</span></span>
<span data-ttu-id="e2c8f-229">*Default load* is how much of the metric each service object (stateless instance or stateful replica) of this service consumes.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-229">*Default load* is how much of the metric each service object (stateless instance or stateful replica) of this service consumes.</span></span> <span data-ttu-id="e2c8f-230">The Cluster Resource Manager uses this number for the load of the service object until it receives other information, such as a dynamic load report.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-230">The Cluster Resource Manager uses this number for the load of the service object until it receives other information, such as a dynamic load report.</span></span> <span data-ttu-id="e2c8f-231">For simpler services, the default load is a static definition.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-231">For simpler services, the default load is a static definition.</span></span> <span data-ttu-id="e2c8f-232">The default load is never updated and is used for the lifetime of the service.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-232">The default load is never updated and is used for the lifetime of the service.</span></span> <span data-ttu-id="e2c8f-233">Default loads works great for simple capacity planning scenarios where certain amounts of resources are dedicated to different workloads and do not change.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-233">Default loads works great for simple capacity planning scenarios where certain amounts of resources are dedicated to different workloads and do not change.</span></span>

> [!NOTE]
> <span data-ttu-id="e2c8f-234">For more information on capacity management and defining capacities for the nodes in your cluster, please see [this article](service-fabric-cluster-resource-manager-cluster-description.md#capacity).</span><span class="sxs-lookup"><span data-stu-id="e2c8f-234">For more information on capacity management and defining capacities for the nodes in your cluster, please see [this article](service-fabric-cluster-resource-manager-cluster-description.md#capacity).</span></span>
> 

<span data-ttu-id="e2c8f-235">The Cluster Resource Manager allows stateful services to specify a different default load for their Primaries and Secondaries.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-235">The Cluster Resource Manager allows stateful services to specify a different default load for their Primaries and Secondaries.</span></span> <span data-ttu-id="e2c8f-236">Stateless services can only specify one value that applies to all instances.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-236">Stateless services can only specify one value that applies to all instances.</span></span> <span data-ttu-id="e2c8f-237">For stateful services, the default load for Primary and Secondary replicas are typically different since replicas do different kinds of work in each role.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-237">For stateful services, the default load for Primary and Secondary replicas are typically different since replicas do different kinds of work in each role.</span></span> <span data-ttu-id="e2c8f-238">For example, Primaries usually serve both reads and writes, and handle most of the computational burden, while secondaries do not.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-238">For example, Primaries usually serve both reads and writes, and handle most of the computational burden, while secondaries do not.</span></span> <span data-ttu-id="e2c8f-239">Usually the default load for a primary replica is higher than the default load for secondary replicas.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-239">Usually the default load for a primary replica is higher than the default load for secondary replicas.</span></span> <span data-ttu-id="e2c8f-240">The real numbers should depend on your own measurements.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-240">The real numbers should depend on your own measurements.</span></span>

## <a name="dynamic-load"></a><span data-ttu-id="e2c8f-241">Dynamic load</span><span class="sxs-lookup"><span data-stu-id="e2c8f-241">Dynamic load</span></span>
<span data-ttu-id="e2c8f-242">Let’s say that you’ve been running your service for a while.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-242">Let’s say that you’ve been running your service for a while.</span></span> <span data-ttu-id="e2c8f-243">With some monitoring, you’ve noticed that:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-243">With some monitoring, you’ve noticed that:</span></span>

1. <span data-ttu-id="e2c8f-244">Some partitions or instances of a given service consume more resources than others</span><span class="sxs-lookup"><span data-stu-id="e2c8f-244">Some partitions or instances of a given service consume more resources than others</span></span>
2. <span data-ttu-id="e2c8f-245">Some services have load that varies over time.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-245">Some services have load that varies over time.</span></span>

<span data-ttu-id="e2c8f-246">There's lots of things that could cause these types of load fluctuations.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-246">There's lots of things that could cause these types of load fluctuations.</span></span> <span data-ttu-id="e2c8f-247">For example, different services or partitions are associated with different customers with different requirements.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-247">For example, different services or partitions are associated with different customers with different requirements.</span></span> <span data-ttu-id="e2c8f-248">Load could also change because the amount of work the service does varies over the course of the day.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-248">Load could also change because the amount of work the service does varies over the course of the day.</span></span> <span data-ttu-id="e2c8f-249">Regardless of the reason, there’s usually no single number that you can use for default.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-249">Regardless of the reason, there’s usually no single number that you can use for default.</span></span> <span data-ttu-id="e2c8f-250">This is especially true if you want to get the most utilization out of the cluster.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-250">This is especially true if you want to get the most utilization out of the cluster.</span></span> <span data-ttu-id="e2c8f-251">Any value you pick for default load is wrong some of the time.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-251">Any value you pick for default load is wrong some of the time.</span></span> <span data-ttu-id="e2c8f-252">Incorrect default loads result in the Cluster Resource Manager either over or under allocating resources.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-252">Incorrect default loads result in the Cluster Resource Manager either over or under allocating resources.</span></span> <span data-ttu-id="e2c8f-253">As a result, you have nodes that are over or under utilized even though the Cluster Resource Manager thinks the cluster is balanced.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-253">As a result, you have nodes that are over or under utilized even though the Cluster Resource Manager thinks the cluster is balanced.</span></span> <span data-ttu-id="e2c8f-254">Default loads are still good since they provide some information for initial placement, but they're not a complete story for real workloads.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-254">Default loads are still good since they provide some information for initial placement, but they're not a complete story for real workloads.</span></span> <span data-ttu-id="e2c8f-255">To accurately capture changing resource requirements, the Cluster Resource Manager allows each service object to update its own load during runtime.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-255">To accurately capture changing resource requirements, the Cluster Resource Manager allows each service object to update its own load during runtime.</span></span> <span data-ttu-id="e2c8f-256">This is called dynamic load reporting.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-256">This is called dynamic load reporting.</span></span>

<span data-ttu-id="e2c8f-257">Dynamic load reports allow replicas or instances to adjust their allocation/reported load of metrics over their lifetime.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-257">Dynamic load reports allow replicas or instances to adjust their allocation/reported load of metrics over their lifetime.</span></span> <span data-ttu-id="e2c8f-258">A service replica or instance that was cold and not doing any work would usually report that it was using low amounts of a given metric.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-258">A service replica or instance that was cold and not doing any work would usually report that it was using low amounts of a given metric.</span></span> <span data-ttu-id="e2c8f-259">A busy replica or instance would report that they are using more.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-259">A busy replica or instance would report that they are using more.</span></span>

<span data-ttu-id="e2c8f-260">Reporting load per replica or instance allows the Cluster Resource Manager to reorganize the individual service objects in the cluster.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-260">Reporting load per replica or instance allows the Cluster Resource Manager to reorganize the individual service objects in the cluster.</span></span> <span data-ttu-id="e2c8f-261">Reorganizing the services helps ensure that they get the resources they require.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-261">Reorganizing the services helps ensure that they get the resources they require.</span></span> <span data-ttu-id="e2c8f-262">Busy services effectively get to "reclaim" resources from other replicas or instances that are currently cold or doing less work.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-262">Busy services effectively get to "reclaim" resources from other replicas or instances that are currently cold or doing less work.</span></span>

<span data-ttu-id="e2c8f-263">Within Reliable Services, the code to report load dynamically looks like this:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-263">Within Reliable Services, the code to report load dynamically looks like this:</span></span>

<span data-ttu-id="e2c8f-264">Code:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-264">Code:</span></span>

```csharp
this.Partition.ReportLoad(new List<LoadMetric> { new LoadMetric("CurrentConnectionCount", 1234), new LoadMetric("metric1", 42) });
```

<span data-ttu-id="e2c8f-265">A service can report on any of the metrics defined for it at creation time.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-265">A service can report on any of the metrics defined for it at creation time.</span></span> <span data-ttu-id="e2c8f-266">If a service reports load for a metric that it is not configured to use, Service Fabric ignores that report.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-266">If a service reports load for a metric that it is not configured to use, Service Fabric ignores that report.</span></span> <span data-ttu-id="e2c8f-267">If there are other metrics reported at the same time that are valid, those reports are accepted.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-267">If there are other metrics reported at the same time that are valid, those reports are accepted.</span></span> <span data-ttu-id="e2c8f-268">Service code can measure and report all the metrics it knows how to, and operators can specify the metric configuration to use without having to change the service code.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-268">Service code can measure and report all the metrics it knows how to, and operators can specify the metric configuration to use without having to change the service code.</span></span> 

### <a name="updating-a-services-metric-configuration"></a><span data-ttu-id="e2c8f-269">Updating a service's metric configuration</span><span class="sxs-lookup"><span data-stu-id="e2c8f-269">Updating a service's metric configuration</span></span>
<span data-ttu-id="e2c8f-270">The list of metrics associated with the service, and the properties of those metrics can be updated dynamically while the service is live.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-270">The list of metrics associated with the service, and the properties of those metrics can be updated dynamically while the service is live.</span></span> <span data-ttu-id="e2c8f-271">This allows for experimentation and flexibility.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-271">This allows for experimentation and flexibility.</span></span> <span data-ttu-id="e2c8f-272">Some examples of when this is useful are:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-272">Some examples of when this is useful are:</span></span>

  - <span data-ttu-id="e2c8f-273">disabling a metric with a buggy report for a particular service</span><span class="sxs-lookup"><span data-stu-id="e2c8f-273">disabling a metric with a buggy report for a particular service</span></span>
  - <span data-ttu-id="e2c8f-274">reconfiguring the weights of metrics based on desired behavior</span><span class="sxs-lookup"><span data-stu-id="e2c8f-274">reconfiguring the weights of metrics based on desired behavior</span></span>
  - <span data-ttu-id="e2c8f-275">enabling a new metric only after the code has already been deployed and validated via other mechanisms</span><span class="sxs-lookup"><span data-stu-id="e2c8f-275">enabling a new metric only after the code has already been deployed and validated via other mechanisms</span></span>
  - <span data-ttu-id="e2c8f-276">changing the default load for a service based on observed behavior and consumption</span><span class="sxs-lookup"><span data-stu-id="e2c8f-276">changing the default load for a service based on observed behavior and consumption</span></span>

<span data-ttu-id="e2c8f-277">The main APIs for changing metric configuration are `FabricClient.ServiceManagementClient.UpdateServiceAsync` in C# and `Update-ServiceFabricService` in PowerShell.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-277">The main APIs for changing metric configuration are `FabricClient.ServiceManagementClient.UpdateServiceAsync` in C# and `Update-ServiceFabricService` in PowerShell.</span></span> <span data-ttu-id="e2c8f-278">Whatever information you specify with these APIs replaces the existing metric information for the service immediately.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-278">Whatever information you specify with these APIs replaces the existing metric information for the service immediately.</span></span> 

## <a name="mixing-default-load-values-and-dynamic-load-reports"></a><span data-ttu-id="e2c8f-279">Mixing default load values and dynamic load reports</span><span class="sxs-lookup"><span data-stu-id="e2c8f-279">Mixing default load values and dynamic load reports</span></span>
<span data-ttu-id="e2c8f-280">Default load and dynamic loads can be used for the same service.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-280">Default load and dynamic loads can be used for the same service.</span></span> <span data-ttu-id="e2c8f-281">When a service utilizes both default load and dynamic load reports, default load serves as an estimate until dynamic reports show up.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-281">When a service utilizes both default load and dynamic load reports, default load serves as an estimate until dynamic reports show up.</span></span> <span data-ttu-id="e2c8f-282">Default load is good because it gives the Cluster Resource Manager something to work with.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-282">Default load is good because it gives the Cluster Resource Manager something to work with.</span></span> <span data-ttu-id="e2c8f-283">The default load allows the Cluster Resource Manager to place the service objects in good locations when they are created.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-283">The default load allows the Cluster Resource Manager to place the service objects in good locations when they are created.</span></span> <span data-ttu-id="e2c8f-284">If no default load information is provided, placement of services is effectively random.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-284">If no default load information is provided, placement of services is effectively random.</span></span> <span data-ttu-id="e2c8f-285">When load reports arrive later the initial random placement is often wrong and the Cluster Resource Manager has to move services.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-285">When load reports arrive later the initial random placement is often wrong and the Cluster Resource Manager has to move services.</span></span>

<span data-ttu-id="e2c8f-286">Let’s take our previous example and see what happens when we add some custom metrics and dynamic load reporting.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-286">Let’s take our previous example and see what happens when we add some custom metrics and dynamic load reporting.</span></span> <span data-ttu-id="e2c8f-287">In this example, we use “MemoryInMb” as an example metric.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-287">In this example, we use “MemoryInMb” as an example metric.</span></span>

> [!NOTE]
> <span data-ttu-id="e2c8f-288">Memory is one of the system metrics that Service Fabric can [resource govern](service-fabric-resource-governance.md), and reporting it yourself is typically difficult.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-288">Memory is one of the system metrics that Service Fabric can [resource govern](service-fabric-resource-governance.md), and reporting it yourself is typically difficult.</span></span> <span data-ttu-id="e2c8f-289">We don't actually expect you to report on Memory consumption; Memory is used here as an aid to learning about the capabilities of the Cluster Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-289">We don't actually expect you to report on Memory consumption; Memory is used here as an aid to learning about the capabilities of the Cluster Resource Manager.</span></span>
>

<span data-ttu-id="e2c8f-290">Let’s presume that we initially created the stateful service with the following command:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-290">Let’s presume that we initially created the stateful service with the following command:</span></span>

<span data-ttu-id="e2c8f-291">Powershell:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-291">Powershell:</span></span>

```posh
New-ServiceFabricService -ApplicationName $applicationName -ServiceName $serviceName -ServiceTypeName $serviceTypeName –Stateful -MinReplicaSetSize 3 -TargetReplicaSetSize 3 -PartitionSchemeSingleton –Metric @("MemoryInMb,High,21,11”,"PrimaryCount,Medium,1,0”,"ReplicaCount,Low,1,1”,"Count,Low,1,1”)
```

<span data-ttu-id="e2c8f-292">As a reminder, this syntax is ("MetricName, MetricWeight, PrimaryDefaultLoad, SecondaryDefaultLoad").</span><span class="sxs-lookup"><span data-stu-id="e2c8f-292">As a reminder, this syntax is ("MetricName, MetricWeight, PrimaryDefaultLoad, SecondaryDefaultLoad").</span></span>

<span data-ttu-id="e2c8f-293">Let's see what one possible cluster layout could look like:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-293">Let's see what one possible cluster layout could look like:</span></span>

<span data-ttu-id="e2c8f-294"><center>
![Cluster Balanced with both Default and Custom metrics][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="e2c8f-294"><center>
![Cluster Balanced with both Default and Custom metrics][Image2]
</center></span></span>

<span data-ttu-id="e2c8f-295">Some things that are worth noting:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-295">Some things that are worth noting:</span></span>

* <span data-ttu-id="e2c8f-296">Secondary replicas within a partition can each have their own load</span><span class="sxs-lookup"><span data-stu-id="e2c8f-296">Secondary replicas within a partition can each have their own load</span></span>
* <span data-ttu-id="e2c8f-297">Overall the metrics look balanced.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-297">Overall the metrics look balanced.</span></span> <span data-ttu-id="e2c8f-298">For Memory, the ratio between the maximum and minimum load is 1.75 (the node with the most load is N3, the least is N2, and 28/16 = 1.75).</span><span class="sxs-lookup"><span data-stu-id="e2c8f-298">For Memory, the ratio between the maximum and minimum load is 1.75 (the node with the most load is N3, the least is N2, and 28/16 = 1.75).</span></span>

<span data-ttu-id="e2c8f-299">There are some things that we still need to explain:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-299">There are some things that we still need to explain:</span></span>

* <span data-ttu-id="e2c8f-300">What determined whether a ratio of 1.75 was reasonable or not?</span><span class="sxs-lookup"><span data-stu-id="e2c8f-300">What determined whether a ratio of 1.75 was reasonable or not?</span></span> <span data-ttu-id="e2c8f-301">How does the Cluster Resource Manager know if that’s good enough or if there is more work to do?</span><span class="sxs-lookup"><span data-stu-id="e2c8f-301">How does the Cluster Resource Manager know if that’s good enough or if there is more work to do?</span></span>
* <span data-ttu-id="e2c8f-302">When does balancing happen?</span><span class="sxs-lookup"><span data-stu-id="e2c8f-302">When does balancing happen?</span></span>
* <span data-ttu-id="e2c8f-303">What does it mean that Memory was weighted “High”?</span><span class="sxs-lookup"><span data-stu-id="e2c8f-303">What does it mean that Memory was weighted “High”?</span></span>

## <a name="metric-weights"></a><span data-ttu-id="e2c8f-304">Metric weights</span><span class="sxs-lookup"><span data-stu-id="e2c8f-304">Metric weights</span></span>
<span data-ttu-id="e2c8f-305">Tracking the same metrics across different services is important.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-305">Tracking the same metrics across different services is important.</span></span> <span data-ttu-id="e2c8f-306">That global view is what allows the Cluster Resource Manager to track consumption in the cluster, balance consumption across nodes, and ensure that nodes don’t go over capacity.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-306">That global view is what allows the Cluster Resource Manager to track consumption in the cluster, balance consumption across nodes, and ensure that nodes don’t go over capacity.</span></span> <span data-ttu-id="e2c8f-307">However, services may have different views as to the importance of the same metric.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-307">However, services may have different views as to the importance of the same metric.</span></span> <span data-ttu-id="e2c8f-308">Also, in a cluster with many metrics and lots of services, perfectly balanced solutions may not exist for all metrics.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-308">Also, in a cluster with many metrics and lots of services, perfectly balanced solutions may not exist for all metrics.</span></span> <span data-ttu-id="e2c8f-309">How should the Cluster Resource Manager handle these situations?</span><span class="sxs-lookup"><span data-stu-id="e2c8f-309">How should the Cluster Resource Manager handle these situations?</span></span>

<span data-ttu-id="e2c8f-310">Metric weights allow the Cluster Resource Manager to decide how to balance the cluster when there’s no perfect answer.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-310">Metric weights allow the Cluster Resource Manager to decide how to balance the cluster when there’s no perfect answer.</span></span> <span data-ttu-id="e2c8f-311">Metric weights also allow the Cluster Resource Manager to balance specific services differently.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-311">Metric weights also allow the Cluster Resource Manager to balance specific services differently.</span></span> <span data-ttu-id="e2c8f-312">Metrics can have four different weight levels: Zero, Low, Medium, and High.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-312">Metrics can have four different weight levels: Zero, Low, Medium, and High.</span></span> <span data-ttu-id="e2c8f-313">A metric with a weight of Zero contributes nothing when considering whether things are balanced or not.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-313">A metric with a weight of Zero contributes nothing when considering whether things are balanced or not.</span></span> <span data-ttu-id="e2c8f-314">However, its load does still contribute to capacity management.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-314">However, its load does still contribute to capacity management.</span></span> <span data-ttu-id="e2c8f-315">Metrics with Zero weight are still useful and are frequently used as a part of service behavior and performance monitoring.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-315">Metrics with Zero weight are still useful and are frequently used as a part of service behavior and performance monitoring.</span></span> <span data-ttu-id="e2c8f-316">[This article](service-fabric-diagnostics-event-generation-infra.md) provides more information on the use of metrics for monitoring and diagnostics of your services.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-316">[This article](service-fabric-diagnostics-event-generation-infra.md) provides more information on the use of metrics for monitoring and diagnostics of your services.</span></span> 

<span data-ttu-id="e2c8f-317">The real impact of different metric weights in the cluster is that the Cluster Resource Manager generates different solutions.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-317">The real impact of different metric weights in the cluster is that the Cluster Resource Manager generates different solutions.</span></span> <span data-ttu-id="e2c8f-318">Metric weights tell the Cluster Resource Manager that certain metrics are more important than others.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-318">Metric weights tell the Cluster Resource Manager that certain metrics are more important than others.</span></span> <span data-ttu-id="e2c8f-319">When there's no perfect solution the Cluster Resource Manager can prefer solutions which balance the higher weighted metrics better.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-319">When there's no perfect solution the Cluster Resource Manager can prefer solutions which balance the higher weighted metrics better.</span></span> <span data-ttu-id="e2c8f-320">If a service thinks a particular metric is unimportant, it may find their use of that metric imbalanced.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-320">If a service thinks a particular metric is unimportant, it may find their use of that metric imbalanced.</span></span> <span data-ttu-id="e2c8f-321">This allows another service to get an even distribution of some metric that is important to it.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-321">This allows another service to get an even distribution of some metric that is important to it.</span></span>

<span data-ttu-id="e2c8f-322">Let’s look at an example of some load reports and how different metric weights results in different allocations in the cluster.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-322">Let’s look at an example of some load reports and how different metric weights results in different allocations in the cluster.</span></span> <span data-ttu-id="e2c8f-323">In this example, we see that switching the relative weight of the metrics causes the Cluster Resource Manager to create different arrangements of services.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-323">In this example, we see that switching the relative weight of the metrics causes the Cluster Resource Manager to create different arrangements of services.</span></span>

<span data-ttu-id="e2c8f-324"><center>
![Metric Weight Example and Its Impact on Balancing Solutions][Image3]
</center></span><span class="sxs-lookup"><span data-stu-id="e2c8f-324"><center>
![Metric Weight Example and Its Impact on Balancing Solutions][Image3]
</center></span></span>

<span data-ttu-id="e2c8f-325">In this example, there are four different services, all reporting different values for two different metrics, MetricA and MetricB.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-325">In this example, there are four different services, all reporting different values for two different metrics, MetricA and MetricB.</span></span> <span data-ttu-id="e2c8f-326">In one case, all the services define MetricA is the most important one (Weight = High) and MetricB as unimportant (Weight = Low).</span><span class="sxs-lookup"><span data-stu-id="e2c8f-326">In one case, all the services define MetricA is the most important one (Weight = High) and MetricB as unimportant (Weight = Low).</span></span> <span data-ttu-id="e2c8f-327">As a result, we see that the Cluster Resource Manager places the services so that MetricA is better balanced than MetricB.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-327">As a result, we see that the Cluster Resource Manager places the services so that MetricA is better balanced than MetricB.</span></span> <span data-ttu-id="e2c8f-328">"Better balanced" means that MetricA has a lower has a lower standard deviation than MetricB.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-328">"Better balanced" means that MetricA has a lower has a lower standard deviation than MetricB.</span></span> <span data-ttu-id="e2c8f-329">In the second case, we reverse the metric weights.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-329">In the second case, we reverse the metric weights.</span></span> <span data-ttu-id="e2c8f-330">As a result, the Cluster Resource Manager swaps services A and B to come up with an allocation where MetricB is better balanced than MetricA.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-330">As a result, the Cluster Resource Manager swaps services A and B to come up with an allocation where MetricB is better balanced than MetricA.</span></span>

> [!NOTE]
> <span data-ttu-id="e2c8f-331">Metric weights determine how the Cluster Resource Manager should balance, but not when balancing should happen.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-331">Metric weights determine how the Cluster Resource Manager should balance, but not when balancing should happen.</span></span> <span data-ttu-id="e2c8f-332">For more information on balancing, check out [this article](service-fabric-cluster-resource-manager-balancing.md)</span><span class="sxs-lookup"><span data-stu-id="e2c8f-332">For more information on balancing, check out [this article](service-fabric-cluster-resource-manager-balancing.md)</span></span>
>

### <a name="global-metric-weights"></a><span data-ttu-id="e2c8f-333">Global metric weights</span><span class="sxs-lookup"><span data-stu-id="e2c8f-333">Global metric weights</span></span>
<span data-ttu-id="e2c8f-334">Let's say ServiceA defines MetricA as weight High, and ServiceB sets the weight for MetricA to Low or Zero.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-334">Let's say ServiceA defines MetricA as weight High, and ServiceB sets the weight for MetricA to Low or Zero.</span></span> <span data-ttu-id="e2c8f-335">What’s the actual weight that ends up getting used?</span><span class="sxs-lookup"><span data-stu-id="e2c8f-335">What’s the actual weight that ends up getting used?</span></span>

<span data-ttu-id="e2c8f-336">There are multiple weights that are tracked for every metric.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-336">There are multiple weights that are tracked for every metric.</span></span> <span data-ttu-id="e2c8f-337">The first weight is the one defined for the metric when the service is created.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-337">The first weight is the one defined for the metric when the service is created.</span></span> <span data-ttu-id="e2c8f-338">The other weight is a global weight, which is computed automatically.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-338">The other weight is a global weight, which is computed automatically.</span></span> <span data-ttu-id="e2c8f-339">The Cluster Resource Manager uses both these weights when scoring solutions.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-339">The Cluster Resource Manager uses both these weights when scoring solutions.</span></span> <span data-ttu-id="e2c8f-340">Taking both weights into account is important.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-340">Taking both weights into account is important.</span></span> <span data-ttu-id="e2c8f-341">This allows the Cluster Resource Manager to balance each service according to its own priorities, and also ensure that the cluster as a whole is allocated correctly.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-341">This allows the Cluster Resource Manager to balance each service according to its own priorities, and also ensure that the cluster as a whole is allocated correctly.</span></span>

<span data-ttu-id="e2c8f-342">What would happen if the Cluster Resource Manager didn’t care about both global and local balance?</span><span class="sxs-lookup"><span data-stu-id="e2c8f-342">What would happen if the Cluster Resource Manager didn’t care about both global and local balance?</span></span> <span data-ttu-id="e2c8f-343">Well, it’s easy to construct solutions that are globally balanced, but which result in poor resource balance for individual services.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-343">Well, it’s easy to construct solutions that are globally balanced, but which result in poor resource balance for individual services.</span></span> <span data-ttu-id="e2c8f-344">In the following example, let’s look at a service configured with just the default metrics, and see what happens when only global balance is considered:</span><span class="sxs-lookup"><span data-stu-id="e2c8f-344">In the following example, let’s look at a service configured with just the default metrics, and see what happens when only global balance is considered:</span></span>

<span data-ttu-id="e2c8f-345"><center>
![The Impact of a Global Only Solution][Image4]
</center></span><span class="sxs-lookup"><span data-stu-id="e2c8f-345"><center>
![The Impact of a Global Only Solution][Image4]
</center></span></span>

<span data-ttu-id="e2c8f-346">In the top example based only on global balance, the cluster as a whole is indeed balanced.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-346">In the top example based only on global balance, the cluster as a whole is indeed balanced.</span></span> <span data-ttu-id="e2c8f-347">All nodes have the same count of primaries and the same number total replicas.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-347">All nodes have the same count of primaries and the same number total replicas.</span></span> <span data-ttu-id="e2c8f-348">However, if you look at the actual impact of this allocation it’s not so good: the loss of any node impacts a particular workload disproportionately, because it takes out all of its primaries.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-348">However, if you look at the actual impact of this allocation it’s not so good: the loss of any node impacts a particular workload disproportionately, because it takes out all of its primaries.</span></span> <span data-ttu-id="e2c8f-349">For example, if the first node fails the three primaries for the three different partitions of the Circle service would all be lost.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-349">For example, if the first node fails the three primaries for the three different partitions of the Circle service would all be lost.</span></span> <span data-ttu-id="e2c8f-350">Conversely, the Triangle and Hexagon services have their partitions lose a replica.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-350">Conversely, the Triangle and Hexagon services have their partitions lose a replica.</span></span> <span data-ttu-id="e2c8f-351">This causes no disruption, other than having to recover the down replica.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-351">This causes no disruption, other than having to recover the down replica.</span></span>

<span data-ttu-id="e2c8f-352">In the bottom example, the Cluster Resource Manager has distributed the replicas based on both the global and per-service balance.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-352">In the bottom example, the Cluster Resource Manager has distributed the replicas based on both the global and per-service balance.</span></span> <span data-ttu-id="e2c8f-353">When calculating the score of the solution it gives most of the weight to the global solution, and a (configurable) portion to individual services.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-353">When calculating the score of the solution it gives most of the weight to the global solution, and a (configurable) portion to individual services.</span></span> <span data-ttu-id="e2c8f-354">Global balance for a metric is calculated based on the average of the metric weights from each service.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-354">Global balance for a metric is calculated based on the average of the metric weights from each service.</span></span> <span data-ttu-id="e2c8f-355">Each service is balanced according to its own defined metric weights.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-355">Each service is balanced according to its own defined metric weights.</span></span> <span data-ttu-id="e2c8f-356">This ensures that the services are balanced within themselves according to their own needs.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-356">This ensures that the services are balanced within themselves according to their own needs.</span></span> <span data-ttu-id="e2c8f-357">As a result, if the same first node fails the failure is distributed across all partitions of all services.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-357">As a result, if the same first node fails the failure is distributed across all partitions of all services.</span></span> <span data-ttu-id="e2c8f-358">The impact to each is the same.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-358">The impact to each is the same.</span></span>

## <a name="next-steps"></a><span data-ttu-id="e2c8f-359">Next steps</span><span class="sxs-lookup"><span data-stu-id="e2c8f-359">Next steps</span></span>
- <span data-ttu-id="e2c8f-360">For more information on configuring services, [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)(service-fabric-cluster-resource-manager-configure-services.md)</span><span class="sxs-lookup"><span data-stu-id="e2c8f-360">For more information on configuring services, [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)(service-fabric-cluster-resource-manager-configure-services.md)</span></span>
- <span data-ttu-id="e2c8f-361">Defining Defragmentation Metrics is one way to consolidate load on nodes instead of spreading it out. To learn how to configure defragmentation, refer to [this article](service-fabric-cluster-resource-manager-defragmentation-metrics.md)</span><span class="sxs-lookup"><span data-stu-id="e2c8f-361">Defining Defragmentation Metrics is one way to consolidate load on nodes instead of spreading it out. To learn how to configure defragmentation, refer to [this article](service-fabric-cluster-resource-manager-defragmentation-metrics.md)</span></span>
- <span data-ttu-id="e2c8f-362">To find out about how the Cluster Resource Manager manages and balances load in the cluster, check out the article on [balancing load](service-fabric-cluster-resource-manager-balancing.md)</span><span class="sxs-lookup"><span data-stu-id="e2c8f-362">To find out about how the Cluster Resource Manager manages and balances load in the cluster, check out the article on [balancing load](service-fabric-cluster-resource-manager-balancing.md)</span></span>
- <span data-ttu-id="e2c8f-363">Start from the beginning and [get an Introduction to the Service Fabric Cluster Resource Manager](service-fabric-cluster-resource-manager-introduction.md)</span><span class="sxs-lookup"><span data-stu-id="e2c8f-363">Start from the beginning and [get an Introduction to the Service Fabric Cluster Resource Manager](service-fabric-cluster-resource-manager-introduction.md)</span></span>
- <span data-ttu-id="e2c8f-364">Movement Cost is one way of signaling to the Cluster Resource Manager that certain services are more expensive to move than others.</span><span class="sxs-lookup"><span data-stu-id="e2c8f-364">Movement Cost is one way of signaling to the Cluster Resource Manager that certain services are more expensive to move than others.</span></span> <span data-ttu-id="e2c8f-365">To learn more about movement cost, refer to [this article](service-fabric-cluster-resource-manager-movement-cost.md)</span><span class="sxs-lookup"><span data-stu-id="e2c8f-365">To learn more about movement cost, refer to [this article](service-fabric-cluster-resource-manager-movement-cost.md)</span></span>

[Image1]:./media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-cluster-layout-with-default-metrics.png
[Image2]:./media/service-fabric-cluster-resource-manager-metrics/Service-Fabric-Resource-Manager-Dynamic-Load-Reports.png
[Image3]:./media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-metric-weights-impact.png
[Image4]:./media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-global-vs-local-balancing.png
