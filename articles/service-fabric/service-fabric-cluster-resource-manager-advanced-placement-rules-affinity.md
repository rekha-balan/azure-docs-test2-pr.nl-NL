---
title: Service Fabric Cluster Resource Manager - Affinity | Microsoft Docs
description: Overview of configuring affinity for Service Fabric Services
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: ''
ms.assetid: 678073e1-d08d-46c4-a811-826e70aba6c4
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 01/05/2017
ms.author: masnider
ms.openlocfilehash: bd7444947924be0b66e4838cfc4917822ab770e2
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44564694"
---
# <a name="configuring-and-using-service-affinity-in-service-fabric"></a><span data-ttu-id="6dbaf-103">Configuring and using service affinity in Service Fabric</span><span class="sxs-lookup"><span data-stu-id="6dbaf-103">Configuring and using service affinity in Service Fabric</span></span>
<span data-ttu-id="6dbaf-104">Affinity is a control that is provided mainly to help ease the transition of larger monolithic applications into the cloud and microservices world.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-104">Affinity is a control that is provided mainly to help ease the transition of larger monolithic applications into the cloud and microservices world.</span></span> <span data-ttu-id="6dbaf-105">That said it can also be used in certain cases as a legitimate optimization for improving the performance of services, although doing so can have side effects.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-105">That said it can also be used in certain cases as a legitimate optimization for improving the performance of services, although doing so can have side effects.</span></span>

<span data-ttu-id="6dbaf-106">Let’s say you’re bringing a larger app, or one that just wasn’t designed with microservices in mind, to Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-106">Let’s say you’re bringing a larger app, or one that just wasn’t designed with microservices in mind, to Service Fabric.</span></span> <span data-ttu-id="6dbaf-107">This type of transition is common.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-107">This type of transition is common.</span></span> <span data-ttu-id="6dbaf-108">You start by lifting the entire app into the environment, packaging it, and making sure it is running smoothly.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-108">You start by lifting the entire app into the environment, packaging it, and making sure it is running smoothly.</span></span> <span data-ttu-id="6dbaf-109">Then you start breaking it down into different smaller services that all talk to each other.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-109">Then you start breaking it down into different smaller services that all talk to each other.</span></span>

<span data-ttu-id="6dbaf-110">Then there’s an “Oops...”.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-110">Then there’s an “Oops...”.</span></span> <span data-ttu-id="6dbaf-111">The “Oops” usually falls into one of these categories:</span><span class="sxs-lookup"><span data-stu-id="6dbaf-111">The “Oops” usually falls into one of these categories:</span></span>

1. <span data-ttu-id="6dbaf-112">Some component X in the monolithic app had an undocumented dependency on component Y, and you just turned those components into separate services.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-112">Some component X in the monolithic app had an undocumented dependency on component Y, and you just turned those components into separate services.</span></span> <span data-ttu-id="6dbaf-113">Since these services are now running on different nodes in the cluster, they're broken.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-113">Since these services are now running on different nodes in the cluster, they're broken.</span></span>
2. <span data-ttu-id="6dbaf-114">These things communicate via (local named pipes | shared memory | files on disk) but they really need to be able to write to a shared resource for performance reasons right now.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-114">These things communicate via (local named pipes | shared memory | files on disk) but they really need to be able to write to a shared resource for performance reasons right now.</span></span> <span data-ttu-id="6dbaf-115">That hard dependency gets removed later.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-115">That hard dependency gets removed later.</span></span>
3. <span data-ttu-id="6dbaf-116">Everything is fine, but it turns out that these two components are actually chatty/performance sensitive.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-116">Everything is fine, but it turns out that these two components are actually chatty/performance sensitive.</span></span> <span data-ttu-id="6dbaf-117">When they moved them into separate services overall application performance tanked or latency increased.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-117">When they moved them into separate services overall application performance tanked or latency increased.</span></span> <span data-ttu-id="6dbaf-118">As a result, the overall application is not meeting expectations.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-118">As a result, the overall application is not meeting expectations.</span></span>

<span data-ttu-id="6dbaf-119">In these cases we don’t want to lose our refactoring work, and don’t want to go back to the monolith.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-119">In these cases we don’t want to lose our refactoring work, and don’t want to go back to the monolith.</span></span> <span data-ttu-id="6dbaf-120">However, until we can redesign the components to work naturally as services (or until we can solve the performance expectations some other way) we're going to need some sense of locality.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-120">However, until we can redesign the components to work naturally as services (or until we can solve the performance expectations some other way) we're going to need some sense of locality.</span></span>

<span data-ttu-id="6dbaf-121">What to do?</span><span class="sxs-lookup"><span data-stu-id="6dbaf-121">What to do?</span></span> <span data-ttu-id="6dbaf-122">Well, you could try turning on affinity.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-122">Well, you could try turning on affinity.</span></span>

## <a name="how-to-configure-affinity"></a><span data-ttu-id="6dbaf-123">How to configure affinity</span><span class="sxs-lookup"><span data-stu-id="6dbaf-123">How to configure affinity</span></span>
<span data-ttu-id="6dbaf-124">To set up affinity, you define an affinity relationship between two different services.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-124">To set up affinity, you define an affinity relationship between two different services.</span></span> <span data-ttu-id="6dbaf-125">You can think of affinity as “pointing” one service at another and saying “This service can only run where that service is running.”</span><span class="sxs-lookup"><span data-stu-id="6dbaf-125">You can think of affinity as “pointing” one service at another and saying “This service can only run where that service is running.”</span></span> <span data-ttu-id="6dbaf-126">Sometimes we refer to affinity as a parent/child relationship (where you point the child at the parent).</span><span class="sxs-lookup"><span data-stu-id="6dbaf-126">Sometimes we refer to affinity as a parent/child relationship (where you point the child at the parent).</span></span> <span data-ttu-id="6dbaf-127">Affinity ensures that the replicas or instances of one service are placed on the same nodes as the replicas or instances of another.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-127">Affinity ensures that the replicas or instances of one service are placed on the same nodes as the replicas or instances of another.</span></span>

``` csharp
ServiceCorrelationDescription affinityDescription = new ServiceCorrelationDescription();
affinityDescription.Scheme = ServiceCorrelationScheme.Affinity;
affinityDescription.ServiceName = new Uri("fabric:/otherApplication/parentService");
serviceDescription.Correlations.Add(affinityDescription);
await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

## <a name="different-affinity-options"></a><span data-ttu-id="6dbaf-128">Different affinity options</span><span class="sxs-lookup"><span data-stu-id="6dbaf-128">Different affinity options</span></span>
<span data-ttu-id="6dbaf-129">Affinity is represented via one of several correlation schemes, and has two different modes.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-129">Affinity is represented via one of several correlation schemes, and has two different modes.</span></span> <span data-ttu-id="6dbaf-130">The most common mode of affinity is what we call NonAlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-130">The most common mode of affinity is what we call NonAlignedAffinity.</span></span> <span data-ttu-id="6dbaf-131">In NonAlignedAffinity, the replicas or instances of the different services are placed on the same nodes.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-131">In NonAlignedAffinity, the replicas or instances of the different services are placed on the same nodes.</span></span> <span data-ttu-id="6dbaf-132">The other mode is AlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-132">The other mode is AlignedAffinity.</span></span> <span data-ttu-id="6dbaf-133">Aligned Affinity is useful only with stateful services.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-133">Aligned Affinity is useful only with stateful services.</span></span> <span data-ttu-id="6dbaf-134">Configuring two stateful services to have aligned affinity ensures that the primaries of those services are placed on the same nodes as each other.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-134">Configuring two stateful services to have aligned affinity ensures that the primaries of those services are placed on the same nodes as each other.</span></span> <span data-ttu-id="6dbaf-135">It also causes each pair of secondaries for those services to be placed on the same nodes.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-135">It also causes each pair of secondaries for those services to be placed on the same nodes.</span></span> <span data-ttu-id="6dbaf-136">It is also possible (though less common) to configure NonAlignedAffinity for stateful services.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-136">It is also possible (though less common) to configure NonAlignedAffinity for stateful services.</span></span> <span data-ttu-id="6dbaf-137">For NonAlignedAffinity, the different replicas of the two stateful services would be collocated on the same nodes, but no attempt would be made to align their primaries or secondaries.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-137">For NonAlignedAffinity, the different replicas of the two stateful services would be collocated on the same nodes, but no attempt would be made to align their primaries or secondaries.</span></span>

<span data-ttu-id="6dbaf-138"><center>
![Affinity Modes and Their Effects][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="6dbaf-138"><center>
![Affinity Modes and Their Effects][Image1]
</center></span></span>

### <a name="best-effort-desired-state"></a><span data-ttu-id="6dbaf-139">Best effort desired state</span><span class="sxs-lookup"><span data-stu-id="6dbaf-139">Best effort desired state</span></span>
<span data-ttu-id="6dbaf-140">There are a few differences between affinity and monolithic architectures.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-140">There are a few differences between affinity and monolithic architectures.</span></span> <span data-ttu-id="6dbaf-141">Many of them are because an affinity relationship is best effort.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-141">Many of them are because an affinity relationship is best effort.</span></span> <span data-ttu-id="6dbaf-142">The services in an affinity relationship are fundamentally different entities that can fail and be moved independently.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-142">The services in an affinity relationship are fundamentally different entities that can fail and be moved independently.</span></span> <span data-ttu-id="6dbaf-143">There are also causes for why an affinity relationship could break.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-143">There are also causes for why an affinity relationship could break.</span></span> <span data-ttu-id="6dbaf-144">For example, capacity limitations where only some of the service objects in the affinity relationship can fit on a given node.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-144">For example, capacity limitations where only some of the service objects in the affinity relationship can fit on a given node.</span></span> <span data-ttu-id="6dbaf-145">In these cases even though there's an affinity relationship in place, it can't be enforced due to the other constraints.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-145">In these cases even though there's an affinity relationship in place, it can't be enforced due to the other constraints.</span></span> <span data-ttu-id="6dbaf-146">if it is possible to do so, the violation is automatically corrected later.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-146">if it is possible to do so, the violation is automatically corrected later.</span></span>

### <a name="chains-vs-stars"></a><span data-ttu-id="6dbaf-147">Chains vs. stars</span><span class="sxs-lookup"><span data-stu-id="6dbaf-147">Chains vs. stars</span></span>
<span data-ttu-id="6dbaf-148">Today the Cluster Resource Manager isn't able to model chains of affinity relationships.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-148">Today the Cluster Resource Manager isn't able to model chains of affinity relationships.</span></span> <span data-ttu-id="6dbaf-149">What this means is that a service that is a child in one affinity relationship can’t be a parent in another affinity relationship.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-149">What this means is that a service that is a child in one affinity relationship can’t be a parent in another affinity relationship.</span></span> <span data-ttu-id="6dbaf-150">If you want to model this type of relationship, you effectively have to model it as a star, rather than a chain.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-150">If you want to model this type of relationship, you effectively have to model it as a star, rather than a chain.</span></span> <span data-ttu-id="6dbaf-151">To move from a chain to a star, the bottommost child would be parented to the first child’s parent instead.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-151">To move from a chain to a star, the bottommost child would be parented to the first child’s parent instead.</span></span> <span data-ttu-id="6dbaf-152">Depending on the arrangement of your services, you may have to do this multiple times.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-152">Depending on the arrangement of your services, you may have to do this multiple times.</span></span> <span data-ttu-id="6dbaf-153">If there's no natural parent service, you may have to create one that serves as a placeholder.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-153">If there's no natural parent service, you may have to create one that serves as a placeholder.</span></span> <span data-ttu-id="6dbaf-154">Depending on your requirements, you may also want to look into [Application Groups](service-fabric-cluster-resource-manager-application-groups.md).</span><span class="sxs-lookup"><span data-stu-id="6dbaf-154">Depending on your requirements, you may also want to look into [Application Groups](service-fabric-cluster-resource-manager-application-groups.md).</span></span>

<span data-ttu-id="6dbaf-155"><center>
![Chains vs. Stars in the Context of Affinity Relationships][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="6dbaf-155"><center>
![Chains vs. Stars in the Context of Affinity Relationships][Image2]
</center></span></span>

<span data-ttu-id="6dbaf-156">Another thing to note about affinity relationships today is that they are directional.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-156">Another thing to note about affinity relationships today is that they are directional.</span></span> <span data-ttu-id="6dbaf-157">This means that the “affinity” rule only enforces that the child is where the parent is, not that the parent is located with the child.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-157">This means that the “affinity” rule only enforces that the child is where the parent is, not that the parent is located with the child.</span></span> <span data-ttu-id="6dbaf-158">For example, let's say the parent suddenly fails over to another node.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-158">For example, let's say the parent suddenly fails over to another node.</span></span> <span data-ttu-id="6dbaf-159">When this happens the Cluster Resource Manager thinks everything is fine until it notices that the child is not located with a parent.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-159">When this happens the Cluster Resource Manager thinks everything is fine until it notices that the child is not located with a parent.</span></span> <span data-ttu-id="6dbaf-160">The affinity relationship can't be perfect or instantly enforced since these are different services with different lifecycles.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-160">The affinity relationship can't be perfect or instantly enforced since these are different services with different lifecycles.</span></span>

### <a name="partitioning-support"></a><span data-ttu-id="6dbaf-161">Partitioning support</span><span class="sxs-lookup"><span data-stu-id="6dbaf-161">Partitioning support</span></span>
<span data-ttu-id="6dbaf-162">The final thing to notice about affinity is that affinity relationships aren’t supported where the parent is partitioned.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-162">The final thing to notice about affinity is that affinity relationships aren’t supported where the parent is partitioned.</span></span> <span data-ttu-id="6dbaf-163">This is something that we may support eventually, but today it is not allowed.</span><span class="sxs-lookup"><span data-stu-id="6dbaf-163">This is something that we may support eventually, but today it is not allowed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="6dbaf-164">Next steps</span><span class="sxs-lookup"><span data-stu-id="6dbaf-164">Next steps</span></span>
* <span data-ttu-id="6dbaf-165">For more information about the other options available for configuring services, check out the topic on the other Cluster Resource Manager configurations available [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)</span><span class="sxs-lookup"><span data-stu-id="6dbaf-165">For more information about the other options available for configuring services, check out the topic on the other Cluster Resource Manager configurations available [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)</span></span>
* <span data-ttu-id="6dbaf-166">For uses such as limiting services to a small set of machines and trying to aggregate the load of a collection of services, use [Application Groups](service-fabric-cluster-resource-manager-application-groups.md)</span><span class="sxs-lookup"><span data-stu-id="6dbaf-166">For uses such as limiting services to a small set of machines and trying to aggregate the load of a collection of services, use [Application Groups](service-fabric-cluster-resource-manager-application-groups.md)</span></span>

[Image1]:https://docstestmedia1.blob.core.windows.net/azure-media/articles/service-fabric/media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resrouce-manager-affinity-modes.png
[Image2]:https://docstestmedia1.blob.core.windows.net/azure-media/articles/service-fabric/media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resource-manager-chains-vs-stars.png


