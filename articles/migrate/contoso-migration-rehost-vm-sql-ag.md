---
title: Rehost a Contoso app by migrating it to Azure VMs and SQL Server AlwaysOn availability group | Microsoft Docs
description: Learn how Contoso rehost an on-premises app by migrating it to Azure VMs and SQL Server AlwaysOn availability group
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 09/05/2018
ms.author: raynew
ms.openlocfilehash: 9a9bcc25a0ab6c50ebce394a43edd7bfcd764bed
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44868633"
---
# <a name="contoso-migration-rehost-an-on-premises-app-on-azure-vms-and-sql-server-alwayson-availability-group"></a><span data-ttu-id="1a31f-103">Contoso migration: Rehost an on-premises app on Azure VMs and SQL Server AlwaysOn Availability Group</span><span class="sxs-lookup"><span data-stu-id="1a31f-103">Contoso migration: Rehost an on-premises app on Azure VMs and SQL Server AlwaysOn Availability Group</span></span>

<span data-ttu-id="1a31f-104">This article demonstrates how Contoso rehosts the SmartHotel360 app in Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-104">This article demonstrates how Contoso rehosts the SmartHotel360 app in Azure.</span></span> <span data-ttu-id="1a31f-105">Contoso migrates the app frontend VM to an Azure VM, and the app database to an Azure SQL Server VM, running in a Windows Server failover cluster with SQL Server AlwaysOn Availability gGroups.</span><span class="sxs-lookup"><span data-stu-id="1a31f-105">Contoso migrates the app frontend VM to an Azure VM, and the app database to an Azure SQL Server VM, running in a Windows Server failover cluster with SQL Server AlwaysOn Availability gGroups.</span></span>

<span data-ttu-id="1a31f-106">This document is one in a series of articles that show how the fictitious company Contoso migrates on-premises resources to the Microsoft Azure cloud.</span><span class="sxs-lookup"><span data-stu-id="1a31f-106">This document is one in a series of articles that show how the fictitious company Contoso migrates on-premises resources to the Microsoft Azure cloud.</span></span> <span data-ttu-id="1a31f-107">The series includes background information, and scenarios that illustrate setting up a migration infrastructure, assessing on-premises resources for migration, and running different types of migrations.</span><span class="sxs-lookup"><span data-stu-id="1a31f-107">The series includes background information, and scenarios that illustrate setting up a migration infrastructure, assessing on-premises resources for migration, and running different types of migrations.</span></span> <span data-ttu-id="1a31f-108">Scenarios grow in complexity.</span><span class="sxs-lookup"><span data-stu-id="1a31f-108">Scenarios grow in complexity.</span></span> <span data-ttu-id="1a31f-109">We'll add additional articles over time.</span><span class="sxs-lookup"><span data-stu-id="1a31f-109">We'll add additional articles over time.</span></span>

<span data-ttu-id="1a31f-110">**Article**</span><span class="sxs-lookup"><span data-stu-id="1a31f-110">**Article**</span></span> | <span data-ttu-id="1a31f-111">**Details**</span><span class="sxs-lookup"><span data-stu-id="1a31f-111">**Details**</span></span> | <span data-ttu-id="1a31f-112">**Status**</span><span class="sxs-lookup"><span data-stu-id="1a31f-112">**Status**</span></span>
--- | --- | ---
[<span data-ttu-id="1a31f-113">Article 1: Overview</span><span class="sxs-lookup"><span data-stu-id="1a31f-113">Article 1: Overview</span></span>](contoso-migration-overview.md) | <span data-ttu-id="1a31f-114">Overview of the article series, Contoso's migration strategy, and the sample apps that are used in the series.</span><span class="sxs-lookup"><span data-stu-id="1a31f-114">Overview of the article series, Contoso's migration strategy, and the sample apps that are used in the series.</span></span> | <span data-ttu-id="1a31f-115">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-115">Available</span></span>
[<span data-ttu-id="1a31f-116">Article 2: Deploy Azure infrastructure</span><span class="sxs-lookup"><span data-stu-id="1a31f-116">Article 2: Deploy Azure infrastructure</span></span>](contoso-migration-infrastructure.md) | <span data-ttu-id="1a31f-117">Contoso prepares its on-premises infrastructure and its Azure infrastructure for migration.</span><span class="sxs-lookup"><span data-stu-id="1a31f-117">Contoso prepares its on-premises infrastructure and its Azure infrastructure for migration.</span></span> <span data-ttu-id="1a31f-118">The same infrastructure is used for all migration articles in the series.</span><span class="sxs-lookup"><span data-stu-id="1a31f-118">The same infrastructure is used for all migration articles in the series.</span></span> | <span data-ttu-id="1a31f-119">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-119">Available</span></span>
[<span data-ttu-id="1a31f-120">Article 3: Assess on-premises resources for migration to Azure</span><span class="sxs-lookup"><span data-stu-id="1a31f-120">Article 3: Assess on-premises resources for migration to Azure</span></span>](contoso-migration-assessment.md)  | <span data-ttu-id="1a31f-121">Contoso runs an assessment of its on-premises SmartHotel360 app running on VMware.</span><span class="sxs-lookup"><span data-stu-id="1a31f-121">Contoso runs an assessment of its on-premises SmartHotel360 app running on VMware.</span></span> <span data-ttu-id="1a31f-122">Contoso assesses app VMs using the Azure Migrate service, and the app SQL Server database using Data Migration Assistant.</span><span class="sxs-lookup"><span data-stu-id="1a31f-122">Contoso assesses app VMs using the Azure Migrate service, and the app SQL Server database using Data Migration Assistant.</span></span> | <span data-ttu-id="1a31f-123">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-123">Available</span></span>
[<span data-ttu-id="1a31f-124">Article 4: Rehost an app on an Azure VM and SQL Database Managed Instance</span><span class="sxs-lookup"><span data-stu-id="1a31f-124">Article 4: Rehost an app on an Azure VM and SQL Database Managed Instance</span></span>](contoso-migration-rehost-vm-sql-managed-instance.md) | <span data-ttu-id="1a31f-125">Contoso runs a lift-and-shift migration to Azure for its on-premises SmartHotel360 app.</span><span class="sxs-lookup"><span data-stu-id="1a31f-125">Contoso runs a lift-and-shift migration to Azure for its on-premises SmartHotel360 app.</span></span> <span data-ttu-id="1a31f-126">Contoso migrates the app front-end VM using [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview).</span><span class="sxs-lookup"><span data-stu-id="1a31f-126">Contoso migrates the app front-end VM using [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview).</span></span> <span data-ttu-id="1a31f-127">Contoso migrates the app database to an Azure SQL Database Managed Instance using the [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview).</span><span class="sxs-lookup"><span data-stu-id="1a31f-127">Contoso migrates the app database to an Azure SQL Database Managed Instance using the [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview).</span></span> | <span data-ttu-id="1a31f-128">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-128">Available</span></span>   
[<span data-ttu-id="1a31f-129">Article 5: Rehost an app on Azure VMs</span><span class="sxs-lookup"><span data-stu-id="1a31f-129">Article 5: Rehost an app on Azure VMs</span></span>](contoso-migration-rehost-vm.md) | <span data-ttu-id="1a31f-130">Contoso migrates its SmartHotel360 app VMs to Azure VMs using the Site Recovery service.</span><span class="sxs-lookup"><span data-stu-id="1a31f-130">Contoso migrates its SmartHotel360 app VMs to Azure VMs using the Site Recovery service.</span></span> | <span data-ttu-id="1a31f-131">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-131">Available</span></span>
<span data-ttu-id="1a31f-132">Article 6: Rehost an app on Azure VMs and in a  SQL Server AlwaysOn availability group</span><span class="sxs-lookup"><span data-stu-id="1a31f-132">Article 6: Rehost an app on Azure VMs and in a  SQL Server AlwaysOn availability group</span></span> | <span data-ttu-id="1a31f-133">Contoso migrates the SmartHotel360 app.</span><span class="sxs-lookup"><span data-stu-id="1a31f-133">Contoso migrates the SmartHotel360 app.</span></span> <span data-ttu-id="1a31f-134">Contoso uses Site Recovery to migrate the app VMs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-134">Contoso uses Site Recovery to migrate the app VMs.</span></span> <span data-ttu-id="1a31f-135">It uses the Database Migration Service to migrate the app database to a SQL Server cluster that's protected by an AlwaysOn availability group.</span><span class="sxs-lookup"><span data-stu-id="1a31f-135">It uses the Database Migration Service to migrate the app database to a SQL Server cluster that's protected by an AlwaysOn availability group.</span></span> | <span data-ttu-id="1a31f-136">This article</span><span class="sxs-lookup"><span data-stu-id="1a31f-136">This article</span></span>
[<span data-ttu-id="1a31f-137">Article 7: Rehost a Linux app on Azure VMs</span><span class="sxs-lookup"><span data-stu-id="1a31f-137">Article 7: Rehost a Linux app on Azure VMs</span></span>](contoso-migration-rehost-linux-vm.md) | <span data-ttu-id="1a31f-138">Contoso completes a lift-and-shift migration of the Linux osTicket app to Azure VMs, using Azure Site Recovery</span><span class="sxs-lookup"><span data-stu-id="1a31f-138">Contoso completes a lift-and-shift migration of the Linux osTicket app to Azure VMs, using Azure Site Recovery</span></span> | <span data-ttu-id="1a31f-139">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-139">Available</span></span>
[<span data-ttu-id="1a31f-140">Article 8: Rehost a Linux app on Azure VMs and Azure MySQL Server</span><span class="sxs-lookup"><span data-stu-id="1a31f-140">Article 8: Rehost a Linux app on Azure VMs and Azure MySQL Server</span></span>](contoso-migration-rehost-linux-vm-mysql.md) | <span data-ttu-id="1a31f-141">Contoso migrates the Linux osTicket app to Azure VMs using Azure Site Recovery, and migrates the app database to an Azure MySQL Server instance using MySQL Workbench.</span><span class="sxs-lookup"><span data-stu-id="1a31f-141">Contoso migrates the Linux osTicket app to Azure VMs using Azure Site Recovery, and migrates the app database to an Azure MySQL Server instance using MySQL Workbench.</span></span> | <span data-ttu-id="1a31f-142">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-142">Available</span></span>
[<span data-ttu-id="1a31f-143">Article 9: Refactor an app on Azure Web Apps and Azure SQL database</span><span class="sxs-lookup"><span data-stu-id="1a31f-143">Article 9: Refactor an app on Azure Web Apps and Azure SQL database</span></span>](contoso-migration-refactor-web-app-sql.md) | <span data-ttu-id="1a31f-144">Contoso migrates the SmartHotel360 app to an Azure Web App, and migrates the app database to an Azure SQL Server instance with Database Migration Assistant</span><span class="sxs-lookup"><span data-stu-id="1a31f-144">Contoso migrates the SmartHotel360 app to an Azure Web App, and migrates the app database to an Azure SQL Server instance with Database Migration Assistant</span></span> | <span data-ttu-id="1a31f-145">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-145">Available</span></span>
[<span data-ttu-id="1a31f-146">Article 10: Refactor a Linux app on Azure Web Apps and Azure MySQL</span><span class="sxs-lookup"><span data-stu-id="1a31f-146">Article 10: Refactor a Linux app on Azure Web Apps and Azure MySQL</span></span>](contoso-migration-refactor-linux-app-service-mysql.md) | <span data-ttu-id="1a31f-147">Contoso migrates its Linux osTicket app to an Azure web app on multiple Azure regions using Azure Traffic Manager, integrated with GitHub for continuous delivery.</span><span class="sxs-lookup"><span data-stu-id="1a31f-147">Contoso migrates its Linux osTicket app to an Azure web app on multiple Azure regions using Azure Traffic Manager, integrated with GitHub for continuous delivery.</span></span> <span data-ttu-id="1a31f-148">Contoso migrates the app database to an Azure Database for MySQL instance.</span><span class="sxs-lookup"><span data-stu-id="1a31f-148">Contoso migrates the app database to an Azure Database for MySQL instance.</span></span> | <span data-ttu-id="1a31f-149">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-149">Available</span></span> 
[<span data-ttu-id="1a31f-150">Article 11: Refactor TFS on Azure DevOps Services</span><span class="sxs-lookup"><span data-stu-id="1a31f-150">Article 11: Refactor TFS on Azure DevOps Services</span></span>](contoso-migration-tfs-vsts.md) | <span data-ttu-id="1a31f-151">Contoso migrates its on-premises Team Foundation Server deployment to Azure DevOps Services in Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-151">Contoso migrates its on-premises Team Foundation Server deployment to Azure DevOps Services in Azure.</span></span> | <span data-ttu-id="1a31f-152">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-152">Available</span></span>
[<span data-ttu-id="1a31f-153">Article 12: Rearchitect an app on Azure containers and Azure SQL Database</span><span class="sxs-lookup"><span data-stu-id="1a31f-153">Article 12: Rearchitect an app on Azure containers and Azure SQL Database</span></span>](contoso-migration-rearchitect-container-sql.md) | <span data-ttu-id="1a31f-154">Contoso migrates its SmartHotel app to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-154">Contoso migrates its SmartHotel app to Azure.</span></span> <span data-ttu-id="1a31f-155">Then, it rearchitects the app web tier as a Windows container running in Azure Service Fabric, and the database with Azure SQL Database.</span><span class="sxs-lookup"><span data-stu-id="1a31f-155">Then, it rearchitects the app web tier as a Windows container running in Azure Service Fabric, and the database with Azure SQL Database.</span></span> | <span data-ttu-id="1a31f-156">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-156">Available</span></span>
[<span data-ttu-id="1a31f-157">Article 13: Rebuild an app in Azure</span><span class="sxs-lookup"><span data-stu-id="1a31f-157">Article 13: Rebuild an app in Azure</span></span>](contoso-migration-rebuild.md) | <span data-ttu-id="1a31f-158">Contoso rebuilds its SmartHotel app by using a range of Azure capabilities and services, including Azure App Service, Azure Kubernetes Service (AKS), Azure Functions, Azure Cognitive Services, and Azure Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="1a31f-158">Contoso rebuilds its SmartHotel app by using a range of Azure capabilities and services, including Azure App Service, Azure Kubernetes Service (AKS), Azure Functions, Azure Cognitive Services, and Azure Cosmos DB.</span></span> | <span data-ttu-id="1a31f-159">Available</span><span class="sxs-lookup"><span data-stu-id="1a31f-159">Available</span></span>


<span data-ttu-id="1a31f-160">In this article, Contoso migrates the two-tier Windows .NET SmartHotel360 app running on VMware VMs to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-160">In this article, Contoso migrates the two-tier Windows .NET SmartHotel360 app running on VMware VMs to Azure.</span></span> <span data-ttu-id="1a31f-161">If you'd like to use this app, it's provided as open source and you can download it from [GitHub](https://github.com/Microsoft/SmartHotel360).</span><span class="sxs-lookup"><span data-stu-id="1a31f-161">If you'd like to use this app, it's provided as open source and you can download it from [GitHub](https://github.com/Microsoft/SmartHotel360).</span></span>

## <a name="business-drivers"></a><span data-ttu-id="1a31f-162">Business drivers</span><span class="sxs-lookup"><span data-stu-id="1a31f-162">Business drivers</span></span>

<span data-ttu-id="1a31f-163">The IT leadership team has worked closely with business partners to understand what they want to achieve with this migration:</span><span class="sxs-lookup"><span data-stu-id="1a31f-163">The IT leadership team has worked closely with business partners to understand what they want to achieve with this migration:</span></span>

- <span data-ttu-id="1a31f-164">**Address business growth**: Contoso is growing, and as a result there is pressure on on-premises systems and infrastructure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-164">**Address business growth**: Contoso is growing, and as a result there is pressure on on-premises systems and infrastructure.</span></span>
- <span data-ttu-id="1a31f-165">**Increase efficiency**: Contoso needs to remove unnecessary procedures, and streamline processes for developers and users.</span><span class="sxs-lookup"><span data-stu-id="1a31f-165">**Increase efficiency**: Contoso needs to remove unnecessary procedures, and streamline processes for developers and users.</span></span>  <span data-ttu-id="1a31f-166">The business needs IT to be fast and not waste time or money, thus delivering faster on customer requirements.</span><span class="sxs-lookup"><span data-stu-id="1a31f-166">The business needs IT to be fast and not waste time or money, thus delivering faster on customer requirements.</span></span>
- <span data-ttu-id="1a31f-167">**Increase agility**:  Contoso IT needs to be more responsive to the needs of the business.</span><span class="sxs-lookup"><span data-stu-id="1a31f-167">**Increase agility**:  Contoso IT needs to be more responsive to the needs of the business.</span></span> <span data-ttu-id="1a31f-168">It must be able to react faster than the changes in the marketplace, to enable the success in a global economy.</span><span class="sxs-lookup"><span data-stu-id="1a31f-168">It must be able to react faster than the changes in the marketplace, to enable the success in a global economy.</span></span>  <span data-ttu-id="1a31f-169">IT mustn't get in the way, or become a business blocker.</span><span class="sxs-lookup"><span data-stu-id="1a31f-169">IT mustn't get in the way, or become a business blocker.</span></span>
- <span data-ttu-id="1a31f-170">**Scale**: As the business grows successfully, Contoso IT must provide systems that are able to grow at the same pace.</span><span class="sxs-lookup"><span data-stu-id="1a31f-170">**Scale**: As the business grows successfully, Contoso IT must provide systems that are able to grow at the same pace.</span></span>

## <a name="migration-goals"></a><span data-ttu-id="1a31f-171">Migration goals</span><span class="sxs-lookup"><span data-stu-id="1a31f-171">Migration goals</span></span>

<span data-ttu-id="1a31f-172">The Contoso cloud team has pinned down goals for this migration.</span><span class="sxs-lookup"><span data-stu-id="1a31f-172">The Contoso cloud team has pinned down goals for this migration.</span></span> <span data-ttu-id="1a31f-173">These goals were used to determine the best migration method:</span><span class="sxs-lookup"><span data-stu-id="1a31f-173">These goals were used to determine the best migration method:</span></span>

- <span data-ttu-id="1a31f-174">After migration, the app in Azure should have the same performance capabilities as it does today in VMWare.</span><span class="sxs-lookup"><span data-stu-id="1a31f-174">After migration, the app in Azure should have the same performance capabilities as it does today in VMWare.</span></span>  <span data-ttu-id="1a31f-175">The app will remain as critical in the cloud as it is on-premises.</span><span class="sxs-lookup"><span data-stu-id="1a31f-175">The app will remain as critical in the cloud as it is on-premises.</span></span>
- <span data-ttu-id="1a31f-176">Contoso doesn’t want to invest in this app.</span><span class="sxs-lookup"><span data-stu-id="1a31f-176">Contoso doesn’t want to invest in this app.</span></span>  <span data-ttu-id="1a31f-177">It is important to the business, but in its current form Contoso simply want to move it safely to the cloud.</span><span class="sxs-lookup"><span data-stu-id="1a31f-177">It is important to the business, but in its current form Contoso simply want to move it safely to the cloud.</span></span>
- <span data-ttu-id="1a31f-178">The on-premises database for the app has had availability issues.</span><span class="sxs-lookup"><span data-stu-id="1a31f-178">The on-premises database for the app has had availability issues.</span></span> <span data-ttu-id="1a31f-179">Contoso would like to deploy it in Azure as a high-availability cluster, with failover capabilities.</span><span class="sxs-lookup"><span data-stu-id="1a31f-179">Contoso would like to deploy it in Azure as a high-availability cluster, with failover capabilities.</span></span>
- <span data-ttu-id="1a31f-180">Contoso wants to upgrade from their current SQL Server 2008 R2 platform, to SQL Server 2017.</span><span class="sxs-lookup"><span data-stu-id="1a31f-180">Contoso wants to upgrade from their current SQL Server 2008 R2 platform, to SQL Server 2017.</span></span>
- <span data-ttu-id="1a31f-181">Contoso doesn't want to use an Azure SQL Database for this app, and is looking for alternatives.</span><span class="sxs-lookup"><span data-stu-id="1a31f-181">Contoso doesn't want to use an Azure SQL Database for this app, and is looking for alternatives.</span></span>


## <a name="solution-design"></a><span data-ttu-id="1a31f-182">Solution design</span><span class="sxs-lookup"><span data-stu-id="1a31f-182">Solution design</span></span>

<span data-ttu-id="1a31f-183">After pinning down their goals and requirements, Contoso designs and reviews a deployment solution, and identifies the migration process, including the Azure services that it will use for the migration.</span><span class="sxs-lookup"><span data-stu-id="1a31f-183">After pinning down their goals and requirements, Contoso designs and reviews a deployment solution, and identifies the migration process, including the Azure services that it will use for the migration.</span></span>

### <a name="current-architecture"></a><span data-ttu-id="1a31f-184">Current architecture</span><span class="sxs-lookup"><span data-stu-id="1a31f-184">Current architecture</span></span>

- <span data-ttu-id="1a31f-185">The app is tiered across two VMs (WEBVM and SQLVM).</span><span class="sxs-lookup"><span data-stu-id="1a31f-185">The app is tiered across two VMs (WEBVM and SQLVM).</span></span>
- <span data-ttu-id="1a31f-186">The VMs are located on VMware ESXi host **contosohost1.contoso.com** (version 6.5)</span><span class="sxs-lookup"><span data-stu-id="1a31f-186">The VMs are located on VMware ESXi host **contosohost1.contoso.com** (version 6.5)</span></span>
- <span data-ttu-id="1a31f-187">The VMware environment is managed by vCenter Server 6.5 (**vcenter.contoso.com**), running on a VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-187">The VMware environment is managed by vCenter Server 6.5 (**vcenter.contoso.com**), running on a VM.</span></span>
- <span data-ttu-id="1a31f-188">Contoso has an on-premises datacenter (contoso-datacenter), with an on-premises domain controller (**contosodc1**).</span><span class="sxs-lookup"><span data-stu-id="1a31f-188">Contoso has an on-premises datacenter (contoso-datacenter), with an on-premises domain controller (**contosodc1**).</span></span>


### <a name="proposed-architecture"></a><span data-ttu-id="1a31f-189">Proposed architecture</span><span class="sxs-lookup"><span data-stu-id="1a31f-189">Proposed architecture</span></span>

<span data-ttu-id="1a31f-190">In this scenario:</span><span class="sxs-lookup"><span data-stu-id="1a31f-190">In this scenario:</span></span>

- <span data-ttu-id="1a31f-191">Contoso will migrate the app frontend WEBVM to an Azure IaaS VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-191">Contoso will migrate the app frontend WEBVM to an Azure IaaS VM.</span></span>
    - <span data-ttu-id="1a31f-192">The frontend VM in Azure will be deployed in the ContosoRG resource group (used for production resources).</span><span class="sxs-lookup"><span data-stu-id="1a31f-192">The frontend VM in Azure will be deployed in the ContosoRG resource group (used for production resources).</span></span>
    -  <span data-ttu-id="1a31f-193">It will be located in the Azure production network (VNET-PROD-EUS2) in the primary East US2 region.</span><span class="sxs-lookup"><span data-stu-id="1a31f-193">It will be located in the Azure production network (VNET-PROD-EUS2) in the primary East US2 region.</span></span>
- <span data-ttu-id="1a31f-194">The app database will be migrated to an Azure SQL Server VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-194">The app database will be migrated to an Azure SQL Server VM.</span></span>
    - <span data-ttu-id="1a31f-195">It will be located in Contoso's Azure database network (PROD-DB-EUS2) in the primary East US2 region.</span><span class="sxs-lookup"><span data-stu-id="1a31f-195">It will be located in Contoso's Azure database network (PROD-DB-EUS2) in the primary East US2 region.</span></span>
    - <span data-ttu-id="1a31f-196">It will be placed in a Windows Server failover cluster with two nodes, that uses SQL Server Always On Availability Groups.</span><span class="sxs-lookup"><span data-stu-id="1a31f-196">It will be placed in a Windows Server failover cluster with two nodes, that uses SQL Server Always On Availability Groups.</span></span>
    - <span data-ttu-id="1a31f-197">In Azure the two SQL Server VM nodes in the cluster will be deployed in the ContosoRG resource group.</span><span class="sxs-lookup"><span data-stu-id="1a31f-197">In Azure the two SQL Server VM nodes in the cluster will be deployed in the ContosoRG resource group.</span></span>
    - <span data-ttu-id="1a31f-198">The VM nodes will be located in the Azure production network (VNET-PROD-EUS2) in the primary East US2 region.</span><span class="sxs-lookup"><span data-stu-id="1a31f-198">The VM nodes will be located in the Azure production network (VNET-PROD-EUS2) in the primary East US2 region.</span></span>
    - <span data-ttu-id="1a31f-199">VMs will run Windows Server 2016 with SQL Server 2017 Enterprise Edition.</span><span class="sxs-lookup"><span data-stu-id="1a31f-199">VMs will run Windows Server 2016 with SQL Server 2017 Enterprise Edition.</span></span> <span data-ttu-id="1a31f-200">Contoso doesn't have licenses for this operating system, so it will use an image in the Azure Marketplace that provides the license as a charge to their Azure EA commitment.</span><span class="sxs-lookup"><span data-stu-id="1a31f-200">Contoso doesn't have licenses for this operating system, so it will use an image in the Azure Marketplace that provides the license as a charge to their Azure EA commitment.</span></span>
    - <span data-ttu-id="1a31f-201">Apart from unique names, both VMs use the same settings.</span><span class="sxs-lookup"><span data-stu-id="1a31f-201">Apart from unique names, both VMs use the same settings.</span></span>
- <span data-ttu-id="1a31f-202">Contoso will deploy an internal load balancer which listens for traffic on the cluster, and directs it to the appropriate cluster node.</span><span class="sxs-lookup"><span data-stu-id="1a31f-202">Contoso will deploy an internal load balancer which listens for traffic on the cluster, and directs it to the appropriate cluster node.</span></span>
    - <span data-ttu-id="1a31f-203">The internal load balancer will be deployed in the ContosoNetworkingRG (used for networking resources).</span><span class="sxs-lookup"><span data-stu-id="1a31f-203">The internal load balancer will be deployed in the ContosoNetworkingRG (used for networking resources).</span></span>
- <span data-ttu-id="1a31f-204">The on-premises VMs in the Contoso datacenter will be decommissioned after the migration is done.</span><span class="sxs-lookup"><span data-stu-id="1a31f-204">The on-premises VMs in the Contoso datacenter will be decommissioned after the migration is done.</span></span>

![Scenario architecture](media/contoso-migration-rehost-vm-sql-ag/architecture.png) 

### <a name="database-considerations"></a><span data-ttu-id="1a31f-206">Database considerations</span><span class="sxs-lookup"><span data-stu-id="1a31f-206">Database considerations</span></span>

<span data-ttu-id="1a31f-207">As part of the solution design process, Contoso did a feature comparison between Azure SQL Database and SQL Server.</span><span class="sxs-lookup"><span data-stu-id="1a31f-207">As part of the solution design process, Contoso did a feature comparison between Azure SQL Database and SQL Server.</span></span> <span data-ttu-id="1a31f-208">The following considerations helped them to decide to go with an Azure Iaas VM running SQL Server:</span><span class="sxs-lookup"><span data-stu-id="1a31f-208">The following considerations helped them to decide to go with an Azure Iaas VM running SQL Server:</span></span>

 - <span data-ttu-id="1a31f-209">Using an Azure VM running SQL Server seems to be an optimal solution if Contoso needs to customize the operating system or the database server, or if it might want to colocate and run third-party apps on the same VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-209">Using an Azure VM running SQL Server seems to be an optimal solution if Contoso needs to customize the operating system or the database server, or if it might want to colocate and run third-party apps on the same VM.</span></span>
 - <span data-ttu-id="1a31f-210">Using the Data Migration Assistant, Contoso can easily assess and migrate to an Azure SQL Database.</span><span class="sxs-lookup"><span data-stu-id="1a31f-210">Using the Data Migration Assistant, Contoso can easily assess and migrate to an Azure SQL Database.</span></span>
 

### <a name="solution-review"></a><span data-ttu-id="1a31f-211">Solution review</span><span class="sxs-lookup"><span data-stu-id="1a31f-211">Solution review</span></span>

<span data-ttu-id="1a31f-212">Contoso evaluates their proposed design by putting together a pros and cons list.</span><span class="sxs-lookup"><span data-stu-id="1a31f-212">Contoso evaluates their proposed design by putting together a pros and cons list.</span></span>

<span data-ttu-id="1a31f-213">**Consideration**</span><span class="sxs-lookup"><span data-stu-id="1a31f-213">**Consideration**</span></span> | <span data-ttu-id="1a31f-214">**Details**</span><span class="sxs-lookup"><span data-stu-id="1a31f-214">**Details**</span></span>
--- | ---
<span data-ttu-id="1a31f-215">**Pros**</span><span class="sxs-lookup"><span data-stu-id="1a31f-215">**Pros**</span></span> | <span data-ttu-id="1a31f-216">WEBVM will be moved to Azure without changes, making the migration simple.</span><span class="sxs-lookup"><span data-stu-id="1a31f-216">WEBVM will be moved to Azure without changes, making the migration simple.</span></span><br/><br/> <span data-ttu-id="1a31f-217">The SQL Server tier will run on SQL Server 2017 and Windows Server 2016.</span><span class="sxs-lookup"><span data-stu-id="1a31f-217">The SQL Server tier will run on SQL Server 2017 and Windows Server 2016.</span></span> <span data-ttu-id="1a31f-218">This retires their current Windows Server 2008 R2 operating system, and running SQL Server 2017 supports Contoso's technical requirements and goals.</span><span class="sxs-lookup"><span data-stu-id="1a31f-218">This retires their current Windows Server 2008 R2 operating system, and running SQL Server 2017 supports Contoso's technical requirements and goals.</span></span> <span data-ttu-id="1a31f-219">IT provides 100% compatibility while moving away from SQL Server 2008 R2.</span><span class="sxs-lookup"><span data-stu-id="1a31f-219">IT provides 100% compatibility while moving away from SQL Server 2008 R2.</span></span><br/><br/> <span data-ttu-id="1a31f-220">Contoso can leverage their investment in Software Assurance, using the Azure Hybrid Benefit.</span><span class="sxs-lookup"><span data-stu-id="1a31f-220">Contoso can leverage their investment in Software Assurance, using the Azure Hybrid Benefit.</span></span><br/><br/> <span data-ttu-id="1a31f-221">A high availability SQL Server deployment in Auzre provides fault tolerance so that the app data tier is no longer a single point of failover.</span><span class="sxs-lookup"><span data-stu-id="1a31f-221">A high availability SQL Server deployment in Auzre provides fault tolerance so that the app data tier is no longer a single point of failover.</span></span>
<span data-ttu-id="1a31f-222">**Cons**</span><span class="sxs-lookup"><span data-stu-id="1a31f-222">**Cons**</span></span> | <span data-ttu-id="1a31f-223">WEBVM is running Windows Server 2008 R2.</span><span class="sxs-lookup"><span data-stu-id="1a31f-223">WEBVM is running Windows Server 2008 R2.</span></span> <span data-ttu-id="1a31f-224">The operating system is supported by Azure for specific roles (July 2018).</span><span class="sxs-lookup"><span data-stu-id="1a31f-224">The operating system is supported by Azure for specific roles (July 2018).</span></span> <span data-ttu-id="1a31f-225">[Learn more](https://support.microsoft.com/help/2721672/microsoft-server-software-support-for-microsoft-azure-virtual-machines).</span><span class="sxs-lookup"><span data-stu-id="1a31f-225">[Learn more](https://support.microsoft.com/help/2721672/microsoft-server-software-support-for-microsoft-azure-virtual-machines).</span></span><br/><br/> <span data-ttu-id="1a31f-226">The web tier of the app will remain a single point of failover.</span><span class="sxs-lookup"><span data-stu-id="1a31f-226">The web tier of the app will remain a single point of failover.</span></span></br><br/> <span data-ttu-id="1a31f-227">Contoso will need to continue supporting the web tier as an Azure VM rather than moving to a managed service such as Azure App Service.</span><span class="sxs-lookup"><span data-stu-id="1a31f-227">Contoso will need to continue supporting the web tier as an Azure VM rather than moving to a managed service such as Azure App Service.</span></span><br/><br/> <span data-ttu-id="1a31f-228">With the chosen solution, Contoso will need to continue managing two SQL Server VMs rather than moving to a managed platform such as Azure SQL Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="1a31f-228">With the chosen solution, Contoso will need to continue managing two SQL Server VMs rather than moving to a managed platform such as Azure SQL Managed Instance.</span></span> <span data-ttu-id="1a31f-229">In addition, with Software Assurance, Contoso could exchange their existing licenses for discounted rates on Azure SQL Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="1a31f-229">In addition, with Software Assurance, Contoso could exchange their existing licenses for discounted rates on Azure SQL Managed Instance.</span></span>


### <a name="azure-services"></a><span data-ttu-id="1a31f-230">Azure services</span><span class="sxs-lookup"><span data-stu-id="1a31f-230">Azure services</span></span>

<span data-ttu-id="1a31f-231">**Service**</span><span class="sxs-lookup"><span data-stu-id="1a31f-231">**Service**</span></span> | <span data-ttu-id="1a31f-232">**Description**</span><span class="sxs-lookup"><span data-stu-id="1a31f-232">**Description**</span></span> | <span data-ttu-id="1a31f-233">**Cost**</span><span class="sxs-lookup"><span data-stu-id="1a31f-233">**Cost**</span></span>
--- | --- | ---
[<span data-ttu-id="1a31f-234">Database Migration Assistant</span><span class="sxs-lookup"><span data-stu-id="1a31f-234">Database Migration Assistant</span></span>](https://docs.microsoft.com/sql/dma/dma-overview?view=ssdt-18vs2017) | <span data-ttu-id="1a31f-235">DMA runs locally from the on-premises SQL Server machine, and migrates the database across a site-to-site VPN to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-235">DMA runs locally from the on-premises SQL Server machine, and migrates the database across a site-to-site VPN to Azure.</span></span> | <span data-ttu-id="1a31f-236">DMA is a free, downloadable tool.</span><span class="sxs-lookup"><span data-stu-id="1a31f-236">DMA is a free, downloadable tool.</span></span>
[<span data-ttu-id="1a31f-237">Azure Site Recovery</span><span class="sxs-lookup"><span data-stu-id="1a31f-237">Azure Site Recovery</span></span>](https://docs.microsoft.com/azure/site-recovery/) | <span data-ttu-id="1a31f-238">Site Recovery orchestrates and manages migration and disaster recovery for Azure VMs, and on-premises VMs and physical servers.</span><span class="sxs-lookup"><span data-stu-id="1a31f-238">Site Recovery orchestrates and manages migration and disaster recovery for Azure VMs, and on-premises VMs and physical servers.</span></span>  | <span data-ttu-id="1a31f-239">During replication to Azure, Azure Storage charges are incurred.</span><span class="sxs-lookup"><span data-stu-id="1a31f-239">During replication to Azure, Azure Storage charges are incurred.</span></span>  <span data-ttu-id="1a31f-240">Azure VMs are created, and incur charges, when failover occurs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-240">Azure VMs are created, and incur charges, when failover occurs.</span></span> <span data-ttu-id="1a31f-241">[Learn more](https://azure.microsoft.com/pricing/details/site-recovery/) about charges and pricing.</span><span class="sxs-lookup"><span data-stu-id="1a31f-241">[Learn more](https://azure.microsoft.com/pricing/details/site-recovery/) about charges and pricing.</span></span>

 

## <a name="migration-process"></a><span data-ttu-id="1a31f-242">Migration process</span><span class="sxs-lookup"><span data-stu-id="1a31f-242">Migration process</span></span>

<span data-ttu-id="1a31f-243">Contoso admins will migrate the app VMs to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-243">Contoso admins will migrate the app VMs to Azure.</span></span>

- <span data-ttu-id="1a31f-244">They'll migrate the frontend VM to Azure VM using Site Recovery:</span><span class="sxs-lookup"><span data-stu-id="1a31f-244">They'll migrate the frontend VM to Azure VM using Site Recovery:</span></span>
    - <span data-ttu-id="1a31f-245">As a first step, they'll prepare and set up Azure components, and prepare the on-premises VMware infrastructure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-245">As a first step, they'll prepare and set up Azure components, and prepare the on-premises VMware infrastructure.</span></span>
    - <span data-ttu-id="1a31f-246">With everything prepared, they can start replicating the VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-246">With everything prepared, they can start replicating the VM.</span></span>
    - <span data-ttu-id="1a31f-247">After replication is enabled and working, they migrate the VM by failing it over to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-247">After replication is enabled and working, they migrate the VM by failing it over to Azure.</span></span>
- <span data-ttu-id="1a31f-248">They'll migrate the database to a SQL Server cluster in Azure, using the Data Migration Assistant (DMA).</span><span class="sxs-lookup"><span data-stu-id="1a31f-248">They'll migrate the database to a SQL Server cluster in Azure, using the Data Migration Assistant (DMA).</span></span>
    - <span data-ttu-id="1a31f-249">As a first step they'll need to provision SQL Server VMs in Azure, set up the cluster and an internal load balancer, and configure AlwaysOn availability groups.</span><span class="sxs-lookup"><span data-stu-id="1a31f-249">As a first step they'll need to provision SQL Server VMs in Azure, set up the cluster and an internal load balancer, and configure AlwaysOn availability groups.</span></span>
    - <span data-ttu-id="1a31f-250">With this in place, they can migrate the database</span><span class="sxs-lookup"><span data-stu-id="1a31f-250">With this in place, they can migrate the database</span></span>
- <span data-ttu-id="1a31f-251">After the migration, they'll enable AlwaysOn protection for the database.</span><span class="sxs-lookup"><span data-stu-id="1a31f-251">After the migration, they'll enable AlwaysOn protection for the database.</span></span>

![Migration process](media/contoso-migration-rehost-vm-sql-ag/migration-process.png) 
 
## <a name="prerequisites"></a><span data-ttu-id="1a31f-253">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="1a31f-253">Prerequisites</span></span>

<span data-ttu-id="1a31f-254">Here's what Contoso needs to do for this scenario.</span><span class="sxs-lookup"><span data-stu-id="1a31f-254">Here's what Contoso needs to do for this scenario.</span></span>

<span data-ttu-id="1a31f-255">**Requirements**</span><span class="sxs-lookup"><span data-stu-id="1a31f-255">**Requirements**</span></span> | <span data-ttu-id="1a31f-256">**Details**</span><span class="sxs-lookup"><span data-stu-id="1a31f-256">**Details**</span></span>
--- | ---
<span data-ttu-id="1a31f-257">**Azure subscription**</span><span class="sxs-lookup"><span data-stu-id="1a31f-257">**Azure subscription**</span></span> | <span data-ttu-id="1a31f-258">Contoso already created a subscription in an early article in this series.</span><span class="sxs-lookup"><span data-stu-id="1a31f-258">Contoso already created a subscription in an early article in this series.</span></span> <span data-ttu-id="1a31f-259">If you don't have an Azure subscription, create a [free account](https://azure.microsoft.com/pricing/free-trial/).</span><span class="sxs-lookup"><span data-stu-id="1a31f-259">If you don't have an Azure subscription, create a [free account](https://azure.microsoft.com/pricing/free-trial/).</span></span><br/><br/> <span data-ttu-id="1a31f-260">If you create a free account, you're the administrator of your subscription and can perform all actions.</span><span class="sxs-lookup"><span data-stu-id="1a31f-260">If you create a free account, you're the administrator of your subscription and can perform all actions.</span></span><br/><br/> <span data-ttu-id="1a31f-261">If you use an existing subscription and you're not the administrator, you need to work with the admin to assign you Owner or Contributor permissions.</span><span class="sxs-lookup"><span data-stu-id="1a31f-261">If you use an existing subscription and you're not the administrator, you need to work with the admin to assign you Owner or Contributor permissions.</span></span><br/><br/> <span data-ttu-id="1a31f-262">If you need more granular permissions, review [this article](../site-recovery/site-recovery-role-based-linked-access-control.md).</span><span class="sxs-lookup"><span data-stu-id="1a31f-262">If you need more granular permissions, review [this article](../site-recovery/site-recovery-role-based-linked-access-control.md).</span></span> 
<span data-ttu-id="1a31f-263">**Azure infrastructure**</span><span class="sxs-lookup"><span data-stu-id="1a31f-263">**Azure infrastructure**</span></span> | <span data-ttu-id="1a31f-264">[Learn how](contoso-migration-infrastructure.md) Contoso set up an Azure infrastructure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-264">[Learn how](contoso-migration-infrastructure.md) Contoso set up an Azure infrastructure.</span></span><br/><br/> <span data-ttu-id="1a31f-265">Learn more about specific [network](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) and [storage](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage) requirements for Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="1a31f-265">Learn more about specific [network](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) and [storage](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage) requirements for Site Recovery.</span></span>
<span data-ttu-id="1a31f-266">**Site recovery (on-premises)**</span><span class="sxs-lookup"><span data-stu-id="1a31f-266">**Site recovery (on-premises)**</span></span> | <span data-ttu-id="1a31f-267">The on-premises vCenter server should be running version 5.5, 6.0, or 6.5</span><span class="sxs-lookup"><span data-stu-id="1a31f-267">The on-premises vCenter server should be running version 5.5, 6.0, or 6.5</span></span><br/><br/> <span data-ttu-id="1a31f-268">An ESXi host running version 5.5, 6.0 or 6.5</span><span class="sxs-lookup"><span data-stu-id="1a31f-268">An ESXi host running version 5.5, 6.0 or 6.5</span></span><br/><br/> <span data-ttu-id="1a31f-269">One or more VMware VMs running on the ESXi host.</span><span class="sxs-lookup"><span data-stu-id="1a31f-269">One or more VMware VMs running on the ESXi host.</span></span><br/><br/> <span data-ttu-id="1a31f-270">VMs must meet [Azure requirements](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).</span><span class="sxs-lookup"><span data-stu-id="1a31f-270">VMs must meet [Azure requirements](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).</span></span><br/><br/> <span data-ttu-id="1a31f-271">Supported [network](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) and [storage](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage) configuration.</span><span class="sxs-lookup"><span data-stu-id="1a31f-271">Supported [network](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) and [storage](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage) configuration.</span></span><br/><br/> <span data-ttu-id="1a31f-272">VMs you want to replicate must meet [Azure requirements](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).</span><span class="sxs-lookup"><span data-stu-id="1a31f-272">VMs you want to replicate must meet [Azure requirements](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).</span></span>



## <a name="scenario-steps"></a><span data-ttu-id="1a31f-273">Scenario steps</span><span class="sxs-lookup"><span data-stu-id="1a31f-273">Scenario steps</span></span>

<span data-ttu-id="1a31f-274">Here's how Contoso will run the migration:</span><span class="sxs-lookup"><span data-stu-id="1a31f-274">Here's how Contoso will run the migration:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="1a31f-275">**Step 1: Prepare a cluster**: Create a cluster for deploying two SQL Server VM nodes in Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-275">**Step 1: Prepare a cluster**: Create a cluster for deploying two SQL Server VM nodes in Azure.</span></span>
> * <span data-ttu-id="1a31f-276">**Step 2: Deploy and set up the cluster**: Prepare an Azure SQL Server cluster.</span><span class="sxs-lookup"><span data-stu-id="1a31f-276">**Step 2: Deploy and set up the cluster**: Prepare an Azure SQL Server cluster.</span></span>  <span data-ttu-id="1a31f-277">Databases are migrated into this pre-created cluster.</span><span class="sxs-lookup"><span data-stu-id="1a31f-277">Databases are migrated into this pre-created cluster.</span></span>
> * <span data-ttu-id="1a31f-278">**Step 3: Deploy the load balancer**: Deploy a load balancer to balance traffic to the SQL Server nodes.</span><span class="sxs-lookup"><span data-stu-id="1a31f-278">**Step 3: Deploy the load balancer**: Deploy a load balancer to balance traffic to the SQL Server nodes.</span></span>
> * <span data-ttu-id="1a31f-279">**Step 4: Prepare Azure for Site Recovery**: Create an Azure storage account to hold replicated data, and a Recovery Services vault.</span><span class="sxs-lookup"><span data-stu-id="1a31f-279">**Step 4: Prepare Azure for Site Recovery**: Create an Azure storage account to hold replicated data, and a Recovery Services vault.</span></span> 
> * <span data-ttu-id="1a31f-280">**Step 5: Prepare on-premises VMware for Site Recovery**: Prepare accounts for VM discovery and agent installation.</span><span class="sxs-lookup"><span data-stu-id="1a31f-280">**Step 5: Prepare on-premises VMware for Site Recovery**: Prepare accounts for VM discovery and agent installation.</span></span> <span data-ttu-id="1a31f-281">Prepare on-premises VMs so that users can connect to Azure VMs after m;migration.</span><span class="sxs-lookup"><span data-stu-id="1a31f-281">Prepare on-premises VMs so that users can connect to Azure VMs after m;migration.</span></span>
> * <span data-ttu-id="1a31f-282">**Step 6: Replicate VMs**: Enable VM replication to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-282">**Step 6: Replicate VMs**: Enable VM replication to Azure.</span></span>
> * <span data-ttu-id="1a31f-283">**Step 7: Install DMA**: Download and install the Database Migration Assistant.</span><span class="sxs-lookup"><span data-stu-id="1a31f-283">**Step 7: Install DMA**: Download and install the Database Migration Assistant.</span></span>
> * <span data-ttu-id="1a31f-284">**Step 7: Migrate the database with DMA**: Migrate the database to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-284">**Step 7: Migrate the database with DMA**: Migrate the database to Azure.</span></span>
> * <span data-ttu-id="1a31f-285">**Step 9: Protect the database**: Create an Always On Availability Group for the cluster.</span><span class="sxs-lookup"><span data-stu-id="1a31f-285">**Step 9: Protect the database**: Create an Always On Availability Group for the cluster.</span></span>
> * <span data-ttu-id="1a31f-286">**Step 10: Migrate the web app VM**: Run a test failover to make sure everything's working as expected.</span><span class="sxs-lookup"><span data-stu-id="1a31f-286">**Step 10: Migrate the web app VM**: Run a test failover to make sure everything's working as expected.</span></span> <span data-ttu-id="1a31f-287">Then run a full failover to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-287">Then run a full failover to Azure.</span></span> 


## <a name="step-1-prepare-a-sql-server-alwayson-availability-group-cluster"></a><span data-ttu-id="1a31f-288">Step 1: Prepare a SQL Server AlwaysOn availability group cluster</span><span class="sxs-lookup"><span data-stu-id="1a31f-288">Step 1: Prepare a SQL Server AlwaysOn availability group cluster</span></span>

<span data-ttu-id="1a31f-289">Contoso admins set up the cluster as follows:</span><span class="sxs-lookup"><span data-stu-id="1a31f-289">Contoso admins set up the cluster as follows:</span></span>

1. <span data-ttu-id="1a31f-290">They create two SQL Server VMs by selecting SQL Server 2017 Enterprise Windows Server 2016 image in the Azure Marketplace.</span><span class="sxs-lookup"><span data-stu-id="1a31f-290">They create two SQL Server VMs by selecting SQL Server 2017 Enterprise Windows Server 2016 image in the Azure Marketplace.</span></span> 

    ![SQL VM SKU](media/contoso-migration-rehost-vm-sql-ag/sql-vm-sku.png)

2. <span data-ttu-id="1a31f-292">In the **Create virtual machine Wizard** > **Basics**, they configure:</span><span class="sxs-lookup"><span data-stu-id="1a31f-292">In the **Create virtual machine Wizard** > **Basics**, they configure:</span></span>

    - <span data-ttu-id="1a31f-293">Names for the VMs: **SQLAOG1** and **SQLAOG2**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-293">Names for the VMs: **SQLAOG1** and **SQLAOG2**.</span></span>
    - <span data-ttu-id="1a31f-294">Since machines are business-critical, they enable SSD for the VM disk type.</span><span class="sxs-lookup"><span data-stu-id="1a31f-294">Since machines are business-critical, they enable SSD for the VM disk type.</span></span>
    - <span data-ttu-id="1a31f-295">They specify machine credentials.</span><span class="sxs-lookup"><span data-stu-id="1a31f-295">They specify machine credentials.</span></span>
    - <span data-ttu-id="1a31f-296">They deploy the VMs in the primary EAST US 2 region, in the ContosoRG resource group.</span><span class="sxs-lookup"><span data-stu-id="1a31f-296">They deploy the VMs in the primary EAST US 2 region, in the ContosoRG resource group.</span></span>

3. <span data-ttu-id="1a31f-297">In **Size**, they start with D2s_V3 SKU for both VMs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-297">In **Size**, they start with D2s_V3 SKU for both VMs.</span></span> <span data-ttu-id="1a31f-298">They'll scale later as they need to.</span><span class="sxs-lookup"><span data-stu-id="1a31f-298">They'll scale later as they need to.</span></span>
4. <span data-ttu-id="1a31f-299">In **Settings**, they do the following:</span><span class="sxs-lookup"><span data-stu-id="1a31f-299">In **Settings**, they do the following:</span></span>

    - <span data-ttu-id="1a31f-300">Since these VMs are critical databases for the app, they use managed disks.</span><span class="sxs-lookup"><span data-stu-id="1a31f-300">Since these VMs are critical databases for the app, they use managed disks.</span></span>
    - <span data-ttu-id="1a31f-301">They place the machines in the production network of the EAST US 2 primary region (**VNET-PROD-EUS2**), in the database subnet (**PROD-DB-EUS2**).</span><span class="sxs-lookup"><span data-stu-id="1a31f-301">They place the machines in the production network of the EAST US 2 primary region (**VNET-PROD-EUS2**), in the database subnet (**PROD-DB-EUS2**).</span></span>
    - <span data-ttu-id="1a31f-302">They create a new availability set: **SQLAOGAVSET**, with two fault domains and five update domains.</span><span class="sxs-lookup"><span data-stu-id="1a31f-302">They create a new availability set: **SQLAOGAVSET**, with two fault domains and five update domains.</span></span>

    ![SQL VM](media/contoso-migration-rehost-vm-sql-ag/sql-vm-settings.png)

4. <span data-ttu-id="1a31f-304">In **SQL Server settings**, they limit SQL connectivity to the virtual network (private), on default port 1433.</span><span class="sxs-lookup"><span data-stu-id="1a31f-304">In **SQL Server settings**, they limit SQL connectivity to the virtual network (private), on default port 1433.</span></span> <span data-ttu-id="1a31f-305">For authentication they use the same credentials as they use onsite (**contosoadmin**).</span><span class="sxs-lookup"><span data-stu-id="1a31f-305">For authentication they use the same credentials as they use onsite (**contosoadmin**).</span></span>

    ![SQL VM](media/contoso-migration-rehost-vm-sql-ag/sql-vm-db.png)

<span data-ttu-id="1a31f-307">**Need more help?**</span><span class="sxs-lookup"><span data-stu-id="1a31f-307">**Need more help?**</span></span>

- <span data-ttu-id="1a31f-308">[Get help](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision#1-configure-basic-settings) provisioning a SQL Server VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-308">[Get help](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision#1-configure-basic-settings) provisioning a SQL Server VM.</span></span>
- <span data-ttu-id="1a31f-309">[Learn about](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-prereq#create-sql-server-vms) configuring VMs for different SQL Server SKUs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-309">[Learn about](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-prereq#create-sql-server-vms) configuring VMs for different SQL Server SKUs.</span></span>

## <a name="step-2-deploy-and-set-up-the-cluster"></a><span data-ttu-id="1a31f-310">Step 2: Deploy and set up the cluster</span><span class="sxs-lookup"><span data-stu-id="1a31f-310">Step 2: Deploy and set up the cluster</span></span>

<span data-ttu-id="1a31f-311">Here's how Contoso admins set up the cluster:</span><span class="sxs-lookup"><span data-stu-id="1a31f-311">Here's how Contoso admins set up the cluster:</span></span>

1. <span data-ttu-id="1a31f-312">They set up an Azure storage account to act as the cloud witness.</span><span class="sxs-lookup"><span data-stu-id="1a31f-312">They set up an Azure storage account to act as the cloud witness.</span></span>
2. <span data-ttu-id="1a31f-313">They add the SQL Server VMs to the Active Directory domain in the Contoso on-premises datacenter.</span><span class="sxs-lookup"><span data-stu-id="1a31f-313">They add the SQL Server VMs to the Active Directory domain in the Contoso on-premises datacenter.</span></span>
3. <span data-ttu-id="1a31f-314">They create the cluster in Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-314">They create the cluster in Azure.</span></span>
4. <span data-ttu-id="1a31f-315">They configure the cloud witness.</span><span class="sxs-lookup"><span data-stu-id="1a31f-315">They configure the cloud witness.</span></span>
5. <span data-ttu-id="1a31f-316">Lastly, they enable SQL Always On availability groups.</span><span class="sxs-lookup"><span data-stu-id="1a31f-316">Lastly, they enable SQL Always On availability groups.</span></span>

### <a name="set-up-a-storage-account-as-cloud-witness"></a><span data-ttu-id="1a31f-317">Set up a storage account as cloud witness</span><span class="sxs-lookup"><span data-stu-id="1a31f-317">Set up a storage account as cloud witness</span></span>

<span data-ttu-id="1a31f-318">To set up a cloud witness, Contoso needs an Azure Storage account that will hold the blob file used for cluster arbitration.</span><span class="sxs-lookup"><span data-stu-id="1a31f-318">To set up a cloud witness, Contoso needs an Azure Storage account that will hold the blob file used for cluster arbitration.</span></span> <span data-ttu-id="1a31f-319">The same storage account can be used to set up cloud witness for multiple  clusters.</span><span class="sxs-lookup"><span data-stu-id="1a31f-319">The same storage account can be used to set up cloud witness for multiple  clusters.</span></span> 

<span data-ttu-id="1a31f-320">Contoso admins create a storage account as follows:</span><span class="sxs-lookup"><span data-stu-id="1a31f-320">Contoso admins create a storage account as follows:</span></span>

1. <span data-ttu-id="1a31f-321">They specify a recognizable name for the account (**contosocloudwitness**).</span><span class="sxs-lookup"><span data-stu-id="1a31f-321">They specify a recognizable name for the account (**contosocloudwitness**).</span></span>
2. <span data-ttu-id="1a31f-322">They deploy a general all-purpose account, with LRS.</span><span class="sxs-lookup"><span data-stu-id="1a31f-322">They deploy a general all-purpose account, with LRS.</span></span>
3. <span data-ttu-id="1a31f-323">They place the account in a third region - South Central US.</span><span class="sxs-lookup"><span data-stu-id="1a31f-323">They place the account in a third region - South Central US.</span></span> <span data-ttu-id="1a31f-324">They place it outside the primary and secondary region so that it remains available in case of regional failure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-324">They place it outside the primary and secondary region so that it remains available in case of regional failure.</span></span>
4. <span data-ttu-id="1a31f-325">They place it in their resource group that holds infrastructure resources - **ContosoInfraRG**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-325">They place it in their resource group that holds infrastructure resources - **ContosoInfraRG**.</span></span>

    ![Cloud witness](media/contoso-migration-rehost-vm-sql-ag/witness-storage.png)

5. <span data-ttu-id="1a31f-327">When they create the storage account, primary and secondary access keys are generated for it.</span><span class="sxs-lookup"><span data-stu-id="1a31f-327">When they create the storage account, primary and secondary access keys are generated for it.</span></span> <span data-ttu-id="1a31f-328">They need the primary access key to create the cloud witness.</span><span class="sxs-lookup"><span data-stu-id="1a31f-328">They need the primary access key to create the cloud witness.</span></span> <span data-ttu-id="1a31f-329">The key appears under the storage account name > **Access Keys**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-329">The key appears under the storage account name > **Access Keys**.</span></span>

    ![Access key](media/contoso-migration-rehost-vm-sql-ag/access-key.png)

### <a name="add-sql-server-vms-to-contoso-domain"></a><span data-ttu-id="1a31f-331">Add SQL Server VMs to Contoso domain</span><span class="sxs-lookup"><span data-stu-id="1a31f-331">Add SQL Server VMs to Contoso domain</span></span>

1. <span data-ttu-id="1a31f-332">Contoso adds SQLAOG1 and SQLAOG2 to contoso.com domain.</span><span class="sxs-lookup"><span data-stu-id="1a31f-332">Contoso adds SQLAOG1 and SQLAOG2 to contoso.com domain.</span></span>
2. <span data-ttu-id="1a31f-333">Then, on each VM they install the Windows Failover Cluster Feature and Tools.</span><span class="sxs-lookup"><span data-stu-id="1a31f-333">Then, on each VM they install the Windows Failover Cluster Feature and Tools.</span></span>

### <a name="set-up-the-cluster"></a><span data-ttu-id="1a31f-334">Set up the cluster</span><span class="sxs-lookup"><span data-stu-id="1a31f-334">Set up the cluster</span></span>

<span data-ttu-id="1a31f-335">Before setting up the cluster, Contoso admins take a snapshot of the OS disk on each machine.</span><span class="sxs-lookup"><span data-stu-id="1a31f-335">Before setting up the cluster, Contoso admins take a snapshot of the OS disk on each machine.</span></span>

![snapshot](media/contoso-migration-rehost-vm-sql-ag/snapshot.png)

2. <span data-ttu-id="1a31f-337">Then, they run a script they've put together to create the Windows Failover Cluster.</span><span class="sxs-lookup"><span data-stu-id="1a31f-337">Then, they run a script they've put together to create the Windows Failover Cluster.</span></span>

    ![Create cluster](media/contoso-migration-rehost-vm-sql-ag/create-cluster1.png)

3. <span data-ttu-id="1a31f-339">After they've created the cluster, they verify that the VMs appear as cluster nodes.</span><span class="sxs-lookup"><span data-stu-id="1a31f-339">After they've created the cluster, they verify that the VMs appear as cluster nodes.</span></span>

     ![Create cluster](media/contoso-migration-rehost-vm-sql-ag/create-cluster2.png)

## <a name="configure-the-cloud-witness"></a><span data-ttu-id="1a31f-341">Configure the cloud witness</span><span class="sxs-lookup"><span data-stu-id="1a31f-341">Configure the cloud witness</span></span>

1. <span data-ttu-id="1a31f-342">Contoso admins configure the cloud witness using the **Quorum Configuration Wizard** in Failover Cluster Manager.</span><span class="sxs-lookup"><span data-stu-id="1a31f-342">Contoso admins configure the cloud witness using the **Quorum Configuration Wizard** in Failover Cluster Manager.</span></span>
2. <span data-ttu-id="1a31f-343">In the wizard they select to create a cloud witness with the storage account.</span><span class="sxs-lookup"><span data-stu-id="1a31f-343">In the wizard they select to create a cloud witness with the storage account.</span></span>
3. <span data-ttu-id="1a31f-344">After the cloud witness is configured, in appears in the Failover Cluster Manager snap-in.</span><span class="sxs-lookup"><span data-stu-id="1a31f-344">After the cloud witness is configured, in appears in the Failover Cluster Manager snap-in.</span></span>

    ![Cloud witness](media/contoso-migration-rehost-vm-sql-ag/cloud-witness.png)
            

### <a name="enable-sql-server-always-on-availability-groups"></a><span data-ttu-id="1a31f-346">Enable SQL Server Always On availability groups</span><span class="sxs-lookup"><span data-stu-id="1a31f-346">Enable SQL Server Always On availability groups</span></span>

<span data-ttu-id="1a31f-347">Contoso admins can now enable Always On:</span><span class="sxs-lookup"><span data-stu-id="1a31f-347">Contoso admins can now enable Always On:</span></span>

1. <span data-ttu-id="1a31f-348">In SQL Server Configuration Manager, they enable **AlwaysOn Availability Groups** for the **SQL Server (MSSQLSERVER)** service.</span><span class="sxs-lookup"><span data-stu-id="1a31f-348">In SQL Server Configuration Manager, they enable **AlwaysOn Availability Groups** for the **SQL Server (MSSQLSERVER)** service.</span></span>

    ![Enable AlwaysOn](media/contoso-migration-rehost-vm-sql-ag/enable-alwayson.png)

2. <span data-ttu-id="1a31f-350">They restart the service for changes to take effect.</span><span class="sxs-lookup"><span data-stu-id="1a31f-350">They restart the service for changes to take effect.</span></span>

<span data-ttu-id="1a31f-351">With AlwaysOn enable, Contoso can set up the AlwaysOn availability group that will protect the SmartHotel360 database.</span><span class="sxs-lookup"><span data-stu-id="1a31f-351">With AlwaysOn enable, Contoso can set up the AlwaysOn availability group that will protect the SmartHotel360 database.</span></span>

<span data-ttu-id="1a31f-352">**Need more help?**</span><span class="sxs-lookup"><span data-stu-id="1a31f-352">**Need more help?**</span></span>

- <span data-ttu-id="1a31f-353">[Read about](https://docs.microsoft.com/windows-server/failover-clustering/deploy-cloud-witness) cloud witness and setting up a storage account for it.</span><span class="sxs-lookup"><span data-stu-id="1a31f-353">[Read about](https://docs.microsoft.com/windows-server/failover-clustering/deploy-cloud-witness) cloud witness and setting up a storage account for it.</span></span>
- <span data-ttu-id="1a31f-354">[Get instructions](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial) for setting up a cluster and creating an availability group.</span><span class="sxs-lookup"><span data-stu-id="1a31f-354">[Get instructions](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial) for setting up a cluster and creating an availability group.</span></span>

## <a name="step-3-deploy-the-azure-load-balancer"></a><span data-ttu-id="1a31f-355">Step 3: Deploy the Azure Load Balancer</span><span class="sxs-lookup"><span data-stu-id="1a31f-355">Step 3: Deploy the Azure Load Balancer</span></span>

<span data-ttu-id="1a31f-356">Contoso admins now want to deploy an internal load balancer that sits in front of the cluster nodes.</span><span class="sxs-lookup"><span data-stu-id="1a31f-356">Contoso admins now want to deploy an internal load balancer that sits in front of the cluster nodes.</span></span> <span data-ttu-id="1a31f-357">The load balancer listens for traffic, and directs it to the appropriate node.</span><span class="sxs-lookup"><span data-stu-id="1a31f-357">The load balancer listens for traffic, and directs it to the appropriate node.</span></span>

![Load balancing](media/contoso-migration-rehost-vm-sql-ag/architecture-lb.png)

<span data-ttu-id="1a31f-359">They create the load balancer as follows:</span><span class="sxs-lookup"><span data-stu-id="1a31f-359">They create the load balancer as follows:</span></span>

1. <span data-ttu-id="1a31f-360">In Azure portal > **Networking** > **Load Balancer**, they set up a new internal load balancer: **ILB-PROD-DB-EUS2-SQLAOG**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-360">In Azure portal > **Networking** > **Load Balancer**, they set up a new internal load balancer: **ILB-PROD-DB-EUS2-SQLAOG**.</span></span>
2. <span data-ttu-id="1a31f-361">They place the load balancer in the production network **VNET-PROD-EUS2**, in the database subnet **PROD-DB-EUS2**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-361">They place the load balancer in the production network **VNET-PROD-EUS2**, in the database subnet **PROD-DB-EUS2**.</span></span>
3. <span data-ttu-id="1a31f-362">They assign it a static IP address: 10.245.40.100.</span><span class="sxs-lookup"><span data-stu-id="1a31f-362">They assign it a static IP address: 10.245.40.100.</span></span>
4. <span data-ttu-id="1a31f-363">As a networking element, they deploy the load balancer in the networking resource group **ContosoNetworkingRG**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-363">As a networking element, they deploy the load balancer in the networking resource group **ContosoNetworkingRG**.</span></span>

    ![Load balancing](media/contoso-migration-rehost-vm-sql-ag/lb-create.png)

<span data-ttu-id="1a31f-365">After the internal load balancer is deployed, they need to set it up.</span><span class="sxs-lookup"><span data-stu-id="1a31f-365">After the internal load balancer is deployed, they need to set it up.</span></span> <span data-ttu-id="1a31f-366">They create a backend address pool, set up a health probe, and configure a load balancing rule.</span><span class="sxs-lookup"><span data-stu-id="1a31f-366">They create a backend address pool, set up a health probe, and configure a load balancing rule.</span></span>

### <a name="add-a-backend-pool"></a><span data-ttu-id="1a31f-367">Add a backend pool</span><span class="sxs-lookup"><span data-stu-id="1a31f-367">Add a backend pool</span></span>

<span data-ttu-id="1a31f-368">To distribute traffic to the VMs in the cluster, Contoso admins set up a backend address pool that contains the IP addresses of the NICs for VMs that will receive network traffic from the load balancer.</span><span class="sxs-lookup"><span data-stu-id="1a31f-368">To distribute traffic to the VMs in the cluster, Contoso admins set up a backend address pool that contains the IP addresses of the NICs for VMs that will receive network traffic from the load balancer.</span></span>

1. <span data-ttu-id="1a31f-369">In the load balancer settings in the portal, Contoso add a backend pool: **ILB-PROD-DB-EUS-SQLAOG-BEPOOL**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-369">In the load balancer settings in the portal, Contoso add a backend pool: **ILB-PROD-DB-EUS-SQLAOG-BEPOOL**.</span></span>
2. <span data-ttu-id="1a31f-370">They associate the pool with availability set SQLAOGAVSET.</span><span class="sxs-lookup"><span data-stu-id="1a31f-370">They associate the pool with availability set SQLAOGAVSET.</span></span> <span data-ttu-id="1a31f-371">The VMs in the set (**SQLAOG1** and **SQLAOG2**) are added to the pool.</span><span class="sxs-lookup"><span data-stu-id="1a31f-371">The VMs in the set (**SQLAOG1** and **SQLAOG2**) are added to the pool.</span></span>

    ![Backend pool](media/contoso-migration-rehost-vm-sql-ag/backend-pool.png)

### <a name="create-a-health-probe"></a><span data-ttu-id="1a31f-373">Create a health probe</span><span class="sxs-lookup"><span data-stu-id="1a31f-373">Create a health probe</span></span>

<span data-ttu-id="1a31f-374">Contoso admins create a health probe so that the load balancer can monitor the app health.</span><span class="sxs-lookup"><span data-stu-id="1a31f-374">Contoso admins create a health probe so that the load balancer can monitor the app health.</span></span> <span data-ttu-id="1a31f-375">The probe dynamically adds or removes VMs from the load balancer rotation, based on how they respond to health checks.</span><span class="sxs-lookup"><span data-stu-id="1a31f-375">The probe dynamically adds or removes VMs from the load balancer rotation, based on how they respond to health checks.</span></span>

<span data-ttu-id="1a31f-376">They create the probe as follows:</span><span class="sxs-lookup"><span data-stu-id="1a31f-376">They create the probe as follows:</span></span> 

1. <span data-ttu-id="1a31f-377">In the load balancer settings in the portal, Contoso creates a health probe: **SQLAlwaysOnEndPointProbe**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-377">In the load balancer settings in the portal, Contoso creates a health probe: **SQLAlwaysOnEndPointProbe**.</span></span>
2. <span data-ttu-id="1a31f-378">They set the probe to monitor VMs on TCP port 59999.</span><span class="sxs-lookup"><span data-stu-id="1a31f-378">They set the probe to monitor VMs on TCP port 59999.</span></span>
3. <span data-ttu-id="1a31f-379">They set an interval of 5 seconds between probes, and a threshold of 2.</span><span class="sxs-lookup"><span data-stu-id="1a31f-379">They set an interval of 5 seconds between probes, and a threshold of 2.</span></span> <span data-ttu-id="1a31f-380">If two probes fail, the VM will be considered unhealthy.</span><span class="sxs-lookup"><span data-stu-id="1a31f-380">If two probes fail, the VM will be considered unhealthy.</span></span>

    ![Probe](media/contoso-migration-rehost-vm-sql-ag/nlb-probe.png)

### <a name="configure-the-load-balancer-to-receive-traffic"></a><span data-ttu-id="1a31f-382">Configure the load balancer to receive traffic</span><span class="sxs-lookup"><span data-stu-id="1a31f-382">Configure the load balancer to receive traffic</span></span>


<span data-ttu-id="1a31f-383">Now, Contoso admins set up a load balancer rule to define how traffic is distributed to the VMs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-383">Now, Contoso admins set up a load balancer rule to define how traffic is distributed to the VMs.</span></span>

- <span data-ttu-id="1a31f-384">The front-end IP address handles incoming traffic.</span><span class="sxs-lookup"><span data-stu-id="1a31f-384">The front-end IP address handles incoming traffic.</span></span>
- <span data-ttu-id="1a31f-385">The back-end IP pool receives the traffic.</span><span class="sxs-lookup"><span data-stu-id="1a31f-385">The back-end IP pool receives the traffic.</span></span>

<span data-ttu-id="1a31f-386">They create the rule as follows:</span><span class="sxs-lookup"><span data-stu-id="1a31f-386">They create the rule as follows:</span></span>

1. <span data-ttu-id="1a31f-387">In the load balancer settings in the portal, they add a new load balancing rule: **SQLAlwaysOnEndPointListener**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-387">In the load balancer settings in the portal, they add a new load balancing rule: **SQLAlwaysOnEndPointListener**.</span></span>
2. <span data-ttu-id="1a31f-388">They set a front-end listener to receive incoming SQL client traffic on TCP 1433.</span><span class="sxs-lookup"><span data-stu-id="1a31f-388">They set a front-end listener to receive incoming SQL client traffic on TCP 1433.</span></span>
3. <span data-ttu-id="1a31f-389">They specify the backend pool to which traffic will be routed, and the port on which VMs listen for traffic.</span><span class="sxs-lookup"><span data-stu-id="1a31f-389">They specify the backend pool to which traffic will be routed, and the port on which VMs listen for traffic.</span></span>
4. <span data-ttu-id="1a31f-390">They enable floating IP (direct server return).</span><span class="sxs-lookup"><span data-stu-id="1a31f-390">They enable floating IP (direct server return).</span></span> <span data-ttu-id="1a31f-391">This is always required for SQL AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="1a31f-391">This is always required for SQL AlwaysOn.</span></span>

    ![Probe](media/contoso-migration-rehost-vm-sql-ag/nlb-probe.png)

<span data-ttu-id="1a31f-393">**Need more help?**</span><span class="sxs-lookup"><span data-stu-id="1a31f-393">**Need more help?**</span></span>

- <span data-ttu-id="1a31f-394">[Get an overview](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview) of Azure Load Balancer.</span><span class="sxs-lookup"><span data-stu-id="1a31f-394">[Get an overview](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview) of Azure Load Balancer.</span></span>
- <span data-ttu-id="1a31f-395">[Learn about](https://docs.microsoft.com/azure/load-balancer/tutorial-load-balancer-basic-internal-portal) creating a load balancer.</span><span class="sxs-lookup"><span data-stu-id="1a31f-395">[Learn about](https://docs.microsoft.com/azure/load-balancer/tutorial-load-balancer-basic-internal-portal) creating a load balancer.</span></span>



## <a name="step-4-prepare-azure-for-the-site-recovery-service"></a><span data-ttu-id="1a31f-396">Step 4: Prepare Azure for the Site Recovery service</span><span class="sxs-lookup"><span data-stu-id="1a31f-396">Step 4: Prepare Azure for the Site Recovery service</span></span>

<span data-ttu-id="1a31f-397">Here are the Azure components Contoso needs to deploy Site Recovery:</span><span class="sxs-lookup"><span data-stu-id="1a31f-397">Here are the Azure components Contoso needs to deploy Site Recovery:</span></span>

- <span data-ttu-id="1a31f-398">A VNet in which VMs will be located when they're creating during failover.</span><span class="sxs-lookup"><span data-stu-id="1a31f-398">A VNet in which VMs will be located when they're creating during failover.</span></span>
- <span data-ttu-id="1a31f-399">An Azure storage account to hold replicated data.</span><span class="sxs-lookup"><span data-stu-id="1a31f-399">An Azure storage account to hold replicated data.</span></span> 
- <span data-ttu-id="1a31f-400">A Recovery Services vault in Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-400">A Recovery Services vault in Azure.</span></span>

<span data-ttu-id="1a31f-401">Contoso admins set these up as follows:</span><span class="sxs-lookup"><span data-stu-id="1a31f-401">Contoso admins set these up as follows:</span></span>

1.  <span data-ttu-id="1a31f-402">Contoso already created a network/subnet they can use for Site Recovery when they [deployed the Azure infrastructure](contoso-migration-rehost-vm-sql-ag.md).</span><span class="sxs-lookup"><span data-stu-id="1a31f-402">Contoso already created a network/subnet they can use for Site Recovery when they [deployed the Azure infrastructure](contoso-migration-rehost-vm-sql-ag.md).</span></span>

    - <span data-ttu-id="1a31f-403">The SmartHotel360 app is a production app, and WEBVM will be migrated to the Azure production network (VNET-PROD-EUS2) in the primary East US2 region.</span><span class="sxs-lookup"><span data-stu-id="1a31f-403">The SmartHotel360 app is a production app, and WEBVM will be migrated to the Azure production network (VNET-PROD-EUS2) in the primary East US2 region.</span></span>
    - <span data-ttu-id="1a31f-404">WEBVM will be placed in the ContosoRG resource group, which is used for production resources, and in the production subnet (PROD-FE-EUS2).</span><span class="sxs-lookup"><span data-stu-id="1a31f-404">WEBVM will be placed in the ContosoRG resource group, which is used for production resources, and in the production subnet (PROD-FE-EUS2).</span></span>

2. <span data-ttu-id="1a31f-405">Contoso admins create an Azure storage account (contosovmsacc20180528) in the primary region.</span><span class="sxs-lookup"><span data-stu-id="1a31f-405">Contoso admins create an Azure storage account (contosovmsacc20180528) in the primary region.</span></span>

    - <span data-ttu-id="1a31f-406">They use a general-purpose account, with standard storage, and LRS replication.</span><span class="sxs-lookup"><span data-stu-id="1a31f-406">They use a general-purpose account, with standard storage, and LRS replication.</span></span>
    - <span data-ttu-id="1a31f-407">The account must be in the same region as the vault.</span><span class="sxs-lookup"><span data-stu-id="1a31f-407">The account must be in the same region as the vault.</span></span>

    ![Site Recovery storage](media/contoso-migration-rehost-vm-sql-ag/asr-storage.png)

3. <span data-ttu-id="1a31f-409">With the network and storage account in place, they now create a Recovery Services vault (**ContosoMigrationVault**), and place it in the **ContosoFailoverRG** resource group, in the primary East US 2 region.</span><span class="sxs-lookup"><span data-stu-id="1a31f-409">With the network and storage account in place, they now create a Recovery Services vault (**ContosoMigrationVault**), and place it in the **ContosoFailoverRG** resource group, in the primary East US 2 region.</span></span>

    ![Recovery Services vault](media/contoso-migration-rehost-vm-sql-ag/asr-vault.png)

<span data-ttu-id="1a31f-411">**Need more help?**</span><span class="sxs-lookup"><span data-stu-id="1a31f-411">**Need more help?**</span></span>

<span data-ttu-id="1a31f-412">[Learn about](https://docs.microsoft.com/azure/site-recovery/tutorial-prepare-azure) setting up Azure for Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="1a31f-412">[Learn about](https://docs.microsoft.com/azure/site-recovery/tutorial-prepare-azure) setting up Azure for Site Recovery.</span></span>


## <a name="step-5-prepare-on-premises-vmware-for-site-recovery"></a><span data-ttu-id="1a31f-413">Step 5: Prepare on-premises VMware for Site Recovery</span><span class="sxs-lookup"><span data-stu-id="1a31f-413">Step 5: Prepare on-premises VMware for Site Recovery</span></span>

<span data-ttu-id="1a31f-414">Here's what Contoso admins prepare on-premises:</span><span class="sxs-lookup"><span data-stu-id="1a31f-414">Here's what Contoso admins prepare on-premises:</span></span>

- <span data-ttu-id="1a31f-415">An account on the vCenter server or vSphere ESXi host, to automate VM discovery.</span><span class="sxs-lookup"><span data-stu-id="1a31f-415">An account on the vCenter server or vSphere ESXi host, to automate VM discovery.</span></span>
- <span data-ttu-id="1a31f-416">An account that allows automatic installation of the Mobility service on VMware VMs that you want to replicate.</span><span class="sxs-lookup"><span data-stu-id="1a31f-416">An account that allows automatic installation of the Mobility service on VMware VMs that you want to replicate.</span></span>
- <span data-ttu-id="1a31f-417">On-premises VM settings, so that Contoso can connect to the replicated Azure VM after failover.</span><span class="sxs-lookup"><span data-stu-id="1a31f-417">On-premises VM settings, so that Contoso can connect to the replicated Azure VM after failover.</span></span>


### <a name="prepare-an-account-for-automatic-discovery"></a><span data-ttu-id="1a31f-418">Prepare an account for automatic discovery</span><span class="sxs-lookup"><span data-stu-id="1a31f-418">Prepare an account for automatic discovery</span></span>

<span data-ttu-id="1a31f-419">Site Recovery needs access to VMware servers to:</span><span class="sxs-lookup"><span data-stu-id="1a31f-419">Site Recovery needs access to VMware servers to:</span></span>

- <span data-ttu-id="1a31f-420">Automatically discover VMs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-420">Automatically discover VMs.</span></span> 
- <span data-ttu-id="1a31f-421">Orchestrate replication, failover, and failback.</span><span class="sxs-lookup"><span data-stu-id="1a31f-421">Orchestrate replication, failover, and failback.</span></span>
- <span data-ttu-id="1a31f-422">At least a read-only account is required.</span><span class="sxs-lookup"><span data-stu-id="1a31f-422">At least a read-only account is required.</span></span> <span data-ttu-id="1a31f-423">You need an account that can run operations such as creating and removing disks, and turning on VMs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-423">You need an account that can run operations such as creating and removing disks, and turning on VMs.</span></span>

<span data-ttu-id="1a31f-424">Contoso admins set up the account as follows:</span><span class="sxs-lookup"><span data-stu-id="1a31f-424">Contoso admins set up the account as follows:</span></span>

1. <span data-ttu-id="1a31f-425">They create a role at the vCenter level.</span><span class="sxs-lookup"><span data-stu-id="1a31f-425">They create a role at the vCenter level.</span></span>
2. <span data-ttu-id="1a31f-426">They then assign that role the required permissions.</span><span class="sxs-lookup"><span data-stu-id="1a31f-426">They then assign that role the required permissions.</span></span>



### <a name="prepare-an-account-for-mobility-service-installation"></a><span data-ttu-id="1a31f-427">Prepare an account for Mobility service installation</span><span class="sxs-lookup"><span data-stu-id="1a31f-427">Prepare an account for Mobility service installation</span></span>

<span data-ttu-id="1a31f-428">The Mobility service must be installed on each VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-428">The Mobility service must be installed on each VM.</span></span>

- <span data-ttu-id="1a31f-429">Site Recovery can do an automatic push installation of this component when replication is enabled for the VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-429">Site Recovery can do an automatic push installation of this component when replication is enabled for the VM.</span></span>
- <span data-ttu-id="1a31f-430">You need an account that Site Recovery can use to access the VM for the push installation.</span><span class="sxs-lookup"><span data-stu-id="1a31f-430">You need an account that Site Recovery can use to access the VM for the push installation.</span></span> <span data-ttu-id="1a31f-431">You specify this account when you set up replication in the Azure console.</span><span class="sxs-lookup"><span data-stu-id="1a31f-431">You specify this account when you set up replication in the Azure console.</span></span>
- <span data-ttu-id="1a31f-432">The account can be domain or local, with permissions to install on the VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-432">The account can be domain or local, with permissions to install on the VM.</span></span>




### <a name="prepare-to-connect-to-azure-vms-after-failover"></a><span data-ttu-id="1a31f-433">Prepare to connect to Azure VMs after failover</span><span class="sxs-lookup"><span data-stu-id="1a31f-433">Prepare to connect to Azure VMs after failover</span></span>

<span data-ttu-id="1a31f-434">After failover, Contoso wants to be able to connect to Azure VMs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-434">After failover, Contoso wants to be able to connect to Azure VMs.</span></span> <span data-ttu-id="1a31f-435">To do this, Contoso admins do the following before migration:</span><span class="sxs-lookup"><span data-stu-id="1a31f-435">To do this, Contoso admins do the following before migration:</span></span>

1. <span data-ttu-id="1a31f-436">For access over the internet they:</span><span class="sxs-lookup"><span data-stu-id="1a31f-436">For access over the internet they:</span></span>

 - <span data-ttu-id="1a31f-437">Enable RDP on the on-premises VM before failover</span><span class="sxs-lookup"><span data-stu-id="1a31f-437">Enable RDP on the on-premises VM before failover</span></span>
 - <span data-ttu-id="1a31f-438">Ensure that TCP and UDP rules are added for the **Public** profile.</span><span class="sxs-lookup"><span data-stu-id="1a31f-438">Ensure that TCP and UDP rules are added for the **Public** profile.</span></span>
 - <span data-ttu-id="1a31f-439">Check that RDP is allowed in **Windows Firewall** > **Allowed Apps** for all profiles.</span><span class="sxs-lookup"><span data-stu-id="1a31f-439">Check that RDP is allowed in **Windows Firewall** > **Allowed Apps** for all profiles.</span></span>
 
2. <span data-ttu-id="1a31f-440">For access over site-to-site VPN, they:</span><span class="sxs-lookup"><span data-stu-id="1a31f-440">For access over site-to-site VPN, they:</span></span>

 - <span data-ttu-id="1a31f-441">Enable RDP on the on-premises machine.</span><span class="sxs-lookup"><span data-stu-id="1a31f-441">Enable RDP on the on-premises machine.</span></span>
 - <span data-ttu-id="1a31f-442">Allow RDP in the **Windows Firewall** -> **Allowed apps and features**, for **Domain and Private** networks.</span><span class="sxs-lookup"><span data-stu-id="1a31f-442">Allow RDP in the **Windows Firewall** -> **Allowed apps and features**, for **Domain and Private** networks.</span></span>
 - <span data-ttu-id="1a31f-443">Set the operating system's SAN policy on the on-premises VM to **OnlineAll**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-443">Set the operating system's SAN policy on the on-premises VM to **OnlineAll**.</span></span>

<span data-ttu-id="1a31f-444">In addition, when they run a failover they need to check the following:</span><span class="sxs-lookup"><span data-stu-id="1a31f-444">In addition, when they run a failover they need to check the following:</span></span>

- <span data-ttu-id="1a31f-445">There should be no Windows updates pending on the VM when triggering a failover.</span><span class="sxs-lookup"><span data-stu-id="1a31f-445">There should be no Windows updates pending on the VM when triggering a failover.</span></span> <span data-ttu-id="1a31f-446">If there are, users won't be able to log into the VM until the update completes.</span><span class="sxs-lookup"><span data-stu-id="1a31f-446">If there are, users won't be able to log into the VM until the update completes.</span></span>
- <span data-ttu-id="1a31f-447">After failover, they can check **Boot diagnostics** to view a screenshot of the VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-447">After failover, they can check **Boot diagnostics** to view a screenshot of the VM.</span></span> <span data-ttu-id="1a31f-448">If this doesn't work, they should verify that the VM is running, and review these [troubleshooting tips](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).</span><span class="sxs-lookup"><span data-stu-id="1a31f-448">If this doesn't work, they should verify that the VM is running, and review these [troubleshooting tips](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).</span></span>


<span data-ttu-id="1a31f-449">**Need more help?**</span><span class="sxs-lookup"><span data-stu-id="1a31f-449">**Need more help?**</span></span>

- <span data-ttu-id="1a31f-450">[Learn about](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-automatic-discovery) creating and assigning a role for automatic discovery.</span><span class="sxs-lookup"><span data-stu-id="1a31f-450">[Learn about](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-automatic-discovery) creating and assigning a role for automatic discovery.</span></span>
- <span data-ttu-id="1a31f-451">[Learn about](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-mobility-service-installation) creating an account for push installation of the Mobility service.</span><span class="sxs-lookup"><span data-stu-id="1a31f-451">[Learn about](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-mobility-service-installation) creating an account for push installation of the Mobility service.</span></span>


## <a name="step-6-replicate-the-on-premises-vms-to-azure-with-site-recovery"></a><span data-ttu-id="1a31f-452">Step 6: Replicate the on-premises VMs to Azure with Site Recovery</span><span class="sxs-lookup"><span data-stu-id="1a31f-452">Step 6: Replicate the on-premises VMs to Azure with Site Recovery</span></span>

<span data-ttu-id="1a31f-453">Before they can run a migration to Azure, Contoso admins need to set up and enable replication.</span><span class="sxs-lookup"><span data-stu-id="1a31f-453">Before they can run a migration to Azure, Contoso admins need to set up and enable replication.</span></span>

### <a name="set-a-replication-goal"></a><span data-ttu-id="1a31f-454">Set a replication goal</span><span class="sxs-lookup"><span data-stu-id="1a31f-454">Set a replication goal</span></span>

1. <span data-ttu-id="1a31f-455">In the vault, under the vault name (ContosoVMVault) they select a replication goal (**Getting Started** > **Site Recovery** > **Prepare infrastructure**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-455">In the vault, under the vault name (ContosoVMVault) they select a replication goal (**Getting Started** > **Site Recovery** > **Prepare infrastructure**.</span></span>
2. <span data-ttu-id="1a31f-456">They specify that their machines are located on-premises, running on VMware, and replicating to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-456">They specify that their machines are located on-premises, running on VMware, and replicating to Azure.</span></span>

    ![Replication goal](./media/contoso-migration-rehost-vm-sql-ag/replication-goal.png)

### <a name="confirm-deployment-planning"></a><span data-ttu-id="1a31f-458">Confirm deployment planning</span><span class="sxs-lookup"><span data-stu-id="1a31f-458">Confirm deployment planning</span></span>

<span data-ttu-id="1a31f-459">To continue, they need to confirm that they have completed deployment planning, by selecting **Yes, I have done it**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-459">To continue, they need to confirm that they have completed deployment planning, by selecting **Yes, I have done it**.</span></span> <span data-ttu-id="1a31f-460">In this scenario Contoso are only migrating a VM, and don't need deployment planning.</span><span class="sxs-lookup"><span data-stu-id="1a31f-460">In this scenario Contoso are only migrating a VM, and don't need deployment planning.</span></span>

### <a name="set-up-the-source-environment"></a><span data-ttu-id="1a31f-461">Set up the source environment</span><span class="sxs-lookup"><span data-stu-id="1a31f-461">Set up the source environment</span></span>

<span data-ttu-id="1a31f-462">Contoso admins need to configure their source environment.</span><span class="sxs-lookup"><span data-stu-id="1a31f-462">Contoso admins need to configure their source environment.</span></span> <span data-ttu-id="1a31f-463">To do this, they download an OVF template and use it to deploy the Site Recovery configuration server as a highly available, on-premises VMware VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-463">To do this, they download an OVF template and use it to deploy the Site Recovery configuration server as a highly available, on-premises VMware VM.</span></span> <span data-ttu-id="1a31f-464">After the configuration server is up and running, they register it in the vault.</span><span class="sxs-lookup"><span data-stu-id="1a31f-464">After the configuration server is up and running, they register it in the vault.</span></span>

<span data-ttu-id="1a31f-465">The configuration server runs a number of components:</span><span class="sxs-lookup"><span data-stu-id="1a31f-465">The configuration server runs a number of components:</span></span>

- <span data-ttu-id="1a31f-466">The configuration server component that coordinates communications between on-premises and Azure and manages data replication.</span><span class="sxs-lookup"><span data-stu-id="1a31f-466">The configuration server component that coordinates communications between on-premises and Azure and manages data replication.</span></span>
- <span data-ttu-id="1a31f-467">The process server that acts as a replication gateway.</span><span class="sxs-lookup"><span data-stu-id="1a31f-467">The process server that acts as a replication gateway.</span></span> <span data-ttu-id="1a31f-468">It receives replication data; optimizes it with caching, compression, and encryption; and sends it to Azure storage.</span><span class="sxs-lookup"><span data-stu-id="1a31f-468">It receives replication data; optimizes it with caching, compression, and encryption; and sends it to Azure storage.</span></span>
- <span data-ttu-id="1a31f-469">The process server also installs Mobility Service on VMs you want to replicate and performs automatic discovery of on-premises VMware VMs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-469">The process server also installs Mobility Service on VMs you want to replicate and performs automatic discovery of on-premises VMware VMs.</span></span>

<span data-ttu-id="1a31f-470">Contoso admins perform these steps as follows:</span><span class="sxs-lookup"><span data-stu-id="1a31f-470">Contoso admins perform these steps as follows:</span></span>


1. <span data-ttu-id="1a31f-471">In the vault, they download the OVF template from **Prepare Infrastructure** > **Source** > **Configuration Server**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-471">In the vault, they download the OVF template from **Prepare Infrastructure** > **Source** > **Configuration Server**.</span></span>
    
    ![Download OVF](./media/contoso-migration-rehost-vm-sql-ag/add-cs.png)

2. <span data-ttu-id="1a31f-473">They import the template into VMware to create and deploy the VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-473">They import the template into VMware to create and deploy the VM.</span></span>

    ![OVF template](./media/contoso-migration-rehost-vm-sql-ag/vcenter-wizard.png)

3. <span data-ttu-id="1a31f-475">When they turn on the VM for the first time, it boots up into a Windows Server 2016 installation experience.</span><span class="sxs-lookup"><span data-stu-id="1a31f-475">When they turn on the VM for the first time, it boots up into a Windows Server 2016 installation experience.</span></span> <span data-ttu-id="1a31f-476">They accept the license agreement, and enter an administrator password.</span><span class="sxs-lookup"><span data-stu-id="1a31f-476">They accept the license agreement, and enter an administrator password.</span></span>
4. <span data-ttu-id="1a31f-477">After the installation finishes, they sign in to the VM as the administrator.</span><span class="sxs-lookup"><span data-stu-id="1a31f-477">After the installation finishes, they sign in to the VM as the administrator.</span></span> <span data-ttu-id="1a31f-478">At first sign-in, the Azure Site Recovery Configuration Tool runs by default.</span><span class="sxs-lookup"><span data-stu-id="1a31f-478">At first sign-in, the Azure Site Recovery Configuration Tool runs by default.</span></span>
5. <span data-ttu-id="1a31f-479">In the tool, they specify a name to use for registering the configuration server in the vault.</span><span class="sxs-lookup"><span data-stu-id="1a31f-479">In the tool, they specify a name to use for registering the configuration server in the vault.</span></span>
6. <span data-ttu-id="1a31f-480">The tool checks that the VM can connect to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-480">The tool checks that the VM can connect to Azure.</span></span> <span data-ttu-id="1a31f-481">After the connection is established, they sign in to the Azure subscription.</span><span class="sxs-lookup"><span data-stu-id="1a31f-481">After the connection is established, they sign in to the Azure subscription.</span></span> <span data-ttu-id="1a31f-482">The credentials must have access to the vault in which you want to register the configuration server.</span><span class="sxs-lookup"><span data-stu-id="1a31f-482">The credentials must have access to the vault in which you want to register the configuration server.</span></span>

    ![Register configuration server](./media/contoso-migration-rehost-vm-sql-ag/config-server-register2.png)

7. <span data-ttu-id="1a31f-484">The tool performs some configuration tasks and then reboots.</span><span class="sxs-lookup"><span data-stu-id="1a31f-484">The tool performs some configuration tasks and then reboots.</span></span>
8. <span data-ttu-id="1a31f-485">They sign in to the machine again, and the Configuration Server Management Wizard starts automatically.</span><span class="sxs-lookup"><span data-stu-id="1a31f-485">They sign in to the machine again, and the Configuration Server Management Wizard starts automatically.</span></span>
9. <span data-ttu-id="1a31f-486">In the wizard, they select the NIC to receive replication traffic.</span><span class="sxs-lookup"><span data-stu-id="1a31f-486">In the wizard, they select the NIC to receive replication traffic.</span></span> <span data-ttu-id="1a31f-487">This setting can't be changed after it's configured.</span><span class="sxs-lookup"><span data-stu-id="1a31f-487">This setting can't be changed after it's configured.</span></span>
10. <span data-ttu-id="1a31f-488">They select the subscription, resource group, and vault in which to register the configuration server.</span><span class="sxs-lookup"><span data-stu-id="1a31f-488">They select the subscription, resource group, and vault in which to register the configuration server.</span></span>
        <span data-ttu-id="1a31f-489">![vault](./media/contoso-migration-rehost-vm-sql-ag/cswiz1.png)</span><span class="sxs-lookup"><span data-stu-id="1a31f-489">![vault](./media/contoso-migration-rehost-vm-sql-ag/cswiz1.png)</span></span> 

10. <span data-ttu-id="1a31f-490">They then download and install MySQL Server, and VMWare PowerCLI.</span><span class="sxs-lookup"><span data-stu-id="1a31f-490">They then download and install MySQL Server, and VMWare PowerCLI.</span></span> 
11. <span data-ttu-id="1a31f-491">After validation, they specify the FQDN or IP address of the vCenter server or vSphere host.</span><span class="sxs-lookup"><span data-stu-id="1a31f-491">After validation, they specify the FQDN or IP address of the vCenter server or vSphere host.</span></span> <span data-ttu-id="1a31f-492">They leave the default port, and specify a friendly name for the vCenter server.</span><span class="sxs-lookup"><span data-stu-id="1a31f-492">They leave the default port, and specify a friendly name for the vCenter server.</span></span>
12. <span data-ttu-id="1a31f-493">They specify the account that they created for automatic discovery, and the credentials that are used to automatically install the Mobility Service.</span><span class="sxs-lookup"><span data-stu-id="1a31f-493">They specify the account that they created for automatic discovery, and the credentials that are used to automatically install the Mobility Service.</span></span> <span data-ttu-id="1a31f-494">For Windows machines, the account needs local administrator privileges on the VMs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-494">For Windows machines, the account needs local administrator privileges on the VMs.</span></span>

    ![vCenter](./media/contoso-migration-rehost-vm-sql-ag/cswiz2.png)

7. <span data-ttu-id="1a31f-496">After registration finishes, in the Azure portal, they double check that the configuration server and VMware server are listed on the **Source** page in the vault.</span><span class="sxs-lookup"><span data-stu-id="1a31f-496">After registration finishes, in the Azure portal, they double check that the configuration server and VMware server are listed on the **Source** page in the vault.</span></span> <span data-ttu-id="1a31f-497">Discovery can take 15 minutes or more.</span><span class="sxs-lookup"><span data-stu-id="1a31f-497">Discovery can take 15 minutes or more.</span></span> 
8. <span data-ttu-id="1a31f-498">Site Recovery then connects to VMware servers using the specified settings, and discovers VMs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-498">Site Recovery then connects to VMware servers using the specified settings, and discovers VMs.</span></span>

### <a name="set-up-the-target"></a><span data-ttu-id="1a31f-499">Set up the target</span><span class="sxs-lookup"><span data-stu-id="1a31f-499">Set up the target</span></span>

<span data-ttu-id="1a31f-500">Now Contoso admins specify target replication settings.</span><span class="sxs-lookup"><span data-stu-id="1a31f-500">Now Contoso admins specify target replication settings.</span></span>

1. <span data-ttu-id="1a31f-501">In **Prepare infrastructure** > **Target**, they select the target settings.</span><span class="sxs-lookup"><span data-stu-id="1a31f-501">In **Prepare infrastructure** > **Target**, they select the target settings.</span></span>
2. <span data-ttu-id="1a31f-502">Site Recovery checks that there's an Azure storage account and network in the specified target.</span><span class="sxs-lookup"><span data-stu-id="1a31f-502">Site Recovery checks that there's an Azure storage account and network in the specified target.</span></span>

### <a name="create-a-replication-policy"></a><span data-ttu-id="1a31f-503">Create a replication policy</span><span class="sxs-lookup"><span data-stu-id="1a31f-503">Create a replication policy</span></span>

<span data-ttu-id="1a31f-504">Now, Contoso admins can create a replication policy.</span><span class="sxs-lookup"><span data-stu-id="1a31f-504">Now, Contoso admins can create a replication policy.</span></span>

1. <span data-ttu-id="1a31f-505">In  **Prepare infrastructure** > **Replication Settings** > **Replication Policy** >  **Create and Associate**, they create a policy **ContosoMigrationPolicy**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-505">In  **Prepare infrastructure** > **Replication Settings** > **Replication Policy** >  **Create and Associate**, they create a policy **ContosoMigrationPolicy**.</span></span>
2. <span data-ttu-id="1a31f-506">They use the default settings:</span><span class="sxs-lookup"><span data-stu-id="1a31f-506">They use the default settings:</span></span>
    - <span data-ttu-id="1a31f-507">**RPO threshold**: Default of 60 minutes.</span><span class="sxs-lookup"><span data-stu-id="1a31f-507">**RPO threshold**: Default of 60 minutes.</span></span> <span data-ttu-id="1a31f-508">This value defines how often recovery points are created.</span><span class="sxs-lookup"><span data-stu-id="1a31f-508">This value defines how often recovery points are created.</span></span> <span data-ttu-id="1a31f-509">An alert is generated if continuous replication exceeds this limit.</span><span class="sxs-lookup"><span data-stu-id="1a31f-509">An alert is generated if continuous replication exceeds this limit.</span></span>
    - <span data-ttu-id="1a31f-510">**Recovery point retention**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-510">**Recovery point retention**.</span></span> <span data-ttu-id="1a31f-511">Default of 24 hours.</span><span class="sxs-lookup"><span data-stu-id="1a31f-511">Default of 24 hours.</span></span> <span data-ttu-id="1a31f-512">This value specifies how long the retention window is for each recovery point.</span><span class="sxs-lookup"><span data-stu-id="1a31f-512">This value specifies how long the retention window is for each recovery point.</span></span> <span data-ttu-id="1a31f-513">Replicated VMs can be recovered to any point in a window.</span><span class="sxs-lookup"><span data-stu-id="1a31f-513">Replicated VMs can be recovered to any point in a window.</span></span>
    - <span data-ttu-id="1a31f-514">**App-consistent snapshot frequency**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-514">**App-consistent snapshot frequency**.</span></span> <span data-ttu-id="1a31f-515">Default of one hour.</span><span class="sxs-lookup"><span data-stu-id="1a31f-515">Default of one hour.</span></span> <span data-ttu-id="1a31f-516">This value specifies the frequency at which application-consistent snapshots are created.</span><span class="sxs-lookup"><span data-stu-id="1a31f-516">This value specifies the frequency at which application-consistent snapshots are created.</span></span>
 
        ![Create replication policy](./media/contoso-migration-rehost-vm-sql-ag/replication-policy.png)

5. <span data-ttu-id="1a31f-518">The policy is automatically associated with the configuration server.</span><span class="sxs-lookup"><span data-stu-id="1a31f-518">The policy is automatically associated with the configuration server.</span></span> 

    ![Associate replication policy](./media/contoso-migration-rehost-vm-sql-ag/replication-policy2.png)



### <a name="enable-replication"></a><span data-ttu-id="1a31f-520">Enable replication</span><span class="sxs-lookup"><span data-stu-id="1a31f-520">Enable replication</span></span>

<span data-ttu-id="1a31f-521">Now Contoso admins can start replicating WebVM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-521">Now Contoso admins can start replicating WebVM.</span></span>

1. <span data-ttu-id="1a31f-522">In **Replicate application** > **Source** > **+Replicate** they select the source settings.</span><span class="sxs-lookup"><span data-stu-id="1a31f-522">In **Replicate application** > **Source** > **+Replicate** they select the source settings.</span></span>
2. <span data-ttu-id="1a31f-523">They indicate that they want to enable VMs, select the vCenter server, and the configuration server.</span><span class="sxs-lookup"><span data-stu-id="1a31f-523">They indicate that they want to enable VMs, select the vCenter server, and the configuration server.</span></span>

    ![Enable replication](./media/contoso-migration-rehost-vm-sql-ag/enable-replication1.png)

3. <span data-ttu-id="1a31f-525">Now, they specify the target settings, including the resource group and VNet, and the storage account in which replicated data will be stored.</span><span class="sxs-lookup"><span data-stu-id="1a31f-525">Now, they specify the target settings, including the resource group and VNet, and the storage account in which replicated data will be stored.</span></span>

     ![Enable replication](./media/contoso-migration-rehost-vm-sql-ag/enable-replication2.png)

3. <span data-ttu-id="1a31f-527">They select the WebVM for replication, checks the replication policy, and enables replication.</span><span class="sxs-lookup"><span data-stu-id="1a31f-527">They select the WebVM for replication, checks the replication policy, and enables replication.</span></span> <span data-ttu-id="1a31f-528">Site Recovery installs the Mobility Service on the VM when replication is enabled.</span><span class="sxs-lookup"><span data-stu-id="1a31f-528">Site Recovery installs the Mobility Service on the VM when replication is enabled.</span></span>
 
    ![Enable replication](./media/contoso-migration-rehost-vm-sql-ag/enable-replication3.png)

4. <span data-ttu-id="1a31f-530">They track replication progress in **Jobs**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-530">They track replication progress in **Jobs**.</span></span> <span data-ttu-id="1a31f-531">After the **Finalize Protection** job runs, the machine is ready for failover.</span><span class="sxs-lookup"><span data-stu-id="1a31f-531">After the **Finalize Protection** job runs, the machine is ready for failover.</span></span>
5. <span data-ttu-id="1a31f-532">In **Essentials** in the Azure portal, they can see the structure for the VMs replicating to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-532">In **Essentials** in the Azure portal, they can see the structure for the VMs replicating to Azure.</span></span>

    ![Infrastructure view](./media/contoso-migration-rehost-vm-sql-ag/essentials.png)


<span data-ttu-id="1a31f-534">**Need more help?**</span><span class="sxs-lookup"><span data-stu-id="1a31f-534">**Need more help?**</span></span>

- <span data-ttu-id="1a31f-535">You can read a full walkthrough of all these steps in [Set up disaster recovery for on-premises VMware VMs](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial).</span><span class="sxs-lookup"><span data-stu-id="1a31f-535">You can read a full walkthrough of all these steps in [Set up disaster recovery for on-premises VMware VMs](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial).</span></span>
- <span data-ttu-id="1a31f-536">Detailed instructions are available to help you [set up the source environment](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-source), [deploy the configuration server](https://docs.microsoft.com/azure/site-recovery/vmware-azure-deploy-configuration-server), and [configure replication settings](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-replication).</span><span class="sxs-lookup"><span data-stu-id="1a31f-536">Detailed instructions are available to help you [set up the source environment](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-source), [deploy the configuration server](https://docs.microsoft.com/azure/site-recovery/vmware-azure-deploy-configuration-server), and [configure replication settings](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-replication).</span></span>
- <span data-ttu-id="1a31f-537">You can learn more about [enabling replication](https://docs.microsoft.com/azure/site-recovery/vmware-azure-enable-replication).</span><span class="sxs-lookup"><span data-stu-id="1a31f-537">You can learn more about [enabling replication](https://docs.microsoft.com/azure/site-recovery/vmware-azure-enable-replication).</span></span>


## <a name="step-7-install-the-database-migration-assistant-dma"></a><span data-ttu-id="1a31f-538">Step 7: Install the Database Migration Assistant (DMA)</span><span class="sxs-lookup"><span data-stu-id="1a31f-538">Step 7: Install the Database Migration Assistant (DMA)</span></span>

<span data-ttu-id="1a31f-539">Contoso admins will migrate the SmartHotel360 database to Azure VM **SQLAOG1** using the DMA.</span><span class="sxs-lookup"><span data-stu-id="1a31f-539">Contoso admins will migrate the SmartHotel360 database to Azure VM **SQLAOG1** using the DMA.</span></span> <span data-ttu-id="1a31f-540">They set up DMA as follows:</span><span class="sxs-lookup"><span data-stu-id="1a31f-540">They set up DMA as follows:</span></span>

1. <span data-ttu-id="1a31f-541">They download the tool from the [Microsoft Download Center](https://www.microsoft.com/download/details.aspx?id=53595) to the on-premises SQL Server VM (**SQLVM**).</span><span class="sxs-lookup"><span data-stu-id="1a31f-541">They download the tool from the [Microsoft Download Center](https://www.microsoft.com/download/details.aspx?id=53595) to the on-premises SQL Server VM (**SQLVM**).</span></span>
2. <span data-ttu-id="1a31f-542">They run setup (DownloadMigrationAssistant.msi) on the VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-542">They run setup (DownloadMigrationAssistant.msi) on the VM.</span></span>
3. <span data-ttu-id="1a31f-543">On the **Finish** page, they select **Launch Microsoft Data Migration Assistant** before finishing the wizard.</span><span class="sxs-lookup"><span data-stu-id="1a31f-543">On the **Finish** page, they select **Launch Microsoft Data Migration Assistant** before finishing the wizard.</span></span>

## <a name="step-8-migrate-the-database-with-dma"></a><span data-ttu-id="1a31f-544">Step 8: Migrate the database with DMA</span><span class="sxs-lookup"><span data-stu-id="1a31f-544">Step 8: Migrate the database with DMA</span></span>

1. <span data-ttu-id="1a31f-545">In the DMA they run a new migration - **SmartHotel**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-545">In the DMA they run a new migration - **SmartHotel**.</span></span>
2. <span data-ttu-id="1a31f-546">They select the **Target server type** as **SQL Server on Azure Virtual Machines**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-546">They select the **Target server type** as **SQL Server on Azure Virtual Machines**.</span></span> 

    ![DMA](media/contoso-migration-rehost-vm-sql-ag/dma-1.png)

3. <span data-ttu-id="1a31f-548">In the migration details, they add **SQLVM** as the source server, and **SQLAOG1** as the target.</span><span class="sxs-lookup"><span data-stu-id="1a31f-548">In the migration details, they add **SQLVM** as the source server, and **SQLAOG1** as the target.</span></span> <span data-ttu-id="1a31f-549">They specify credentials for each machine.</span><span class="sxs-lookup"><span data-stu-id="1a31f-549">They specify credentials for each machine.</span></span>

     ![DMA](media/contoso-migration-rehost-vm-sql-ag/dma-2.png)

4. <span data-ttu-id="1a31f-551">They create a local share for the database and configuration information.</span><span class="sxs-lookup"><span data-stu-id="1a31f-551">They create a local share for the database and configuration information.</span></span> <span data-ttu-id="1a31f-552">It must be accessible with write access by the SQL Service account on SQLVM and SQLAOG1.</span><span class="sxs-lookup"><span data-stu-id="1a31f-552">It must be accessible with write access by the SQL Service account on SQLVM and SQLAOG1.</span></span>

    ![DMA](media/contoso-migration-rehost-vm-sql-ag/dma-3.png)

5. <span data-ttu-id="1a31f-554">Contoso selects the logins that should be migrated, and starts the migration.</span><span class="sxs-lookup"><span data-stu-id="1a31f-554">Contoso selects the logins that should be migrated, and starts the migration.</span></span> <span data-ttu-id="1a31f-555">After it finishes, DMA shows the migration as successful.</span><span class="sxs-lookup"><span data-stu-id="1a31f-555">After it finishes, DMA shows the migration as successful.</span></span>

    ![DMA](media/contoso-migration-rehost-vm-sql-ag/dma-4.png)

6. <span data-ttu-id="1a31f-557">They verify that the database is running on **SQLAOG1**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-557">They verify that the database is running on **SQLAOG1**.</span></span>

    ![DMA](media/contoso-migration-rehost-vm-sql-ag/dma-5.png)

<span data-ttu-id="1a31f-559">DMS connects to the on-premises SQL Server VM across a site-to-site VPN connection between the Contoso datacenter and Azure, and then migrates the database.</span><span class="sxs-lookup"><span data-stu-id="1a31f-559">DMS connects to the on-premises SQL Server VM across a site-to-site VPN connection between the Contoso datacenter and Azure, and then migrates the database.</span></span>

## <a name="step-7-protect-the-database-with-alwayson"></a><span data-ttu-id="1a31f-560">Step 7: Protect the database with AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="1a31f-560">Step 7: Protect the database with AlwaysOn</span></span>

<span data-ttu-id="1a31f-561">With the app database running on **SQLAOG1**, Contoso admins can now protect it using AlwaysOn availability groups.</span><span class="sxs-lookup"><span data-stu-id="1a31f-561">With the app database running on **SQLAOG1**, Contoso admins can now protect it using AlwaysOn availability groups.</span></span> <span data-ttu-id="1a31f-562">They configure AlwaysOn using SQL Management Studio, and then assign a listener using Windows clustering.</span><span class="sxs-lookup"><span data-stu-id="1a31f-562">They configure AlwaysOn using SQL Management Studio, and then assign a listener using Windows clustering.</span></span> 

### <a name="create-an-alwayson-availability-group"></a><span data-ttu-id="1a31f-563">Create an AlwaysOn availability group</span><span class="sxs-lookup"><span data-stu-id="1a31f-563">Create an AlwaysOn availability group</span></span>

1. <span data-ttu-id="1a31f-564">In SQL Management Studio, they right-click on **Always on High Availability** to start the **New Availability Group Wizard**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-564">In SQL Management Studio, they right-click on **Always on High Availability** to start the **New Availability Group Wizard**.</span></span>
2. <span data-ttu-id="1a31f-565">In **Specify Options**, they name the availability group **SHAOG**.</span><span class="sxs-lookup"><span data-stu-id="1a31f-565">In **Specify Options**, they name the availability group **SHAOG**.</span></span> <span data-ttu-id="1a31f-566">In **Select Databases**, they select the SmartHotel360 database.</span><span class="sxs-lookup"><span data-stu-id="1a31f-566">In **Select Databases**, they select the SmartHotel360 database.</span></span>

    ![AlwaysOn availability group](media/contoso-migration-rehost-vm-sql-ag/aog-1.png)

3. <span data-ttu-id="1a31f-568">In **Specify Replicas**, they add the two SQL nodes as availability replicas, and configure them to provide automatic failover with synchronous commit.</span><span class="sxs-lookup"><span data-stu-id="1a31f-568">In **Specify Replicas**, they add the two SQL nodes as availability replicas, and configure them to provide automatic failover with synchronous commit.</span></span>

     ![AlwaysOn availability group](media/contoso-migration-rehost-vm-sql-ag/aog-2.png)

4. <span data-ttu-id="1a31f-570">They configure a listener for the group (**SHAOG**) and port.</span><span class="sxs-lookup"><span data-stu-id="1a31f-570">They configure a listener for the group (**SHAOG**) and port.</span></span> <span data-ttu-id="1a31f-571">The IP address of the internal load balancer is added as a static IP address (10.245.40.100).</span><span class="sxs-lookup"><span data-stu-id="1a31f-571">The IP address of the internal load balancer is added as a static IP address (10.245.40.100).</span></span>

    ![AlwaysOn availability group](media/contoso-migration-rehost-vm-sql-ag/aog-3.png)

5. <span data-ttu-id="1a31f-573">In **Select Data Synchronization**, they enable automatic seeding.</span><span class="sxs-lookup"><span data-stu-id="1a31f-573">In **Select Data Synchronization**, they enable automatic seeding.</span></span> <span data-ttu-id="1a31f-574">With this option, SQL Server automatically creates the secondary replicas for every database in the group, so Contoso don't have to manually back up and restore these.</span><span class="sxs-lookup"><span data-stu-id="1a31f-574">With this option, SQL Server automatically creates the secondary replicas for every database in the group, so Contoso don't have to manually back up and restore these.</span></span> <span data-ttu-id="1a31f-575">After validation, the availability group is created.</span><span class="sxs-lookup"><span data-stu-id="1a31f-575">After validation, the availability group is created.</span></span>

    ![AlwaysOn availability group](media/contoso-migration-rehost-vm-sql-ag/aog-4.png)

6. <span data-ttu-id="1a31f-577">Contoso ran into an issue when creating the group.</span><span class="sxs-lookup"><span data-stu-id="1a31f-577">Contoso ran into an issue when creating the group.</span></span> <span data-ttu-id="1a31f-578">They aren't using Active Directory Windows Integrated security, and thus need to grant permissions to the SQL login to create the Windows Failover Cluster roles.</span><span class="sxs-lookup"><span data-stu-id="1a31f-578">They aren't using Active Directory Windows Integrated security, and thus need to grant permissions to the SQL login to create the Windows Failover Cluster roles.</span></span>

    ![AlwaysOn availability group](media/contoso-migration-rehost-vm-sql-ag/aog-5.png)

6. <span data-ttu-id="1a31f-580">After the group is created, Contoso can see it in SQL Management Studio.</span><span class="sxs-lookup"><span data-stu-id="1a31f-580">After the group is created, Contoso can see it in SQL Management Studio.</span></span>

### <a name="configure-a-listener-on-the-cluster"></a><span data-ttu-id="1a31f-581">Configure a listener on the cluster</span><span class="sxs-lookup"><span data-stu-id="1a31f-581">Configure a listener on the cluster</span></span>

<span data-ttu-id="1a31f-582">As a last step in setting up the SQL deployment, Contoso admins configure the internal load balancer as the listener on the cluster, and brings the listener online.</span><span class="sxs-lookup"><span data-stu-id="1a31f-582">As a last step in setting up the SQL deployment, Contoso admins configure the internal load balancer as the listener on the cluster, and brings the listener online.</span></span> <span data-ttu-id="1a31f-583">They  use a script to do this.</span><span class="sxs-lookup"><span data-stu-id="1a31f-583">They  use a script to do this.</span></span>

![Cluster listener](media/contoso-migration-rehost-vm-sql-ag/cluster-listener.png)


### <a name="verify-the-configuration"></a><span data-ttu-id="1a31f-585">Verify the configuration</span><span class="sxs-lookup"><span data-stu-id="1a31f-585">Verify the configuration</span></span>

<span data-ttu-id="1a31f-586">With everything set up, Contoso now has a functional availability group in Azure that uses the migrated database.</span><span class="sxs-lookup"><span data-stu-id="1a31f-586">With everything set up, Contoso now has a functional availability group in Azure that uses the migrated database.</span></span> <span data-ttu-id="1a31f-587">Admins verify this by connecting to the internal load balancer in SQL Management Studio.</span><span class="sxs-lookup"><span data-stu-id="1a31f-587">Admins verify this by connecting to the internal load balancer in SQL Management Studio.</span></span>

![ILB connect](media/contoso-migration-rehost-vm-sql-ag/ilb-connect.png)

<span data-ttu-id="1a31f-589">**Need more help?**</span><span class="sxs-lookup"><span data-stu-id="1a31f-589">**Need more help?**</span></span>
- <span data-ttu-id="1a31f-590">Learn about creating an [availability group](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial#create-the-availability-group) and [listener](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial#configure-listener).</span><span class="sxs-lookup"><span data-stu-id="1a31f-590">Learn about creating an [availability group](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial#create-the-availability-group) and [listener](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-availability-group-tutorial#configure-listener).</span></span>
- <span data-ttu-id="1a31f-591">Manually [set up the cluster to use the load balancer IP address](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-alwayson-int-listener#configure-the-cluster-to-use-the-load-balancer-ip-address).</span><span class="sxs-lookup"><span data-stu-id="1a31f-591">Manually [set up the cluster to use the load balancer IP address](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-alwayson-int-listener#configure-the-cluster-to-use-the-load-balancer-ip-address).</span></span>
- <span data-ttu-id="1a31f-592">[Learn more](https://docs.microsoft.com/azure/storage/blobs/storage-dotnet-shared-access-signature-part-2) about creating and using SAS.</span><span class="sxs-lookup"><span data-stu-id="1a31f-592">[Learn more](https://docs.microsoft.com/azure/storage/blobs/storage-dotnet-shared-access-signature-part-2) about creating and using SAS.</span></span>


## <a name="step-8-migrate-the-vm-with-site-recovery"></a><span data-ttu-id="1a31f-593">Step 8: Migrate the VM with Site Recovery</span><span class="sxs-lookup"><span data-stu-id="1a31f-593">Step 8: Migrate the VM with Site Recovery</span></span>

<span data-ttu-id="1a31f-594">Contoso admins run a quick test failover, and then migrate the VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-594">Contoso admins run a quick test failover, and then migrate the VM.</span></span>

### <a name="run-a-test-failover"></a><span data-ttu-id="1a31f-595">Run a test failover</span><span class="sxs-lookup"><span data-stu-id="1a31f-595">Run a test failover</span></span>

<span data-ttu-id="1a31f-596">Running a test failover helps ensure that everything's working as expected before the migration.</span><span class="sxs-lookup"><span data-stu-id="1a31f-596">Running a test failover helps ensure that everything's working as expected before the migration.</span></span> 

1. <span data-ttu-id="1a31f-597">They run a test failover to the latest available point in time (**Latest processed**).</span><span class="sxs-lookup"><span data-stu-id="1a31f-597">They run a test failover to the latest available point in time (**Latest processed**).</span></span>
2. <span data-ttu-id="1a31f-598">They select **Shut down machine before beginning failover**, so that Site Recovery attempts to shut down the source VM before triggering the failover.</span><span class="sxs-lookup"><span data-stu-id="1a31f-598">They select **Shut down machine before beginning failover**, so that Site Recovery attempts to shut down the source VM before triggering the failover.</span></span> <span data-ttu-id="1a31f-599">Failover continues even if shutdown fails.</span><span class="sxs-lookup"><span data-stu-id="1a31f-599">Failover continues even if shutdown fails.</span></span> 
3. <span data-ttu-id="1a31f-600">Test failover runs:</span><span class="sxs-lookup"><span data-stu-id="1a31f-600">Test failover runs:</span></span> 

    - <span data-ttu-id="1a31f-601">A prerequisites check runs to make sure all of the conditions required for migration are in place.</span><span class="sxs-lookup"><span data-stu-id="1a31f-601">A prerequisites check runs to make sure all of the conditions required for migration are in place.</span></span>
    - <span data-ttu-id="1a31f-602">Failover processes the data, so that an Azure VM can be created.</span><span class="sxs-lookup"><span data-stu-id="1a31f-602">Failover processes the data, so that an Azure VM can be created.</span></span> <span data-ttu-id="1a31f-603">If select the latest recovery point, a recovery point is created from the data.</span><span class="sxs-lookup"><span data-stu-id="1a31f-603">If select the latest recovery point, a recovery point is created from the data.</span></span>
    - <span data-ttu-id="1a31f-604">An Azure VM is created using the data processed in the previous step.</span><span class="sxs-lookup"><span data-stu-id="1a31f-604">An Azure VM is created using the data processed in the previous step.</span></span>

3. <span data-ttu-id="1a31f-605">After the failover finishes, the replica Azure VM appears in the Azure portal.</span><span class="sxs-lookup"><span data-stu-id="1a31f-605">After the failover finishes, the replica Azure VM appears in the Azure portal.</span></span> <span data-ttu-id="1a31f-606">They check that the VM is the appropriate size, that it's connected to the right network, and that it's running.</span><span class="sxs-lookup"><span data-stu-id="1a31f-606">They check that the VM is the appropriate size, that it's connected to the right network, and that it's running.</span></span> 
4. <span data-ttu-id="1a31f-607">After verifying, They clean up the failover, and record and save any observations.</span><span class="sxs-lookup"><span data-stu-id="1a31f-607">After verifying, They clean up the failover, and record and save any observations.</span></span> 

### <a name="run-a-failover"></a><span data-ttu-id="1a31f-608">Run a failover</span><span class="sxs-lookup"><span data-stu-id="1a31f-608">Run a failover</span></span>

1. <span data-ttu-id="1a31f-609">After verifying that the test failover worked as expected, Contoso admins create a recovery plan for migration, and add WEBVM to the plan.</span><span class="sxs-lookup"><span data-stu-id="1a31f-609">After verifying that the test failover worked as expected, Contoso admins create a recovery plan for migration, and add WEBVM to the plan.</span></span>

     ![Recovery plan](./media/contoso-migration-rehost-vm-sql-ag/recovery-plan.png)

2. <span data-ttu-id="1a31f-611">They run a failover on the plan.</span><span class="sxs-lookup"><span data-stu-id="1a31f-611">They run a failover on the plan.</span></span> <span data-ttu-id="1a31f-612">They select the latest recovery point, and specify that Site Recovery should try to shut down the on-premises VM before triggering the failover.</span><span class="sxs-lookup"><span data-stu-id="1a31f-612">They select the latest recovery point, and specify that Site Recovery should try to shut down the on-premises VM before triggering the failover.</span></span>

    ![Failover](./media/contoso-migration-rehost-vm-sql-ag/failover1.png)

3. <span data-ttu-id="1a31f-614">After the failover, they verify that the Azure VM appears as expected in the Azure portal.</span><span class="sxs-lookup"><span data-stu-id="1a31f-614">After the failover, they verify that the Azure VM appears as expected in the Azure portal.</span></span>

    ![Recovery plan](./media/contoso-migration-rehost-vm-sql-ag/failover2.png)

6. <span data-ttu-id="1a31f-616">After verifying the VM in Azure, they complete the migration to finish the migration process, stop replication for the VM, and stop Site Recovery billing for the VM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-616">After verifying the VM in Azure, they complete the migration to finish the migration process, stop replication for the VM, and stop Site Recovery billing for the VM.</span></span>

    ![Failover](./media/contoso-migration-rehost-vm-sql-ag/failover3.png)

### <a name="update-the-connection-string"></a><span data-ttu-id="1a31f-618">Update the connection string</span><span class="sxs-lookup"><span data-stu-id="1a31f-618">Update the connection string</span></span>

<span data-ttu-id="1a31f-619">As the final step in the migration process, Contoso admins update the connection string of the application to point to the migrated database running on the SHAOG listener.</span><span class="sxs-lookup"><span data-stu-id="1a31f-619">As the final step in the migration process, Contoso admins update the connection string of the application to point to the migrated database running on the SHAOG listener.</span></span> <span data-ttu-id="1a31f-620">This configuration will be changed on the WEBVM now running in Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-620">This configuration will be changed on the WEBVM now running in Azure.</span></span>  <span data-ttu-id="1a31f-621">This configuration is located in the web.config of the ASP application.</span><span class="sxs-lookup"><span data-stu-id="1a31f-621">This configuration is located in the web.config of the ASP application.</span></span> 

1. <span data-ttu-id="1a31f-622">Locate the file at C:\inetpub\SmartHotelWeb\web.config.  Change the name of the server to reflect the FQDN of the AOG: shaog.contoso.com.</span><span class="sxs-lookup"><span data-stu-id="1a31f-622">Locate the file at C:\inetpub\SmartHotelWeb\web.config.  Change the name of the server to reflect the FQDN of the AOG: shaog.contoso.com.</span></span>

    ![Failover](./media/contoso-migration-rehost-vm-sql-ag/failover4.png)  

2. <span data-ttu-id="1a31f-624">After updating the file and saving it, they restart IIS on WEBVM.</span><span class="sxs-lookup"><span data-stu-id="1a31f-624">After updating the file and saving it, they restart IIS on WEBVM.</span></span> <span data-ttu-id="1a31f-625">They do this using the IISRESET /RESTART from a cmd prompt.</span><span class="sxs-lookup"><span data-stu-id="1a31f-625">They do this using the IISRESET /RESTART from a cmd prompt.</span></span>
2. <span data-ttu-id="1a31f-626">After IIS has been restarted, the application is now using the database running on the SQL MI.</span><span class="sxs-lookup"><span data-stu-id="1a31f-626">After IIS has been restarted, the application is now using the database running on the SQL MI.</span></span>


<span data-ttu-id="1a31f-627">**Need more help?**</span><span class="sxs-lookup"><span data-stu-id="1a31f-627">**Need more help?**</span></span>

- <span data-ttu-id="1a31f-628">[Learn about](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure) running a test failover.</span><span class="sxs-lookup"><span data-stu-id="1a31f-628">[Learn about](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure) running a test failover.</span></span> 
- <span data-ttu-id="1a31f-629">[Learn](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans) how to create a recovery plan.</span><span class="sxs-lookup"><span data-stu-id="1a31f-629">[Learn](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans) how to create a recovery plan.</span></span>
- <span data-ttu-id="1a31f-630">[Learn about](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover) failing over to Azure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-630">[Learn about](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover) failing over to Azure.</span></span>

## <a name="clean-up-after-migration"></a><span data-ttu-id="1a31f-631">Clean up after migration</span><span class="sxs-lookup"><span data-stu-id="1a31f-631">Clean up after migration</span></span>

<span data-ttu-id="1a31f-632">After migration, the SmartHotel360 app is running on an Azure VM, and the SmartHotel360 database is located in the Azure SQL cluster.</span><span class="sxs-lookup"><span data-stu-id="1a31f-632">After migration, the SmartHotel360 app is running on an Azure VM, and the SmartHotel360 database is located in the Azure SQL cluster.</span></span>

<span data-ttu-id="1a31f-633">Now, Contoso needs to complete these cleanup steps:</span><span class="sxs-lookup"><span data-stu-id="1a31f-633">Now, Contoso needs to complete these cleanup steps:</span></span>  

- <span data-ttu-id="1a31f-634">Remove the on-premises VMs from the vCenter inventory.</span><span class="sxs-lookup"><span data-stu-id="1a31f-634">Remove the on-premises VMs from the vCenter inventory.</span></span>
- <span data-ttu-id="1a31f-635">Remove the VMs from local backup jobs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-635">Remove the VMs from local backup jobs.</span></span>
- <span data-ttu-id="1a31f-636">Update internal documentation to show the new locations and IP addresses for VMs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-636">Update internal documentation to show the new locations and IP addresses for VMs.</span></span>
- <span data-ttu-id="1a31f-637">Review any resources that interact with the decommissioned VMs, and update any relevant settings or documentation to reflect the new configuration.</span><span class="sxs-lookup"><span data-stu-id="1a31f-637">Review any resources that interact with the decommissioned VMs, and update any relevant settings or documentation to reflect the new configuration.</span></span>
- <span data-ttu-id="1a31f-638">Add the two new VMs (SQLAOG1 and SQLAOG2) should be added to production monitoring systems.</span><span class="sxs-lookup"><span data-stu-id="1a31f-638">Add the two new VMs (SQLAOG1 and SQLAOG2) should be added to production monitoring systems.</span></span>

## <a name="review-the-deployment"></a><span data-ttu-id="1a31f-639">Review the deployment</span><span class="sxs-lookup"><span data-stu-id="1a31f-639">Review the deployment</span></span>

<span data-ttu-id="1a31f-640">With the migrated resources in Azure, Contoso needs to fully operationalize and secure their new infrastructure.</span><span class="sxs-lookup"><span data-stu-id="1a31f-640">With the migrated resources in Azure, Contoso needs to fully operationalize and secure their new infrastructure.</span></span>

### <a name="security"></a><span data-ttu-id="1a31f-641">Security</span><span class="sxs-lookup"><span data-stu-id="1a31f-641">Security</span></span>

<span data-ttu-id="1a31f-642">The Contoso security team reviews the Azure VMs WEBVM, SQLAOG1 and SQLAOG2 to determine any security issues.</span><span class="sxs-lookup"><span data-stu-id="1a31f-642">The Contoso security team reviews the Azure VMs WEBVM, SQLAOG1 and SQLAOG2 to determine any security issues.</span></span> 

- <span data-ttu-id="1a31f-643">The team reviews the Network Security Groups (NSGs) for the VM to control access.</span><span class="sxs-lookup"><span data-stu-id="1a31f-643">The team reviews the Network Security Groups (NSGs) for the VM to control access.</span></span> <span data-ttu-id="1a31f-644">NSGs are used to ensure that only traffic allowed to the application can pass.</span><span class="sxs-lookup"><span data-stu-id="1a31f-644">NSGs are used to ensure that only traffic allowed to the application can pass.</span></span>
- <span data-ttu-id="1a31f-645">The team considers securing the data on the disk using Azure Disk Encryption and KeyVault.</span><span class="sxs-lookup"><span data-stu-id="1a31f-645">The team considers securing the data on the disk using Azure Disk Encryption and KeyVault.</span></span>
- <span data-ttu-id="1a31f-646">The team should evaluate transparent data encryption (TDE), and then enable it on the SmartHotel360 database running on the new SQL AOG.</span><span class="sxs-lookup"><span data-stu-id="1a31f-646">The team should evaluate transparent data encryption (TDE), and then enable it on the SmartHotel360 database running on the new SQL AOG.</span></span> <span data-ttu-id="1a31f-647">[Learn more](https://docs.microsoft.com/sql/relational-databases/security/encryption/transparent-data-encryption?view=sql-server-2017).</span><span class="sxs-lookup"><span data-stu-id="1a31f-647">[Learn more](https://docs.microsoft.com/sql/relational-databases/security/encryption/transparent-data-encryption?view=sql-server-2017).</span></span>

<span data-ttu-id="1a31f-648">[Read more](https://docs.microsoft.com/azure/security/azure-security-best-practices-vms#vm-authentication-and-access-control) about security practices for VMs.</span><span class="sxs-lookup"><span data-stu-id="1a31f-648">[Read more](https://docs.microsoft.com/azure/security/azure-security-best-practices-vms#vm-authentication-and-access-control) about security practices for VMs.</span></span>


## <a name="bcdr"></a><span data-ttu-id="1a31f-649">BCDR</span><span class="sxs-lookup"><span data-stu-id="1a31f-649">BCDR</span></span>

 <span data-ttu-id="1a31f-650">For business continuity and disaster recovery (BCDR), Contoso takes the following actions:</span><span class="sxs-lookup"><span data-stu-id="1a31f-650">For business continuity and disaster recovery (BCDR), Contoso takes the following actions:</span></span>
 - <span data-ttu-id="1a31f-651">Keep data safe: Contoso backs up the data on the WEBVM, SQLAOG1 and SQLAOG2 VMs using the Azure Backup service.</span><span class="sxs-lookup"><span data-stu-id="1a31f-651">Keep data safe: Contoso backs up the data on the WEBVM, SQLAOG1 and SQLAOG2 VMs using the Azure Backup service.</span></span> <span data-ttu-id="1a31f-652">[Learn more].</span><span class="sxs-lookup"><span data-stu-id="1a31f-652">[Learn more].</span></span>
<span data-ttu-id="1a31f-653">(https://docs.microsoft.com/azure/backup/backup-introduction-to-azure-backup?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="1a31f-653">(https://docs.microsoft.com/azure/backup/backup-introduction-to-azure-backup?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span></span>
- <span data-ttu-id="1a31f-654">Contoso will also learn about how to use Azure Storage to back up SQL Server directly to blob storage.</span><span class="sxs-lookup"><span data-stu-id="1a31f-654">Contoso will also learn about how to use Azure Storage to back up SQL Server directly to blob storage.</span></span> <span data-ttu-id="1a31f-655">[Learn more](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-use-storage-sql-server-backup-restore).</span><span class="sxs-lookup"><span data-stu-id="1a31f-655">[Learn more](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-use-storage-sql-server-backup-restore).</span></span>
- <span data-ttu-id="1a31f-656">Keep apps up and running: Contoso replicates the app VMs in Azure to a secondary region using Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="1a31f-656">Keep apps up and running: Contoso replicates the app VMs in Azure to a secondary region using Site Recovery.</span></span> <span data-ttu-id="1a31f-657">[Learn more](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-quickstart).</span><span class="sxs-lookup"><span data-stu-id="1a31f-657">[Learn more](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-quickstart).</span></span>


### <a name="licensing-and-cost-optimization"></a><span data-ttu-id="1a31f-658">Licensing and cost optimization</span><span class="sxs-lookup"><span data-stu-id="1a31f-658">Licensing and cost optimization</span></span>

1. <span data-ttu-id="1a31f-659">Contoso has existing licensing for their WEBVM and will leverage the Azure Hybrid Benefit.</span><span class="sxs-lookup"><span data-stu-id="1a31f-659">Contoso has existing licensing for their WEBVM and will leverage the Azure Hybrid Benefit.</span></span>  <span data-ttu-id="1a31f-660">Contoso will convert the existing Azure VMs to take advantage of this pricing.</span><span class="sxs-lookup"><span data-stu-id="1a31f-660">Contoso will convert the existing Azure VMs to take advantage of this pricing.</span></span>
2. <span data-ttu-id="1a31f-661">Contoso will enable Azure Cost Management licensed by Cloudyn, a Microsoft subsidiary.</span><span class="sxs-lookup"><span data-stu-id="1a31f-661">Contoso will enable Azure Cost Management licensed by Cloudyn, a Microsoft subsidiary.</span></span> <span data-ttu-id="1a31f-662">It's a multi-cloud cost management solution that helps you to utilize and manage Azure and other cloud resources.</span><span class="sxs-lookup"><span data-stu-id="1a31f-662">It's a multi-cloud cost management solution that helps you to utilize and manage Azure and other cloud resources.</span></span>  <span data-ttu-id="1a31f-663">[Learn more](https://docs.microsoft.com/azure/cost-management/overview) about Azure Cost Management.</span><span class="sxs-lookup"><span data-stu-id="1a31f-663">[Learn more](https://docs.microsoft.com/azure/cost-management/overview) about Azure Cost Management.</span></span> 

## <a name="conclusion"></a><span data-ttu-id="1a31f-664">Conclusion</span><span class="sxs-lookup"><span data-stu-id="1a31f-664">Conclusion</span></span>

<span data-ttu-id="1a31f-665">In this article, Contoso rehosted the SmartHotel360 app in Azure by migrating the app frontend VM to Azure using the Site Recovery service.</span><span class="sxs-lookup"><span data-stu-id="1a31f-665">In this article, Contoso rehosted the SmartHotel360 app in Azure by migrating the app frontend VM to Azure using the Site Recovery service.</span></span> <span data-ttu-id="1a31f-666">Contoso migrated the app database to a SQL Server cluster provisioned in Azure, and protected it in a SQL Server AlwaysOn availability group.</span><span class="sxs-lookup"><span data-stu-id="1a31f-666">Contoso migrated the app database to a SQL Server cluster provisioned in Azure, and protected it in a SQL Server AlwaysOn availability group.</span></span>

## <a name="next-steps"></a><span data-ttu-id="1a31f-667">Next steps</span><span class="sxs-lookup"><span data-stu-id="1a31f-667">Next steps</span></span>

<span data-ttu-id="1a31f-668">In the next article in the series, we'll show how Contoso rehost their service desk osTicket app running on Linux, and deployed with a MySQL database.</span><span class="sxs-lookup"><span data-stu-id="1a31f-668">In the next article in the series, we'll show how Contoso rehost their service desk osTicket app running on Linux, and deployed with a MySQL database.</span></span>


