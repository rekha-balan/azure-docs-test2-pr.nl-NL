---
title: Rehost a Contoso on-premises app by migrating to Azure VMs and Azure SQL Database Managed Instance | Microsoft Docs
description: Learn how Contoso rehosts an on-premises app on Azure VMs and by using Azure SQL Database Managed Instance.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 09/05/2018
ms.author: raynew
ms.openlocfilehash: 12baa21c8661012cd7ef96217724150a3d8c56f3
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44868703"
---
# <a name="contoso-migration-rehost-an-on-premises-app-on-an-azure-vm-and-sql-database-managed-instance"></a><span data-ttu-id="f7431-103">Contoso migration: Rehost an on-premises app on an Azure VM and SQL Database Managed Instance</span><span class="sxs-lookup"><span data-stu-id="f7431-103">Contoso migration: Rehost an on-premises app on an Azure VM and SQL Database Managed Instance</span></span>

<span data-ttu-id="f7431-104">In this article, Contoso migrates its SmartHotel360 app front-end VM to an Azure VM by using the Azure Site Recovery service.</span><span class="sxs-lookup"><span data-stu-id="f7431-104">In this article, Contoso migrates its SmartHotel360 app front-end VM to an Azure VM by using the Azure Site Recovery service.</span></span> <span data-ttu-id="f7431-105">Contoso also migrates the app database to Azure SQL Database Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-105">Contoso also migrates the app database to Azure SQL Database Managed Instance.</span></span>

> [!NOTE]
> <span data-ttu-id="f7431-106">Azure SQL Database Managed Instance currently is in preview.</span><span class="sxs-lookup"><span data-stu-id="f7431-106">Azure SQL Database Managed Instance currently is in preview.</span></span>

<span data-ttu-id="f7431-107">This article is one in a series of articles that documents how the fictitious company Contoso migrates its on-premises resources to the Microsoft Azure cloud.</span><span class="sxs-lookup"><span data-stu-id="f7431-107">This article is one in a series of articles that documents how the fictitious company Contoso migrates its on-premises resources to the Microsoft Azure cloud.</span></span> <span data-ttu-id="f7431-108">The series includes background information and a series of scenarios that illustrate how to set up a migration infrastructure and run different types of migrations.</span><span class="sxs-lookup"><span data-stu-id="f7431-108">The series includes background information and a series of scenarios that illustrate how to set up a migration infrastructure and run different types of migrations.</span></span> <span data-ttu-id="f7431-109">Scenarios grow in complexity.</span><span class="sxs-lookup"><span data-stu-id="f7431-109">Scenarios grow in complexity.</span></span> <span data-ttu-id="f7431-110">Articles will be added to the series over time.</span><span class="sxs-lookup"><span data-stu-id="f7431-110">Articles will be added to the series over time.</span></span>


<span data-ttu-id="f7431-111">**Article**</span><span class="sxs-lookup"><span data-stu-id="f7431-111">**Article**</span></span> | <span data-ttu-id="f7431-112">**Details**</span><span class="sxs-lookup"><span data-stu-id="f7431-112">**Details**</span></span> | <span data-ttu-id="f7431-113">**Status**</span><span class="sxs-lookup"><span data-stu-id="f7431-113">**Status**</span></span>
--- | --- | ---
[<span data-ttu-id="f7431-114">Article 1: Overview</span><span class="sxs-lookup"><span data-stu-id="f7431-114">Article 1: Overview</span></span>](contoso-migration-overview.md) | <span data-ttu-id="f7431-115">Overview of Contoso's migration strategy, the article series, and the sample apps that are used in the series.</span><span class="sxs-lookup"><span data-stu-id="f7431-115">Overview of Contoso's migration strategy, the article series, and the sample apps that are used in the series.</span></span> | <span data-ttu-id="f7431-116">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-116">Available</span></span>
[<span data-ttu-id="f7431-117">Article 2: Deploy an Azure infrastructure</span><span class="sxs-lookup"><span data-stu-id="f7431-117">Article 2: Deploy an Azure infrastructure</span></span>](contoso-migration-infrastructure.md) | <span data-ttu-id="f7431-118">Contoso prepares its on-premises infrastructure and its Azure infrastructure for migration.</span><span class="sxs-lookup"><span data-stu-id="f7431-118">Contoso prepares its on-premises infrastructure and its Azure infrastructure for migration.</span></span> <span data-ttu-id="f7431-119">The same infrastructure is used for all migration articles in the series.</span><span class="sxs-lookup"><span data-stu-id="f7431-119">The same infrastructure is used for all migration articles in the series.</span></span> | <span data-ttu-id="f7431-120">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-120">Available</span></span>
[<span data-ttu-id="f7431-121">Article 3: Assess on-premises resources for migration to Azure</span><span class="sxs-lookup"><span data-stu-id="f7431-121">Article 3: Assess on-premises resources for migration to Azure</span></span>](contoso-migration-assessment.md) | <span data-ttu-id="f7431-122">Contoso runs an assessment of its on-premises two-tier SmartHotel app running on VMware.</span><span class="sxs-lookup"><span data-stu-id="f7431-122">Contoso runs an assessment of its on-premises two-tier SmartHotel app running on VMware.</span></span> <span data-ttu-id="f7431-123">Contoso assesses app VMs by using the [Azure Migrate](migrate-overview.md) service.</span><span class="sxs-lookup"><span data-stu-id="f7431-123">Contoso assesses app VMs by using the [Azure Migrate](migrate-overview.md) service.</span></span> <span data-ttu-id="f7431-124">Contoso assesses the app SQL Server database by using [Data Migration Assistant](https://docs.microsoft.com/sql/dma/dma-overview?view=sql-server-2017).</span><span class="sxs-lookup"><span data-stu-id="f7431-124">Contoso assesses the app SQL Server database by using [Data Migration Assistant](https://docs.microsoft.com/sql/dma/dma-overview?view=sql-server-2017).</span></span> | <span data-ttu-id="f7431-125">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-125">Available</span></span>
<span data-ttu-id="f7431-126">Article 4: Rehost an app on an Azure VM and SQL Database Managed Instance</span><span class="sxs-lookup"><span data-stu-id="f7431-126">Article 4: Rehost an app on an Azure VM and SQL Database Managed Instance</span></span> | <span data-ttu-id="f7431-127">Contoso runs a lift-and-shift migration to Azure for its on-premises SmartHotel app.</span><span class="sxs-lookup"><span data-stu-id="f7431-127">Contoso runs a lift-and-shift migration to Azure for its on-premises SmartHotel app.</span></span> <span data-ttu-id="f7431-128">Contoso migrates the app front-end VM by using [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview).</span><span class="sxs-lookup"><span data-stu-id="f7431-128">Contoso migrates the app front-end VM by using [Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/site-recovery-overview).</span></span> <span data-ttu-id="f7431-129">Contoso migrates the app database to an Azure SQL Database Managed Instance by using the [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview).</span><span class="sxs-lookup"><span data-stu-id="f7431-129">Contoso migrates the app database to an Azure SQL Database Managed Instance by using the [Azure Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview).</span></span> | <span data-ttu-id="f7431-130">This article</span><span class="sxs-lookup"><span data-stu-id="f7431-130">This article</span></span>
[<span data-ttu-id="f7431-131">Article 5: Rehost an app on Azure VMs</span><span class="sxs-lookup"><span data-stu-id="f7431-131">Article 5: Rehost an app on Azure VMs</span></span>](contoso-migration-rehost-vm.md) | <span data-ttu-id="f7431-132">Contoso migrates its SmartHotel app VMs to Azure VMs by using the Site Recovery service.</span><span class="sxs-lookup"><span data-stu-id="f7431-132">Contoso migrates its SmartHotel app VMs to Azure VMs by using the Site Recovery service.</span></span> | <span data-ttu-id="f7431-133">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-133">Available</span></span>
[<span data-ttu-id="f7431-134">Article 6: Rehost an app on Azure VMs and in a  SQL Server AlwaysOn availability group</span><span class="sxs-lookup"><span data-stu-id="f7431-134">Article 6: Rehost an app on Azure VMs and in a  SQL Server AlwaysOn availability group</span></span>](contoso-migration-rehost-vm-sql-ag.md) | <span data-ttu-id="f7431-135">Contoso migrates the SmartHotel app.</span><span class="sxs-lookup"><span data-stu-id="f7431-135">Contoso migrates the SmartHotel app.</span></span> <span data-ttu-id="f7431-136">Contoso uses Site Recovery to migrate the app VMs.</span><span class="sxs-lookup"><span data-stu-id="f7431-136">Contoso uses Site Recovery to migrate the app VMs.</span></span> <span data-ttu-id="f7431-137">It uses the Database Migration Service to migrate the app database to a SQL Server cluster that's protected by an AlwaysOn availability group.</span><span class="sxs-lookup"><span data-stu-id="f7431-137">It uses the Database Migration Service to migrate the app database to a SQL Server cluster that's protected by an AlwaysOn availability group.</span></span> | <span data-ttu-id="f7431-138">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-138">Available</span></span>
[<span data-ttu-id="f7431-139">Article 7: Rehost a Linux app on Azure VMs</span><span class="sxs-lookup"><span data-stu-id="f7431-139">Article 7: Rehost a Linux app on Azure VMs</span></span>](contoso-migration-rehost-linux-vm.md) | <span data-ttu-id="f7431-140">Contoso completes a lift-and-shift migration of its Linux osTicket app to Azure VMs by using Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="f7431-140">Contoso completes a lift-and-shift migration of its Linux osTicket app to Azure VMs by using Site Recovery.</span></span> | <span data-ttu-id="f7431-141">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-141">Available</span></span>
[<span data-ttu-id="f7431-142">Article 8: Rehost a Linux app on Azure VMs and Azure Database for MySQL</span><span class="sxs-lookup"><span data-stu-id="f7431-142">Article 8: Rehost a Linux app on Azure VMs and Azure Database for MySQL</span></span>](contoso-migration-rehost-linux-vm-mysql.md) | <span data-ttu-id="f7431-143">Contoso migrates its Linux osTicket app to Azure VMs by using Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="f7431-143">Contoso migrates its Linux osTicket app to Azure VMs by using Site Recovery.</span></span> <span data-ttu-id="f7431-144">It migrates the app database to Azure Database for MySQL by using MySQL Workbench.</span><span class="sxs-lookup"><span data-stu-id="f7431-144">It migrates the app database to Azure Database for MySQL by using MySQL Workbench.</span></span> | <span data-ttu-id="f7431-145">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-145">Available</span></span>
[<span data-ttu-id="f7431-146">Article 9: Refactor an app in an Azure web app and Azure SQL Database</span><span class="sxs-lookup"><span data-stu-id="f7431-146">Article 9: Refactor an app in an Azure web app and Azure SQL Database</span></span>](contoso-migration-refactor-web-app-sql.md) | <span data-ttu-id="f7431-147">Contoso migrates its SmartHotel app to an Azure web app and migrates the app database to an Azure SQL Server instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-147">Contoso migrates its SmartHotel app to an Azure web app and migrates the app database to an Azure SQL Server instance.</span></span> | <span data-ttu-id="f7431-148">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-148">Available</span></span>
[<span data-ttu-id="f7431-149">Article 10: Refactor a Linux app in an Azure web app and Azure Database for MySQL</span><span class="sxs-lookup"><span data-stu-id="f7431-149">Article 10: Refactor a Linux app in an Azure web app and Azure Database for MySQL</span></span>](contoso-migration-refactor-linux-app-service-mysql.md) | <span data-ttu-id="f7431-150">Contoso migrates its Linux osTicket app to an Azure web app on multiple sites.</span><span class="sxs-lookup"><span data-stu-id="f7431-150">Contoso migrates its Linux osTicket app to an Azure web app on multiple sites.</span></span> <span data-ttu-id="f7431-151">The web app is integrated with GitHub for continuous delivery.</span><span class="sxs-lookup"><span data-stu-id="f7431-151">The web app is integrated with GitHub for continuous delivery.</span></span> <span data-ttu-id="f7431-152">Contoso migrates the app database to an Azure Database for MySQL instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-152">Contoso migrates the app database to an Azure Database for MySQL instance.</span></span> | <span data-ttu-id="f7431-153">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-153">Available</span></span>
[<span data-ttu-id="f7431-154">Article 11: Refactor Team Foundation Server on Azure DevOps Services</span><span class="sxs-lookup"><span data-stu-id="f7431-154">Article 11: Refactor Team Foundation Server on Azure DevOps Services</span></span>](contoso-migration-tfs-vsts.md) | <span data-ttu-id="f7431-155">Contoso migrates its on-premises Team Foundation Server deployment by migrating it to Azure DevOps Services in Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-155">Contoso migrates its on-premises Team Foundation Server deployment by migrating it to Azure DevOps Services in Azure.</span></span> | <span data-ttu-id="f7431-156">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-156">Available</span></span>
[<span data-ttu-id="f7431-157">Article 12: Rearchitect an app in Azure containers and Azure SQL Database</span><span class="sxs-lookup"><span data-stu-id="f7431-157">Article 12: Rearchitect an app in Azure containers and Azure SQL Database</span></span>](contoso-migration-rearchitect-container-sql.md) | <span data-ttu-id="f7431-158">Contoso migrates its SmartHotel app to Azure, and then rearchitects the app.</span><span class="sxs-lookup"><span data-stu-id="f7431-158">Contoso migrates its SmartHotel app to Azure, and then rearchitects the app.</span></span> <span data-ttu-id="f7431-159">Contoso rearchitects the app web tier as a Windows container, and rearchitects the app database by using Azure SQL Database.</span><span class="sxs-lookup"><span data-stu-id="f7431-159">Contoso rearchitects the app web tier as a Windows container, and rearchitects the app database by using Azure SQL Database.</span></span> | <span data-ttu-id="f7431-160">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-160">Available</span></span>
[<span data-ttu-id="f7431-161">Article 13: Rebuild an app in Azure</span><span class="sxs-lookup"><span data-stu-id="f7431-161">Article 13: Rebuild an app in Azure</span></span>](contoso-migration-rebuild.md) | <span data-ttu-id="f7431-162">Contoso rebuilds its SmartHotel app by using a range of Azure capabilities and services, including Azure App Service, Azure Kubernetes Service, Azure Functions, Azure Cognitive Services, and Azure Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="f7431-162">Contoso rebuilds its SmartHotel app by using a range of Azure capabilities and services, including Azure App Service, Azure Kubernetes Service, Azure Functions, Azure Cognitive Services, and Azure Cosmos DB.</span></span> | <span data-ttu-id="f7431-163">Available</span><span class="sxs-lookup"><span data-stu-id="f7431-163">Available</span></span>




<span data-ttu-id="f7431-164">You can download the sample SmartHotel360 app that's used in this article from [GitHub](https://github.com/Microsoft/SmartHotel360).</span><span class="sxs-lookup"><span data-stu-id="f7431-164">You can download the sample SmartHotel360 app that's used in this article from [GitHub](https://github.com/Microsoft/SmartHotel360).</span></span>



## <a name="business-drivers"></a><span data-ttu-id="f7431-165">Business drivers</span><span class="sxs-lookup"><span data-stu-id="f7431-165">Business drivers</span></span>

<span data-ttu-id="f7431-166">Contoso's IT leadership team has worked closely with the company's business partners to understand what the business wants to achieve with this migration:</span><span class="sxs-lookup"><span data-stu-id="f7431-166">Contoso's IT leadership team has worked closely with the company's business partners to understand what the business wants to achieve with this migration:</span></span>

- <span data-ttu-id="f7431-167">**Address business growth**: Contoso is growing.</span><span class="sxs-lookup"><span data-stu-id="f7431-167">**Address business growth**: Contoso is growing.</span></span> <span data-ttu-id="f7431-168">As a result, pressure has increased on the company's on-premises systems and infrastructure.</span><span class="sxs-lookup"><span data-stu-id="f7431-168">As a result, pressure has increased on the company's on-premises systems and infrastructure.</span></span>
- <span data-ttu-id="f7431-169">**Increase efficiency**: Contoso needs to remove unnecessary procedures, and to streamline processes for its developers and users.</span><span class="sxs-lookup"><span data-stu-id="f7431-169">**Increase efficiency**: Contoso needs to remove unnecessary procedures, and to streamline processes for its developers and users.</span></span> <span data-ttu-id="f7431-170">The business needs IT to be fast and to not waste time or money, so the company can deliver faster on customer requirements.</span><span class="sxs-lookup"><span data-stu-id="f7431-170">The business needs IT to be fast and to not waste time or money, so the company can deliver faster on customer requirements.</span></span>
- <span data-ttu-id="f7431-171">**Increase agility**:  Contoso IT needs to be more responsive to the needs of the business.</span><span class="sxs-lookup"><span data-stu-id="f7431-171">**Increase agility**:  Contoso IT needs to be more responsive to the needs of the business.</span></span> <span data-ttu-id="f7431-172">It must be able to react faster than the changes that occur in the marketplace for the company to be successful in a global economy.</span><span class="sxs-lookup"><span data-stu-id="f7431-172">It must be able to react faster than the changes that occur in the marketplace for the company to be successful in a global economy.</span></span> <span data-ttu-id="f7431-173">IT at Contoso must not get in the way or become a business blocker.</span><span class="sxs-lookup"><span data-stu-id="f7431-173">IT at Contoso must not get in the way or become a business blocker.</span></span>
- <span data-ttu-id="f7431-174">**Scale**: As the company's business grows successfully, Contoso IT must provide systems that can grow at the same pace.</span><span class="sxs-lookup"><span data-stu-id="f7431-174">**Scale**: As the company's business grows successfully, Contoso IT must provide systems that can grow at the same pace.</span></span>

## <a name="migration-goals"></a><span data-ttu-id="f7431-175">Migration goals</span><span class="sxs-lookup"><span data-stu-id="f7431-175">Migration goals</span></span>

<span data-ttu-id="f7431-176">The Contoso cloud team has identified goals for this migration.</span><span class="sxs-lookup"><span data-stu-id="f7431-176">The Contoso cloud team has identified goals for this migration.</span></span> <span data-ttu-id="f7431-177">The company uses migration goals to determine the best migration method.</span><span class="sxs-lookup"><span data-stu-id="f7431-177">The company uses migration goals to determine the best migration method.</span></span>

- <span data-ttu-id="f7431-178">After migration, the app in Azure should have the same performance capabilities that the app has today in Contoso's on-premises VMWare environment.</span><span class="sxs-lookup"><span data-stu-id="f7431-178">After migration, the app in Azure should have the same performance capabilities that the app has today in Contoso's on-premises VMWare environment.</span></span> <span data-ttu-id="f7431-179">Moving to the cloud doesn't mean that app performance is less critical.</span><span class="sxs-lookup"><span data-stu-id="f7431-179">Moving to the cloud doesn't mean that app performance is less critical.</span></span>
- <span data-ttu-id="f7431-180">Contoso doesn’t want to invest in the app.</span><span class="sxs-lookup"><span data-stu-id="f7431-180">Contoso doesn’t want to invest in the app.</span></span> <span data-ttu-id="f7431-181">The app is critical and important to the business, but Contoso simply wants to move the app in its current form to the cloud.</span><span class="sxs-lookup"><span data-stu-id="f7431-181">The app is critical and important to the business, but Contoso simply wants to move the app in its current form to the cloud.</span></span>
- <span data-ttu-id="f7431-182">Database administration tasks should be minimized after the app is migrated.</span><span class="sxs-lookup"><span data-stu-id="f7431-182">Database administration tasks should be minimized after the app is migrated.</span></span>
- <span data-ttu-id="f7431-183">Contoso doesn't want to use an Azure SQL Database for this app.</span><span class="sxs-lookup"><span data-stu-id="f7431-183">Contoso doesn't want to use an Azure SQL Database for this app.</span></span> <span data-ttu-id="f7431-184">It's looking for alternatives.</span><span class="sxs-lookup"><span data-stu-id="f7431-184">It's looking for alternatives.</span></span>


## <a name="solution-design"></a><span data-ttu-id="f7431-185">Solution design</span><span class="sxs-lookup"><span data-stu-id="f7431-185">Solution design</span></span>

<span data-ttu-id="f7431-186">After pinning down their goals and requirements, Contoso designs and reviews a deployment solution, and identifies the migration process, including the Azure services that it will use for the migration.</span><span class="sxs-lookup"><span data-stu-id="f7431-186">After pinning down their goals and requirements, Contoso designs and reviews a deployment solution, and identifies the migration process, including the Azure services that it will use for the migration.</span></span>

### <a name="current-architecture"></a><span data-ttu-id="f7431-187">Current architecture</span><span class="sxs-lookup"><span data-stu-id="f7431-187">Current architecture</span></span> 

- <span data-ttu-id="f7431-188">Contoso has one main datacenter (**contoso-datacenter**) .</span><span class="sxs-lookup"><span data-stu-id="f7431-188">Contoso has one main datacenter (**contoso-datacenter**) .</span></span> <span data-ttu-id="f7431-189">The datacenter is located in the city of New York in the Eastern United States.</span><span class="sxs-lookup"><span data-stu-id="f7431-189">The datacenter is located in the city of New York in the Eastern United States.</span></span>
- <span data-ttu-id="f7431-190">Contoso has three additional local branches across the United States.</span><span class="sxs-lookup"><span data-stu-id="f7431-190">Contoso has three additional local branches across the United States.</span></span>
- <span data-ttu-id="f7431-191">The main datacenter is connected to the internet with a fiber Metro Ethernet connection (500 MBps).</span><span class="sxs-lookup"><span data-stu-id="f7431-191">The main datacenter is connected to the internet with a fiber Metro Ethernet connection (500 MBps).</span></span>
- <span data-ttu-id="f7431-192">Each branch is connected locally to the internet by using business-class connections with IPsec VPN tunnels back to the main datacenter.</span><span class="sxs-lookup"><span data-stu-id="f7431-192">Each branch is connected locally to the internet by using business-class connections with IPsec VPN tunnels back to the main datacenter.</span></span> <span data-ttu-id="f7431-193">The setup allows Contoso's entire network to be permanently connected and optimizes internet connectivity.</span><span class="sxs-lookup"><span data-stu-id="f7431-193">The setup allows Contoso's entire network to be permanently connected and optimizes internet connectivity.</span></span>
- <span data-ttu-id="f7431-194">The main datacenter is fully virtualized with VMware.</span><span class="sxs-lookup"><span data-stu-id="f7431-194">The main datacenter is fully virtualized with VMware.</span></span> <span data-ttu-id="f7431-195">Contoso has two ESXi 6.5 virtualization hosts that are managed by vCenter Server 6.5.</span><span class="sxs-lookup"><span data-stu-id="f7431-195">Contoso has two ESXi 6.5 virtualization hosts that are managed by vCenter Server 6.5.</span></span>
- <span data-ttu-id="f7431-196">Contoso uses Active Directory for identity management.</span><span class="sxs-lookup"><span data-stu-id="f7431-196">Contoso uses Active Directory for identity management.</span></span> <span data-ttu-id="f7431-197">Contoso uses DNS servers on the internal network.</span><span class="sxs-lookup"><span data-stu-id="f7431-197">Contoso uses DNS servers on the internal network.</span></span>
- <span data-ttu-id="f7431-198">Contoso has an on-premises domain controller (**contosodc1**).</span><span class="sxs-lookup"><span data-stu-id="f7431-198">Contoso has an on-premises domain controller (**contosodc1**).</span></span>
- <span data-ttu-id="f7431-199">The domain controllers run on VMware VMs.</span><span class="sxs-lookup"><span data-stu-id="f7431-199">The domain controllers run on VMware VMs.</span></span> <span data-ttu-id="f7431-200">The domain controllers at local branches run on physical servers.</span><span class="sxs-lookup"><span data-stu-id="f7431-200">The domain controllers at local branches run on physical servers.</span></span>
- <span data-ttu-id="f7431-201">The SmartHotel360 app is tiered across two VMs (**WEBVM** and **SQLVM**) that are located on a VMware ESXi version 6.5 host (**contosohost1.contoso.com**).</span><span class="sxs-lookup"><span data-stu-id="f7431-201">The SmartHotel360 app is tiered across two VMs (**WEBVM** and **SQLVM**) that are located on a VMware ESXi version 6.5 host (**contosohost1.contoso.com**).</span></span> 
- <span data-ttu-id="f7431-202">The VMware environment is managed by vCenter Server 6.5 (**vcenter.contoso.com**) running on a VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-202">The VMware environment is managed by vCenter Server 6.5 (**vcenter.contoso.com**) running on a VM.</span></span>

![Current Contoso architecture](./media/contoso-migration-rehost-vm-sql-managed-instance/contoso-architecture.png)  

### <a name="proposed-architecture"></a><span data-ttu-id="f7431-204">Proposed architecture</span><span class="sxs-lookup"><span data-stu-id="f7431-204">Proposed architecture</span></span>

<span data-ttu-id="f7431-205">In this scenario, Contoso wants to migrate its two-tier on-premises travel app as follows:</span><span class="sxs-lookup"><span data-stu-id="f7431-205">In this scenario, Contoso wants to migrate its two-tier on-premises travel app as follows:</span></span>

- <span data-ttu-id="f7431-206">Migrate the app database (**SmartHotelDB**) to an Azure SQL Database Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-206">Migrate the app database (**SmartHotelDB**) to an Azure SQL Database Managed Instance.</span></span>
- <span data-ttu-id="f7431-207">Migrate the frontend **WebVM** to an Azure VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-207">Migrate the frontend **WebVM** to an Azure VM.</span></span>
- <span data-ttu-id="f7431-208">The on-premises VMs in the Contoso datacenter will be decommissioned when the migration is finished.</span><span class="sxs-lookup"><span data-stu-id="f7431-208">The on-premises VMs in the Contoso datacenter will be decommissioned when the migration is finished.</span></span>

![Scenario architecture](media/contoso-migration-rehost-vm-sql-managed-instance/architecture.png) 

### <a name="database-considerations"></a><span data-ttu-id="f7431-210">Database considerations</span><span class="sxs-lookup"><span data-stu-id="f7431-210">Database considerations</span></span>

<span data-ttu-id="f7431-211">As part of the solution design process, Contoso did a feature comparison between Azure SQL Database and SQL Server Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-211">As part of the solution design process, Contoso did a feature comparison between Azure SQL Database and SQL Server Managed Instance.</span></span> <span data-ttu-id="f7431-212">The following considerations helped them to decide to go with Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-212">The following considerations helped them to decide to go with Managed Instance.</span></span>

- <span data-ttu-id="f7431-213">Managed Instance aims to deliver almost 100% compatibility with the latest on-premises SQL Server version.</span><span class="sxs-lookup"><span data-stu-id="f7431-213">Managed Instance aims to deliver almost 100% compatibility with the latest on-premises SQL Server version.</span></span> <span data-ttu-id="f7431-214">Microsoft recommends Managed instance for customers running SQL Server on-premises or on IaaS VM who want to migrate their apps to a fully managed service with minimal design changes.</span><span class="sxs-lookup"><span data-stu-id="f7431-214">Microsoft recommends Managed instance for customers running SQL Server on-premises or on IaaS VM who want to migrate their apps to a fully managed service with minimal design changes.</span></span>
- <span data-ttu-id="f7431-215">Contoso is planning to migrate a large number of apps from on-premises to IaaS.</span><span class="sxs-lookup"><span data-stu-id="f7431-215">Contoso is planning to migrate a large number of apps from on-premises to IaaS.</span></span> <span data-ttu-id="f7431-216">Many of these are ISV provided.</span><span class="sxs-lookup"><span data-stu-id="f7431-216">Many of these are ISV provided.</span></span> <span data-ttu-id="f7431-217">Contoso realizes that using Managed Instance will help ensure database compatibility for these apps, rather than using SQL Database which might not be supported.</span><span class="sxs-lookup"><span data-stu-id="f7431-217">Contoso realizes that using Managed Instance will help ensure database compatibility for these apps, rather than using SQL Database which might not be supported.</span></span>
- <span data-ttu-id="f7431-218">Contoso can simply do a lift-and-shift migration to Managed Instance using the fully automated Data Migration Service (DMS).</span><span class="sxs-lookup"><span data-stu-id="f7431-218">Contoso can simply do a lift-and-shift migration to Managed Instance using the fully automated Data Migration Service (DMS).</span></span> <span data-ttu-id="f7431-219">With this service in place, Contoso can reuse it for future database migrations.</span><span class="sxs-lookup"><span data-stu-id="f7431-219">With this service in place, Contoso can reuse it for future database migrations.</span></span>
- <span data-ttu-id="f7431-220">SQL Managed Instance supports SQL Server Agent which is an important issue for the SmartHotel360 app.</span><span class="sxs-lookup"><span data-stu-id="f7431-220">SQL Managed Instance supports SQL Server Agent which is an important issue for the SmartHotel360 app.</span></span> <span data-ttu-id="f7431-221">Contoso needs this compatibility, otherwise it will have to redesign maintenance plans required by the app.</span><span class="sxs-lookup"><span data-stu-id="f7431-221">Contoso needs this compatibility, otherwise it will have to redesign maintenance plans required by the app.</span></span>
- <span data-ttu-id="f7431-222">With Software Assurance, Contoso can exchange their existing licenses for discounted rates on a SQL Database Managed Instance using the Azure Hybrid Benefit for SQL Server.</span><span class="sxs-lookup"><span data-stu-id="f7431-222">With Software Assurance, Contoso can exchange their existing licenses for discounted rates on a SQL Database Managed Instance using the Azure Hybrid Benefit for SQL Server.</span></span> <span data-ttu-id="f7431-223">This can allow Contoso to save up to 30% on Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-223">This can allow Contoso to save up to 30% on Managed Instance.</span></span>
- <span data-ttu-id="f7431-224">Managed Instance is fully contained in the virtual network, so it provides a high level of isolation and security for Contoso’s data.</span><span class="sxs-lookup"><span data-stu-id="f7431-224">Managed Instance is fully contained in the virtual network, so it provides a high level of isolation and security for Contoso’s data.</span></span> <span data-ttu-id="f7431-225">Contoso can get the benefits of the public cloud, while keeping the environment isolated from the public Internet.</span><span class="sxs-lookup"><span data-stu-id="f7431-225">Contoso can get the benefits of the public cloud, while keeping the environment isolated from the public Internet.</span></span>
- <span data-ttu-id="f7431-226">Managed Instance supports many security features including Always-encrypted, dynamic data masking, row-level security, and threat detection.</span><span class="sxs-lookup"><span data-stu-id="f7431-226">Managed Instance supports many security features including Always-encrypted, dynamic data masking, row-level security, and threat detection.</span></span>


### <a name="solution-review"></a><span data-ttu-id="f7431-227">Solution review</span><span class="sxs-lookup"><span data-stu-id="f7431-227">Solution review</span></span>

<span data-ttu-id="f7431-228">Contoso evaluates the proposed design by putting together a pros and cons list.</span><span class="sxs-lookup"><span data-stu-id="f7431-228">Contoso evaluates the proposed design by putting together a pros and cons list.</span></span>

<span data-ttu-id="f7431-229">**Consideration**</span><span class="sxs-lookup"><span data-stu-id="f7431-229">**Consideration**</span></span> | <span data-ttu-id="f7431-230">**Details**</span><span class="sxs-lookup"><span data-stu-id="f7431-230">**Details**</span></span>
--- | ---
<span data-ttu-id="f7431-231">**Pros**</span><span class="sxs-lookup"><span data-stu-id="f7431-231">**Pros**</span></span> |  <span data-ttu-id="f7431-232">WEBVM will be moved to Azure without changes, making the migration simple.</span><span class="sxs-lookup"><span data-stu-id="f7431-232">WEBVM will be moved to Azure without changes, making the migration simple.</span></span><br/><br/> <span data-ttu-id="f7431-233">SQL Managed Instance supports Contoso's technical requirements and goals.</span><span class="sxs-lookup"><span data-stu-id="f7431-233">SQL Managed Instance supports Contoso's technical requirements and goals.</span></span><br/><br/> <span data-ttu-id="f7431-234">Managed Instance will provide 100% compatibility with their current deployment, while moving them away from SQL Server 2008 R2.</span><span class="sxs-lookup"><span data-stu-id="f7431-234">Managed Instance will provide 100% compatibility with their current deployment, while moving them away from SQL Server 2008 R2.</span></span><br/><br/>  <span data-ttu-id="f7431-235">They can leverage their investment in Software Assurance and using the Azure Hybrid Benefit forSQL  Server and Windows Server.</span><span class="sxs-lookup"><span data-stu-id="f7431-235">They can leverage their investment in Software Assurance and using the Azure Hybrid Benefit forSQL  Server and Windows Server.</span></span><br/><br/> <span data-ttu-id="f7431-236">They can reuse the Database Migration Service for additional future migrations.</span><span class="sxs-lookup"><span data-stu-id="f7431-236">They can reuse the Database Migration Service for additional future migrations.</span></span><br/><br/> <span data-ttu-id="f7431-237">SQL Managed Instance has built in fault tolerance which Contoso doesn't need to configures.</span><span class="sxs-lookup"><span data-stu-id="f7431-237">SQL Managed Instance has built in fault tolerance which Contoso doesn't need to configures.</span></span> <span data-ttu-id="f7431-238">This ensures that the data tier is no longer a single point of failover.</span><span class="sxs-lookup"><span data-stu-id="f7431-238">This ensures that the data tier is no longer a single point of failover.</span></span>
<span data-ttu-id="f7431-239">**Cons**</span><span class="sxs-lookup"><span data-stu-id="f7431-239">**Cons**</span></span> | <span data-ttu-id="f7431-240">The WEBVM is running Windows Server 2008 R2.</span><span class="sxs-lookup"><span data-stu-id="f7431-240">The WEBVM is running Windows Server 2008 R2.</span></span>  <span data-ttu-id="f7431-241">Although this operating system is supported by Azure, it is no longer supported platform.</span><span class="sxs-lookup"><span data-stu-id="f7431-241">Although this operating system is supported by Azure, it is no longer supported platform.</span></span> <span data-ttu-id="f7431-242">[Learn more](https://support.microsoft.com/en-us/help/956893).</span><span class="sxs-lookup"><span data-stu-id="f7431-242">[Learn more](https://support.microsoft.com/en-us/help/956893).</span></span><br/><br/> <span data-ttu-id="f7431-243">The web tier remains a single point of failover with only WEBVM providing services.</span><span class="sxs-lookup"><span data-stu-id="f7431-243">The web tier remains a single point of failover with only WEBVM providing services.</span></span><br/><br/> <span data-ttu-id="f7431-244">Contoso will need to continue supporting the app web tier as a VM rather than moving to a managed service, such as Azure App Service.</span><span class="sxs-lookup"><span data-stu-id="f7431-244">Contoso will need to continue supporting the app web tier as a VM rather than moving to a managed service, such as Azure App Service.</span></span><br/><br/> <span data-ttu-id="f7431-245">For the data tier, Managed Instance might not be the best solution if Contoso want to customize the operating system or the database server, or if they want to run third-party apps along with SQL Server.</span><span class="sxs-lookup"><span data-stu-id="f7431-245">For the data tier, Managed Instance might not be the best solution if Contoso want to customize the operating system or the database server, or if they want to run third-party apps along with SQL Server.</span></span> <span data-ttu-id="f7431-246">Running SQL Server on an IaaS VM could provide this flexibility.</span><span class="sxs-lookup"><span data-stu-id="f7431-246">Running SQL Server on an IaaS VM could provide this flexibility.</span></span> 

### <a name="migration-process"></a><span data-ttu-id="f7431-247">Migration process</span><span class="sxs-lookup"><span data-stu-id="f7431-247">Migration process</span></span>

<span data-ttu-id="f7431-248">Contoso will migrate the web and data tiers of its SmartHotel360 app to Azure by completing these steps:</span><span class="sxs-lookup"><span data-stu-id="f7431-248">Contoso will migrate the web and data tiers of its SmartHotel360 app to Azure by completing these steps:</span></span>

1. <span data-ttu-id="f7431-249">Contoso already has its Azure infrastructure in place, so it just needs to add a couple of specific Azure components for this scenario.</span><span class="sxs-lookup"><span data-stu-id="f7431-249">Contoso already has its Azure infrastructure in place, so it just needs to add a couple of specific Azure components for this scenario.</span></span>
2. <span data-ttu-id="f7431-250">The data tier will be migrated by using the Data Migration Service.</span><span class="sxs-lookup"><span data-stu-id="f7431-250">The data tier will be migrated by using the Data Migration Service.</span></span> <span data-ttu-id="f7431-251">The Data Migration Service connects to the on-premises SQL Server VM across a site-to-site VPN connection between the Contoso datacenter and Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-251">The Data Migration Service connects to the on-premises SQL Server VM across a site-to-site VPN connection between the Contoso datacenter and Azure.</span></span> <span data-ttu-id="f7431-252">Then, the Data Migration Service migrates the database.</span><span class="sxs-lookup"><span data-stu-id="f7431-252">Then, the Data Migration Service migrates the database.</span></span>
3. <span data-ttu-id="f7431-253">The web tier will be migrated by using a lift-and-shift migration by using Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="f7431-253">The web tier will be migrated by using a lift-and-shift migration by using Site Recovery.</span></span> <span data-ttu-id="f7431-254">The process entails preparing the on-premises VMware environment, setting up and enabling replication, and migrating the VMs by failing them over to Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-254">The process entails preparing the on-premises VMware environment, setting up and enabling replication, and migrating the VMs by failing them over to Azure.</span></span>

     ![Migration architecture](media/contoso-migration-rehost-vm-sql-managed-instance/migration-architecture.png) 

### <a name="azure-services"></a><span data-ttu-id="f7431-256">Azure services</span><span class="sxs-lookup"><span data-stu-id="f7431-256">Azure services</span></span>

<span data-ttu-id="f7431-257">Service</span><span class="sxs-lookup"><span data-stu-id="f7431-257">Service</span></span> | <span data-ttu-id="f7431-258">Description</span><span class="sxs-lookup"><span data-stu-id="f7431-258">Description</span></span> | <span data-ttu-id="f7431-259">Cost</span><span class="sxs-lookup"><span data-stu-id="f7431-259">Cost</span></span>
--- | --- | ---
[<span data-ttu-id="f7431-260">Database Migration Service</span><span class="sxs-lookup"><span data-stu-id="f7431-260">Database Migration Service</span></span>](https://docs.microsoft.com/azure/dms/dms-overview) | <span data-ttu-id="f7431-261">The Database Migration Service enables seamless migration from multiple database sources to Azure data platforms with minimal downtime.</span><span class="sxs-lookup"><span data-stu-id="f7431-261">The Database Migration Service enables seamless migration from multiple database sources to Azure data platforms with minimal downtime.</span></span> | <span data-ttu-id="f7431-262">Learn about [supported regions](https://docs.microsoft.com/azure/dms/dms-overview#regional-availability) and [Database Migration Service pricing](https://azure.microsoft.com/pricing/details/database-migration/).</span><span class="sxs-lookup"><span data-stu-id="f7431-262">Learn about [supported regions](https://docs.microsoft.com/azure/dms/dms-overview#regional-availability) and [Database Migration Service pricing](https://azure.microsoft.com/pricing/details/database-migration/).</span></span>
[<span data-ttu-id="f7431-263">Azure SQL Database Managed Instance</span><span class="sxs-lookup"><span data-stu-id="f7431-263">Azure SQL Database Managed Instance</span></span>](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance) | <span data-ttu-id="f7431-264">Managed Instance is a managed database service that represents a fully managed SQL Server instance in the Azure cloud.</span><span class="sxs-lookup"><span data-stu-id="f7431-264">Managed Instance is a managed database service that represents a fully managed SQL Server instance in the Azure cloud.</span></span> <span data-ttu-id="f7431-265">It uses the same code as the latest version of SQL Server Database Engine, and has the latest features, performance improvements, and security patches.</span><span class="sxs-lookup"><span data-stu-id="f7431-265">It uses the same code as the latest version of SQL Server Database Engine, and has the latest features, performance improvements, and security patches.</span></span> | <span data-ttu-id="f7431-266">Using a SQL Database Managed Instance running in Azure incurs charges based on capacity.</span><span class="sxs-lookup"><span data-stu-id="f7431-266">Using a SQL Database Managed Instance running in Azure incurs charges based on capacity.</span></span> <span data-ttu-id="f7431-267">Learn more about [Managed Instance pricing](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span><span class="sxs-lookup"><span data-stu-id="f7431-267">Learn more about [Managed Instance pricing](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span></span> 
[<span data-ttu-id="f7431-268">Azure Site Recovery</span><span class="sxs-lookup"><span data-stu-id="f7431-268">Azure Site Recovery</span></span>](https://docs.microsoft.com/azure/site-recovery/) | <span data-ttu-id="f7431-269">The Site Recovery service orchestrates and manages migration and disaster recovery for Azure VMs and on-premises VMs and physical servers.</span><span class="sxs-lookup"><span data-stu-id="f7431-269">The Site Recovery service orchestrates and manages migration and disaster recovery for Azure VMs and on-premises VMs and physical servers.</span></span>  | <span data-ttu-id="f7431-270">During replication to Azure, Azure Storage charges are incurred.</span><span class="sxs-lookup"><span data-stu-id="f7431-270">During replication to Azure, Azure Storage charges are incurred.</span></span>  <span data-ttu-id="f7431-271">Azure VMs are created and incur charges when failover occurs.</span><span class="sxs-lookup"><span data-stu-id="f7431-271">Azure VMs are created and incur charges when failover occurs.</span></span> <span data-ttu-id="f7431-272">Learn more about [Site Recovery charges and pricing](https://azure.microsoft.com/pricing/details/site-recovery/).</span><span class="sxs-lookup"><span data-stu-id="f7431-272">Learn more about [Site Recovery charges and pricing](https://azure.microsoft.com/pricing/details/site-recovery/).</span></span>

 

## <a name="prerequisites"></a><span data-ttu-id="f7431-273">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="f7431-273">Prerequisites</span></span>

<span data-ttu-id="f7431-274">Contoso and other users must meet the following prerequisites for this scenario:</span><span class="sxs-lookup"><span data-stu-id="f7431-274">Contoso and other users must meet the following prerequisites for this scenario:</span></span>

<span data-ttu-id="f7431-275">Requirements</span><span class="sxs-lookup"><span data-stu-id="f7431-275">Requirements</span></span> | <span data-ttu-id="f7431-276">Details</span><span class="sxs-lookup"><span data-stu-id="f7431-276">Details</span></span>
--- | ---
<span data-ttu-id="f7431-277">**Enroll in the Managed Instance preview**</span><span class="sxs-lookup"><span data-stu-id="f7431-277">**Enroll in the Managed Instance preview**</span></span> | <span data-ttu-id="f7431-278">You must be enrolled in the SQL Database Managed Instance limited public preview.</span><span class="sxs-lookup"><span data-stu-id="f7431-278">You must be enrolled in the SQL Database Managed Instance limited public preview.</span></span> <span data-ttu-id="f7431-279">You need an Azure subscription to [sign up](https://portal.azure.com#create/Microsoft.SQLManagedInstance).</span><span class="sxs-lookup"><span data-stu-id="f7431-279">You need an Azure subscription to [sign up](https://portal.azure.com#create/Microsoft.SQLManagedInstance).</span></span> <span data-ttu-id="f7431-280">Signup can take a few days to complete, so make sure to sign up before you begin to deploy this scenario.</span><span class="sxs-lookup"><span data-stu-id="f7431-280">Signup can take a few days to complete, so make sure to sign up before you begin to deploy this scenario.</span></span>
<span data-ttu-id="f7431-281">**Azure subscription**</span><span class="sxs-lookup"><span data-stu-id="f7431-281">**Azure subscription**</span></span> | <span data-ttu-id="f7431-282">You should have already created a subscription when you perform the assessment in the first article in this series.</span><span class="sxs-lookup"><span data-stu-id="f7431-282">You should have already created a subscription when you perform the assessment in the first article in this series.</span></span> <span data-ttu-id="f7431-283">If you don't have an Azure subscription, create a [free account](https://azure.microsoft.com/pricing/free-trial/).</span><span class="sxs-lookup"><span data-stu-id="f7431-283">If you don't have an Azure subscription, create a [free account](https://azure.microsoft.com/pricing/free-trial/).</span></span><br/><br/> <span data-ttu-id="f7431-284">If you create a free account, you're the administrator of your subscription and can perform all actions.</span><span class="sxs-lookup"><span data-stu-id="f7431-284">If you create a free account, you're the administrator of your subscription and can perform all actions.</span></span><br/><br/> <span data-ttu-id="f7431-285">If you use an existing subscription and you're not the administrator of the subscription, you need to work with the admin to assign you Owner or Contributor permissions.</span><span class="sxs-lookup"><span data-stu-id="f7431-285">If you use an existing subscription and you're not the administrator of the subscription, you need to work with the admin to assign you Owner or Contributor permissions.</span></span><br/><br/> <span data-ttu-id="f7431-286">If you need more granular permissions, see [Use role-based access control to manage Site Recovery access](../site-recovery/site-recovery-role-based-linked-access-control.md).</span><span class="sxs-lookup"><span data-stu-id="f7431-286">If you need more granular permissions, see [Use role-based access control to manage Site Recovery access](../site-recovery/site-recovery-role-based-linked-access-control.md).</span></span> 
<span data-ttu-id="f7431-287">**Site Recovery (on-premises)**</span><span class="sxs-lookup"><span data-stu-id="f7431-287">**Site Recovery (on-premises)**</span></span> | <span data-ttu-id="f7431-288">Your on-premises vCenter Server instance should be running version 5.5, 6.0, or 6.5</span><span class="sxs-lookup"><span data-stu-id="f7431-288">Your on-premises vCenter Server instance should be running version 5.5, 6.0, or 6.5</span></span><br/><br/> <span data-ttu-id="f7431-289">An ESXi host running version 5.5, 6.0, or 6.5</span><span class="sxs-lookup"><span data-stu-id="f7431-289">An ESXi host running version 5.5, 6.0, or 6.5</span></span><br/><br/> <span data-ttu-id="f7431-290">One or more VMware VMs running on the ESXi host.</span><span class="sxs-lookup"><span data-stu-id="f7431-290">One or more VMware VMs running on the ESXi host.</span></span><br/><br/> <span data-ttu-id="f7431-291">VMs must meet [Azure requirements](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).</span><span class="sxs-lookup"><span data-stu-id="f7431-291">VMs must meet [Azure requirements](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements).</span></span><br/><br/> <span data-ttu-id="f7431-292">Supported [network](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) and [storage](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage) configuration.</span><span class="sxs-lookup"><span data-stu-id="f7431-292">Supported [network](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network) and [storage](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage) configuration.</span></span>
<span data-ttu-id="f7431-293">**Database Migration Service**</span><span class="sxs-lookup"><span data-stu-id="f7431-293">**Database Migration Service**</span></span> | <span data-ttu-id="f7431-294">For the Database Migration Service, you need a [compatible on-premises VPN device](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-devices).</span><span class="sxs-lookup"><span data-stu-id="f7431-294">For the Database Migration Service, you need a [compatible on-premises VPN device](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-devices).</span></span><br/><br/> <span data-ttu-id="f7431-295">You must be able to configure the on-premises VPN device.</span><span class="sxs-lookup"><span data-stu-id="f7431-295">You must be able to configure the on-premises VPN device.</span></span> <span data-ttu-id="f7431-296">It must have an external-facing public IPv4 address.</span><span class="sxs-lookup"><span data-stu-id="f7431-296">It must have an external-facing public IPv4 address.</span></span> <span data-ttu-id="f7431-297">The address can't be located behind a NAT device.</span><span class="sxs-lookup"><span data-stu-id="f7431-297">The address can't be located behind a NAT device.</span></span><br/><br/> <span data-ttu-id="f7431-298">Make sure you have access to your on-premises SQL Server database.</span><span class="sxs-lookup"><span data-stu-id="f7431-298">Make sure you have access to your on-premises SQL Server database.</span></span><br/><br/> <span data-ttu-id="f7431-299">Windows Firewall should be able to access the source database engine.</span><span class="sxs-lookup"><span data-stu-id="f7431-299">Windows Firewall should be able to access the source database engine.</span></span> <span data-ttu-id="f7431-300">Learn how to [configure Windows Firewall for Database Engine access](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access).</span><span class="sxs-lookup"><span data-stu-id="f7431-300">Learn how to [configure Windows Firewall for Database Engine access](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access).</span></span><br/><br/> <span data-ttu-id="f7431-301">If there's a firewall in front of your database machine, add rules to allow access to the database and files via SMB port 445.</span><span class="sxs-lookup"><span data-stu-id="f7431-301">If there's a firewall in front of your database machine, add rules to allow access to the database and files via SMB port 445.</span></span><br/><br/> <span data-ttu-id="f7431-302">The credentials that are used to connect to the source SQL Server instance and which target Managed Instance must be members of the sysadmin server role.</span><span class="sxs-lookup"><span data-stu-id="f7431-302">The credentials that are used to connect to the source SQL Server instance and which target Managed Instance must be members of the sysadmin server role.</span></span><br/><br/> <span data-ttu-id="f7431-303">You need a network share in your on-premises database that the Database Migration Service can use to back up the source database.</span><span class="sxs-lookup"><span data-stu-id="f7431-303">You need a network share in your on-premises database that the Database Migration Service can use to back up the source database.</span></span><br/><br/> <span data-ttu-id="f7431-304">Make sure that the service account running the source SQL Server instance has write permissions on the network share.</span><span class="sxs-lookup"><span data-stu-id="f7431-304">Make sure that the service account running the source SQL Server instance has write permissions on the network share.</span></span><br/><br/> <span data-ttu-id="f7431-305">Make a note of a Windows user and password that has full control permissions on the network share.</span><span class="sxs-lookup"><span data-stu-id="f7431-305">Make a note of a Windows user and password that has full control permissions on the network share.</span></span> <span data-ttu-id="f7431-306">The Database Migration Service impersonates these user credentials to upload backup files to the Azure Storage container.</span><span class="sxs-lookup"><span data-stu-id="f7431-306">The Database Migration Service impersonates these user credentials to upload backup files to the Azure Storage container.</span></span><br/><br/> <span data-ttu-id="f7431-307">The SQL Server Express installation process sets the TCP/IP protocol to **Disabled** by default.</span><span class="sxs-lookup"><span data-stu-id="f7431-307">The SQL Server Express installation process sets the TCP/IP protocol to **Disabled** by default.</span></span> <span data-ttu-id="f7431-308">Make sure that it's enabled.</span><span class="sxs-lookup"><span data-stu-id="f7431-308">Make sure that it's enabled.</span></span>

## <a name="scenario-steps"></a><span data-ttu-id="f7431-309">Scenario steps</span><span class="sxs-lookup"><span data-stu-id="f7431-309">Scenario steps</span></span>

<span data-ttu-id="f7431-310">Here's how Contoso plans to set up the deployment:</span><span class="sxs-lookup"><span data-stu-id="f7431-310">Here's how Contoso plans to set up the deployment:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="f7431-311">**Step 1: Set up a SQL Database Managed Instance**: Contoso needs a pre-created Managed Instance to which the on-premises SQL Server database will migrate.</span><span class="sxs-lookup"><span data-stu-id="f7431-311">**Step 1: Set up a SQL Database Managed Instance**: Contoso needs a pre-created Managed Instance to which the on-premises SQL Server database will migrate.</span></span>
> * <span data-ttu-id="f7431-312">**Step 2: Prepare the Database Migration Service**: Contoso must register the database migration provider, create an instance, and then create a Database Migration Service project.</span><span class="sxs-lookup"><span data-stu-id="f7431-312">**Step 2: Prepare the Database Migration Service**: Contoso must register the database migration provider, create an instance, and then create a Database Migration Service project.</span></span> <span data-ttu-id="f7431-313">Contoso also must set up a shared access signature (SAS) Uniform Resource Identifier (URI) for the Database Migration Service.</span><span class="sxs-lookup"><span data-stu-id="f7431-313">Contoso also must set up a shared access signature (SAS) Uniform Resource Identifier (URI) for the Database Migration Service.</span></span> <span data-ttu-id="f7431-314">An SAS URI provides delegated access to resources in Contoso's storage account, so Contoso can grant limited permissions to storage objects.</span><span class="sxs-lookup"><span data-stu-id="f7431-314">An SAS URI provides delegated access to resources in Contoso's storage account, so Contoso can grant limited permissions to storage objects.</span></span> <span data-ttu-id="f7431-315">Contoso sets up an SAS URI, so the Database Migration Service can access the storage account container to which the service uploads the SQL Server backup files.</span><span class="sxs-lookup"><span data-stu-id="f7431-315">Contoso sets up an SAS URI, so the Database Migration Service can access the storage account container to which the service uploads the SQL Server backup files.</span></span>
> * <span data-ttu-id="f7431-316">**Step 3: Prepare Azure for Site Recovery**: Contoso must create a storage account to hold replicated data for Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="f7431-316">**Step 3: Prepare Azure for Site Recovery**: Contoso must create a storage account to hold replicated data for Site Recovery.</span></span> <span data-ttu-id="f7431-317">It also must create an Azure Recovery Services vault.</span><span class="sxs-lookup"><span data-stu-id="f7431-317">It also must create an Azure Recovery Services vault.</span></span>
> * <span data-ttu-id="f7431-318">**Step 4: Prepare on-premises VMware for Site Recovery**: Contoso will prepare accounts for VM discovery and agent installation to connect to Azure VMs after failover.</span><span class="sxs-lookup"><span data-stu-id="f7431-318">**Step 4: Prepare on-premises VMware for Site Recovery**: Contoso will prepare accounts for VM discovery and agent installation to connect to Azure VMs after failover.</span></span>
> * <span data-ttu-id="f7431-319">**Step 5: Replicate VMs**: To set up replication, Contoso configure the Site Recovery source and target environments, sets up a replication policy, and starts replicating VMs to Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="f7431-319">**Step 5: Replicate VMs**: To set up replication, Contoso configure the Site Recovery source and target environments, sets up a replication policy, and starts replicating VMs to Azure Storage.</span></span>
> * <span data-ttu-id="f7431-320">**Step 6: Migrate the database by using the Database Migration Service**: Contoso migrates the database.</span><span class="sxs-lookup"><span data-stu-id="f7431-320">**Step 6: Migrate the database by using the Database Migration Service**: Contoso migrates the database.</span></span>
> * <span data-ttu-id="f7431-321">**Step 7: Migrate the VMs by using Site Recovery**: Contoso runs a test failover to make sure everything's working.</span><span class="sxs-lookup"><span data-stu-id="f7431-321">**Step 7: Migrate the VMs by using Site Recovery**: Contoso runs a test failover to make sure everything's working.</span></span> <span data-ttu-id="f7431-322">Then, Contoso runs a full failover to migrate the VMs to Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-322">Then, Contoso runs a full failover to migrate the VMs to Azure.</span></span>

## <a name="step-1-prepare-a-sql-database-managed-instance"></a><span data-ttu-id="f7431-323">Step 1: Prepare a SQL Database Managed Instance</span><span class="sxs-lookup"><span data-stu-id="f7431-323">Step 1: Prepare a SQL Database Managed Instance</span></span>

<span data-ttu-id="f7431-324">To set up an Azure SQL Database Managed Instance, Contoso needs a subnet that meets the following requirements:</span><span class="sxs-lookup"><span data-stu-id="f7431-324">To set up an Azure SQL Database Managed Instance, Contoso needs a subnet that meets the following requirements:</span></span>

- <span data-ttu-id="f7431-325">The subnet must be dedicated.</span><span class="sxs-lookup"><span data-stu-id="f7431-325">The subnet must be dedicated.</span></span> <span data-ttu-id="f7431-326">It must be empty, and it can't contain any other cloud service.</span><span class="sxs-lookup"><span data-stu-id="f7431-326">It must be empty, and it can't contain any other cloud service.</span></span> <span data-ttu-id="f7431-327">The subnet can't be a gateway subnet.</span><span class="sxs-lookup"><span data-stu-id="f7431-327">The subnet can't be a gateway subnet.</span></span>
- <span data-ttu-id="f7431-328">After the Managed Instance is created, Contoso should not add resources to the subnet.</span><span class="sxs-lookup"><span data-stu-id="f7431-328">After the Managed Instance is created, Contoso should not add resources to the subnet.</span></span>
- <span data-ttu-id="f7431-329">The subnet can't have a network security group associated with it.</span><span class="sxs-lookup"><span data-stu-id="f7431-329">The subnet can't have a network security group associated with it.</span></span>
- <span data-ttu-id="f7431-330">The subnet must have a user-defined routing (UDR) route table.</span><span class="sxs-lookup"><span data-stu-id="f7431-330">The subnet must have a user-defined routing (UDR) route table.</span></span> <span data-ttu-id="f7431-331">The only route assigned should be 0.0.0.0/0 next hop internet.</span><span class="sxs-lookup"><span data-stu-id="f7431-331">The only route assigned should be 0.0.0.0/0 next hop internet.</span></span> 
- <span data-ttu-id="f7431-332">Optional custom DNS: If custom DNS is specified on the Azure virtual network, Azure's recursive resolvers IP address (such as 168.63.129.16) must be added to the list.</span><span class="sxs-lookup"><span data-stu-id="f7431-332">Optional custom DNS: If custom DNS is specified on the Azure virtual network, Azure's recursive resolvers IP address (such as 168.63.129.16) must be added to the list.</span></span> <span data-ttu-id="f7431-333">Learn how to [configure custom DNS for a Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).</span><span class="sxs-lookup"><span data-stu-id="f7431-333">Learn how to [configure custom DNS for a Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).</span></span>
- <span data-ttu-id="f7431-334">The subnet mustn't have a service endpoint (storage or SQL) associated with it.</span><span class="sxs-lookup"><span data-stu-id="f7431-334">The subnet mustn't have a service endpoint (storage or SQL) associated with it.</span></span> <span data-ttu-id="f7431-335">Service endpoints should be disabled on the virtual network.</span><span class="sxs-lookup"><span data-stu-id="f7431-335">Service endpoints should be disabled on the virtual network.</span></span>
- <span data-ttu-id="f7431-336">The subnet must have a minimum of 16 IP addresses.</span><span class="sxs-lookup"><span data-stu-id="f7431-336">The subnet must have a minimum of 16 IP addresses.</span></span> <span data-ttu-id="f7431-337">Learn how to [size the Managed Instance subnet](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration#determine-the-size-of-subnet-for-managed-instances).</span><span class="sxs-lookup"><span data-stu-id="f7431-337">Learn how to [size the Managed Instance subnet](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration#determine-the-size-of-subnet-for-managed-instances).</span></span>
- <span data-ttu-id="f7431-338">In Contoso's hybrid environment, custom DNS settings are required.</span><span class="sxs-lookup"><span data-stu-id="f7431-338">In Contoso's hybrid environment, custom DNS settings are required.</span></span> <span data-ttu-id="f7431-339">Contoso configures DNS settings to use one or more of the company's Azure DNS servers.</span><span class="sxs-lookup"><span data-stu-id="f7431-339">Contoso configures DNS settings to use one or more of the company's Azure DNS servers.</span></span> <span data-ttu-id="f7431-340">Learn more about [DNS customization](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).</span><span class="sxs-lookup"><span data-stu-id="f7431-340">Learn more about [DNS customization](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns).</span></span>

### <a name="set-up-a-virtual-network-for-the-managed-instance"></a><span data-ttu-id="f7431-341">Set up a virtual network for the Managed Instance</span><span class="sxs-lookup"><span data-stu-id="f7431-341">Set up a virtual network for the Managed Instance</span></span>

<span data-ttu-id="f7431-342">Contoso admins set up the virtual network as follows:</span><span class="sxs-lookup"><span data-stu-id="f7431-342">Contoso admins set up the virtual network as follows:</span></span> 

1. <span data-ttu-id="f7431-343">They create a new virtual network (**VNET-SQLMI-EU2**) in the primary East US 2 region.</span><span class="sxs-lookup"><span data-stu-id="f7431-343">They create a new virtual network (**VNET-SQLMI-EU2**) in the primary East US 2 region.</span></span> <span data-ttu-id="f7431-344">It adds the virtual network to the **ContosoNetworkingRG** resource group.</span><span class="sxs-lookup"><span data-stu-id="f7431-344">It adds the virtual network to the **ContosoNetworkingRG** resource group.</span></span>
2. <span data-ttu-id="f7431-345">They assign an address space of 10.235.0.0/24.</span><span class="sxs-lookup"><span data-stu-id="f7431-345">They assign an address space of 10.235.0.0/24.</span></span> <span data-ttu-id="f7431-346">They ensure that the range doesn't overlap with any other networks in its enterprise.</span><span class="sxs-lookup"><span data-stu-id="f7431-346">They ensure that the range doesn't overlap with any other networks in its enterprise.</span></span>
3. <span data-ttu-id="f7431-347">They add two subnets to the network:</span><span class="sxs-lookup"><span data-stu-id="f7431-347">They add two subnets to the network:</span></span>
    - <span data-ttu-id="f7431-348">**SQLMI-DS-EUS2** (10.235.0.0.25)</span><span class="sxs-lookup"><span data-stu-id="f7431-348">**SQLMI-DS-EUS2** (10.235.0.0.25)</span></span>
    - <span data-ttu-id="f7431-349">**SQLMI-SAW-EUS2** (10.235.0.128/29).</span><span class="sxs-lookup"><span data-stu-id="f7431-349">**SQLMI-SAW-EUS2** (10.235.0.128/29).</span></span> <span data-ttu-id="f7431-350">This subnet is used to attach a directory to the Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-350">This subnet is used to attach a directory to the Managed Instance.</span></span>

    ![Managed Instance - Create virtual network](media/contoso-migration-rehost-vm-sql-managed-instance/mi-vnet.png)

4. <span data-ttu-id="f7431-352">After the virtual network and subnets are deployed, they peer networks as follows:</span><span class="sxs-lookup"><span data-stu-id="f7431-352">After the virtual network and subnets are deployed, they peer networks as follows:</span></span>

    - <span data-ttu-id="f7431-353">Peers **VNET-SQLMI-EUS2** with **VNET-HUB-EUS2** (the hub virtual network for the East US 2).</span><span class="sxs-lookup"><span data-stu-id="f7431-353">Peers **VNET-SQLMI-EUS2** with **VNET-HUB-EUS2** (the hub virtual network for the East US 2).</span></span>
    - <span data-ttu-id="f7431-354">Peers **VNET-SQLMI-EUS2** with **VNET-PROD-EUS2** (the production network).</span><span class="sxs-lookup"><span data-stu-id="f7431-354">Peers **VNET-SQLMI-EUS2** with **VNET-PROD-EUS2** (the production network).</span></span>

    ![Network peering](media/contoso-migration-rehost-vm-sql-managed-instance/mi-peering.png)

5. <span data-ttu-id="f7431-356">They set custom DNS settings.</span><span class="sxs-lookup"><span data-stu-id="f7431-356">They set custom DNS settings.</span></span> <span data-ttu-id="f7431-357">DNS points first to Contoso's Azure domain controllers.</span><span class="sxs-lookup"><span data-stu-id="f7431-357">DNS points first to Contoso's Azure domain controllers.</span></span> <span data-ttu-id="f7431-358">Azure DNS is secondary.</span><span class="sxs-lookup"><span data-stu-id="f7431-358">Azure DNS is secondary.</span></span> <span data-ttu-id="f7431-359">The Contoso Azure domain controllers are located as follows:</span><span class="sxs-lookup"><span data-stu-id="f7431-359">The Contoso Azure domain controllers are located as follows:</span></span>

    - <span data-ttu-id="f7431-360">Located in the **PROD-DC-EUS2** subnet, in the East US 2 production network (**VNET-PROD-EUS2**)</span><span class="sxs-lookup"><span data-stu-id="f7431-360">Located in the **PROD-DC-EUS2** subnet, in the East US 2 production network (**VNET-PROD-EUS2**)</span></span>
    - <span data-ttu-id="f7431-361">**CONTOSODC3** address: 10.245.42.4</span><span class="sxs-lookup"><span data-stu-id="f7431-361">**CONTOSODC3** address: 10.245.42.4</span></span>
    - <span data-ttu-id="f7431-362">**CONTOSODC4** address: 10.245.42.5</span><span class="sxs-lookup"><span data-stu-id="f7431-362">**CONTOSODC4** address: 10.245.42.5</span></span>
    - <span data-ttu-id="f7431-363">Azure DNS resolver: 168.63.129.16</span><span class="sxs-lookup"><span data-stu-id="f7431-363">Azure DNS resolver: 168.63.129.16</span></span>

     ![Network DNS servers](media/contoso-migration-rehost-vm-sql-managed-instance/mi-dns.png)

<span data-ttu-id="f7431-365">*Need more help?*</span><span class="sxs-lookup"><span data-stu-id="f7431-365">*Need more help?*</span></span>

- <span data-ttu-id="f7431-366">Get an overview of [SQL Database Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance).</span><span class="sxs-lookup"><span data-stu-id="f7431-366">Get an overview of [SQL Database Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance).</span></span>
- <span data-ttu-id="f7431-367">Learn how to [create a virtual network for a SQL Database Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration#create-a-new-virtual-network-for-managed-instances).</span><span class="sxs-lookup"><span data-stu-id="f7431-367">Learn how to [create a virtual network for a SQL Database Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration#create-a-new-virtual-network-for-managed-instances).</span></span>
- <span data-ttu-id="f7431-368">Learn how to [set up peering](https://docs.microsoft.com/azure/virtual-network/virtual-network-manage-peering).</span><span class="sxs-lookup"><span data-stu-id="f7431-368">Learn how to [set up peering](https://docs.microsoft.com/azure/virtual-network/virtual-network-manage-peering).</span></span>
- <span data-ttu-id="f7431-369">Learn how to [update Azure Active Directory DNS settings](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-getting-started-dns).</span><span class="sxs-lookup"><span data-stu-id="f7431-369">Learn how to [update Azure Active Directory DNS settings](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-getting-started-dns).</span></span>

### <a name="set-up-routing"></a><span data-ttu-id="f7431-370">Set up routing</span><span class="sxs-lookup"><span data-stu-id="f7431-370">Set up routing</span></span>

<span data-ttu-id="f7431-371">The Managed Instance is placed in a private virtual network.</span><span class="sxs-lookup"><span data-stu-id="f7431-371">The Managed Instance is placed in a private virtual network.</span></span> <span data-ttu-id="f7431-372">Contoso needs a route table for the virtual network to communicate with the Azure Management Service.</span><span class="sxs-lookup"><span data-stu-id="f7431-372">Contoso needs a route table for the virtual network to communicate with the Azure Management Service.</span></span> <span data-ttu-id="f7431-373">If the virtual network can't communicate with the service that manages it, the virtual network becomes inaccessible.</span><span class="sxs-lookup"><span data-stu-id="f7431-373">If the virtual network can't communicate with the service that manages it, the virtual network becomes inaccessible.</span></span>

<span data-ttu-id="f7431-374">Contoso considers these factors:</span><span class="sxs-lookup"><span data-stu-id="f7431-374">Contoso considers these factors:</span></span>

- <span data-ttu-id="f7431-375">The route table contains a set of rules (routes) that specify how packets sent from the Managed Instance should be routed in the virtual network.</span><span class="sxs-lookup"><span data-stu-id="f7431-375">The route table contains a set of rules (routes) that specify how packets sent from the Managed Instance should be routed in the virtual network.</span></span>
- <span data-ttu-id="f7431-376">The route table is associated with subnets in which Managed Instances are deployed.</span><span class="sxs-lookup"><span data-stu-id="f7431-376">The route table is associated with subnets in which Managed Instances are deployed.</span></span> <span data-ttu-id="f7431-377">Each packet that leaves a subnet is handled based on the associated route table.</span><span class="sxs-lookup"><span data-stu-id="f7431-377">Each packet that leaves a subnet is handled based on the associated route table.</span></span>
- <span data-ttu-id="f7431-378">A subnet can be associated with only one route table.</span><span class="sxs-lookup"><span data-stu-id="f7431-378">A subnet can be associated with only one route table.</span></span>
- <span data-ttu-id="f7431-379">There are no additional charges for creating route tables in Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-379">There are no additional charges for creating route tables in Microsoft Azure.</span></span>

 <span data-ttu-id="f7431-380">To set up routing Contoso admins do the following:</span><span class="sxs-lookup"><span data-stu-id="f7431-380">To set up routing Contoso admins do the following:</span></span>

1. <span data-ttu-id="f7431-381">They create a UDR (route) table in the **ContosoNetworkingRG** resource group.</span><span class="sxs-lookup"><span data-stu-id="f7431-381">They create a UDR (route) table in the **ContosoNetworkingRG** resource group.</span></span>

    ![Route table](media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table.png)

2. <span data-ttu-id="f7431-383">To comply with Managed Instance requirements, after the route table (**MIRouteTable**) is deployed, they add a route that has an address prefix of 0.0.0.0/0.</span><span class="sxs-lookup"><span data-stu-id="f7431-383">To comply with Managed Instance requirements, after the route table (**MIRouteTable**) is deployed, they add a route that has an address prefix of 0.0.0.0/0.</span></span> <span data-ttu-id="f7431-384">The **Next hop type** option is set to **Internet**.</span><span class="sxs-lookup"><span data-stu-id="f7431-384">The **Next hop type** option is set to **Internet**.</span></span>

    ![Route table prefix](media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-prefix.png)
    
3. <span data-ttu-id="f7431-386">they associate the route table with the **SQLMI-DB-EUS2** subnet (in the **VNET-SQLMI-EUS2** network).</span><span class="sxs-lookup"><span data-stu-id="f7431-386">they associate the route table with the **SQLMI-DB-EUS2** subnet (in the **VNET-SQLMI-EUS2** network).</span></span> 

    ![Route table subnet](media/contoso-migration-rehost-vm-sql-managed-instance/mi-route-table-subnet.png)
    
<span data-ttu-id="f7431-388">*Need more help?*</span><span class="sxs-lookup"><span data-stu-id="f7431-388">*Need more help?*</span></span>

<span data-ttu-id="f7431-389">Learn how to [set up routes for a Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-create-tutorial-portal#create-new-route-table-and-a-route).</span><span class="sxs-lookup"><span data-stu-id="f7431-389">Learn how to [set up routes for a Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-create-tutorial-portal#create-new-route-table-and-a-route).</span></span>

### <a name="create-a-managed-instance"></a><span data-ttu-id="f7431-390">Create a Managed Instance</span><span class="sxs-lookup"><span data-stu-id="f7431-390">Create a Managed Instance</span></span>

<span data-ttu-id="f7431-391">Now, Contoso admins can provision a SQL Database Managed Instance:</span><span class="sxs-lookup"><span data-stu-id="f7431-391">Now, Contoso admins can provision a SQL Database Managed Instance:</span></span>

1. <span data-ttu-id="f7431-392">Because the Managed Instance serves a business app, they deploy the Managed Instance in the company's primary East US 2 region.</span><span class="sxs-lookup"><span data-stu-id="f7431-392">Because the Managed Instance serves a business app, they deploy the Managed Instance in the company's primary East US 2 region.</span></span> <span data-ttu-id="f7431-393">They add the Managed Instance to the **ContosoRG** resource group.</span><span class="sxs-lookup"><span data-stu-id="f7431-393">They add the Managed Instance to the **ContosoRG** resource group.</span></span>
2. <span data-ttu-id="f7431-394">They select a pricing tier, size compute, and storage for the instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-394">They select a pricing tier, size compute, and storage for the instance.</span></span> <span data-ttu-id="f7431-395">Learn more about [Managed Instance pricing](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span><span class="sxs-lookup"><span data-stu-id="f7431-395">Learn more about [Managed Instance pricing](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span></span>

    ![Managed Instance](media/contoso-migration-rehost-vm-sql-managed-instance/mi-create.png)

3. <span data-ttu-id="f7431-397">After the Managed Instance is deployed, two new resources appear in the **ContosoRG** resource group:</span><span class="sxs-lookup"><span data-stu-id="f7431-397">After the Managed Instance is deployed, two new resources appear in the **ContosoRG** resource group:</span></span>

    - <span data-ttu-id="f7431-398">A virtual cluster in case Contoso has multiple Managed Instances.</span><span class="sxs-lookup"><span data-stu-id="f7431-398">A virtual cluster in case Contoso has multiple Managed Instances.</span></span>
    - <span data-ttu-id="f7431-399">The SQL Server Database Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-399">The SQL Server Database Managed Instance.</span></span> 

    ![Managed Instance](media/contoso-migration-rehost-vm-sql-managed-instance/mi-resources.png)

<span data-ttu-id="f7431-401">*Need more help?*</span><span class="sxs-lookup"><span data-stu-id="f7431-401">*Need more help?*</span></span>

<span data-ttu-id="f7431-402">Learn how to [provision a Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-create-tutorial-portal).</span><span class="sxs-lookup"><span data-stu-id="f7431-402">Learn how to [provision a Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-create-tutorial-portal).</span></span>

## <a name="step-2-prepare-the-database-migration-service"></a><span data-ttu-id="f7431-403">Step 2: Prepare the Database Migration Service</span><span class="sxs-lookup"><span data-stu-id="f7431-403">Step 2: Prepare the Database Migration Service</span></span>

<span data-ttu-id="f7431-404">To prepare the Database Migration Service, Contoso admins need to do a few things:</span><span class="sxs-lookup"><span data-stu-id="f7431-404">To prepare the Database Migration Service, Contoso admins need to do a few things:</span></span>

- <span data-ttu-id="f7431-405">Register the Database Migration Service provider in Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-405">Register the Database Migration Service provider in Azure.</span></span>
- <span data-ttu-id="f7431-406">Provide the Database Migration Service with access to Azure Storage for uploading the backup files that are used to migrate a database.</span><span class="sxs-lookup"><span data-stu-id="f7431-406">Provide the Database Migration Service with access to Azure Storage for uploading the backup files that are used to migrate a database.</span></span> <span data-ttu-id="f7431-407">To provide access to Azure Storage, they create an Azure Blob storage container.</span><span class="sxs-lookup"><span data-stu-id="f7431-407">To provide access to Azure Storage, they create an Azure Blob storage container.</span></span> <span data-ttu-id="f7431-408">They generate an SAS URI for the Blob storage container.</span><span class="sxs-lookup"><span data-stu-id="f7431-408">They generate an SAS URI for the Blob storage container.</span></span> 
- <span data-ttu-id="f7431-409">Create a Database Migration Service project.</span><span class="sxs-lookup"><span data-stu-id="f7431-409">Create a Database Migration Service project.</span></span>

<span data-ttu-id="f7431-410">Then, they complete the following steps:</span><span class="sxs-lookup"><span data-stu-id="f7431-410">Then, they complete the following steps:</span></span>

1. <span data-ttu-id="f7431-411">They register the database migration provider under its subscription.</span><span class="sxs-lookup"><span data-stu-id="f7431-411">They register the database migration provider under its subscription.</span></span>
    <span data-ttu-id="f7431-412">![Database Migration Service - Register](media/contoso-migration-rehost-vm-sql-managed-instance/dms-subscription.png)</span><span class="sxs-lookup"><span data-stu-id="f7431-412">![Database Migration Service - Register](media/contoso-migration-rehost-vm-sql-managed-instance/dms-subscription.png)</span></span>

2. <span data-ttu-id="f7431-413">They create a Blob storage container.</span><span class="sxs-lookup"><span data-stu-id="f7431-413">They create a Blob storage container.</span></span> <span data-ttu-id="f7431-414">Contoso generates an SAS URI so that the Database Migration Service can access it.</span><span class="sxs-lookup"><span data-stu-id="f7431-414">Contoso generates an SAS URI so that the Database Migration Service can access it.</span></span>

    ![Database Migration Service - Generate an SAS URI](media/contoso-migration-rehost-vm-sql-managed-instance/dms-sas.png)

3. <span data-ttu-id="f7431-416">They create a Database Migration Service instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-416">They create a Database Migration Service instance.</span></span> 

    ![Database Migration Service - Create instance](media/contoso-migration-rehost-vm-sql-managed-instance/dms-instance.png)

4. <span data-ttu-id="f7431-418">They place the Database Migration Service instance in the **PROD-DC-EUS2** subnet of the **VNET-PROD-DC-EUS2** virtual network.</span><span class="sxs-lookup"><span data-stu-id="f7431-418">They place the Database Migration Service instance in the **PROD-DC-EUS2** subnet of the **VNET-PROD-DC-EUS2** virtual network.</span></span>
    - <span data-ttu-id="f7431-419">The Database Migration Service is placed here because the service must be in a virtual network that can access the on-premises SQL Server VM via a VPN gateway.</span><span class="sxs-lookup"><span data-stu-id="f7431-419">The Database Migration Service is placed here because the service must be in a virtual network that can access the on-premises SQL Server VM via a VPN gateway.</span></span>
    - <span data-ttu-id="f7431-420">The **VNET-PROD-EUS2** is peered to **VNET-HUB-EUS2** and is allowed to use remote gateways.</span><span class="sxs-lookup"><span data-stu-id="f7431-420">The **VNET-PROD-EUS2** is peered to **VNET-HUB-EUS2** and is allowed to use remote gateways.</span></span> <span data-ttu-id="f7431-421">The **Use remote gateways** option ensures that the Database Migration Service can communicate as required.</span><span class="sxs-lookup"><span data-stu-id="f7431-421">The **Use remote gateways** option ensures that the Database Migration Service can communicate as required.</span></span>

        ![Database Migration Service - Configure network](media/contoso-migration-rehost-vm-sql-managed-instance/dms-network.png)

<span data-ttu-id="f7431-423">*Need more help?*</span><span class="sxs-lookup"><span data-stu-id="f7431-423">*Need more help?*</span></span>

- <span data-ttu-id="f7431-424">Learn how to [set up the Database Migration Service](https://docs.microsoft.com/azure/dms/quickstart-create-data-migration-service-portal).</span><span class="sxs-lookup"><span data-stu-id="f7431-424">Learn how to [set up the Database Migration Service](https://docs.microsoft.com/azure/dms/quickstart-create-data-migration-service-portal).</span></span>
- <span data-ttu-id="f7431-425">Learn how to [create and use SAS](https://docs.microsoft.com/azure/storage/blobs/storage-dotnet-shared-access-signature-part-2).</span><span class="sxs-lookup"><span data-stu-id="f7431-425">Learn how to [create and use SAS](https://docs.microsoft.com/azure/storage/blobs/storage-dotnet-shared-access-signature-part-2).</span></span>


## <a name="step-3-prepare-azure-for-the-site-recovery-service"></a><span data-ttu-id="f7431-426">Step 3: Prepare Azure for the Site Recovery service</span><span class="sxs-lookup"><span data-stu-id="f7431-426">Step 3: Prepare Azure for the Site Recovery service</span></span>

<span data-ttu-id="f7431-427">Several Azure elements are required for Contoso to set up Site Recovery for migration of its web tier VM (**WEBMV**):</span><span class="sxs-lookup"><span data-stu-id="f7431-427">Several Azure elements are required for Contoso to set up Site Recovery for migration of its web tier VM (**WEBMV**):</span></span>

- <span data-ttu-id="f7431-428">A virtual network in which failed-over resources are located.</span><span class="sxs-lookup"><span data-stu-id="f7431-428">A virtual network in which failed-over resources are located.</span></span>
- <span data-ttu-id="f7431-429">A storage account to hold replicated data.</span><span class="sxs-lookup"><span data-stu-id="f7431-429">A storage account to hold replicated data.</span></span> 
- <span data-ttu-id="f7431-430">A Recovery Services vault in Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-430">A Recovery Services vault in Azure.</span></span>

<span data-ttu-id="f7431-431">Contoso admins set up Site Recovery as follows:</span><span class="sxs-lookup"><span data-stu-id="f7431-431">Contoso admins set up Site Recovery as follows:</span></span>

1. <span data-ttu-id="f7431-432">Because the VM is a web front end to the SmartHotel360 app, Contoso fails over the VM to its existing production network (**VNET-PROD-EUS2**) and subnet (**PROD-FE-EUS2**).</span><span class="sxs-lookup"><span data-stu-id="f7431-432">Because the VM is a web front end to the SmartHotel360 app, Contoso fails over the VM to its existing production network (**VNET-PROD-EUS2**) and subnet (**PROD-FE-EUS2**).</span></span> <span data-ttu-id="f7431-433">The network and subnet are located in the primary East US 2 region.</span><span class="sxs-lookup"><span data-stu-id="f7431-433">The network and subnet are located in the primary East US 2 region.</span></span> <span data-ttu-id="f7431-434">Contoso set up the network when it [deployed the Azure infrastructure](contoso-migration-infrastructure.md).</span><span class="sxs-lookup"><span data-stu-id="f7431-434">Contoso set up the network when it [deployed the Azure infrastructure](contoso-migration-infrastructure.md).</span></span>
2. <span data-ttu-id="f7431-435">They create a storage account (**contosovmsacc20180528**).</span><span class="sxs-lookup"><span data-stu-id="f7431-435">They create a storage account (**contosovmsacc20180528**).</span></span> <span data-ttu-id="f7431-436">Contoso uses a general-purpose account.</span><span class="sxs-lookup"><span data-stu-id="f7431-436">Contoso uses a general-purpose account.</span></span> <span data-ttu-id="f7431-437">Contoso selects standard storage and locally redundant storage replication.</span><span class="sxs-lookup"><span data-stu-id="f7431-437">Contoso selects standard storage and locally redundant storage replication.</span></span>

    ![Site Recovery - Create storage account](media/contoso-migration-rehost-vm-sql-managed-instance/asr-storage.png)

3. <span data-ttu-id="f7431-439">With the network and storage account in place, they create a vault (**ContosoMigrationVault**).</span><span class="sxs-lookup"><span data-stu-id="f7431-439">With the network and storage account in place, they create a vault (**ContosoMigrationVault**).</span></span> <span data-ttu-id="f7431-440">Contoso places the vault in the **ContosoFailoverRG** resource group, in the primary East US 2 region.</span><span class="sxs-lookup"><span data-stu-id="f7431-440">Contoso places the vault in the **ContosoFailoverRG** resource group, in the primary East US 2 region.</span></span>

    ![Recovery Services - Create vault](media/contoso-migration-rehost-vm-sql-managed-instance/asr-vault.png)

<span data-ttu-id="f7431-442">*Need more help?*</span><span class="sxs-lookup"><span data-stu-id="f7431-442">*Need more help?*</span></span>

<span data-ttu-id="f7431-443">Learn how to [set up Azure for Site Recovery](https://docs.microsoft.com/azure/site-recovery/tutorial-prepare-azure).</span><span class="sxs-lookup"><span data-stu-id="f7431-443">Learn how to [set up Azure for Site Recovery](https://docs.microsoft.com/azure/site-recovery/tutorial-prepare-azure).</span></span>


## <a name="step-4-prepare-on-premises-vmware-for-site-recovery"></a><span data-ttu-id="f7431-444">Step 4: Prepare on-premises VMware for Site Recovery</span><span class="sxs-lookup"><span data-stu-id="f7431-444">Step 4: Prepare on-premises VMware for Site Recovery</span></span>

<span data-ttu-id="f7431-445">To prepare VMware for Site Recovery, Contoso admins must complete these tasks:</span><span class="sxs-lookup"><span data-stu-id="f7431-445">To prepare VMware for Site Recovery, Contoso admins must complete these tasks:</span></span>

- <span data-ttu-id="f7431-446">Prepare an account on the vCenter Server instance or vSphere ESXi host.</span><span class="sxs-lookup"><span data-stu-id="f7431-446">Prepare an account on the vCenter Server instance or vSphere ESXi host.</span></span> <span data-ttu-id="f7431-447">The account automates VM discovery.</span><span class="sxs-lookup"><span data-stu-id="f7431-447">The account automates VM discovery.</span></span>
- <span data-ttu-id="f7431-448">Prepare an account that allows automatic installation of the Mobility Service on VMware VMs that Contoso wants to replicate.</span><span class="sxs-lookup"><span data-stu-id="f7431-448">Prepare an account that allows automatic installation of the Mobility Service on VMware VMs that Contoso wants to replicate.</span></span>
- <span data-ttu-id="f7431-449">Prepare on-premises VMs to connect to Azure VMs when they're created after failover.</span><span class="sxs-lookup"><span data-stu-id="f7431-449">Prepare on-premises VMs to connect to Azure VMs when they're created after failover.</span></span>


### <a name="prepare-an-account-for-automatic-discovery"></a><span data-ttu-id="f7431-450">Prepare an account for automatic discovery</span><span class="sxs-lookup"><span data-stu-id="f7431-450">Prepare an account for automatic discovery</span></span>

<span data-ttu-id="f7431-451">Site Recovery needs access to VMware servers to:</span><span class="sxs-lookup"><span data-stu-id="f7431-451">Site Recovery needs access to VMware servers to:</span></span>

- <span data-ttu-id="f7431-452">Automatically discover VMs.</span><span class="sxs-lookup"><span data-stu-id="f7431-452">Automatically discover VMs.</span></span> <span data-ttu-id="f7431-453">A minimum of a read-only account is required.</span><span class="sxs-lookup"><span data-stu-id="f7431-453">A minimum of a read-only account is required.</span></span>
- <span data-ttu-id="f7431-454">Orchestrate replication, failover, and failback.</span><span class="sxs-lookup"><span data-stu-id="f7431-454">Orchestrate replication, failover, and failback.</span></span> <span data-ttu-id="f7431-455">Contoso needs an account that can run operations such as creating and removing disks and turning on VMs.</span><span class="sxs-lookup"><span data-stu-id="f7431-455">Contoso needs an account that can run operations such as creating and removing disks and turning on VMs.</span></span>

<span data-ttu-id="f7431-456">Contoso admins set up the account by completing these tasks:</span><span class="sxs-lookup"><span data-stu-id="f7431-456">Contoso admins set up the account by completing these tasks:</span></span>

1. <span data-ttu-id="f7431-457">Creates a role at the vCenter level.</span><span class="sxs-lookup"><span data-stu-id="f7431-457">Creates a role at the vCenter level.</span></span>
2. <span data-ttu-id="f7431-458">Assigns the required permissions to that role.</span><span class="sxs-lookup"><span data-stu-id="f7431-458">Assigns the required permissions to that role.</span></span>

<span data-ttu-id="f7431-459">*Need more help?*</span><span class="sxs-lookup"><span data-stu-id="f7431-459">*Need more help?*</span></span>

<span data-ttu-id="f7431-460">Learn how to [create and assign a role for automatic discovery](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-automatic-discovery).</span><span class="sxs-lookup"><span data-stu-id="f7431-460">Learn how to [create and assign a role for automatic discovery](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-automatic-discovery).</span></span>

### <a name="prepare-an-account-for-mobility-service-installation"></a><span data-ttu-id="f7431-461">Prepare an account for Mobility Service installation</span><span class="sxs-lookup"><span data-stu-id="f7431-461">Prepare an account for Mobility Service installation</span></span>

<span data-ttu-id="f7431-462">The Mobility Service must be installed on the VM that Contoso wants to replicate.</span><span class="sxs-lookup"><span data-stu-id="f7431-462">The Mobility Service must be installed on the VM that Contoso wants to replicate.</span></span> <span data-ttu-id="f7431-463">Contoso considers these factors about the Mobility Service:</span><span class="sxs-lookup"><span data-stu-id="f7431-463">Contoso considers these factors about the Mobility Service:</span></span>

- <span data-ttu-id="f7431-464">Site Recovery can do an automatic push installation of this component when Contoso enables replication for the VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-464">Site Recovery can do an automatic push installation of this component when Contoso enables replication for the VM.</span></span>
- <span data-ttu-id="f7431-465">For automatic push installation, Contoso must prepare an account that Site Recovery uses to access the VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-465">For automatic push installation, Contoso must prepare an account that Site Recovery uses to access the VM.</span></span>
- <span data-ttu-id="f7431-466">This account is specified when replication is configured in the Azure console.</span><span class="sxs-lookup"><span data-stu-id="f7431-466">This account is specified when replication is configured in the Azure console.</span></span>
- <span data-ttu-id="f7431-467">Contoso must have a domain or local account with permissions to install on the VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-467">Contoso must have a domain or local account with permissions to install on the VM.</span></span>

<span data-ttu-id="f7431-468">*Need more help*</span><span class="sxs-lookup"><span data-stu-id="f7431-468">*Need more help*</span></span>

<span data-ttu-id="f7431-469">Learn how to [create an account for push installation of the Mobility Service](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-mobility-service-installation).</span><span class="sxs-lookup"><span data-stu-id="f7431-469">Learn how to [create an account for push installation of the Mobility Service](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial-prepare-on-premises#prepare-an-account-for-mobility-service-installation).</span></span>

### <a name="prepare-to-connect-to-azure-vms-after-failover"></a><span data-ttu-id="f7431-470">Prepare to connect to Azure VMs after failover</span><span class="sxs-lookup"><span data-stu-id="f7431-470">Prepare to connect to Azure VMs after failover</span></span>

<span data-ttu-id="f7431-471">After failover to Azure, Contoso wants to be able to connect to the replicated VMs in Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-471">After failover to Azure, Contoso wants to be able to connect to the replicated VMs in Azure.</span></span> <span data-ttu-id="f7431-472">To connect to the replicated VMs in Azure, Contoso admins must complete a few tasks on the on-premises VM before the migration:</span><span class="sxs-lookup"><span data-stu-id="f7431-472">To connect to the replicated VMs in Azure, Contoso admins must complete a few tasks on the on-premises VM before the migration:</span></span> 

1. <span data-ttu-id="f7431-473">For access over the internet, they enable RDP on the on-premises VM before failover.</span><span class="sxs-lookup"><span data-stu-id="f7431-473">For access over the internet, they enable RDP on the on-premises VM before failover.</span></span> <span data-ttu-id="f7431-474">They ensure that TCP and UDP rules are added for the **Public** profile, and that RDP is allowed in **Windows Firewall** > **Allowed Apps** for all profiles.</span><span class="sxs-lookup"><span data-stu-id="f7431-474">They ensure that TCP and UDP rules are added for the **Public** profile, and that RDP is allowed in **Windows Firewall** > **Allowed Apps** for all profiles.</span></span>
2. <span data-ttu-id="f7431-475">For access over Contoso's site-to-site VPN, they enable RDP on the on-premises machine.</span><span class="sxs-lookup"><span data-stu-id="f7431-475">For access over Contoso's site-to-site VPN, they enable RDP on the on-premises machine.</span></span> <span data-ttu-id="f7431-476">They allow RDP in **Windows Firewall** > **Allowed apps and features** for **Domain and Private** networks.</span><span class="sxs-lookup"><span data-stu-id="f7431-476">They allow RDP in **Windows Firewall** > **Allowed apps and features** for **Domain and Private** networks.</span></span>
3. <span data-ttu-id="f7431-477">They set the operating system's SAN policy on the on-premises VM to **OnlineAll**.</span><span class="sxs-lookup"><span data-stu-id="f7431-477">They set the operating system's SAN policy on the on-premises VM to **OnlineAll**.</span></span>

<span data-ttu-id="f7431-478">Contoso admins also need to check these items when they run a failover:</span><span class="sxs-lookup"><span data-stu-id="f7431-478">Contoso admins also need to check these items when they run a failover:</span></span>

- <span data-ttu-id="f7431-479">There should be no Windows updates pending on the VM when a failover is triggered.</span><span class="sxs-lookup"><span data-stu-id="f7431-479">There should be no Windows updates pending on the VM when a failover is triggered.</span></span> <span data-ttu-id="f7431-480">If Windows updates are pending, users Contoso can't sign in to the virtual machine until the update is finished.</span><span class="sxs-lookup"><span data-stu-id="f7431-480">If Windows updates are pending, users Contoso can't sign in to the virtual machine until the update is finished.</span></span>
- <span data-ttu-id="f7431-481">After failover, admins should check **Boot diagnostics** to view a screenshot of the VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-481">After failover, admins should check **Boot diagnostics** to view a screenshot of the VM.</span></span> <span data-ttu-id="f7431-482">If they can't view the boot diagnostics, they should check that the VM is running, and then review [troubleshooting tips](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).</span><span class="sxs-lookup"><span data-stu-id="f7431-482">If they can't view the boot diagnostics, they should check that the VM is running, and then review [troubleshooting tips](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).</span></span>

## <a name="step-5-replicate-the-on-premises-vms-to-azure"></a><span data-ttu-id="f7431-483">Step 5: Replicate the on-premises VMs to Azure</span><span class="sxs-lookup"><span data-stu-id="f7431-483">Step 5: Replicate the on-premises VMs to Azure</span></span>

<span data-ttu-id="f7431-484">Before running a migration to Azure, Contoso admins need to set up and enable replication for the on-premises VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-484">Before running a migration to Azure, Contoso admins need to set up and enable replication for the on-premises VM.</span></span>

### <a name="set-a-replication-goal"></a><span data-ttu-id="f7431-485">Set a replication goal</span><span class="sxs-lookup"><span data-stu-id="f7431-485">Set a replication goal</span></span>

1. <span data-ttu-id="f7431-486">In the vault, under the vault name (**ContosoVMVault**), they set a replication goal (**Getting Started** > **Site Recovery** > **Prepare infrastructure**).</span><span class="sxs-lookup"><span data-stu-id="f7431-486">In the vault, under the vault name (**ContosoVMVault**), they set a replication goal (**Getting Started** > **Site Recovery** > **Prepare infrastructure**).</span></span>
2. <span data-ttu-id="f7431-487">They specify that the machines are located on-premises, that they're VMware VMs, replicating to Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-487">They specify that the machines are located on-premises, that they're VMware VMs, replicating to Azure.</span></span>

    ![Prepare infrastructure - Protection goal](./media/contoso-migration-rehost-vm-sql-managed-instance/replication-goal.png)

### <a name="confirm-deployment-planning"></a><span data-ttu-id="f7431-489">Confirm deployment planning</span><span class="sxs-lookup"><span data-stu-id="f7431-489">Confirm deployment planning</span></span>

<span data-ttu-id="f7431-490">To continue, Contoso admins confirm that they've completed deployment planning.</span><span class="sxs-lookup"><span data-stu-id="f7431-490">To continue, Contoso admins confirm that they've completed deployment planning.</span></span> <span data-ttu-id="f7431-491">They select **Yes, I have done it**.</span><span class="sxs-lookup"><span data-stu-id="f7431-491">They select **Yes, I have done it**.</span></span> <span data-ttu-id="f7431-492">In this deployment, Contoso is migrating only a single VM, deployment planning isn't needed.</span><span class="sxs-lookup"><span data-stu-id="f7431-492">In this deployment, Contoso is migrating only a single VM, deployment planning isn't needed.</span></span>

### <a name="set-up-the-source-environment"></a><span data-ttu-id="f7431-493">Set up the source environment</span><span class="sxs-lookup"><span data-stu-id="f7431-493">Set up the source environment</span></span>

<span data-ttu-id="f7431-494">Now, Contoso admins configure the source environment.</span><span class="sxs-lookup"><span data-stu-id="f7431-494">Now, Contoso admins configure the source environment.</span></span> <span data-ttu-id="f7431-495">To set up its source environment, they download an OVF template, and use it to deploy the configuration server and its associated components as a highly available, on-premises VMware VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-495">To set up its source environment, they download an OVF template, and use it to deploy the configuration server and its associated components as a highly available, on-premises VMware VM.</span></span> <span data-ttu-id="f7431-496">Components on the server include:</span><span class="sxs-lookup"><span data-stu-id="f7431-496">Components on the server include:</span></span>

- <span data-ttu-id="f7431-497">The configuration server that coordinates communications between the on-premises infrastructure and Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-497">The configuration server that coordinates communications between the on-premises infrastructure and Azure.</span></span> <span data-ttu-id="f7431-498">The configuration server manages data replication.</span><span class="sxs-lookup"><span data-stu-id="f7431-498">The configuration server manages data replication.</span></span>
- <span data-ttu-id="f7431-499">The process server that acts as a replication gateway.</span><span class="sxs-lookup"><span data-stu-id="f7431-499">The process server that acts as a replication gateway.</span></span> <span data-ttu-id="f7431-500">The process server:</span><span class="sxs-lookup"><span data-stu-id="f7431-500">The process server:</span></span>
    - <span data-ttu-id="f7431-501">Receives replication data.</span><span class="sxs-lookup"><span data-stu-id="f7431-501">Receives replication data.</span></span>
    - <span data-ttu-id="f7431-502">Optimizes replication date by using caching, compression, and encryption.</span><span class="sxs-lookup"><span data-stu-id="f7431-502">Optimizes replication date by using caching, compression, and encryption.</span></span>
    - <span data-ttu-id="f7431-503">Sends replication date to Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="f7431-503">Sends replication date to Azure Storage.</span></span>
- <span data-ttu-id="f7431-504">The process server also installs the Mobility Service on the VMs that will be replicated.</span><span class="sxs-lookup"><span data-stu-id="f7431-504">The process server also installs the Mobility Service on the VMs that will be replicated.</span></span> <span data-ttu-id="f7431-505">The process server performs automatic discovery of on-premises VMware VMs.</span><span class="sxs-lookup"><span data-stu-id="f7431-505">The process server performs automatic discovery of on-premises VMware VMs.</span></span>
- <span data-ttu-id="f7431-506">After the configuration server VM is created and started, Contoso registers the server in the vault.</span><span class="sxs-lookup"><span data-stu-id="f7431-506">After the configuration server VM is created and started, Contoso registers the server in the vault.</span></span>

<span data-ttu-id="f7431-507">To set up the source environment Contoso admins do the following:</span><span class="sxs-lookup"><span data-stu-id="f7431-507">To set up the source environment Contoso admins do the following:</span></span>

1. <span data-ttu-id="f7431-508">They download the OVF template from the Azure portal (**Prepare Infrastructure** > **Source** > **Configuration Server**).</span><span class="sxs-lookup"><span data-stu-id="f7431-508">They download the OVF template from the Azure portal (**Prepare Infrastructure** > **Source** > **Configuration Server**).</span></span>
    
    ![Add a configuration server](./media/contoso-migration-rehost-vm-sql-managed-instance/add-cs.png)

2. <span data-ttu-id="f7431-510">They import the template into VMware to create and deploy the VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-510">They import the template into VMware to create and deploy the VM.</span></span>

    ![Deploy OVF template](./media/contoso-migration-rehost-vm-sql-managed-instance/vcenter-wizard.png)

3.  <span data-ttu-id="f7431-512">When they turn on the VM for the first time, it starts in a Windows Server 2016 installation experience.</span><span class="sxs-lookup"><span data-stu-id="f7431-512">When they turn on the VM for the first time, it starts in a Windows Server 2016 installation experience.</span></span> <span data-ttu-id="f7431-513">They accept the license agreement and enters an administrator password.</span><span class="sxs-lookup"><span data-stu-id="f7431-513">They accept the license agreement and enters an administrator password.</span></span>
4. <span data-ttu-id="f7431-514">When the installation is finished, they sign in to the VM as the administrator.</span><span class="sxs-lookup"><span data-stu-id="f7431-514">When the installation is finished, they sign in to the VM as the administrator.</span></span> <span data-ttu-id="f7431-515">At first time sign-in, the Azure Site Recovery Configuration Tool runs automatically.</span><span class="sxs-lookup"><span data-stu-id="f7431-515">At first time sign-in, the Azure Site Recovery Configuration Tool runs automatically.</span></span>
5. <span data-ttu-id="f7431-516">In the Site Recovery Configuration Tool, they enter a name to use to register the configuration server in the vault.</span><span class="sxs-lookup"><span data-stu-id="f7431-516">In the Site Recovery Configuration Tool, they enter a name to use to register the configuration server in the vault.</span></span>
6. <span data-ttu-id="f7431-517">The tool checks the VM's connection to Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-517">The tool checks the VM's connection to Azure.</span></span> <span data-ttu-id="f7431-518">After the connection is established, they select **Sign in** to sign in to the Azure subscription.</span><span class="sxs-lookup"><span data-stu-id="f7431-518">After the connection is established, they select **Sign in** to sign in to the Azure subscription.</span></span> <span data-ttu-id="f7431-519">The credentials must have access to the vault in which the configuration server is registered.</span><span class="sxs-lookup"><span data-stu-id="f7431-519">The credentials must have access to the vault in which the configuration server is registered.</span></span> 

    ![Register the configuration server](./media/contoso-migration-rehost-vm-sql-managed-instance/config-server-register2.png)

7. <span data-ttu-id="f7431-521">The tool performs some configuration tasks, and then reboots.</span><span class="sxs-lookup"><span data-stu-id="f7431-521">The tool performs some configuration tasks, and then reboots.</span></span> <span data-ttu-id="f7431-522">They sign in to the machine again.</span><span class="sxs-lookup"><span data-stu-id="f7431-522">They sign in to the machine again.</span></span> <span data-ttu-id="f7431-523">The Configuration Server Management Wizard starts automatically.</span><span class="sxs-lookup"><span data-stu-id="f7431-523">The Configuration Server Management Wizard starts automatically.</span></span>
8. <span data-ttu-id="f7431-524">In the wizard, they select the NIC to receive replication traffic.</span><span class="sxs-lookup"><span data-stu-id="f7431-524">In the wizard, they select the NIC to receive replication traffic.</span></span> <span data-ttu-id="f7431-525">This setting can't be changed after it's configured.</span><span class="sxs-lookup"><span data-stu-id="f7431-525">This setting can't be changed after it's configured.</span></span>
9. <span data-ttu-id="f7431-526">They select the subscription, resource group, and Recovery Services vault in which to register the configuration server.</span><span class="sxs-lookup"><span data-stu-id="f7431-526">They select the subscription, resource group, and Recovery Services vault in which to register the configuration server.</span></span>

    ![Select Recovery Services vault](./media/contoso-migration-rehost-vm-sql-managed-instance/cswiz1.png)

10. <span data-ttu-id="f7431-528">They download and installs MySQL Server and VMWare PowerCLI.</span><span class="sxs-lookup"><span data-stu-id="f7431-528">They download and installs MySQL Server and VMWare PowerCLI.</span></span> <span data-ttu-id="f7431-529">Then, they validates the server settings.</span><span class="sxs-lookup"><span data-stu-id="f7431-529">Then, they validates the server settings.</span></span>
11. <span data-ttu-id="f7431-530">After validation, they enter the FQDN or IP address of the vCenter Server instance or vSphere host.</span><span class="sxs-lookup"><span data-stu-id="f7431-530">After validation, they enter the FQDN or IP address of the vCenter Server instance or vSphere host.</span></span> <span data-ttu-id="f7431-531">They leave the default port, and enter a display name for the vCenter Server instance in Azure.</span><span class="sxs-lookup"><span data-stu-id="f7431-531">They leave the default port, and enter a display name for the vCenter Server instance in Azure.</span></span>
12. <span data-ttu-id="f7431-532">They specify the account created earlier so that Site Recovery can automatically discover VMware VMs that are available for replication.</span><span class="sxs-lookup"><span data-stu-id="f7431-532">They specify the account created earlier so that Site Recovery can automatically discover VMware VMs that are available for replication.</span></span> 
13. <span data-ttu-id="f7431-533">They enter credentials, so the Mobility Service is automatically installed when replication is enabled.</span><span class="sxs-lookup"><span data-stu-id="f7431-533">They enter credentials, so the Mobility Service is automatically installed when replication is enabled.</span></span> <span data-ttu-id="f7431-534">For Windows machines, the account needs local administrator permissions on the VMs.</span><span class="sxs-lookup"><span data-stu-id="f7431-534">For Windows machines, the account needs local administrator permissions on the VMs.</span></span> 

    ![Configure vCenter Server](./media/contoso-migration-rehost-vm-sql-managed-instance/cswiz2.png)

7. <span data-ttu-id="f7431-536">When registration is finished, in the Azure portal, they verify again that the configuration server and VMware server are listed on the **Source** page in the vault.</span><span class="sxs-lookup"><span data-stu-id="f7431-536">When registration is finished, in the Azure portal, they verify again that the configuration server and VMware server are listed on the **Source** page in the vault.</span></span> <span data-ttu-id="f7431-537">Discovery can take 15 minutes or more.</span><span class="sxs-lookup"><span data-stu-id="f7431-537">Discovery can take 15 minutes or more.</span></span> 
8. <span data-ttu-id="f7431-538">Site Recovery connects to VMware servers by using the specified settings, and discovers VMs.</span><span class="sxs-lookup"><span data-stu-id="f7431-538">Site Recovery connects to VMware servers by using the specified settings, and discovers VMs.</span></span>

### <a name="set-up-the-target"></a><span data-ttu-id="f7431-539">Set up the target</span><span class="sxs-lookup"><span data-stu-id="f7431-539">Set up the target</span></span>

<span data-ttu-id="f7431-540">Now, Contoso admins configure the target replication environment:</span><span class="sxs-lookup"><span data-stu-id="f7431-540">Now, Contoso admins configure the target replication environment:</span></span>

1. <span data-ttu-id="f7431-541">In **Prepare infrastructure** > **Target**, they selecs the target settings.</span><span class="sxs-lookup"><span data-stu-id="f7431-541">In **Prepare infrastructure** > **Target**, they selecs the target settings.</span></span>
2. <span data-ttu-id="f7431-542">Site Recovery checks that there's a storage account and network in the specified target.</span><span class="sxs-lookup"><span data-stu-id="f7431-542">Site Recovery checks that there's a storage account and network in the specified target.</span></span>

### <a name="create-a-replication-policy"></a><span data-ttu-id="f7431-543">Create a replication policy</span><span class="sxs-lookup"><span data-stu-id="f7431-543">Create a replication policy</span></span>

<span data-ttu-id="f7431-544">When the source and target are set up, Contoso admins create a replication policy and associates the policy with the configuration server:</span><span class="sxs-lookup"><span data-stu-id="f7431-544">When the source and target are set up, Contoso admins create a replication policy and associates the policy with the configuration server:</span></span>

1. <span data-ttu-id="f7431-545">In  **Prepare infrastructure** > **Replication Settings** > **Replication Policy** >  **Create and Associate**, they create the **ContosoMigrationPolicy** policy.</span><span class="sxs-lookup"><span data-stu-id="f7431-545">In  **Prepare infrastructure** > **Replication Settings** > **Replication Policy** >  **Create and Associate**, they create the **ContosoMigrationPolicy** policy.</span></span>
2. <span data-ttu-id="f7431-546">They use the default settings:</span><span class="sxs-lookup"><span data-stu-id="f7431-546">They use the default settings:</span></span>
    - <span data-ttu-id="f7431-547">**RPO threshold**: Default of 60 minutes.</span><span class="sxs-lookup"><span data-stu-id="f7431-547">**RPO threshold**: Default of 60 minutes.</span></span> <span data-ttu-id="f7431-548">This value defines how often recovery points are created.</span><span class="sxs-lookup"><span data-stu-id="f7431-548">This value defines how often recovery points are created.</span></span> <span data-ttu-id="f7431-549">An alert is generated if continuous replication exceeds this limit.</span><span class="sxs-lookup"><span data-stu-id="f7431-549">An alert is generated if continuous replication exceeds this limit.</span></span>
    - <span data-ttu-id="f7431-550">**Recovery point retention**: Default of 24 hours.</span><span class="sxs-lookup"><span data-stu-id="f7431-550">**Recovery point retention**: Default of 24 hours.</span></span> <span data-ttu-id="f7431-551">This value specifies how long the retention window is for each recovery point.</span><span class="sxs-lookup"><span data-stu-id="f7431-551">This value specifies how long the retention window is for each recovery point.</span></span> <span data-ttu-id="f7431-552">Replicated VMs can be recovered to any point in a window.</span><span class="sxs-lookup"><span data-stu-id="f7431-552">Replicated VMs can be recovered to any point in a window.</span></span>
    - <span data-ttu-id="f7431-553">**App-consistent snapshot frequency**: Default of 1 hour.</span><span class="sxs-lookup"><span data-stu-id="f7431-553">**App-consistent snapshot frequency**: Default of 1 hour.</span></span> <span data-ttu-id="f7431-554">This value specifies the frequency at which application-consistent snapshots are created.</span><span class="sxs-lookup"><span data-stu-id="f7431-554">This value specifies the frequency at which application-consistent snapshots are created.</span></span>
 
    ![Replication policy - Create](./media/contoso-migration-rehost-vm-sql-managed-instance/replication-policy.png)

3. <span data-ttu-id="f7431-556">The policy is automatically associated with the configuration server.</span><span class="sxs-lookup"><span data-stu-id="f7431-556">The policy is automatically associated with the configuration server.</span></span> 

    ![Replication policy - Associate](./media/contoso-migration-rehost-vm-sql-managed-instance/replication-policy2.png)

<span data-ttu-id="f7431-558">*Need more help?*</span><span class="sxs-lookup"><span data-stu-id="f7431-558">*Need more help?*</span></span>

- <span data-ttu-id="f7431-559">You can read a full walkthrough of these steps in [Set up disaster recovery for on-premises VMware VMs](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial).</span><span class="sxs-lookup"><span data-stu-id="f7431-559">You can read a full walkthrough of these steps in [Set up disaster recovery for on-premises VMware VMs](https://docs.microsoft.com/azure/site-recovery/vmware-azure-tutorial).</span></span>
- <span data-ttu-id="f7431-560">Detailed instructions are available to help you [set up the source environment](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-source), [deploy the configuration server](https://docs.microsoft.com/azure/site-recovery/vmware-azure-deploy-configuration-server), and [configure replication settings](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-replication).</span><span class="sxs-lookup"><span data-stu-id="f7431-560">Detailed instructions are available to help you [set up the source environment](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-source), [deploy the configuration server](https://docs.microsoft.com/azure/site-recovery/vmware-azure-deploy-configuration-server), and [configure replication settings](https://docs.microsoft.com/azure/site-recovery/vmware-azure-set-up-replication).</span></span>

### <a name="enable-replication"></a><span data-ttu-id="f7431-561">Enable replication</span><span class="sxs-lookup"><span data-stu-id="f7431-561">Enable replication</span></span>

<span data-ttu-id="f7431-562">Now, Contoso admins can start replicating WebVM.</span><span class="sxs-lookup"><span data-stu-id="f7431-562">Now, Contoso admins can start replicating WebVM.</span></span>

1. <span data-ttu-id="f7431-563">In **Replicate application** > **Source** > **Replicate**, they select the source settings.</span><span class="sxs-lookup"><span data-stu-id="f7431-563">In **Replicate application** > **Source** > **Replicate**, they select the source settings.</span></span>
2. <span data-ttu-id="f7431-564">They indicate that they want to enable virtual machines, select the vCenter Server instance, and set the configuration server.</span><span class="sxs-lookup"><span data-stu-id="f7431-564">They indicate that they want to enable virtual machines, select the vCenter Server instance, and set the configuration server.</span></span>

    ![Enable replication - Source](./media/contoso-migration-rehost-vm-sql-managed-instance/enable-replication1.png)
 
3. <span data-ttu-id="f7431-566">They specify the target settings, including the resource group and network in which the Azure VM will be located after failover.</span><span class="sxs-lookup"><span data-stu-id="f7431-566">They specify the target settings, including the resource group and network in which the Azure VM will be located after failover.</span></span> <span data-ttu-id="f7431-567">They specify the storage account in which replicated data will be stored.</span><span class="sxs-lookup"><span data-stu-id="f7431-567">They specify the storage account in which replicated data will be stored.</span></span>

    ![Enable replication - Target](./media/contoso-migration-rehost-vm-sql-managed-instance/enable-replication2.png)

4. <span data-ttu-id="f7431-569">They select **WebVM** for replication.</span><span class="sxs-lookup"><span data-stu-id="f7431-569">They select **WebVM** for replication.</span></span> <span data-ttu-id="f7431-570">Site Recovery installs the Mobility Service on each VM when replication is enabled.</span><span class="sxs-lookup"><span data-stu-id="f7431-570">Site Recovery installs the Mobility Service on each VM when replication is enabled.</span></span> 

    ![Enable replication - Select the VM](./media/contoso-migration-rehost-vm-sql-managed-instance/enable-replication3.png)

5. <span data-ttu-id="f7431-572">They check that the correct replication policy is selected, and enable replication for **WEBVM**.</span><span class="sxs-lookup"><span data-stu-id="f7431-572">They check that the correct replication policy is selected, and enable replication for **WEBVM**.</span></span> <span data-ttu-id="f7431-573">They tracs replication progress in **Jobs**.</span><span class="sxs-lookup"><span data-stu-id="f7431-573">They tracs replication progress in **Jobs**.</span></span> <span data-ttu-id="f7431-574">After the **Finalize Protection** job runs, the machine is ready for failover.</span><span class="sxs-lookup"><span data-stu-id="f7431-574">After the **Finalize Protection** job runs, the machine is ready for failover.</span></span>
6. <span data-ttu-id="f7431-575">In **Essentials** in the Azure portal, they can see status for the VMs that are replicating to Azure:</span><span class="sxs-lookup"><span data-stu-id="f7431-575">In **Essentials** in the Azure portal, they can see status for the VMs that are replicating to Azure:</span></span>

    ![Infrastructure view](./media/contoso-migration-rehost-vm-sql-managed-instance/essentials.png)

<span data-ttu-id="f7431-577">*Need more help?*</span><span class="sxs-lookup"><span data-stu-id="f7431-577">*Need more help?*</span></span>

<span data-ttu-id="f7431-578">You can read a full walkthrough of these steps in [Enable replication](https://docs.microsoft.com/azure/site-recovery/vmware-azure-enable-replication).</span><span class="sxs-lookup"><span data-stu-id="f7431-578">You can read a full walkthrough of these steps in [Enable replication](https://docs.microsoft.com/azure/site-recovery/vmware-azure-enable-replication).</span></span>

## <a name="step-6-migrate-the-database"></a><span data-ttu-id="f7431-579">Step 6: Migrate the database</span><span class="sxs-lookup"><span data-stu-id="f7431-579">Step 6: Migrate the database</span></span> 

<span data-ttu-id="f7431-580">Contoso admins need to create a Database Migration Service project, and then migrate the database.</span><span class="sxs-lookup"><span data-stu-id="f7431-580">Contoso admins need to create a Database Migration Service project, and then migrate the database.</span></span>

### <a name="create-a-database-migration-service-project"></a><span data-ttu-id="f7431-581">Create a Database Migration Service project</span><span class="sxs-lookup"><span data-stu-id="f7431-581">Create a Database Migration Service project</span></span>

1. <span data-ttu-id="f7431-582">They create a Database Migration Service project.</span><span class="sxs-lookup"><span data-stu-id="f7431-582">They create a Database Migration Service project.</span></span> <span data-ttu-id="f7431-583">They select the **SQL Server** source server type, and **Azure SQL Database Managed Instance** as the target.</span><span class="sxs-lookup"><span data-stu-id="f7431-583">They select the **SQL Server** source server type, and **Azure SQL Database Managed Instance** as the target.</span></span>

     ![Database Migration Service - New migration project](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-project.png)

2. <span data-ttu-id="f7431-585">The Migration Wizard opens.</span><span class="sxs-lookup"><span data-stu-id="f7431-585">The Migration Wizard opens.</span></span>

### <a name="migrate-the-database"></a><span data-ttu-id="f7431-586">Migrate the database</span><span class="sxs-lookup"><span data-stu-id="f7431-586">Migrate the database</span></span> 

1. <span data-ttu-id="f7431-587">In the Migration Wizard, they specify the source VM on which the on-premises database is located.</span><span class="sxs-lookup"><span data-stu-id="f7431-587">In the Migration Wizard, they specify the source VM on which the on-premises database is located.</span></span> <span data-ttu-id="f7431-588">They enter the credentials to access the database.</span><span class="sxs-lookup"><span data-stu-id="f7431-588">They enter the credentials to access the database.</span></span>

    ![Database Migration Service - Source details](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-wizard-source.png)

2. <span data-ttu-id="f7431-590">they select the database to migrate (**SmartHotel.Registration**):</span><span class="sxs-lookup"><span data-stu-id="f7431-590">they select the database to migrate (**SmartHotel.Registration**):</span></span>

    ![Database Migration Service - Select source databases](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-wizard-sourcedb.png)

3. <span data-ttu-id="f7431-592">For the target, they enter the name of the Managed Instance in Azure, and the access credentials.</span><span class="sxs-lookup"><span data-stu-id="f7431-592">For the target, they enter the name of the Managed Instance in Azure, and the access credentials.</span></span>

    ![Database Migration Service - Target details](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-target-details.png)

4. <span data-ttu-id="f7431-594">In **New Activity** > **Run Migration**, they specify settings to run migration:</span><span class="sxs-lookup"><span data-stu-id="f7431-594">In **New Activity** > **Run Migration**, they specify settings to run migration:</span></span>
    - <span data-ttu-id="f7431-595">Source and target credentials.</span><span class="sxs-lookup"><span data-stu-id="f7431-595">Source and target credentials.</span></span>
    - <span data-ttu-id="f7431-596">The database to migrate.</span><span class="sxs-lookup"><span data-stu-id="f7431-596">The database to migrate.</span></span>
    - <span data-ttu-id="f7431-597">The network share created on the on-premises VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-597">The network share created on the on-premises VM.</span></span> <span data-ttu-id="f7431-598">The Database Migration Service takes source backups to this share.</span><span class="sxs-lookup"><span data-stu-id="f7431-598">The Database Migration Service takes source backups to this share.</span></span> 
        - <span data-ttu-id="f7431-599">The service account that runs the source SQL Server instance must have write permissions on this share.</span><span class="sxs-lookup"><span data-stu-id="f7431-599">The service account that runs the source SQL Server instance must have write permissions on this share.</span></span>
        - <span data-ttu-id="f7431-600">The FQDN path to the share must be used.</span><span class="sxs-lookup"><span data-stu-id="f7431-600">The FQDN path to the share must be used.</span></span>
    - <span data-ttu-id="f7431-601">The SAS URI that provides the Database Migration Service with access to the storage account container to which the service uploads the backup files for migration.</span><span class="sxs-lookup"><span data-stu-id="f7431-601">The SAS URI that provides the Database Migration Service with access to the storage account container to which the service uploads the backup files for migration.</span></span>

        ![Database Migration Service - Configure migration settings](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-migration-settings.png)

5. <span data-ttu-id="f7431-603">They save the migration settings, and then run the migration.</span><span class="sxs-lookup"><span data-stu-id="f7431-603">They save the migration settings, and then run the migration.</span></span>
6. <span data-ttu-id="f7431-604">In **Overview**, they monitos the migration status.</span><span class="sxs-lookup"><span data-stu-id="f7431-604">In **Overview**, they monitos the migration status.</span></span>

    ![Database Migration Service - Monitor](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-monitor1.png)

7. <span data-ttu-id="f7431-606">When migration is finished, they verify that the target databases exist on the Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-606">When migration is finished, they verify that the target databases exist on the Managed Instance.</span></span>

    ![Database Migration Service - Verify the database migration](./media/contoso-migration-rehost-vm-sql-managed-instance/dms-monitor2.png)

## <a name="step-7-migrate-the-vm"></a><span data-ttu-id="f7431-608">Step 7: Migrate the VM</span><span class="sxs-lookup"><span data-stu-id="f7431-608">Step 7: Migrate the VM</span></span>

<span data-ttu-id="f7431-609">Contoso admins run a quick test failover, and then migrate the VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-609">Contoso admins run a quick test failover, and then migrate the VM.</span></span>

### <a name="run-a-test-failover"></a><span data-ttu-id="f7431-610">Run a test failover</span><span class="sxs-lookup"><span data-stu-id="f7431-610">Run a test failover</span></span>

<span data-ttu-id="f7431-611">Before migrating WEBVM, a test failover helps ensure that everything works as expected.</span><span class="sxs-lookup"><span data-stu-id="f7431-611">Before migrating WEBVM, a test failover helps ensure that everything works as expected.</span></span> <span data-ttu-id="f7431-612">Admins complete the following steps:</span><span class="sxs-lookup"><span data-stu-id="f7431-612">Admins complete the following steps:</span></span>

1. <span data-ttu-id="f7431-613">They run a test failover to the latest available point in time (**Latest processed**).</span><span class="sxs-lookup"><span data-stu-id="f7431-613">They run a test failover to the latest available point in time (**Latest processed**).</span></span>
2. <span data-ttu-id="f7431-614">They select **Shut down machine before beginning failover**.</span><span class="sxs-lookup"><span data-stu-id="f7431-614">They select **Shut down machine before beginning failover**.</span></span> <span data-ttu-id="f7431-615">With this option selected, Site Recovery attempts to shut down the source VM before it triggers the failover.</span><span class="sxs-lookup"><span data-stu-id="f7431-615">With this option selected, Site Recovery attempts to shut down the source VM before it triggers the failover.</span></span> <span data-ttu-id="f7431-616">Failover continues, even if shutdown fails.</span><span class="sxs-lookup"><span data-stu-id="f7431-616">Failover continues, even if shutdown fails.</span></span> 
3. <span data-ttu-id="f7431-617">Test failover runs:</span><span class="sxs-lookup"><span data-stu-id="f7431-617">Test failover runs:</span></span> 
    1. <span data-ttu-id="f7431-618">A prerequisites check runs to make sure that all the conditions required for migration are in place.</span><span class="sxs-lookup"><span data-stu-id="f7431-618">A prerequisites check runs to make sure that all the conditions required for migration are in place.</span></span>
    2. <span data-ttu-id="f7431-619">Failover processes the data so that an Azure VM can be created.</span><span class="sxs-lookup"><span data-stu-id="f7431-619">Failover processes the data so that an Azure VM can be created.</span></span> <span data-ttu-id="f7431-620">If the latest recovery point is selected, a recovery point is created from the data.</span><span class="sxs-lookup"><span data-stu-id="f7431-620">If the latest recovery point is selected, a recovery point is created from the data.</span></span>
    3.  <span data-ttu-id="f7431-621">Azure VM is created by using the data processed in the preceding step.</span><span class="sxs-lookup"><span data-stu-id="f7431-621">Azure VM is created by using the data processed in the preceding step.</span></span>
3. <span data-ttu-id="f7431-622">When the failover is finished, the replica Azure VM appears in the Azure portal.</span><span class="sxs-lookup"><span data-stu-id="f7431-622">When the failover is finished, the replica Azure VM appears in the Azure portal.</span></span> <span data-ttu-id="f7431-623">they verify that everything is working properly: the VM is the appropriate size, it's connected to the correct network, and it's running.</span><span class="sxs-lookup"><span data-stu-id="f7431-623">they verify that everything is working properly: the VM is the appropriate size, it's connected to the correct network, and it's running.</span></span> 
4. <span data-ttu-id="f7431-624">After verifying the test failover, they clean up the failover, and record any observations.</span><span class="sxs-lookup"><span data-stu-id="f7431-624">After verifying the test failover, they clean up the failover, and record any observations.</span></span> 

### <a name="migrate-the-vm"></a><span data-ttu-id="f7431-625">Migrate the VM</span><span class="sxs-lookup"><span data-stu-id="f7431-625">Migrate the VM</span></span>

1. <span data-ttu-id="f7431-626">After verifying that the test failover worked as expected, Contoso admins create a recovery plan for migration, and add WEBVM to the plan:</span><span class="sxs-lookup"><span data-stu-id="f7431-626">After verifying that the test failover worked as expected, Contoso admins create a recovery plan for migration, and add WEBVM to the plan:</span></span>

     ![Create recovery plan - Select items](./media/contoso-migration-rehost-vm-sql-managed-instance/recovery-plan.png)

2. <span data-ttu-id="f7431-628">They run a failover on the plan, selecting the latest recovery point.</span><span class="sxs-lookup"><span data-stu-id="f7431-628">They run a failover on the plan, selecting the latest recovery point.</span></span> <span data-ttu-id="f7431-629">They specify that Site Recovery should try to shut down the on-premises VM before it triggers the failover.</span><span class="sxs-lookup"><span data-stu-id="f7431-629">They specify that Site Recovery should try to shut down the on-premises VM before it triggers the failover.</span></span>

    ![Failover](./media/contoso-migration-rehost-vm-sql-managed-instance/failover1.png)

3. <span data-ttu-id="f7431-631">After the failover, they verify that the Azure VM appears as expected in the Azure portal.</span><span class="sxs-lookup"><span data-stu-id="f7431-631">After the failover, they verify that the Azure VM appears as expected in the Azure portal.</span></span>

   ![Recovery plan details](./media/contoso-migration-rehost-vm-sql-managed-instance/failover2.png)

4. <span data-ttu-id="f7431-633">After verifying, they complete the migration to finish the migration process, stop replication for the VM, and stop Site Recovery billing for the VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-633">After verifying, they complete the migration to finish the migration process, stop replication for the VM, and stop Site Recovery billing for the VM.</span></span>

    ![Failover - Complete migration](./media/contoso-migration-rehost-vm-sql-managed-instance/failover3.png)

### <a name="update-the-connection-string"></a><span data-ttu-id="f7431-635">Update the connection string</span><span class="sxs-lookup"><span data-stu-id="f7431-635">Update the connection string</span></span>

<span data-ttu-id="f7431-636">As the final step in the migration process, Contoso admins update the connection string of the application to point to the migrated database that's running on Contoso's Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-636">As the final step in the migration process, Contoso admins update the connection string of the application to point to the migrated database that's running on Contoso's Managed Instance.</span></span>

1. <span data-ttu-id="f7431-637">In the Azure portal, they find the connection string by selecting **Settings** > **Connection Strings**.</span><span class="sxs-lookup"><span data-stu-id="f7431-637">In the Azure portal, they find the connection string by selecting **Settings** > **Connection Strings**.</span></span>

    ![Connection strings](./media/contoso-migration-rehost-vm-sql-managed-instance/failover4.png)  

2. <span data-ttu-id="f7431-639">They update the string with the user name and password of the SQL Database Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-639">They update the string with the user name and password of the SQL Database Managed Instance.</span></span>
3. <span data-ttu-id="f7431-640">After the string is configured, they replace the current connection string in the web.config file of its application.</span><span class="sxs-lookup"><span data-stu-id="f7431-640">After the string is configured, they replace the current connection string in the web.config file of its application.</span></span>
4. <span data-ttu-id="f7431-641">After updating the file and saving it, they restart IIS on WEBVM by running `IISRESET /RESTART` in a Command Prompt window.</span><span class="sxs-lookup"><span data-stu-id="f7431-641">After updating the file and saving it, they restart IIS on WEBVM by running `IISRESET /RESTART` in a Command Prompt window.</span></span>
5. <span data-ttu-id="f7431-642">After IIS is restarted, the app uses the database that's running on the SQL Database Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-642">After IIS is restarted, the app uses the database that's running on the SQL Database Managed Instance.</span></span>
6. <span data-ttu-id="f7431-643">At this point, they can shut down on-premises the SQLVM machine.</span><span class="sxs-lookup"><span data-stu-id="f7431-643">At this point, they can shut down on-premises the SQLVM machine.</span></span> <span data-ttu-id="f7431-644">The migration has been completed.</span><span class="sxs-lookup"><span data-stu-id="f7431-644">The migration has been completed.</span></span>

<span data-ttu-id="f7431-645">*Need more help?*</span><span class="sxs-lookup"><span data-stu-id="f7431-645">*Need more help?*</span></span>

- <span data-ttu-id="f7431-646">Learn how to [run a test failover](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure).</span><span class="sxs-lookup"><span data-stu-id="f7431-646">Learn how to [run a test failover](https://docs.microsoft.com/azure/site-recovery/tutorial-dr-drill-azure).</span></span> 
- <span data-ttu-id="f7431-647">Learn how to [create a recovery plan](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans).</span><span class="sxs-lookup"><span data-stu-id="f7431-647">Learn how to [create a recovery plan](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans).</span></span>
- <span data-ttu-id="f7431-648">Learn how to [fail over to Azure](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover).</span><span class="sxs-lookup"><span data-stu-id="f7431-648">Learn how to [fail over to Azure](https://docs.microsoft.com/azure/site-recovery/site-recovery-failover).</span></span>

## <a name="clean-up-after-migration"></a><span data-ttu-id="f7431-649">Clean up after migration</span><span class="sxs-lookup"><span data-stu-id="f7431-649">Clean up after migration</span></span>

<span data-ttu-id="f7431-650">With the migration complete, the SmartHotel360 app is running on an Azure VM and the SmartHotel360 database is available in the Azure SQL Database Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-650">With the migration complete, the SmartHotel360 app is running on an Azure VM and the SmartHotel360 database is available in the Azure SQL Database Managed Instance.</span></span>  

<span data-ttu-id="f7431-651">Now, Contoso needs to do the following cleanup tasks:</span><span class="sxs-lookup"><span data-stu-id="f7431-651">Now, Contoso needs to do the following cleanup tasks:</span></span>  

- <span data-ttu-id="f7431-652">Remove the WEBVM machine from the vCenter Server inventory.</span><span class="sxs-lookup"><span data-stu-id="f7431-652">Remove the WEBVM machine from the vCenter Server inventory.</span></span>
- <span data-ttu-id="f7431-653">Remove the SQLVM machine from the vCenter Server inventory.</span><span class="sxs-lookup"><span data-stu-id="f7431-653">Remove the SQLVM machine from the vCenter Server inventory.</span></span>
- <span data-ttu-id="f7431-654">Remove WEBVM and SQLVM from local backup jobs.</span><span class="sxs-lookup"><span data-stu-id="f7431-654">Remove WEBVM and SQLVM from local backup jobs.</span></span>
- <span data-ttu-id="f7431-655">Update internal documentation to show the new location and IP address for WEBVM.</span><span class="sxs-lookup"><span data-stu-id="f7431-655">Update internal documentation to show the new location and IP address for WEBVM.</span></span>
- <span data-ttu-id="f7431-656">Remove SQLVM from internal documentation.</span><span class="sxs-lookup"><span data-stu-id="f7431-656">Remove SQLVM from internal documentation.</span></span> <span data-ttu-id="f7431-657">Alternatively, Contoso can revise the documentation to show SQLVM as deleted and no longer in the VM inventory.</span><span class="sxs-lookup"><span data-stu-id="f7431-657">Alternatively, Contoso can revise the documentation to show SQLVM as deleted and no longer in the VM inventory.</span></span>
- <span data-ttu-id="f7431-658">Review any resources that interact with the decommissioned VMs.</span><span class="sxs-lookup"><span data-stu-id="f7431-658">Review any resources that interact with the decommissioned VMs.</span></span> <span data-ttu-id="f7431-659">Update any relevant settings or documentation to reflect the new configuration.</span><span class="sxs-lookup"><span data-stu-id="f7431-659">Update any relevant settings or documentation to reflect the new configuration.</span></span>

## <a name="review-the-deployment"></a><span data-ttu-id="f7431-660">Review the deployment</span><span class="sxs-lookup"><span data-stu-id="f7431-660">Review the deployment</span></span>

<span data-ttu-id="f7431-661">With the migrated resources in Azure, Contoso needs to fully operationalize and secure its new infrastructure.</span><span class="sxs-lookup"><span data-stu-id="f7431-661">With the migrated resources in Azure, Contoso needs to fully operationalize and secure its new infrastructure.</span></span>

### <a name="security"></a><span data-ttu-id="f7431-662">Security</span><span class="sxs-lookup"><span data-stu-id="f7431-662">Security</span></span>

<span data-ttu-id="f7431-663">The Contoso security team reviews the Azure VMs and SQL Database Managed Instance to check for any security issues with its implementation:</span><span class="sxs-lookup"><span data-stu-id="f7431-663">The Contoso security team reviews the Azure VMs and SQL Database Managed Instance to check for any security issues with its implementation:</span></span>

- <span data-ttu-id="f7431-664">The team reviews the network security groups that are used to control access for the VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-664">The team reviews the network security groups that are used to control access for the VM.</span></span> <span data-ttu-id="f7431-665">Network security groups help ensure that only traffic that is allowed to the app can pass.</span><span class="sxs-lookup"><span data-stu-id="f7431-665">Network security groups help ensure that only traffic that is allowed to the app can pass.</span></span>
- <span data-ttu-id="f7431-666">Contoso's security team also is considering securing the data on the disk by using Azure Disk Encryption and Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="f7431-666">Contoso's security team also is considering securing the data on the disk by using Azure Disk Encryption and Azure Key Vault.</span></span>
- <span data-ttu-id="f7431-667">The team enables threat detection on the Managed Instance.</span><span class="sxs-lookup"><span data-stu-id="f7431-667">The team enables threat detection on the Managed Instance.</span></span> <span data-ttu-id="f7431-668">Threat detection sends an alert to Contoso's security team/service desk system to open a ticket if a threat is detected.</span><span class="sxs-lookup"><span data-stu-id="f7431-668">Threat detection sends an alert to Contoso's security team/service desk system to open a ticket if a threat is detected.</span></span> <span data-ttu-id="f7431-669">Learn more about [threat detection for Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-threat-detection).</span><span class="sxs-lookup"><span data-stu-id="f7431-669">Learn more about [threat detection for Managed Instance](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-threat-detection).</span></span>

     ![Managed Instance security - Threat detection](./media/contoso-migration-rehost-vm-sql-managed-instance/mi-security.png)  

<span data-ttu-id="f7431-671">To learn more about security practices for VMs, see [Security best practices for IaaS workloads in Azure](https://docs.microsoft.com/azure/security/azure-security-best-practices-vms#vm-authentication-and-access-control).</span><span class="sxs-lookup"><span data-stu-id="f7431-671">To learn more about security practices for VMs, see [Security best practices for IaaS workloads in Azure](https://docs.microsoft.com/azure/security/azure-security-best-practices-vms#vm-authentication-and-access-control).</span></span>

### <a name="bcdr"></a><span data-ttu-id="f7431-672">BCDR</span><span class="sxs-lookup"><span data-stu-id="f7431-672">BCDR</span></span>

<span data-ttu-id="f7431-673">For business continuity and disaster recovery (BCDR), Contoso takes the following actions:</span><span class="sxs-lookup"><span data-stu-id="f7431-673">For business continuity and disaster recovery (BCDR), Contoso takes the following actions:</span></span>

- <span data-ttu-id="f7431-674">Keep data safe: Contoso backs up the data on the VMs using the Azure Backup service.</span><span class="sxs-lookup"><span data-stu-id="f7431-674">Keep data safe: Contoso backs up the data on the VMs using the Azure Backup service.</span></span> <span data-ttu-id="f7431-675">[Learn more]https://docs.microsoft.com/azure/backup/backup-introduction-to-azure-backup?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="f7431-675">[Learn more]https://docs.microsoft.com/azure/backup/backup-introduction-to-azure-backup?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span></span>
- <span data-ttu-id="f7431-676">Keep apps up and running: Contoso replicates the app VMs in Azure to a secondary region using Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="f7431-676">Keep apps up and running: Contoso replicates the app VMs in Azure to a secondary region using Site Recovery.</span></span> <span data-ttu-id="f7431-677">[Learn more](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-quickstart).</span><span class="sxs-lookup"><span data-stu-id="f7431-677">[Learn more](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-quickstart).</span></span>
- <span data-ttu-id="f7431-678">Contoso learns more about managing SQL Managed Instance, including [database backups](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups).</span><span class="sxs-lookup"><span data-stu-id="f7431-678">Contoso learns more about managing SQL Managed Instance, including [database backups](https://docs.microsoft.com/azure/sql-database/sql-database-automated-backups).</span></span>


### <a name="licensing-and-cost-optimization"></a><span data-ttu-id="f7431-679">Licensing and cost optimization</span><span class="sxs-lookup"><span data-stu-id="f7431-679">Licensing and cost optimization</span></span>

- <span data-ttu-id="f7431-680">Contoso has an existing licensing for WEBVM.</span><span class="sxs-lookup"><span data-stu-id="f7431-680">Contoso has an existing licensing for WEBVM.</span></span> <span data-ttu-id="f7431-681">To take advantage of pricing with Azure Hybrid Benefit, Contoso converts the existing Azure VM.</span><span class="sxs-lookup"><span data-stu-id="f7431-681">To take advantage of pricing with Azure Hybrid Benefit, Contoso converts the existing Azure VM.</span></span>
- <span data-ttu-id="f7431-682">Contoso enables Azure Cost Management licensed by Cloudyn, a Microsoft subsidiary.</span><span class="sxs-lookup"><span data-stu-id="f7431-682">Contoso enables Azure Cost Management licensed by Cloudyn, a Microsoft subsidiary.</span></span> <span data-ttu-id="f7431-683">Cost Management is a multi-cloud cost management solution that helps Contoso use and manage Azure and other cloud resources.</span><span class="sxs-lookup"><span data-stu-id="f7431-683">Cost Management is a multi-cloud cost management solution that helps Contoso use and manage Azure and other cloud resources.</span></span> <span data-ttu-id="f7431-684">Learn more about [Azure Cost Management](https://docs.microsoft.com/azure/cost-management/overview).</span><span class="sxs-lookup"><span data-stu-id="f7431-684">Learn more about [Azure Cost Management](https://docs.microsoft.com/azure/cost-management/overview).</span></span> 


## <a name="conclusion"></a><span data-ttu-id="f7431-685">Conclusion</span><span class="sxs-lookup"><span data-stu-id="f7431-685">Conclusion</span></span>

<span data-ttu-id="f7431-686">In this article, Contoso rehosts the SmartHotel360 app in Azure by migrating the app front-end VM to Azure by using the Site Recovery service.</span><span class="sxs-lookup"><span data-stu-id="f7431-686">In this article, Contoso rehosts the SmartHotel360 app in Azure by migrating the app front-end VM to Azure by using the Site Recovery service.</span></span> <span data-ttu-id="f7431-687">Contoso migrates the on-premises database to an Azure SQL Database Managed Instance by using the Azure Database Migration Service.</span><span class="sxs-lookup"><span data-stu-id="f7431-687">Contoso migrates the on-premises database to an Azure SQL Database Managed Instance by using the Azure Database Migration Service.</span></span>

## <a name="next-steps"></a><span data-ttu-id="f7431-688">Next steps</span><span class="sxs-lookup"><span data-stu-id="f7431-688">Next steps</span></span>

<span data-ttu-id="f7431-689">In the next article in the series, Contoso [rehosts the SmartHotel360 app on Azure VMs](contoso-migration-rehost-vm.md) by using the Azure Site Recovery service.</span><span class="sxs-lookup"><span data-stu-id="f7431-689">In the next article in the series, Contoso [rehosts the SmartHotel360 app on Azure VMs](contoso-migration-rehost-vm.md) by using the Azure Site Recovery service.</span></span>

