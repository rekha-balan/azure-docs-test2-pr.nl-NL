---
title: Troubleshoot Kerberos constrained delegation configurations for Application Proxy | Microsoft Docs
description: Troubleshoot Kerberos Constrained Delegation configurations for Application Proxy
services: active-directory
documentationcenter: ''
author: barbkess
manager: mtillman
ms.assetid: ''
ms.service: active-directory
ms.component: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 05/24/2018
ms.author: barbkess
ms.reviewer: asteen
ms.openlocfilehash: 52157797bb01fc73c551ca9654b2360d161b653d
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44865449"
---
# <a name="troubleshoot-kerberos-constrained-delegation-configurations-for-application-proxy"></a><span data-ttu-id="9f92a-103">Troubleshoot Kerberos constrained delegation configurations for Application Proxy</span><span class="sxs-lookup"><span data-stu-id="9f92a-103">Troubleshoot Kerberos constrained delegation configurations for Application Proxy</span></span>

<span data-ttu-id="9f92a-104">The methods available for achieving SSO to published applications can vary from one application to another.</span><span class="sxs-lookup"><span data-stu-id="9f92a-104">The methods available for achieving SSO to published applications can vary from one application to another.</span></span> <span data-ttu-id="9f92a-105">One option that Azure Active Directory (Azure AD) Application Proxy offers by default is Kerberos constrained delegation (KCD).</span><span class="sxs-lookup"><span data-stu-id="9f92a-105">One option that Azure Active Directory (Azure AD) Application Proxy offers by default is Kerberos constrained delegation (KCD).</span></span> <span data-ttu-id="9f92a-106">You can configure a connector, for your users, to run constrained Kerberos authentication to back-end applications.</span><span class="sxs-lookup"><span data-stu-id="9f92a-106">You can configure a connector, for your users, to run constrained Kerberos authentication to back-end applications.</span></span>

<span data-ttu-id="9f92a-107">The procedure for enabling KCD is straightforward.</span><span class="sxs-lookup"><span data-stu-id="9f92a-107">The procedure for enabling KCD is straightforward.</span></span> <span data-ttu-id="9f92a-108">It requires no more than a general understanding of the various components and authentication flow that support SSO.</span><span class="sxs-lookup"><span data-stu-id="9f92a-108">It requires no more than a general understanding of the various components and authentication flow that support SSO.</span></span> <span data-ttu-id="9f92a-109">But sometimes, KCD SSO doesn’t function as expected.</span><span class="sxs-lookup"><span data-stu-id="9f92a-109">But sometimes, KCD SSO doesn’t function as expected.</span></span> <span data-ttu-id="9f92a-110">You need good sources of information to troubleshoot these scenarios.</span><span class="sxs-lookup"><span data-stu-id="9f92a-110">You need good sources of information to troubleshoot these scenarios.</span></span>

<span data-ttu-id="9f92a-111">This article provides a single point of reference that helps troubleshoot and self-remediate some of the most common issues.</span><span class="sxs-lookup"><span data-stu-id="9f92a-111">This article provides a single point of reference that helps troubleshoot and self-remediate some of the most common issues.</span></span> <span data-ttu-id="9f92a-112">It also covers diagnosis of more complex implementation problems.</span><span class="sxs-lookup"><span data-stu-id="9f92a-112">It also covers diagnosis of more complex implementation problems.</span></span>

<span data-ttu-id="9f92a-113">This article makes the following assumptions:</span><span class="sxs-lookup"><span data-stu-id="9f92a-113">This article makes the following assumptions:</span></span>

-   <span data-ttu-id="9f92a-114">Deployment of Azure AD Application Proxy per [Get started with Application Proxy](application-proxy-enable.md) and general access to non-KCD applications work as expected.</span><span class="sxs-lookup"><span data-stu-id="9f92a-114">Deployment of Azure AD Application Proxy per [Get started with Application Proxy](application-proxy-enable.md) and general access to non-KCD applications work as expected.</span></span>

-   <span data-ttu-id="9f92a-115">The published target application is based on Internet Information Services (IIS) and the Microsoft implementation of Kerberos.</span><span class="sxs-lookup"><span data-stu-id="9f92a-115">The published target application is based on Internet Information Services (IIS) and the Microsoft implementation of Kerberos.</span></span>

-   <span data-ttu-id="9f92a-116">The server and application hosts reside in a single Azure Active Directory domain.</span><span class="sxs-lookup"><span data-stu-id="9f92a-116">The server and application hosts reside in a single Azure Active Directory domain.</span></span> <span data-ttu-id="9f92a-117">For detailed information on cross-domain and forest scenarios, see the [KCD white paper](https://aka.ms/KCDPaper).</span><span class="sxs-lookup"><span data-stu-id="9f92a-117">For detailed information on cross-domain and forest scenarios, see the [KCD white paper](https://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="9f92a-118">The subject application is published in an Azure tenant with pre-authentication enabled.</span><span class="sxs-lookup"><span data-stu-id="9f92a-118">The subject application is published in an Azure tenant with pre-authentication enabled.</span></span> <span data-ttu-id="9f92a-119">Users are expected to authenticate to Azure via forms-based authentication.</span><span class="sxs-lookup"><span data-stu-id="9f92a-119">Users are expected to authenticate to Azure via forms-based authentication.</span></span> <span data-ttu-id="9f92a-120">Rich client authentication scenarios aren't covered by this article.</span><span class="sxs-lookup"><span data-stu-id="9f92a-120">Rich client authentication scenarios aren't covered by this article.</span></span> <span data-ttu-id="9f92a-121">They might be added at some point in the future.</span><span class="sxs-lookup"><span data-stu-id="9f92a-121">They might be added at some point in the future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="9f92a-122">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="9f92a-122">Prerequisites</span></span>

<span data-ttu-id="9f92a-123">Azure AD Application Proxy can be deployed into many types of infrastructures or environments.</span><span class="sxs-lookup"><span data-stu-id="9f92a-123">Azure AD Application Proxy can be deployed into many types of infrastructures or environments.</span></span> <span data-ttu-id="9f92a-124">The architectures vary from organization to organization.</span><span class="sxs-lookup"><span data-stu-id="9f92a-124">The architectures vary from organization to organization.</span></span> <span data-ttu-id="9f92a-125">The most common causes of KCD-related issues aren't the environments.</span><span class="sxs-lookup"><span data-stu-id="9f92a-125">The most common causes of KCD-related issues aren't the environments.</span></span> <span data-ttu-id="9f92a-126">Simple misconfigurations or general mistakes cause most issues.</span><span class="sxs-lookup"><span data-stu-id="9f92a-126">Simple misconfigurations or general mistakes cause most issues.</span></span>

<span data-ttu-id="9f92a-127">For this reason, it's best to make sure you've met all the prerequisites in [Using KCD SSO with the Application Proxy](application-proxy-configure-single-sign-on-with-kcd.md) before you start troubleshooting.</span><span class="sxs-lookup"><span data-stu-id="9f92a-127">For this reason, it's best to make sure you've met all the prerequisites in [Using KCD SSO with the Application Proxy](application-proxy-configure-single-sign-on-with-kcd.md) before you start troubleshooting.</span></span> <span data-ttu-id="9f92a-128">Note the section on configuring Kerberos constrained delegation on 2012R2.</span><span class="sxs-lookup"><span data-stu-id="9f92a-128">Note the section on configuring Kerberos constrained delegation on 2012R2.</span></span> <span data-ttu-id="9f92a-129">This process employs a different approach to configuring KCD on previous versions of Windows.</span><span class="sxs-lookup"><span data-stu-id="9f92a-129">This process employs a different approach to configuring KCD on previous versions of Windows.</span></span> <span data-ttu-id="9f92a-130">Also, be mindful of these considerations:</span><span class="sxs-lookup"><span data-stu-id="9f92a-130">Also, be mindful of these considerations:</span></span>

-   <span data-ttu-id="9f92a-131">It's not uncommon for a domain member server to open a secure channel dialog with a specific domain controller (DC).</span><span class="sxs-lookup"><span data-stu-id="9f92a-131">It's not uncommon for a domain member server to open a secure channel dialog with a specific domain controller (DC).</span></span> <span data-ttu-id="9f92a-132">Then the server might move to another dialog at any given time.</span><span class="sxs-lookup"><span data-stu-id="9f92a-132">Then the server might move to another dialog at any given time.</span></span> <span data-ttu-id="9f92a-133">So connector hosts aren't restricted to communication with only specific local site DCs.</span><span class="sxs-lookup"><span data-stu-id="9f92a-133">So connector hosts aren't restricted to communication with only specific local site DCs.</span></span>

-   <span data-ttu-id="9f92a-134">Cross-domain scenarios rely on referrals that direct a connector host to DCs that might be outside of the local network perimeter.</span><span class="sxs-lookup"><span data-stu-id="9f92a-134">Cross-domain scenarios rely on referrals that direct a connector host to DCs that might be outside of the local network perimeter.</span></span> <span data-ttu-id="9f92a-135">In these cases, it's equally important to also send traffic onward to DCs that represent other respective domains.</span><span class="sxs-lookup"><span data-stu-id="9f92a-135">In these cases, it's equally important to also send traffic onward to DCs that represent other respective domains.</span></span> <span data-ttu-id="9f92a-136">If not, delegation fails.</span><span class="sxs-lookup"><span data-stu-id="9f92a-136">If not, delegation fails.</span></span>

-   <span data-ttu-id="9f92a-137">Where possible, avoid placing any active IPS or IDS devices between connector hosts and DCs.</span><span class="sxs-lookup"><span data-stu-id="9f92a-137">Where possible, avoid placing any active IPS or IDS devices between connector hosts and DCs.</span></span> <span data-ttu-id="9f92a-138">These devices are sometimes overintrusive and interfere with core RPC traffic.</span><span class="sxs-lookup"><span data-stu-id="9f92a-138">These devices are sometimes overintrusive and interfere with core RPC traffic.</span></span>

<span data-ttu-id="9f92a-139">Test delegation in simple scenarios.</span><span class="sxs-lookup"><span data-stu-id="9f92a-139">Test delegation in simple scenarios.</span></span> <span data-ttu-id="9f92a-140">The more variables you introduce, the more you might have to contend with.</span><span class="sxs-lookup"><span data-stu-id="9f92a-140">The more variables you introduce, the more you might have to contend with.</span></span> <span data-ttu-id="9f92a-141">To save time, limit your testing to a single connector.</span><span class="sxs-lookup"><span data-stu-id="9f92a-141">To save time, limit your testing to a single connector.</span></span> <span data-ttu-id="9f92a-142">Add additional connectors after the issue has been resolved.</span><span class="sxs-lookup"><span data-stu-id="9f92a-142">Add additional connectors after the issue has been resolved.</span></span>

<span data-ttu-id="9f92a-143">Some environmental factors might also contribute to an issue.</span><span class="sxs-lookup"><span data-stu-id="9f92a-143">Some environmental factors might also contribute to an issue.</span></span> <span data-ttu-id="9f92a-144">To avoid these factors, minimize architecture as much as possible during testing.</span><span class="sxs-lookup"><span data-stu-id="9f92a-144">To avoid these factors, minimize architecture as much as possible during testing.</span></span> <span data-ttu-id="9f92a-145">For example, misconfigured internal firewall ACLs are common.</span><span class="sxs-lookup"><span data-stu-id="9f92a-145">For example, misconfigured internal firewall ACLs are common.</span></span> <span data-ttu-id="9f92a-146">If possible, send all traffic from a connector straight through to the DCs and back-end application.</span><span class="sxs-lookup"><span data-stu-id="9f92a-146">If possible, send all traffic from a connector straight through to the DCs and back-end application.</span></span>

<span data-ttu-id="9f92a-147">The best place to position connectors is as close as possible to their targets.</span><span class="sxs-lookup"><span data-stu-id="9f92a-147">The best place to position connectors is as close as possible to their targets.</span></span> <span data-ttu-id="9f92a-148">A firewall that sits inline when testing adds unnecessary complexity and can prolong your investigations.</span><span class="sxs-lookup"><span data-stu-id="9f92a-148">A firewall that sits inline when testing adds unnecessary complexity and can prolong your investigations.</span></span>

<span data-ttu-id="9f92a-149">What shows a KCD problem?</span><span class="sxs-lookup"><span data-stu-id="9f92a-149">What shows a KCD problem?</span></span> <span data-ttu-id="9f92a-150">There are several common indications that KCD SSO is failing.</span><span class="sxs-lookup"><span data-stu-id="9f92a-150">There are several common indications that KCD SSO is failing.</span></span> <span data-ttu-id="9f92a-151">The first signs of an issue appear in the browser.</span><span class="sxs-lookup"><span data-stu-id="9f92a-151">The first signs of an issue appear in the browser.</span></span>

   ![Incorrect KCD configuration error](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Authorization failed because of missing permissions](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="9f92a-154">Both of these images show the same symptom: SSO failure.</span><span class="sxs-lookup"><span data-stu-id="9f92a-154">Both of these images show the same symptom: SSO failure.</span></span> <span data-ttu-id="9f92a-155">User access to the application is denied.</span><span class="sxs-lookup"><span data-stu-id="9f92a-155">User access to the application is denied.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="9f92a-156">Troubleshooting</span><span class="sxs-lookup"><span data-stu-id="9f92a-156">Troubleshooting</span></span>

<span data-ttu-id="9f92a-157">How you troubleshoot depends on the issue and the symptoms you observe.</span><span class="sxs-lookup"><span data-stu-id="9f92a-157">How you troubleshoot depends on the issue and the symptoms you observe.</span></span> <span data-ttu-id="9f92a-158">Before you go any farther, explore the following articles.</span><span class="sxs-lookup"><span data-stu-id="9f92a-158">Before you go any farther, explore the following articles.</span></span> <span data-ttu-id="9f92a-159">They provide useful troubleshooting information:</span><span class="sxs-lookup"><span data-stu-id="9f92a-159">They provide useful troubleshooting information:</span></span>

-   [<span data-ttu-id="9f92a-160">Troubleshoot Application Proxy problems and error messages</span><span class="sxs-lookup"><span data-stu-id="9f92a-160">Troubleshoot Application Proxy problems and error messages</span></span>](application-proxy-troubleshoot.md)

-   [<span data-ttu-id="9f92a-161">Kerberos errors and symptoms</span><span class="sxs-lookup"><span data-stu-id="9f92a-161">Kerberos errors and symptoms</span></span>](application-proxy-troubleshoot.md#kerberos-errors)

-   [<span data-ttu-id="9f92a-162">Working with SSO when on-premises and cloud identities aren't identical</span><span class="sxs-lookup"><span data-stu-id="9f92a-162">Working with SSO when on-premises and cloud identities aren't identical</span></span>](application-proxy-configure-single-sign-on-with-kcd.md#working-with-different-on-premises-and-cloud-identities)

<span data-ttu-id="9f92a-163">If you got to this point, then your main issue exists.</span><span class="sxs-lookup"><span data-stu-id="9f92a-163">If you got to this point, then your main issue exists.</span></span> <span data-ttu-id="9f92a-164">To start, separate the flow into the following three stages that you can troubleshoot.</span><span class="sxs-lookup"><span data-stu-id="9f92a-164">To start, separate the flow into the following three stages that you can troubleshoot.</span></span>

### <a name="client-pre-authentication"></a><span data-ttu-id="9f92a-165">Client pre-authentication</span><span class="sxs-lookup"><span data-stu-id="9f92a-165">Client pre-authentication</span></span> 
<span data-ttu-id="9f92a-166">The external user authenticating to Azure via a browser.</span><span class="sxs-lookup"><span data-stu-id="9f92a-166">The external user authenticating to Azure via a browser.</span></span> <span data-ttu-id="9f92a-167">The ability to pre-authenticate to Azure is necessary for KCD SSO to function.</span><span class="sxs-lookup"><span data-stu-id="9f92a-167">The ability to pre-authenticate to Azure is necessary for KCD SSO to function.</span></span> <span data-ttu-id="9f92a-168">Test and address this ability if there are any issues.</span><span class="sxs-lookup"><span data-stu-id="9f92a-168">Test and address this ability if there are any issues.</span></span> <span data-ttu-id="9f92a-169">The pre-authentication stage isn't related to KCD or the published application.</span><span class="sxs-lookup"><span data-stu-id="9f92a-169">The pre-authentication stage isn't related to KCD or the published application.</span></span> <span data-ttu-id="9f92a-170">It's easy to correct any discrepancies by sanity checking that the subject account exists in Azure.</span><span class="sxs-lookup"><span data-stu-id="9f92a-170">It's easy to correct any discrepancies by sanity checking that the subject account exists in Azure.</span></span> <span data-ttu-id="9f92a-171">Also check that it's not disabled or blocked.</span><span class="sxs-lookup"><span data-stu-id="9f92a-171">Also check that it's not disabled or blocked.</span></span> <span data-ttu-id="9f92a-172">The error response in the browser is descriptive enough to explain the cause.</span><span class="sxs-lookup"><span data-stu-id="9f92a-172">The error response in the browser is descriptive enough to explain the cause.</span></span> <span data-ttu-id="9f92a-173">If you're uncertain, check other Microsoft troubleshooting articles to verify.</span><span class="sxs-lookup"><span data-stu-id="9f92a-173">If you're uncertain, check other Microsoft troubleshooting articles to verify.</span></span>

### <a name="delegation-service"></a><span data-ttu-id="9f92a-174">Delegation service</span><span class="sxs-lookup"><span data-stu-id="9f92a-174">Delegation service</span></span> 
<span data-ttu-id="9f92a-175">The Azure Proxy connector that gets a Kerberos service ticket for users from a Kerberos Key Distribution Center (KCD).</span><span class="sxs-lookup"><span data-stu-id="9f92a-175">The Azure Proxy connector that gets a Kerberos service ticket for users from a Kerberos Key Distribution Center (KCD).</span></span>

<span data-ttu-id="9f92a-176">The external communications between the client and the Azure front end have no bearing on KCD.</span><span class="sxs-lookup"><span data-stu-id="9f92a-176">The external communications between the client and the Azure front end have no bearing on KCD.</span></span> <span data-ttu-id="9f92a-177">These communications only make sure that KCD works.</span><span class="sxs-lookup"><span data-stu-id="9f92a-177">These communications only make sure that KCD works.</span></span> <span data-ttu-id="9f92a-178">The Azure Proxy service is provided a valid user ID that is used to get a Kerberos ticket.</span><span class="sxs-lookup"><span data-stu-id="9f92a-178">The Azure Proxy service is provided a valid user ID that is used to get a Kerberos ticket.</span></span> <span data-ttu-id="9f92a-179">Without this ID, KCD isn't possible and fails.</span><span class="sxs-lookup"><span data-stu-id="9f92a-179">Without this ID, KCD isn't possible and fails.</span></span>

<span data-ttu-id="9f92a-180">As mentioned previously, the browser error messages provides some good clues about why things fail.</span><span class="sxs-lookup"><span data-stu-id="9f92a-180">As mentioned previously, the browser error messages provides some good clues about why things fail.</span></span> <span data-ttu-id="9f92a-181">Make sure to note down the activity ID and timestamp in the response.</span><span class="sxs-lookup"><span data-stu-id="9f92a-181">Make sure to note down the activity ID and timestamp in the response.</span></span> <span data-ttu-id="9f92a-182">This information helps you correlate the behavior to actual events in the Azure Proxy event log.</span><span class="sxs-lookup"><span data-stu-id="9f92a-182">This information helps you correlate the behavior to actual events in the Azure Proxy event log.</span></span>

   ![Incorrect KCD configuration error](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="9f92a-184">The corresponding entries seen in the event log show as events 13019 or 12027.</span><span class="sxs-lookup"><span data-stu-id="9f92a-184">The corresponding entries seen in the event log show as events 13019 or 12027.</span></span> <span data-ttu-id="9f92a-185">Find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector** &gt; **Admin**.</span><span class="sxs-lookup"><span data-stu-id="9f92a-185">Find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector** &gt; **Admin**.</span></span>

   ![Event 13019 from Application Proxy event log](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Event 12027 from Application Proxy event log](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

1.   <span data-ttu-id="9f92a-188">Use an **A** record in your internal DNS for the application’s address, not a **CName**.</span><span class="sxs-lookup"><span data-stu-id="9f92a-188">Use an **A** record in your internal DNS for the application’s address, not a **CName**.</span></span>

2.   <span data-ttu-id="9f92a-189">Reconfirm that the connector host has been granted the right to delegate to the designated target account’s SPN.</span><span class="sxs-lookup"><span data-stu-id="9f92a-189">Reconfirm that the connector host has been granted the right to delegate to the designated target account’s SPN.</span></span> <span data-ttu-id="9f92a-190">Reconfirm that **Use any authentication protocol** is selected.</span><span class="sxs-lookup"><span data-stu-id="9f92a-190">Reconfirm that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="9f92a-191">For more information, see the [SSO configuration article](application-proxy-configure-single-sign-on-with-kcd.md).</span><span class="sxs-lookup"><span data-stu-id="9f92a-191">For more information, see the [SSO configuration article](application-proxy-configure-single-sign-on-with-kcd.md).</span></span>

3.   <span data-ttu-id="9f92a-192">Verify that there's only one instance of the SPN in existence in Azure AD.</span><span class="sxs-lookup"><span data-stu-id="9f92a-192">Verify that there's only one instance of the SPN in existence in Azure AD.</span></span> <span data-ttu-id="9f92a-193">Issue `setspn -x` from a command prompt on any domain member host.</span><span class="sxs-lookup"><span data-stu-id="9f92a-193">Issue `setspn -x` from a command prompt on any domain member host.</span></span>

4.   <span data-ttu-id="9f92a-194">Check that a domain policy is enforced that limits the [maximum size of issued Kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/).</span><span class="sxs-lookup"><span data-stu-id="9f92a-194">Check that a domain policy is enforced that limits the [maximum size of issued Kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/).</span></span> <span data-ttu-id="9f92a-195">This policy stops the connector from getting a token if it's found to be excessive.</span><span class="sxs-lookup"><span data-stu-id="9f92a-195">This policy stops the connector from getting a token if it's found to be excessive.</span></span>

<span data-ttu-id="9f92a-196">A network trace that captures the exchanges between the connector host and a domain KDC is the next best step to get more low-level detail on the issues.</span><span class="sxs-lookup"><span data-stu-id="9f92a-196">A network trace that captures the exchanges between the connector host and a domain KDC is the next best step to get more low-level detail on the issues.</span></span> <span data-ttu-id="9f92a-197">For more information, see the [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="9f92a-197">For more information, see the [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="9f92a-198">If ticketing looks good, you see an event in the logs stating that authentication failed because the application returned a 401.</span><span class="sxs-lookup"><span data-stu-id="9f92a-198">If ticketing looks good, you see an event in the logs stating that authentication failed because the application returned a 401.</span></span> <span data-ttu-id="9f92a-199">This event indicates that the target application rejected your ticket.</span><span class="sxs-lookup"><span data-stu-id="9f92a-199">This event indicates that the target application rejected your ticket.</span></span> <span data-ttu-id="9f92a-200">Go to the next stage.</span><span class="sxs-lookup"><span data-stu-id="9f92a-200">Go to the next stage.</span></span>

### <a name="target-application"></a><span data-ttu-id="9f92a-201">Target application</span><span class="sxs-lookup"><span data-stu-id="9f92a-201">Target application</span></span> 
<span data-ttu-id="9f92a-202">The consumer of the Kerberos ticket provided by the connector.</span><span class="sxs-lookup"><span data-stu-id="9f92a-202">The consumer of the Kerberos ticket provided by the connector.</span></span> <span data-ttu-id="9f92a-203">At this stage, expect the connector to have sent a Kerberos service ticket to the back end.</span><span class="sxs-lookup"><span data-stu-id="9f92a-203">At this stage, expect the connector to have sent a Kerberos service ticket to the back end.</span></span> <span data-ttu-id="9f92a-204">This ticket is a header in the first application request.</span><span class="sxs-lookup"><span data-stu-id="9f92a-204">This ticket is a header in the first application request.</span></span>

1.   <span data-ttu-id="9f92a-205">By using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span><span class="sxs-lookup"><span data-stu-id="9f92a-205">By using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span></span> <span data-ttu-id="9f92a-206">Then you can sign in successfully.</span><span class="sxs-lookup"><span data-stu-id="9f92a-206">Then you can sign in successfully.</span></span> <span data-ttu-id="9f92a-207">Details can be found on the connector **Troubleshoot** page.</span><span class="sxs-lookup"><span data-stu-id="9f92a-207">Details can be found on the connector **Troubleshoot** page.</span></span>

2.   <span data-ttu-id="9f92a-208">Still on the connector host, confirm that the authentication between the browser and the application uses Kerberos.</span><span class="sxs-lookup"><span data-stu-id="9f92a-208">Still on the connector host, confirm that the authentication between the browser and the application uses Kerberos.</span></span> <span data-ttu-id="9f92a-209">Take one of the following actions:</span><span class="sxs-lookup"><span data-stu-id="9f92a-209">Take one of the following actions:</span></span>

3.  <span data-ttu-id="9f92a-210">Run DevTools (**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span><span class="sxs-lookup"><span data-stu-id="9f92a-210">Run DevTools (**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span></span> <span data-ttu-id="9f92a-211">Go to the application by using the internal URL.</span><span class="sxs-lookup"><span data-stu-id="9f92a-211">Go to the application by using the internal URL.</span></span> <span data-ttu-id="9f92a-212">Inspect the offered WWW authorization headers returned in the response from the application to make sure that either negotiate or Kerberos is present.</span><span class="sxs-lookup"><span data-stu-id="9f92a-212">Inspect the offered WWW authorization headers returned in the response from the application to make sure that either negotiate or Kerberos is present.</span></span> 

    - <span data-ttu-id="9f92a-213">The next Kerberos blob that is returned in the response from the browser to the application starts with **YII**.</span><span class="sxs-lookup"><span data-stu-id="9f92a-213">The next Kerberos blob that is returned in the response from the browser to the application starts with **YII**.</span></span> <span data-ttu-id="9f92a-214">These letters tell you that Kerberos is running.</span><span class="sxs-lookup"><span data-stu-id="9f92a-214">These letters tell you that Kerberos is running.</span></span> <span data-ttu-id="9f92a-215">Microsoft NT LAN Manager (NTLM), on the other hand, always starts with **TlRMTVNTUAAB**, which reads NTLM Security Support Provider (NTLMSSP) when decoded from Base64.</span><span class="sxs-lookup"><span data-stu-id="9f92a-215">Microsoft NT LAN Manager (NTLM), on the other hand, always starts with **TlRMTVNTUAAB**, which reads NTLM Security Support Provider (NTLMSSP) when decoded from Base64.</span></span> <span data-ttu-id="9f92a-216">If you see **TlRMTVNTUAAB** at the start of the blob, Kerberos is not available.</span><span class="sxs-lookup"><span data-stu-id="9f92a-216">If you see **TlRMTVNTUAAB** at the start of the blob, Kerberos is not available.</span></span> <span data-ttu-id="9f92a-217">If you don’t see **TlRMTVNTUAAB**, Kerberos is likely available.</span><span class="sxs-lookup"><span data-stu-id="9f92a-217">If you don’t see **TlRMTVNTUAAB**, Kerberos is likely available.</span></span>
   
       > [!NOTE]
       > <span data-ttu-id="9f92a-218">If you use Fiddler, this method requires that you temporarily disable extended protection on the application’s configuration in IIS.</span><span class="sxs-lookup"><span data-stu-id="9f92a-218">If you use Fiddler, this method requires that you temporarily disable extended protection on the application’s configuration in IIS.</span></span>
      
      ![Browser network inspection window](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)
   
    - <span data-ttu-id="9f92a-220">The blob in this figure doesn't start with **TIRMTVNTUAAB**.</span><span class="sxs-lookup"><span data-stu-id="9f92a-220">The blob in this figure doesn't start with **TIRMTVNTUAAB**.</span></span> <span data-ttu-id="9f92a-221">So in this example, Kerberos is available, and the Kerberos blob doesn’t start with **YII**.</span><span class="sxs-lookup"><span data-stu-id="9f92a-221">So in this example, Kerberos is available, and the Kerberos blob doesn’t start with **YII**.</span></span>

4.  <span data-ttu-id="9f92a-222">Temporarily remove NTLM from the providers list on the IIS site.</span><span class="sxs-lookup"><span data-stu-id="9f92a-222">Temporarily remove NTLM from the providers list on the IIS site.</span></span> <span data-ttu-id="9f92a-223">Access the app directly from Internet Explorer on the connector host.</span><span class="sxs-lookup"><span data-stu-id="9f92a-223">Access the app directly from Internet Explorer on the connector host.</span></span> <span data-ttu-id="9f92a-224">NTLM is no longer in the providers list.</span><span class="sxs-lookup"><span data-stu-id="9f92a-224">NTLM is no longer in the providers list.</span></span> <span data-ttu-id="9f92a-225">You can access the application by using Kerberos only.</span><span class="sxs-lookup"><span data-stu-id="9f92a-225">You can access the application by using Kerberos only.</span></span> <span data-ttu-id="9f92a-226">If access fails, there might be a problem with the application’s configuration.</span><span class="sxs-lookup"><span data-stu-id="9f92a-226">If access fails, there might be a problem with the application’s configuration.</span></span> <span data-ttu-id="9f92a-227">Kerberos authentication isn't functioning.</span><span class="sxs-lookup"><span data-stu-id="9f92a-227">Kerberos authentication isn't functioning.</span></span>

    - <span data-ttu-id="9f92a-228">If Kerberos isn't available, check the application’s authentication settings in IIS.</span><span class="sxs-lookup"><span data-stu-id="9f92a-228">If Kerberos isn't available, check the application’s authentication settings in IIS.</span></span> <span data-ttu-id="9f92a-229">Make sure **Negotiate** is listed at the top, with NTLM just beneath it.</span><span class="sxs-lookup"><span data-stu-id="9f92a-229">Make sure **Negotiate** is listed at the top, with NTLM just beneath it.</span></span> <span data-ttu-id="9f92a-230">If you see **Not Negotiate**, **Kerberos or Negotiate**, or **PKU2U**, continue only if Kerberos is functional.</span><span class="sxs-lookup"><span data-stu-id="9f92a-230">If you see **Not Negotiate**, **Kerberos or Negotiate**, or **PKU2U**, continue only if Kerberos is functional.</span></span>

       ![Windows authentication providers](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
    - <span data-ttu-id="9f92a-232">With Kerberos and NTLM in place, temporarily disable pre-authentication for the application in the portal.</span><span class="sxs-lookup"><span data-stu-id="9f92a-232">With Kerberos and NTLM in place, temporarily disable pre-authentication for the application in the portal.</span></span> <span data-ttu-id="9f92a-233">Try to access it from the internet by using the external URL.</span><span class="sxs-lookup"><span data-stu-id="9f92a-233">Try to access it from the internet by using the external URL.</span></span> <span data-ttu-id="9f92a-234">You're prompted to authenticate.</span><span class="sxs-lookup"><span data-stu-id="9f92a-234">You're prompted to authenticate.</span></span> <span data-ttu-id="9f92a-235">You're able to do so with the same account used in the previous step.</span><span class="sxs-lookup"><span data-stu-id="9f92a-235">You're able to do so with the same account used in the previous step.</span></span> <span data-ttu-id="9f92a-236">If not, there's a problem with the back-end application, not KCD.</span><span class="sxs-lookup"><span data-stu-id="9f92a-236">If not, there's a problem with the back-end application, not KCD.</span></span>

    - <span data-ttu-id="9f92a-237">Re-enable pre-authentication in the portal.</span><span class="sxs-lookup"><span data-stu-id="9f92a-237">Re-enable pre-authentication in the portal.</span></span> <span data-ttu-id="9f92a-238">Authenticate through Azure by attempting to connect to the application via its external URL.</span><span class="sxs-lookup"><span data-stu-id="9f92a-238">Authenticate through Azure by attempting to connect to the application via its external URL.</span></span> <span data-ttu-id="9f92a-239">If SSO fails, you see a forbidden error message in the browser and event 13022 in the log:</span><span class="sxs-lookup"><span data-stu-id="9f92a-239">If SSO fails, you see a forbidden error message in the browser and event 13022 in the log:</span></span>

       <span data-ttu-id="9f92a-240">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span><span class="sxs-lookup"><span data-stu-id="9f92a-240">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span></span>

       ![HTTTP 401 forbidden error](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)
   
    - <span data-ttu-id="9f92a-242">Check the IIS application.</span><span class="sxs-lookup"><span data-stu-id="9f92a-242">Check the IIS application.</span></span> <span data-ttu-id="9f92a-243">Make sure that the configured application pool and the SPN are configured to use the same account in Azure AD.</span><span class="sxs-lookup"><span data-stu-id="9f92a-243">Make sure that the configured application pool and the SPN are configured to use the same account in Azure AD.</span></span> <span data-ttu-id="9f92a-244">Navigate in IIS as shown in the following illustration:</span><span class="sxs-lookup"><span data-stu-id="9f92a-244">Navigate in IIS as shown in the following illustration:</span></span>
      
       ![IIS application configuration window](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)
      
       <span data-ttu-id="9f92a-246">After you know the identity, make sure this account is configured with the SPN in question.</span><span class="sxs-lookup"><span data-stu-id="9f92a-246">After you know the identity, make sure this account is configured with the SPN in question.</span></span> <span data-ttu-id="9f92a-247">An example is `setspn –q http/spn.wacketywack.com`.</span><span class="sxs-lookup"><span data-stu-id="9f92a-247">An example is `setspn –q http/spn.wacketywack.com`.</span></span> <span data-ttu-id="9f92a-248">Enter the following text in a command prompt:</span><span class="sxs-lookup"><span data-stu-id="9f92a-248">Enter the following text in a command prompt:</span></span>
      
       ![SetSPN command window](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)
      
    - <span data-ttu-id="9f92a-250">Check the SPN defined against the application’s settings in the portal.</span><span class="sxs-lookup"><span data-stu-id="9f92a-250">Check the SPN defined against the application’s settings in the portal.</span></span> <span data-ttu-id="9f92a-251">Make sure that the same SPN configured against the target Azure AD account is used by the application’s app pool.</span><span class="sxs-lookup"><span data-stu-id="9f92a-251">Make sure that the same SPN configured against the target Azure AD account is used by the application’s app pool.</span></span>

       ![SPN configuration in the Azure portal](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
    - <span data-ttu-id="9f92a-253">Go into IIS and select the **Configuration Editor** option for the application.</span><span class="sxs-lookup"><span data-stu-id="9f92a-253">Go into IIS and select the **Configuration Editor** option for the application.</span></span> <span data-ttu-id="9f92a-254">Navigate to **system.webServer/security/authentication/windowsAuthentication**.</span><span class="sxs-lookup"><span data-stu-id="9f92a-254">Navigate to **system.webServer/security/authentication/windowsAuthentication**.</span></span> <span data-ttu-id="9f92a-255">Make sure the value **UseAppPoolCredentials** is **True**.</span><span class="sxs-lookup"><span data-stu-id="9f92a-255">Make sure the value **UseAppPoolCredentials** is **True**.</span></span>

       ![IIS configuration app pools credential option](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

       <span data-ttu-id="9f92a-257">Change this value to **True**.</span><span class="sxs-lookup"><span data-stu-id="9f92a-257">Change this value to **True**.</span></span> <span data-ttu-id="9f92a-258">Remove all cached Kerberos tickets from the back-end server by running the following command:</span><span class="sxs-lookup"><span data-stu-id="9f92a-258">Remove all cached Kerberos tickets from the back-end server by running the following command:</span></span>

       ```powershell
       Get-WmiObject Win32_LogonSession | Where-Object {$_.AuthenticationPackage -ne 'NTLM'} | ForEach-Object {klist.exe purge -li ([Convert]::ToString($_.LogonId, 16))}
       ``` 

<span data-ttu-id="9f92a-259">For more information, see [Purge the Kerberos client ticket cache for all sessions](https://gallery.technet.microsoft.com/scriptcenter/Purge-the-Kerberos-client-b56987bf).</span><span class="sxs-lookup"><span data-stu-id="9f92a-259">For more information, see [Purge the Kerberos client ticket cache for all sessions](https://gallery.technet.microsoft.com/scriptcenter/Purge-the-Kerberos-client-b56987bf).</span></span>



<span data-ttu-id="9f92a-260">If you leave Kernel mode enabled, it improves the performance of Kerberos operations.</span><span class="sxs-lookup"><span data-stu-id="9f92a-260">If you leave Kernel mode enabled, it improves the performance of Kerberos operations.</span></span> <span data-ttu-id="9f92a-261">But it also causes the ticket for the requested service to be decrypted by using the machine account.</span><span class="sxs-lookup"><span data-stu-id="9f92a-261">But it also causes the ticket for the requested service to be decrypted by using the machine account.</span></span> <span data-ttu-id="9f92a-262">This account is also called the Local system.</span><span class="sxs-lookup"><span data-stu-id="9f92a-262">This account is also called the Local system.</span></span> <span data-ttu-id="9f92a-263">Set this value to **True** to break KCD when the application is hosted across more than one server in a farm.</span><span class="sxs-lookup"><span data-stu-id="9f92a-263">Set this value to **True** to break KCD when the application is hosted across more than one server in a farm.</span></span>

-   <span data-ttu-id="9f92a-264">As an additional check, disable **Extended** protection too.</span><span class="sxs-lookup"><span data-stu-id="9f92a-264">As an additional check, disable **Extended** protection too.</span></span> <span data-ttu-id="9f92a-265">In some scenarios, **Extended** protection broke KCD when it was enabled in specific configurations.</span><span class="sxs-lookup"><span data-stu-id="9f92a-265">In some scenarios, **Extended** protection broke KCD when it was enabled in specific configurations.</span></span> <span data-ttu-id="9f92a-266">In those cases, an application was published as a subfolder of the default website.</span><span class="sxs-lookup"><span data-stu-id="9f92a-266">In those cases, an application was published as a subfolder of the default website.</span></span> <span data-ttu-id="9f92a-267">This application is configured for anonymous authentication only.</span><span class="sxs-lookup"><span data-stu-id="9f92a-267">This application is configured for anonymous authentication only.</span></span> <span data-ttu-id="9f92a-268">All the dialogs are grayed out, which suggests child objects wouldn't inherit any active settings.</span><span class="sxs-lookup"><span data-stu-id="9f92a-268">All the dialogs are grayed out, which suggests child objects wouldn't inherit any active settings.</span></span> <span data-ttu-id="9f92a-269">We recommend that you test, but don’t forget to restore this value to **enabled**, where possible.</span><span class="sxs-lookup"><span data-stu-id="9f92a-269">We recommend that you test, but don’t forget to restore this value to **enabled**, where possible.</span></span>

    <span data-ttu-id="9f92a-270">This additional check puts you on track to use your published application.</span><span class="sxs-lookup"><span data-stu-id="9f92a-270">This additional check puts you on track to use your published application.</span></span> <span data-ttu-id="9f92a-271">You can spin up additional connectors that are also configured to delegate.</span><span class="sxs-lookup"><span data-stu-id="9f92a-271">You can spin up additional connectors that are also configured to delegate.</span></span> <span data-ttu-id="9f92a-272">For more information, read the more in-depth technical walk-through, [Troubleshooting the Azure AD Application Proxy](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="9f92a-272">For more information, read the more in-depth technical walk-through, [Troubleshooting the Azure AD Application Proxy](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="9f92a-273">If you still can't make progress, Microsoft support can assist you.</span><span class="sxs-lookup"><span data-stu-id="9f92a-273">If you still can't make progress, Microsoft support can assist you.</span></span> <span data-ttu-id="9f92a-274">Create a support ticket directly within the portal.</span><span class="sxs-lookup"><span data-stu-id="9f92a-274">Create a support ticket directly within the portal.</span></span> <span data-ttu-id="9f92a-275">An engineer will contact you.</span><span class="sxs-lookup"><span data-stu-id="9f92a-275">An engineer will contact you.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="9f92a-276">Other scenarios</span><span class="sxs-lookup"><span data-stu-id="9f92a-276">Other scenarios</span></span>

- <span data-ttu-id="9f92a-277">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span><span class="sxs-lookup"><span data-stu-id="9f92a-277">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span></span> <span data-ttu-id="9f92a-278">Some third-party applications like Tableau Server don't like this method of authenticating.</span><span class="sxs-lookup"><span data-stu-id="9f92a-278">Some third-party applications like Tableau Server don't like this method of authenticating.</span></span> <span data-ttu-id="9f92a-279">These applications expect the more conventional negotiations to take place.</span><span class="sxs-lookup"><span data-stu-id="9f92a-279">These applications expect the more conventional negotiations to take place.</span></span> <span data-ttu-id="9f92a-280">The first request is anonymous, which allows the application to respond with the authentication types that it supports through a 401.</span><span class="sxs-lookup"><span data-stu-id="9f92a-280">The first request is anonymous, which allows the application to respond with the authentication types that it supports through a 401.</span></span>

- <span data-ttu-id="9f92a-281">Multi-hop authentication is commonly used in scenarios where an application is tiered, with a back end and front end, where both require authentication, such as SQL Server Reporting Services.</span><span class="sxs-lookup"><span data-stu-id="9f92a-281">Multi-hop authentication is commonly used in scenarios where an application is tiered, with a back end and front end, where both require authentication, such as SQL Server Reporting Services.</span></span> <span data-ttu-id="9f92a-282">To configure the multihop scenario, see the support article [Kerberos Constrained Delegation May Require Protocol Transition in Multi-hop Scenarios](https://support.microsoft.com/help/2005838/kerberos-constrained-delegation-may-require-protocol-transition-in-mul).</span><span class="sxs-lookup"><span data-stu-id="9f92a-282">To configure the multihop scenario, see the support article [Kerberos Constrained Delegation May Require Protocol Transition in Multi-hop Scenarios](https://support.microsoft.com/help/2005838/kerberos-constrained-delegation-may-require-protocol-transition-in-mul).</span></span>

## <a name="next-steps"></a><span data-ttu-id="9f92a-283">Next steps</span><span class="sxs-lookup"><span data-stu-id="9f92a-283">Next steps</span></span>
<span data-ttu-id="9f92a-284">[Configure KCD on a managed domain](../../active-directory-domain-services/active-directory-ds-enable-kcd.md).</span><span class="sxs-lookup"><span data-stu-id="9f92a-284">[Configure KCD on a managed domain](../../active-directory-domain-services/active-directory-ds-enable-kcd.md).</span></span>
