---
title: Single sign-on with Application Proxy | Microsoft Docs
description: Covers how to provide single sign-on using Azure AD Application Proxy.
services: active-directory
documentationcenter: ''
author: kgremban
manager: femila
editor: ''
ms.assetid: ded0d9c9-45f6-47d7-bd0f-3f7fd99ab621
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/27/2017
ms.author: kgremban
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 16a2d87c7d955a6a36d70f2717a042ed7be42b37
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44552935"
---
# <a name="provide-single-sign-on-to-your-apps-with-application-proxy"></a><span data-ttu-id="7c5b4-103">Provide single sign-on to your apps with Application Proxy</span><span class="sxs-lookup"><span data-stu-id="7c5b4-103">Provide single sign-on to your apps with Application Proxy</span></span>
<span data-ttu-id="7c5b4-104">Single sign-on is a key element of Azure AD Application Proxy.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-104">Single sign-on is a key element of Azure AD Application Proxy.</span></span> <span data-ttu-id="7c5b4-105">It provides the best user experience with the following steps:</span><span class="sxs-lookup"><span data-stu-id="7c5b4-105">It provides the best user experience with the following steps:</span></span>

1. <span data-ttu-id="7c5b4-106">A user signs in to the cloud.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-106">A user signs in to the cloud.</span></span>  
2. <span data-ttu-id="7c5b4-107">All security validations happen in the cloud (preauthentication).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-107">All security validations happen in the cloud (preauthentication).</span></span>  
3. <span data-ttu-id="7c5b4-108">When the request is sent to the on-prem application, the Application Proxy Connector impersonates the user.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-108">When the request is sent to the on-prem application, the Application Proxy Connector impersonates the user.</span></span> <span data-ttu-id="7c5b4-109">The backend application thinks this is a regular user coming from a domain-joined device.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-109">The backend application thinks this is a regular user coming from a domain-joined device.</span></span>

![Access diagram from end user, through Application Proxy, to the corporate network](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_diagram.png)

<span data-ttu-id="7c5b4-111">Azure AD Application Proxy helps you provide a single sign-on (SSO) experience for your users.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-111">Azure AD Application Proxy helps you provide a single sign-on (SSO) experience for your users.</span></span> <span data-ttu-id="7c5b4-112">Use the following instructions to publish your apps using SSO:</span><span class="sxs-lookup"><span data-stu-id="7c5b4-112">Use the following instructions to publish your apps using SSO:</span></span>

## <a name="sso-for-on-prem-iwa-apps-using-kcd-with-application-proxy"></a><span data-ttu-id="7c5b4-113">SSO for on-prem IWA apps using KCD with Application Proxy</span><span class="sxs-lookup"><span data-stu-id="7c5b4-113">SSO for on-prem IWA apps using KCD with Application Proxy</span></span>
<span data-ttu-id="7c5b4-114">You can enable single sign-on to your applications using Integrated Windows Authentication (IWA) by giving Application Proxy Connectors permission in Active Directory to impersonate users, and send and receive tokens on their behalf.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-114">You can enable single sign-on to your applications using Integrated Windows Authentication (IWA) by giving Application Proxy Connectors permission in Active Directory to impersonate users, and send and receive tokens on their behalf.</span></span>

### <a name="network-diagram"></a><span data-ttu-id="7c5b4-115">Network diagram</span><span class="sxs-lookup"><span data-stu-id="7c5b4-115">Network diagram</span></span>
<span data-ttu-id="7c5b4-116">This diagram explains the flow when a user attempts to access an on-prem application that uses IWA.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-116">This diagram explains the flow when a user attempts to access an on-prem application that uses IWA.</span></span>

![Microsoft AAD authentication flow diagram](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/AuthDiagram.png)

1. <span data-ttu-id="7c5b4-118">The user enters the URL to access the on-prem application through Application Proxy.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-118">The user enters the URL to access the on-prem application through Application Proxy.</span></span>
2. <span data-ttu-id="7c5b4-119">Application Proxy redirects the request to Azure AD authentication services to preauthenticate.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-119">Application Proxy redirects the request to Azure AD authentication services to preauthenticate.</span></span> <span data-ttu-id="7c5b4-120">At this point, Azure AD applies any applicable authentication and authorization policies, such as multifactor authentication.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-120">At this point, Azure AD applies any applicable authentication and authorization policies, such as multifactor authentication.</span></span> <span data-ttu-id="7c5b4-121">If the user is validated, Azure AD creates a token and sends it to the user.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-121">If the user is validated, Azure AD creates a token and sends it to the user.</span></span>
3. <span data-ttu-id="7c5b4-122">The user passes the token to Application Proxy.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-122">The user passes the token to Application Proxy.</span></span>
4. <span data-ttu-id="7c5b4-123">Application Proxy validates the token and retrieves the User Principal Name (UPN) from it, and then sends the request, the UPN, and the Service Principal Name (SPN) to the Connector through a dually authenticated secure channel.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-123">Application Proxy validates the token and retrieves the User Principal Name (UPN) from it, and then sends the request, the UPN, and the Service Principal Name (SPN) to the Connector through a dually authenticated secure channel.</span></span>
5. <span data-ttu-id="7c5b4-124">The Connector performs Kerberos Constrained Delegation (KCD) negotiation with the on-prem AD, impersonating the user to get a Kerberos token to the application.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-124">The Connector performs Kerberos Constrained Delegation (KCD) negotiation with the on-prem AD, impersonating the user to get a Kerberos token to the application.</span></span>
6. <span data-ttu-id="7c5b4-125">Active Directory sends the Kerberos token for the application to the Connector.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-125">Active Directory sends the Kerberos token for the application to the Connector.</span></span>
7. <span data-ttu-id="7c5b4-126">The Connector sends the original request to the application server, using the Kerberos token it received from AD.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-126">The Connector sends the original request to the application server, using the Kerberos token it received from AD.</span></span>
8. <span data-ttu-id="7c5b4-127">The application sends the response to the Connector, which is then returned to the Application Proxy service and finally to the user.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-127">The application sends the response to the Connector, which is then returned to the Application Proxy service and finally to the user.</span></span>

### <a name="prerequisites"></a><span data-ttu-id="7c5b4-128">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="7c5b4-128">Prerequisites</span></span>
<span data-ttu-id="7c5b4-129">Before you get started with SSO for Application Proxy, make sure your environment is ready with the following settings and configurations:</span><span class="sxs-lookup"><span data-stu-id="7c5b4-129">Before you get started with SSO for Application Proxy, make sure your environment is ready with the following settings and configurations:</span></span>

* <span data-ttu-id="7c5b4-130">Your apps, like SharePoint Web apps, are set to use Integrated Windows Authentication.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-130">Your apps, like SharePoint Web apps, are set to use Integrated Windows Authentication.</span></span> <span data-ttu-id="7c5b4-131">For more information, see [Enable Support for Kerberos Authentication](https://technet.microsoft.com/library/dd759186.aspx), or for SharePoint see [Plan for Kerberos authentication in SharePoint 2013](https://technet.microsoft.com/library/ee806870.aspx).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-131">For more information, see [Enable Support for Kerberos Authentication](https://technet.microsoft.com/library/dd759186.aspx), or for SharePoint see [Plan for Kerberos authentication in SharePoint 2013](https://technet.microsoft.com/library/ee806870.aspx).</span></span>
* <span data-ttu-id="7c5b4-132">All your apps have Service Principal Names.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-132">All your apps have Service Principal Names.</span></span>
* <span data-ttu-id="7c5b4-133">The server running the Connector and the server running the app are domain joined and part of the same domain or trusting domains.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-133">The server running the Connector and the server running the app are domain joined and part of the same domain or trusting domains.</span></span> <span data-ttu-id="7c5b4-134">For more information on domain join, see [Join a Computer to a Domain](https://technet.microsoft.com/library/dd807102.aspx).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-134">For more information on domain join, see [Join a Computer to a Domain](https://technet.microsoft.com/library/dd807102.aspx).</span></span>
* <span data-ttu-id="7c5b4-135">The server running the Connector has access to read the TokenGroupsGlobalAndUniversal for users.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-135">The server running the Connector has access to read the TokenGroupsGlobalAndUniversal for users.</span></span> <span data-ttu-id="7c5b4-136">This is a default setting that might have been impacted by security hardening the environment.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-136">This is a default setting that might have been impacted by security hardening the environment.</span></span> <span data-ttu-id="7c5b4-137">Get more help with this setting in [KB2009157](https://support.microsoft.com/en-us/kb/2009157).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-137">Get more help with this setting in [KB2009157](https://support.microsoft.com/en-us/kb/2009157).</span></span>

### <a name="active-directory-configuration"></a><span data-ttu-id="7c5b4-138">Active Directory configuration</span><span class="sxs-lookup"><span data-stu-id="7c5b4-138">Active Directory configuration</span></span>
<span data-ttu-id="7c5b4-139">The Active Directory configuration varies, depending on whether your Application Proxy Connector and the published server are in the same domain or not.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-139">The Active Directory configuration varies, depending on whether your Application Proxy Connector and the published server are in the same domain or not.</span></span>

#### <a name="connector-and-published-server-in-the-same-domain"></a><span data-ttu-id="7c5b4-140">Connector and published server in the same domain</span><span class="sxs-lookup"><span data-stu-id="7c5b4-140">Connector and published server in the same domain</span></span>
1. <span data-ttu-id="7c5b4-141">In Active Directory, go to **Tools** > **Users and Computers**.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-141">In Active Directory, go to **Tools** > **Users and Computers**.</span></span>
2. <span data-ttu-id="7c5b4-142">Select the server running the Connector.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-142">Select the server running the Connector.</span></span>
<span data-ttu-id="7c5b4-143">.3.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-143">.3.</span></span> <span data-ttu-id="7c5b4-144">Right-click and select **Properties** > **Delegation**.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-144">Right-click and select **Properties** > **Delegation**.</span></span>
4. <span data-ttu-id="7c5b4-145">Select **Trust this computer for delegation to specified services only**.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-145">Select **Trust this computer for delegation to specified services only**.</span></span> <span data-ttu-id="7c5b4-146">Under **Services to which this account can present delegated credentials** add the value for the SPN identity of the application server.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-146">Under **Services to which this account can present delegated credentials** add the value for the SPN identity of the application server.</span></span>
5. <span data-ttu-id="7c5b4-147">This enables the Application Proxy Connector to impersonate users in AD against the applications defined in the list.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-147">This enables the Application Proxy Connector to impersonate users in AD against the applications defined in the list.</span></span>

![Connector-SVR Properties window screenshot](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/Properties.jpg)

#### <a name="connector-and-published-server-in-different-domains"></a><span data-ttu-id="7c5b4-149">Connector and published server in different domains</span><span class="sxs-lookup"><span data-stu-id="7c5b4-149">Connector and published server in different domains</span></span>
1. <span data-ttu-id="7c5b4-150">For a list of prerequisites for working with KCD across domains, see [Kerberos Constrained Delegation across domains](https://technet.microsoft.com/library/hh831477.aspx).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-150">For a list of prerequisites for working with KCD across domains, see [Kerberos Constrained Delegation across domains](https://technet.microsoft.com/library/hh831477.aspx).</span></span>
2. <span data-ttu-id="7c5b4-151">In Windows 2012 R2, use the `principalsallowedtodelegateto` property on the Connector server to enable the Application Proxy to delegate for the Connector server, where the published server is `sharepointserviceaccount` and the delegating server is `connectormachineaccount`.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-151">In Windows 2012 R2, use the `principalsallowedtodelegateto` property on the Connector server to enable the Application Proxy to delegate for the Connector server, where the published server is `sharepointserviceaccount` and the delegating server is `connectormachineaccount`.</span></span>

        $connector= Get-ADComputer -Identity connectormachineaccount -server dc.connectordomain.com

        Set-ADComputer -Identity sharepointserviceaccount -PrincipalsAllowedToDelegateToAccount $connector

        Get-ADComputer sharepointserviceaccount -Properties PrincipalsAllowedToDelegateToAccount

> [!NOTE]
> <span data-ttu-id="7c5b4-152">`sharepointserviceaccount` can be the SPS machine account or a service account under which the SPS app pool is running.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-152">`sharepointserviceaccount` can be the SPS machine account or a service account under which the SPS app pool is running.</span></span>
>
>

### <a name="azure-classic-portal-configuration"></a><span data-ttu-id="7c5b4-153">Azure classic portal configuration</span><span class="sxs-lookup"><span data-stu-id="7c5b4-153">Azure classic portal configuration</span></span>
1. <span data-ttu-id="7c5b4-154">Publish your application according to the instructions described in [Publish applications with Application Proxy](active-directory-application-proxy-publish.md).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-154">Publish your application according to the instructions described in [Publish applications with Application Proxy](active-directory-application-proxy-publish.md).</span></span> <span data-ttu-id="7c5b4-155">Make sure to select **Azure Active Directory** as the **Preauthentication Method**.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-155">Make sure to select **Azure Active Directory** as the **Preauthentication Method**.</span></span>
2. <span data-ttu-id="7c5b4-156">After your application appears in the list of applications, select it and click **Configure**.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-156">After your application appears in the list of applications, select it and click **Configure**.</span></span>
3. <span data-ttu-id="7c5b4-157">Under **Properties**, set **Internal Authentication Method** to **Integrated Windows Authentication**.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-157">Under **Properties**, set **Internal Authentication Method** to **Integrated Windows Authentication**.</span></span>  
   <span data-ttu-id="7c5b4-158">![Advanced Application Configuration](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/cwap_auth2.png)</span><span class="sxs-lookup"><span data-stu-id="7c5b4-158">![Advanced Application Configuration](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/cwap_auth2.png)</span></span>  
4. <span data-ttu-id="7c5b4-159">Enter the **Internal Application SPN** of the application server.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-159">Enter the **Internal Application SPN** of the application server.</span></span> <span data-ttu-id="7c5b4-160">In this example, the SPN for our published application is http/lob.contoso.com.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-160">In this example, the SPN for our published application is http/lob.contoso.com.</span></span>  

> [!IMPORTANT]
> <span data-ttu-id="7c5b4-161">If your on-premises UPN and the UPN in Azure Active Directory are not identical, you need to configure the [delegated login identity](#delegated-login-identity) in order for preauthentication to work.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-161">If your on-premises UPN and the UPN in Azure Active Directory are not identical, you need to configure the [delegated login identity](#delegated-login-identity) in order for preauthentication to work.</span></span>
>
>

|  |  |
| --- | --- |
| <span data-ttu-id="7c5b4-162">Internal Authentication Method</span><span class="sxs-lookup"><span data-stu-id="7c5b4-162">Internal Authentication Method</span></span> |<span data-ttu-id="7c5b4-163">If you use Azure AD for preauthentication, you can set an internal authentication method to enable your users to benefit from single sign-on (SSO) to this application.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-163">If you use Azure AD for preauthentication, you can set an internal authentication method to enable your users to benefit from single sign-on (SSO) to this application.</span></span> <br><br> <span data-ttu-id="7c5b4-164">Select **Integrated Windows Authentication** (IWA) if your application uses IWA and you can configure Kerberos Constrained Delegation (KCD) to enable SSO for this application.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-164">Select **Integrated Windows Authentication** (IWA) if your application uses IWA and you can configure Kerberos Constrained Delegation (KCD) to enable SSO for this application.</span></span> <span data-ttu-id="7c5b4-165">Applications that use IWA must be configured using KCD, otherwise Application Proxy can't publish these applications.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-165">Applications that use IWA must be configured using KCD, otherwise Application Proxy can't publish these applications.</span></span> <br><br> <span data-ttu-id="7c5b4-166">Select **None** if your application does not use IWA.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-166">Select **None** if your application does not use IWA.</span></span> |
| <span data-ttu-id="7c5b4-167">Internal Application SPN</span><span class="sxs-lookup"><span data-stu-id="7c5b4-167">Internal Application SPN</span></span> |<span data-ttu-id="7c5b4-168">This is the Service-Principal-Name (SPN) of the internal application as configured in the on-prem Azure AD.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-168">This is the Service-Principal-Name (SPN) of the internal application as configured in the on-prem Azure AD.</span></span> <span data-ttu-id="7c5b4-169">The SPN is used by the Application Proxy Connector to fetch Kerberos tokens for the application using KCD.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-169">The SPN is used by the Application Proxy Connector to fetch Kerberos tokens for the application using KCD.</span></span> |

## <a name="sso-for-non-windows-apps"></a><span data-ttu-id="7c5b4-170">SSO for non-Windows apps</span><span class="sxs-lookup"><span data-stu-id="7c5b4-170">SSO for non-Windows apps</span></span>
<span data-ttu-id="7c5b4-171">The Kerberos delegation flow in Azure AD Application Proxy starts when Azure AD authenticates the user in the cloud.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-171">The Kerberos delegation flow in Azure AD Application Proxy starts when Azure AD authenticates the user in the cloud.</span></span> <span data-ttu-id="7c5b4-172">Once the request arrives on-premises, the Azure AD Application Proxy Connector issues a Kerberos ticket on behalf of the user by interacting with the local Active Directory.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-172">Once the request arrives on-premises, the Azure AD Application Proxy Connector issues a Kerberos ticket on behalf of the user by interacting with the local Active Directory.</span></span> <span data-ttu-id="7c5b4-173">This process is referred to as Kerberos Constrained Delegation (KCD).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-173">This process is referred to as Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="7c5b4-174">In the next phase, a request is sent to the backend application with this Kerberos ticket.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-174">In the next phase, a request is sent to the backend application with this Kerberos ticket.</span></span> <span data-ttu-id="7c5b4-175">There are several protocols that define how to send such requests.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-175">There are several protocols that define how to send such requests.</span></span> <span data-ttu-id="7c5b4-176">Most non-Windows servers expect Negotiate/SPNego that is now supported on Azure AD Application Proxy.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-176">Most non-Windows servers expect Negotiate/SPNego that is now supported on Azure AD Application Proxy.</span></span>

![Non-Windows SSO diagram](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_nonwindows_diagram.png)

<span data-ttu-id="7c5b4-178">For more information about Kerberos, see [All you want to know about Kerberos Constrained Delegation (KCD)](https://blogs.technet.microsoft.com/applicationproxyblog/2015/09/21/all-you-want-to-know-about-kerberos-constrained-delegation-kcd).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-178">For more information about Kerberos, see [All you want to know about Kerberos Constrained Delegation (KCD)](https://blogs.technet.microsoft.com/applicationproxyblog/2015/09/21/all-you-want-to-know-about-kerberos-constrained-delegation-kcd).</span></span>

### <a name="delegated-login-identity"></a><span data-ttu-id="7c5b4-179">Delegated login identity</span><span class="sxs-lookup"><span data-stu-id="7c5b4-179">Delegated login identity</span></span>
<span data-ttu-id="7c5b4-180">Delegated login identity helps you handle two different login scenarios:</span><span class="sxs-lookup"><span data-stu-id="7c5b4-180">Delegated login identity helps you handle two different login scenarios:</span></span>

* <span data-ttu-id="7c5b4-181">Non-Windows applications that typically get user identity in the form of a username or SAM account name, not an email address (username@domain).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-181">Non-Windows applications that typically get user identity in the form of a username or SAM account name, not an email address (username@domain).</span></span>
* <span data-ttu-id="7c5b4-182">Alternative login configurations where the UPN in Azure AD and the UPN in your on-premises Active Directory are different.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-182">Alternative login configurations where the UPN in Azure AD and the UPN in your on-premises Active Directory are different.</span></span>

<span data-ttu-id="7c5b4-183">With Application Proxy, you can select which identity to use to obtain the Kerberos ticket.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-183">With Application Proxy, you can select which identity to use to obtain the Kerberos ticket.</span></span> <span data-ttu-id="7c5b4-184">This setting is per application.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-184">This setting is per application.</span></span> <span data-ttu-id="7c5b4-185">Some of these options are suitable for systems that do not accept email address format, others are designed for alternative login.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-185">Some of these options are suitable for systems that do not accept email address format, others are designed for alternative login.</span></span>

![Delegated login identity parameter screenshot](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_upn.png)

<span data-ttu-id="7c5b4-187">If delegated login identity is used, the value might not be unique for all the domains or forests in your organization.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-187">If delegated login identity is used, the value might not be unique for all the domains or forests in your organization.</span></span> <span data-ttu-id="7c5b4-188">You can avoid this issue by publishing these applications twice using two different Connector groups.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-188">You can avoid this issue by publishing these applications twice using two different Connector groups.</span></span> <span data-ttu-id="7c5b4-189">Since each application has a different user audience, you can join its Connectors to a different domain.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-189">Since each application has a different user audience, you can join its Connectors to a different domain.</span></span>

## <a name="working-with-sso-when-on-premises-and-cloud-identities-are-not-identical"></a><span data-ttu-id="7c5b4-190">Working with SSO when on-premises and cloud identities are not identical</span><span class="sxs-lookup"><span data-stu-id="7c5b4-190">Working with SSO when on-premises and cloud identities are not identical</span></span>
<span data-ttu-id="7c5b4-191">Unless otherwise configured, Application Proxy assumes that users have exactly the same identity in the cloud and on-premises.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-191">Unless otherwise configured, Application Proxy assumes that users have exactly the same identity in the cloud and on-premises.</span></span> <span data-ttu-id="7c5b4-192">You can configure, for each application, which identity should be used when performing single sign-on.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-192">You can configure, for each application, which identity should be used when performing single sign-on.</span></span>  

<span data-ttu-id="7c5b4-193">This capability allows many organizations that have different on-prem and cloud identities to have SSO from the cloud to on-prem apps without requiring the users to enter different usernames and passwords.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-193">This capability allows many organizations that have different on-prem and cloud identities to have SSO from the cloud to on-prem apps without requiring the users to enter different usernames and passwords.</span></span> <span data-ttu-id="7c5b4-194">This includes organizations that:</span><span class="sxs-lookup"><span data-stu-id="7c5b4-194">This includes organizations that:</span></span>

* <span data-ttu-id="7c5b4-195">Have multiple domains internally (joe@us.contoso.com, joe@eu.contoso.com) and a single domain in the cloud (joe@contoso.com).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-195">Have multiple domains internally (joe@us.contoso.com, joe@eu.contoso.com) and a single domain in the cloud (joe@contoso.com).</span></span>
* <span data-ttu-id="7c5b4-196">Have non-routable domain name internally (joe@contoso.usa) and a legal one in the cloud.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-196">Have non-routable domain name internally (joe@contoso.usa) and a legal one in the cloud.</span></span>
* <span data-ttu-id="7c5b4-197">Do not use domain names internally (joe)</span><span class="sxs-lookup"><span data-stu-id="7c5b4-197">Do not use domain names internally (joe)</span></span>
* <span data-ttu-id="7c5b4-198">Use different aliases on-prem and in the cloud.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-198">Use different aliases on-prem and in the cloud.</span></span> <span data-ttu-id="7c5b4-199">E.g.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-199">E.g.</span></span> <span data-ttu-id="7c5b4-200">joe-johns@contoso.com vs. joej@contoso.com</span><span class="sxs-lookup"><span data-stu-id="7c5b4-200">joe-johns@contoso.com vs. joej@contoso.com</span></span>  

<span data-ttu-id="7c5b4-201">It also helps with applications that do not accept addresses in the form of email address, which is a very common scenario for non-Windows backend servers.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-201">It also helps with applications that do not accept addresses in the form of email address, which is a very common scenario for non-Windows backend servers.</span></span>

### <a name="setting-sso-for-different-cloud-and-on-prem-identities"></a><span data-ttu-id="7c5b4-202">Setting SSO for different cloud and on-prem identities</span><span class="sxs-lookup"><span data-stu-id="7c5b4-202">Setting SSO for different cloud and on-prem identities</span></span>
1. <span data-ttu-id="7c5b4-203">Configure Azure AD Connect settings so the main identity is the email address (mail).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-203">Configure Azure AD Connect settings so the main identity is the email address (mail).</span></span> <span data-ttu-id="7c5b4-204">This is done as part of the customize process, by changing the **User Principal Name** field in the sync settings.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-204">This is done as part of the customize process, by changing the **User Principal Name** field in the sync settings.</span></span> <span data-ttu-id="7c5b4-205">These settings also determine how users log in to Office365, Windows10 devices, and other applications that use Azure AD as their identity store.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-205">These settings also determine how users log in to Office365, Windows10 devices, and other applications that use Azure AD as their identity store.</span></span>  
   <span data-ttu-id="7c5b4-206">![Identifying users screenshot - User Principal Name dropdown](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_connect_settings.png)</span><span class="sxs-lookup"><span data-stu-id="7c5b4-206">![Identifying users screenshot - User Principal Name dropdown](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_connect_settings.png)</span></span>  
2. <span data-ttu-id="7c5b4-207">In the Application Configuration settings for the application you would like to modify, select the **Delegated Login Identity** to be used:</span><span class="sxs-lookup"><span data-stu-id="7c5b4-207">In the Application Configuration settings for the application you would like to modify, select the **Delegated Login Identity** to be used:</span></span>

   * <span data-ttu-id="7c5b4-208">User Principal Name: joe@contoso.com</span><span class="sxs-lookup"><span data-stu-id="7c5b4-208">User Principal Name: joe@contoso.com</span></span>  
   * <span data-ttu-id="7c5b4-209">Alternate User Principal Name: joed@contoso.local</span><span class="sxs-lookup"><span data-stu-id="7c5b4-209">Alternate User Principal Name: joed@contoso.local</span></span>  
   * <span data-ttu-id="7c5b4-210">Username part of User Principal Name: joe</span><span class="sxs-lookup"><span data-stu-id="7c5b4-210">Username part of User Principal Name: joe</span></span>  
   * <span data-ttu-id="7c5b4-211">Username part of Alternate User Principal Name: joed</span><span class="sxs-lookup"><span data-stu-id="7c5b4-211">Username part of Alternate User Principal Name: joed</span></span>  
   * <span data-ttu-id="7c5b4-212">On-premises SAM account name: depending on-prem domain controller configuration</span><span class="sxs-lookup"><span data-stu-id="7c5b4-212">On-premises SAM account name: depending on-prem domain controller configuration</span></span>

   ![Delegated login identity drop-down menu screenshot](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/app_proxy_sso_diff_id_upn.png)  

### <a name="troubleshooting-sso-for-different-identities"></a><span data-ttu-id="7c5b4-214">Troubleshooting SSO for different identities</span><span class="sxs-lookup"><span data-stu-id="7c5b4-214">Troubleshooting SSO for different identities</span></span>
<span data-ttu-id="7c5b4-215">If there is an error in the SSO process, it appears in the Connector machine event log as explained in [Troubleshooting](active-directory-application-proxy-troubleshoot.md).</span><span class="sxs-lookup"><span data-stu-id="7c5b4-215">If there is an error in the SSO process, it appears in the Connector machine event log as explained in [Troubleshooting](active-directory-application-proxy-troubleshoot.md).</span></span>
<span data-ttu-id="7c5b4-216">But, in some cases, the request is successfully sent to the backend application while this application replies in various other HTTP responses.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-216">But, in some cases, the request is successfully sent to the backend application while this application replies in various other HTTP responses.</span></span> <span data-ttu-id="7c5b4-217">Troubleshooting these cases should start by examining event number 24029 on the Connector machine in the Application Proxy session event log.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-217">Troubleshooting these cases should start by examining event number 24029 on the Connector machine in the Application Proxy session event log.</span></span> <span data-ttu-id="7c5b4-218">The user identity that was used for delegation appears in the “user” field within the event details.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-218">The user identity that was used for delegation appears in the “user” field within the event details.</span></span> <span data-ttu-id="7c5b4-219">To turn on session log, select **Show analytic and debug logs** in the event viewer view menu.</span><span class="sxs-lookup"><span data-stu-id="7c5b4-219">To turn on session log, select **Show analytic and debug logs** in the event viewer view menu.</span></span>

## <a name="see-also"></a><span data-ttu-id="7c5b4-220">See also</span><span class="sxs-lookup"><span data-stu-id="7c5b4-220">See also</span></span>
* [<span data-ttu-id="7c5b4-221">Publish applications with Application Proxy</span><span class="sxs-lookup"><span data-stu-id="7c5b4-221">Publish applications with Application Proxy</span></span>](active-directory-application-proxy-publish.md)
* [<span data-ttu-id="7c5b4-222">Troubleshoot issues you're having with Application Proxy</span><span class="sxs-lookup"><span data-stu-id="7c5b4-222">Troubleshoot issues you're having with Application Proxy</span></span>](active-directory-application-proxy-troubleshoot.md)
* [<span data-ttu-id="7c5b4-223">Working with claims aware applications</span><span class="sxs-lookup"><span data-stu-id="7c5b4-223">Working with claims aware applications</span></span>](active-directory-application-proxy-claims-aware-apps.md)
* [<span data-ttu-id="7c5b4-224">Enable conditional access</span><span class="sxs-lookup"><span data-stu-id="7c5b4-224">Enable conditional access</span></span>](active-directory-application-proxy-conditional-access.md)

<span data-ttu-id="7c5b4-225">For the latest news and updates, check out the [Application Proxy blog](http://blogs.technet.com/b/applicationproxyblog/)</span><span class="sxs-lookup"><span data-stu-id="7c5b4-225">For the latest news and updates, check out the [Application Proxy blog](http://blogs.technet.com/b/applicationproxyblog/)</span></span>

<!--Image references-->
[1]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/AuthDiagram.png
[2]: https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-application-proxy-sso-using-kcd/Properties.jpg










