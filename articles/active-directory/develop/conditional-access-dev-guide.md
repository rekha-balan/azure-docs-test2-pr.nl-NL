---
title: Developer guidance for Azure Active Directory conditional access
description: Developer guidance and scenarios for Azure AD conditional access
services: active-directory
keywords: ''
author: CelesteDG
manager: mtillman
editor: PatAltimore
ms.author: celested
ms.reviewer: dadobali
ms.date: 07/19/2017
ms.service: active-directory
ms.component: develop
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.openlocfilehash: ab6936d62aac5502d70239bacfbfd15bd6b793ab
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44868803"
---
# <a name="developer-guidance-for-azure-active-directory-conditional-access"></a><span data-ttu-id="be2f5-103">Developer guidance for Azure Active Directory conditional access</span><span class="sxs-lookup"><span data-stu-id="be2f5-103">Developer guidance for Azure Active Directory conditional access</span></span>

<span data-ttu-id="be2f5-104">The conditional access feature in Azure Active Directory (Azure AD) offers one of several ways that you can use to secure your app and protect a service.</span><span class="sxs-lookup"><span data-stu-id="be2f5-104">The conditional access feature in Azure Active Directory (Azure AD) offers one of several ways that you can use to secure your app and protect a service.</span></span> <span data-ttu-id="be2f5-105">Conditional access enables developers and enterprise customers to protect services in a multitude of ways including:</span><span class="sxs-lookup"><span data-stu-id="be2f5-105">Conditional access enables developers and enterprise customers to protect services in a multitude of ways including:</span></span>

* <span data-ttu-id="be2f5-106">Multi-factor authentication</span><span class="sxs-lookup"><span data-stu-id="be2f5-106">Multi-factor authentication</span></span>
* <span data-ttu-id="be2f5-107">Allowing only Intune enrolled devices to access specific services</span><span class="sxs-lookup"><span data-stu-id="be2f5-107">Allowing only Intune enrolled devices to access specific services</span></span>
* <span data-ttu-id="be2f5-108">Restricting user locations and IP ranges</span><span class="sxs-lookup"><span data-stu-id="be2f5-108">Restricting user locations and IP ranges</span></span>

<span data-ttu-id="be2f5-109">For more information on the full capabilities of conditional access, see [Conditional access in Azure Active Directory](../active-directory-conditional-access-azure-portal.md).</span><span class="sxs-lookup"><span data-stu-id="be2f5-109">For more information on the full capabilities of conditional access, see [Conditional access in Azure Active Directory](../active-directory-conditional-access-azure-portal.md).</span></span> 

<span data-ttu-id="be2f5-110">For developers building apps for Azure AD, this article shows how you can use conditional access and you'll also learn about the impact of accessing resources that you don't have control over that may have conditional access policies applied.</span><span class="sxs-lookup"><span data-stu-id="be2f5-110">For developers building apps for Azure AD, this article shows how you can use conditional access and you'll also learn about the impact of accessing resources that you don't have control over that may have conditional access policies applied.</span></span> <span data-ttu-id="be2f5-111">The article also explores the implications of conditional access in the on-behalf-of flow, web apps, accessing Microsoft Graph, and calling APIs.</span><span class="sxs-lookup"><span data-stu-id="be2f5-111">The article also explores the implications of conditional access in the on-behalf-of flow, web apps, accessing Microsoft Graph, and calling APIs.</span></span>

<span data-ttu-id="be2f5-112">Knowledge of [single](quickstart-v1-integrate-apps-with-azure-ad.md) and [multi-tenant](howto-convert-app-to-be-multi-tenant.md) apps and [common authentication patterns](authentication-scenarios.md) is assumed.</span><span class="sxs-lookup"><span data-stu-id="be2f5-112">Knowledge of [single](quickstart-v1-integrate-apps-with-azure-ad.md) and [multi-tenant](howto-convert-app-to-be-multi-tenant.md) apps and [common authentication patterns](authentication-scenarios.md) is assumed.</span></span>

## <a name="how-does-conditional-access-impact-an-app"></a><span data-ttu-id="be2f5-113">How does conditional access impact an app?</span><span class="sxs-lookup"><span data-stu-id="be2f5-113">How does conditional access impact an app?</span></span>

### <a name="app-types-impacted"></a><span data-ttu-id="be2f5-114">App types impacted</span><span class="sxs-lookup"><span data-stu-id="be2f5-114">App types impacted</span></span>

<span data-ttu-id="be2f5-115">In most common cases, conditional access does not change an app's behavior or requires any changes from the developer.</span><span class="sxs-lookup"><span data-stu-id="be2f5-115">In most common cases, conditional access does not change an app's behavior or requires any changes from the developer.</span></span> <span data-ttu-id="be2f5-116">Only in certain cases when an app indirectly or silently requests a token for a service, an app requires code changes to handle conditional access "challenges".</span><span class="sxs-lookup"><span data-stu-id="be2f5-116">Only in certain cases when an app indirectly or silently requests a token for a service, an app requires code changes to handle conditional access "challenges".</span></span> <span data-ttu-id="be2f5-117">It may be as simple as performing an interactive sign-in request.</span><span class="sxs-lookup"><span data-stu-id="be2f5-117">It may be as simple as performing an interactive sign-in request.</span></span> 

<span data-ttu-id="be2f5-118">Specifically, the following scenarios require code to handle conditional access "challenges":</span><span class="sxs-lookup"><span data-stu-id="be2f5-118">Specifically, the following scenarios require code to handle conditional access "challenges":</span></span> 

* <span data-ttu-id="be2f5-119">Apps accessing Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="be2f5-119">Apps accessing Microsoft Graph</span></span>
* <span data-ttu-id="be2f5-120">Apps performing the on-behalf-of flow</span><span class="sxs-lookup"><span data-stu-id="be2f5-120">Apps performing the on-behalf-of flow</span></span>
* <span data-ttu-id="be2f5-121">Apps accessing multiple services/resources</span><span class="sxs-lookup"><span data-stu-id="be2f5-121">Apps accessing multiple services/resources</span></span>
* <span data-ttu-id="be2f5-122">Single page apps using ADAL.js</span><span class="sxs-lookup"><span data-stu-id="be2f5-122">Single page apps using ADAL.js</span></span>
* <span data-ttu-id="be2f5-123">Web Apps calling a resource</span><span class="sxs-lookup"><span data-stu-id="be2f5-123">Web Apps calling a resource</span></span>

<span data-ttu-id="be2f5-124">Conditional access policies can be applied to the app, but also can be applied to a web API your app accesses.</span><span class="sxs-lookup"><span data-stu-id="be2f5-124">Conditional access policies can be applied to the app, but also can be applied to a web API your app accesses.</span></span> <span data-ttu-id="be2f5-125">To learn more about how to configure a conditional access policy, see [Quickstart: Require MFA for specific apps with Azure Active Directory conditional access](../conditional-access/app-based-mfa.md).</span><span class="sxs-lookup"><span data-stu-id="be2f5-125">To learn more about how to configure a conditional access policy, see [Quickstart: Require MFA for specific apps with Azure Active Directory conditional access](../conditional-access/app-based-mfa.md).</span></span>

<span data-ttu-id="be2f5-126">Depending on the scenario, an enterprise customer can apply and remove conditional access policies at any time.</span><span class="sxs-lookup"><span data-stu-id="be2f5-126">Depending on the scenario, an enterprise customer can apply and remove conditional access policies at any time.</span></span> <span data-ttu-id="be2f5-127">In order for your app to continue functioning when a new policy is applied, you need to implement the "challenge" handling.</span><span class="sxs-lookup"><span data-stu-id="be2f5-127">In order for your app to continue functioning when a new policy is applied, you need to implement the "challenge" handling.</span></span> <span data-ttu-id="be2f5-128">The following examples illustrate challenge handling.</span><span class="sxs-lookup"><span data-stu-id="be2f5-128">The following examples illustrate challenge handling.</span></span> 

### <a name="conditional-access-examples"></a><span data-ttu-id="be2f5-129">Conditional access examples</span><span class="sxs-lookup"><span data-stu-id="be2f5-129">Conditional access examples</span></span>

<span data-ttu-id="be2f5-130">Some scenarios require code changes to handle conditional access whereas others work as is.</span><span class="sxs-lookup"><span data-stu-id="be2f5-130">Some scenarios require code changes to handle conditional access whereas others work as is.</span></span> <span data-ttu-id="be2f5-131">Here are a few scenarios using conditional access to do multi-factor authentication that gives some insight into the difference.</span><span class="sxs-lookup"><span data-stu-id="be2f5-131">Here are a few scenarios using conditional access to do multi-factor authentication that gives some insight into the difference.</span></span>

* <span data-ttu-id="be2f5-132">You are building a single-tenant iOS app and apply a conditional access policy.</span><span class="sxs-lookup"><span data-stu-id="be2f5-132">You are building a single-tenant iOS app and apply a conditional access policy.</span></span> <span data-ttu-id="be2f5-133">The app signs in a user and doesn't request access to an API.</span><span class="sxs-lookup"><span data-stu-id="be2f5-133">The app signs in a user and doesn't request access to an API.</span></span> <span data-ttu-id="be2f5-134">When the user signs in, the policy is automatically invoked and the user needs to perform multi-factor authentication (MFA).</span><span class="sxs-lookup"><span data-stu-id="be2f5-134">When the user signs in, the policy is automatically invoked and the user needs to perform multi-factor authentication (MFA).</span></span> 
* <span data-ttu-id="be2f5-135">You are building a multi-tenant web app that uses Microsoft Graph to access Exchange, among other services.</span><span class="sxs-lookup"><span data-stu-id="be2f5-135">You are building a multi-tenant web app that uses Microsoft Graph to access Exchange, among other services.</span></span> <span data-ttu-id="be2f5-136">An enterprise customer who adopts this app sets a policy on Exchange.</span><span class="sxs-lookup"><span data-stu-id="be2f5-136">An enterprise customer who adopts this app sets a policy on Exchange.</span></span> <span data-ttu-id="be2f5-137">When the web app requests a token for MS Graph, the app will not be challenged to comply with the policy.</span><span class="sxs-lookup"><span data-stu-id="be2f5-137">When the web app requests a token for MS Graph, the app will not be challenged to comply with the policy.</span></span> <span data-ttu-id="be2f5-138">The end user is signed in with valid tokens.</span><span class="sxs-lookup"><span data-stu-id="be2f5-138">The end user is signed in with valid tokens.</span></span> <span data-ttu-id="be2f5-139">When the app attempts to use this token against the Microsoft Graph to access Exchange data, a claims "challenge" is returned to the web app through the ```WWW-Authenticate``` header.</span><span class="sxs-lookup"><span data-stu-id="be2f5-139">When the app attempts to use this token against the Microsoft Graph to access Exchange data, a claims "challenge" is returned to the web app through the ```WWW-Authenticate``` header.</span></span> <span data-ttu-id="be2f5-140">The app can then use the ```claims``` in a new request, and the end user will be prompted to comply with the conditions.</span><span class="sxs-lookup"><span data-stu-id="be2f5-140">The app can then use the ```claims``` in a new request, and the end user will be prompted to comply with the conditions.</span></span> 
* <span data-ttu-id="be2f5-141">You are building a native app that uses a middle tier service to access a downstream API.</span><span class="sxs-lookup"><span data-stu-id="be2f5-141">You are building a native app that uses a middle tier service to access a downstream API.</span></span> <span data-ttu-id="be2f5-142">An enterprise customer at the company using this app applies a policy to the downstream API.</span><span class="sxs-lookup"><span data-stu-id="be2f5-142">An enterprise customer at the company using this app applies a policy to the downstream API.</span></span> <span data-ttu-id="be2f5-143">When an end user signs in, the native app requests access to the middle tier and sends the token.</span><span class="sxs-lookup"><span data-stu-id="be2f5-143">When an end user signs in, the native app requests access to the middle tier and sends the token.</span></span> <span data-ttu-id="be2f5-144">The middle tier performs on-behalf-of flow to request access to the downstream API.</span><span class="sxs-lookup"><span data-stu-id="be2f5-144">The middle tier performs on-behalf-of flow to request access to the downstream API.</span></span> <span data-ttu-id="be2f5-145">At this point, a claims "challenge" is presented to the middle tier.</span><span class="sxs-lookup"><span data-stu-id="be2f5-145">At this point, a claims "challenge" is presented to the middle tier.</span></span> <span data-ttu-id="be2f5-146">The middle tier sends the challenge back to the native app, which needs to comply with the conditional access policy.</span><span class="sxs-lookup"><span data-stu-id="be2f5-146">The middle tier sends the challenge back to the native app, which needs to comply with the conditional access policy.</span></span>

### <a name="complying-with-a-conditional-access-policy"></a><span data-ttu-id="be2f5-147">Complying with a conditional access policy</span><span class="sxs-lookup"><span data-stu-id="be2f5-147">Complying with a conditional access policy</span></span>

<span data-ttu-id="be2f5-148">For several different app topologies, a conditional access policy is evaluated when the session is established.</span><span class="sxs-lookup"><span data-stu-id="be2f5-148">For several different app topologies, a conditional access policy is evaluated when the session is established.</span></span> <span data-ttu-id="be2f5-149">As a conditional access policy operates on the granularity of apps and services, the point at which it is invoked depends heavily on the scenario you're trying to accomplish.</span><span class="sxs-lookup"><span data-stu-id="be2f5-149">As a conditional access policy operates on the granularity of apps and services, the point at which it is invoked depends heavily on the scenario you're trying to accomplish.</span></span>

<span data-ttu-id="be2f5-150">When your app attempts to access a service with a conditional access policy, it may encounter a conditional access challenge.</span><span class="sxs-lookup"><span data-stu-id="be2f5-150">When your app attempts to access a service with a conditional access policy, it may encounter a conditional access challenge.</span></span> <span data-ttu-id="be2f5-151">This challenge is encoded in the `claims` parameter that comes in a response from Azure AD or Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="be2f5-151">This challenge is encoded in the `claims` parameter that comes in a response from Azure AD or Microsoft Graph.</span></span> <span data-ttu-id="be2f5-152">Here's an example of this challenge parameter:</span><span class="sxs-lookup"><span data-stu-id="be2f5-152">Here's an example of this challenge parameter:</span></span> 

```
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

<span data-ttu-id="be2f5-153">Developers can take this challenge and append it onto a new request to Azure AD.</span><span class="sxs-lookup"><span data-stu-id="be2f5-153">Developers can take this challenge and append it onto a new request to Azure AD.</span></span> <span data-ttu-id="be2f5-154">Passing this state prompts the end user to perform any action necessary to comply with the conditional access policy.</span><span class="sxs-lookup"><span data-stu-id="be2f5-154">Passing this state prompts the end user to perform any action necessary to comply with the conditional access policy.</span></span> <span data-ttu-id="be2f5-155">In the following scenarios, specifics of the error and how to extract the parameter are explained.</span><span class="sxs-lookup"><span data-stu-id="be2f5-155">In the following scenarios, specifics of the error and how to extract the parameter are explained.</span></span> 

## <a name="scenarios"></a><span data-ttu-id="be2f5-156">Scenarios</span><span class="sxs-lookup"><span data-stu-id="be2f5-156">Scenarios</span></span>

### <a name="prerequisites"></a><span data-ttu-id="be2f5-157">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="be2f5-157">Prerequisites</span></span>

<span data-ttu-id="be2f5-158">Azure AD conditional access is a feature included in [Azure AD Premium](https://docs.microsoft.com/azure/active-directory/active-directory-whatis#choose-an-edition).</span><span class="sxs-lookup"><span data-stu-id="be2f5-158">Azure AD conditional access is a feature included in [Azure AD Premium](https://docs.microsoft.com/azure/active-directory/active-directory-whatis#choose-an-edition).</span></span> <span data-ttu-id="be2f5-159">You can learn more about licensing requirements in the [unlicensed usage report](../active-directory-conditional-access-unlicensed-usage-report.md).</span><span class="sxs-lookup"><span data-stu-id="be2f5-159">You can learn more about licensing requirements in the [unlicensed usage report](../active-directory-conditional-access-unlicensed-usage-report.md).</span></span> <span data-ttu-id="be2f5-160">Developers can join the [Microsoft Developer Network](https://msdn.microsoft.com/dn308572.aspx), which includes a free subscription to the Enterprise Mobility Suite, which includes Azure AD Premium.</span><span class="sxs-lookup"><span data-stu-id="be2f5-160">Developers can join the [Microsoft Developer Network](https://msdn.microsoft.com/dn308572.aspx), which includes a free subscription to the Enterprise Mobility Suite, which includes Azure AD Premium.</span></span>

### <a name="considerations-for-specific-scenarios"></a><span data-ttu-id="be2f5-161">Considerations for specific scenarios</span><span class="sxs-lookup"><span data-stu-id="be2f5-161">Considerations for specific scenarios</span></span>

<span data-ttu-id="be2f5-162">The following information only applies in these conditional access scenarios:</span><span class="sxs-lookup"><span data-stu-id="be2f5-162">The following information only applies in these conditional access scenarios:</span></span>

* <span data-ttu-id="be2f5-163">Apps accessing Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="be2f5-163">Apps accessing Microsoft Graph</span></span>
* <span data-ttu-id="be2f5-164">Apps performing the on-behalf-of flow</span><span class="sxs-lookup"><span data-stu-id="be2f5-164">Apps performing the on-behalf-of flow</span></span>
* <span data-ttu-id="be2f5-165">Apps accessing multiple services/resources</span><span class="sxs-lookup"><span data-stu-id="be2f5-165">Apps accessing multiple services/resources</span></span>
* <span data-ttu-id="be2f5-166">Single page apps using ADAL.js</span><span class="sxs-lookup"><span data-stu-id="be2f5-166">Single page apps using ADAL.js</span></span>

<span data-ttu-id="be2f5-167">The following sections discuss common scenarios that are more complex.</span><span class="sxs-lookup"><span data-stu-id="be2f5-167">The following sections discuss common scenarios that are more complex.</span></span> <span data-ttu-id="be2f5-168">The core operating principle is conditional access policies are evaluated at the time the token is requested for the service that has a conditional access policy applied unless it's being accessed through Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="be2f5-168">The core operating principle is conditional access policies are evaluated at the time the token is requested for the service that has a conditional access policy applied unless it's being accessed through Microsoft Graph.</span></span>

## <a name="scenario-app-accessing-microsoft-graph"></a><span data-ttu-id="be2f5-169">Scenario: App accessing Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="be2f5-169">Scenario: App accessing Microsoft Graph</span></span>

<span data-ttu-id="be2f5-170">In this scenario, learn how a web app requests access to Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="be2f5-170">In this scenario, learn how a web app requests access to Microsoft Graph.</span></span> <span data-ttu-id="be2f5-171">The conditional access policy in this case could be assigned to SharePoint, Exchange, or some other service that is accessed as a workload through Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="be2f5-171">The conditional access policy in this case could be assigned to SharePoint, Exchange, or some other service that is accessed as a workload through Microsoft Graph.</span></span> <span data-ttu-id="be2f5-172">In this example, let's assume there's a conditional access policy on Sharepoint Online.</span><span class="sxs-lookup"><span data-stu-id="be2f5-172">In this example, let's assume there's a conditional access policy on Sharepoint Online.</span></span>

![App accessing Microsoft Graph flow diagram](./media/conditional-access-dev-guide/app-accessing-microsoft-graph-scenario.png)

<span data-ttu-id="be2f5-174">The app first requests authorization to Microsoft Graph which requires accessing a downstream workload without conditional access.</span><span class="sxs-lookup"><span data-stu-id="be2f5-174">The app first requests authorization to Microsoft Graph which requires accessing a downstream workload without conditional access.</span></span> <span data-ttu-id="be2f5-175">The request succeeds without invoking any policy and the app receives tokens for Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="be2f5-175">The request succeeds without invoking any policy and the app receives tokens for Microsoft Graph.</span></span> <span data-ttu-id="be2f5-176">At this point, the app may use the access token in a bearer request for the endpoint requested.</span><span class="sxs-lookup"><span data-stu-id="be2f5-176">At this point, the app may use the access token in a bearer request for the endpoint requested.</span></span> <span data-ttu-id="be2f5-177">Now, the app needs to access a Sharepoint Online endpoint of Microsoft Graph, for example: `https://graph.microsoft.com/v1.0/me/mySite`</span><span class="sxs-lookup"><span data-stu-id="be2f5-177">Now, the app needs to access a Sharepoint Online endpoint of Microsoft Graph, for example: `https://graph.microsoft.com/v1.0/me/mySite`</span></span>

<span data-ttu-id="be2f5-178">The app already has a valid token for Microsoft Graph, so it can perform the new request without being issued a new token.</span><span class="sxs-lookup"><span data-stu-id="be2f5-178">The app already has a valid token for Microsoft Graph, so it can perform the new request without being issued a new token.</span></span> <span data-ttu-id="be2f5-179">This request fails and a claims challenge is issued from Microsoft Graph in the form of an HTTP 403 Forbidden with a ```WWW-Authenticate``` challenge.</span><span class="sxs-lookup"><span data-stu-id="be2f5-179">This request fails and a claims challenge is issued from Microsoft Graph in the form of an HTTP 403 Forbidden with a ```WWW-Authenticate``` challenge.</span></span>

<span data-ttu-id="be2f5-180">Here's an example of the response:</span><span class="sxs-lookup"><span data-stu-id="be2f5-180">Here's an example of the response:</span></span> 

```
HTTP 403; Forbidden 
error=insufficient_claims
www-authenticate="Bearer realm="", authorization_uri="https://login.windows.net/common/oauth2/authorize", client_id="<GUID>", error=insufficient_claims, claims={"access_token":{"polids":{"essential":true,"values":["<GUID>"]}}}"
```

<span data-ttu-id="be2f5-181">The claims challenge is inside the ```WWW-Authenticate``` header, which can be parsed to extract the claims parameter for the next request.</span><span class="sxs-lookup"><span data-stu-id="be2f5-181">The claims challenge is inside the ```WWW-Authenticate``` header, which can be parsed to extract the claims parameter for the next request.</span></span> <span data-ttu-id="be2f5-182">Once it's appended to the new request, Azure AD knows to evaluate the conditional access policy when signing in the user and the app is now in compliance with the conditional access policy.</span><span class="sxs-lookup"><span data-stu-id="be2f5-182">Once it's appended to the new request, Azure AD knows to evaluate the conditional access policy when signing in the user and the app is now in compliance with the conditional access policy.</span></span> <span data-ttu-id="be2f5-183">Repeating the request to the Sharepoint Online endpoint succeeds.</span><span class="sxs-lookup"><span data-stu-id="be2f5-183">Repeating the request to the Sharepoint Online endpoint succeeds.</span></span>

<span data-ttu-id="be2f5-184">The ```WWW-Authenticate``` header does have a unique structure and is not trivial to parse in order to extract values.</span><span class="sxs-lookup"><span data-stu-id="be2f5-184">The ```WWW-Authenticate``` header does have a unique structure and is not trivial to parse in order to extract values.</span></span> <span data-ttu-id="be2f5-185">Here's a short method to help.</span><span class="sxs-lookup"><span data-stu-id="be2f5-185">Here's a short method to help.</span></span>

```csharp
        /// <summary>
        /// This method extracts the claims value from the 403 error response from MS Graph. 
        /// </summary>
        /// <param name="wwwAuthHeader"></param>
        /// <returns>Value of the claims entry. This should be considered an opaque string. 
        /// Returns null if the wwwAuthheader does not contain the claims value. </returns>
        private String extractClaims(String wwwAuthHeader)
        {
            String ClaimsKey = "claims=";
            String ClaimsSubstring = "";
            if (wwwAuthHeader.Contains(ClaimsKey))
            {
                int Index = wwwAuthHeader.IndexOf(ClaimsKey);
                ClaimsSubstring = wwwAuthHeader.Substring(Index, wwwAuthHeader.Length - Index);
                string ClaimsChallenge;
                if (Regex.Match(ClaimsSubstring, @"}$").Success)
                {
                    ClaimsChallenge = ClaimsSubstring.Split('=')[1];
                }
                else
                {
                    ClaimsChallenge = ClaimsSubstring.Substring(0, ClaimsSubstring.IndexOf("},") + 1);
                }
                return ClaimsChallenge;
            }
            return null; 
        }
```

<span data-ttu-id="be2f5-186">For code samples that demonstrate how to handle the claims challenge, refer to the [On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca) for ADAL .NET.</span><span class="sxs-lookup"><span data-stu-id="be2f5-186">For code samples that demonstrate how to handle the claims challenge, refer to the [On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca) for ADAL .NET.</span></span>

## <a name="scenario-app-performing-the-on-behalf-of-flow"></a><span data-ttu-id="be2f5-187">Scenario: App performing the on-behalf-of flow</span><span class="sxs-lookup"><span data-stu-id="be2f5-187">Scenario: App performing the on-behalf-of flow</span></span>

<span data-ttu-id="be2f5-188">In this scenario, we walk through the case in which a native app calls a web service/API.</span><span class="sxs-lookup"><span data-stu-id="be2f5-188">In this scenario, we walk through the case in which a native app calls a web service/API.</span></span> <span data-ttu-id="be2f5-189">In turn, this service does [the "on-behalf-of" flow](authentication-scenarios.md#application-types-and-scenarios) to call a downstream service.</span><span class="sxs-lookup"><span data-stu-id="be2f5-189">In turn, this service does [the "on-behalf-of" flow](authentication-scenarios.md#application-types-and-scenarios) to call a downstream service.</span></span> <span data-ttu-id="be2f5-190">In our case, we've applied our conditional access policy to the downstream service (Web API 2) and are using a native app rather than a server/daemon app.</span><span class="sxs-lookup"><span data-stu-id="be2f5-190">In our case, we've applied our conditional access policy to the downstream service (Web API 2) and are using a native app rather than a server/daemon app.</span></span> 

![App performing the on-behalf-of flow diagram](./media/conditional-access-dev-guide/app-performing-on-behalf-of-scenario.png)

<span data-ttu-id="be2f5-192">The initial token request for Web API 1 does not prompt the end user for multi-factor authentication as Web API 1 may not always hit the downstream API.</span><span class="sxs-lookup"><span data-stu-id="be2f5-192">The initial token request for Web API 1 does not prompt the end user for multi-factor authentication as Web API 1 may not always hit the downstream API.</span></span> <span data-ttu-id="be2f5-193">Once Web API 1 tries to request a token on-behalf-of the user for Web API 2, the request fails since the user has not signed in with multi-factor authentication.</span><span class="sxs-lookup"><span data-stu-id="be2f5-193">Once Web API 1 tries to request a token on-behalf-of the user for Web API 2, the request fails since the user has not signed in with multi-factor authentication.</span></span>

<span data-ttu-id="be2f5-194">Azure AD returns an HTTP response with some interesting data:</span><span class="sxs-lookup"><span data-stu-id="be2f5-194">Azure AD returns an HTTP response with some interesting data:</span></span> 

> [!NOTE]
> <span data-ttu-id="be2f5-195">In this instance it's a multi-factor authentication error description, but there's a wide range of `interaction_required` possible pertaining to conditional access.</span><span class="sxs-lookup"><span data-stu-id="be2f5-195">In this instance it's a multi-factor authentication error description, but there's a wide range of `interaction_required` possible pertaining to conditional access.</span></span> 

```
HTTP 400; Bad Request 
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API 2 App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

<span data-ttu-id="be2f5-196">In Web API 1, we catch the error `error=interaction_required`, and send back the `claims` challenge to the desktop app.</span><span class="sxs-lookup"><span data-stu-id="be2f5-196">In Web API 1, we catch the error `error=interaction_required`, and send back the `claims` challenge to the desktop app.</span></span> <span data-ttu-id="be2f5-197">At that point, the desktop app can make a new `acquireToken()` call and append the `claims`challenge as an extra query string parameter.</span><span class="sxs-lookup"><span data-stu-id="be2f5-197">At that point, the desktop app can make a new `acquireToken()` call and append the `claims`challenge as an extra query string parameter.</span></span> <span data-ttu-id="be2f5-198">This new request requires the user to do multi-factor authentication and then send this new token back to Web API 1 and complete the on-behalf-of flow.</span><span class="sxs-lookup"><span data-stu-id="be2f5-198">This new request requires the user to do multi-factor authentication and then send this new token back to Web API 1 and complete the on-behalf-of flow.</span></span>

<span data-ttu-id="be2f5-199">To try out this scenario, see our [.NET code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span><span class="sxs-lookup"><span data-stu-id="be2f5-199">To try out this scenario, see our [.NET code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span></span> <span data-ttu-id="be2f5-200">It demonstrates how to pass the claims challenge back from Web API 1 to the native app and construct a new request inside the client app.</span><span class="sxs-lookup"><span data-stu-id="be2f5-200">It demonstrates how to pass the claims challenge back from Web API 1 to the native app and construct a new request inside the client app.</span></span> 

## <a name="scenario-app-accessing-multiple-services"></a><span data-ttu-id="be2f5-201">Scenario: App accessing multiple services</span><span class="sxs-lookup"><span data-stu-id="be2f5-201">Scenario: App accessing multiple services</span></span>

<span data-ttu-id="be2f5-202">In this scenario, we walk through the case in which a web app accesses two services one of which has a conditional access policy assigned.</span><span class="sxs-lookup"><span data-stu-id="be2f5-202">In this scenario, we walk through the case in which a web app accesses two services one of which has a conditional access policy assigned.</span></span> <span data-ttu-id="be2f5-203">Depending on your app logic, there may exist a path in which your app does not require access to both web services.</span><span class="sxs-lookup"><span data-stu-id="be2f5-203">Depending on your app logic, there may exist a path in which your app does not require access to both web services.</span></span> <span data-ttu-id="be2f5-204">In this scenario, the order in which you request a token plays an important role in the end user experience.</span><span class="sxs-lookup"><span data-stu-id="be2f5-204">In this scenario, the order in which you request a token plays an important role in the end user experience.</span></span>

<span data-ttu-id="be2f5-205">Let's assume we have web service A and B and web service B has our conditional access policy applied.</span><span class="sxs-lookup"><span data-stu-id="be2f5-205">Let's assume we have web service A and B and web service B has our conditional access policy applied.</span></span> <span data-ttu-id="be2f5-206">While the initial interactive auth request requires consent for both services, the conditional access policy is not required in all cases.</span><span class="sxs-lookup"><span data-stu-id="be2f5-206">While the initial interactive auth request requires consent for both services, the conditional access policy is not required in all cases.</span></span> <span data-ttu-id="be2f5-207">If the app requests a token for web service B, then the policy is invoked and subsequent requests for web service A also succeeds as follows.</span><span class="sxs-lookup"><span data-stu-id="be2f5-207">If the app requests a token for web service B, then the policy is invoked and subsequent requests for web service A also succeeds as follows.</span></span>

![App accessing multiple-services flow diagram](./media/conditional-access-dev-guide/app-accessing-multiple-services-scenario.png)

<span data-ttu-id="be2f5-209">Alternatively, if the app initially requests a token for web service A, the end user does not invoke the conditional access policy.</span><span class="sxs-lookup"><span data-stu-id="be2f5-209">Alternatively, if the app initially requests a token for web service A, the end user does not invoke the conditional access policy.</span></span> <span data-ttu-id="be2f5-210">This allows the app developer to control the end user experience and not force the conditional access policy to be invoked in all cases.</span><span class="sxs-lookup"><span data-stu-id="be2f5-210">This allows the app developer to control the end user experience and not force the conditional access policy to be invoked in all cases.</span></span> <span data-ttu-id="be2f5-211">The tricky case is if the app subsequently requests a token for web service B. At this point, the end user needs to comply with the conditional access policy.</span><span class="sxs-lookup"><span data-stu-id="be2f5-211">The tricky case is if the app subsequently requests a token for web service B. At this point, the end user needs to comply with the conditional access policy.</span></span> <span data-ttu-id="be2f5-212">When the app tries to `acquireToken`, it may generate the following error (illustrated in the following diagram):</span><span class="sxs-lookup"><span data-stu-id="be2f5-212">When the app tries to `acquireToken`, it may generate the following error (illustrated in the following diagram):</span></span> 

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
``` 

![App accessing multiple services requesting a new token](./media/conditional-access-dev-guide/app-accessing-multiple-services-new-token.png)

<span data-ttu-id="be2f5-214">If the app is using the ADAL library, a failure to acquire the token is always retried interactively.</span><span class="sxs-lookup"><span data-stu-id="be2f5-214">If the app is using the ADAL library, a failure to acquire the token is always retried interactively.</span></span> <span data-ttu-id="be2f5-215">When this interactive request occurs, the end user has the opportunity to comply with the conditional access.</span><span class="sxs-lookup"><span data-stu-id="be2f5-215">When this interactive request occurs, the end user has the opportunity to comply with the conditional access.</span></span> <span data-ttu-id="be2f5-216">This is true unless the request is a `AcquireTokenSilentAsync` or `PromptBehavior.Never` in which case the app needs to perform an interactive ```AcquireToken``` request to give the end use the opportunity to comply with the policy.</span><span class="sxs-lookup"><span data-stu-id="be2f5-216">This is true unless the request is a `AcquireTokenSilentAsync` or `PromptBehavior.Never` in which case the app needs to perform an interactive ```AcquireToken``` request to give the end use the opportunity to comply with the policy.</span></span> 

## <a name="scenario-single-page-app-spa-using-adaljs"></a><span data-ttu-id="be2f5-217">Scenario: Single Page App (SPA) using ADAL.js</span><span class="sxs-lookup"><span data-stu-id="be2f5-217">Scenario: Single Page App (SPA) using ADAL.js</span></span>

<span data-ttu-id="be2f5-218">In this scenario, we walk through the case when we have a single page app (SPA), using ADAL.js to call a conditional access protected web API.</span><span class="sxs-lookup"><span data-stu-id="be2f5-218">In this scenario, we walk through the case when we have a single page app (SPA), using ADAL.js to call a conditional access protected web API.</span></span> <span data-ttu-id="be2f5-219">This is a simple architecture but has some nuances that need to be taken into account when developing around conditional access.</span><span class="sxs-lookup"><span data-stu-id="be2f5-219">This is a simple architecture but has some nuances that need to be taken into account when developing around conditional access.</span></span>

<span data-ttu-id="be2f5-220">In ADAL.js, there are a few functions that obtain tokens: `login()`, `acquireToken(...)`, `acquireTokenPopup(…)`, and `acquireTokenRedirect(…)`.</span><span class="sxs-lookup"><span data-stu-id="be2f5-220">In ADAL.js, there are a few functions that obtain tokens: `login()`, `acquireToken(...)`, `acquireTokenPopup(…)`, and `acquireTokenRedirect(…)`.</span></span> 

* <span data-ttu-id="be2f5-221">`login()` obtains an ID token through an interactive sign-in request but does not obtain access tokens for any service (including a conditional access protected web API).</span><span class="sxs-lookup"><span data-stu-id="be2f5-221">`login()` obtains an ID token through an interactive sign-in request but does not obtain access tokens for any service (including a conditional access protected web API).</span></span> 
* <span data-ttu-id="be2f5-222">`acquireToken(…)` can then be used to silently obtain an access token meaning it does not show UI in any circumstance.</span><span class="sxs-lookup"><span data-stu-id="be2f5-222">`acquireToken(…)` can then be used to silently obtain an access token meaning it does not show UI in any circumstance.</span></span> 
* <span data-ttu-id="be2f5-223">`acquireTokenPopup(…)` and `acquireTokenRedirect(…)` are both used to interactively request a token for a resource meaning they always show sign-in UI.</span><span class="sxs-lookup"><span data-stu-id="be2f5-223">`acquireTokenPopup(…)` and `acquireTokenRedirect(…)` are both used to interactively request a token for a resource meaning they always show sign-in UI.</span></span>

<span data-ttu-id="be2f5-224">When an app needs an access token to call a Web API, it attempts an `acquireToken(…)`.</span><span class="sxs-lookup"><span data-stu-id="be2f5-224">When an app needs an access token to call a Web API, it attempts an `acquireToken(…)`.</span></span> <span data-ttu-id="be2f5-225">If the token session is expired or we need to comply with a conditional access policy, then the *acquireToken* function fails and the app uses `acquireTokenPopup()` or `acquireTokenRedirect()`.</span><span class="sxs-lookup"><span data-stu-id="be2f5-225">If the token session is expired or we need to comply with a conditional access policy, then the *acquireToken* function fails and the app uses `acquireTokenPopup()` or `acquireTokenRedirect()`.</span></span>

![Single page app using ADAL flow diagram](./media/conditional-access-dev-guide/spa-using-adal-scenario.png)

<span data-ttu-id="be2f5-227">Let's walk through an example with our conditional access scenario.</span><span class="sxs-lookup"><span data-stu-id="be2f5-227">Let's walk through an example with our conditional access scenario.</span></span> <span data-ttu-id="be2f5-228">The end user just landed on the site and doesn’t have a session.</span><span class="sxs-lookup"><span data-stu-id="be2f5-228">The end user just landed on the site and doesn’t have a session.</span></span> <span data-ttu-id="be2f5-229">We perform a `login()` call, get an ID token without multi-factor authentication.</span><span class="sxs-lookup"><span data-stu-id="be2f5-229">We perform a `login()` call, get an ID token without multi-factor authentication.</span></span> <span data-ttu-id="be2f5-230">Then the user hits a button that requires the app to request data from a web API.</span><span class="sxs-lookup"><span data-stu-id="be2f5-230">Then the user hits a button that requires the app to request data from a web API.</span></span> <span data-ttu-id="be2f5-231">The app tries to do an `acquireToken()` call but fails since the user has not performed multi-factor authentication yet and needs to comply with the conditional access policy.</span><span class="sxs-lookup"><span data-stu-id="be2f5-231">The app tries to do an `acquireToken()` call but fails since the user has not performed multi-factor authentication yet and needs to comply with the conditional access policy.</span></span>

<span data-ttu-id="be2f5-232">Azure AD sends back the following HTTP response:</span><span class="sxs-lookup"><span data-stu-id="be2f5-232">Azure AD sends back the following HTTP response:</span></span> 

```
HTTP 400; Bad Request 
error=interaction_required
error_description=AADSTS50076: Due to a configuration change made by your administrator, or because you moved to a new location, you must use multi-factor authentication to access '<Web API App/Client ID>'.
```

<span data-ttu-id="be2f5-233">Our app needs to catch the `error=interaction_required`.</span><span class="sxs-lookup"><span data-stu-id="be2f5-233">Our app needs to catch the `error=interaction_required`.</span></span> <span data-ttu-id="be2f5-234">The application can then use either `acquireTokenPopup()` or `acquireTokenRedirect()` on the same resource.</span><span class="sxs-lookup"><span data-stu-id="be2f5-234">The application can then use either `acquireTokenPopup()` or `acquireTokenRedirect()` on the same resource.</span></span> <span data-ttu-id="be2f5-235">The user is forced to do a multi-factor authentication.</span><span class="sxs-lookup"><span data-stu-id="be2f5-235">The user is forced to do a multi-factor authentication.</span></span> <span data-ttu-id="be2f5-236">After the user completes the multi-factor authentication, the app is issued a fresh access token for the requested resource.</span><span class="sxs-lookup"><span data-stu-id="be2f5-236">After the user completes the multi-factor authentication, the app is issued a fresh access token for the requested resource.</span></span>

<span data-ttu-id="be2f5-237">To try out this scenario, see our [JS SPA On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span><span class="sxs-lookup"><span data-stu-id="be2f5-237">To try out this scenario, see our [JS SPA On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span></span> <span data-ttu-id="be2f5-238">This code sample uses the conditional access policy and web API you registered earlier with a JS SPA to demonstrate this scenario.</span><span class="sxs-lookup"><span data-stu-id="be2f5-238">This code sample uses the conditional access policy and web API you registered earlier with a JS SPA to demonstrate this scenario.</span></span> <span data-ttu-id="be2f5-239">It shows how to properly handle the claims challenge and get an access token that can be used for your Web API.</span><span class="sxs-lookup"><span data-stu-id="be2f5-239">It shows how to properly handle the claims challenge and get an access token that can be used for your Web API.</span></span> <span data-ttu-id="be2f5-240">Alternatively, checkout the general [Angular.js code sample](https://github.com/Azure-Samples/active-directory-angularjs-singlepageapp) for guidance on an Angular SPA</span><span class="sxs-lookup"><span data-stu-id="be2f5-240">Alternatively, checkout the general [Angular.js code sample](https://github.com/Azure-Samples/active-directory-angularjs-singlepageapp) for guidance on an Angular SPA</span></span>


## <a name="see-also"></a><span data-ttu-id="be2f5-241">See also</span><span class="sxs-lookup"><span data-stu-id="be2f5-241">See also</span></span>

* <span data-ttu-id="be2f5-242">To learn more about the capabilities, see [Conditional Access in Azure Active Directory](../active-directory-conditional-access-azure-portal.md).</span><span class="sxs-lookup"><span data-stu-id="be2f5-242">To learn more about the capabilities, see [Conditional Access in Azure Active Directory](../active-directory-conditional-access-azure-portal.md).</span></span>
* <span data-ttu-id="be2f5-243">For more Azure AD code samples, see [Github repo of code samples](https://github.com/azure-samples?utf8=%E2%9C%93&q=active-directory).</span><span class="sxs-lookup"><span data-stu-id="be2f5-243">For more Azure AD code samples, see [Github repo of code samples](https://github.com/azure-samples?utf8=%E2%9C%93&q=active-directory).</span></span> 
* <span data-ttu-id="be2f5-244">For more info on the ADAL SDK's and access the reference documentation, see [library guide](active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="be2f5-244">For more info on the ADAL SDK's and access the reference documentation, see [library guide](active-directory-authentication-libraries.md).</span></span>
* <span data-ttu-id="be2f5-245">To learn more about multi-tenant scenarios, see [How to sign in users using the multi-tenant pattern](howto-convert-app-to-be-multi-tenant.md).</span><span class="sxs-lookup"><span data-stu-id="be2f5-245">To learn more about multi-tenant scenarios, see [How to sign in users using the multi-tenant pattern](howto-convert-app-to-be-multi-tenant.md).</span></span>
