---
title: Configure Azure MFA Server for high availability | Microsoft Docs
description: Deploy multiple instances of Azure Multi-Factor Authentication Server in configurations that provide high availability.
services: multi-factor-authentication
ms.service: active-directory
ms.component: authentication
ms.topic: conceptual
ms.date: 07/11/2018
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.reviewer: michmcla
ms.openlocfilehash: 5d3833d3218a4b6252c9591bb67686ddc1c3cdf9
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44865373"
---
# <a name="configure-azure-multi-factor-authentication-server-for-high-availability"></a><span data-ttu-id="b1837-103">Configure Azure Multi-Factor Authentication Server for high availability</span><span class="sxs-lookup"><span data-stu-id="b1837-103">Configure Azure Multi-Factor Authentication Server for high availability</span></span>

<span data-ttu-id="b1837-104">To achieve high-availability with your Azure Server MFA deployment, you need to deploy multiple MFA servers.</span><span class="sxs-lookup"><span data-stu-id="b1837-104">To achieve high-availability with your Azure Server MFA deployment, you need to deploy multiple MFA servers.</span></span> <span data-ttu-id="b1837-105">This section provides information on a load-balanced design to achieve your high availability targets in you Azure MFS Server deployment.</span><span class="sxs-lookup"><span data-stu-id="b1837-105">This section provides information on a load-balanced design to achieve your high availability targets in you Azure MFS Server deployment.</span></span>

## <a name="mfa-server-overview"></a><span data-ttu-id="b1837-106">MFA Server overview</span><span class="sxs-lookup"><span data-stu-id="b1837-106">MFA Server overview</span></span>

<span data-ttu-id="b1837-107">The Azure MFA Server service architecture comprises several components as shown in the following diagram:</span><span class="sxs-lookup"><span data-stu-id="b1837-107">The Azure MFA Server service architecture comprises several components as shown in the following diagram:</span></span>

 ![MFA Server Architecture](./media/howto-mfaserver-deploy-ha/mfa-ha-architecture.png)

<span data-ttu-id="b1837-109">An MFA Server is a Windows Server that has the Azure Multi-Factor Authentication software installed.</span><span class="sxs-lookup"><span data-stu-id="b1837-109">An MFA Server is a Windows Server that has the Azure Multi-Factor Authentication software installed.</span></span> <span data-ttu-id="b1837-110">The MFA Server instance must be activated by the MFA Service in Azure to function.</span><span class="sxs-lookup"><span data-stu-id="b1837-110">The MFA Server instance must be activated by the MFA Service in Azure to function.</span></span> <span data-ttu-id="b1837-111">More than one MFA Server can be installed on-premises.</span><span class="sxs-lookup"><span data-stu-id="b1837-111">More than one MFA Server can be installed on-premises.</span></span>

<span data-ttu-id="b1837-112">The first MFA Server that is installed is the master MFA Server upon activation by the Azure MFA Service by default.</span><span class="sxs-lookup"><span data-stu-id="b1837-112">The first MFA Server that is installed is the master MFA Server upon activation by the Azure MFA Service by default.</span></span> <span data-ttu-id="b1837-113">The master MFA server has a writeable copy of the PhoneFactor.pfdata database.</span><span class="sxs-lookup"><span data-stu-id="b1837-113">The master MFA server has a writeable copy of the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="b1837-114">Subsequent installations of instances of MFA Server are known as subordinates.</span><span class="sxs-lookup"><span data-stu-id="b1837-114">Subsequent installations of instances of MFA Server are known as subordinates.</span></span> <span data-ttu-id="b1837-115">The MFA subordinates have a replicated read-only copy of the PhoneFactor.pfdata database.</span><span class="sxs-lookup"><span data-stu-id="b1837-115">The MFA subordinates have a replicated read-only copy of the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="b1837-116">MFA servers replicate information using Remote Procedure Call (RPC).</span><span class="sxs-lookup"><span data-stu-id="b1837-116">MFA servers replicate information using Remote Procedure Call (RPC).</span></span> <span data-ttu-id="b1837-117">All MFA Severs must collectively either be domain joined or standalone to replicate information.</span><span class="sxs-lookup"><span data-stu-id="b1837-117">All MFA Severs must collectively either be domain joined or standalone to replicate information.</span></span>

<span data-ttu-id="b1837-118">Both MFA master and subordinate MFA Servers communicate with the MFA Service when two-factor authentication is required.</span><span class="sxs-lookup"><span data-stu-id="b1837-118">Both MFA master and subordinate MFA Servers communicate with the MFA Service when two-factor authentication is required.</span></span> <span data-ttu-id="b1837-119">For example, when a user attempts to gain access to an application that requires two-factor authentication, the user will first be authenticated by an identity provider, such as Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="b1837-119">For example, when a user attempts to gain access to an application that requires two-factor authentication, the user will first be authenticated by an identity provider, such as Active Directory (AD).</span></span>

<span data-ttu-id="b1837-120">After successful authentication with AD, the MFA Server will communicate with the MFA Service.</span><span class="sxs-lookup"><span data-stu-id="b1837-120">After successful authentication with AD, the MFA Server will communicate with the MFA Service.</span></span> <span data-ttu-id="b1837-121">The MFA Server waits for notification from the MFA Service to allow or deny the user access to the application.</span><span class="sxs-lookup"><span data-stu-id="b1837-121">The MFA Server waits for notification from the MFA Service to allow or deny the user access to the application.</span></span>

<span data-ttu-id="b1837-122">If the MFA master server goes offline, authentications can still be processed, but operations that require changes to the MFA database cannot be processed.</span><span class="sxs-lookup"><span data-stu-id="b1837-122">If the MFA master server goes offline, authentications can still be processed, but operations that require changes to the MFA database cannot be processed.</span></span> <span data-ttu-id="b1837-123">(Examples include: the addition of users, self-service PIN changes, and changing user information)</span><span class="sxs-lookup"><span data-stu-id="b1837-123">(Examples include: the addition of users, self-service PIN changes, and changing user information)</span></span>

## <a name="deployment"></a><span data-ttu-id="b1837-124">Deployment</span><span class="sxs-lookup"><span data-stu-id="b1837-124">Deployment</span></span>

<span data-ttu-id="b1837-125">Consider the following important points for load balancing Azure MFA Server and its related components.</span><span class="sxs-lookup"><span data-stu-id="b1837-125">Consider the following important points for load balancing Azure MFA Server and its related components.</span></span>

* <span data-ttu-id="b1837-126">**Using RADIUS standard to achieve high availability**.</span><span class="sxs-lookup"><span data-stu-id="b1837-126">**Using RADIUS standard to achieve high availability**.</span></span> <span data-ttu-id="b1837-127">If you are using Azure MFA Servers as RADIUS servers, you can potentially configure one MFA Server as a primary RADIUS authentication target and other Azure MFA Servers as secondary authentication targets.</span><span class="sxs-lookup"><span data-stu-id="b1837-127">If you are using Azure MFA Servers as RADIUS servers, you can potentially configure one MFA Server as a primary RADIUS authentication target and other Azure MFA Servers as secondary authentication targets.</span></span> <span data-ttu-id="b1837-128">However, this method to achieve high availability may not be practical because you must wait for a time-out period to occur when authentication fails on the primary authentication target before you can be authenticated against the secondary authentication target.</span><span class="sxs-lookup"><span data-stu-id="b1837-128">However, this method to achieve high availability may not be practical because you must wait for a time-out period to occur when authentication fails on the primary authentication target before you can be authenticated against the secondary authentication target.</span></span> <span data-ttu-id="b1837-129">It is more efficient to load balance the RADIUS traffic between the RADIUS client and the RADIUS Servers (in this case, the Azure MFA Servers acting as RADIUS servers) so that you can configure the RADIUS clients with a single URL that they can point to.</span><span class="sxs-lookup"><span data-stu-id="b1837-129">It is more efficient to load balance the RADIUS traffic between the RADIUS client and the RADIUS Servers (in this case, the Azure MFA Servers acting as RADIUS servers) so that you can configure the RADIUS clients with a single URL that they can point to.</span></span>
* <span data-ttu-id="b1837-130">**Need to manually promote MFA subordinates**.</span><span class="sxs-lookup"><span data-stu-id="b1837-130">**Need to manually promote MFA subordinates**.</span></span> <span data-ttu-id="b1837-131">If the master Azure MFA server goes offline, the secondary Azure MFA Servers continue to process MFA requests.</span><span class="sxs-lookup"><span data-stu-id="b1837-131">If the master Azure MFA server goes offline, the secondary Azure MFA Servers continue to process MFA requests.</span></span> <span data-ttu-id="b1837-132">However, until a master MFA server is available, admins can not add users or modify MFA settings, and users can not make changes using the user portal.</span><span class="sxs-lookup"><span data-stu-id="b1837-132">However, until a master MFA server is available, admins can not add users or modify MFA settings, and users can not make changes using the user portal.</span></span> <span data-ttu-id="b1837-133">Promoting an MFA subordinate to the master role is always a manual process.</span><span class="sxs-lookup"><span data-stu-id="b1837-133">Promoting an MFA subordinate to the master role is always a manual process.</span></span>
* <span data-ttu-id="b1837-134">**Separability of components**.</span><span class="sxs-lookup"><span data-stu-id="b1837-134">**Separability of components**.</span></span> <span data-ttu-id="b1837-135">The Azure MFA Server comprises several components that can be installed on the same Windows Server instance or on different instances.</span><span class="sxs-lookup"><span data-stu-id="b1837-135">The Azure MFA Server comprises several components that can be installed on the same Windows Server instance or on different instances.</span></span> <span data-ttu-id="b1837-136">These components include the User Portal, Mobile App Web Service, and the ADFS adapter (agent).</span><span class="sxs-lookup"><span data-stu-id="b1837-136">These components include the User Portal, Mobile App Web Service, and the ADFS adapter (agent).</span></span> <span data-ttu-id="b1837-137">This separability makes it possible to use the Web Application Proxy to publish the User Portal and Mobile App Web Server from the perimeter network.</span><span class="sxs-lookup"><span data-stu-id="b1837-137">This separability makes it possible to use the Web Application Proxy to publish the User Portal and Mobile App Web Server from the perimeter network.</span></span> <span data-ttu-id="b1837-138">Such a configuration adds to the overall security of your design, as shown in the following diagram.</span><span class="sxs-lookup"><span data-stu-id="b1837-138">Such a configuration adds to the overall security of your design, as shown in the following diagram.</span></span> <span data-ttu-id="b1837-139">The MFA User Portal and Mobile App Web Server may also be deployed in HA load-balanced configurations.</span><span class="sxs-lookup"><span data-stu-id="b1837-139">The MFA User Portal and Mobile App Web Server may also be deployed in HA load-balanced configurations.</span></span>

   ![MFA Server with a Perimeter Network](./media/howto-mfaserver-deploy-ha/mfasecurity.png)

* <span data-ttu-id="b1837-141">**One-time password (OTP) over SMS (aka one-way SMS) requires the use of sticky sessions if traffic is load-balanced**.</span><span class="sxs-lookup"><span data-stu-id="b1837-141">**One-time password (OTP) over SMS (aka one-way SMS) requires the use of sticky sessions if traffic is load-balanced**.</span></span> <span data-ttu-id="b1837-142">One-way SMS is an authentication option that causes the MFA Server to send the users a text message containing an OTP.</span><span class="sxs-lookup"><span data-stu-id="b1837-142">One-way SMS is an authentication option that causes the MFA Server to send the users a text message containing an OTP.</span></span> <span data-ttu-id="b1837-143">The user enters the OTP in a prompt window to complete the MFA challenge.</span><span class="sxs-lookup"><span data-stu-id="b1837-143">The user enters the OTP in a prompt window to complete the MFA challenge.</span></span> <span data-ttu-id="b1837-144">If you load balance Azure MFA Servers, the same server that served the initial authentication request must be the server that receives the OTP message from the user; if another MFA Server receives the OTP reply, the authentication challenge fails.</span><span class="sxs-lookup"><span data-stu-id="b1837-144">If you load balance Azure MFA Servers, the same server that served the initial authentication request must be the server that receives the OTP message from the user; if another MFA Server receives the OTP reply, the authentication challenge fails.</span></span> <span data-ttu-id="b1837-145">For more information, see [One Time Password over SMS Added to Azure MFA Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server).</span><span class="sxs-lookup"><span data-stu-id="b1837-145">For more information, see [One Time Password over SMS Added to Azure MFA Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server).</span></span>
* <span data-ttu-id="b1837-146">**Load-Balanced deployments of the User Portal and Mobile App Web Service require sticky sessions**.</span><span class="sxs-lookup"><span data-stu-id="b1837-146">**Load-Balanced deployments of the User Portal and Mobile App Web Service require sticky sessions**.</span></span> <span data-ttu-id="b1837-147">If you are load-balancing the MFA User Portal and the Mobile App Web Service, each session needs to stay on the same server.</span><span class="sxs-lookup"><span data-stu-id="b1837-147">If you are load-balancing the MFA User Portal and the Mobile App Web Service, each session needs to stay on the same server.</span></span>

## <a name="high-availability-deployment"></a><span data-ttu-id="b1837-148">High-availability deployment</span><span class="sxs-lookup"><span data-stu-id="b1837-148">High-availability deployment</span></span>

<span data-ttu-id="b1837-149">The following diagram shows a complete HA load-balanced implementation of Azure MFA and its components, along with ADFS for reference.</span><span class="sxs-lookup"><span data-stu-id="b1837-149">The following diagram shows a complete HA load-balanced implementation of Azure MFA and its components, along with ADFS for reference.</span></span>

 ![Azure MFA Server HA implementation](./media/howto-mfaserver-deploy-ha/mfa-ha-deployment.png)

<span data-ttu-id="b1837-151">Note the following items for the correspondingly numbered area of the preceding diagram.</span><span class="sxs-lookup"><span data-stu-id="b1837-151">Note the following items for the correspondingly numbered area of the preceding diagram.</span></span>

1. <span data-ttu-id="b1837-152">The two Azure MFA Servers (MFA1 and MFA2) are load balanced (mfaapp.contoso.com) and are configured to use a static port (4443) to replicate the PhoneFactor.pfdata database.</span><span class="sxs-lookup"><span data-stu-id="b1837-152">The two Azure MFA Servers (MFA1 and MFA2) are load balanced (mfaapp.contoso.com) and are configured to use a static port (4443) to replicate the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="b1837-153">The Web Service SDK is installed on each of the MFA Server to enable communication over TCP port 443 with the ADFS servers.</span><span class="sxs-lookup"><span data-stu-id="b1837-153">The Web Service SDK is installed on each of the MFA Server to enable communication over TCP port 443 with the ADFS servers.</span></span> <span data-ttu-id="b1837-154">The MFA servers are deployed in a stateless load-balanced configuration.</span><span class="sxs-lookup"><span data-stu-id="b1837-154">The MFA servers are deployed in a stateless load-balanced configuration.</span></span> <span data-ttu-id="b1837-155">However, if you wanted to use OTP over SMS, you must use stateful load balancing.</span><span class="sxs-lookup"><span data-stu-id="b1837-155">However, if you wanted to use OTP over SMS, you must use stateful load balancing.</span></span>
   <span data-ttu-id="b1837-156">![Azure MFA Server - App server HA](./media/howto-mfaserver-deploy-ha/mfaapp.png)</span><span class="sxs-lookup"><span data-stu-id="b1837-156">![Azure MFA Server - App server HA](./media/howto-mfaserver-deploy-ha/mfaapp.png)</span></span>

   > [!NOTE]
   > <span data-ttu-id="b1837-157">Because RPC uses dynamic ports, it is not recommended to open firewalls up to the range of dynamic ports that RPC can potentially use.</span><span class="sxs-lookup"><span data-stu-id="b1837-157">Because RPC uses dynamic ports, it is not recommended to open firewalls up to the range of dynamic ports that RPC can potentially use.</span></span> <span data-ttu-id="b1837-158">If you have a firewall **between** your MFA application servers, you should configure the MFA Server to communicate on a static port for the replication traffic between subordinate and master servers and open that port on your firewall.</span><span class="sxs-lookup"><span data-stu-id="b1837-158">If you have a firewall **between** your MFA application servers, you should configure the MFA Server to communicate on a static port for the replication traffic between subordinate and master servers and open that port on your firewall.</span></span> <span data-ttu-id="b1837-159">You can force the static port by creating a DWORD registry value at ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` called ```Pfsvc_ncan_ip_tcp_port``` and setting the value to an available static port.</span><span class="sxs-lookup"><span data-stu-id="b1837-159">You can force the static port by creating a DWORD registry value at ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` called ```Pfsvc_ncan_ip_tcp_port``` and setting the value to an available static port.</span></span> <span data-ttu-id="b1837-160">Connections are always initiated by the subordinate MFA Servers to the master, the static port is only required on the master, but since you can promote a subordinate to be the master at any time, you should set the static port on all MFA Servers.</span><span class="sxs-lookup"><span data-stu-id="b1837-160">Connections are always initiated by the subordinate MFA Servers to the master, the static port is only required on the master, but since you can promote a subordinate to be the master at any time, you should set the static port on all MFA Servers.</span></span>

2. <span data-ttu-id="b1837-161">The two User Portal/MFA Mobile App servers (MFA-UP-MAS1 and MFA-UP-MAS2) are load balanced in a **stateful** configuration (mfa.contoso.com).</span><span class="sxs-lookup"><span data-stu-id="b1837-161">The two User Portal/MFA Mobile App servers (MFA-UP-MAS1 and MFA-UP-MAS2) are load balanced in a **stateful** configuration (mfa.contoso.com).</span></span> <span data-ttu-id="b1837-162">Recall that sticky sessions are a requirement for load balancing the MFA User Portal and Mobile App Service.</span><span class="sxs-lookup"><span data-stu-id="b1837-162">Recall that sticky sessions are a requirement for load balancing the MFA User Portal and Mobile App Service.</span></span>
   <span data-ttu-id="b1837-163">![Azure MFA Server - User Portal and Mobile App Service HA](./media/howto-mfaserver-deploy-ha/mfaportal.png)</span><span class="sxs-lookup"><span data-stu-id="b1837-163">![Azure MFA Server - User Portal and Mobile App Service HA](./media/howto-mfaserver-deploy-ha/mfaportal.png)</span></span>
3. <span data-ttu-id="b1837-164">The ADFS Server farm is load balanced and published to the Internet through load-balanced ADFS proxies in the perimeter network.</span><span class="sxs-lookup"><span data-stu-id="b1837-164">The ADFS Server farm is load balanced and published to the Internet through load-balanced ADFS proxies in the perimeter network.</span></span> <span data-ttu-id="b1837-165">Each ADFS Server uses the ADFS agent to communicate with the Azure MFA Servers using a single load-balanced URL (mfaapp.contoso.com) over TCP port 443.</span><span class="sxs-lookup"><span data-stu-id="b1837-165">Each ADFS Server uses the ADFS agent to communicate with the Azure MFA Servers using a single load-balanced URL (mfaapp.contoso.com) over TCP port 443.</span></span>

## <a name="next-steps"></a><span data-ttu-id="b1837-166">Next steps</span><span class="sxs-lookup"><span data-stu-id="b1837-166">Next steps</span></span>

* [<span data-ttu-id="b1837-167">Install and configure Azure MFA Server</span><span class="sxs-lookup"><span data-stu-id="b1837-167">Install and configure Azure MFA Server</span></span>](howto-mfaserver-deploy.md)
