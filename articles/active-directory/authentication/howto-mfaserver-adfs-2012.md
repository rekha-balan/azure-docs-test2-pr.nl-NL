---
title: Azure MFA Server with AD FS in Windows Server
description: This article describes how to get started with Azure Multi-Factor Authentication and AD FS in Windows Server 2012 R2 and 2016.
services: multi-factor-authentication
ms.service: active-directory
ms.component: authentication
ms.topic: conceptual
ms.date: 07/11/2018
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.reviewer: michmcla
ms.openlocfilehash: 663ed2f42f59093252506fc5bb5fe2581d4dd200
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44870887"
---
# <a name="configure-azure-multi-factor-authentication-server-to-work-with-ad-fs-in-windows-server"></a><span data-ttu-id="398ff-103">Configure Azure Multi-Factor Authentication Server to work with AD FS in Windows Server</span><span class="sxs-lookup"><span data-stu-id="398ff-103">Configure Azure Multi-Factor Authentication Server to work with AD FS in Windows Server</span></span>

<span data-ttu-id="398ff-104">If you use Active Directory Federation Services (AD FS) and want to secure cloud or on-premises resources, you can configure Azure Multi-Factor Authentication Server to work with AD FS.</span><span class="sxs-lookup"><span data-stu-id="398ff-104">If you use Active Directory Federation Services (AD FS) and want to secure cloud or on-premises resources, you can configure Azure Multi-Factor Authentication Server to work with AD FS.</span></span> <span data-ttu-id="398ff-105">This configuration triggers two-step verification for high-value endpoints.</span><span class="sxs-lookup"><span data-stu-id="398ff-105">This configuration triggers two-step verification for high-value endpoints.</span></span>

<span data-ttu-id="398ff-106">In this article, we discuss using Azure Multi-Factor Authentication Server with AD FS in Windows Server 2012 R2 or Windows Server 2016.</span><span class="sxs-lookup"><span data-stu-id="398ff-106">In this article, we discuss using Azure Multi-Factor Authentication Server with AD FS in Windows Server 2012 R2 or Windows Server 2016.</span></span> <span data-ttu-id="398ff-107">For more information, read about how to [secure cloud and on-premises resources by using Azure Multi-Factor Authentication Server with AD FS 2.0](howto-mfaserver-adfs-2.md).</span><span class="sxs-lookup"><span data-stu-id="398ff-107">For more information, read about how to [secure cloud and on-premises resources by using Azure Multi-Factor Authentication Server with AD FS 2.0](howto-mfaserver-adfs-2.md).</span></span>

## <a name="secure-windows-server-ad-fs-with-azure-multi-factor-authentication-server"></a><span data-ttu-id="398ff-108">Secure Windows Server AD FS with Azure Multi-Factor Authentication Server</span><span class="sxs-lookup"><span data-stu-id="398ff-108">Secure Windows Server AD FS with Azure Multi-Factor Authentication Server</span></span>

<span data-ttu-id="398ff-109">When you install Azure Multi-Factor Authentication Server, you have the following options:</span><span class="sxs-lookup"><span data-stu-id="398ff-109">When you install Azure Multi-Factor Authentication Server, you have the following options:</span></span>

* <span data-ttu-id="398ff-110">Install Azure Multi-Factor Authentication Server locally on the same server as AD FS</span><span class="sxs-lookup"><span data-stu-id="398ff-110">Install Azure Multi-Factor Authentication Server locally on the same server as AD FS</span></span>
* <span data-ttu-id="398ff-111">Install the Azure Multi-Factor Authentication adapter locally on the AD FS server, and then install Multi-Factor Authentication Server on a different computer</span><span class="sxs-lookup"><span data-stu-id="398ff-111">Install the Azure Multi-Factor Authentication adapter locally on the AD FS server, and then install Multi-Factor Authentication Server on a different computer</span></span>

<span data-ttu-id="398ff-112">Before you begin, be aware of the following information:</span><span class="sxs-lookup"><span data-stu-id="398ff-112">Before you begin, be aware of the following information:</span></span>

* <span data-ttu-id="398ff-113">You don't have to install Azure Multi-Factor Authentication Server on your AD FS server.</span><span class="sxs-lookup"><span data-stu-id="398ff-113">You don't have to install Azure Multi-Factor Authentication Server on your AD FS server.</span></span> <span data-ttu-id="398ff-114">However, you must install the Multi-Factor Authentication adapter for AD FS on a Windows Server 2012 R2 or Windows Server 2016 that is running AD FS.</span><span class="sxs-lookup"><span data-stu-id="398ff-114">However, you must install the Multi-Factor Authentication adapter for AD FS on a Windows Server 2012 R2 or Windows Server 2016 that is running AD FS.</span></span> <span data-ttu-id="398ff-115">You can install the server on a different computer if you install the AD FS adapter separately on your AD FS federation server.</span><span class="sxs-lookup"><span data-stu-id="398ff-115">You can install the server on a different computer if you install the AD FS adapter separately on your AD FS federation server.</span></span> <span data-ttu-id="398ff-116">See the following procedures to learn how to install the adapter separately.</span><span class="sxs-lookup"><span data-stu-id="398ff-116">See the following procedures to learn how to install the adapter separately.</span></span>
* <span data-ttu-id="398ff-117">If your organization is using text message or mobile app verification methods, the strings defined in Company Settings contain a placeholder, <$*application_name*$>.</span><span class="sxs-lookup"><span data-stu-id="398ff-117">If your organization is using text message or mobile app verification methods, the strings defined in Company Settings contain a placeholder, <$*application_name*$>.</span></span> <span data-ttu-id="398ff-118">In MFA Server v7.1, you can provide an application name that replaces this placeholder.</span><span class="sxs-lookup"><span data-stu-id="398ff-118">In MFA Server v7.1, you can provide an application name that replaces this placeholder.</span></span> <span data-ttu-id="398ff-119">In v7.0 or older, this placeholder is not automatically replaced when you use the AD FS adapter.</span><span class="sxs-lookup"><span data-stu-id="398ff-119">In v7.0 or older, this placeholder is not automatically replaced when you use the AD FS adapter.</span></span> <span data-ttu-id="398ff-120">For those older versions, remove the placeholder from the appropriate strings when you secure AD FS.</span><span class="sxs-lookup"><span data-stu-id="398ff-120">For those older versions, remove the placeholder from the appropriate strings when you secure AD FS.</span></span>
* <span data-ttu-id="398ff-121">The account that you use to sign in must have user rights to create security groups in your Active Directory service.</span><span class="sxs-lookup"><span data-stu-id="398ff-121">The account that you use to sign in must have user rights to create security groups in your Active Directory service.</span></span>
* <span data-ttu-id="398ff-122">The Multi-Factor Authentication AD FS adapter installation wizard creates a security group called PhoneFactor Admins in your instance of Active Directory.</span><span class="sxs-lookup"><span data-stu-id="398ff-122">The Multi-Factor Authentication AD FS adapter installation wizard creates a security group called PhoneFactor Admins in your instance of Active Directory.</span></span> <span data-ttu-id="398ff-123">It then adds the AD FS service account of your federation service to this group.</span><span class="sxs-lookup"><span data-stu-id="398ff-123">It then adds the AD FS service account of your federation service to this group.</span></span> <span data-ttu-id="398ff-124">Verify that the PhoneFactor Admins group was created on your domain controller, and that the AD FS service account is a member of this group.</span><span class="sxs-lookup"><span data-stu-id="398ff-124">Verify that the PhoneFactor Admins group was created on your domain controller, and that the AD FS service account is a member of this group.</span></span> <span data-ttu-id="398ff-125">If necessary, manually add the AD FS service account to the PhoneFactor Admins group on your domain controller.</span><span class="sxs-lookup"><span data-stu-id="398ff-125">If necessary, manually add the AD FS service account to the PhoneFactor Admins group on your domain controller.</span></span>
* <span data-ttu-id="398ff-126">For information about installing the Web Service SDK with the user portal, see [deploying the user portal for Azure Multi-Factor Authentication Server.](howto-mfaserver-deploy-userportal.md)</span><span class="sxs-lookup"><span data-stu-id="398ff-126">For information about installing the Web Service SDK with the user portal, see [deploying the user portal for Azure Multi-Factor Authentication Server.](howto-mfaserver-deploy-userportal.md)</span></span>

### <a name="install-azure-multi-factor-authentication-server-locally-on-the-ad-fs-server"></a><span data-ttu-id="398ff-127">Install Azure Multi-Factor Authentication Server locally on the AD FS server</span><span class="sxs-lookup"><span data-stu-id="398ff-127">Install Azure Multi-Factor Authentication Server locally on the AD FS server</span></span>

1. <span data-ttu-id="398ff-128">Download and install Azure Multi-Factor Authentication Server on your AD FS server.</span><span class="sxs-lookup"><span data-stu-id="398ff-128">Download and install Azure Multi-Factor Authentication Server on your AD FS server.</span></span> <span data-ttu-id="398ff-129">For installation information, read about [getting started with Azure Multi-Factor Authentication Server](howto-mfaserver-deploy.md).</span><span class="sxs-lookup"><span data-stu-id="398ff-129">For installation information, read about [getting started with Azure Multi-Factor Authentication Server](howto-mfaserver-deploy.md).</span></span>
2. <span data-ttu-id="398ff-130">In the Azure Multi-Factor Authentication Server management console, click the **AD FS** icon.</span><span class="sxs-lookup"><span data-stu-id="398ff-130">In the Azure Multi-Factor Authentication Server management console, click the **AD FS** icon.</span></span> <span data-ttu-id="398ff-131">Select the options **Allow user enrollment** and **Allow users to select method**.</span><span class="sxs-lookup"><span data-stu-id="398ff-131">Select the options **Allow user enrollment** and **Allow users to select method**.</span></span>
3. <span data-ttu-id="398ff-132">Select any additional options you'd like to specify for your organization.</span><span class="sxs-lookup"><span data-stu-id="398ff-132">Select any additional options you'd like to specify for your organization.</span></span>
4. <span data-ttu-id="398ff-133">Click **Install AD FS Adapter**.</span><span class="sxs-lookup"><span data-stu-id="398ff-133">Click **Install AD FS Adapter**.</span></span>
   
   <span data-ttu-id="398ff-134"><center>![Cloud](./media/howto-mfaserver-adfs-2012/server.png)</center></span><span class="sxs-lookup"><span data-stu-id="398ff-134"><center>![Cloud](./media/howto-mfaserver-adfs-2012/server.png)</center></span></span>

5. <span data-ttu-id="398ff-135">If the Active Directory window is displayed, that means two things.</span><span class="sxs-lookup"><span data-stu-id="398ff-135">If the Active Directory window is displayed, that means two things.</span></span> <span data-ttu-id="398ff-136">Your computer is joined to a domain, and the Active Directory configuration for securing communication between the AD FS adapter and the Multi-Factor Authentication service is incomplete.</span><span class="sxs-lookup"><span data-stu-id="398ff-136">Your computer is joined to a domain, and the Active Directory configuration for securing communication between the AD FS adapter and the Multi-Factor Authentication service is incomplete.</span></span> <span data-ttu-id="398ff-137">Click **Next** to automatically complete this configuration, or select the **Skip automatic Active Directory configuration and configure settings manually** check box.</span><span class="sxs-lookup"><span data-stu-id="398ff-137">Click **Next** to automatically complete this configuration, or select the **Skip automatic Active Directory configuration and configure settings manually** check box.</span></span> <span data-ttu-id="398ff-138">Click **Next**.</span><span class="sxs-lookup"><span data-stu-id="398ff-138">Click **Next**.</span></span>
6. <span data-ttu-id="398ff-139">If the Local Group windows is displayed, that means two things.</span><span class="sxs-lookup"><span data-stu-id="398ff-139">If the Local Group windows is displayed, that means two things.</span></span> <span data-ttu-id="398ff-140">Your computer is not joined to a domain, and the local group configuration for securing communication between the AD FS adapter and the Multi-Factor Authentication service is incomplete.</span><span class="sxs-lookup"><span data-stu-id="398ff-140">Your computer is not joined to a domain, and the local group configuration for securing communication between the AD FS adapter and the Multi-Factor Authentication service is incomplete.</span></span> <span data-ttu-id="398ff-141">Click **Next** to automatically complete this configuration, or select the **Skip automatic Local Group configuration and configure settings manually** check box.</span><span class="sxs-lookup"><span data-stu-id="398ff-141">Click **Next** to automatically complete this configuration, or select the **Skip automatic Local Group configuration and configure settings manually** check box.</span></span> <span data-ttu-id="398ff-142">Click **Next**.</span><span class="sxs-lookup"><span data-stu-id="398ff-142">Click **Next**.</span></span>
7. <span data-ttu-id="398ff-143">In the installation wizard, click **Next**.</span><span class="sxs-lookup"><span data-stu-id="398ff-143">In the installation wizard, click **Next**.</span></span> <span data-ttu-id="398ff-144">Azure Multi-Factor Authentication Server creates the PhoneFactor Admins group and adds the AD FS service account to the PhoneFactor Admins group.</span><span class="sxs-lookup"><span data-stu-id="398ff-144">Azure Multi-Factor Authentication Server creates the PhoneFactor Admins group and adds the AD FS service account to the PhoneFactor Admins group.</span></span>
   <span data-ttu-id="398ff-145"><center>![Cloud](./media/howto-mfaserver-adfs-2012/adapter.png)</center></span><span class="sxs-lookup"><span data-stu-id="398ff-145"><center>![Cloud](./media/howto-mfaserver-adfs-2012/adapter.png)</center></span></span>
8. <span data-ttu-id="398ff-146">On the **Launch Installer** page, click **Next**.</span><span class="sxs-lookup"><span data-stu-id="398ff-146">On the **Launch Installer** page, click **Next**.</span></span>
9. <span data-ttu-id="398ff-147">In the Multi-Factor Authentication AD FS adapter installer, click **Next**.</span><span class="sxs-lookup"><span data-stu-id="398ff-147">In the Multi-Factor Authentication AD FS adapter installer, click **Next**.</span></span>
10. <span data-ttu-id="398ff-148">Click **Close** when the installation is finished.</span><span class="sxs-lookup"><span data-stu-id="398ff-148">Click **Close** when the installation is finished.</span></span>
11. <span data-ttu-id="398ff-149">When the adapter has been installed, you must register it with AD FS.</span><span class="sxs-lookup"><span data-stu-id="398ff-149">When the adapter has been installed, you must register it with AD FS.</span></span> <span data-ttu-id="398ff-150">Open Windows PowerShell and run the following command:</span><span class="sxs-lookup"><span data-stu-id="398ff-150">Open Windows PowerShell and run the following command:</span></span><br>
    <span data-ttu-id="398ff-151">`C:\Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1`
    <center>![Cloud](./media/howto-mfaserver-adfs-2012/pshell.png)</center></span><span class="sxs-lookup"><span data-stu-id="398ff-151">`C:\Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1`
<center>![Cloud](./media/howto-mfaserver-adfs-2012/pshell.png)</center></span></span>
12. <span data-ttu-id="398ff-152">To use your newly registered adapter, edit the global authentication policy in AD FS.</span><span class="sxs-lookup"><span data-stu-id="398ff-152">To use your newly registered adapter, edit the global authentication policy in AD FS.</span></span> <span data-ttu-id="398ff-153">In the AD FS management console, go to the **Authentication Policies** node.</span><span class="sxs-lookup"><span data-stu-id="398ff-153">In the AD FS management console, go to the **Authentication Policies** node.</span></span> <span data-ttu-id="398ff-154">In the **Multi-factor Authentication** section, click the **Edit** link next to the **Global Settings** section.</span><span class="sxs-lookup"><span data-stu-id="398ff-154">In the **Multi-factor Authentication** section, click the **Edit** link next to the **Global Settings** section.</span></span> <span data-ttu-id="398ff-155">In the **Edit Global Authentication Policy** window, select **Multi-Factor Authentication** as an additional authentication method, and then click **OK**.</span><span class="sxs-lookup"><span data-stu-id="398ff-155">In the **Edit Global Authentication Policy** window, select **Multi-Factor Authentication** as an additional authentication method, and then click **OK**.</span></span> <span data-ttu-id="398ff-156">The adapter is registered as WindowsAzureMultiFactorAuthentication.</span><span class="sxs-lookup"><span data-stu-id="398ff-156">The adapter is registered as WindowsAzureMultiFactorAuthentication.</span></span> <span data-ttu-id="398ff-157">Restart the AD FS service for the registration to take effect.</span><span class="sxs-lookup"><span data-stu-id="398ff-157">Restart the AD FS service for the registration to take effect.</span></span>

<span data-ttu-id="398ff-158"><center>![Cloud](./media/howto-mfaserver-adfs-2012/global.png)</center></span><span class="sxs-lookup"><span data-stu-id="398ff-158"><center>![Cloud](./media/howto-mfaserver-adfs-2012/global.png)</center></span></span>

<span data-ttu-id="398ff-159">At this point, Multi-Factor Authentication Server is set up to be an additional authentication provider to use with AD FS.</span><span class="sxs-lookup"><span data-stu-id="398ff-159">At this point, Multi-Factor Authentication Server is set up to be an additional authentication provider to use with AD FS.</span></span>

## <a name="install-a-standalone-instance-of-the-ad-fs-adapter-by-using-the-web-service-sdk"></a><span data-ttu-id="398ff-160">Install a standalone instance of the AD FS adapter by using the Web Service SDK</span><span class="sxs-lookup"><span data-stu-id="398ff-160">Install a standalone instance of the AD FS adapter by using the Web Service SDK</span></span>

1. <span data-ttu-id="398ff-161">Install the Web Service SDK on the server that is running Multi-Factor Authentication Server.</span><span class="sxs-lookup"><span data-stu-id="398ff-161">Install the Web Service SDK on the server that is running Multi-Factor Authentication Server.</span></span>
2. <span data-ttu-id="398ff-162">Copy the following files from the \Program Files\Multi-Factor Authentication Server directory to the server on which you plan to install the AD FS adapter:</span><span class="sxs-lookup"><span data-stu-id="398ff-162">Copy the following files from the \Program Files\Multi-Factor Authentication Server directory to the server on which you plan to install the AD FS adapter:</span></span>
   * <span data-ttu-id="398ff-163">MultiFactorAuthenticationAdfsAdapterSetup64.msi</span><span class="sxs-lookup"><span data-stu-id="398ff-163">MultiFactorAuthenticationAdfsAdapterSetup64.msi</span></span>
   * <span data-ttu-id="398ff-164">Register-MultiFactorAuthenticationAdfsAdapter.ps1</span><span class="sxs-lookup"><span data-stu-id="398ff-164">Register-MultiFactorAuthenticationAdfsAdapter.ps1</span></span>
   * <span data-ttu-id="398ff-165">Unregister-MultiFactorAuthenticationAdfsAdapter.ps1</span><span class="sxs-lookup"><span data-stu-id="398ff-165">Unregister-MultiFactorAuthenticationAdfsAdapter.ps1</span></span>
   * <span data-ttu-id="398ff-166">MultiFactorAuthenticationAdfsAdapter.config</span><span class="sxs-lookup"><span data-stu-id="398ff-166">MultiFactorAuthenticationAdfsAdapter.config</span></span>
3. <span data-ttu-id="398ff-167">Run the MultiFactorAuthenticationAdfsAdapterSetup64.msi installation file.</span><span class="sxs-lookup"><span data-stu-id="398ff-167">Run the MultiFactorAuthenticationAdfsAdapterSetup64.msi installation file.</span></span>
4. <span data-ttu-id="398ff-168">In the Multi-Factor Authentication AD FS adapter installer, click **Next** to start the installation.</span><span class="sxs-lookup"><span data-stu-id="398ff-168">In the Multi-Factor Authentication AD FS adapter installer, click **Next** to start the installation.</span></span>
5. <span data-ttu-id="398ff-169">Click **Close** when the installation is finished.</span><span class="sxs-lookup"><span data-stu-id="398ff-169">Click **Close** when the installation is finished.</span></span>

## <a name="edit-the-multifactorauthenticationadfsadapterconfig-file"></a><span data-ttu-id="398ff-170">Edit the MultiFactorAuthenticationAdfsAdapter.config file</span><span class="sxs-lookup"><span data-stu-id="398ff-170">Edit the MultiFactorAuthenticationAdfsAdapter.config file</span></span>
<span data-ttu-id="398ff-171">Follow these steps to edit the MultiFactorAuthenticationAdfsAdapter.config file:</span><span class="sxs-lookup"><span data-stu-id="398ff-171">Follow these steps to edit the MultiFactorAuthenticationAdfsAdapter.config file:</span></span>

1. <span data-ttu-id="398ff-172">Set the **UseWebServiceSdk** node to **true**.</span><span class="sxs-lookup"><span data-stu-id="398ff-172">Set the **UseWebServiceSdk** node to **true**.</span></span>  
2. <span data-ttu-id="398ff-173">Set the value for **WebServiceSdkUrl** to the URL of the Multi-Factor Authentication Web Service SDK.</span><span class="sxs-lookup"><span data-stu-id="398ff-173">Set the value for **WebServiceSdkUrl** to the URL of the Multi-Factor Authentication Web Service SDK.</span></span> <span data-ttu-id="398ff-174">For example: *https://contoso.com/&lt;certificatename&gt;/MultiFactorAuthWebServiceSdk/PfWsSdk.asmx*, Where *certificatename* is the name of your certificate.</span><span class="sxs-lookup"><span data-stu-id="398ff-174">For example: *https://contoso.com/&lt;certificatename&gt;/MultiFactorAuthWebServiceSdk/PfWsSdk.asmx*, Where *certificatename* is the name of your certificate.</span></span>  
3. <span data-ttu-id="398ff-175">Edit the Register-MultiFactorAuthenticationAdfsAdapter.ps1 script by adding `-ConfigurationFilePath &lt;path&gt;` to the end of the `Register-AdfsAuthenticationProvider` command, where *&lt;path&gt;* is the full path to the MultiFactorAuthenticationAdfsAdapter.config file.</span><span class="sxs-lookup"><span data-stu-id="398ff-175">Edit the Register-MultiFactorAuthenticationAdfsAdapter.ps1 script by adding `-ConfigurationFilePath &lt;path&gt;` to the end of the `Register-AdfsAuthenticationProvider` command, where *&lt;path&gt;* is the full path to the MultiFactorAuthenticationAdfsAdapter.config file.</span></span>

### <a name="configure-the-web-service-sdk-with-a-username-and-password"></a><span data-ttu-id="398ff-176">Configure the Web Service SDK with a username and password</span><span class="sxs-lookup"><span data-stu-id="398ff-176">Configure the Web Service SDK with a username and password</span></span>

<span data-ttu-id="398ff-177">There are two options for configuring the Web Service SDK.</span><span class="sxs-lookup"><span data-stu-id="398ff-177">There are two options for configuring the Web Service SDK.</span></span> <span data-ttu-id="398ff-178">The first is with a username and password, the second is with a client certificate.</span><span class="sxs-lookup"><span data-stu-id="398ff-178">The first is with a username and password, the second is with a client certificate.</span></span> <span data-ttu-id="398ff-179">Follow these steps for the first option, or skip ahead for the second.</span><span class="sxs-lookup"><span data-stu-id="398ff-179">Follow these steps for the first option, or skip ahead for the second.</span></span>  

1. <span data-ttu-id="398ff-180">Set the value for **WebServiceSdkUsername** to an account that is a member of the PhoneFactor Admins security group.</span><span class="sxs-lookup"><span data-stu-id="398ff-180">Set the value for **WebServiceSdkUsername** to an account that is a member of the PhoneFactor Admins security group.</span></span> <span data-ttu-id="398ff-181">Use the &lt;domain&gt;&#92;&lt;user name&gt; format.</span><span class="sxs-lookup"><span data-stu-id="398ff-181">Use the &lt;domain&gt;&#92;&lt;user name&gt; format.</span></span>  
2. <span data-ttu-id="398ff-182">Set the value for **WebServiceSdkPassword** to the appropriate account password.</span><span class="sxs-lookup"><span data-stu-id="398ff-182">Set the value for **WebServiceSdkPassword** to the appropriate account password.</span></span>

### <a name="configure-the-web-service-sdk-with-a-client-certificate"></a><span data-ttu-id="398ff-183">Configure the Web Service SDK with a client certificate</span><span class="sxs-lookup"><span data-stu-id="398ff-183">Configure the Web Service SDK with a client certificate</span></span>

<span data-ttu-id="398ff-184">If you don't want to use a username and password, follow these steps to configure the Web Service SDK with a client certificate.</span><span class="sxs-lookup"><span data-stu-id="398ff-184">If you don't want to use a username and password, follow these steps to configure the Web Service SDK with a client certificate.</span></span>

1. <span data-ttu-id="398ff-185">Obtain a client certificate from a certificate authority for the server that is running the Web Service SDK.</span><span class="sxs-lookup"><span data-stu-id="398ff-185">Obtain a client certificate from a certificate authority for the server that is running the Web Service SDK.</span></span> <span data-ttu-id="398ff-186">Learn how to [obtain client certificates](https://technet.microsoft.com/library/cc770328.aspx).</span><span class="sxs-lookup"><span data-stu-id="398ff-186">Learn how to [obtain client certificates](https://technet.microsoft.com/library/cc770328.aspx).</span></span>  
2. <span data-ttu-id="398ff-187">Import the client certificate to the local computer personal certificate store on the server that is running the Web Service SDK.</span><span class="sxs-lookup"><span data-stu-id="398ff-187">Import the client certificate to the local computer personal certificate store on the server that is running the Web Service SDK.</span></span> <span data-ttu-id="398ff-188">Make sure that the certificate authority's public certificate is in Trusted Root Certificates certificate store.</span><span class="sxs-lookup"><span data-stu-id="398ff-188">Make sure that the certificate authority's public certificate is in Trusted Root Certificates certificate store.</span></span>  
3. <span data-ttu-id="398ff-189">Export the public and private keys of the client certificate to a .pfx file.</span><span class="sxs-lookup"><span data-stu-id="398ff-189">Export the public and private keys of the client certificate to a .pfx file.</span></span>  
4. <span data-ttu-id="398ff-190">Export the public key in Base64 format to a .cer file.</span><span class="sxs-lookup"><span data-stu-id="398ff-190">Export the public key in Base64 format to a .cer file.</span></span>  
5. <span data-ttu-id="398ff-191">In Server Manager, verify that the Web Server (IIS)\Web Server\Security\IIS Client Certificate Mapping Authentication feature is installed.</span><span class="sxs-lookup"><span data-stu-id="398ff-191">In Server Manager, verify that the Web Server (IIS)\Web Server\Security\IIS Client Certificate Mapping Authentication feature is installed.</span></span> <span data-ttu-id="398ff-192">If it is not installed, select **Add Roles and Features** to add this feature.</span><span class="sxs-lookup"><span data-stu-id="398ff-192">If it is not installed, select **Add Roles and Features** to add this feature.</span></span>  
6. <span data-ttu-id="398ff-193">In IIS Manager, double-click **Configuration Editor** in the website that contains the Web Service SDK virtual directory.</span><span class="sxs-lookup"><span data-stu-id="398ff-193">In IIS Manager, double-click **Configuration Editor** in the website that contains the Web Service SDK virtual directory.</span></span> <span data-ttu-id="398ff-194">It is important to select the website, not the virtual directory.</span><span class="sxs-lookup"><span data-stu-id="398ff-194">It is important to select the website, not the virtual directory.</span></span>  
7. <span data-ttu-id="398ff-195">Go to the **system.webServer/security/authentication/iisClientCertificateMappingAuthentication** section.</span><span class="sxs-lookup"><span data-stu-id="398ff-195">Go to the **system.webServer/security/authentication/iisClientCertificateMappingAuthentication** section.</span></span>  
8. <span data-ttu-id="398ff-196">Set enabled to **true**.</span><span class="sxs-lookup"><span data-stu-id="398ff-196">Set enabled to **true**.</span></span>  
9. <span data-ttu-id="398ff-197">Set oneToOneCertificateMappingsEnabled to **true**.</span><span class="sxs-lookup"><span data-stu-id="398ff-197">Set oneToOneCertificateMappingsEnabled to **true**.</span></span>  
10. <span data-ttu-id="398ff-198">Click the **...** button next to oneToOneMappings, and then click the **Add** link.</span><span class="sxs-lookup"><span data-stu-id="398ff-198">Click the **...** button next to oneToOneMappings, and then click the **Add** link.</span></span>  
11. <span data-ttu-id="398ff-199">Open the Base64 .cer file you exported earlier.</span><span class="sxs-lookup"><span data-stu-id="398ff-199">Open the Base64 .cer file you exported earlier.</span></span> <span data-ttu-id="398ff-200">Remove *-----BEGIN CERTIFICATE-----*, *-----END CERTIFICATE-----*, and any line breaks.</span><span class="sxs-lookup"><span data-stu-id="398ff-200">Remove *-----BEGIN CERTIFICATE-----*, *-----END CERTIFICATE-----*, and any line breaks.</span></span> <span data-ttu-id="398ff-201">Copy the resulting string.</span><span class="sxs-lookup"><span data-stu-id="398ff-201">Copy the resulting string.</span></span>  
12. <span data-ttu-id="398ff-202">Set certificate to the string copied in the preceding step.</span><span class="sxs-lookup"><span data-stu-id="398ff-202">Set certificate to the string copied in the preceding step.</span></span>  
13. <span data-ttu-id="398ff-203">Set enabled to **true**.</span><span class="sxs-lookup"><span data-stu-id="398ff-203">Set enabled to **true**.</span></span>  
14. <span data-ttu-id="398ff-204">Set userName to an account that is a member of the PhoneFactor Admins security group.</span><span class="sxs-lookup"><span data-stu-id="398ff-204">Set userName to an account that is a member of the PhoneFactor Admins security group.</span></span> <span data-ttu-id="398ff-205">Use the &lt;domain&gt;&#92;&lt;user name&gt; format.</span><span class="sxs-lookup"><span data-stu-id="398ff-205">Use the &lt;domain&gt;&#92;&lt;user name&gt; format.</span></span>  
15. <span data-ttu-id="398ff-206">Set the password to the appropriate account password, and then close Configuration Editor.</span><span class="sxs-lookup"><span data-stu-id="398ff-206">Set the password to the appropriate account password, and then close Configuration Editor.</span></span>  
16. <span data-ttu-id="398ff-207">Click the **Apply** link.</span><span class="sxs-lookup"><span data-stu-id="398ff-207">Click the **Apply** link.</span></span>  
17. <span data-ttu-id="398ff-208">In the Web Service SDK virtual directory, double-click **Authentication**.</span><span class="sxs-lookup"><span data-stu-id="398ff-208">In the Web Service SDK virtual directory, double-click **Authentication**.</span></span>  
18. <span data-ttu-id="398ff-209">Verify that ASP.NET Impersonation and Basic Authentication are set to **Enabled**, and that all other items are set to **Disabled**.</span><span class="sxs-lookup"><span data-stu-id="398ff-209">Verify that ASP.NET Impersonation and Basic Authentication are set to **Enabled**, and that all other items are set to **Disabled**.</span></span>  
19. <span data-ttu-id="398ff-210">In the Web Service SDK virtual directory, double-click **SSL Settings**.</span><span class="sxs-lookup"><span data-stu-id="398ff-210">In the Web Service SDK virtual directory, double-click **SSL Settings**.</span></span>  
20. <span data-ttu-id="398ff-211">Set Client Certificates to **Accept**, and then click **Apply**.</span><span class="sxs-lookup"><span data-stu-id="398ff-211">Set Client Certificates to **Accept**, and then click **Apply**.</span></span>  
21. <span data-ttu-id="398ff-212">Copy the .pfx file you exported earlier to the server that is running the AD FS adapter.</span><span class="sxs-lookup"><span data-stu-id="398ff-212">Copy the .pfx file you exported earlier to the server that is running the AD FS adapter.</span></span>  
22. <span data-ttu-id="398ff-213">Import the .pfx file to the local computer personal certificate store.</span><span class="sxs-lookup"><span data-stu-id="398ff-213">Import the .pfx file to the local computer personal certificate store.</span></span>  
23. <span data-ttu-id="398ff-214">Right-click and select **Manage Private Keys**, and then grant read access to the account you used to sign in to the AD FS service.</span><span class="sxs-lookup"><span data-stu-id="398ff-214">Right-click and select **Manage Private Keys**, and then grant read access to the account you used to sign in to the AD FS service.</span></span>  
24. <span data-ttu-id="398ff-215">Open the client certificate and copy the thumbprint from the **Details** tab.</span><span class="sxs-lookup"><span data-stu-id="398ff-215">Open the client certificate and copy the thumbprint from the **Details** tab.</span></span>  
25. <span data-ttu-id="398ff-216">In the MultiFactorAuthenticationAdfsAdapter.config file, set **WebServiceSdkCertificateThumbprint** to the string copied in the previous step.</span><span class="sxs-lookup"><span data-stu-id="398ff-216">In the MultiFactorAuthenticationAdfsAdapter.config file, set **WebServiceSdkCertificateThumbprint** to the string copied in the previous step.</span></span>  

<span data-ttu-id="398ff-217">Finally, to register the adapter, run the \Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1 script in PowerShell.</span><span class="sxs-lookup"><span data-stu-id="398ff-217">Finally, to register the adapter, run the \Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1 script in PowerShell.</span></span> <span data-ttu-id="398ff-218">The adapter is registered as WindowsAzureMultiFactorAuthentication.</span><span class="sxs-lookup"><span data-stu-id="398ff-218">The adapter is registered as WindowsAzureMultiFactorAuthentication.</span></span> <span data-ttu-id="398ff-219">Restart the AD FS service for the registration to take effect.</span><span class="sxs-lookup"><span data-stu-id="398ff-219">Restart the AD FS service for the registration to take effect.</span></span>

## <a name="secure-azure-ad-resources-using-ad-fs"></a><span data-ttu-id="398ff-220">Secure Azure AD resources using AD FS</span><span class="sxs-lookup"><span data-stu-id="398ff-220">Secure Azure AD resources using AD FS</span></span>

<span data-ttu-id="398ff-221">To secure your cloud resource, set up a claims rule so that Active Directory Federation Services emits the multipleauthn claim when a user performs two-step verification successfully.</span><span class="sxs-lookup"><span data-stu-id="398ff-221">To secure your cloud resource, set up a claims rule so that Active Directory Federation Services emits the multipleauthn claim when a user performs two-step verification successfully.</span></span> <span data-ttu-id="398ff-222">This claim is passed on to Azure AD.</span><span class="sxs-lookup"><span data-stu-id="398ff-222">This claim is passed on to Azure AD.</span></span> <span data-ttu-id="398ff-223">Follow this procedure to walk through the steps:</span><span class="sxs-lookup"><span data-stu-id="398ff-223">Follow this procedure to walk through the steps:</span></span>

1. <span data-ttu-id="398ff-224">Open AD FS Management.</span><span class="sxs-lookup"><span data-stu-id="398ff-224">Open AD FS Management.</span></span>
2. <span data-ttu-id="398ff-225">On the left, select **Relying Party Trusts**.</span><span class="sxs-lookup"><span data-stu-id="398ff-225">On the left, select **Relying Party Trusts**.</span></span>
3. <span data-ttu-id="398ff-226">Right-click on **Microsoft Office 365 Identity Platform** and select **Edit Claim Rules…**</span><span class="sxs-lookup"><span data-stu-id="398ff-226">Right-click on **Microsoft Office 365 Identity Platform** and select **Edit Claim Rules…**</span></span>

   ![Cloud](./media/howto-mfaserver-adfs-2012/trustedip1.png)

4. <span data-ttu-id="398ff-228">On Issuance Transform Rules, click **Add Rule.**</span><span class="sxs-lookup"><span data-stu-id="398ff-228">On Issuance Transform Rules, click **Add Rule.**</span></span>

   ![Cloud](./media/howto-mfaserver-adfs-2012/trustedip2.png)

5. <span data-ttu-id="398ff-230">On the Add Transform Claim Rule Wizard, select **Pass Through or Filter an Incoming Claim** from the drop-down and click **Next**.</span><span class="sxs-lookup"><span data-stu-id="398ff-230">On the Add Transform Claim Rule Wizard, select **Pass Through or Filter an Incoming Claim** from the drop-down and click **Next**.</span></span>

   ![Cloud](./media/howto-mfaserver-adfs-2012/trustedip3.png)

6. <span data-ttu-id="398ff-232">Give your rule a name.</span><span class="sxs-lookup"><span data-stu-id="398ff-232">Give your rule a name.</span></span>
7. <span data-ttu-id="398ff-233">Select **Authentication Methods References** as the Incoming claim type.</span><span class="sxs-lookup"><span data-stu-id="398ff-233">Select **Authentication Methods References** as the Incoming claim type.</span></span>
8. <span data-ttu-id="398ff-234">Select **Pass through all claim values**.</span><span class="sxs-lookup"><span data-stu-id="398ff-234">Select **Pass through all claim values**.</span></span>
    <span data-ttu-id="398ff-235">![Add Transform Claim Rule Wizard](./media/howto-mfaserver-adfs-2012/configurewizard.png)</span><span class="sxs-lookup"><span data-stu-id="398ff-235">![Add Transform Claim Rule Wizard](./media/howto-mfaserver-adfs-2012/configurewizard.png)</span></span>
9. <span data-ttu-id="398ff-236">Click **Finish**.</span><span class="sxs-lookup"><span data-stu-id="398ff-236">Click **Finish**.</span></span> <span data-ttu-id="398ff-237">Close the AD FS Management console.</span><span class="sxs-lookup"><span data-stu-id="398ff-237">Close the AD FS Management console.</span></span>

## <a name="troubleshooting-logs"></a><span data-ttu-id="398ff-238">Troubleshooting logs</span><span class="sxs-lookup"><span data-stu-id="398ff-238">Troubleshooting logs</span></span>

<span data-ttu-id="398ff-239">To help with troubleshooting issues with the MFA Server AD FS Adapter use the steps that follow to enable additional logging.</span><span class="sxs-lookup"><span data-stu-id="398ff-239">To help with troubleshooting issues with the MFA Server AD FS Adapter use the steps that follow to enable additional logging.</span></span>

1. <span data-ttu-id="398ff-240">In the MFA Server interface, open the AD FS section, and check the **Enable logging** checkbox.</span><span class="sxs-lookup"><span data-stu-id="398ff-240">In the MFA Server interface, open the AD FS section, and check the **Enable logging** checkbox.</span></span>
2. <span data-ttu-id="398ff-241">On each AD FS server, use **regedit.exe** to create string value registry key `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Positive Networks\PhoneFactor\InstallPath` with value `C:\Program Files\Multi-Factor Authentication Server\` (or other directory of your choice).</span><span class="sxs-lookup"><span data-stu-id="398ff-241">On each AD FS server, use **regedit.exe** to create string value registry key `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Positive Networks\PhoneFactor\InstallPath` with value `C:\Program Files\Multi-Factor Authentication Server\` (or other directory of your choice).</span></span>  <span data-ttu-id="398ff-242">**Note, the trailing backslash is important.**</span><span class="sxs-lookup"><span data-stu-id="398ff-242">**Note, the trailing backslash is important.**</span></span>
3. <span data-ttu-id="398ff-243">Create `C:\Program Files\Multi-Factor Authentication Server\Logs` directory (or other directory as referenced in **Step 2**).</span><span class="sxs-lookup"><span data-stu-id="398ff-243">Create `C:\Program Files\Multi-Factor Authentication Server\Logs` directory (or other directory as referenced in **Step 2**).</span></span>
4. <span data-ttu-id="398ff-244">Grant Modify access on the Logs directory to the AD FS service account.</span><span class="sxs-lookup"><span data-stu-id="398ff-244">Grant Modify access on the Logs directory to the AD FS service account.</span></span>
5. <span data-ttu-id="398ff-245">Restart the AD FS service.</span><span class="sxs-lookup"><span data-stu-id="398ff-245">Restart the AD FS service.</span></span>
6. <span data-ttu-id="398ff-246">Verify that `MultiFactorAuthAdfsAdapter.log` file was created in the Logs directory.</span><span class="sxs-lookup"><span data-stu-id="398ff-246">Verify that `MultiFactorAuthAdfsAdapter.log` file was created in the Logs directory.</span></span>

## <a name="related-topics"></a><span data-ttu-id="398ff-247">Related topics</span><span class="sxs-lookup"><span data-stu-id="398ff-247">Related topics</span></span>

<span data-ttu-id="398ff-248">For troubleshooting help, see the [Azure Multi-Factor Authentication FAQs](multi-factor-authentication-faq.md)</span><span class="sxs-lookup"><span data-stu-id="398ff-248">For troubleshooting help, see the [Azure Multi-Factor Authentication FAQs](multi-factor-authentication-faq.md)</span></span>
