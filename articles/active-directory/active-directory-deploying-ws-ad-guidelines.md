---
title: Guidelines for Deploying Windows Server Active Directory on Azure Virtual Machines | Microsoft Docs
description: If you know how to deploy AD Domain Services and AD Federation Services on premises, learn how they work on Azure virtual machines.
services: active-directory
documentationcenter: ''
author: femila
manager: femila
editor: ''
ms.assetid: 04df4c46-e6b6-4754-960a-57b823d617fa
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 02/22/2017
ms.author: femila
ms.openlocfilehash: b6afe5e6ae73ee46da2b20dbc6a8fb91c84e4409
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44553217"
---
# <a name="guidelines-for-deploying-windows-server-active-directory-on-azure-virtual-machines"></a><span data-ttu-id="5126b-103">Guidelines for deploying Windows Server Active Directory on Azure virtual machines</span><span class="sxs-lookup"><span data-stu-id="5126b-103">Guidelines for deploying Windows Server Active Directory on Azure virtual machines</span></span>
<span data-ttu-id="5126b-104">This article explains the important differences between deploying Windows Server Active Directory Domain Services (AD DS) and Active Directory Federation Services (AD FS) on-premises versus deploying them on Microsoft Azure virtual machines.</span><span class="sxs-lookup"><span data-stu-id="5126b-104">This article explains the important differences between deploying Windows Server Active Directory Domain Services (AD DS) and Active Directory Federation Services (AD FS) on-premises versus deploying them on Microsoft Azure virtual machines.</span></span>

## <a name="scope-and-audience"></a><span data-ttu-id="5126b-105">Scope and audience</span><span class="sxs-lookup"><span data-stu-id="5126b-105">Scope and audience</span></span>
<span data-ttu-id="5126b-106">The article is intended for those already experienced with deploying Active Directory on-premises.</span><span class="sxs-lookup"><span data-stu-id="5126b-106">The article is intended for those already experienced with deploying Active Directory on-premises.</span></span> <span data-ttu-id="5126b-107">It covers the differences between deploying Active Directory on Microsoft Azure virtual machines/Azure virtual networks and traditional on-premises Active Directory deployments.</span><span class="sxs-lookup"><span data-stu-id="5126b-107">It covers the differences between deploying Active Directory on Microsoft Azure virtual machines/Azure virtual networks and traditional on-premises Active Directory deployments.</span></span> <span data-ttu-id="5126b-108">Azure virtual machines and Azure virtual networks are part of an Infrastructure-as-a-Service (IaaS) offering for organizations to leverage computing resources in the cloud.</span><span class="sxs-lookup"><span data-stu-id="5126b-108">Azure virtual machines and Azure virtual networks are part of an Infrastructure-as-a-Service (IaaS) offering for organizations to leverage computing resources in the cloud.</span></span>

<span data-ttu-id="5126b-109">For those that are not familiar with AD deployment, see the [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963) or [Plan your AD FS deployment](https://technet.microsoft.com/library/dn151324.aspx) as appropriate.</span><span class="sxs-lookup"><span data-stu-id="5126b-109">For those that are not familiar with AD deployment, see the [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963) or [Plan your AD FS deployment](https://technet.microsoft.com/library/dn151324.aspx) as appropriate.</span></span>

<span data-ttu-id="5126b-110">This article assumes that the reader is familiar with the following concepts:</span><span class="sxs-lookup"><span data-stu-id="5126b-110">This article assumes that the reader is familiar with the following concepts:</span></span>

* <span data-ttu-id="5126b-111">Windows Server AD DS deployment and management</span><span class="sxs-lookup"><span data-stu-id="5126b-111">Windows Server AD DS deployment and management</span></span>
* <span data-ttu-id="5126b-112">Deployment and configuration of DNS to support a Windows Server AD DS infrastructure</span><span class="sxs-lookup"><span data-stu-id="5126b-112">Deployment and configuration of DNS to support a Windows Server AD DS infrastructure</span></span>
* <span data-ttu-id="5126b-113">Windows Server AD FS deployment and management</span><span class="sxs-lookup"><span data-stu-id="5126b-113">Windows Server AD FS deployment and management</span></span>
* <span data-ttu-id="5126b-114">Deploying, configuring, and managing relying party applications (websites and web services) that can consume Windows Server AD FS tokens</span><span class="sxs-lookup"><span data-stu-id="5126b-114">Deploying, configuring, and managing relying party applications (websites and web services) that can consume Windows Server AD FS tokens</span></span>
* <span data-ttu-id="5126b-115">General virtual machine concepts, such as how to configure a virtual machine, virtual disks, and virtual networks</span><span class="sxs-lookup"><span data-stu-id="5126b-115">General virtual machine concepts, such as how to configure a virtual machine, virtual disks, and virtual networks</span></span>

<span data-ttu-id="5126b-116">This article highlights the requirements for a hybrid deployment scenario in which Windows Server AD DS or AD FS are partly deployed on-premises and partly deployed on Azure virtual machines.</span><span class="sxs-lookup"><span data-stu-id="5126b-116">This article highlights the requirements for a hybrid deployment scenario in which Windows Server AD DS or AD FS are partly deployed on-premises and partly deployed on Azure virtual machines.</span></span> <span data-ttu-id="5126b-117">The document first covers the critical differences between running Windows Server AD DS and AD FS on Azure virtual machines versus on-premises, and important decision points that affect design and deployment.</span><span class="sxs-lookup"><span data-stu-id="5126b-117">The document first covers the critical differences between running Windows Server AD DS and AD FS on Azure virtual machines versus on-premises, and important decision points that affect design and deployment.</span></span> <span data-ttu-id="5126b-118">The rest of the paper explains guidelines for each of the decision points in more detail, and how to apply the guidelines to various deployment scenarios.</span><span class="sxs-lookup"><span data-stu-id="5126b-118">The rest of the paper explains guidelines for each of the decision points in more detail, and how to apply the guidelines to various deployment scenarios.</span></span>

<span data-ttu-id="5126b-119">This article does not discuss the configuration of [Azure Active Directory](http://azure.microsoft.com/services/active-directory/), which is a REST-based service that provides identity management and access control capabilities for cloud applications.</span><span class="sxs-lookup"><span data-stu-id="5126b-119">This article does not discuss the configuration of [Azure Active Directory](http://azure.microsoft.com/services/active-directory/), which is a REST-based service that provides identity management and access control capabilities for cloud applications.</span></span> <span data-ttu-id="5126b-120">Azure Active Directory (Azure AD) and Windows Server AD DS are, however, designed to work together to provide an identity and access management solution for today’s hybrid IT environments and modern applications.</span><span class="sxs-lookup"><span data-stu-id="5126b-120">Azure Active Directory (Azure AD) and Windows Server AD DS are, however, designed to work together to provide an identity and access management solution for today’s hybrid IT environments and modern applications.</span></span> <span data-ttu-id="5126b-121">To help understand the differences and relationships between Windows Server AD DS and Azure AD, consider the following:</span><span class="sxs-lookup"><span data-stu-id="5126b-121">To help understand the differences and relationships between Windows Server AD DS and Azure AD, consider the following:</span></span>

1. <span data-ttu-id="5126b-122">You might run Windows Server AD DS in the cloud on Azure virtual machines when you are using Azure to extend your on-premises datacenter into the cloud.</span><span class="sxs-lookup"><span data-stu-id="5126b-122">You might run Windows Server AD DS in the cloud on Azure virtual machines when you are using Azure to extend your on-premises datacenter into the cloud.</span></span>
2. <span data-ttu-id="5126b-123">You might use Azure AD to give your users single sign-on to Software-as-a-Service (SaaS) applications.</span><span class="sxs-lookup"><span data-stu-id="5126b-123">You might use Azure AD to give your users single sign-on to Software-as-a-Service (SaaS) applications.</span></span> <span data-ttu-id="5126b-124">Microsoft Office 365 uses this technology, for example, and applications running on Azure or other cloud platforms can also use it.</span><span class="sxs-lookup"><span data-stu-id="5126b-124">Microsoft Office 365 uses this technology, for example, and applications running on Azure or other cloud platforms can also use it.</span></span>
3. <span data-ttu-id="5126b-125">You might use Azure AD (its Access Control Service) to let users sign in using identities from Facebook, Google, Microsoft, and other identity providers to applications that are hosted in the cloud or on-premises.</span><span class="sxs-lookup"><span data-stu-id="5126b-125">You might use Azure AD (its Access Control Service) to let users sign in using identities from Facebook, Google, Microsoft, and other identity providers to applications that are hosted in the cloud or on-premises.</span></span>

<span data-ttu-id="5126b-126">For more information about these differences, see [Azure Identity](fundamentals-identity.md).</span><span class="sxs-lookup"><span data-stu-id="5126b-126">For more information about these differences, see [Azure Identity](fundamentals-identity.md).</span></span>

## <a name="related-resources"></a><span data-ttu-id="5126b-127">Related resources</span><span class="sxs-lookup"><span data-stu-id="5126b-127">Related resources</span></span>
<span data-ttu-id="5126b-128">You may download and run the [Azure Virtual Machine Readiness Assessment](https://www.microsoft.com/download/details.aspx?id=40898).</span><span class="sxs-lookup"><span data-stu-id="5126b-128">You may download and run the [Azure Virtual Machine Readiness Assessment](https://www.microsoft.com/download/details.aspx?id=40898).</span></span> <span data-ttu-id="5126b-129">The assessment will automatically inspect your on-premises environment and generate a customized report based on the guidance found in this topic to help you migrate the environment to Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-129">The assessment will automatically inspect your on-premises environment and generate a customized report based on the guidance found in this topic to help you migrate the environment to Azure.</span></span>

<span data-ttu-id="5126b-130">We recommend that you also first review the tutorials, guides, and videos that cover the following topics:</span><span class="sxs-lookup"><span data-stu-id="5126b-130">We recommend that you also first review the tutorials, guides, and videos that cover the following topics:</span></span>

* [<span data-ttu-id="5126b-131">Configure a Cloud-Only Virtual Network in the Azure Portal</span><span class="sxs-lookup"><span data-stu-id="5126b-131">Configure a Cloud-Only Virtual Network in the Azure Portal</span></span>](../virtual-network/virtual-networks-create-vnet-arm-pportal.md)
* [<span data-ttu-id="5126b-132">Configure a Site-to-Site VPN in the Azure Portal</span><span class="sxs-lookup"><span data-stu-id="5126b-132">Configure a Site-to-Site VPN in the Azure Portal</span></span>](../vpn-gateway/vpn-gateway-site-to-site-create.md)
* [<span data-ttu-id="5126b-133">Install a new Active Directory forest on an Azure virtual network</span><span class="sxs-lookup"><span data-stu-id="5126b-133">Install a new Active Directory forest on an Azure virtual network</span></span>](active-directory-new-forest-virtual-machine.md)
* [<span data-ttu-id="5126b-134">Install a replica Active Directory domain controller on Azure</span><span class="sxs-lookup"><span data-stu-id="5126b-134">Install a replica Active Directory domain controller on Azure</span></span>](active-directory-install-replica-active-directory-domain-controller.md)
* [<span data-ttu-id="5126b-135">Microsoft Azure IT Pro IaaS: (01) Virtual Machine Fundamentals</span><span class="sxs-lookup"><span data-stu-id="5126b-135">Microsoft Azure IT Pro IaaS: (01) Virtual Machine Fundamentals</span></span>](https://channel9.msdn.com/Series/Windows-Azure-IT-Pro-IaaS/01)
* [<span data-ttu-id="5126b-136">Microsoft Azure IT Pro IaaS: (05) Creating Virtual Networks and Cross-Premises Connectivity</span><span class="sxs-lookup"><span data-stu-id="5126b-136">Microsoft Azure IT Pro IaaS: (05) Creating Virtual Networks and Cross-Premises Connectivity</span></span>](https://channel9.msdn.com/Series/Windows-Azure-IT-Pro-IaaS/05)

## <a name="introduction"></a><span data-ttu-id="5126b-137">Introduction</span><span class="sxs-lookup"><span data-stu-id="5126b-137">Introduction</span></span>
<span data-ttu-id="5126b-138">The fundamental requirements for deploying Windows Server Active Directory on Azure virtual machines differ very little from deploying it in on-premises virtual machines (and, to some extent, physical machines).</span><span class="sxs-lookup"><span data-stu-id="5126b-138">The fundamental requirements for deploying Windows Server Active Directory on Azure virtual machines differ very little from deploying it in on-premises virtual machines (and, to some extent, physical machines).</span></span> <span data-ttu-id="5126b-139">For example, in the case of Windows Server AD DS, if the domain controllers (DCs) that you deploy on Azure virtual machines are replicas in an existing on-premises corporate domain/forest, then the Azure deployment can largely be treated in the same way as you might treat any other additional Windows Server Active Directory site.</span><span class="sxs-lookup"><span data-stu-id="5126b-139">For example, in the case of Windows Server AD DS, if the domain controllers (DCs) that you deploy on Azure virtual machines are replicas in an existing on-premises corporate domain/forest, then the Azure deployment can largely be treated in the same way as you might treat any other additional Windows Server Active Directory site.</span></span> <span data-ttu-id="5126b-140">That is, subnets must be defined in Windows Server AD DS, a site created, the subnets linked to that site, and connected to other sites using appropriate site-links.</span><span class="sxs-lookup"><span data-stu-id="5126b-140">That is, subnets must be defined in Windows Server AD DS, a site created, the subnets linked to that site, and connected to other sites using appropriate site-links.</span></span> <span data-ttu-id="5126b-141">There are, however, some differences that are common to all Azure deployments and some that vary according to the specific deployment scenario.</span><span class="sxs-lookup"><span data-stu-id="5126b-141">There are, however, some differences that are common to all Azure deployments and some that vary according to the specific deployment scenario.</span></span> <span data-ttu-id="5126b-142">Two fundamental differences are outlined below:</span><span class="sxs-lookup"><span data-stu-id="5126b-142">Two fundamental differences are outlined below:</span></span>

### <a name="azure-virtual-machines-may-need-connectivity-to-the-on-premises-corporate-network"></a><span data-ttu-id="5126b-143">Azure virtual machines may need connectivity to the on-premises corporate network.</span><span class="sxs-lookup"><span data-stu-id="5126b-143">Azure virtual machines may need connectivity to the on-premises corporate network.</span></span>
<span data-ttu-id="5126b-144">Connecting Azure virtual machines back to an on-premises corporate network requires Azure virtual network, which includes a site-to-site or site-to-point virtual private network (VPN) component able to seamlessly connect Azure virtual machines and on-premises machines.</span><span class="sxs-lookup"><span data-stu-id="5126b-144">Connecting Azure virtual machines back to an on-premises corporate network requires Azure virtual network, which includes a site-to-site or site-to-point virtual private network (VPN) component able to seamlessly connect Azure virtual machines and on-premises machines.</span></span> <span data-ttu-id="5126b-145">This VPN component could also enable on-premises domain member computers to access a Windows Server Active Directory domain whose domain controllers are hosted exclusively on Azure virtual machines.</span><span class="sxs-lookup"><span data-stu-id="5126b-145">This VPN component could also enable on-premises domain member computers to access a Windows Server Active Directory domain whose domain controllers are hosted exclusively on Azure virtual machines.</span></span> <span data-ttu-id="5126b-146">It is important to note, though, that if the VPN fails, authentication and other operations that depend on Windows Server Active Directory will also fail.</span><span class="sxs-lookup"><span data-stu-id="5126b-146">It is important to note, though, that if the VPN fails, authentication and other operations that depend on Windows Server Active Directory will also fail.</span></span> <span data-ttu-id="5126b-147">While users may be able to sign in using existing cached credentials, all peer-to-peer or client-to-server authentication attempts for which tickets have yet to be issued or have become stale will fail.</span><span class="sxs-lookup"><span data-stu-id="5126b-147">While users may be able to sign in using existing cached credentials, all peer-to-peer or client-to-server authentication attempts for which tickets have yet to be issued or have become stale will fail.</span></span>

<span data-ttu-id="5126b-148">See [Virtual Network](http://azure.microsoft.com/documentation/services/virtual-network/) for a demonstration video and a list of step-by-step tutorials, including [Configure a Site-to-Site VPN in the Azure portal](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span><span class="sxs-lookup"><span data-stu-id="5126b-148">See [Virtual Network](http://azure.microsoft.com/documentation/services/virtual-network/) for a demonstration video and a list of step-by-step tutorials, including [Configure a Site-to-Site VPN in the Azure portal](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>

> [!NOTE]
> <span data-ttu-id="5126b-149">You can also deploy Windows Server Active Directory on an Azure virtual network that does not have connectivity with an on-premises network.</span><span class="sxs-lookup"><span data-stu-id="5126b-149">You can also deploy Windows Server Active Directory on an Azure virtual network that does not have connectivity with an on-premises network.</span></span> <span data-ttu-id="5126b-150">The guidelines in this topic, however, assume that an Azure virtual network is used because it provides IP addressing capabilities that are essential to Windows Server.</span><span class="sxs-lookup"><span data-stu-id="5126b-150">The guidelines in this topic, however, assume that an Azure virtual network is used because it provides IP addressing capabilities that are essential to Windows Server.</span></span>
> 
> 

### <a name="static-ip-addresses-must-be-configured-with-azure-powershell"></a><span data-ttu-id="5126b-151">Static IP addresses must be configured with Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="5126b-151">Static IP addresses must be configured with Azure PowerShell.</span></span>
<span data-ttu-id="5126b-152">Dynamic addresses are allocated by default, but use the Set-AzureStaticVNetIP cmdlet to assign a static IP address instead.</span><span class="sxs-lookup"><span data-stu-id="5126b-152">Dynamic addresses are allocated by default, but use the Set-AzureStaticVNetIP cmdlet to assign a static IP address instead.</span></span> <span data-ttu-id="5126b-153">That sets a static IP address that will persist through service healing and VM shutdown/restart.</span><span class="sxs-lookup"><span data-stu-id="5126b-153">That sets a static IP address that will persist through service healing and VM shutdown/restart.</span></span> <span data-ttu-id="5126b-154">For more information, see [Static internal IP address for virtual machines](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/).</span><span class="sxs-lookup"><span data-stu-id="5126b-154">For more information, see [Static internal IP address for virtual machines](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/).</span></span>

## <a name="BKMK_Glossary"></a><span data-ttu-id="5126b-155">Terms and definitions</span><span class="sxs-lookup"><span data-stu-id="5126b-155">Terms and definitions</span></span>
<span data-ttu-id="5126b-156">The following is a non-exhaustive list of terms for various Azure technologies which will be referenced in this article.</span><span class="sxs-lookup"><span data-stu-id="5126b-156">The following is a non-exhaustive list of terms for various Azure technologies which will be referenced in this article.</span></span>

* <span data-ttu-id="5126b-157">**Azure virtual machines**: The IaaS offering in Azure that allows customers to deploy VMs running nearly any traditionally on-premises server workload.</span><span class="sxs-lookup"><span data-stu-id="5126b-157">**Azure virtual machines**: The IaaS offering in Azure that allows customers to deploy VMs running nearly any traditionally on-premises server workload.</span></span>
* <span data-ttu-id="5126b-158">**Azure virtual network**: The networking service in Azure that lets customers create and manage virtual networks in Azure and securely link them to their own on-premises networking infrastructure by using a virtual private network (VPN).</span><span class="sxs-lookup"><span data-stu-id="5126b-158">**Azure virtual network**: The networking service in Azure that lets customers create and manage virtual networks in Azure and securely link them to their own on-premises networking infrastructure by using a virtual private network (VPN).</span></span>
* <span data-ttu-id="5126b-159">**Virtual IP address**: An internet-facing IP address that is not bound to a specific computer or network interface card.</span><span class="sxs-lookup"><span data-stu-id="5126b-159">**Virtual IP address**: An internet-facing IP address that is not bound to a specific computer or network interface card.</span></span> <span data-ttu-id="5126b-160">Cloud services are assigned a virtual IP address for receiving network traffic which is redirected to an Azure VM.</span><span class="sxs-lookup"><span data-stu-id="5126b-160">Cloud services are assigned a virtual IP address for receiving network traffic which is redirected to an Azure VM.</span></span> <span data-ttu-id="5126b-161">A virtual IP address is a property of a cloud-service which can contain one or more Azure virtual machines.</span><span class="sxs-lookup"><span data-stu-id="5126b-161">A virtual IP address is a property of a cloud-service which can contain one or more Azure virtual machines.</span></span> <span data-ttu-id="5126b-162">Also note that an Azure virtual network can contain one or more cloud-services.</span><span class="sxs-lookup"><span data-stu-id="5126b-162">Also note that an Azure virtual network can contain one or more cloud-services.</span></span> <span data-ttu-id="5126b-163">Virtual IP addresses provide native load-balancing capabilities.</span><span class="sxs-lookup"><span data-stu-id="5126b-163">Virtual IP addresses provide native load-balancing capabilities.</span></span>
* <span data-ttu-id="5126b-164">**Dynamic IP address**: This is the IP address that is internal only.</span><span class="sxs-lookup"><span data-stu-id="5126b-164">**Dynamic IP address**: This is the IP address that is internal only.</span></span> <span data-ttu-id="5126b-165">It should be configured as a static IP address (by using the Set-AzureStaticVNetIP cmdlet) for VMs that host the DC/DNS server roles.</span><span class="sxs-lookup"><span data-stu-id="5126b-165">It should be configured as a static IP address (by using the Set-AzureStaticVNetIP cmdlet) for VMs that host the DC/DNS server roles.</span></span>
* <span data-ttu-id="5126b-166">**Service healing**: The process in which Azure automatically returns a service to a running state again after it detects that the service has failed.</span><span class="sxs-lookup"><span data-stu-id="5126b-166">**Service healing**: The process in which Azure automatically returns a service to a running state again after it detects that the service has failed.</span></span> <span data-ttu-id="5126b-167">Service healing is one of the aspects of Azure that supports availability and resiliency.</span><span class="sxs-lookup"><span data-stu-id="5126b-167">Service healing is one of the aspects of Azure that supports availability and resiliency.</span></span> <span data-ttu-id="5126b-168">While unlikely, the result following a service healing incident for a DC running on a VM is similar to an unplanned reboot, but has a few side-effects:</span><span class="sxs-lookup"><span data-stu-id="5126b-168">While unlikely, the result following a service healing incident for a DC running on a VM is similar to an unplanned reboot, but has a few side-effects:</span></span>
  
  * <span data-ttu-id="5126b-169">The virtual network adapter in the VM will change</span><span class="sxs-lookup"><span data-stu-id="5126b-169">The virtual network adapter in the VM will change</span></span>
  * <span data-ttu-id="5126b-170">The MAC address of the virtual network adapter will change</span><span class="sxs-lookup"><span data-stu-id="5126b-170">The MAC address of the virtual network adapter will change</span></span>
  * <span data-ttu-id="5126b-171">The Processor/CPU ID of the VM will change</span><span class="sxs-lookup"><span data-stu-id="5126b-171">The Processor/CPU ID of the VM will change</span></span>
  * <span data-ttu-id="5126b-172">The IP configuration of the virtual network adapter will not change as long as the VM is attached to a virtual network and the VM’s IP address is static.</span><span class="sxs-lookup"><span data-stu-id="5126b-172">The IP configuration of the virtual network adapter will not change as long as the VM is attached to a virtual network and the VM’s IP address is static.</span></span>
  
  <span data-ttu-id="5126b-173">None of these behaviors affect Windows Server Active Directory because it has no dependency on the MAC address or Processor/CPU ID, and all Windows Server Active Directory deployments on Azure are recommended to be run on an Azure virtual network as outlined above.</span><span class="sxs-lookup"><span data-stu-id="5126b-173">None of these behaviors affect Windows Server Active Directory because it has no dependency on the MAC address or Processor/CPU ID, and all Windows Server Active Directory deployments on Azure are recommended to be run on an Azure virtual network as outlined above.</span></span>

## <a name="is-it-safe-to-virtualize-windows-server-active-directory-domain-controllers"></a><span data-ttu-id="5126b-174">Is it safe to virtualize Windows Server Active Directory domain controllers?</span><span class="sxs-lookup"><span data-stu-id="5126b-174">Is it safe to virtualize Windows Server Active Directory domain controllers?</span></span>
<span data-ttu-id="5126b-175">Deploying Windows Server Active Directory DCs on Azure virtual machines is subject to the same guidelines as running DCs on-premises in a virtual machine.</span><span class="sxs-lookup"><span data-stu-id="5126b-175">Deploying Windows Server Active Directory DCs on Azure virtual machines is subject to the same guidelines as running DCs on-premises in a virtual machine.</span></span> <span data-ttu-id="5126b-176">Running virtualized DCs is a safe practice as long as guidelines for backing up and restoring DCs are followed.</span><span class="sxs-lookup"><span data-stu-id="5126b-176">Running virtualized DCs is a safe practice as long as guidelines for backing up and restoring DCs are followed.</span></span> <span data-ttu-id="5126b-177">For more information about constraints and guidelines for running virtualized DCs, see [Running Domain Controllers in Hyper-V](https://technet.microsoft.com/library/dd363553).</span><span class="sxs-lookup"><span data-stu-id="5126b-177">For more information about constraints and guidelines for running virtualized DCs, see [Running Domain Controllers in Hyper-V](https://technet.microsoft.com/library/dd363553).</span></span>

<span data-ttu-id="5126b-178">Hypervisors provide or trivialize technologies that can cause problems for many distributed systems, including Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="5126b-178">Hypervisors provide or trivialize technologies that can cause problems for many distributed systems, including Windows Server Active Directory.</span></span> <span data-ttu-id="5126b-179">For example, on a physical server, you can clone a disk or use unsupported methods to roll back the state of a server, including using SANs and so on, but doing that on a physical server is much harder than restoring a virtual machine snapshot in a hypervisor.</span><span class="sxs-lookup"><span data-stu-id="5126b-179">For example, on a physical server, you can clone a disk or use unsupported methods to roll back the state of a server, including using SANs and so on, but doing that on a physical server is much harder than restoring a virtual machine snapshot in a hypervisor.</span></span> <span data-ttu-id="5126b-180">Azure offers functionality that can result in the same undesirable condition.</span><span class="sxs-lookup"><span data-stu-id="5126b-180">Azure offers functionality that can result in the same undesirable condition.</span></span> <span data-ttu-id="5126b-181">For example, you should not copy VHD files of DCs instead of performing regular backups because restoring them can result in a similar situation to using snapshot restore features.</span><span class="sxs-lookup"><span data-stu-id="5126b-181">For example, you should not copy VHD files of DCs instead of performing regular backups because restoring them can result in a similar situation to using snapshot restore features.</span></span>

<span data-ttu-id="5126b-182">Such rollbacks introduce USN bubbles that can lead to permanently divergent states between DCs.</span><span class="sxs-lookup"><span data-stu-id="5126b-182">Such rollbacks introduce USN bubbles that can lead to permanently divergent states between DCs.</span></span> <span data-ttu-id="5126b-183">That can cause issues such as:</span><span class="sxs-lookup"><span data-stu-id="5126b-183">That can cause issues such as:</span></span>

* <span data-ttu-id="5126b-184">Lingering objects</span><span class="sxs-lookup"><span data-stu-id="5126b-184">Lingering objects</span></span>
* <span data-ttu-id="5126b-185">Inconsistent passwords</span><span class="sxs-lookup"><span data-stu-id="5126b-185">Inconsistent passwords</span></span>
* <span data-ttu-id="5126b-186">Inconsistent attribute values</span><span class="sxs-lookup"><span data-stu-id="5126b-186">Inconsistent attribute values</span></span>
* <span data-ttu-id="5126b-187">Schema mismatches if the schema master is rolled back</span><span class="sxs-lookup"><span data-stu-id="5126b-187">Schema mismatches if the schema master is rolled back</span></span>

<span data-ttu-id="5126b-188">For more information about how DCs are impacted, see [USN and USN Rollback](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx#usn_and_usn_rollback).</span><span class="sxs-lookup"><span data-stu-id="5126b-188">For more information about how DCs are impacted, see [USN and USN Rollback](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx#usn_and_usn_rollback).</span></span>

<span data-ttu-id="5126b-189">Beginning with Windows Server 2012, [additional safeguards are built in to AD DS](https://technet.microsoft.com/library/hh831734.aspx).</span><span class="sxs-lookup"><span data-stu-id="5126b-189">Beginning with Windows Server 2012, [additional safeguards are built in to AD DS](https://technet.microsoft.com/library/hh831734.aspx).</span></span> <span data-ttu-id="5126b-190">These safeguards help protect virtualized domain controllers against the aforementioned problems, as long as the underlying hypervisor platform supports VM-GenerationID.</span><span class="sxs-lookup"><span data-stu-id="5126b-190">These safeguards help protect virtualized domain controllers against the aforementioned problems, as long as the underlying hypervisor platform supports VM-GenerationID.</span></span> <span data-ttu-id="5126b-191">Azure supports VM-GenerationID, which means that domain controllers that run Windows Server 2012 or later on Azure virtual machines have the additional safeguards.</span><span class="sxs-lookup"><span data-stu-id="5126b-191">Azure supports VM-GenerationID, which means that domain controllers that run Windows Server 2012 or later on Azure virtual machines have the additional safeguards.</span></span>

> [!NOTE]
> <span data-ttu-id="5126b-192">You should shut down and restart a VM that runs the domain controller role in Azure within the guest operating system instead of using the **Shut Down** option in the Azure portal or classic portal.</span><span class="sxs-lookup"><span data-stu-id="5126b-192">You should shut down and restart a VM that runs the domain controller role in Azure within the guest operating system instead of using the **Shut Down** option in the Azure portal or classic portal.</span></span> <span data-ttu-id="5126b-193">Today, using the portal to shut down a VM causes the VM to be deallocated.</span><span class="sxs-lookup"><span data-stu-id="5126b-193">Today, using the portal to shut down a VM causes the VM to be deallocated.</span></span> <span data-ttu-id="5126b-194">A deallocated VM has the advantage of not incurring charges, but it also resets the VM-GenerationID, which is undesirable for a DC.</span><span class="sxs-lookup"><span data-stu-id="5126b-194">A deallocated VM has the advantage of not incurring charges, but it also resets the VM-GenerationID, which is undesirable for a DC.</span></span> <span data-ttu-id="5126b-195">When the VM-GenerationID is reset, the invocationID of the AD DS database is also reset, the RID pool is discarded, and SYSVOL is marked as non-authoritative.</span><span class="sxs-lookup"><span data-stu-id="5126b-195">When the VM-GenerationID is reset, the invocationID of the AD DS database is also reset, the RID pool is discarded, and SYSVOL is marked as non-authoritative.</span></span> <span data-ttu-id="5126b-196">For more information, see [Introduction to Active Directory Domain Services (AD DS) Virtualization](https://technet.microsoft.com/library/hh831734.aspx) and [Safely Virtualizing DFSR](http://blogs.technet.com/b/filecab/archive/2013/04/05/safely-virtualizing-dfsr.aspx).</span><span class="sxs-lookup"><span data-stu-id="5126b-196">For more information, see [Introduction to Active Directory Domain Services (AD DS) Virtualization](https://technet.microsoft.com/library/hh831734.aspx) and [Safely Virtualizing DFSR](http://blogs.technet.com/b/filecab/archive/2013/04/05/safely-virtualizing-dfsr.aspx).</span></span>
> 
> 

## <a name="why-deploy-windows-server-ad-ds-on-azure-virtual-machines"></a><span data-ttu-id="5126b-197">Why deploy Windows Server AD DS on Azure Virtual Machines?</span><span class="sxs-lookup"><span data-stu-id="5126b-197">Why deploy Windows Server AD DS on Azure Virtual Machines?</span></span>
<span data-ttu-id="5126b-198">Many Windows Server AD DS deployment scenarios are well-suited for deployment as VMs on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-198">Many Windows Server AD DS deployment scenarios are well-suited for deployment as VMs on Azure.</span></span> <span data-ttu-id="5126b-199">For example, suppose you have a company in Europe that needs to authenticate users in a remote location in Asia.</span><span class="sxs-lookup"><span data-stu-id="5126b-199">For example, suppose you have a company in Europe that needs to authenticate users in a remote location in Asia.</span></span> <span data-ttu-id="5126b-200">The company has not previously deployed Windows Server Active Directory DCs in Asia due to the cost to deploy them and limited expertise to manage the servers post-deployment.</span><span class="sxs-lookup"><span data-stu-id="5126b-200">The company has not previously deployed Windows Server Active Directory DCs in Asia due to the cost to deploy them and limited expertise to manage the servers post-deployment.</span></span> <span data-ttu-id="5126b-201">As a result, authentication requests from Asia are serviced by DCs in Europe with suboptimal results.</span><span class="sxs-lookup"><span data-stu-id="5126b-201">As a result, authentication requests from Asia are serviced by DCs in Europe with suboptimal results.</span></span> <span data-ttu-id="5126b-202">In this case, you can deploy a DC on a VM that you have specified must be run within the Azure datacenter in Asia.</span><span class="sxs-lookup"><span data-stu-id="5126b-202">In this case, you can deploy a DC on a VM that you have specified must be run within the Azure datacenter in Asia.</span></span> <span data-ttu-id="5126b-203">Attaching that DC to an Azure virtual network that is connected directly to the remote location will improve authentication performance.</span><span class="sxs-lookup"><span data-stu-id="5126b-203">Attaching that DC to an Azure virtual network that is connected directly to the remote location will improve authentication performance.</span></span>

<span data-ttu-id="5126b-204">Azure is also well-suited as a substitute to otherwise costly disaster recovery (DR) sites.</span><span class="sxs-lookup"><span data-stu-id="5126b-204">Azure is also well-suited as a substitute to otherwise costly disaster recovery (DR) sites.</span></span> <span data-ttu-id="5126b-205">The relatively low-cost of hosting a small number of domain controllers and a single virtual network on Azure represents an attractive alternative.</span><span class="sxs-lookup"><span data-stu-id="5126b-205">The relatively low-cost of hosting a small number of domain controllers and a single virtual network on Azure represents an attractive alternative.</span></span>

<span data-ttu-id="5126b-206">Finally, you may want to deploy a network application on Azure, such as SharePoint, that requires Windows Server Active Directory but has no dependency on the on-premises network or the corporate Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="5126b-206">Finally, you may want to deploy a network application on Azure, such as SharePoint, that requires Windows Server Active Directory but has no dependency on the on-premises network or the corporate Windows Server Active Directory.</span></span> <span data-ttu-id="5126b-207">In this case, deploying an isolated forest on Azure to meet the SharePoint server’s requirements is optimal.</span><span class="sxs-lookup"><span data-stu-id="5126b-207">In this case, deploying an isolated forest on Azure to meet the SharePoint server’s requirements is optimal.</span></span> <span data-ttu-id="5126b-208">Again, deploying network applications that do require connectivity to the on-premises network and the corporate Active Directory is also supported.</span><span class="sxs-lookup"><span data-stu-id="5126b-208">Again, deploying network applications that do require connectivity to the on-premises network and the corporate Active Directory is also supported.</span></span>

> [!NOTE]
> <span data-ttu-id="5126b-209">Since it provides a layer-3 connection, the VPN component that provides connectivity between an Azure virtual network and an on-premises network can also enable member servers that run on-premises to leverage DCs that run as Azure virtual machines on Azure virtual network.</span><span class="sxs-lookup"><span data-stu-id="5126b-209">Since it provides a layer-3 connection, the VPN component that provides connectivity between an Azure virtual network and an on-premises network can also enable member servers that run on-premises to leverage DCs that run as Azure virtual machines on Azure virtual network.</span></span> <span data-ttu-id="5126b-210">But if the VPN is unavailable, communication between on-premises computers and Azure-based domain controllers will not function, resulting in authentication and various other errors.</span><span class="sxs-lookup"><span data-stu-id="5126b-210">But if the VPN is unavailable, communication between on-premises computers and Azure-based domain controllers will not function, resulting in authentication and various other errors.</span></span>  
> 
> 

## <a name="contrasts-between-deploying-windows-server-active-directory-domain-controllers-on-azure-virtual-machines-versus-on-premises"></a><span data-ttu-id="5126b-211">Contrasts between deploying Windows Server Active Directory domain controllers on Azure Virtual Machines versus on-premises</span><span class="sxs-lookup"><span data-stu-id="5126b-211">Contrasts between deploying Windows Server Active Directory domain controllers on Azure Virtual Machines versus on-premises</span></span>
* <span data-ttu-id="5126b-212">For any Windows Server Active Directory deployment scenario that includes more than a single VM, it is necessary to use an Azure virtual network for IP address consistency.</span><span class="sxs-lookup"><span data-stu-id="5126b-212">For any Windows Server Active Directory deployment scenario that includes more than a single VM, it is necessary to use an Azure virtual network for IP address consistency.</span></span> <span data-ttu-id="5126b-213">Note that this guide assumes that DCs are running on an Azure virtual network.</span><span class="sxs-lookup"><span data-stu-id="5126b-213">Note that this guide assumes that DCs are running on an Azure virtual network.</span></span>
* <span data-ttu-id="5126b-214">As with on-premises DCs, static IP addresses are recommended.</span><span class="sxs-lookup"><span data-stu-id="5126b-214">As with on-premises DCs, static IP addresses are recommended.</span></span> <span data-ttu-id="5126b-215">A static IP address can only be configured by using Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="5126b-215">A static IP address can only be configured by using Azure PowerShell.</span></span> <span data-ttu-id="5126b-216">See [Static internal IP address for VMs](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/) for more details.</span><span class="sxs-lookup"><span data-stu-id="5126b-216">See [Static internal IP address for VMs](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/) for more details.</span></span> <span data-ttu-id="5126b-217">If you have monitoring systems or other solutions that check for static IP address configuration within the guest operating system, you can assign the same static IP address to the network adapter properties of the VM.</span><span class="sxs-lookup"><span data-stu-id="5126b-217">If you have monitoring systems or other solutions that check for static IP address configuration within the guest operating system, you can assign the same static IP address to the network adapter properties of the VM.</span></span> <span data-ttu-id="5126b-218">But be aware that the network adapter will be discarded if the VM undergoes service healing or is shut down in the classic portal and has its address deallocated.</span><span class="sxs-lookup"><span data-stu-id="5126b-218">But be aware that the network adapter will be discarded if the VM undergoes service healing or is shut down in the classic portal and has its address deallocated.</span></span> <span data-ttu-id="5126b-219">In that case, the static IP address within the guest will need to be reset.</span><span class="sxs-lookup"><span data-stu-id="5126b-219">In that case, the static IP address within the guest will need to be reset.</span></span>
* <span data-ttu-id="5126b-220">Deploying VMs on a virtual network does not imply (or require) connectivity back to an on-premises network; the virtual network merely enables that possibility.</span><span class="sxs-lookup"><span data-stu-id="5126b-220">Deploying VMs on a virtual network does not imply (or require) connectivity back to an on-premises network; the virtual network merely enables that possibility.</span></span> <span data-ttu-id="5126b-221">You must create a virtual network for private communication between Azure and your on-premises network.</span><span class="sxs-lookup"><span data-stu-id="5126b-221">You must create a virtual network for private communication between Azure and your on-premises network.</span></span> <span data-ttu-id="5126b-222">You need to deploy a VPN endpoint on the on-premises network.</span><span class="sxs-lookup"><span data-stu-id="5126b-222">You need to deploy a VPN endpoint on the on-premises network.</span></span> <span data-ttu-id="5126b-223">The VPN is opened from Azure to the on-premises network.</span><span class="sxs-lookup"><span data-stu-id="5126b-223">The VPN is opened from Azure to the on-premises network.</span></span> <span data-ttu-id="5126b-224">For more information, see [Virtual Network Overview](../virtual-network/virtual-networks-overview.md) and [Configure a Site-to-Site VPN in the Azure Portal](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span><span class="sxs-lookup"><span data-stu-id="5126b-224">For more information, see [Virtual Network Overview](../virtual-network/virtual-networks-overview.md) and [Configure a Site-to-Site VPN in the Azure Portal](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>

> [!NOTE]
> <span data-ttu-id="5126b-225">An option to [create a point-to-site VPN](../vpn-gateway/vpn-gateway-point-to-site-create.md) is available to connect individual Windows-based computers directly to an Azure virtual network.</span><span class="sxs-lookup"><span data-stu-id="5126b-225">An option to [create a point-to-site VPN](../vpn-gateway/vpn-gateway-point-to-site-create.md) is available to connect individual Windows-based computers directly to an Azure virtual network.</span></span>
> 
> 

* <span data-ttu-id="5126b-226">Regardless of whether you create a virtual network or not, Azure charges for egress traffic but not ingress.</span><span class="sxs-lookup"><span data-stu-id="5126b-226">Regardless of whether you create a virtual network or not, Azure charges for egress traffic but not ingress.</span></span> <span data-ttu-id="5126b-227">Various Windows Server Active Directory design choices can affect how much egress traffic is generated by a deployment.</span><span class="sxs-lookup"><span data-stu-id="5126b-227">Various Windows Server Active Directory design choices can affect how much egress traffic is generated by a deployment.</span></span> <span data-ttu-id="5126b-228">For example, deploying a read-only domain controller (RODC) limits egress traffic because it does not replicate outbound.</span><span class="sxs-lookup"><span data-stu-id="5126b-228">For example, deploying a read-only domain controller (RODC) limits egress traffic because it does not replicate outbound.</span></span> <span data-ttu-id="5126b-229">But the decision to deploy an RODC needs to be weighed against the need to perform write operations against the DC and the [compatibility](https://technet.microsoft.com/library/cc755190) that applications and services in the site have with RODCs.</span><span class="sxs-lookup"><span data-stu-id="5126b-229">But the decision to deploy an RODC needs to be weighed against the need to perform write operations against the DC and the [compatibility](https://technet.microsoft.com/library/cc755190) that applications and services in the site have with RODCs.</span></span> <span data-ttu-id="5126b-230">For more information about traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span><span class="sxs-lookup"><span data-stu-id="5126b-230">For more information about traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span>
* <span data-ttu-id="5126b-231">While you have complete control over what server resources to use for VMs on-premises, such as RAM, disk size, and so on, on Azure you must select from a list of preconfigured server sizes.</span><span class="sxs-lookup"><span data-stu-id="5126b-231">While you have complete control over what server resources to use for VMs on-premises, such as RAM, disk size, and so on, on Azure you must select from a list of preconfigured server sizes.</span></span> <span data-ttu-id="5126b-232">For a DC, a data disk is needed in addition to the operating system disk in order to store the Windows Server Active Directory database.</span><span class="sxs-lookup"><span data-stu-id="5126b-232">For a DC, a data disk is needed in addition to the operating system disk in order to store the Windows Server Active Directory database.</span></span>

## <a name="can-you-deploy-windows-server-ad-fs-on-azure-virtual-machines"></a><span data-ttu-id="5126b-233">Can you deploy Windows Server AD FS on Azure virtual machines?</span><span class="sxs-lookup"><span data-stu-id="5126b-233">Can you deploy Windows Server AD FS on Azure virtual machines?</span></span>
<span data-ttu-id="5126b-234">Yes, you can deploy Windows Server AD FS on Azure virtual machines, and the [best practices for AD FS deployment](https://technet.microsoft.com/library/dn151324.aspx) on-premises apply equally to AD FS deployment on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-234">Yes, you can deploy Windows Server AD FS on Azure virtual machines, and the [best practices for AD FS deployment](https://technet.microsoft.com/library/dn151324.aspx) on-premises apply equally to AD FS deployment on Azure.</span></span> <span data-ttu-id="5126b-235">But some of the best practices such as load balancing and high availability require technologies beyond what AD FS offers itself.</span><span class="sxs-lookup"><span data-stu-id="5126b-235">But some of the best practices such as load balancing and high availability require technologies beyond what AD FS offers itself.</span></span> <span data-ttu-id="5126b-236">They must be provided by the underlying infrastructure.</span><span class="sxs-lookup"><span data-stu-id="5126b-236">They must be provided by the underlying infrastructure.</span></span> <span data-ttu-id="5126b-237">Let’s review some of those best practices and see how they can be achieved by using Azure VMs and an Azure virtual network.</span><span class="sxs-lookup"><span data-stu-id="5126b-237">Let’s review some of those best practices and see how they can be achieved by using Azure VMs and an Azure virtual network.</span></span>

1. <span data-ttu-id="5126b-238">**Never expose security token service (STS) servers directly to the Internet.**</span><span class="sxs-lookup"><span data-stu-id="5126b-238">**Never expose security token service (STS) servers directly to the Internet.**</span></span>
   
    <span data-ttu-id="5126b-239">This is important because the STS issues security tokens.</span><span class="sxs-lookup"><span data-stu-id="5126b-239">This is important because the STS issues security tokens.</span></span> <span data-ttu-id="5126b-240">As a result, STS servers such as AD FS servers should be treated with the same level of protection as a domain controller.</span><span class="sxs-lookup"><span data-stu-id="5126b-240">As a result, STS servers such as AD FS servers should be treated with the same level of protection as a domain controller.</span></span> <span data-ttu-id="5126b-241">If an STS is compromised, malicious users have the ability to issue access tokens potentially containing claims of their choosing to relying party applications and other STS servers in trusting organizations.</span><span class="sxs-lookup"><span data-stu-id="5126b-241">If an STS is compromised, malicious users have the ability to issue access tokens potentially containing claims of their choosing to relying party applications and other STS servers in trusting organizations.</span></span>
2. <span data-ttu-id="5126b-242">**Deploy Active Directory domain controllers for all user domains in the same network as the AD FS servers.**</span><span class="sxs-lookup"><span data-stu-id="5126b-242">**Deploy Active Directory domain controllers for all user domains in the same network as the AD FS servers.**</span></span>
   
    <span data-ttu-id="5126b-243">AD FS servers use Active Directory Domain Services to authenticate users.</span><span class="sxs-lookup"><span data-stu-id="5126b-243">AD FS servers use Active Directory Domain Services to authenticate users.</span></span> <span data-ttu-id="5126b-244">It is recommended to deploy domain controllers on the same network as the AD FS servers.</span><span class="sxs-lookup"><span data-stu-id="5126b-244">It is recommended to deploy domain controllers on the same network as the AD FS servers.</span></span> <span data-ttu-id="5126b-245">This provides business continuity in case the link between the Azure network and your on-premises network is broken, and enables lower latency and increased performance for logins.</span><span class="sxs-lookup"><span data-stu-id="5126b-245">This provides business continuity in case the link between the Azure network and your on-premises network is broken, and enables lower latency and increased performance for logins.</span></span>
3. <span data-ttu-id="5126b-246">**Deploy multiple AD FS nodes for high availability and balancing the load.**</span><span class="sxs-lookup"><span data-stu-id="5126b-246">**Deploy multiple AD FS nodes for high availability and balancing the load.**</span></span>
   
    <span data-ttu-id="5126b-247">In most cases, the failure of an application that AD FS enables is unacceptable because the applications that require security tokens are often mission critical.</span><span class="sxs-lookup"><span data-stu-id="5126b-247">In most cases, the failure of an application that AD FS enables is unacceptable because the applications that require security tokens are often mission critical.</span></span> <span data-ttu-id="5126b-248">As a result, and because AD FS now resides in the critical path to accessing mission critical applications, the AD FS service must be highly available through multiple AD FS proxies and AD FS servers.</span><span class="sxs-lookup"><span data-stu-id="5126b-248">As a result, and because AD FS now resides in the critical path to accessing mission critical applications, the AD FS service must be highly available through multiple AD FS proxies and AD FS servers.</span></span> <span data-ttu-id="5126b-249">To achieve distribution of requests, load balancers are typically deployed in front of both the AD FS Proxies and the AD FS servers.</span><span class="sxs-lookup"><span data-stu-id="5126b-249">To achieve distribution of requests, load balancers are typically deployed in front of both the AD FS Proxies and the AD FS servers.</span></span>
4. <span data-ttu-id="5126b-250">**Deploy one or more Web Application Proxy nodes for internet access.**</span><span class="sxs-lookup"><span data-stu-id="5126b-250">**Deploy one or more Web Application Proxy nodes for internet access.**</span></span>
   
    <span data-ttu-id="5126b-251">When users need to access applications protected by the AD FS service, the AD FS service needs to be available from the internet.</span><span class="sxs-lookup"><span data-stu-id="5126b-251">When users need to access applications protected by the AD FS service, the AD FS service needs to be available from the internet.</span></span> <span data-ttu-id="5126b-252">This is achieved by deploying the Web Application Proxy service.</span><span class="sxs-lookup"><span data-stu-id="5126b-252">This is achieved by deploying the Web Application Proxy service.</span></span> <span data-ttu-id="5126b-253">It is strongly recommended to deploy more than one node for the purposes of high availability and load balancing.</span><span class="sxs-lookup"><span data-stu-id="5126b-253">It is strongly recommended to deploy more than one node for the purposes of high availability and load balancing.</span></span>
5. <span data-ttu-id="5126b-254">**Restrict access from the Web Application Proxy nodes to internal network resources.**</span><span class="sxs-lookup"><span data-stu-id="5126b-254">**Restrict access from the Web Application Proxy nodes to internal network resources.**</span></span>
   
    <span data-ttu-id="5126b-255">To allow external users to access AD FS from the internet, you need to deploy Web Application Proxy nodes (or AD FS Proxy in earlier versions of Windows Server).</span><span class="sxs-lookup"><span data-stu-id="5126b-255">To allow external users to access AD FS from the internet, you need to deploy Web Application Proxy nodes (or AD FS Proxy in earlier versions of Windows Server).</span></span> <span data-ttu-id="5126b-256">The Web Application proxy nodes are directly exposed to the Internet.</span><span class="sxs-lookup"><span data-stu-id="5126b-256">The Web Application proxy nodes are directly exposed to the Internet.</span></span> <span data-ttu-id="5126b-257">They are not required to be domain-joined and they only need access to the AD FS servers over TCP ports 443 and 80.</span><span class="sxs-lookup"><span data-stu-id="5126b-257">They are not required to be domain-joined and they only need access to the AD FS servers over TCP ports 443 and 80.</span></span> <span data-ttu-id="5126b-258">It is strongly recommended that communication to all other computers (especially domain controllers) is blocked.</span><span class="sxs-lookup"><span data-stu-id="5126b-258">It is strongly recommended that communication to all other computers (especially domain controllers) is blocked.</span></span>
   
    <span data-ttu-id="5126b-259">This is typically achieved on-premises by means of a DMZ.</span><span class="sxs-lookup"><span data-stu-id="5126b-259">This is typically achieved on-premises by means of a DMZ.</span></span> <span data-ttu-id="5126b-260">Firewalls use a whitelist mode of operation to restrict traffic from the DMZ to the on-premises network (that is, only traffic from the specified IP addresses and over specified ports is allowed, and all other traffic is blocked).</span><span class="sxs-lookup"><span data-stu-id="5126b-260">Firewalls use a whitelist mode of operation to restrict traffic from the DMZ to the on-premises network (that is, only traffic from the specified IP addresses and over specified ports is allowed, and all other traffic is blocked).</span></span>

<span data-ttu-id="5126b-261">The following diagram shows a traditional on-premises AD FS deployment.</span><span class="sxs-lookup"><span data-stu-id="5126b-261">The following diagram shows a traditional on-premises AD FS deployment.</span></span>

![Diagram of a traditional on-premises Active Directory Federation Services deployment](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-deploying-ws-ad-guidelines/ADFS_onprem.png)

<span data-ttu-id="5126b-263">However, because Azure does not provide native, full-featured firewall capability, other options need to be used to restrict traffic.</span><span class="sxs-lookup"><span data-stu-id="5126b-263">However, because Azure does not provide native, full-featured firewall capability, other options need to be used to restrict traffic.</span></span> <span data-ttu-id="5126b-264">The following table shows each option and its advantages and disadvantages.</span><span class="sxs-lookup"><span data-stu-id="5126b-264">The following table shows each option and its advantages and disadvantages.</span></span>

| <span data-ttu-id="5126b-265">Option</span><span class="sxs-lookup"><span data-stu-id="5126b-265">Option</span></span> | <span data-ttu-id="5126b-266">Advantage</span><span class="sxs-lookup"><span data-stu-id="5126b-266">Advantage</span></span> | <span data-ttu-id="5126b-267">Disadvantage</span><span class="sxs-lookup"><span data-stu-id="5126b-267">Disadvantage</span></span> |
| --- | --- | --- |
| [<span data-ttu-id="5126b-268">Azure network ACLs</span><span class="sxs-lookup"><span data-stu-id="5126b-268">Azure network ACLs</span></span>](../virtual-network/virtual-networks-acl.md) |<span data-ttu-id="5126b-269">Less costly and simpler initial configuration</span><span class="sxs-lookup"><span data-stu-id="5126b-269">Less costly and simpler initial configuration</span></span> |<span data-ttu-id="5126b-270">Additional network ACL configuration required if any new VMs are added to the deployment</span><span class="sxs-lookup"><span data-stu-id="5126b-270">Additional network ACL configuration required if any new VMs are added to the deployment</span></span> |
| [<span data-ttu-id="5126b-271">Barracuda NG firewall</span><span class="sxs-lookup"><span data-stu-id="5126b-271">Barracuda NG firewall</span></span>](https://www.barracuda.com/products/ngfirewall) |<span data-ttu-id="5126b-272">Whitelist mode of operation and it requires no network ACL configuration</span><span class="sxs-lookup"><span data-stu-id="5126b-272">Whitelist mode of operation and it requires no network ACL configuration</span></span> |<span data-ttu-id="5126b-273">Increased cost and complexity for initial setup</span><span class="sxs-lookup"><span data-stu-id="5126b-273">Increased cost and complexity for initial setup</span></span> |

<span data-ttu-id="5126b-274">The high-level steps to deploy AD FS in this case are as follows:</span><span class="sxs-lookup"><span data-stu-id="5126b-274">The high-level steps to deploy AD FS in this case are as follows:</span></span>

1. <span data-ttu-id="5126b-275">Create a virtual network with cross-premises connectivity, using either a VPN or [ExpressRoute](http://azure.microsoft.com/services/expressroute/).</span><span class="sxs-lookup"><span data-stu-id="5126b-275">Create a virtual network with cross-premises connectivity, using either a VPN or [ExpressRoute](http://azure.microsoft.com/services/expressroute/).</span></span>
2. <span data-ttu-id="5126b-276">Deploy domain controllers on the virtual network.</span><span class="sxs-lookup"><span data-stu-id="5126b-276">Deploy domain controllers on the virtual network.</span></span> <span data-ttu-id="5126b-277">This step is optional but recommended.</span><span class="sxs-lookup"><span data-stu-id="5126b-277">This step is optional but recommended.</span></span>
3. <span data-ttu-id="5126b-278">Deploy domain-joined AD FS servers on the virtual network.</span><span class="sxs-lookup"><span data-stu-id="5126b-278">Deploy domain-joined AD FS servers on the virtual network.</span></span>
4. <span data-ttu-id="5126b-279">Create an [internal load balanced set](http://azure.microsoft.com/blog/internal-load-balancing/) that includes the AD FS servers and uses a new private IP address within the virtual network (a dynamic IP address).</span><span class="sxs-lookup"><span data-stu-id="5126b-279">Create an [internal load balanced set](http://azure.microsoft.com/blog/internal-load-balancing/) that includes the AD FS servers and uses a new private IP address within the virtual network (a dynamic IP address).</span></span>
   
   1. <span data-ttu-id="5126b-280">Update DNS to create the FQDN to point to the private (dynamic) IP address of the internal load balanced set.</span><span class="sxs-lookup"><span data-stu-id="5126b-280">Update DNS to create the FQDN to point to the private (dynamic) IP address of the internal load balanced set.</span></span>
5. <span data-ttu-id="5126b-281">Create a cloud service (or a separate virtual network) for the Web Application Proxy nodes.</span><span class="sxs-lookup"><span data-stu-id="5126b-281">Create a cloud service (or a separate virtual network) for the Web Application Proxy nodes.</span></span>
6. <span data-ttu-id="5126b-282">Deploy the Web Application Proxy nodes in the cloud service or virtual network</span><span class="sxs-lookup"><span data-stu-id="5126b-282">Deploy the Web Application Proxy nodes in the cloud service or virtual network</span></span>
   
   1. <span data-ttu-id="5126b-283">Create an external load balanced set that includes the Web Application Proxy nodes.</span><span class="sxs-lookup"><span data-stu-id="5126b-283">Create an external load balanced set that includes the Web Application Proxy nodes.</span></span>
   2. <span data-ttu-id="5126b-284">Update the external DNS name (FQDN) to point to the cloud service public IP address (the virtual IP address).</span><span class="sxs-lookup"><span data-stu-id="5126b-284">Update the external DNS name (FQDN) to point to the cloud service public IP address (the virtual IP address).</span></span>
   3. <span data-ttu-id="5126b-285">Configure AD FS proxies to use the FQDN that corresponds to the internal load balanced set for the AD FS servers.</span><span class="sxs-lookup"><span data-stu-id="5126b-285">Configure AD FS proxies to use the FQDN that corresponds to the internal load balanced set for the AD FS servers.</span></span>
   4. <span data-ttu-id="5126b-286">Update claims-based web sites to use the external FQDN for their claims provider.</span><span class="sxs-lookup"><span data-stu-id="5126b-286">Update claims-based web sites to use the external FQDN for their claims provider.</span></span>
7. <span data-ttu-id="5126b-287">Restrict access between Web Application Proxy to any machine in the AD FS virtual network.</span><span class="sxs-lookup"><span data-stu-id="5126b-287">Restrict access between Web Application Proxy to any machine in the AD FS virtual network.</span></span>

<span data-ttu-id="5126b-288">To restrict traffic, the load-balanced set for the Azure internal load balancer needs to be configured for only traffic to TCP ports 80 and 443, and all other traffic to the internal dynamic IP address of the load balanced set is dropped.</span><span class="sxs-lookup"><span data-stu-id="5126b-288">To restrict traffic, the load-balanced set for the Azure internal load balancer needs to be configured for only traffic to TCP ports 80 and 443, and all other traffic to the internal dynamic IP address of the load balanced set is dropped.</span></span>

![Diagram of ADFS Network ACLs with TCP 443 + 80 permitted.](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-deploying-ws-ad-guidelines/ADFS_ACLs.png)

<span data-ttu-id="5126b-290">Traffic to the AD FS servers would be permitted only by the following sources:</span><span class="sxs-lookup"><span data-stu-id="5126b-290">Traffic to the AD FS servers would be permitted only by the following sources:</span></span>

* <span data-ttu-id="5126b-291">The Azure internal load balancer.</span><span class="sxs-lookup"><span data-stu-id="5126b-291">The Azure internal load balancer.</span></span>
* <span data-ttu-id="5126b-292">The IP address of an administrator on the on-premises network.</span><span class="sxs-lookup"><span data-stu-id="5126b-292">The IP address of an administrator on the on-premises network.</span></span>

> [!WARNING]
> <span data-ttu-id="5126b-293">The design must prevent Web Application Proxy nodes from reaching any other VMs in the Azure virtual network or any locations on the on-premises network.</span><span class="sxs-lookup"><span data-stu-id="5126b-293">The design must prevent Web Application Proxy nodes from reaching any other VMs in the Azure virtual network or any locations on the on-premises network.</span></span> <span data-ttu-id="5126b-294">That can be done by configuring firewall rules in the on-premises appliance for Express Route connections or the VPN device for site-to-site VPN connections.</span><span class="sxs-lookup"><span data-stu-id="5126b-294">That can be done by configuring firewall rules in the on-premises appliance for Express Route connections or the VPN device for site-to-site VPN connections.</span></span>
> 
> 

<span data-ttu-id="5126b-295">A disadvantage to this option is the need to configure the network ACLs for multiple devices, including internal load balancer, the AD FS servers, and any other servers that get added to the virtual network.</span><span class="sxs-lookup"><span data-stu-id="5126b-295">A disadvantage to this option is the need to configure the network ACLs for multiple devices, including internal load balancer, the AD FS servers, and any other servers that get added to the virtual network.</span></span> <span data-ttu-id="5126b-296">If any device is added to the deployment without configuring network ACLs to restrict traffic to it, the entire deployment can be at risk.</span><span class="sxs-lookup"><span data-stu-id="5126b-296">If any device is added to the deployment without configuring network ACLs to restrict traffic to it, the entire deployment can be at risk.</span></span> <span data-ttu-id="5126b-297">If the IP addresses of the Web Application Proxy nodes ever change, the network ACLs must be reset (which means the proxies should be configured to use [static dynamic IP addresses](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/)).</span><span class="sxs-lookup"><span data-stu-id="5126b-297">If the IP addresses of the Web Application Proxy nodes ever change, the network ACLs must be reset (which means the proxies should be configured to use [static dynamic IP addresses](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/)).</span></span>

![ADFS on Azure with network ACLS.](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-deploying-ws-ad-guidelines/ADFS_Azure.png)

<span data-ttu-id="5126b-299">Another option is to use the [Barracuda NG Firewall](https://www.barracuda.com/products/ngfirewall) appliance to control traffic between AD FS proxy servers and the AD FS servers.</span><span class="sxs-lookup"><span data-stu-id="5126b-299">Another option is to use the [Barracuda NG Firewall](https://www.barracuda.com/products/ngfirewall) appliance to control traffic between AD FS proxy servers and the AD FS servers.</span></span> <span data-ttu-id="5126b-300">This option complies with best practices for security and high availability, and requires less administration after the initial setup because the Barracuda NG Firewall appliance provides a whitelist mode of firewall administration and it can be installed directly on an Azure virtual network.</span><span class="sxs-lookup"><span data-stu-id="5126b-300">This option complies with best practices for security and high availability, and requires less administration after the initial setup because the Barracuda NG Firewall appliance provides a whitelist mode of firewall administration and it can be installed directly on an Azure virtual network.</span></span> <span data-ttu-id="5126b-301">That eliminates the need to configure network ACLs any time a new server is added to the deployment.</span><span class="sxs-lookup"><span data-stu-id="5126b-301">That eliminates the need to configure network ACLs any time a new server is added to the deployment.</span></span> <span data-ttu-id="5126b-302">But this option adds initial deployment complexity and cost.</span><span class="sxs-lookup"><span data-stu-id="5126b-302">But this option adds initial deployment complexity and cost.</span></span>

<span data-ttu-id="5126b-303">In this case, two virtual networks are deployed instead of one.</span><span class="sxs-lookup"><span data-stu-id="5126b-303">In this case, two virtual networks are deployed instead of one.</span></span> <span data-ttu-id="5126b-304">We'll call them VNet1 and VNet2.</span><span class="sxs-lookup"><span data-stu-id="5126b-304">We'll call them VNet1 and VNet2.</span></span> <span data-ttu-id="5126b-305">VNet1 contains the proxies and VNet2 contains the STSs and the network connection back to the corporate network.</span><span class="sxs-lookup"><span data-stu-id="5126b-305">VNet1 contains the proxies and VNet2 contains the STSs and the network connection back to the corporate network.</span></span> <span data-ttu-id="5126b-306">VNet1 is therefore physically (albeit virtually) isolated from VNet2 and, in turn, from the corporate network.</span><span class="sxs-lookup"><span data-stu-id="5126b-306">VNet1 is therefore physically (albeit virtually) isolated from VNet2 and, in turn, from the corporate network.</span></span> <span data-ttu-id="5126b-307">VNet1 is then connected to VNet2 using a special tunneling technology known as Transport Independent Network Architecture (TINA).</span><span class="sxs-lookup"><span data-stu-id="5126b-307">VNet1 is then connected to VNet2 using a special tunneling technology known as Transport Independent Network Architecture (TINA).</span></span> <span data-ttu-id="5126b-308">The TINA tunnel is attached to each of the virtual networks using a Barracuda NG firewall—one Barracuda on each of the virtual networks.</span><span class="sxs-lookup"><span data-stu-id="5126b-308">The TINA tunnel is attached to each of the virtual networks using a Barracuda NG firewall—one Barracuda on each of the virtual networks.</span></span>  <span data-ttu-id="5126b-309">For high-availability, it is recommended that you deploy two Barracudas on each virtual network; one active, the other passive.</span><span class="sxs-lookup"><span data-stu-id="5126b-309">For high-availability, it is recommended that you deploy two Barracudas on each virtual network; one active, the other passive.</span></span> <span data-ttu-id="5126b-310">They offer extremely rich firewalling capabilities which allow us to mimic the operation of a traditional on-premises DMZ in Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-310">They offer extremely rich firewalling capabilities which allow us to mimic the operation of a traditional on-premises DMZ in Azure.</span></span>

![ADFS on Azure with firewall.](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-deploying-ws-ad-guidelines/ADFS_Azure_firewall.png)

<span data-ttu-id="5126b-312">For more information, see [AD FS: Extend a claims-aware on-premises front-end application to the Internet](#BKMK_CloudOnlyFed).</span><span class="sxs-lookup"><span data-stu-id="5126b-312">For more information, see [AD FS: Extend a claims-aware on-premises front-end application to the Internet](#BKMK_CloudOnlyFed).</span></span>

### <a name="an-alternative-to-ad-fs-deployment-if-the-goal-is-office-365-sso-alone"></a><span data-ttu-id="5126b-313">An alternative to AD FS deployment if the goal is Office 365 SSO alone</span><span class="sxs-lookup"><span data-stu-id="5126b-313">An alternative to AD FS deployment if the goal is Office 365 SSO alone</span></span>
<span data-ttu-id="5126b-314">There is another alternative to deploying AD FS altogether if your goal is only to enable sign-in for Office 365.</span><span class="sxs-lookup"><span data-stu-id="5126b-314">There is another alternative to deploying AD FS altogether if your goal is only to enable sign-in for Office 365.</span></span> <span data-ttu-id="5126b-315">In that case, you can simply deploy DirSync with password sync on-premises and achieve the same end-result with minimal deployment complexity because this approach does not require AD FS or Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-315">In that case, you can simply deploy DirSync with password sync on-premises and achieve the same end-result with minimal deployment complexity because this approach does not require AD FS or Azure.</span></span>

<span data-ttu-id="5126b-316">The following table compares how the sign-in processes work with and without deploying AD FS.</span><span class="sxs-lookup"><span data-stu-id="5126b-316">The following table compares how the sign-in processes work with and without deploying AD FS.</span></span>

| <span data-ttu-id="5126b-317">Office 365 single sign-on using AD FS and DirSync</span><span class="sxs-lookup"><span data-stu-id="5126b-317">Office 365 single sign-on using AD FS and DirSync</span></span> | <span data-ttu-id="5126b-318">Office 365 same sign-on using DirSync + Password Sync</span><span class="sxs-lookup"><span data-stu-id="5126b-318">Office 365 same sign-on using DirSync + Password Sync</span></span> |
| --- | --- |
| <span data-ttu-id="5126b-319">1. The user logs on to a corporate network, and is authenticated to Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="5126b-319">1. The user logs on to a corporate network, and is authenticated to Windows Server Active Directory.</span></span> |<span data-ttu-id="5126b-320">1. The user logs on to a corporate network, and is authenticated to Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="5126b-320">1. The user logs on to a corporate network, and is authenticated to Windows Server Active Directory.</span></span> |
| <span data-ttu-id="5126b-321">2. The user tries to access Office 365 (I am @contoso.com).</span><span class="sxs-lookup"><span data-stu-id="5126b-321">2. The user tries to access Office 365 (I am @contoso.com).</span></span> |<span data-ttu-id="5126b-322">2. The user tries to access Office 365 (I am @contoso.com).</span><span class="sxs-lookup"><span data-stu-id="5126b-322">2. The user tries to access Office 365 (I am @contoso.com).</span></span> |
| <span data-ttu-id="5126b-323">3. Office 365 redirects the user to Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5126b-323">3. Office 365 redirects the user to Azure AD.</span></span> |<span data-ttu-id="5126b-324">3. Office 365 redirects the user to Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5126b-324">3. Office 365 redirects the user to Azure AD.</span></span> |
| <span data-ttu-id="5126b-325">4. Since Azure AD can’t authenticate the user and understands there is a trust with AD FS on-premises, it redirects the user to AD FS.</span><span class="sxs-lookup"><span data-stu-id="5126b-325">4. Since Azure AD can’t authenticate the user and understands there is a trust with AD FS on-premises, it redirects the user to AD FS.</span></span> |<span data-ttu-id="5126b-326">4. Azure AD can’t accept Kerberos tickets directly and no trust relationship exists so it requests that the user enter credentials.</span><span class="sxs-lookup"><span data-stu-id="5126b-326">4. Azure AD can’t accept Kerberos tickets directly and no trust relationship exists so it requests that the user enter credentials.</span></span> |
| <span data-ttu-id="5126b-327">5. The user sends a Kerberos ticket to the AD FS STS.</span><span class="sxs-lookup"><span data-stu-id="5126b-327">5. The user sends a Kerberos ticket to the AD FS STS.</span></span> |<span data-ttu-id="5126b-328">5. The user enters the same on-premises password, and Azure AD validates them against the user name and password that was synchronized by DirSync.</span><span class="sxs-lookup"><span data-stu-id="5126b-328">5. The user enters the same on-premises password, and Azure AD validates them against the user name and password that was synchronized by DirSync.</span></span> |
| <span data-ttu-id="5126b-329">6. AD FS transforms the Kerberos ticket to the required token format/claims and redirects the user to Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5126b-329">6. AD FS transforms the Kerberos ticket to the required token format/claims and redirects the user to Azure AD.</span></span> |<span data-ttu-id="5126b-330">6. Azure AD redirects the user to Office 365.</span><span class="sxs-lookup"><span data-stu-id="5126b-330">6. Azure AD redirects the user to Office 365.</span></span> |
| <span data-ttu-id="5126b-331">7. The user authenticates to Azure AD (another transformation occurs).</span><span class="sxs-lookup"><span data-stu-id="5126b-331">7. The user authenticates to Azure AD (another transformation occurs).</span></span> |<span data-ttu-id="5126b-332">7. The user can sign in to Office 365 and OWA using the Azure AD token.</span><span class="sxs-lookup"><span data-stu-id="5126b-332">7. The user can sign in to Office 365 and OWA using the Azure AD token.</span></span> |
| <span data-ttu-id="5126b-333">8. Azure AD redirects the user to Office 365.</span><span class="sxs-lookup"><span data-stu-id="5126b-333">8. Azure AD redirects the user to Office 365.</span></span> | |
| <span data-ttu-id="5126b-334">9. The user is silently signed on to Office 365.</span><span class="sxs-lookup"><span data-stu-id="5126b-334">9. The user is silently signed on to Office 365.</span></span> | |

<span data-ttu-id="5126b-335">In the Office 365 with DirSync with password sync scenario (no AD FS), single sign-on is replaced by “same sign-on” where “same” simply means that users must re-enter their same on-premises credentials when accessing Office 365.</span><span class="sxs-lookup"><span data-stu-id="5126b-335">In the Office 365 with DirSync with password sync scenario (no AD FS), single sign-on is replaced by “same sign-on” where “same” simply means that users must re-enter their same on-premises credentials when accessing Office 365.</span></span> <span data-ttu-id="5126b-336">Note that this data can be remembered by the user’s browser to help reduce subsequent prompts.</span><span class="sxs-lookup"><span data-stu-id="5126b-336">Note that this data can be remembered by the user’s browser to help reduce subsequent prompts.</span></span>

### <a name="additional-food-for-thought"></a><span data-ttu-id="5126b-337">Additional food for thought</span><span class="sxs-lookup"><span data-stu-id="5126b-337">Additional food for thought</span></span>
* <span data-ttu-id="5126b-338">If you deploy an AD FS proxy on an Azure virtual machine, connectivity to the AD FS servers is needed.</span><span class="sxs-lookup"><span data-stu-id="5126b-338">If you deploy an AD FS proxy on an Azure virtual machine, connectivity to the AD FS servers is needed.</span></span> <span data-ttu-id="5126b-339">If they are on-premises, it is recommended that you leverage the site-to-site VPN connectivity provided by the virtual network to allow the Web Application Proxy nodes to communicate with their AD FS servers.</span><span class="sxs-lookup"><span data-stu-id="5126b-339">If they are on-premises, it is recommended that you leverage the site-to-site VPN connectivity provided by the virtual network to allow the Web Application Proxy nodes to communicate with their AD FS servers.</span></span>
* <span data-ttu-id="5126b-340">If you deploy an AD FS server on an Azure virtual machine, connectivity to Windows Server Active Directory domain controllers, Attribute Stores, and Configuration databases is necessary and may also require an ExpressRoute or a site-to-site VPN connection between the Azure virtual network and the on-premises network.</span><span class="sxs-lookup"><span data-stu-id="5126b-340">If you deploy an AD FS server on an Azure virtual machine, connectivity to Windows Server Active Directory domain controllers, Attribute Stores, and Configuration databases is necessary and may also require an ExpressRoute or a site-to-site VPN connection between the Azure virtual network and the on-premises network.</span></span>
* <span data-ttu-id="5126b-341">Charges are applied to all traffic from Azure virtual machines (egress traffic).</span><span class="sxs-lookup"><span data-stu-id="5126b-341">Charges are applied to all traffic from Azure virtual machines (egress traffic).</span></span> <span data-ttu-id="5126b-342">If cost is the driving factor, it is advisable to deploy the Web Application Proxy nodes on Azure, leaving the AD FS servers on-premises.</span><span class="sxs-lookup"><span data-stu-id="5126b-342">If cost is the driving factor, it is advisable to deploy the Web Application Proxy nodes on Azure, leaving the AD FS servers on-premises.</span></span> <span data-ttu-id="5126b-343">If the AD FS servers are deployed on Azure virtual machines as well, additional costs will be incurred to authenticate on-premises users.</span><span class="sxs-lookup"><span data-stu-id="5126b-343">If the AD FS servers are deployed on Azure virtual machines as well, additional costs will be incurred to authenticate on-premises users.</span></span> <span data-ttu-id="5126b-344">Egress traffic incurs a cost regardless of whether or not it is traversing the ExpressRoute or the VPN site-to-site connection.</span><span class="sxs-lookup"><span data-stu-id="5126b-344">Egress traffic incurs a cost regardless of whether or not it is traversing the ExpressRoute or the VPN site-to-site connection.</span></span>
* <span data-ttu-id="5126b-345">If you decide to use Azure’s native server load balancing capabilities for high availability of AD FS servers, note that load balancing provides probes that are used to determine the health of the virtual machines within the cloud service.</span><span class="sxs-lookup"><span data-stu-id="5126b-345">If you decide to use Azure’s native server load balancing capabilities for high availability of AD FS servers, note that load balancing provides probes that are used to determine the health of the virtual machines within the cloud service.</span></span> <span data-ttu-id="5126b-346">In the case of Azure virtual machines (as opposed to web or worker roles), a custom probe must be used since the agent that responds to the default probes is not present on Azure virtual machines.</span><span class="sxs-lookup"><span data-stu-id="5126b-346">In the case of Azure virtual machines (as opposed to web or worker roles), a custom probe must be used since the agent that responds to the default probes is not present on Azure virtual machines.</span></span> <span data-ttu-id="5126b-347">For simplicity, you might use a custom TCP probe — this requires only that a TCP connection (a TCP SYN segment sent and responded to with a TCP SYN ACK segment) be successfully established to determine virtual machine health.</span><span class="sxs-lookup"><span data-stu-id="5126b-347">For simplicity, you might use a custom TCP probe — this requires only that a TCP connection (a TCP SYN segment sent and responded to with a TCP SYN ACK segment) be successfully established to determine virtual machine health.</span></span> <span data-ttu-id="5126b-348">You can configure the custom probe to use any TCP port to which your virtual machines are actively listening.</span><span class="sxs-lookup"><span data-stu-id="5126b-348">You can configure the custom probe to use any TCP port to which your virtual machines are actively listening.</span></span>

> [!NOTE]
> <span data-ttu-id="5126b-349">Machines that need to expose the same set of ports directly to the Internet (such as port 80 and 443) cannot share the same cloud service.</span><span class="sxs-lookup"><span data-stu-id="5126b-349">Machines that need to expose the same set of ports directly to the Internet (such as port 80 and 443) cannot share the same cloud service.</span></span> <span data-ttu-id="5126b-350">It is, therefore, recommended that you create a dedicated cloud service for your Windows Server AD FS servers in order to avoid potential overlaps between port requirements for an application and Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="5126b-350">It is, therefore, recommended that you create a dedicated cloud service for your Windows Server AD FS servers in order to avoid potential overlaps between port requirements for an application and Windows Server AD FS.</span></span>
> 
> 

## <a name="deployment-scenarios"></a><span data-ttu-id="5126b-351">Deployment scenarios</span><span class="sxs-lookup"><span data-stu-id="5126b-351">Deployment scenarios</span></span>
<span data-ttu-id="5126b-352">The following section outlines commonplace deployment scenarios to draw attention to important considerations that must be taken into account.</span><span class="sxs-lookup"><span data-stu-id="5126b-352">The following section outlines commonplace deployment scenarios to draw attention to important considerations that must be taken into account.</span></span> <span data-ttu-id="5126b-353">Each scenario has links to more details about the decisions and factors to consider.</span><span class="sxs-lookup"><span data-stu-id="5126b-353">Each scenario has links to more details about the decisions and factors to consider.</span></span>

1. [<span data-ttu-id="5126b-354">AD DS: Deploy an AD DS-aware application with no requirement for corporate network connectivity</span><span class="sxs-lookup"><span data-stu-id="5126b-354">AD DS: Deploy an AD DS-aware application with no requirement for corporate network connectivity</span></span>](#BKMK_CloudOnly)
   
    <span data-ttu-id="5126b-355">For example, an Internet-facing SharePoint service is deployed on an Azure virtual machine.</span><span class="sxs-lookup"><span data-stu-id="5126b-355">For example, an Internet-facing SharePoint service is deployed on an Azure virtual machine.</span></span> <span data-ttu-id="5126b-356">The application has no dependencies on corporate-network resources.</span><span class="sxs-lookup"><span data-stu-id="5126b-356">The application has no dependencies on corporate-network resources.</span></span> <span data-ttu-id="5126b-357">The application does require Windows Server AD DS but does NOT require the corporate Windows Server AD DS.</span><span class="sxs-lookup"><span data-stu-id="5126b-357">The application does require Windows Server AD DS but does NOT require the corporate Windows Server AD DS.</span></span>
2. [<span data-ttu-id="5126b-358">AD FS: Extend a claims-aware on-premises front-end application to the Internet</span><span class="sxs-lookup"><span data-stu-id="5126b-358">AD FS: Extend a claims-aware on-premises front-end application to the Internet</span></span>](#BKMK_CloudOnlyFed)
   
    <span data-ttu-id="5126b-359">For example, a claims-aware application that has been successfully deployed on-premises and used by corporate users needs to become accessible from the Internet.</span><span class="sxs-lookup"><span data-stu-id="5126b-359">For example, a claims-aware application that has been successfully deployed on-premises and used by corporate users needs to become accessible from the Internet.</span></span> <span data-ttu-id="5126b-360">The application needs to be accessed directly over the Internet both by business partners using their own corporate identities and by existing corporate users.</span><span class="sxs-lookup"><span data-stu-id="5126b-360">The application needs to be accessed directly over the Internet both by business partners using their own corporate identities and by existing corporate users.</span></span>
3. [<span data-ttu-id="5126b-361">AD DS: Deploy a Windows Server AD DS-aware application that requires connectivity to the corporate network</span><span class="sxs-lookup"><span data-stu-id="5126b-361">AD DS: Deploy a Windows Server AD DS-aware application that requires connectivity to the corporate network</span></span>](#BKMK_HybridExt)
   
    <span data-ttu-id="5126b-362">For example, an LDAP-aware application that supports Windows-integrated authentication and uses Windows Server AD DS as a repository for configuration and user-profile data is deployed on an Azure virtual machine.</span><span class="sxs-lookup"><span data-stu-id="5126b-362">For example, an LDAP-aware application that supports Windows-integrated authentication and uses Windows Server AD DS as a repository for configuration and user-profile data is deployed on an Azure virtual machine.</span></span> <span data-ttu-id="5126b-363">It is desirable for the application to leverage the existing corporate Windows Server AD DS and provide single sign-on.</span><span class="sxs-lookup"><span data-stu-id="5126b-363">It is desirable for the application to leverage the existing corporate Windows Server AD DS and provide single sign-on.</span></span> <span data-ttu-id="5126b-364">The application is not claims-aware.</span><span class="sxs-lookup"><span data-stu-id="5126b-364">The application is not claims-aware.</span></span>

### <a name="BKMK_CloudOnly"></a><span data-ttu-id="5126b-365">1. AD DS: Deploy an AD DS-aware application with no requirement for corporate network connectivity</span><span class="sxs-lookup"><span data-stu-id="5126b-365">1. AD DS: Deploy an AD DS-aware application with no requirement for corporate network connectivity</span></span>
<span data-ttu-id="5126b-366">![Cloud-only AD DS deployment](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-deploying-ws-ad-guidelines/ADDS_cloud.png)
**Figure 1**</span><span class="sxs-lookup"><span data-stu-id="5126b-366">![Cloud-only AD DS deployment](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-deploying-ws-ad-guidelines/ADDS_cloud.png)
**Figure 1**</span></span>

#### <a name="description"></a><span data-ttu-id="5126b-367">Description</span><span class="sxs-lookup"><span data-stu-id="5126b-367">Description</span></span>
<span data-ttu-id="5126b-368">SharePoint is deployed on an Azure virtual machine and the application has no dependencies on corporate-network resources.</span><span class="sxs-lookup"><span data-stu-id="5126b-368">SharePoint is deployed on an Azure virtual machine and the application has no dependencies on corporate-network resources.</span></span> <span data-ttu-id="5126b-369">The application does require Windows Server AD DS but does *not* require the corporate Windows Server AD DS.</span><span class="sxs-lookup"><span data-stu-id="5126b-369">The application does require Windows Server AD DS but does *not* require the corporate Windows Server AD DS.</span></span> <span data-ttu-id="5126b-370">No Kerberos or federated trusts are required because users are self-provisioned through the application into the Windows Server AD DS domain that is also hosted in the cloud on Azure virtual machines.</span><span class="sxs-lookup"><span data-stu-id="5126b-370">No Kerberos or federated trusts are required because users are self-provisioned through the application into the Windows Server AD DS domain that is also hosted in the cloud on Azure virtual machines.</span></span>

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a><span data-ttu-id="5126b-371">Scenario considerations and how technology areas apply to the scenario</span><span class="sxs-lookup"><span data-stu-id="5126b-371">Scenario considerations and how technology areas apply to the scenario</span></span>
* <span data-ttu-id="5126b-372">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network without cross-premises connectivity (also known as site-to-site connectivity).</span><span class="sxs-lookup"><span data-stu-id="5126b-372">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network without cross-premises connectivity (also known as site-to-site connectivity).</span></span>
* <span data-ttu-id="5126b-373">[DC deployment configuration](#BKMK_DeploymentConfig): Deploy a new domain controller into a new, single-domain, Windows Server Active Directory forest.</span><span class="sxs-lookup"><span data-stu-id="5126b-373">[DC deployment configuration](#BKMK_DeploymentConfig): Deploy a new domain controller into a new, single-domain, Windows Server Active Directory forest.</span></span> <span data-ttu-id="5126b-374">This should be deployed along with the Windows DNS server.</span><span class="sxs-lookup"><span data-stu-id="5126b-374">This should be deployed along with the Windows DNS server.</span></span>
* <span data-ttu-id="5126b-375">[Windows Server Active Directory site topology](#BKMK_ADSiteTopology): Use the default Windows Server Active Directory site (all computers will be in Default-First-Site-Name).</span><span class="sxs-lookup"><span data-stu-id="5126b-375">[Windows Server Active Directory site topology](#BKMK_ADSiteTopology): Use the default Windows Server Active Directory site (all computers will be in Default-First-Site-Name).</span></span>
* <span data-ttu-id="5126b-376">[IP addressing and DNS](#BKMK_IPAddressDNS):</span><span class="sxs-lookup"><span data-stu-id="5126b-376">[IP addressing and DNS](#BKMK_IPAddressDNS):</span></span>
  
  * <span data-ttu-id="5126b-377">Set a static IP address for the DC by using the Set-AzureStaticVNetIP Azure PowerShell cmdlet.</span><span class="sxs-lookup"><span data-stu-id="5126b-377">Set a static IP address for the DC by using the Set-AzureStaticVNetIP Azure PowerShell cmdlet.</span></span>
  * <span data-ttu-id="5126b-378">Install and configure Windows Server DNS on the domain controller(s) on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-378">Install and configure Windows Server DNS on the domain controller(s) on Azure.</span></span>
  * <span data-ttu-id="5126b-379">Configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles.</span><span class="sxs-lookup"><span data-stu-id="5126b-379">Configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles.</span></span>
* <span data-ttu-id="5126b-380">[Global Catalog](#BKMK_GC): The first DC in the forest must be a global catalog server.</span><span class="sxs-lookup"><span data-stu-id="5126b-380">[Global Catalog](#BKMK_GC): The first DC in the forest must be a global catalog server.</span></span> <span data-ttu-id="5126b-381">Additional DCs should also be configured as GCs because in a single domain forest, the global catalog does not require any additional work from the DC.</span><span class="sxs-lookup"><span data-stu-id="5126b-381">Additional DCs should also be configured as GCs because in a single domain forest, the global catalog does not require any additional work from the DC.</span></span>
* <span data-ttu-id="5126b-382">[Placement of the Windows Server AD DS database and SYSVOL](#BKMK_PlaceDB): Add a data disk to DCs running as Azure VMs in order to store the Windows Server Active Directory database, logs, and SYSVOL.</span><span class="sxs-lookup"><span data-stu-id="5126b-382">[Placement of the Windows Server AD DS database and SYSVOL](#BKMK_PlaceDB): Add a data disk to DCs running as Azure VMs in order to store the Windows Server Active Directory database, logs, and SYSVOL.</span></span>
* <span data-ttu-id="5126b-383">[Backup and Restore](#BKMK_BUR): Determine where you want to store system state backups.</span><span class="sxs-lookup"><span data-stu-id="5126b-383">[Backup and Restore](#BKMK_BUR): Determine where you want to store system state backups.</span></span> <span data-ttu-id="5126b-384">If necessary, add another data disk to the DC VM to store backups.</span><span class="sxs-lookup"><span data-stu-id="5126b-384">If necessary, add another data disk to the DC VM to store backups.</span></span>

### <a name="BKMK_CloudOnlyFed"></a><span data-ttu-id="5126b-385">2 AD FS: Extend a claims-aware on-premises front-end application to the Internet</span><span class="sxs-lookup"><span data-stu-id="5126b-385">2 AD FS: Extend a claims-aware on-premises front-end application to the Internet</span></span>
<span data-ttu-id="5126b-386">![Federation with cross-premises connectivity](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-deploying-ws-ad-guidelines/Federation_xprem.png)
**Figure 2**</span><span class="sxs-lookup"><span data-stu-id="5126b-386">![Federation with cross-premises connectivity](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-deploying-ws-ad-guidelines/Federation_xprem.png)
**Figure 2**</span></span>

#### <a name="description"></a><span data-ttu-id="5126b-387">Description</span><span class="sxs-lookup"><span data-stu-id="5126b-387">Description</span></span>
<span data-ttu-id="5126b-388">A claims-aware application that has been successfully deployed on-premises and used by corporate users needs to become accessible directly from the Internet.</span><span class="sxs-lookup"><span data-stu-id="5126b-388">A claims-aware application that has been successfully deployed on-premises and used by corporate users needs to become accessible directly from the Internet.</span></span> <span data-ttu-id="5126b-389">The application serves as a web frontend to a SQL database in which it stores data.</span><span class="sxs-lookup"><span data-stu-id="5126b-389">The application serves as a web frontend to a SQL database in which it stores data.</span></span> <span data-ttu-id="5126b-390">The SQL servers used by the application are also located on the corporate network.</span><span class="sxs-lookup"><span data-stu-id="5126b-390">The SQL servers used by the application are also located on the corporate network.</span></span> <span data-ttu-id="5126b-391">Two Windows Server AD FS STSs and a load-balancer have been deployed on-premises to provide access to the corporate users.</span><span class="sxs-lookup"><span data-stu-id="5126b-391">Two Windows Server AD FS STSs and a load-balancer have been deployed on-premises to provide access to the corporate users.</span></span> <span data-ttu-id="5126b-392">The application now needs to be additionally accessed directly over the Internet both by business partners using their own corporate identities and by existing corporate users.</span><span class="sxs-lookup"><span data-stu-id="5126b-392">The application now needs to be additionally accessed directly over the Internet both by business partners using their own corporate identities and by existing corporate users.</span></span>

<span data-ttu-id="5126b-393">In an effort to simplify and meet the deployment and configuration needs of this new requirement, it is decided that two additional web frontends and two Windows Server AD FS proxy servers be installed on Azure virtual machines.</span><span class="sxs-lookup"><span data-stu-id="5126b-393">In an effort to simplify and meet the deployment and configuration needs of this new requirement, it is decided that two additional web frontends and two Windows Server AD FS proxy servers be installed on Azure virtual machines.</span></span> <span data-ttu-id="5126b-394">All four VMs will be exposed directly to the Internet and will be provided connectivity to the on-premises network using Azure Virtual Network’s site-to-site VPN capability.</span><span class="sxs-lookup"><span data-stu-id="5126b-394">All four VMs will be exposed directly to the Internet and will be provided connectivity to the on-premises network using Azure Virtual Network’s site-to-site VPN capability.</span></span>

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a><span data-ttu-id="5126b-395">Scenario considerations and how technology areas apply to the scenario</span><span class="sxs-lookup"><span data-stu-id="5126b-395">Scenario considerations and how technology areas apply to the scenario</span></span>
* <span data-ttu-id="5126b-396">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network and [configure cross-premises connectivity](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span><span class="sxs-lookup"><span data-stu-id="5126b-396">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network and [configure cross-premises connectivity](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="5126b-397">For each of the Windows Server AD FS certificates, ensure that the URL defined within the certificate template and the resulting certificates can be reached by the Windows Server AD FS instances running on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-397">For each of the Windows Server AD FS certificates, ensure that the URL defined within the certificate template and the resulting certificates can be reached by the Windows Server AD FS instances running on Azure.</span></span> <span data-ttu-id="5126b-398">This may require cross-premises connectivity to parts of your PKI infrastructure.</span><span class="sxs-lookup"><span data-stu-id="5126b-398">This may require cross-premises connectivity to parts of your PKI infrastructure.</span></span> <span data-ttu-id="5126b-399">For example if the CRL's endpoint is LDAP-based and hosted exclusively on-premises, then cross-premises connectivity will be required.</span><span class="sxs-lookup"><span data-stu-id="5126b-399">For example if the CRL's endpoint is LDAP-based and hosted exclusively on-premises, then cross-premises connectivity will be required.</span></span> <span data-ttu-id="5126b-400">If this is not desirable, it may be necessary to use certificates issued by a CA whose CRL is accessible over the Internet.</span><span class="sxs-lookup"><span data-stu-id="5126b-400">If this is not desirable, it may be necessary to use certificates issued by a CA whose CRL is accessible over the Internet.</span></span>
  > 
  > 
* <span data-ttu-id="5126b-401">[Cloud services configuration](#BKMK_CloudSvcConfig): Ensure you have two cloud services in order provide two load-balanced virtual IP addresses.</span><span class="sxs-lookup"><span data-stu-id="5126b-401">[Cloud services configuration](#BKMK_CloudSvcConfig): Ensure you have two cloud services in order provide two load-balanced virtual IP addresses.</span></span> <span data-ttu-id="5126b-402">The first cloud service’s virtual IP address will be directed to the two Windows Server AD FS proxy VMs on ports 80 and 443.</span><span class="sxs-lookup"><span data-stu-id="5126b-402">The first cloud service’s virtual IP address will be directed to the two Windows Server AD FS proxy VMs on ports 80 and 443.</span></span> <span data-ttu-id="5126b-403">The Windows Server AD FS proxy VMs will be configured to point to the IP address of the on-premises load-balancer that fronts the Windows Server AD FS STSs.</span><span class="sxs-lookup"><span data-stu-id="5126b-403">The Windows Server AD FS proxy VMs will be configured to point to the IP address of the on-premises load-balancer that fronts the Windows Server AD FS STSs.</span></span> <span data-ttu-id="5126b-404">The second cloud service’s virtual IP address will be directed to the two VMs running the web frontend again on ports 80 and 443.</span><span class="sxs-lookup"><span data-stu-id="5126b-404">The second cloud service’s virtual IP address will be directed to the two VMs running the web frontend again on ports 80 and 443.</span></span> <span data-ttu-id="5126b-405">Configure a custom probe to ensure the load-balancer only directs traffic to functioning Windows Server AD FS proxy and web frontend VMs.</span><span class="sxs-lookup"><span data-stu-id="5126b-405">Configure a custom probe to ensure the load-balancer only directs traffic to functioning Windows Server AD FS proxy and web frontend VMs.</span></span>
* <span data-ttu-id="5126b-406">[Federation server configuration](#BKMK_FedSrvConfig): Configure Windows Server AD FS as a federation server (STS) to generate security tokens for the Windows Server Active Directory forest created in the cloud.</span><span class="sxs-lookup"><span data-stu-id="5126b-406">[Federation server configuration](#BKMK_FedSrvConfig): Configure Windows Server AD FS as a federation server (STS) to generate security tokens for the Windows Server Active Directory forest created in the cloud.</span></span> <span data-ttu-id="5126b-407">Set federation claims provider trust relationships with the different partners you wish to accept identities from, and configure relying party trust relationships with the different applications you want to generate tokens to.</span><span class="sxs-lookup"><span data-stu-id="5126b-407">Set federation claims provider trust relationships with the different partners you wish to accept identities from, and configure relying party trust relationships with the different applications you want to generate tokens to.</span></span>
  
    <span data-ttu-id="5126b-408">In most scenarios, Windows Server AD FS proxy servers are deployed in an Internet-facing capacity for security purposes while their Windows Server AD FS federation counterparts remain isolated from direct Internet connectivity.</span><span class="sxs-lookup"><span data-stu-id="5126b-408">In most scenarios, Windows Server AD FS proxy servers are deployed in an Internet-facing capacity for security purposes while their Windows Server AD FS federation counterparts remain isolated from direct Internet connectivity.</span></span> <span data-ttu-id="5126b-409">Regardless of your deployment scenario, you must configure your cloud service with a virtual IP address that will provide a publicly exposed IP address and port that is able to load-balance across either your two Windows Server AD FS STS instances or proxy instances.</span><span class="sxs-lookup"><span data-stu-id="5126b-409">Regardless of your deployment scenario, you must configure your cloud service with a virtual IP address that will provide a publicly exposed IP address and port that is able to load-balance across either your two Windows Server AD FS STS instances or proxy instances.</span></span>
* <span data-ttu-id="5126b-410">[Windows Server AD FS high availability configuration](#BKMK_ADFSHighAvail): It is advisable to deploy a Windows Server AD FS farm with at least two servers for failover and load balancing.</span><span class="sxs-lookup"><span data-stu-id="5126b-410">[Windows Server AD FS high availability configuration](#BKMK_ADFSHighAvail): It is advisable to deploy a Windows Server AD FS farm with at least two servers for failover and load balancing.</span></span> <span data-ttu-id="5126b-411">You might want to consider using the Windows Internal Database (WID) for Windows Server AD FS configuration data, and use the internal load balancing capability of Azure to distribute incoming requests across the servers in the farm.</span><span class="sxs-lookup"><span data-stu-id="5126b-411">You might want to consider using the Windows Internal Database (WID) for Windows Server AD FS configuration data, and use the internal load balancing capability of Azure to distribute incoming requests across the servers in the farm.</span></span>

<span data-ttu-id="5126b-412">For more information, see the [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963).</span><span class="sxs-lookup"><span data-stu-id="5126b-412">For more information, see the [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963).</span></span>

### <a name="BKMK_HybridExt"></a><span data-ttu-id="5126b-413">3. AD DS: Deploy a Windows Server AD DS-aware application that requires connectivity to the corporate network</span><span class="sxs-lookup"><span data-stu-id="5126b-413">3. AD DS: Deploy a Windows Server AD DS-aware application that requires connectivity to the corporate network</span></span>
<span data-ttu-id="5126b-414">![Cross-premises AD DS deployment](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-deploying-ws-ad-guidelines/ADDS_xprem.png)
**Figure 3**</span><span class="sxs-lookup"><span data-stu-id="5126b-414">![Cross-premises AD DS deployment](https://docstestmedia1.blob.core.windows.net/azure-media/articles/active-directory/media/active-directory-deploying-ws-ad-guidelines/ADDS_xprem.png)
**Figure 3**</span></span>

#### <a name="description"></a><span data-ttu-id="5126b-415">Description</span><span class="sxs-lookup"><span data-stu-id="5126b-415">Description</span></span>
<span data-ttu-id="5126b-416">An LDAP-aware application is deployed on an Azure virtual machine.</span><span class="sxs-lookup"><span data-stu-id="5126b-416">An LDAP-aware application is deployed on an Azure virtual machine.</span></span> <span data-ttu-id="5126b-417">It supports Windows-integrated authentication and uses Windows Server AD DS as a repository for configuration and user profile data.</span><span class="sxs-lookup"><span data-stu-id="5126b-417">It supports Windows-integrated authentication and uses Windows Server AD DS as a repository for configuration and user profile data.</span></span> <span data-ttu-id="5126b-418">The goal is for the application to leverage the existing corporate Windows Server AD DS and provide single sign-on.</span><span class="sxs-lookup"><span data-stu-id="5126b-418">The goal is for the application to leverage the existing corporate Windows Server AD DS and provide single sign-on.</span></span> <span data-ttu-id="5126b-419">The application is not claims-aware.</span><span class="sxs-lookup"><span data-stu-id="5126b-419">The application is not claims-aware.</span></span> <span data-ttu-id="5126b-420">Users also need to access the application directly from the Internet.</span><span class="sxs-lookup"><span data-stu-id="5126b-420">Users also need to access the application directly from the Internet.</span></span> <span data-ttu-id="5126b-421">To optimize for performance and cost, it is decided that two additional domain controllers that are part of the corporate domain be deployed alongside the application on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-421">To optimize for performance and cost, it is decided that two additional domain controllers that are part of the corporate domain be deployed alongside the application on Azure.</span></span>

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a><span data-ttu-id="5126b-422">Scenario considerations and how technology areas apply to the scenario</span><span class="sxs-lookup"><span data-stu-id="5126b-422">Scenario considerations and how technology areas apply to the scenario</span></span>
* <span data-ttu-id="5126b-423">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network with [cross-premises connectivity](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span><span class="sxs-lookup"><span data-stu-id="5126b-423">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network with [cross-premises connectivity](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>
* <span data-ttu-id="5126b-424">[Installation method](#BKMK_InstallMethod): Deploy replica DCs from the corporate Windows Server Active Directory domain.</span><span class="sxs-lookup"><span data-stu-id="5126b-424">[Installation method](#BKMK_InstallMethod): Deploy replica DCs from the corporate Windows Server Active Directory domain.</span></span> <span data-ttu-id="5126b-425">For a replica DC, you can install Windows Server AD DS on the VM, and optionally use the Install From Media (IFM) feature to reduce the amount of data that needs to be replicated to the new DC during installation.</span><span class="sxs-lookup"><span data-stu-id="5126b-425">For a replica DC, you can install Windows Server AD DS on the VM, and optionally use the Install From Media (IFM) feature to reduce the amount of data that needs to be replicated to the new DC during installation.</span></span> <span data-ttu-id="5126b-426">For a tutorial, see [Install a replica Active Directory domain controller on Azure](active-directory-install-replica-active-directory-domain-controller.md).</span><span class="sxs-lookup"><span data-stu-id="5126b-426">For a tutorial, see [Install a replica Active Directory domain controller on Azure](active-directory-install-replica-active-directory-domain-controller.md).</span></span> <span data-ttu-id="5126b-427">Even if you use IFM, it may be more efficient to build the virtual DC on-premises and move the entire Virtual Hard Disk (VHD) to the cloud instead of replicating Windows Server AD DS during installation.</span><span class="sxs-lookup"><span data-stu-id="5126b-427">Even if you use IFM, it may be more efficient to build the virtual DC on-premises and move the entire Virtual Hard Disk (VHD) to the cloud instead of replicating Windows Server AD DS during installation.</span></span> <span data-ttu-id="5126b-428">For safety, it is recommended that you delete the VHD from the on-premises network once it has been copied to Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-428">For safety, it is recommended that you delete the VHD from the on-premises network once it has been copied to Azure.</span></span>
* <span data-ttu-id="5126b-429">[Windows Server Active Directory site topology](#BKMK_ADSiteTopology): Create a new Azure site in Active Directory Sites and Services.</span><span class="sxs-lookup"><span data-stu-id="5126b-429">[Windows Server Active Directory site topology](#BKMK_ADSiteTopology): Create a new Azure site in Active Directory Sites and Services.</span></span> <span data-ttu-id="5126b-430">Create a Windows Server Active Directory subnet object to represent the Azure virtual network and add the subnet to the site.</span><span class="sxs-lookup"><span data-stu-id="5126b-430">Create a Windows Server Active Directory subnet object to represent the Azure virtual network and add the subnet to the site.</span></span> <span data-ttu-id="5126b-431">Create a new site link that includes the new Azure site and the site in which the Azure virtual network VPN endpoint is located in order to control and optimize Windows Server Active Directory traffic to and from Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-431">Create a new site link that includes the new Azure site and the site in which the Azure virtual network VPN endpoint is located in order to control and optimize Windows Server Active Directory traffic to and from Azure.</span></span>
* <span data-ttu-id="5126b-432">[IP addressing and DNS](#BKMK_IPAddressDNS):</span><span class="sxs-lookup"><span data-stu-id="5126b-432">[IP addressing and DNS](#BKMK_IPAddressDNS):</span></span>
  
  * <span data-ttu-id="5126b-433">Set a static IP address for the DC by using the Set-AzureStaticVNetIP Azure PowerShell cmdlet.</span><span class="sxs-lookup"><span data-stu-id="5126b-433">Set a static IP address for the DC by using the Set-AzureStaticVNetIP Azure PowerShell cmdlet.</span></span>
  * <span data-ttu-id="5126b-434">Install and configure Windows Server DNS on the domain controller(s) on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-434">Install and configure Windows Server DNS on the domain controller(s) on Azure.</span></span>
  * <span data-ttu-id="5126b-435">Configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles.</span><span class="sxs-lookup"><span data-stu-id="5126b-435">Configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles.</span></span>
* <span data-ttu-id="5126b-436">[Geo-distributed DCs](#BKMK_DistributedDCs): Configure additional virtual networks as needed.</span><span class="sxs-lookup"><span data-stu-id="5126b-436">[Geo-distributed DCs](#BKMK_DistributedDCs): Configure additional virtual networks as needed.</span></span> <span data-ttu-id="5126b-437">If your Active Directory site topology requires DCs in geographies that correspond to different Azure regions, than you want to create Active Directory sites accordingly.</span><span class="sxs-lookup"><span data-stu-id="5126b-437">If your Active Directory site topology requires DCs in geographies that correspond to different Azure regions, than you want to create Active Directory sites accordingly.</span></span>
* <span data-ttu-id="5126b-438">[Read-only DCs](#BKMK_RODC): You might deploy an RODC in the Azure site, depending on your requirements for performing write operations against the DC and the compatibility of applications and services in the site with RODCs.</span><span class="sxs-lookup"><span data-stu-id="5126b-438">[Read-only DCs](#BKMK_RODC): You might deploy an RODC in the Azure site, depending on your requirements for performing write operations against the DC and the compatibility of applications and services in the site with RODCs.</span></span> <span data-ttu-id="5126b-439">For more information about application compatibility, see the [Read-Only domain controllers application compatibility guide](https://technet.microsoft.com/library/cc755190).</span><span class="sxs-lookup"><span data-stu-id="5126b-439">For more information about application compatibility, see the [Read-Only domain controllers application compatibility guide](https://technet.microsoft.com/library/cc755190).</span></span>
* <span data-ttu-id="5126b-440">[Global Catalog](#BKMK_GC): GCs are needed to service logon requests in multidomain forests.</span><span class="sxs-lookup"><span data-stu-id="5126b-440">[Global Catalog](#BKMK_GC): GCs are needed to service logon requests in multidomain forests.</span></span> <span data-ttu-id="5126b-441">If you do not deploy a GC in the Azure site, you will incur egress traffic costs as authentication requests cause queries GCs in other sites.</span><span class="sxs-lookup"><span data-stu-id="5126b-441">If you do not deploy a GC in the Azure site, you will incur egress traffic costs as authentication requests cause queries GCs in other sites.</span></span> <span data-ttu-id="5126b-442">To minimize that traffic, you can enable universal group membership caching for the Azure site in Active Directory Sites and Services.</span><span class="sxs-lookup"><span data-stu-id="5126b-442">To minimize that traffic, you can enable universal group membership caching for the Azure site in Active Directory Sites and Services.</span></span>
  
    <span data-ttu-id="5126b-443">If you deploy a GC, configure site links and site links costs so that the GC in the Azure site is not preferred as a source DC by other GCs that need to replicate the same partial domain partitions.</span><span class="sxs-lookup"><span data-stu-id="5126b-443">If you deploy a GC, configure site links and site links costs so that the GC in the Azure site is not preferred as a source DC by other GCs that need to replicate the same partial domain partitions.</span></span>
* <span data-ttu-id="5126b-444">[Placement of the Windows Server AD DS database and SYSVOL](#BKMK_PlaceDB): Add a data disk to DCs running on Azure VMs in order to store the Windows Server Active Directory database, logs, and SYSVOL.</span><span class="sxs-lookup"><span data-stu-id="5126b-444">[Placement of the Windows Server AD DS database and SYSVOL](#BKMK_PlaceDB): Add a data disk to DCs running on Azure VMs in order to store the Windows Server Active Directory database, logs, and SYSVOL.</span></span>
* <span data-ttu-id="5126b-445">[Backup and Restore](#BKMK_BUR): Determine where you want to store system state backups.</span><span class="sxs-lookup"><span data-stu-id="5126b-445">[Backup and Restore](#BKMK_BUR): Determine where you want to store system state backups.</span></span> <span data-ttu-id="5126b-446">If necessary, add another data disk to the DC VM to store backups.</span><span class="sxs-lookup"><span data-stu-id="5126b-446">If necessary, add another data disk to the DC VM to store backups.</span></span>

## <a name="deployment-decisions-and-factors"></a><span data-ttu-id="5126b-447">Deployment decisions and factors</span><span class="sxs-lookup"><span data-stu-id="5126b-447">Deployment decisions and factors</span></span>
<span data-ttu-id="5126b-448">This table summarizes the Windows Server Active Directory technology areas that are impacted in the preceding scenarios and the corresponding decisions to consider, with links to more detail below.</span><span class="sxs-lookup"><span data-stu-id="5126b-448">This table summarizes the Windows Server Active Directory technology areas that are impacted in the preceding scenarios and the corresponding decisions to consider, with links to more detail below.</span></span> <span data-ttu-id="5126b-449">Some technology areas might not be applicable to every deployment scenario, and some technology areas might be more critical to a deployment scenario than other technology areas.</span><span class="sxs-lookup"><span data-stu-id="5126b-449">Some technology areas might not be applicable to every deployment scenario, and some technology areas might be more critical to a deployment scenario than other technology areas.</span></span>

<span data-ttu-id="5126b-450">For example, if you deploy a replica DC on a virtual network and your forest has only a single domain, then choosing to deploy a global catalog server in that case will not be critical to the deployment scenario because it will not create any additional replication requirements.</span><span class="sxs-lookup"><span data-stu-id="5126b-450">For example, if you deploy a replica DC on a virtual network and your forest has only a single domain, then choosing to deploy a global catalog server in that case will not be critical to the deployment scenario because it will not create any additional replication requirements.</span></span> <span data-ttu-id="5126b-451">On the other hand, if the forest has several domains, then the decision to deploy a global catalog on a virtual network could affect available bandwidth, performance, authentication, directory lookups, and so on.</span><span class="sxs-lookup"><span data-stu-id="5126b-451">On the other hand, if the forest has several domains, then the decision to deploy a global catalog on a virtual network could affect available bandwidth, performance, authentication, directory lookups, and so on.</span></span>

| <span data-ttu-id="5126b-452">Windows Server Active Directory technology area</span><span class="sxs-lookup"><span data-stu-id="5126b-452">Windows Server Active Directory technology area</span></span> | <span data-ttu-id="5126b-453">Decisions</span><span class="sxs-lookup"><span data-stu-id="5126b-453">Decisions</span></span> | <span data-ttu-id="5126b-454">Factors</span><span class="sxs-lookup"><span data-stu-id="5126b-454">Factors</span></span> |
| --- | --- | --- |
| [<span data-ttu-id="5126b-455">Network topology</span><span class="sxs-lookup"><span data-stu-id="5126b-455">Network topology</span></span>](#BKMK_NetworkTopology) |<span data-ttu-id="5126b-456">Do you create a virtual network?</span><span class="sxs-lookup"><span data-stu-id="5126b-456">Do you create a virtual network?</span></span> |<li><span data-ttu-id="5126b-457">Requirements to access Corp resources</span><span class="sxs-lookup"><span data-stu-id="5126b-457">Requirements to access Corp resources</span></span></li> <li><span data-ttu-id="5126b-458">Authentication</span><span class="sxs-lookup"><span data-stu-id="5126b-458">Authentication</span></span></li> <li><span data-ttu-id="5126b-459">Account management</span><span class="sxs-lookup"><span data-stu-id="5126b-459">Account management</span></span></li> |
| [<span data-ttu-id="5126b-460">DC deployment configuration</span><span class="sxs-lookup"><span data-stu-id="5126b-460">DC deployment configuration</span></span>](#BKMK_DeploymentConfig) |<li><span data-ttu-id="5126b-461">Deploy a separate forest without any trusts?</span><span class="sxs-lookup"><span data-stu-id="5126b-461">Deploy a separate forest without any trusts?</span></span></li> <li><span data-ttu-id="5126b-462">Deploy a new forest with federation?</span><span class="sxs-lookup"><span data-stu-id="5126b-462">Deploy a new forest with federation?</span></span></li> <li><span data-ttu-id="5126b-463">Deploy a new forest with Windows Server Active Directory forest trust or Kerberos?</span><span class="sxs-lookup"><span data-stu-id="5126b-463">Deploy a new forest with Windows Server Active Directory forest trust or Kerberos?</span></span></li> <li><span data-ttu-id="5126b-464">Extend Corp forest by deploying a replica DC?</span><span class="sxs-lookup"><span data-stu-id="5126b-464">Extend Corp forest by deploying a replica DC?</span></span></li> <li><span data-ttu-id="5126b-465">Extend Corp forest by deploying a new child domain or domain tree?</span><span class="sxs-lookup"><span data-stu-id="5126b-465">Extend Corp forest by deploying a new child domain or domain tree?</span></span></li> |<li><span data-ttu-id="5126b-466">Security</span><span class="sxs-lookup"><span data-stu-id="5126b-466">Security</span></span></li> <li><span data-ttu-id="5126b-467">Compliance</span><span class="sxs-lookup"><span data-stu-id="5126b-467">Compliance</span></span></li> <li><span data-ttu-id="5126b-468">Cost</span><span class="sxs-lookup"><span data-stu-id="5126b-468">Cost</span></span></li> <li><span data-ttu-id="5126b-469">Resiliency and fault-tolerance</span><span class="sxs-lookup"><span data-stu-id="5126b-469">Resiliency and fault-tolerance</span></span></li> <li><span data-ttu-id="5126b-470">Application compatibility</span><span class="sxs-lookup"><span data-stu-id="5126b-470">Application compatibility</span></span></li> |
| [<span data-ttu-id="5126b-471">Windows Server Active Directory site topology</span><span class="sxs-lookup"><span data-stu-id="5126b-471">Windows Server Active Directory site topology</span></span>](#BKMK_ADSiteTopology) |<span data-ttu-id="5126b-472">How do you configure subnets, sites, and site links with Azure Virtual Network to optimize traffic and minimize cost?</span><span class="sxs-lookup"><span data-stu-id="5126b-472">How do you configure subnets, sites, and site links with Azure Virtual Network to optimize traffic and minimize cost?</span></span> |<li><span data-ttu-id="5126b-473">Subnet and site definitions</span><span class="sxs-lookup"><span data-stu-id="5126b-473">Subnet and site definitions</span></span></li> <li><span data-ttu-id="5126b-474">Site link properties and change notification</span><span class="sxs-lookup"><span data-stu-id="5126b-474">Site link properties and change notification</span></span></li> <li><span data-ttu-id="5126b-475">Replication compression</span><span class="sxs-lookup"><span data-stu-id="5126b-475">Replication compression</span></span></li> |
| [<span data-ttu-id="5126b-476">IP addressing and DNS</span><span class="sxs-lookup"><span data-stu-id="5126b-476">IP addressing and DNS</span></span>](#BKMK_IPAddressDNS) |<span data-ttu-id="5126b-477">How to configure IP addresses and name resolution?</span><span class="sxs-lookup"><span data-stu-id="5126b-477">How to configure IP addresses and name resolution?</span></span> |<li><span data-ttu-id="5126b-478">Use the Use the Set-AzureStaticVNetIP cmdlet to assign a static IP address</span><span class="sxs-lookup"><span data-stu-id="5126b-478">Use the Use the Set-AzureStaticVNetIP cmdlet to assign a static IP address</span></span></li> <li><span data-ttu-id="5126b-479">Install Windows Server DNS server and configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles</span><span class="sxs-lookup"><span data-stu-id="5126b-479">Install Windows Server DNS server and configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles</span></span></li> |
| [<span data-ttu-id="5126b-480">Geo-distributed DCs</span><span class="sxs-lookup"><span data-stu-id="5126b-480">Geo-distributed DCs</span></span>](#BKMK_DistributedDCs) |<span data-ttu-id="5126b-481">How to replicate to DCs on separate virtual networks?</span><span class="sxs-lookup"><span data-stu-id="5126b-481">How to replicate to DCs on separate virtual networks?</span></span> |<span data-ttu-id="5126b-482">If your Active Directory site topology requires DCs in geographies that corresponds to different Azure regions, than you want to create Active Directory sites accordingly.</span><span class="sxs-lookup"><span data-stu-id="5126b-482">If your Active Directory site topology requires DCs in geographies that corresponds to different Azure regions, than you want to create Active Directory sites accordingly.</span></span> <span data-ttu-id="5126b-483">[Configure virtual network to virtual network Connectivity](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md) to replicate between domain controllers on separate virtual networks.</span><span class="sxs-lookup"><span data-stu-id="5126b-483">[Configure virtual network to virtual network Connectivity](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md) to replicate between domain controllers on separate virtual networks.</span></span> |
| [<span data-ttu-id="5126b-484">Read-only DCs</span><span class="sxs-lookup"><span data-stu-id="5126b-484">Read-only DCs</span></span>](#BKMK_RODC) |<span data-ttu-id="5126b-485">Use read-only or writeable DCs?</span><span class="sxs-lookup"><span data-stu-id="5126b-485">Use read-only or writeable DCs?</span></span> |<li><span data-ttu-id="5126b-486">Filter HBI/PII attributes</span><span class="sxs-lookup"><span data-stu-id="5126b-486">Filter HBI/PII attributes</span></span></li> <li><span data-ttu-id="5126b-487">Filter secrets</span><span class="sxs-lookup"><span data-stu-id="5126b-487">Filter secrets</span></span></li> <li><span data-ttu-id="5126b-488">Limit outbound traffic</span><span class="sxs-lookup"><span data-stu-id="5126b-488">Limit outbound traffic</span></span></li> |
| [<span data-ttu-id="5126b-489">Global catalog</span><span class="sxs-lookup"><span data-stu-id="5126b-489">Global catalog</span></span>](#BKMK_GC) |<span data-ttu-id="5126b-490">Install global catalog?</span><span class="sxs-lookup"><span data-stu-id="5126b-490">Install global catalog?</span></span> |<li><span data-ttu-id="5126b-491">For single-domain forest, make all DCs GCs</span><span class="sxs-lookup"><span data-stu-id="5126b-491">For single-domain forest, make all DCs GCs</span></span></li> <li><span data-ttu-id="5126b-492">For multidomain forest, GCs are required for authentication</span><span class="sxs-lookup"><span data-stu-id="5126b-492">For multidomain forest, GCs are required for authentication</span></span></li> |
| [<span data-ttu-id="5126b-493">Installation method</span><span class="sxs-lookup"><span data-stu-id="5126b-493">Installation method</span></span>](#BKMK_InstallMethod) |<span data-ttu-id="5126b-494">How to install DC in Azure?</span><span class="sxs-lookup"><span data-stu-id="5126b-494">How to install DC in Azure?</span></span> |<span data-ttu-id="5126b-495">Either:</span><span class="sxs-lookup"><span data-stu-id="5126b-495">Either:</span></span> <li><span data-ttu-id="5126b-496">Install AD DS using Windows PowerShell or Dcpromo</span><span class="sxs-lookup"><span data-stu-id="5126b-496">Install AD DS using Windows PowerShell or Dcpromo</span></span></li> <li><span data-ttu-id="5126b-497">Move VHD of an on-premises virtual DC</span><span class="sxs-lookup"><span data-stu-id="5126b-497">Move VHD of an on-premises virtual DC</span></span></li> |
| [<span data-ttu-id="5126b-498">Placement of the Windows Server AD DS database and SYSVOL</span><span class="sxs-lookup"><span data-stu-id="5126b-498">Placement of the Windows Server AD DS database and SYSVOL</span></span>](#BKMK_PlaceDB) |<span data-ttu-id="5126b-499">Where to store Windows Server AD DS database, logs, and SYSVOL?</span><span class="sxs-lookup"><span data-stu-id="5126b-499">Where to store Windows Server AD DS database, logs, and SYSVOL?</span></span> |<span data-ttu-id="5126b-500">Change Dcpromo.exe default values.</span><span class="sxs-lookup"><span data-stu-id="5126b-500">Change Dcpromo.exe default values.</span></span> <span data-ttu-id="5126b-501">These critical Active Directory files *must* be placed on Azure Data Disks instead of Operating System disks that implement write caching.</span><span class="sxs-lookup"><span data-stu-id="5126b-501">These critical Active Directory files *must* be placed on Azure Data Disks instead of Operating System disks that implement write caching.</span></span> |
| [<span data-ttu-id="5126b-502">Backup and Restore</span><span class="sxs-lookup"><span data-stu-id="5126b-502">Backup and Restore</span></span>](#BKMK_BUR) |<span data-ttu-id="5126b-503">How to safeguard and recover data?</span><span class="sxs-lookup"><span data-stu-id="5126b-503">How to safeguard and recover data?</span></span> |<span data-ttu-id="5126b-504">Create system state backups</span><span class="sxs-lookup"><span data-stu-id="5126b-504">Create system state backups</span></span> |
| [<span data-ttu-id="5126b-505">Federation server configuration</span><span class="sxs-lookup"><span data-stu-id="5126b-505">Federation server configuration</span></span>](#BKMK_FedSrvConfig) |<li><span data-ttu-id="5126b-506">Deploy a new forest with federation in the cloud?</span><span class="sxs-lookup"><span data-stu-id="5126b-506">Deploy a new forest with federation in the cloud?</span></span></li> <li><span data-ttu-id="5126b-507">Deploy AD FS on-premises and expose a proxy in the cloud?</span><span class="sxs-lookup"><span data-stu-id="5126b-507">Deploy AD FS on-premises and expose a proxy in the cloud?</span></span></li> |<li><span data-ttu-id="5126b-508">Security</span><span class="sxs-lookup"><span data-stu-id="5126b-508">Security</span></span></li> <li><span data-ttu-id="5126b-509">Compliance</span><span class="sxs-lookup"><span data-stu-id="5126b-509">Compliance</span></span></li> <li><span data-ttu-id="5126b-510">Cost</span><span class="sxs-lookup"><span data-stu-id="5126b-510">Cost</span></span></li> <li><span data-ttu-id="5126b-511">Access to applications by business partners</span><span class="sxs-lookup"><span data-stu-id="5126b-511">Access to applications by business partners</span></span></li> |
| [<span data-ttu-id="5126b-512">Cloud services configuration</span><span class="sxs-lookup"><span data-stu-id="5126b-512">Cloud services configuration</span></span>](#BKMK_CloudSvcConfig) |<span data-ttu-id="5126b-513">A cloud service is implicitly deployed the first time you create a virtual machine.</span><span class="sxs-lookup"><span data-stu-id="5126b-513">A cloud service is implicitly deployed the first time you create a virtual machine.</span></span> <span data-ttu-id="5126b-514">Do you need to deploy additional cloud services?</span><span class="sxs-lookup"><span data-stu-id="5126b-514">Do you need to deploy additional cloud services?</span></span> |<li><span data-ttu-id="5126b-515">Does a VM or VMs require direct exposure to the Internet?</span><span class="sxs-lookup"><span data-stu-id="5126b-515">Does a VM or VMs require direct exposure to the Internet?</span></span></li> <li> <span data-ttu-id="5126b-516">Does the service require load-balancing?</span><span class="sxs-lookup"><span data-stu-id="5126b-516">Does the service require load-balancing?</span></span></li> |
| [<span data-ttu-id="5126b-517">Federation server requirements for public and private IP addressing (dynamic IP vs. virtual IP)</span><span class="sxs-lookup"><span data-stu-id="5126b-517">Federation server requirements for public and private IP addressing (dynamic IP vs. virtual IP)</span></span>](#BKMK_FedReqVIPDIP) |<li><span data-ttu-id="5126b-518">Does the Windows Server AD FS instance need to be reached directly from the Internet?</span><span class="sxs-lookup"><span data-stu-id="5126b-518">Does the Windows Server AD FS instance need to be reached directly from the Internet?</span></span></li> <li><span data-ttu-id="5126b-519">Does the application being deployed in the cloud require its own Internet-facing IP address and port?</span><span class="sxs-lookup"><span data-stu-id="5126b-519">Does the application being deployed in the cloud require its own Internet-facing IP address and port?</span></span></li> |<span data-ttu-id="5126b-520">Create one cloud-service for each virtual IP address that is required by your deployment</span><span class="sxs-lookup"><span data-stu-id="5126b-520">Create one cloud-service for each virtual IP address that is required by your deployment</span></span> |
| [<span data-ttu-id="5126b-521">Windows Server AD FS high availability configuration</span><span class="sxs-lookup"><span data-stu-id="5126b-521">Windows Server AD FS high availability configuration</span></span>](#BKMK_ADFSHighAvail) |<li><span data-ttu-id="5126b-522">How many nodes in my Windows Server AD FS server farm?</span><span class="sxs-lookup"><span data-stu-id="5126b-522">How many nodes in my Windows Server AD FS server farm?</span></span></li> <li><span data-ttu-id="5126b-523">How many nodes to deploy in my Windows Server AD FS proxy farm?</span><span class="sxs-lookup"><span data-stu-id="5126b-523">How many nodes to deploy in my Windows Server AD FS proxy farm?</span></span></li> |<span data-ttu-id="5126b-524">Resiliency and fault tolerance</span><span class="sxs-lookup"><span data-stu-id="5126b-524">Resiliency and fault tolerance</span></span> |

### <a name="BKMK_NetworkTopology"></a><span data-ttu-id="5126b-525">Network topology</span><span class="sxs-lookup"><span data-stu-id="5126b-525">Network topology</span></span>
<span data-ttu-id="5126b-526">In order to meet the IP address consistency and DNS requirements of Windows Server AD DS, it is necessary to first create an [Azure virtual network](../virtual-network/virtual-networks-overview.md) and attach your virtual machines to it.</span><span class="sxs-lookup"><span data-stu-id="5126b-526">In order to meet the IP address consistency and DNS requirements of Windows Server AD DS, it is necessary to first create an [Azure virtual network](../virtual-network/virtual-networks-overview.md) and attach your virtual machines to it.</span></span> <span data-ttu-id="5126b-527">During its creation, you must decide whether to optionally extend connectivity to your on-premises corporate network, which transparently connects Azure virtual machines to on-premises machines — this is achieved using traditional VPN technologies and requires that a VPN endpoint be exposed on the edge of the corporate network.</span><span class="sxs-lookup"><span data-stu-id="5126b-527">During its creation, you must decide whether to optionally extend connectivity to your on-premises corporate network, which transparently connects Azure virtual machines to on-premises machines — this is achieved using traditional VPN technologies and requires that a VPN endpoint be exposed on the edge of the corporate network.</span></span> <span data-ttu-id="5126b-528">That is, the VPN is initiated from Azure to the corporate network, not vice-versa.</span><span class="sxs-lookup"><span data-stu-id="5126b-528">That is, the VPN is initiated from Azure to the corporate network, not vice-versa.</span></span>

<span data-ttu-id="5126b-529">Note that additional charges apply when extending a virtual network to your on-premises network beyond the standard charges that apply to each VM.</span><span class="sxs-lookup"><span data-stu-id="5126b-529">Note that additional charges apply when extending a virtual network to your on-premises network beyond the standard charges that apply to each VM.</span></span> <span data-ttu-id="5126b-530">Specifically, there are charges for CPU time of the Azure Virtual Network gateway and for the egress traffic generated by each VM that communicates with on-premises machines across the VPN.</span><span class="sxs-lookup"><span data-stu-id="5126b-530">Specifically, there are charges for CPU time of the Azure Virtual Network gateway and for the egress traffic generated by each VM that communicates with on-premises machines across the VPN.</span></span> <span data-ttu-id="5126b-531">For more information about network traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span><span class="sxs-lookup"><span data-stu-id="5126b-531">For more information about network traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span>

### <a name="BKMK_DeploymentConfig"></a><span data-ttu-id="5126b-532">DC deployment configuration</span><span class="sxs-lookup"><span data-stu-id="5126b-532">DC deployment configuration</span></span>
<span data-ttu-id="5126b-533">The way you configure the DC depends on the requirements for the service you want to run on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-533">The way you configure the DC depends on the requirements for the service you want to run on Azure.</span></span> <span data-ttu-id="5126b-534">For example, you might deploy a new forest, isolated from your own corporate forest, for testing a proof-of-concept, a new application, or some other short term project that requires directory services but not specific access to internal corporate resources.</span><span class="sxs-lookup"><span data-stu-id="5126b-534">For example, you might deploy a new forest, isolated from your own corporate forest, for testing a proof-of-concept, a new application, or some other short term project that requires directory services but not specific access to internal corporate resources.</span></span>

<span data-ttu-id="5126b-535">As a benefit, an isolated forest DC does not replicate with on-premises DCs, resulting in less outbound network traffic generated by the system itself, directly reducing costs.</span><span class="sxs-lookup"><span data-stu-id="5126b-535">As a benefit, an isolated forest DC does not replicate with on-premises DCs, resulting in less outbound network traffic generated by the system itself, directly reducing costs.</span></span> <span data-ttu-id="5126b-536">For more information about network traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span><span class="sxs-lookup"><span data-stu-id="5126b-536">For more information about network traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span>

<span data-ttu-id="5126b-537">As another example, suppose you have privacy requirements for a service, but the service depends on access to your internal Windows Server Active Directory.</span><span class="sxs-lookup"><span data-stu-id="5126b-537">As another example, suppose you have privacy requirements for a service, but the service depends on access to your internal Windows Server Active Directory.</span></span> <span data-ttu-id="5126b-538">If you are allowed to host data for the service in the cloud, you might deploy a new child domain for your internal forest on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-538">If you are allowed to host data for the service in the cloud, you might deploy a new child domain for your internal forest on Azure.</span></span> <span data-ttu-id="5126b-539">In this case, you can deploy a DC for the new child domain (without the global catalog in order to help address privacy concerns).</span><span class="sxs-lookup"><span data-stu-id="5126b-539">In this case, you can deploy a DC for the new child domain (without the global catalog in order to help address privacy concerns).</span></span> <span data-ttu-id="5126b-540">This scenario, along with a replica DC deployment, requires a virtual network for connectivity with your on-premises DCs.</span><span class="sxs-lookup"><span data-stu-id="5126b-540">This scenario, along with a replica DC deployment, requires a virtual network for connectivity with your on-premises DCs.</span></span>

<span data-ttu-id="5126b-541">If you create a new forest, choose whether to use [Active Directory trusts](https://technet.microsoft.com/library/cc771397) or [Federation trusts](https://technet.microsoft.com/library/dd807036).</span><span class="sxs-lookup"><span data-stu-id="5126b-541">If you create a new forest, choose whether to use [Active Directory trusts](https://technet.microsoft.com/library/cc771397) or [Federation trusts](https://technet.microsoft.com/library/dd807036).</span></span> <span data-ttu-id="5126b-542">Balance the requirements dictated by compatibility, security, compliance, cost, and resiliency.</span><span class="sxs-lookup"><span data-stu-id="5126b-542">Balance the requirements dictated by compatibility, security, compliance, cost, and resiliency.</span></span> <span data-ttu-id="5126b-543">For example, to take advantage of [selective authentication](https://technet.microsoft.com/library/cc755844) you might choose to deploy a new forest on Azure and create a Windows Server Active Directory trust between the on-premises forest and the cloud forest.</span><span class="sxs-lookup"><span data-stu-id="5126b-543">For example, to take advantage of [selective authentication](https://technet.microsoft.com/library/cc755844) you might choose to deploy a new forest on Azure and create a Windows Server Active Directory trust between the on-premises forest and the cloud forest.</span></span> <span data-ttu-id="5126b-544">If the application is claims-aware, however, you might deploy federation trusts instead of Active Directory forest trusts.</span><span class="sxs-lookup"><span data-stu-id="5126b-544">If the application is claims-aware, however, you might deploy federation trusts instead of Active Directory forest trusts.</span></span> <span data-ttu-id="5126b-545">Another factor will be the cost to either replicate more data by extending your on-premises Windows Server Active Directory to the cloud or generate more outbound traffic as a result of authentication and query load.</span><span class="sxs-lookup"><span data-stu-id="5126b-545">Another factor will be the cost to either replicate more data by extending your on-premises Windows Server Active Directory to the cloud or generate more outbound traffic as a result of authentication and query load.</span></span>

<span data-ttu-id="5126b-546">Requirements for availability and fault tolerance also affect your choice.</span><span class="sxs-lookup"><span data-stu-id="5126b-546">Requirements for availability and fault tolerance also affect your choice.</span></span> <span data-ttu-id="5126b-547">For example, if the link is interrupted, applications leveraging either a Kerberos trust or a federation trust are all likely entirely broken unless you have deployed sufficient infrastructure on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-547">For example, if the link is interrupted, applications leveraging either a Kerberos trust or a federation trust are all likely entirely broken unless you have deployed sufficient infrastructure on Azure.</span></span> <span data-ttu-id="5126b-548">Alternative deployment configurations such as replica DCs (writeable or RODCs) increase the likelihood of being able to tolerate link outages.</span><span class="sxs-lookup"><span data-stu-id="5126b-548">Alternative deployment configurations such as replica DCs (writeable or RODCs) increase the likelihood of being able to tolerate link outages.</span></span>

### <a name="BKMK_ADSiteTopology"></a><span data-ttu-id="5126b-549">Windows Server Active Directory site topology</span><span class="sxs-lookup"><span data-stu-id="5126b-549">Windows Server Active Directory site topology</span></span>
<span data-ttu-id="5126b-550">You need to correctly define sites and site links in order to optimize traffic and minimize cost.</span><span class="sxs-lookup"><span data-stu-id="5126b-550">You need to correctly define sites and site links in order to optimize traffic and minimize cost.</span></span> <span data-ttu-id="5126b-551">Sites, site-links, and subnets affect the replication topology between DCs and the flow of authentication traffic.</span><span class="sxs-lookup"><span data-stu-id="5126b-551">Sites, site-links, and subnets affect the replication topology between DCs and the flow of authentication traffic.</span></span> <span data-ttu-id="5126b-552">Consider the following traffic charges and then deploy and configure DCs according to the requirements of your deployment scenario:</span><span class="sxs-lookup"><span data-stu-id="5126b-552">Consider the following traffic charges and then deploy and configure DCs according to the requirements of your deployment scenario:</span></span>

* <span data-ttu-id="5126b-553">There is a nominal fee per hour for the gateway itself:</span><span class="sxs-lookup"><span data-stu-id="5126b-553">There is a nominal fee per hour for the gateway itself:</span></span>
  
  * <span data-ttu-id="5126b-554">It can be started and stopped as you see fit</span><span class="sxs-lookup"><span data-stu-id="5126b-554">It can be started and stopped as you see fit</span></span>
  * <span data-ttu-id="5126b-555">If stopped, Azure VMs are isolated from the corporate network</span><span class="sxs-lookup"><span data-stu-id="5126b-555">If stopped, Azure VMs are isolated from the corporate network</span></span>
* <span data-ttu-id="5126b-556">Inbound traffic is free</span><span class="sxs-lookup"><span data-stu-id="5126b-556">Inbound traffic is free</span></span>
* <span data-ttu-id="5126b-557">Outbound traffic is charged, according to [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span><span class="sxs-lookup"><span data-stu-id="5126b-557">Outbound traffic is charged, according to [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span> <span data-ttu-id="5126b-558">You can optimize site link properties between on-premises sites and the cloud sites as follows:</span><span class="sxs-lookup"><span data-stu-id="5126b-558">You can optimize site link properties between on-premises sites and the cloud sites as follows:</span></span>
  
  * <span data-ttu-id="5126b-559">If you are using multiple virtual networks, configure the site-links and their costs appropriately to prevent Windows Server AD DS from prioritizing the Azure site over one that can provide the same levels of service at no charge.</span><span class="sxs-lookup"><span data-stu-id="5126b-559">If you are using multiple virtual networks, configure the site-links and their costs appropriately to prevent Windows Server AD DS from prioritizing the Azure site over one that can provide the same levels of service at no charge.</span></span> <span data-ttu-id="5126b-560">You might also consider disabling the Bridge all site link (BASL) option (which is enabled by default).</span><span class="sxs-lookup"><span data-stu-id="5126b-560">You might also consider disabling the Bridge all site link (BASL) option (which is enabled by default).</span></span> <span data-ttu-id="5126b-561">This ensures that only directly-connected sites replicate with one another.</span><span class="sxs-lookup"><span data-stu-id="5126b-561">This ensures that only directly-connected sites replicate with one another.</span></span> <span data-ttu-id="5126b-562">DCs in transitively connected sites are no longer able to replicate directly with each other, but must replicate through a common site or sites.</span><span class="sxs-lookup"><span data-stu-id="5126b-562">DCs in transitively connected sites are no longer able to replicate directly with each other, but must replicate through a common site or sites.</span></span> <span data-ttu-id="5126b-563">If the intermediary sites become unavailable for some reason, replication between DCs in transitively connected sites will not occur even if connectivity between the sites is available.</span><span class="sxs-lookup"><span data-stu-id="5126b-563">If the intermediary sites become unavailable for some reason, replication between DCs in transitively connected sites will not occur even if connectivity between the sites is available.</span></span> <span data-ttu-id="5126b-564">Finally, where sections of transitive replication behavior remain desirable, create site link bridges that contain the appropriate site-links and sites, such as on-premises, corporate network sites.</span><span class="sxs-lookup"><span data-stu-id="5126b-564">Finally, where sections of transitive replication behavior remain desirable, create site link bridges that contain the appropriate site-links and sites, such as on-premises, corporate network sites.</span></span>
  * <span data-ttu-id="5126b-565">[Configure site link costs](https://technet.microsoft.com/library/cc794882) appropriately to avoid unintended traffic.</span><span class="sxs-lookup"><span data-stu-id="5126b-565">[Configure site link costs](https://technet.microsoft.com/library/cc794882) appropriately to avoid unintended traffic.</span></span> <span data-ttu-id="5126b-566">For example, if **Try Next Closest Site** setting is enabled, make sure the virtual network sites are not the next closest by increasing the cost associated of the site-link object that connects the Azure site back to the corporate network.</span><span class="sxs-lookup"><span data-stu-id="5126b-566">For example, if **Try Next Closest Site** setting is enabled, make sure the virtual network sites are not the next closest by increasing the cost associated of the site-link object that connects the Azure site back to the corporate network.</span></span>
  * <span data-ttu-id="5126b-567">Configure site link [intervals](https://technet.microsoft.com/library/cc794878) and [schedules](https://technet.microsoft.com/library/cc816906) according to consistency requirements and rate of object changes.</span><span class="sxs-lookup"><span data-stu-id="5126b-567">Configure site link [intervals](https://technet.microsoft.com/library/cc794878) and [schedules](https://technet.microsoft.com/library/cc816906) according to consistency requirements and rate of object changes.</span></span> <span data-ttu-id="5126b-568">Align replication schedule with latency tolerance.</span><span class="sxs-lookup"><span data-stu-id="5126b-568">Align replication schedule with latency tolerance.</span></span> <span data-ttu-id="5126b-569">DCs replicate only the last state of a value, so decreasing the replication interval can save costs if there is a sufficient object change rate.</span><span class="sxs-lookup"><span data-stu-id="5126b-569">DCs replicate only the last state of a value, so decreasing the replication interval can save costs if there is a sufficient object change rate.</span></span>
* <span data-ttu-id="5126b-570">If minimizing costs is a priority, ensure replication is scheduled and change notification is not enabled.</span><span class="sxs-lookup"><span data-stu-id="5126b-570">If minimizing costs is a priority, ensure replication is scheduled and change notification is not enabled.</span></span> <span data-ttu-id="5126b-571">This is the default configuration when replicating between sites.</span><span class="sxs-lookup"><span data-stu-id="5126b-571">This is the default configuration when replicating between sites.</span></span> <span data-ttu-id="5126b-572">This is not important if you are deploying an RODC on a virtual network because the RODC will not replicate any changes outbound.</span><span class="sxs-lookup"><span data-stu-id="5126b-572">This is not important if you are deploying an RODC on a virtual network because the RODC will not replicate any changes outbound.</span></span> <span data-ttu-id="5126b-573">But if you deploy a writable DC, you should make sure the site link is not configured to replicate updates with unnecessary frequency.</span><span class="sxs-lookup"><span data-stu-id="5126b-573">But if you deploy a writable DC, you should make sure the site link is not configured to replicate updates with unnecessary frequency.</span></span> <span data-ttu-id="5126b-574">If you deploy a global catalog server (GC), make sure that every other site that contains a GC replicates domain partitions from a source DC in a site that is connected with a site-link or site-links that have a lower cost than the GC in the Azure site.</span><span class="sxs-lookup"><span data-stu-id="5126b-574">If you deploy a global catalog server (GC), make sure that every other site that contains a GC replicates domain partitions from a source DC in a site that is connected with a site-link or site-links that have a lower cost than the GC in the Azure site.</span></span>
* <span data-ttu-id="5126b-575">It is possible to further still reduce network traffic generated by replication between sites by changing the replication compression algorithm.</span><span class="sxs-lookup"><span data-stu-id="5126b-575">It is possible to further still reduce network traffic generated by replication between sites by changing the replication compression algorithm.</span></span> <span data-ttu-id="5126b-576">The compression algorithm is controlled by the REG_DWORD registry entry HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Replicator compression algorithm.</span><span class="sxs-lookup"><span data-stu-id="5126b-576">The compression algorithm is controlled by the REG_DWORD registry entry HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Replicator compression algorithm.</span></span> <span data-ttu-id="5126b-577">The default value is 3, which correlates to the Xpress Compress algorithm.</span><span class="sxs-lookup"><span data-stu-id="5126b-577">The default value is 3, which correlates to the Xpress Compress algorithm.</span></span> <span data-ttu-id="5126b-578">You can change the value to 2, which changes the algorithm to MSZip.</span><span class="sxs-lookup"><span data-stu-id="5126b-578">You can change the value to 2, which changes the algorithm to MSZip.</span></span> <span data-ttu-id="5126b-579">In most cases, this will increase the compression, but it does so at the expense of CPU utilization.</span><span class="sxs-lookup"><span data-stu-id="5126b-579">In most cases, this will increase the compression, but it does so at the expense of CPU utilization.</span></span> <span data-ttu-id="5126b-580">For more information, see [How Active Directory replication topology works](https://technet.microsoft.com/library/cc755994).</span><span class="sxs-lookup"><span data-stu-id="5126b-580">For more information, see [How Active Directory replication topology works](https://technet.microsoft.com/library/cc755994).</span></span>

### <a name="BKMK_IPAddressDNS"></a><span data-ttu-id="5126b-581">IP addressing and DNS</span><span class="sxs-lookup"><span data-stu-id="5126b-581">IP addressing and DNS</span></span>
<span data-ttu-id="5126b-582">Azure virtual machines are allocated “DHCP-leased addresses” by default.</span><span class="sxs-lookup"><span data-stu-id="5126b-582">Azure virtual machines are allocated “DHCP-leased addresses” by default.</span></span> <span data-ttu-id="5126b-583">Because Azure virtual network dynamic addresses persist with a virtual machine for the lifetime of the virtual machine, the requirements of Windows Server AD DS are met.</span><span class="sxs-lookup"><span data-stu-id="5126b-583">Because Azure virtual network dynamic addresses persist with a virtual machine for the lifetime of the virtual machine, the requirements of Windows Server AD DS are met.</span></span>

<span data-ttu-id="5126b-584">As a result, when you use a dynamic address on Azure, you are in effect using a static IP address because it is routable for the period of the lease, and the period of the lease is equal to the lifetime of the cloud service.</span><span class="sxs-lookup"><span data-stu-id="5126b-584">As a result, when you use a dynamic address on Azure, you are in effect using a static IP address because it is routable for the period of the lease, and the period of the lease is equal to the lifetime of the cloud service.</span></span>

<span data-ttu-id="5126b-585">However, the dynamic address is deallocated if the VM is shutdown.</span><span class="sxs-lookup"><span data-stu-id="5126b-585">However, the dynamic address is deallocated if the VM is shutdown.</span></span> <span data-ttu-id="5126b-586">To prevent the IP address from being deallocated, you can [use Set-AzureStaticVNetIP to assign a static IP address](http://social.technet.microsoft.com/wiki/contents/articles/23447.how-to-assign-a-private-static-ip-to-an-azure-vm.aspx).</span><span class="sxs-lookup"><span data-stu-id="5126b-586">To prevent the IP address from being deallocated, you can [use Set-AzureStaticVNetIP to assign a static IP address](http://social.technet.microsoft.com/wiki/contents/articles/23447.how-to-assign-a-private-static-ip-to-an-azure-vm.aspx).</span></span>

<span data-ttu-id="5126b-587">For name resolution, deploy your own (or leverage your existing) DNS server infrastructure; Azure-provided DNS does not meet the advanced name resolution needs of Windows Server AD DS.</span><span class="sxs-lookup"><span data-stu-id="5126b-587">For name resolution, deploy your own (or leverage your existing) DNS server infrastructure; Azure-provided DNS does not meet the advanced name resolution needs of Windows Server AD DS.</span></span> <span data-ttu-id="5126b-588">For example, it does not support dynamic SRV records, and so on.</span><span class="sxs-lookup"><span data-stu-id="5126b-588">For example, it does not support dynamic SRV records, and so on.</span></span> <span data-ttu-id="5126b-589">Name resolution is a critical configuration item for DCs and domain-joined clients.</span><span class="sxs-lookup"><span data-stu-id="5126b-589">Name resolution is a critical configuration item for DCs and domain-joined clients.</span></span> <span data-ttu-id="5126b-590">DCs must be capable of registering resource records and resolving other DC’s resource records.</span><span class="sxs-lookup"><span data-stu-id="5126b-590">DCs must be capable of registering resource records and resolving other DC’s resource records.</span></span>
<span data-ttu-id="5126b-591">For fault tolerance and performance reasons, it is optimal to install the Windows Server DNS service on the DCs running on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-591">For fault tolerance and performance reasons, it is optimal to install the Windows Server DNS service on the DCs running on Azure.</span></span> <span data-ttu-id="5126b-592">Then configure the Azure virtual network properties with the name and IP address of the DNS server.</span><span class="sxs-lookup"><span data-stu-id="5126b-592">Then configure the Azure virtual network properties with the name and IP address of the DNS server.</span></span> <span data-ttu-id="5126b-593">When other VMs on the virtual network start, their DNS client resolver settings will be configured with DNS server as part of the dynamic IP address allocation.</span><span class="sxs-lookup"><span data-stu-id="5126b-593">When other VMs on the virtual network start, their DNS client resolver settings will be configured with DNS server as part of the dynamic IP address allocation.</span></span>

> [!NOTE]
> <span data-ttu-id="5126b-594">You cannot join on-premises computers to a Windows Server AD DS Active Directory domain that is hosted on Azure directly over the Internet.</span><span class="sxs-lookup"><span data-stu-id="5126b-594">You cannot join on-premises computers to a Windows Server AD DS Active Directory domain that is hosted on Azure directly over the Internet.</span></span> <span data-ttu-id="5126b-595">The port requirements for Active Directory and the domain-join operation render it impractical to directly expose the necessary ports and in effect, an entire DC to the Internet.</span><span class="sxs-lookup"><span data-stu-id="5126b-595">The port requirements for Active Directory and the domain-join operation render it impractical to directly expose the necessary ports and in effect, an entire DC to the Internet.</span></span>
> 
> 

<span data-ttu-id="5126b-596">VMs register their DNS name automatically on startup or when there is a name change.</span><span class="sxs-lookup"><span data-stu-id="5126b-596">VMs register their DNS name automatically on startup or when there is a name change.</span></span>

<span data-ttu-id="5126b-597">For more information about this example and another example that shows how to provision the first VM and install AD DS on it, see [Install a new Active Directory forest on Microsoft Azure](active-directory-new-forest-virtual-machine.md).</span><span class="sxs-lookup"><span data-stu-id="5126b-597">For more information about this example and another example that shows how to provision the first VM and install AD DS on it, see [Install a new Active Directory forest on Microsoft Azure](active-directory-new-forest-virtual-machine.md).</span></span> <span data-ttu-id="5126b-598">For more information about using Windows PowerShell, see [Install Azure PowerShell](/powershell/azureps-cmdlets-docs) and [Azure Management Cmdlets](https://msdn.microsoft.com/library/azure/jj152841).</span><span class="sxs-lookup"><span data-stu-id="5126b-598">For more information about using Windows PowerShell, see [Install Azure PowerShell](/powershell/azureps-cmdlets-docs) and [Azure Management Cmdlets](https://msdn.microsoft.com/library/azure/jj152841).</span></span>

### <a name="BKMK_DistributedDCs"></a><span data-ttu-id="5126b-599">Geo-distributed DCs</span><span class="sxs-lookup"><span data-stu-id="5126b-599">Geo-distributed DCs</span></span>
<span data-ttu-id="5126b-600">Azure offers advantages when hosting multiple DCs on different virtual networks:</span><span class="sxs-lookup"><span data-stu-id="5126b-600">Azure offers advantages when hosting multiple DCs on different virtual networks:</span></span>

* <span data-ttu-id="5126b-601">Multi-site fault-tolerance</span><span class="sxs-lookup"><span data-stu-id="5126b-601">Multi-site fault-tolerance</span></span>
* <span data-ttu-id="5126b-602">Physical proximity to branch offices (lower latency)</span><span class="sxs-lookup"><span data-stu-id="5126b-602">Physical proximity to branch offices (lower latency)</span></span>

<span data-ttu-id="5126b-603">For information about configuring direct communication between virtual networks, see [Configure virtual network to virtual network connectivity](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).</span><span class="sxs-lookup"><span data-stu-id="5126b-603">For information about configuring direct communication between virtual networks, see [Configure virtual network to virtual network connectivity](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).</span></span>

### <a name="BKMK_RODC"></a><span data-ttu-id="5126b-604">Read-only DCs</span><span class="sxs-lookup"><span data-stu-id="5126b-604">Read-only DCs</span></span>
<span data-ttu-id="5126b-605">You need to choose whether to deploy read-only or writeable DCs.</span><span class="sxs-lookup"><span data-stu-id="5126b-605">You need to choose whether to deploy read-only or writeable DCs.</span></span> <span data-ttu-id="5126b-606">You might be inclined to deploy RODCs because you will not have physical control over them, but RODCs are designed to be deployed in locations where their physical security is at risk, such as branch offices.</span><span class="sxs-lookup"><span data-stu-id="5126b-606">You might be inclined to deploy RODCs because you will not have physical control over them, but RODCs are designed to be deployed in locations where their physical security is at risk, such as branch offices.</span></span>

<span data-ttu-id="5126b-607">Azure does not present the physical security risk of a branch office, but RODCs might still prove to be more cost effective because the features they provide are well-suited to these environments albeit for very different reasons.</span><span class="sxs-lookup"><span data-stu-id="5126b-607">Azure does not present the physical security risk of a branch office, but RODCs might still prove to be more cost effective because the features they provide are well-suited to these environments albeit for very different reasons.</span></span> <span data-ttu-id="5126b-608">For example, RODCs have no outbound replication and are able to selectively populate secrets (passwords).</span><span class="sxs-lookup"><span data-stu-id="5126b-608">For example, RODCs have no outbound replication and are able to selectively populate secrets (passwords).</span></span> <span data-ttu-id="5126b-609">On the downside, the lack of these secrets might require on-demand outbound traffic to validate them as a user or computer authenticates.</span><span class="sxs-lookup"><span data-stu-id="5126b-609">On the downside, the lack of these secrets might require on-demand outbound traffic to validate them as a user or computer authenticates.</span></span> <span data-ttu-id="5126b-610">But secrets can be selectively prepopulated and cached.</span><span class="sxs-lookup"><span data-stu-id="5126b-610">But secrets can be selectively prepopulated and cached.</span></span>

<span data-ttu-id="5126b-611">RODCs provide an additional advantage in and around HBI and PII concerns because you can add attributes that contain sensitive data to the RODC filtered attribute set (FAS).</span><span class="sxs-lookup"><span data-stu-id="5126b-611">RODCs provide an additional advantage in and around HBI and PII concerns because you can add attributes that contain sensitive data to the RODC filtered attribute set (FAS).</span></span> <span data-ttu-id="5126b-612">The FAS is a customizable set of attributes that are not replicated to RODCs.</span><span class="sxs-lookup"><span data-stu-id="5126b-612">The FAS is a customizable set of attributes that are not replicated to RODCs.</span></span> <span data-ttu-id="5126b-613">You can use the FAS as a safeguard in case you are not permitted or do not want to store PII or HBI on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-613">You can use the FAS as a safeguard in case you are not permitted or do not want to store PII or HBI on Azure.</span></span> <span data-ttu-id="5126b-614">For more information, see [RODC filtered attribute set[(https://technet.microsoft.com/library/cc753459)].</span><span class="sxs-lookup"><span data-stu-id="5126b-614">For more information, see [RODC filtered attribute set[(https://technet.microsoft.com/library/cc753459)].</span></span>

<span data-ttu-id="5126b-615">Make sure that applications will be compatible with RODCs you plan to use.</span><span class="sxs-lookup"><span data-stu-id="5126b-615">Make sure that applications will be compatible with RODCs you plan to use.</span></span> <span data-ttu-id="5126b-616">Many Windows Server Active Directory-enabled applications work well with RODCs, but some applications can perform inefficiently or fail if they do not have access to a writable DC.</span><span class="sxs-lookup"><span data-stu-id="5126b-616">Many Windows Server Active Directory-enabled applications work well with RODCs, but some applications can perform inefficiently or fail if they do not have access to a writable DC.</span></span> <span data-ttu-id="5126b-617">For more information, see [Read-Only DCs application compatibility guide](https://technet.microsoft.com/library/cc755190).</span><span class="sxs-lookup"><span data-stu-id="5126b-617">For more information, see [Read-Only DCs application compatibility guide](https://technet.microsoft.com/library/cc755190).</span></span>

### <a name="BKMK_GC"></a><span data-ttu-id="5126b-618">Global catalog</span><span class="sxs-lookup"><span data-stu-id="5126b-618">Global catalog</span></span>
<span data-ttu-id="5126b-619">You need to choose whether to install a global catalog (GC).</span><span class="sxs-lookup"><span data-stu-id="5126b-619">You need to choose whether to install a global catalog (GC).</span></span> <span data-ttu-id="5126b-620">In a single domain forest, you should configure all DCs as global catalog servers.</span><span class="sxs-lookup"><span data-stu-id="5126b-620">In a single domain forest, you should configure all DCs as global catalog servers.</span></span> <span data-ttu-id="5126b-621">It will not increase costs because there will be no additional replication traffic.</span><span class="sxs-lookup"><span data-stu-id="5126b-621">It will not increase costs because there will be no additional replication traffic.</span></span>

<span data-ttu-id="5126b-622">In a multidomain forest, GCs are necessary to expand Universal Group memberships during the authentication process.</span><span class="sxs-lookup"><span data-stu-id="5126b-622">In a multidomain forest, GCs are necessary to expand Universal Group memberships during the authentication process.</span></span> <span data-ttu-id="5126b-623">If you do not deploy a GC, workloads on the virtual network that authenticate against a DC on Azure will indirectly generate outbound authentication traffic to query GCs on-premises during each authentication attempt.</span><span class="sxs-lookup"><span data-stu-id="5126b-623">If you do not deploy a GC, workloads on the virtual network that authenticate against a DC on Azure will indirectly generate outbound authentication traffic to query GCs on-premises during each authentication attempt.</span></span>

<span data-ttu-id="5126b-624">The costs associated with GCs are less-predictable because they host every domain (in-part).</span><span class="sxs-lookup"><span data-stu-id="5126b-624">The costs associated with GCs are less-predictable because they host every domain (in-part).</span></span> <span data-ttu-id="5126b-625">If the workload hosts an Internet-facing service and authenticates users against Windows Server AD DS, the costs could be completely unpredictable.</span><span class="sxs-lookup"><span data-stu-id="5126b-625">If the workload hosts an Internet-facing service and authenticates users against Windows Server AD DS, the costs could be completely unpredictable.</span></span> <span data-ttu-id="5126b-626">To help reduce GC queries outside of the cloud site during authentication, you can [enable Universal Group Membership Caching](https://technet.microsoft.com/library/cc816928).</span><span class="sxs-lookup"><span data-stu-id="5126b-626">To help reduce GC queries outside of the cloud site during authentication, you can [enable Universal Group Membership Caching](https://technet.microsoft.com/library/cc816928).</span></span>

### <a name="BKMK_InstallMethod"></a><span data-ttu-id="5126b-627">Installation method</span><span class="sxs-lookup"><span data-stu-id="5126b-627">Installation method</span></span>
<span data-ttu-id="5126b-628">You need to choose how to install the DCs on the virtual network:</span><span class="sxs-lookup"><span data-stu-id="5126b-628">You need to choose how to install the DCs on the virtual network:</span></span>

* <span data-ttu-id="5126b-629">Promote new DCs.</span><span class="sxs-lookup"><span data-stu-id="5126b-629">Promote new DCs.</span></span> <span data-ttu-id="5126b-630">For more information, see [Install a new Active Directory forest on an Azure virtual network](active-directory-new-forest-virtual-machine.md).</span><span class="sxs-lookup"><span data-stu-id="5126b-630">For more information, see [Install a new Active Directory forest on an Azure virtual network](active-directory-new-forest-virtual-machine.md).</span></span>
* <span data-ttu-id="5126b-631">Move the VHD of an on-premises virtual DC to the cloud.</span><span class="sxs-lookup"><span data-stu-id="5126b-631">Move the VHD of an on-premises virtual DC to the cloud.</span></span> <span data-ttu-id="5126b-632">In this case, you must ensure that the on-premises virtual DC is “moved,” not “copied” or “cloned.”</span><span class="sxs-lookup"><span data-stu-id="5126b-632">In this case, you must ensure that the on-premises virtual DC is “moved,” not “copied” or “cloned.”</span></span>

<span data-ttu-id="5126b-633">Use only Azure virtual machines for DCs (as opposed to Azure “web” or “worker” role VMs).</span><span class="sxs-lookup"><span data-stu-id="5126b-633">Use only Azure virtual machines for DCs (as opposed to Azure “web” or “worker” role VMs).</span></span> <span data-ttu-id="5126b-634">They are durable and durability of state for a DC is required.</span><span class="sxs-lookup"><span data-stu-id="5126b-634">They are durable and durability of state for a DC is required.</span></span> <span data-ttu-id="5126b-635">Azure virtual machines are designed for workloads such as DCs.</span><span class="sxs-lookup"><span data-stu-id="5126b-635">Azure virtual machines are designed for workloads such as DCs.</span></span>

<span data-ttu-id="5126b-636">Do not use SYSPREP to deploy or clone DCs.</span><span class="sxs-lookup"><span data-stu-id="5126b-636">Do not use SYSPREP to deploy or clone DCs.</span></span> <span data-ttu-id="5126b-637">The ability to clone DCs is only available beginning in Windows Server 2012.</span><span class="sxs-lookup"><span data-stu-id="5126b-637">The ability to clone DCs is only available beginning in Windows Server 2012.</span></span> <span data-ttu-id="5126b-638">The cloning feature requires support for VMGenerationID in the underlying hypervisor.</span><span class="sxs-lookup"><span data-stu-id="5126b-638">The cloning feature requires support for VMGenerationID in the underlying hypervisor.</span></span> <span data-ttu-id="5126b-639">Hyper-V in Windows Server 2012 and Azure virtual networks both support VMGenerationID, as do third-party virtualization software vendors.</span><span class="sxs-lookup"><span data-stu-id="5126b-639">Hyper-V in Windows Server 2012 and Azure virtual networks both support VMGenerationID, as do third-party virtualization software vendors.</span></span>

### <a name="BKMK_PlaceDB"></a><span data-ttu-id="5126b-640">Placement of the Windows Server AD DS database and SYSVOL</span><span class="sxs-lookup"><span data-stu-id="5126b-640">Placement of the Windows Server AD DS database and SYSVOL</span></span>
<span data-ttu-id="5126b-641">Select where to locate the Windows Server AD DS database, logs, and SYSVOL.</span><span class="sxs-lookup"><span data-stu-id="5126b-641">Select where to locate the Windows Server AD DS database, logs, and SYSVOL.</span></span> <span data-ttu-id="5126b-642">They must be deployed on Azure Data disks.</span><span class="sxs-lookup"><span data-stu-id="5126b-642">They must be deployed on Azure Data disks.</span></span>

> [!NOTE]
> <span data-ttu-id="5126b-643">Azure Data disks are constrained to 1 TB.</span><span class="sxs-lookup"><span data-stu-id="5126b-643">Azure Data disks are constrained to 1 TB.</span></span>
> 
> 

<span data-ttu-id="5126b-644">Data disk drives do not cache writes by default.</span><span class="sxs-lookup"><span data-stu-id="5126b-644">Data disk drives do not cache writes by default.</span></span> <span data-ttu-id="5126b-645">Data disk drives that are attached to a VM use write-through caching.</span><span class="sxs-lookup"><span data-stu-id="5126b-645">Data disk drives that are attached to a VM use write-through caching.</span></span> <span data-ttu-id="5126b-646">Write-through caching makes sure the write is committed to durable Azure storage before the transaction is complete from the perspective of the VM’s operating system.</span><span class="sxs-lookup"><span data-stu-id="5126b-646">Write-through caching makes sure the write is committed to durable Azure storage before the transaction is complete from the perspective of the VM’s operating system.</span></span> <span data-ttu-id="5126b-647">It provides durability, at the expense of slightly slower writes.</span><span class="sxs-lookup"><span data-stu-id="5126b-647">It provides durability, at the expense of slightly slower writes.</span></span>

<span data-ttu-id="5126b-648">This is important for Windows Server AD DS because write-behind disk-caching invalidates assumptions made by the DC.</span><span class="sxs-lookup"><span data-stu-id="5126b-648">This is important for Windows Server AD DS because write-behind disk-caching invalidates assumptions made by the DC.</span></span> <span data-ttu-id="5126b-649">Windows Server AD DS attempts to disable write caching but it is up to the disk IO system to honor it.</span><span class="sxs-lookup"><span data-stu-id="5126b-649">Windows Server AD DS attempts to disable write caching but it is up to the disk IO system to honor it.</span></span> <span data-ttu-id="5126b-650">Failure to disable write caching may, under certain circumstances, introduce USN rollback resulting in lingering objects and other problems.</span><span class="sxs-lookup"><span data-stu-id="5126b-650">Failure to disable write caching may, under certain circumstances, introduce USN rollback resulting in lingering objects and other problems.</span></span>

<span data-ttu-id="5126b-651">As a best practice for virtual DCs, do the following:</span><span class="sxs-lookup"><span data-stu-id="5126b-651">As a best practice for virtual DCs, do the following:</span></span>

* <span data-ttu-id="5126b-652">Set the Host Cache Preference setting on the Azure data disk for NONE.</span><span class="sxs-lookup"><span data-stu-id="5126b-652">Set the Host Cache Preference setting on the Azure data disk for NONE.</span></span> <span data-ttu-id="5126b-653">This prevents issues with write caching for AD DS operations.</span><span class="sxs-lookup"><span data-stu-id="5126b-653">This prevents issues with write caching for AD DS operations.</span></span>
* <span data-ttu-id="5126b-654">Store the database, logs, and SYSVOL on the either same data disk or separate data disks.</span><span class="sxs-lookup"><span data-stu-id="5126b-654">Store the database, logs, and SYSVOL on the either same data disk or separate data disks.</span></span> <span data-ttu-id="5126b-655">Typically, this is a separate disk from the disk used for the operating system itself.</span><span class="sxs-lookup"><span data-stu-id="5126b-655">Typically, this is a separate disk from the disk used for the operating system itself.</span></span> <span data-ttu-id="5126b-656">The key takeaway is that the Windows Server AD DS database and SYSVOL must not be stored on an Azure Operating System disk type.</span><span class="sxs-lookup"><span data-stu-id="5126b-656">The key takeaway is that the Windows Server AD DS database and SYSVOL must not be stored on an Azure Operating System disk type.</span></span> <span data-ttu-id="5126b-657">By default, the AD DS installation process installs these components in %systemroot% folder, which is NOT recommended for Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-657">By default, the AD DS installation process installs these components in %systemroot% folder, which is NOT recommended for Azure.</span></span>

### <a name="BKMK_BUR"></a><span data-ttu-id="5126b-658">Backup and restore</span><span class="sxs-lookup"><span data-stu-id="5126b-658">Backup and restore</span></span>
<span data-ttu-id="5126b-659">Be aware of what is and is not supported for backup and restore of a DC in general, and more specifically, those running in a VM.</span><span class="sxs-lookup"><span data-stu-id="5126b-659">Be aware of what is and is not supported for backup and restore of a DC in general, and more specifically, those running in a VM.</span></span> <span data-ttu-id="5126b-660">See [Backup and Restore Considerations for Virtualized DCs](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv#backup_and_restore_considerations_for_virtualized_domain_controllers).</span><span class="sxs-lookup"><span data-stu-id="5126b-660">See [Backup and Restore Considerations for Virtualized DCs](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv#backup_and_restore_considerations_for_virtualized_domain_controllers).</span></span>

<span data-ttu-id="5126b-661">Create system state backups by using only backup software that is specifically aware of backup requirements for Windows Server AD DS, such as Windows Server Backup.</span><span class="sxs-lookup"><span data-stu-id="5126b-661">Create system state backups by using only backup software that is specifically aware of backup requirements for Windows Server AD DS, such as Windows Server Backup.</span></span>

<span data-ttu-id="5126b-662">Do not copy or clone VHD files of DCs instead of performing regular backups.</span><span class="sxs-lookup"><span data-stu-id="5126b-662">Do not copy or clone VHD files of DCs instead of performing regular backups.</span></span> <span data-ttu-id="5126b-663">Should a restore ever be required, doing so using cloned or copied VHDs without Windows Server 2012 and a supported hypervisor will introduce USN bubbles.</span><span class="sxs-lookup"><span data-stu-id="5126b-663">Should a restore ever be required, doing so using cloned or copied VHDs without Windows Server 2012 and a supported hypervisor will introduce USN bubbles.</span></span>

### <a name="BKMK_FedSrvConfig"></a><span data-ttu-id="5126b-664">Federation server configuration</span><span class="sxs-lookup"><span data-stu-id="5126b-664">Federation server configuration</span></span>
<span data-ttu-id="5126b-665">The configuration of Windows Server AD FS federation servers (STSs) depends in part on whether the applications that you want to deploy on Azure need to access resources on your on-premises network.</span><span class="sxs-lookup"><span data-stu-id="5126b-665">The configuration of Windows Server AD FS federation servers (STSs) depends in part on whether the applications that you want to deploy on Azure need to access resources on your on-premises network.</span></span>

<span data-ttu-id="5126b-666">If the applications meet the following criteria, you could deploy the applications in isolation from your on-premises network.</span><span class="sxs-lookup"><span data-stu-id="5126b-666">If the applications meet the following criteria, you could deploy the applications in isolation from your on-premises network.</span></span>

* <span data-ttu-id="5126b-667">They accept SAML security tokens</span><span class="sxs-lookup"><span data-stu-id="5126b-667">They accept SAML security tokens</span></span>
* <span data-ttu-id="5126b-668">They are exposable to the Internet</span><span class="sxs-lookup"><span data-stu-id="5126b-668">They are exposable to the Internet</span></span>
* <span data-ttu-id="5126b-669">They do not access on-premises resources</span><span class="sxs-lookup"><span data-stu-id="5126b-669">They do not access on-premises resources</span></span>

<span data-ttu-id="5126b-670">In this case, configure Windows Server AD FS STSs as follows:</span><span class="sxs-lookup"><span data-stu-id="5126b-670">In this case, configure Windows Server AD FS STSs as follows:</span></span>

1. <span data-ttu-id="5126b-671">Configure an isolated single-domain forest on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-671">Configure an isolated single-domain forest on Azure.</span></span>
2. <span data-ttu-id="5126b-672">Provide federated access to the forest by configuring a Windows Server AD FS federation server farm.</span><span class="sxs-lookup"><span data-stu-id="5126b-672">Provide federated access to the forest by configuring a Windows Server AD FS federation server farm.</span></span>
3. <span data-ttu-id="5126b-673">Configure Windows Server AD FS (federation server farm and federation server proxy farm) in the on-premises forest.</span><span class="sxs-lookup"><span data-stu-id="5126b-673">Configure Windows Server AD FS (federation server farm and federation server proxy farm) in the on-premises forest.</span></span>
4. <span data-ttu-id="5126b-674">Establish a federation trust relationship between the on-premises and Azure instances of Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="5126b-674">Establish a federation trust relationship between the on-premises and Azure instances of Windows Server AD FS.</span></span>

<span data-ttu-id="5126b-675">On the other hand, if the applications require access to on-premises resources, you could configure Windows Server AD FS with the application on Azure as follows:</span><span class="sxs-lookup"><span data-stu-id="5126b-675">On the other hand, if the applications require access to on-premises resources, you could configure Windows Server AD FS with the application on Azure as follows:</span></span>

1. <span data-ttu-id="5126b-676">Configure connectivity between on-premises networks and Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-676">Configure connectivity between on-premises networks and Azure.</span></span>
2. <span data-ttu-id="5126b-677">Configure a Windows Server AD FS federation server farm in the on-premises forest.</span><span class="sxs-lookup"><span data-stu-id="5126b-677">Configure a Windows Server AD FS federation server farm in the on-premises forest.</span></span>
3. <span data-ttu-id="5126b-678">Configure a Windows Server AD FS federation server proxy farm on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-678">Configure a Windows Server AD FS federation server proxy farm on Azure.</span></span>

<span data-ttu-id="5126b-679">This configuration has the advantage of reducing the exposure of on-premises resources, similar to configuring Windows Server AD FS with applications in a perimeter network.</span><span class="sxs-lookup"><span data-stu-id="5126b-679">This configuration has the advantage of reducing the exposure of on-premises resources, similar to configuring Windows Server AD FS with applications in a perimeter network.</span></span>

<span data-ttu-id="5126b-680">Note that in either scenario, you can establish trusts relationships with more identity providers, if business-to-business collaboration is needed.</span><span class="sxs-lookup"><span data-stu-id="5126b-680">Note that in either scenario, you can establish trusts relationships with more identity providers, if business-to-business collaboration is needed.</span></span>

### <a name="BKMK_CloudSvcConfig"></a><span data-ttu-id="5126b-681">Cloud services configuration</span><span class="sxs-lookup"><span data-stu-id="5126b-681">Cloud services configuration</span></span>
<span data-ttu-id="5126b-682">Cloud services are necessary if you want to expose a VM directly to the Internet or to expose an Internet-facing load-balanced application.</span><span class="sxs-lookup"><span data-stu-id="5126b-682">Cloud services are necessary if you want to expose a VM directly to the Internet or to expose an Internet-facing load-balanced application.</span></span> <span data-ttu-id="5126b-683">This is possible because each cloud service offers a single configurable virtual IP address.</span><span class="sxs-lookup"><span data-stu-id="5126b-683">This is possible because each cloud service offers a single configurable virtual IP address.</span></span>

### <a name="BKMK_FedReqVIPDIP"></a><span data-ttu-id="5126b-684">Federation server requirements for public and private IP addressing (dynamic IP vs. virtual IP)</span><span class="sxs-lookup"><span data-stu-id="5126b-684">Federation server requirements for public and private IP addressing (dynamic IP vs. virtual IP)</span></span>
<span data-ttu-id="5126b-685">Each Azure virtual machine receives a dynamic IP address.</span><span class="sxs-lookup"><span data-stu-id="5126b-685">Each Azure virtual machine receives a dynamic IP address.</span></span> <span data-ttu-id="5126b-686">A dynamic IP address is a private address accessible only within Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-686">A dynamic IP address is a private address accessible only within Azure.</span></span> <span data-ttu-id="5126b-687">In most cases, however, it will be necessary to configure a virtual IP address for your Windows Server AD FS deployments.</span><span class="sxs-lookup"><span data-stu-id="5126b-687">In most cases, however, it will be necessary to configure a virtual IP address for your Windows Server AD FS deployments.</span></span> <span data-ttu-id="5126b-688">The virtual IP is necessary to expose Windows Server AD FS endpoints to the Internet, and will be used by federated partners and clients for authentication and ongoing management.</span><span class="sxs-lookup"><span data-stu-id="5126b-688">The virtual IP is necessary to expose Windows Server AD FS endpoints to the Internet, and will be used by federated partners and clients for authentication and ongoing management.</span></span> <span data-ttu-id="5126b-689">A virtual IP address is a property of a cloud service which contains one or more Azure virtual machines.</span><span class="sxs-lookup"><span data-stu-id="5126b-689">A virtual IP address is a property of a cloud service which contains one or more Azure virtual machines.</span></span> <span data-ttu-id="5126b-690">If the claims-aware application deployed on Azure and Windows Server AD FS are both Internet-facing and share common ports, each will require a virtual IP address of its own and it will therefore be necessary to create one cloud service for the application and a second for Windows Server AD FS.</span><span class="sxs-lookup"><span data-stu-id="5126b-690">If the claims-aware application deployed on Azure and Windows Server AD FS are both Internet-facing and share common ports, each will require a virtual IP address of its own and it will therefore be necessary to create one cloud service for the application and a second for Windows Server AD FS.</span></span>

<span data-ttu-id="5126b-691">For definitions of the terms virtual IP address and dynamic IP address, see [Terms and definitions](#BKMK_Glossary).</span><span class="sxs-lookup"><span data-stu-id="5126b-691">For definitions of the terms virtual IP address and dynamic IP address, see [Terms and definitions](#BKMK_Glossary).</span></span>

### <a name="BKMK_ADFSHighAvail"></a><span data-ttu-id="5126b-692">Windows Server AD FS high availability configuration</span><span class="sxs-lookup"><span data-stu-id="5126b-692">Windows Server AD FS high availability configuration</span></span>
<span data-ttu-id="5126b-693">While it is possible to deploy standalone Windows Server AD FS federation services, it is recommended to deploy a farm with at least two nodes for both AD FS STS and proxies for production environments.</span><span class="sxs-lookup"><span data-stu-id="5126b-693">While it is possible to deploy standalone Windows Server AD FS federation services, it is recommended to deploy a farm with at least two nodes for both AD FS STS and proxies for production environments.</span></span>

<span data-ttu-id="5126b-694">See [AD FS 2.0 deployment topology considerations](https://technet.microsoft.com/library/gg982489) in the [AD FS 2.0 Design Guide](https://technet.microsoft.com/library/dd807036) to decide which deployment configuration options best suit your particular needs.</span><span class="sxs-lookup"><span data-stu-id="5126b-694">See [AD FS 2.0 deployment topology considerations](https://technet.microsoft.com/library/gg982489) in the [AD FS 2.0 Design Guide](https://technet.microsoft.com/library/dd807036) to decide which deployment configuration options best suit your particular needs.</span></span>

> [!NOTE]
> <span data-ttu-id="5126b-695">In order to get load balancing for Windows Server AD FS endpoints on Azure, configure all members of the Windows Server AD FS farm in the same cloud service, and use the load balancing capability of Azure for HTTP (default 80) and HTTPS ports (default 443).</span><span class="sxs-lookup"><span data-stu-id="5126b-695">In order to get load balancing for Windows Server AD FS endpoints on Azure, configure all members of the Windows Server AD FS farm in the same cloud service, and use the load balancing capability of Azure for HTTP (default 80) and HTTPS ports (default 443).</span></span> <span data-ttu-id="5126b-696">For more information, see [Azure load-balancer probe](https://msdn.microsoft.com/library/azure/jj151530).</span><span class="sxs-lookup"><span data-stu-id="5126b-696">For more information, see [Azure load-balancer probe](https://msdn.microsoft.com/library/azure/jj151530).</span></span>
> <span data-ttu-id="5126b-697">Windows Server Network Load Balancing (NLB) is not supported on Azure.</span><span class="sxs-lookup"><span data-stu-id="5126b-697">Windows Server Network Load Balancing (NLB) is not supported on Azure.</span></span>
> 
> 








