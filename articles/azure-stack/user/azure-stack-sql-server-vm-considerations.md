---
title: Performance best practices for SQL Server in Azure Stack Virtual Machines
description: Provides best practices for optimizing SQL Server performance in Microsoft Azure Stack Virtual Machines.
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.assetid: ''
ms.service: azure-stack
ms.workload: na
pms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/31/2018
ms.author: mabrigg
ms.reviewer: anajod
ms.openlocfilehash: 00c67503f5b9e0027cbb62520e392f56420a75e6
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44865415"
---
# <a name="optimize-sql-server-performance"></a><span data-ttu-id="86374-103">Optimize SQL Server performance</span><span class="sxs-lookup"><span data-stu-id="86374-103">Optimize SQL Server performance</span></span>

<span data-ttu-id="86374-104">This article provides guidance for optimizing SQL Server performance in Microsoft Azure Stack virtual machines.</span><span class="sxs-lookup"><span data-stu-id="86374-104">This article provides guidance for optimizing SQL Server performance in Microsoft Azure Stack virtual machines.</span></span> <span data-ttu-id="86374-105">When running SQL Server in Azure Stack virtual machines, use the same database performance-tuning options applicable to SQL Server in an on-premises server environment.</span><span class="sxs-lookup"><span data-stu-id="86374-105">When running SQL Server in Azure Stack virtual machines, use the same database performance-tuning options applicable to SQL Server in an on-premises server environment.</span></span> <span data-ttu-id="86374-106">The performance of a relational database in an Azure Stack cloud depends on many factors.</span><span class="sxs-lookup"><span data-stu-id="86374-106">The performance of a relational database in an Azure Stack cloud depends on many factors.</span></span> <span data-ttu-id="86374-107">Factors include the family size of a virtual machine, and the configuration of the data disks.</span><span class="sxs-lookup"><span data-stu-id="86374-107">Factors include the family size of a virtual machine, and the configuration of the data disks.</span></span>

<span data-ttu-id="86374-108">When creating SQL Server images, [consider provisioning your virtual machines in the Azure Stack portal](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision).</span><span class="sxs-lookup"><span data-stu-id="86374-108">When creating SQL Server images, [consider provisioning your virtual machines in the Azure Stack portal](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision).</span></span> <span data-ttu-id="86374-109">Download the SQL IaaS Extension from Marketplace Management in the Azure Stack Admin Portal and download your choice of SQL virtual machine virtual hard drives (VHDs).</span><span class="sxs-lookup"><span data-stu-id="86374-109">Download the SQL IaaS Extension from Marketplace Management in the Azure Stack Admin Portal and download your choice of SQL virtual machine virtual hard drives (VHDs).</span></span> <span data-ttu-id="86374-110">These include SQL2014SP2, SQL2016SP1, and SQL2017.</span><span class="sxs-lookup"><span data-stu-id="86374-110">These include SQL2014SP2, SQL2016SP1, and SQL2017.</span></span>

> [!NOTE]  
> <span data-ttu-id="86374-111">While the article describes how to provision a SQL Server virtual machine using the global Azure portal, the guidance also applies to Azure Stack with the following differences: SSD is not available for the operating system disk, managed disks are not available, and there are minor differences in storage configuration.</span><span class="sxs-lookup"><span data-stu-id="86374-111">While the article describes how to provision a SQL Server virtual machine using the global Azure portal, the guidance also applies to Azure Stack with the following differences: SSD is not available for the operating system disk, managed disks are not available, and there are minor differences in storage configuration.</span></span>

<span data-ttu-id="86374-112">Getting the *best* performance for SQL Server on Azure Stack virtual machines is the focus of this article.</span><span class="sxs-lookup"><span data-stu-id="86374-112">Getting the *best* performance for SQL Server on Azure Stack virtual machines is the focus of this article.</span></span> <span data-ttu-id="86374-113">If your workload is less demanding, you might not require every recommended optimization.</span><span class="sxs-lookup"><span data-stu-id="86374-113">If your workload is less demanding, you might not require every recommended optimization.</span></span> <span data-ttu-id="86374-114">Consider your performance needs and workload patterns as you evaluate these recommendations.</span><span class="sxs-lookup"><span data-stu-id="86374-114">Consider your performance needs and workload patterns as you evaluate these recommendations.</span></span>

> [!NOTE]  
> <span data-ttu-id="86374-115">For performance guidance for SQL Server in Azure virtual machines, refer to [this article](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-performance).</span><span class="sxs-lookup"><span data-stu-id="86374-115">For performance guidance for SQL Server in Azure virtual machines, refer to [this article](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-performance).</span></span>

## <a name="before-you-begin"></a><span data-ttu-id="86374-116">Before you begin</span><span class="sxs-lookup"><span data-stu-id="86374-116">Before you begin</span></span>
<span data-ttu-id="86374-117">The following checklist is for optimal performance of SQL Server on Azure Stack virtual machines:</span><span class="sxs-lookup"><span data-stu-id="86374-117">The following checklist is for optimal performance of SQL Server on Azure Stack virtual machines:</span></span>


|<span data-ttu-id="86374-118">Area</span><span class="sxs-lookup"><span data-stu-id="86374-118">Area</span></span>|<span data-ttu-id="86374-119">Optimizations</span><span class="sxs-lookup"><span data-stu-id="86374-119">Optimizations</span></span>|
|-----|-----|
|<span data-ttu-id="86374-120">Virtual machine size</span><span class="sxs-lookup"><span data-stu-id="86374-120">Virtual machine size</span></span> |<span data-ttu-id="86374-121">[DS3](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) or higher for SQL Server Enterprise edition.</span><span class="sxs-lookup"><span data-stu-id="86374-121">[DS3](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) or higher for SQL Server Enterprise edition.</span></span><br><br><span data-ttu-id="86374-122">[DS2](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) or higher for SQL Server Standard edition and Web edition.</span><span class="sxs-lookup"><span data-stu-id="86374-122">[DS2](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) or higher for SQL Server Standard edition and Web edition.</span></span>|
|<span data-ttu-id="86374-123">Storage</span><span class="sxs-lookup"><span data-stu-id="86374-123">Storage</span></span> |<span data-ttu-id="86374-124">Use a virtual machine family that supports [Premium storage](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-acs-differences).</span><span class="sxs-lookup"><span data-stu-id="86374-124">Use a virtual machine family that supports [Premium storage](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-acs-differences).</span></span>|
|<span data-ttu-id="86374-125">Disks</span><span class="sxs-lookup"><span data-stu-id="86374-125">Disks</span></span> |<span data-ttu-id="86374-126">Use a minimum of two data disks (one for log files and one for data file and TempDB), and choose the disk size based on your capacity needs.</span><span class="sxs-lookup"><span data-stu-id="86374-126">Use a minimum of two data disks (one for log files and one for data file and TempDB), and choose the disk size based on your capacity needs.</span></span> <span data-ttu-id="86374-127">Set the default data file locations to these disks during the SQL Server install.</span><span class="sxs-lookup"><span data-stu-id="86374-127">Set the default data file locations to these disks during the SQL Server install.</span></span><br><br><span data-ttu-id="86374-128">Avoid using operating system or temporary disks for database storage or logging.</span><span class="sxs-lookup"><span data-stu-id="86374-128">Avoid using operating system or temporary disks for database storage or logging.</span></span><br><span data-ttu-id="86374-129">Stripe multiple Azure data disks to get increased IO throughput using Storage Spaces.</span><span class="sxs-lookup"><span data-stu-id="86374-129">Stripe multiple Azure data disks to get increased IO throughput using Storage Spaces.</span></span><br><br><span data-ttu-id="86374-130">Format with documented allocation sizes.</span><span class="sxs-lookup"><span data-stu-id="86374-130">Format with documented allocation sizes.</span></span>|
|<span data-ttu-id="86374-131">I/O</span><span class="sxs-lookup"><span data-stu-id="86374-131">I/O</span></span>|<span data-ttu-id="86374-132">Enable instant file initialization for data files.</span><span class="sxs-lookup"><span data-stu-id="86374-132">Enable instant file initialization for data files.</span></span><br><br><span data-ttu-id="86374-133">Limit autogrow on the databases with reasonably small fixed increments (64 MB-256 MB).</span><span class="sxs-lookup"><span data-stu-id="86374-133">Limit autogrow on the databases with reasonably small fixed increments (64 MB-256 MB).</span></span><br><br><span data-ttu-id="86374-134">Disable autoshrink on the database.</span><span class="sxs-lookup"><span data-stu-id="86374-134">Disable autoshrink on the database.</span></span><br><br><span data-ttu-id="86374-135">Set up default backup and database file locations on data disks, not the operating system disk.</span><span class="sxs-lookup"><span data-stu-id="86374-135">Set up default backup and database file locations on data disks, not the operating system disk.</span></span><br><br><span data-ttu-id="86374-136">Enable locked pages.</span><span class="sxs-lookup"><span data-stu-id="86374-136">Enable locked pages.</span></span><br><br><span data-ttu-id="86374-137">Apply SQL Server service packs and cumulative updates.</span><span class="sxs-lookup"><span data-stu-id="86374-137">Apply SQL Server service packs and cumulative updates.</span></span>|
|<span data-ttu-id="86374-138">Feature-specific</span><span class="sxs-lookup"><span data-stu-id="86374-138">Feature-specific</span></span>|<span data-ttu-id="86374-139">Back up directly to blob storage (if supported by the SQL Server version in use).</span><span class="sxs-lookup"><span data-stu-id="86374-139">Back up directly to blob storage (if supported by the SQL Server version in use).</span></span>|
|||

<span data-ttu-id="86374-140">For more information on *how* and *why* to make these optimizations, please review the details and guidance provided in the following sections.</span><span class="sxs-lookup"><span data-stu-id="86374-140">For more information on *how* and *why* to make these optimizations, please review the details and guidance provided in the following sections.</span></span>

## <a name="virtual-machine-size-guidance"></a><span data-ttu-id="86374-141">Virtual machine size guidance</span><span class="sxs-lookup"><span data-stu-id="86374-141">Virtual machine size guidance</span></span>

<span data-ttu-id="86374-142">For performance-sensitive applications, the following [virtual machine sizes](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) are recommended:</span><span class="sxs-lookup"><span data-stu-id="86374-142">For performance-sensitive applications, the following [virtual machine sizes](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) are recommended:</span></span>

- <span data-ttu-id="86374-143">**SQL Server Enterprise edition:** DS3 or higher</span><span class="sxs-lookup"><span data-stu-id="86374-143">**SQL Server Enterprise edition:** DS3 or higher</span></span>

- <span data-ttu-id="86374-144">**SQL Server Standard edition and Web edition:** DS2 or higher</span><span class="sxs-lookup"><span data-stu-id="86374-144">**SQL Server Standard edition and Web edition:** DS2 or higher</span></span>

<span data-ttu-id="86374-145">With Azure Stack there is no performance difference between the DS and DS_v2 virtual machine family series.</span><span class="sxs-lookup"><span data-stu-id="86374-145">With Azure Stack there is no performance difference between the DS and DS_v2 virtual machine family series.</span></span>

## <a name="storage-guidance"></a><span data-ttu-id="86374-146">Storage guidance</span><span class="sxs-lookup"><span data-stu-id="86374-146">Storage guidance</span></span>

<span data-ttu-id="86374-147">DS-series (along with DSv2-series) virtual machines in Azure Stack provide the maximum operating system disk and data disk throughput (IOPS).</span><span class="sxs-lookup"><span data-stu-id="86374-147">DS-series (along with DSv2-series) virtual machines in Azure Stack provide the maximum operating system disk and data disk throughput (IOPS).</span></span> <span data-ttu-id="86374-148">A virtual machine from the DS or DSv2 series provides up to 1,000 IOPS for the operating system disk and up to 2,300 IOPS per data disk, no matter the type or size of the chosen disk.</span><span class="sxs-lookup"><span data-stu-id="86374-148">A virtual machine from the DS or DSv2 series provides up to 1,000 IOPS for the operating system disk and up to 2,300 IOPS per data disk, no matter the type or size of the chosen disk.</span></span>

<span data-ttu-id="86374-149">Data disk throughput is determined uniquely based on the virtual machine family series.</span><span class="sxs-lookup"><span data-stu-id="86374-149">Data disk throughput is determined uniquely based on the virtual machine family series.</span></span> <span data-ttu-id="86374-150">You can [refer to this article](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) to identify the data disk throughput per virtual machine family series.</span><span class="sxs-lookup"><span data-stu-id="86374-150">You can [refer to this article](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) to identify the data disk throughput per virtual machine family series.</span></span>

> [!NOTE]  
> <span data-ttu-id="86374-151">For production workloads, select a DS-series or DSv2-series virtual machine to provide the maximum possible IOPS on the operating system disk and data disks.</span><span class="sxs-lookup"><span data-stu-id="86374-151">For production workloads, select a DS-series or DSv2-series virtual machine to provide the maximum possible IOPS on the operating system disk and data disks.</span></span>

<span data-ttu-id="86374-152">When creating a storage account in Azure Stack, the geo-replication option has no effect because this capability is not available in Azure Stack.</span><span class="sxs-lookup"><span data-stu-id="86374-152">When creating a storage account in Azure Stack, the geo-replication option has no effect because this capability is not available in Azure Stack.</span></span>

## <a name="disks-guidance"></a><span data-ttu-id="86374-153">Disks guidance</span><span class="sxs-lookup"><span data-stu-id="86374-153">Disks guidance</span></span>

<span data-ttu-id="86374-154">There are three main disk types on an Azure Stack virtual machine:</span><span class="sxs-lookup"><span data-stu-id="86374-154">There are three main disk types on an Azure Stack virtual machine:</span></span>

- <span data-ttu-id="86374-155">**Operating system disk:** When you create an Azure Stack virtual machine, the platform attaches at least one disk (labeled as the **C** drive) to the virtual machine for your operating system disk.</span><span class="sxs-lookup"><span data-stu-id="86374-155">**Operating system disk:** When you create an Azure Stack virtual machine, the platform attaches at least one disk (labeled as the **C** drive) to the virtual machine for your operating system disk.</span></span> <span data-ttu-id="86374-156">This disk is a VHD stored as a page blob in storage.</span><span class="sxs-lookup"><span data-stu-id="86374-156">This disk is a VHD stored as a page blob in storage.</span></span>

- <span data-ttu-id="86374-157">**Temporary disk:** Azure Stack virtual machines contain another disk called the temporary disk (labeled as the **D** drive).</span><span class="sxs-lookup"><span data-stu-id="86374-157">**Temporary disk:** Azure Stack virtual machines contain another disk called the temporary disk (labeled as the **D** drive).</span></span> <span data-ttu-id="86374-158">This is a disk on the node that can be used for scratch space.</span><span class="sxs-lookup"><span data-stu-id="86374-158">This is a disk on the node that can be used for scratch space.</span></span>

- <span data-ttu-id="86374-159">**Data disks:** You can attach additional disks to your virtual machine as data disks, and these disks are stored in storage as page blobs.</span><span class="sxs-lookup"><span data-stu-id="86374-159">**Data disks:** You can attach additional disks to your virtual machine as data disks, and these disks are stored in storage as page blobs.</span></span>

<span data-ttu-id="86374-160">The following sections describe recommendations for using these different disks.</span><span class="sxs-lookup"><span data-stu-id="86374-160">The following sections describe recommendations for using these different disks.</span></span>

### <a name="operating-system-disk"></a><span data-ttu-id="86374-161">Operating system disk</span><span class="sxs-lookup"><span data-stu-id="86374-161">Operating system disk</span></span>

<span data-ttu-id="86374-162">An operating system disk is a VHD that you can boot and mount as a running version of an operating system and is labeled as **C** drive.</span><span class="sxs-lookup"><span data-stu-id="86374-162">An operating system disk is a VHD that you can boot and mount as a running version of an operating system and is labeled as **C** drive.</span></span>

### <a name="temporary-disk"></a><span data-ttu-id="86374-163">Temporary disk</span><span class="sxs-lookup"><span data-stu-id="86374-163">Temporary disk</span></span>

<span data-ttu-id="86374-164">The temporary storage drive, labeled as the **D** drive, is not persisted.</span><span class="sxs-lookup"><span data-stu-id="86374-164">The temporary storage drive, labeled as the **D** drive, is not persisted.</span></span> <span data-ttu-id="86374-165">Do not store any data you are unwilling to lose, such as your user database files or user transaction log files, on the **D** drive.</span><span class="sxs-lookup"><span data-stu-id="86374-165">Do not store any data you are unwilling to lose, such as your user database files or user transaction log files, on the **D** drive.</span></span>

<span data-ttu-id="86374-166">We recommend storing TempDB on a data disk as each data disk provides a maximum of up to 2,300 IOPS per data disk.</span><span class="sxs-lookup"><span data-stu-id="86374-166">We recommend storing TempDB on a data disk as each data disk provides a maximum of up to 2,300 IOPS per data disk.</span></span>

### <a name="data-disks"></a><span data-ttu-id="86374-167">Data disks</span><span class="sxs-lookup"><span data-stu-id="86374-167">Data disks</span></span>

- <span data-ttu-id="86374-168">**Use data disks for data and log files.**</span><span class="sxs-lookup"><span data-stu-id="86374-168">**Use data disks for data and log files.**</span></span> <span data-ttu-id="86374-169">If you are not using disk striping, use two data disks from a virtual machine that supports Premium storage, where one disk contains the log files and the other contains the data and TempDB files.</span><span class="sxs-lookup"><span data-stu-id="86374-169">If you are not using disk striping, use two data disks from a virtual machine that supports Premium storage, where one disk contains the log files and the other contains the data and TempDB files.</span></span> <span data-ttu-id="86374-170">Each data disk provides a number of IOPS and bandwidth (MB/s) depending on the virtual machine family, as described in [Virtual machine sizes supported in Azure Stack](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes).</span><span class="sxs-lookup"><span data-stu-id="86374-170">Each data disk provides a number of IOPS and bandwidth (MB/s) depending on the virtual machine family, as described in [Virtual machine sizes supported in Azure Stack](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes).</span></span> <span data-ttu-id="86374-171">If you are using a disk-striping technique, such as Storage Spaces, place all data and log files on the same drive (including TempDB).</span><span class="sxs-lookup"><span data-stu-id="86374-171">If you are using a disk-striping technique, such as Storage Spaces, place all data and log files on the same drive (including TempDB).</span></span> <span data-ttu-id="86374-172">This configuration gives you the maximum number of IOPS available for SQL Server to consume, no matter which file needs them at any particular time.</span><span class="sxs-lookup"><span data-stu-id="86374-172">This configuration gives you the maximum number of IOPS available for SQL Server to consume, no matter which file needs them at any particular time.</span></span>

> [!NOTE]  
> <span data-ttu-id="86374-173">When you provision a SQL Server virtual machine in the portal, you have the option of editing your storage configuration.</span><span class="sxs-lookup"><span data-stu-id="86374-173">When you provision a SQL Server virtual machine in the portal, you have the option of editing your storage configuration.</span></span> <span data-ttu-id="86374-174">Depending on your configuration, Azure Stack configures one or more disks.</span><span class="sxs-lookup"><span data-stu-id="86374-174">Depending on your configuration, Azure Stack configures one or more disks.</span></span> <span data-ttu-id="86374-175">Multiple disks are combined into a single storage pool.</span><span class="sxs-lookup"><span data-stu-id="86374-175">Multiple disks are combined into a single storage pool.</span></span> <span data-ttu-id="86374-176">Both the data and log files reside together in this configuration.</span><span class="sxs-lookup"><span data-stu-id="86374-176">Both the data and log files reside together in this configuration.</span></span>

- <span data-ttu-id="86374-177">**Disk striping:** For more throughput, you can add additional data disks and use disk striping.</span><span class="sxs-lookup"><span data-stu-id="86374-177">**Disk striping:** For more throughput, you can add additional data disks and use disk striping.</span></span> <span data-ttu-id="86374-178">To determine the number of data disks you need, analyze the number of IOPS and bandwidth required for your log files and for your data and TempDB files.</span><span class="sxs-lookup"><span data-stu-id="86374-178">To determine the number of data disks you need, analyze the number of IOPS and bandwidth required for your log files and for your data and TempDB files.</span></span> <span data-ttu-id="86374-179">Notice that IOPS limits are per data disk based on the virtual machine series family, and not based on the virtual machine size.</span><span class="sxs-lookup"><span data-stu-id="86374-179">Notice that IOPS limits are per data disk based on the virtual machine series family, and not based on the virtual machine size.</span></span> <span data-ttu-id="86374-180">Network bandwidth limits, however, are based on the virtual machine size.</span><span class="sxs-lookup"><span data-stu-id="86374-180">Network bandwidth limits, however, are based on the virtual machine size.</span></span> <span data-ttu-id="86374-181">See the tables on [Virtual machine sizes in Azure Stack](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) for more detail.</span><span class="sxs-lookup"><span data-stu-id="86374-181">See the tables on [Virtual machine sizes in Azure Stack](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) for more detail.</span></span> <span data-ttu-id="86374-182">Use the following guidelines:</span><span class="sxs-lookup"><span data-stu-id="86374-182">Use the following guidelines:</span></span>

    - <span data-ttu-id="86374-183">For Windows Server 2012 or later, use [Storage Spaces](https://technet.microsoft.com/library/hh831739.aspx) with the following guidelines:</span><span class="sxs-lookup"><span data-stu-id="86374-183">For Windows Server 2012 or later, use [Storage Spaces](https://technet.microsoft.com/library/hh831739.aspx) with the following guidelines:</span></span>

        1.  <span data-ttu-id="86374-184">Set the interleave (stripe size) to 64 KB (65,536 bytes) for online transaction processing (OLTP) workloads and 256 KB (262,144 bytes) for data warehousing workloads to avoid performance impact due to partition misalignment.</span><span class="sxs-lookup"><span data-stu-id="86374-184">Set the interleave (stripe size) to 64 KB (65,536 bytes) for online transaction processing (OLTP) workloads and 256 KB (262,144 bytes) for data warehousing workloads to avoid performance impact due to partition misalignment.</span></span> <span data-ttu-id="86374-185">This must be set with PowerShell.</span><span class="sxs-lookup"><span data-stu-id="86374-185">This must be set with PowerShell.</span></span>

        2.  <span data-ttu-id="86374-186">Set column count = number of physical disks.</span><span class="sxs-lookup"><span data-stu-id="86374-186">Set column count = number of physical disks.</span></span> <span data-ttu-id="86374-187">Use PowerShell when configuring more than eight disks (not Server Manager UI).</span><span class="sxs-lookup"><span data-stu-id="86374-187">Use PowerShell when configuring more than eight disks (not Server Manager UI).</span></span>

            <span data-ttu-id="86374-188">For example, the following PowerShell creates a new storage pool with the interleave size set to 64 KB and the number of columns to 2:</span><span class="sxs-lookup"><span data-stu-id="86374-188">For example, the following PowerShell creates a new storage pool with the interleave size set to 64 KB and the number of columns to 2:</span></span>

          ```PowerShell  
          $PoolCount = Get-PhysicalDisk -CanPool $True
          $PhysicalDisks = Get-PhysicalDisk | Where-Object {$_.FriendlyName -like "*2" -or $_.FriendlyName -like "*3"}

          New-StoragePool -FriendlyName "DataFiles" -StorageSubsystemFriendlyName "Storage Spaces*" -PhysicalDisks $PhysicalDisks | New-VirtualDisk -FriendlyName "DataFiles" -Interleave 65536 -NumberOfColumns 2 -ResiliencySettingName simple –UseMaximumSize |Initialize-Disk -PartitionStyle GPT -PassThru |New-Partition -AssignDriveLetter -UseMaximumSize |Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDisks" -AllocationUnitSize 65536 -Confirm:$false
          ```

- <span data-ttu-id="86374-189">Determine the number of disks associated with your storage pool based on your load expectations.</span><span class="sxs-lookup"><span data-stu-id="86374-189">Determine the number of disks associated with your storage pool based on your load expectations.</span></span> <span data-ttu-id="86374-190">Keep in mind that different virtual machine sizes allow different numbers of attached data disks.</span><span class="sxs-lookup"><span data-stu-id="86374-190">Keep in mind that different virtual machine sizes allow different numbers of attached data disks.</span></span> <span data-ttu-id="86374-191">For more information, see [Virtual machine sizes supported in Azure Stack](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes).</span><span class="sxs-lookup"><span data-stu-id="86374-191">For more information, see [Virtual machine sizes supported in Azure Stack](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes).</span></span>
- <span data-ttu-id="86374-192">In order to get the maximum possible IOPS for data disks, the recommendation is to add the maximum number of data disks supported by your [virtual machine size](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) and use disk striping.</span><span class="sxs-lookup"><span data-stu-id="86374-192">In order to get the maximum possible IOPS for data disks, the recommendation is to add the maximum number of data disks supported by your [virtual machine size](https://docs.microsoft.com/azure/azure-stack/user/azure-stack-vm-sizes) and use disk striping.</span></span>
- <span data-ttu-id="86374-193">**NTFS allocation unit size:** When formatting the data disk, it is recommended that you use a 64-KB allocation unit size for data and log files as well as TempDB.</span><span class="sxs-lookup"><span data-stu-id="86374-193">**NTFS allocation unit size:** When formatting the data disk, it is recommended that you use a 64-KB allocation unit size for data and log files as well as TempDB.</span></span>
- <span data-ttu-id="86374-194">**Disk management practices:** When removing a data disk, stop the SQL Server service during the change.</span><span class="sxs-lookup"><span data-stu-id="86374-194">**Disk management practices:** When removing a data disk, stop the SQL Server service during the change.</span></span> <span data-ttu-id="86374-195">Also, don't change cache settings on the disks as it doesn't provide any performance improvements.</span><span class="sxs-lookup"><span data-stu-id="86374-195">Also, don't change cache settings on the disks as it doesn't provide any performance improvements.</span></span>

> [!WARNING]  
> <span data-ttu-id="86374-196">Failure to stop the SQL Service during these operations can cause database corruption.</span><span class="sxs-lookup"><span data-stu-id="86374-196">Failure to stop the SQL Service during these operations can cause database corruption.</span></span>

## <a name="io-guidance"></a><span data-ttu-id="86374-197">I/O guidance</span><span class="sxs-lookup"><span data-stu-id="86374-197">I/O guidance</span></span>

- <span data-ttu-id="86374-198">Consider enabling instant file initialization to reduce the time that is required for initial file allocation.</span><span class="sxs-lookup"><span data-stu-id="86374-198">Consider enabling instant file initialization to reduce the time that is required for initial file allocation.</span></span> <span data-ttu-id="86374-199">To take advantage of instant file initialization, you grant the SQL Server (MSSQLSERVER) service account with **SE_MANAGE_VOLUME_NAME** and add it to the **Perform Volume Maintenance Tasks** security policy.</span><span class="sxs-lookup"><span data-stu-id="86374-199">To take advantage of instant file initialization, you grant the SQL Server (MSSQLSERVER) service account with **SE_MANAGE_VOLUME_NAME** and add it to the **Perform Volume Maintenance Tasks** security policy.</span></span> <span data-ttu-id="86374-200">If you are using a SQL Server platform image for Azure, the default service account (**NT Service\MSSQLSERVER**) isn’t added to the **Perform Volume Maintenance Tasks** security policy.</span><span class="sxs-lookup"><span data-stu-id="86374-200">If you are using a SQL Server platform image for Azure, the default service account (**NT Service\MSSQLSERVER**) isn’t added to the **Perform Volume Maintenance Tasks** security policy.</span></span> <span data-ttu-id="86374-201">In other words, instant file initialization is not enabled in a SQL Server Azure platform image.</span><span class="sxs-lookup"><span data-stu-id="86374-201">In other words, instant file initialization is not enabled in a SQL Server Azure platform image.</span></span> <span data-ttu-id="86374-202">After adding the SQL Server service account to the **Perform Volume Maintenance Tasks** security policy, restart the SQL Server service.</span><span class="sxs-lookup"><span data-stu-id="86374-202">After adding the SQL Server service account to the **Perform Volume Maintenance Tasks** security policy, restart the SQL Server service.</span></span> <span data-ttu-id="86374-203">There could be security considerations for using this feature.</span><span class="sxs-lookup"><span data-stu-id="86374-203">There could be security considerations for using this feature.</span></span> <span data-ttu-id="86374-204">For more information, see [Database File Initialization](https://msdn.microsoft.com/library/ms175935.aspx).</span><span class="sxs-lookup"><span data-stu-id="86374-204">For more information, see [Database File Initialization](https://msdn.microsoft.com/library/ms175935.aspx).</span></span>
- <span data-ttu-id="86374-205">**Autogrow** is a contingency for unexpected growth.</span><span class="sxs-lookup"><span data-stu-id="86374-205">**Autogrow** is a contingency for unexpected growth.</span></span> <span data-ttu-id="86374-206">Do not manage your data and log growth on a day-to-day basis with autogrow.</span><span class="sxs-lookup"><span data-stu-id="86374-206">Do not manage your data and log growth on a day-to-day basis with autogrow.</span></span> <span data-ttu-id="86374-207">If autogrow is used, pre-grow the file using the **Size** switch.</span><span class="sxs-lookup"><span data-stu-id="86374-207">If autogrow is used, pre-grow the file using the **Size** switch.</span></span>
- <span data-ttu-id="86374-208">Make sure **autoshrink** is disabled to avoid unnecessary overhead that can negatively affect performance.</span><span class="sxs-lookup"><span data-stu-id="86374-208">Make sure **autoshrink** is disabled to avoid unnecessary overhead that can negatively affect performance.</span></span>
- <span data-ttu-id="86374-209">Setup default backup and database file locations.</span><span class="sxs-lookup"><span data-stu-id="86374-209">Setup default backup and database file locations.</span></span> <span data-ttu-id="86374-210">Use the recommendations in this article and make the changes in the Server properties window.</span><span class="sxs-lookup"><span data-stu-id="86374-210">Use the recommendations in this article and make the changes in the Server properties window.</span></span> <span data-ttu-id="86374-211">For instructions, see [View or Change the Default Locations for Data and Log Files (SQL Server Management Studio)](https://msdn.microsoft.com/library/dd206993.aspx).</span><span class="sxs-lookup"><span data-stu-id="86374-211">For instructions, see [View or Change the Default Locations for Data and Log Files (SQL Server Management Studio)](https://msdn.microsoft.com/library/dd206993.aspx).</span></span> <span data-ttu-id="86374-212">The following screenshot demonstrates where to make these changes:</span><span class="sxs-lookup"><span data-stu-id="86374-212">The following screenshot demonstrates where to make these changes:</span></span>

    > ![View or Change the Default Locations](./media/sql-server-vm-considerations/image1.png)

- <span data-ttu-id="86374-214">Enable locked pages to reduce IO and any paging activities.</span><span class="sxs-lookup"><span data-stu-id="86374-214">Enable locked pages to reduce IO and any paging activities.</span></span> <span data-ttu-id="86374-215">For more information, see [Enable the Lock Pages in Memory Option (Windows)](https://msdn.microsoft.com/library/ms190730.aspx).</span><span class="sxs-lookup"><span data-stu-id="86374-215">For more information, see [Enable the Lock Pages in Memory Option (Windows)](https://msdn.microsoft.com/library/ms190730.aspx).</span></span>

- <span data-ttu-id="86374-216">Consider compressing any data files when transferring in/out of Azure Stack, including backups.</span><span class="sxs-lookup"><span data-stu-id="86374-216">Consider compressing any data files when transferring in/out of Azure Stack, including backups.</span></span>

## <a name="feature-specific-guidance"></a><span data-ttu-id="86374-217">Feature-specific guidance</span><span class="sxs-lookup"><span data-stu-id="86374-217">Feature-specific guidance</span></span>

<span data-ttu-id="86374-218">Some deployments may achieve additional performance benefits using more advanced configuration techniques.</span><span class="sxs-lookup"><span data-stu-id="86374-218">Some deployments may achieve additional performance benefits using more advanced configuration techniques.</span></span> <span data-ttu-id="86374-219">The following list highlights some SQL Server features that may help you achieve better performance:</span><span class="sxs-lookup"><span data-stu-id="86374-219">The following list highlights some SQL Server features that may help you achieve better performance:</span></span>

- <span data-ttu-id="86374-220">**Back up to Azure** **storage.**</span><span class="sxs-lookup"><span data-stu-id="86374-220">**Back up to Azure** **storage.**</span></span> <span data-ttu-id="86374-221">When performing backups for SQL Server running in Azure Stack virtual machines, you can use SQL Server Backup to URL.</span><span class="sxs-lookup"><span data-stu-id="86374-221">When performing backups for SQL Server running in Azure Stack virtual machines, you can use SQL Server Backup to URL.</span></span> <span data-ttu-id="86374-222">This feature is available starting with SQL Server 2012 SP1 CU2 and recommended for backing up to the attached data disks.</span><span class="sxs-lookup"><span data-stu-id="86374-222">This feature is available starting with SQL Server 2012 SP1 CU2 and recommended for backing up to the attached data disks.</span></span>

    <span data-ttu-id="86374-223">When your backup or restore using Azure storage, follow the recommendations provided in [SQL Server Backup to URL Best Practices and Troubleshooting](https://msdn.microsoft.com/library/jj919149.aspx) and [Restoring From Backups Stored in Microsoft Azure](https://docs.microsoft.com/en-us/sql/relational-databases/backup-restore/restoring-from-backups-stored-in-microsoft-azure?view=sql-server-2017).</span><span class="sxs-lookup"><span data-stu-id="86374-223">When your backup or restore using Azure storage, follow the recommendations provided in [SQL Server Backup to URL Best Practices and Troubleshooting](https://msdn.microsoft.com/library/jj919149.aspx) and [Restoring From Backups Stored in Microsoft Azure](https://docs.microsoft.com/en-us/sql/relational-databases/backup-restore/restoring-from-backups-stored-in-microsoft-azure?view=sql-server-2017).</span></span> <span data-ttu-id="86374-224">You can also automate these backups using [Automated Backup for SQL Server in Azure Virtual Machines](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-automated-backup).</span><span class="sxs-lookup"><span data-stu-id="86374-224">You can also automate these backups using [Automated Backup for SQL Server in Azure Virtual Machines](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-automated-backup).</span></span>

-   <span data-ttu-id="86374-225">**Back up to Azure Stack storage.**</span><span class="sxs-lookup"><span data-stu-id="86374-225">**Back up to Azure Stack storage.**</span></span> <span data-ttu-id="86374-226">You can back up to Azure Stack storage in a similar fashion as with backing up to Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="86374-226">You can back up to Azure Stack storage in a similar fashion as with backing up to Azure Storage.</span></span> <span data-ttu-id="86374-227">When you create a backup inside SQL Server Management Studio (SSMS), you need to enter the configuration information manually.</span><span class="sxs-lookup"><span data-stu-id="86374-227">When you create a backup inside SQL Server Management Studio (SSMS), you need to enter the configuration information manually.</span></span> <span data-ttu-id="86374-228">You cannot use SSMS to create the storage container or the Shared Access Signature.</span><span class="sxs-lookup"><span data-stu-id="86374-228">You cannot use SSMS to create the storage container or the Shared Access Signature.</span></span> <span data-ttu-id="86374-229">SSMS only connects to Azure subscriptions, not Azure Stack subscriptions.</span><span class="sxs-lookup"><span data-stu-id="86374-229">SSMS only connects to Azure subscriptions, not Azure Stack subscriptions.</span></span> <span data-ttu-id="86374-230">Instead, you need to create the storage account, container, and Shared Access Signature in the Azure Stack portal or with PowerShell.</span><span class="sxs-lookup"><span data-stu-id="86374-230">Instead, you need to create the storage account, container, and Shared Access Signature in the Azure Stack portal or with PowerShell.</span></span>

    <span data-ttu-id="86374-231">When you place the information into the SQL Server Backup dialog:</span><span class="sxs-lookup"><span data-stu-id="86374-231">When you place the information into the SQL Server Backup dialog:</span></span>

    ![SQL Server Backup](./media/sql-server-vm-considerations/image3.png)

    > [!NOTE]  
    > <span data-ttu-id="86374-233">The Shared Access Signature is the SAS token from the Azure Stack portal, without the leading ‘?’</span><span class="sxs-lookup"><span data-stu-id="86374-233">The Shared Access Signature is the SAS token from the Azure Stack portal, without the leading ‘?’</span></span> <span data-ttu-id="86374-234">in the string.</span><span class="sxs-lookup"><span data-stu-id="86374-234">in the string.</span></span> <span data-ttu-id="86374-235">If you use the copy function from the portal, you need to delete the leading ‘?’</span><span class="sxs-lookup"><span data-stu-id="86374-235">If you use the copy function from the portal, you need to delete the leading ‘?’</span></span> <span data-ttu-id="86374-236">for the token to work within SQL Server.</span><span class="sxs-lookup"><span data-stu-id="86374-236">for the token to work within SQL Server.</span></span>

    <span data-ttu-id="86374-237">Once you have the Backup Destination set up and configured in SQL Server, you can then back up to the Azure Stack blob storage.</span><span class="sxs-lookup"><span data-stu-id="86374-237">Once you have the Backup Destination set up and configured in SQL Server, you can then back up to the Azure Stack blob storage.</span></span>

## <a name="next-steps"></a><span data-ttu-id="86374-238">Next steps</span><span class="sxs-lookup"><span data-stu-id="86374-238">Next steps</span></span>

[<span data-ttu-id="86374-239">Using services or building apps for Azure Stack</span><span class="sxs-lookup"><span data-stu-id="86374-239">Using services or building apps for Azure Stack</span></span>](azure-stack-considerations.md)