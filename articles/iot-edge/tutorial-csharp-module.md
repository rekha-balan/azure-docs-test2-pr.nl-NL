---
title: Azure IoT Edge C# tutorial | Microsoft Docs
description: This tutorial shows you how to create an IoT Edge module with C# code and deploy it to an edge device.
services: iot-edge
author: kgremban
manager: timlt
ms.author: kgremban
ms.date: 06/27/2018
ms.topic: tutorial
ms.service: iot-edge
ms.custom: mvc
ms.openlocfilehash: 8a3cc9793af39deeb24fa725da5cf0dc536f4465
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44868541"
---
# <a name="tutorial-develop-a-c-iot-edge-module-and-deploy-to-your-simulated-device"></a><span data-ttu-id="0f4a0-103">Tutorial: Develop a C# IoT Edge module and deploy to your simulated device</span><span class="sxs-lookup"><span data-stu-id="0f4a0-103">Tutorial: Develop a C# IoT Edge module and deploy to your simulated device</span></span>

<span data-ttu-id="0f4a0-104">You can use Azure IoT Edge modules to deploy code that implements your business logic directly to your IoT Edge devices.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-104">You can use Azure IoT Edge modules to deploy code that implements your business logic directly to your IoT Edge devices.</span></span> <span data-ttu-id="0f4a0-105">This tutorial walks you through creating and deploying an IoT Edge module that filters sensor data.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-105">This tutorial walks you through creating and deploying an IoT Edge module that filters sensor data.</span></span> <span data-ttu-id="0f4a0-106">You'll use the simulated IoT Edge device that you created in the Deploy Azure IoT Edge on a simulated device in [Windows][lnk-tutorial1-win] or [Linux][lnk-tutorial1-lin] quickstarts.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-106">You'll use the simulated IoT Edge device that you created in the Deploy Azure IoT Edge on a simulated device in [Windows][lnk-tutorial1-win] or [Linux][lnk-tutorial1-lin] quickstarts.</span></span> <span data-ttu-id="0f4a0-107">In this tutorial, you learn how to:</span><span class="sxs-lookup"><span data-stu-id="0f4a0-107">In this tutorial, you learn how to:</span></span>    

> [!div class="checklist"]
> * <span data-ttu-id="0f4a0-108">Use Visual Studio Code to create an IoT Edge module that's based on the .NET Core 2.0 SDK.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-108">Use Visual Studio Code to create an IoT Edge module that's based on the .NET Core 2.0 SDK.</span></span>
> * <span data-ttu-id="0f4a0-109">Use Visual Studio Code and Docker to create a Docker image and publish it to your registry.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-109">Use Visual Studio Code and Docker to create a Docker image and publish it to your registry.</span></span>
> * <span data-ttu-id="0f4a0-110">Deploy the module to your IoT Edge device.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-110">Deploy the module to your IoT Edge device.</span></span>
> * <span data-ttu-id="0f4a0-111">View generated data.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-111">View generated data.</span></span>


<span data-ttu-id="0f4a0-112">The IoT Edge module that you create in this tutorial filters the temperature data that's generated by your device.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-112">The IoT Edge module that you create in this tutorial filters the temperature data that's generated by your device.</span></span> <span data-ttu-id="0f4a0-113">It only sends messages upstream if the temperature is above a specified threshold.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-113">It only sends messages upstream if the temperature is above a specified threshold.</span></span> <span data-ttu-id="0f4a0-114">This type of analysis at the edge is useful for reducing the amount of data that's communicated to and stored in the cloud.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-114">This type of analysis at the edge is useful for reducing the amount of data that's communicated to and stored in the cloud.</span></span> 

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]


## <a name="prerequisites"></a><span data-ttu-id="0f4a0-115">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="0f4a0-115">Prerequisites</span></span>

<span data-ttu-id="0f4a0-116">An Azure IoT Edge device:</span><span class="sxs-lookup"><span data-stu-id="0f4a0-116">An Azure IoT Edge device:</span></span>

* <span data-ttu-id="0f4a0-117">You can use your development machine or a virtual machine as an Edge device by following the steps in the quickstart for [Linux](quickstart-linux.md) or [Windows devices](quickstart.md).</span><span class="sxs-lookup"><span data-stu-id="0f4a0-117">You can use your development machine or a virtual machine as an Edge device by following the steps in the quickstart for [Linux](quickstart-linux.md) or [Windows devices](quickstart.md).</span></span>

<span data-ttu-id="0f4a0-118">Cloud resources:</span><span class="sxs-lookup"><span data-stu-id="0f4a0-118">Cloud resources:</span></span>

* <span data-ttu-id="0f4a0-119">A standard-tier [IoT Hub](../iot-hub/iot-hub-create-through-portal.md) in Azure.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-119">A standard-tier [IoT Hub](../iot-hub/iot-hub-create-through-portal.md) in Azure.</span></span> 

<span data-ttu-id="0f4a0-120">Development resources:</span><span class="sxs-lookup"><span data-stu-id="0f4a0-120">Development resources:</span></span>

* <span data-ttu-id="0f4a0-121">[Visual Studio Code](https://code.visualstudio.com/).</span><span class="sxs-lookup"><span data-stu-id="0f4a0-121">[Visual Studio Code](https://code.visualstudio.com/).</span></span> 
* <span data-ttu-id="0f4a0-122">[C# for Visual Studio Code (powered by OmniSharp) extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode.csharp).</span><span class="sxs-lookup"><span data-stu-id="0f4a0-122">[C# for Visual Studio Code (powered by OmniSharp) extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode.csharp).</span></span>
* <span data-ttu-id="0f4a0-123">[Azure IoT Edge extension](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-edge) for Visual Studio Code.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-123">[Azure IoT Edge extension](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-edge) for Visual Studio Code.</span></span> 
* <span data-ttu-id="0f4a0-124">[.NET Core 2.1 SDK](https://www.microsoft.com/net/download).</span><span class="sxs-lookup"><span data-stu-id="0f4a0-124">[.NET Core 2.1 SDK](https://www.microsoft.com/net/download).</span></span>
* [<span data-ttu-id="0f4a0-125">Docker CE</span><span class="sxs-lookup"><span data-stu-id="0f4a0-125">Docker CE</span></span>](https://docs.docker.com/install/)


## <a name="create-a-container-registry"></a><span data-ttu-id="0f4a0-126">Create a container registry</span><span class="sxs-lookup"><span data-stu-id="0f4a0-126">Create a container registry</span></span>
<span data-ttu-id="0f4a0-127">In this tutorial, you use the Azure IoT Edge extension for VS Code to build a module and create a **container image** from the files.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-127">In this tutorial, you use the Azure IoT Edge extension for VS Code to build a module and create a **container image** from the files.</span></span> <span data-ttu-id="0f4a0-128">Then you push this image to a **registry** that stores and manages your images.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-128">Then you push this image to a **registry** that stores and manages your images.</span></span> <span data-ttu-id="0f4a0-129">Finally, you deploy your image from your registry to run on your IoT Edge device.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-129">Finally, you deploy your image from your registry to run on your IoT Edge device.</span></span>  

<span data-ttu-id="0f4a0-130">You can use any Docker-compatible registry for this tutorial.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-130">You can use any Docker-compatible registry for this tutorial.</span></span> <span data-ttu-id="0f4a0-131">Two popular Docker registry services that are available in the cloud are [Azure Container Registry](https://docs.microsoft.com/azure/container-registry/) and [Docker Hub](https://docs.docker.com/docker-hub/repos/#viewing-repository-tags).</span><span class="sxs-lookup"><span data-stu-id="0f4a0-131">Two popular Docker registry services that are available in the cloud are [Azure Container Registry](https://docs.microsoft.com/azure/container-registry/) and [Docker Hub](https://docs.docker.com/docker-hub/repos/#viewing-repository-tags).</span></span> <span data-ttu-id="0f4a0-132">This tutorial uses Azure Container Registry.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-132">This tutorial uses Azure Container Registry.</span></span> 

1. <span data-ttu-id="0f4a0-133">In the [Azure portal](https://portal.azure.com), select **Create a resource** > **Containers** > **Azure Container Registry**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-133">In the [Azure portal](https://portal.azure.com), select **Create a resource** > **Containers** > **Azure Container Registry**.</span></span>
2. <span data-ttu-id="0f4a0-134">Give your registry a name, choose a subscription, choose a resource group, and set the SKU to **Basic**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-134">Give your registry a name, choose a subscription, choose a resource group, and set the SKU to **Basic**.</span></span> 
3. <span data-ttu-id="0f4a0-135">Select **Create**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-135">Select **Create**.</span></span>
4. <span data-ttu-id="0f4a0-136">After your container registry is created, browse to it, and select **Access keys**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-136">After your container registry is created, browse to it, and select **Access keys**.</span></span> 
5. <span data-ttu-id="0f4a0-137">Toggle **Admin user** to **Enable**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-137">Toggle **Admin user** to **Enable**.</span></span>
6. <span data-ttu-id="0f4a0-138">Copy the values for **Login server**, **Username**, and **Password**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-138">Copy the values for **Login server**, **Username**, and **Password**.</span></span> <span data-ttu-id="0f4a0-139">You use these values later in the tutorial to publish the Docker image to your registry and to add the registry credentials to the Azure IoT Edge runtime.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-139">You use these values later in the tutorial to publish the Docker image to your registry and to add the registry credentials to the Azure IoT Edge runtime.</span></span> 

## <a name="create-an-iot-edge-module-project"></a><span data-ttu-id="0f4a0-140">Create an IoT Edge module project</span><span class="sxs-lookup"><span data-stu-id="0f4a0-140">Create an IoT Edge module project</span></span>
<span data-ttu-id="0f4a0-141">The following steps create an IoT Edge module project that's based on the .NET Core 2.0 SDK by using Visual Studio Code and the Azure IoT Edge extension.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-141">The following steps create an IoT Edge module project that's based on the .NET Core 2.0 SDK by using Visual Studio Code and the Azure IoT Edge extension.</span></span>

### <a name="create-a-new-solution"></a><span data-ttu-id="0f4a0-142">Create a new solution</span><span class="sxs-lookup"><span data-stu-id="0f4a0-142">Create a new solution</span></span>

<span data-ttu-id="0f4a0-143">Create a C# solution template that you can customize with your own code.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-143">Create a C# solution template that you can customize with your own code.</span></span> 

1. <span data-ttu-id="0f4a0-144">In Visual Studio Code, select **View** > **Command Palette** to open the VS Code command palette.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-144">In Visual Studio Code, select **View** > **Command Palette** to open the VS Code command palette.</span></span> 

2. <span data-ttu-id="0f4a0-145">In the command palette, enter and run the command **Azure: Sign in** and follow the instructions to sign in your Azure account.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-145">In the command palette, enter and run the command **Azure: Sign in** and follow the instructions to sign in your Azure account.</span></span> <span data-ttu-id="0f4a0-146">If you're already signed in, you can skip this step.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-146">If you're already signed in, you can skip this step.</span></span>

3. <span data-ttu-id="0f4a0-147">In the command palette, enter and run the command **Azure IoT Edge: New IoT Edge solution**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-147">In the command palette, enter and run the command **Azure IoT Edge: New IoT Edge solution**.</span></span> <span data-ttu-id="0f4a0-148">In the command palette, provide the following information to create your solution:</span><span class="sxs-lookup"><span data-stu-id="0f4a0-148">In the command palette, provide the following information to create your solution:</span></span> 

   1. <span data-ttu-id="0f4a0-149">Select the folder where you want to create the solution.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-149">Select the folder where you want to create the solution.</span></span> 
   2. <span data-ttu-id="0f4a0-150">Provide a name for your solution or accept the default **EdgeSolution**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-150">Provide a name for your solution or accept the default **EdgeSolution**.</span></span>
   3. <span data-ttu-id="0f4a0-151">Choose **C# Module** as the module template.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-151">Choose **C# Module** as the module template.</span></span> 
   4. <span data-ttu-id="0f4a0-152">Replace the default module name with **CSharpModule**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-152">Replace the default module name with **CSharpModule**.</span></span> 
   5. <span data-ttu-id="0f4a0-153">Specify the Azure container registry that you created in the previous section as the image repository for your first module.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-153">Specify the Azure container registry that you created in the previous section as the image repository for your first module.</span></span> <span data-ttu-id="0f4a0-154">Replace **localhost:5000** with the login server value that you copied.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-154">Replace **localhost:5000** with the login server value that you copied.</span></span> <span data-ttu-id="0f4a0-155">The final string looks like \<registry name\>.azurecr.io/csharpmodule.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-155">The final string looks like \<registry name\>.azurecr.io/csharpmodule.</span></span>

   ![Provide Docker image repository](./media/tutorial-csharp-module/repository.png)

<span data-ttu-id="0f4a0-157">The VS Code window loads your IoT Edge solution workspace.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-157">The VS Code window loads your IoT Edge solution workspace.</span></span> <span data-ttu-id="0f4a0-158">The solution workspace contains five top-level components.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-158">The solution workspace contains five top-level components.</span></span> <span data-ttu-id="0f4a0-159">You won't edit the **\.vscode** folder or **\.gitignore** file in this tutorial.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-159">You won't edit the **\.vscode** folder or **\.gitignore** file in this tutorial.</span></span> <span data-ttu-id="0f4a0-160">The **modules** folder contains the C# code for your module as well as Dockerfiles for building your module as a container image.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-160">The **modules** folder contains the C# code for your module as well as Dockerfiles for building your module as a container image.</span></span> <span data-ttu-id="0f4a0-161">The **\.env** file stores your container registry credentials.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-161">The **\.env** file stores your container registry credentials.</span></span> <span data-ttu-id="0f4a0-162">The **deployment.template.json** file contains the information that the IoT Edge runtime uses to deploy modules on a device.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-162">The **deployment.template.json** file contains the information that the IoT Edge runtime uses to deploy modules on a device.</span></span> 

<span data-ttu-id="0f4a0-163">If you didn't specify a container registry when creating your solution, but accepted the default localhost:5000 value, you won't have a \.env file.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-163">If you didn't specify a container registry when creating your solution, but accepted the default localhost:5000 value, you won't have a \.env file.</span></span> 

   ![C# solution workspace](./media/tutorial-csharp-module/workspace.png)

### <a name="add-your-registry-credentials"></a><span data-ttu-id="0f4a0-165">Add your registry credentials</span><span class="sxs-lookup"><span data-stu-id="0f4a0-165">Add your registry credentials</span></span>

<span data-ttu-id="0f4a0-166">The environment file stores the credentials for your container registry and shares them with the IoT Edge runtime.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-166">The environment file stores the credentials for your container registry and shares them with the IoT Edge runtime.</span></span> <span data-ttu-id="0f4a0-167">The runtime needs these credentials to pull your private images onto the IoT Edge device.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-167">The runtime needs these credentials to pull your private images onto the IoT Edge device.</span></span> 

1. <span data-ttu-id="0f4a0-168">In the VS Code explorer, open the .env file.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-168">In the VS Code explorer, open the .env file.</span></span> 
2. <span data-ttu-id="0f4a0-169">Update the fields with the **username** and **password** values that you copied from your Azure container registry.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-169">Update the fields with the **username** and **password** values that you copied from your Azure container registry.</span></span> 
3. <span data-ttu-id="0f4a0-170">Save this file.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-170">Save this file.</span></span> 

### <a name="update-the-module-with-custom-code"></a><span data-ttu-id="0f4a0-171">Update the module with custom code</span><span class="sxs-lookup"><span data-stu-id="0f4a0-171">Update the module with custom code</span></span>

1. <span data-ttu-id="0f4a0-172">In the VS Code explorer, open **modules** > **CSharpModule** > **Program.cs**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-172">In the VS Code explorer, open **modules** > **CSharpModule** > **Program.cs**.</span></span>

5. <span data-ttu-id="0f4a0-173">At the top of the **CSharpModule** namespace, add three **using** statements for types that are used later:</span><span class="sxs-lookup"><span data-stu-id="0f4a0-173">At the top of the **CSharpModule** namespace, add three **using** statements for types that are used later:</span></span>

    ```csharp
    using System.Collections.Generic;     // For KeyValuePair<>
    using Microsoft.Azure.Devices.Shared; // For TwinCollection
    using Newtonsoft.Json;                // For JsonConvert
    ```

6. <span data-ttu-id="0f4a0-174">Add the **temperatureThreshold** variable to the **Program** class.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-174">Add the **temperatureThreshold** variable to the **Program** class.</span></span> <span data-ttu-id="0f4a0-175">This variable sets the value that the measured temperature must exceed for the data to be sent to the IoT hub.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-175">This variable sets the value that the measured temperature must exceed for the data to be sent to the IoT hub.</span></span> 

    ```csharp
    static int temperatureThreshold { get; set; } = 25;
    ```

7. <span data-ttu-id="0f4a0-176">Add the **MessageBody**, **Machine**, and **Ambient** classes to the **Program** class.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-176">Add the **MessageBody**, **Machine**, and **Ambient** classes to the **Program** class.</span></span> <span data-ttu-id="0f4a0-177">These classes define the expected schema for the body of incoming messages.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-177">These classes define the expected schema for the body of incoming messages.</span></span>

    ```csharp
    class MessageBody
    {
        public Machine machine {get;set;}
        public Ambient ambient {get; set;}
        public string timeCreated {get; set;}
    }
    class Machine
    {
       public double temperature {get; set;}
       public double pressure {get; set;}         
    }
    class Ambient
    {
       public double temperature {get; set;}
       public int humidity {get; set;}         
    }
    ```

8. <span data-ttu-id="0f4a0-178">In the **Init** method, the code creates and configures a **ModuleClient** object.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-178">In the **Init** method, the code creates and configures a **ModuleClient** object.</span></span> <span data-ttu-id="0f4a0-179">This object allows the module to connect to the local Azure IoT Edge runtime to send and receive messages.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-179">This object allows the module to connect to the local Azure IoT Edge runtime to send and receive messages.</span></span> <span data-ttu-id="0f4a0-180">The connection string that's used in the **Init** method is supplied to the module by the IoT Edge runtime.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-180">The connection string that's used in the **Init** method is supplied to the module by the IoT Edge runtime.</span></span> <span data-ttu-id="0f4a0-181">After creating the **ModuleClient**, the code reads the **temperatureThreshold** value from the module twin's desired properties.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-181">After creating the **ModuleClient**, the code reads the **temperatureThreshold** value from the module twin's desired properties.</span></span> <span data-ttu-id="0f4a0-182">The code registers a callback to receive messages from an IoT Edge hub via the **input1** endpoint.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-182">The code registers a callback to receive messages from an IoT Edge hub via the **input1** endpoint.</span></span> <span data-ttu-id="0f4a0-183">Replace the **SetInputMessageHandlerAsync** method with a new one, and add a **SetDesiredPropertyUpdateCallbackAsync** method for updates to the desired properties.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-183">Replace the **SetInputMessageHandlerAsync** method with a new one, and add a **SetDesiredPropertyUpdateCallbackAsync** method for updates to the desired properties.</span></span> <span data-ttu-id="0f4a0-184">To make this change, replace the last line of the **Init** method with the following code:</span><span class="sxs-lookup"><span data-stu-id="0f4a0-184">To make this change, replace the last line of the **Init** method with the following code:</span></span>

    ```csharp
    // Register a callback for messages that are received by the module.
    // await ioTHubModuleClient.SetImputMessageHandlerAsync("input1", PipeMessage, iotHubModuleClient);

    // Read the TemperatureThreshold value from the module twin's desired properties
    var moduleTwin = await ioTHubModuleClient.GetTwinAsync();
    var moduleTwinCollection = moduleTwin.Properties.Desired;
    try {
        temperatureThreshold = moduleTwinCollection["TemperatureThreshold"];
    } catch(ArgumentOutOfRangeException e) {
        Console.WriteLine($"Property TemperatureThreshold not exist: {e.Message}"); 
    }

    // Attach a callback for updates to the module twin's desired properties.
    await ioTHubModuleClient.SetDesiredPropertyUpdateCallbackAsync(OnDesiredPropertiesUpdate, null);

    // Register a callback for messages that are received by the module.
    await ioTHubModuleClient.SetInputMessageHandlerAsync("input1", FilterMessages, ioTHubModuleClient);
    ```

9. <span data-ttu-id="0f4a0-185">Add the **onDesiredPropertiesUpdate** method to the **Program** class.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-185">Add the **onDesiredPropertiesUpdate** method to the **Program** class.</span></span> <span data-ttu-id="0f4a0-186">This method receives updates on the desired properties from the module twin, and updates the **temperatureThreshold** variable to match.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-186">This method receives updates on the desired properties from the module twin, and updates the **temperatureThreshold** variable to match.</span></span> <span data-ttu-id="0f4a0-187">All modules have their own module twin, which lets you configure the code that's running inside a module directly from the cloud.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-187">All modules have their own module twin, which lets you configure the code that's running inside a module directly from the cloud.</span></span>

    ```csharp
    static Task OnDesiredPropertiesUpdate(TwinCollection desiredProperties, object userContext)
    {
        try
        {
            Console.WriteLine("Desired property change:");
            Console.WriteLine(JsonConvert.SerializeObject(desiredProperties));

            if (desiredProperties["TemperatureThreshold"]!=null)
                temperatureThreshold = desiredProperties["TemperatureThreshold"];

        }
        catch (AggregateException ex)
        {
            foreach (Exception exception in ex.InnerExceptions)
            {
                Console.WriteLine();
                Console.WriteLine("Error when receiving desired property: {0}", exception);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine();
            Console.WriteLine("Error when receiving desired property: {0}", ex.Message);
        }
        return Task.CompletedTask;
    }
    ```

10. <span data-ttu-id="0f4a0-188">Replace the **PipeMessage** method with the **FilterMessages** method.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-188">Replace the **PipeMessage** method with the **FilterMessages** method.</span></span> <span data-ttu-id="0f4a0-189">This method is called whenever the module receives a message from the IoT Edge hub.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-189">This method is called whenever the module receives a message from the IoT Edge hub.</span></span> <span data-ttu-id="0f4a0-190">It filters out messages that report temperatures below the temperature threshold set via the module twin.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-190">It filters out messages that report temperatures below the temperature threshold set via the module twin.</span></span> <span data-ttu-id="0f4a0-191">It also adds the **MessageType** property to the message with the value set to **Alert**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-191">It also adds the **MessageType** property to the message with the value set to **Alert**.</span></span> 

    ```csharp
    static async Task<MessageResponse> FilterMessages(Message message, object userContext)
    {
        var counterValue = Interlocked.Increment(ref counter);
        try
        {
            ModuleClient moduleClient = (ModuleClient)userContext;
            var messageBytes = message.GetBytes();
            var messageString = Encoding.UTF8.GetString(messageBytes);
            Console.WriteLine($"Received message {counterValue}: [{messageString}]");

            // Get the message body.
            var messageBody = JsonConvert.DeserializeObject<MessageBody>(messageString);

            if (messageBody != null && messageBody.machine.temperature > temperatureThreshold)
            {
                Console.WriteLine($"Machine temperature {messageBody.machine.temperature} " +
                    $"exceeds threshold {temperatureThreshold}");
                var filteredMessage = new Message(messageBytes);
                foreach (KeyValuePair<string, string> prop in message.Properties)
                {
                    filteredMessage.Properties.Add(prop.Key, prop.Value);
                }

                filteredMessage.Properties.Add("MessageType", "Alert");
                await moduleClient.SendEventAsync("output1", filteredMessage);
            }

            // Indicate that the message treatment is completed.
            return MessageResponse.Completed;
        }
        catch (AggregateException ex)
        {
            foreach (Exception exception in ex.InnerExceptions)
            {
                Console.WriteLine();
                Console.WriteLine("Error in sample: {0}", exception);
            }
            // Indicate that the message treatment is not completed.
            var moduleClient = (ModuleClient)userContext;
            return MessageResponse.Abandoned;
        }
        catch (Exception ex)
        {
            Console.WriteLine();
            Console.WriteLine("Error in sample: {0}", ex.Message);
            // Indicate that the message treatment is not completed.
            ModuleClient moduleClient = (ModuleClient)userContext;
            return MessageResponse.Abandoned;
        }
    }
    ```

11. <span data-ttu-id="0f4a0-192">Save this file.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-192">Save this file.</span></span>

## <a name="build-your-iot-edge-solution"></a><span data-ttu-id="0f4a0-193">Build your IoT Edge solution</span><span class="sxs-lookup"><span data-stu-id="0f4a0-193">Build your IoT Edge solution</span></span>

<span data-ttu-id="0f4a0-194">In the previous section, you created an IoT Edge solution and added code to the **CSharpModule** to filter out messages where the reported machine temperature is below the acceptable threshold.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-194">In the previous section, you created an IoT Edge solution and added code to the **CSharpModule** to filter out messages where the reported machine temperature is below the acceptable threshold.</span></span> <span data-ttu-id="0f4a0-195">Now you need to build the solution as a container image and push it to your container registry.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-195">Now you need to build the solution as a container image and push it to your container registry.</span></span> 

1. <span data-ttu-id="0f4a0-196">Sign in to Docker by entering the following command in the Visual Studio Code integrated terminal.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-196">Sign in to Docker by entering the following command in the Visual Studio Code integrated terminal.</span></span> <span data-ttu-id="0f4a0-197">Then you can push your module image to your Azure container registry.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-197">Then you can push your module image to your Azure container registry.</span></span>
     
   ```csh/sh
   docker login -u <ACR username> -p <ACR password> <ACR login server>
   ```
   <span data-ttu-id="0f4a0-198">Use the username, password, and login server that you copied from your Azure container registry in the first section.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-198">Use the username, password, and login server that you copied from your Azure container registry in the first section.</span></span> <span data-ttu-id="0f4a0-199">You can also retrieve these values from the **Access keys** section of your registry in the Azure portal.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-199">You can also retrieve these values from the **Access keys** section of your registry in the Azure portal.</span></span>

2. <span data-ttu-id="0f4a0-200">In the VS Code explorer, open the deployment.template.json file in your IoT Edge solution workspace.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-200">In the VS Code explorer, open the deployment.template.json file in your IoT Edge solution workspace.</span></span> <span data-ttu-id="0f4a0-201">This file tells the **$edgeAgent** to deploy two modules: **tempSensor** and **CSharpModule**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-201">This file tells the **$edgeAgent** to deploy two modules: **tempSensor** and **CSharpModule**.</span></span> <span data-ttu-id="0f4a0-202">The **CSharpModule.image** value is set to a Linux amd64 version of the image.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-202">The **CSharpModule.image** value is set to a Linux amd64 version of the image.</span></span> 

   <span data-ttu-id="0f4a0-203">Verify that the template has the correct module name, not the default **SampleModule** name that you changed when you created the IoT Edge solution.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-203">Verify that the template has the correct module name, not the default **SampleModule** name that you changed when you created the IoT Edge solution.</span></span>

   <span data-ttu-id="0f4a0-204">To learn more about deployment manifests, see [Understand how IoT Edge modules can be used, configured, and reused](module-composition.md).</span><span class="sxs-lookup"><span data-stu-id="0f4a0-204">To learn more about deployment manifests, see [Understand how IoT Edge modules can be used, configured, and reused](module-composition.md).</span></span>

3. <span data-ttu-id="0f4a0-205">In the deployment.template.json file, the **registryCredentials** section stores your Docker registry credentials.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-205">In the deployment.template.json file, the **registryCredentials** section stores your Docker registry credentials.</span></span> <span data-ttu-id="0f4a0-206">The actual username and password pairs are stored in the .env file, which is ignored by git.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-206">The actual username and password pairs are stored in the .env file, which is ignored by git.</span></span>  

4. <span data-ttu-id="0f4a0-207">Add the **CSharpModule** module twin to the deployment manifest.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-207">Add the **CSharpModule** module twin to the deployment manifest.</span></span> <span data-ttu-id="0f4a0-208">Insert the following JSON content at the bottom of the **moduleContent** section, after the **$edgeHub** module twin:</span><span class="sxs-lookup"><span data-stu-id="0f4a0-208">Insert the following JSON content at the bottom of the **moduleContent** section, after the **$edgeHub** module twin:</span></span> 
    ```json
        "CSharpModule": {
            "properties.desired":{
                "TemperatureThreshold":25
            }
        }
    ```

4. <span data-ttu-id="0f4a0-209">Save this file.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-209">Save this file.</span></span>

5. <span data-ttu-id="0f4a0-210">In the VS Code explorer, right-click the deployment.template.json file and select **Build and Push IoT Edge solution**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-210">In the VS Code explorer, right-click the deployment.template.json file and select **Build and Push IoT Edge solution**.</span></span> 

<span data-ttu-id="0f4a0-211">When you tell Visual Studio Code to build your solution, it first takes the information in the deployment template and generates a deployment.json file in a new folder named **config**. Then, it runs two commands in the integrated terminal: `docker build` and `docker push`.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-211">When you tell Visual Studio Code to build your solution, it first takes the information in the deployment template and generates a deployment.json file in a new folder named **config**. Then, it runs two commands in the integrated terminal: `docker build` and `docker push`.</span></span> <span data-ttu-id="0f4a0-212">These two commands build your code, containerize the CSharpModule.dll, and then push the code to the container registry that you specified when you initialized the solution.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-212">These two commands build your code, containerize the CSharpModule.dll, and then push the code to the container registry that you specified when you initialized the solution.</span></span> 

<span data-ttu-id="0f4a0-213">You can see the full container image address with tag in the VS Code integrated terminal.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-213">You can see the full container image address with tag in the VS Code integrated terminal.</span></span> <span data-ttu-id="0f4a0-214">The image address is built from information that's in the module.json file with the format \<repository\>:\<version\>-\<platform\>.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-214">The image address is built from information that's in the module.json file with the format \<repository\>:\<version\>-\<platform\>.</span></span> <span data-ttu-id="0f4a0-215">For this tutorial, it should look like registryname.azurecr.io/csharpmodule:0.0.1-amd64.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-215">For this tutorial, it should look like registryname.azurecr.io/csharpmodule:0.0.1-amd64.</span></span>

## <a name="deploy-and-run-the-solution"></a><span data-ttu-id="0f4a0-216">Deploy and run the solution</span><span class="sxs-lookup"><span data-stu-id="0f4a0-216">Deploy and run the solution</span></span>

<span data-ttu-id="0f4a0-217">In the quickstart article that you used to set up your IoT Edge device, you deployed a module by using the Azure portal.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-217">In the quickstart article that you used to set up your IoT Edge device, you deployed a module by using the Azure portal.</span></span> <span data-ttu-id="0f4a0-218">You can also deploy modules using the Azure IoT Toolkit extension for Visual Studio Code.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-218">You can also deploy modules using the Azure IoT Toolkit extension for Visual Studio Code.</span></span> <span data-ttu-id="0f4a0-219">You already have a deployment manifest prepared for your scenario, the **deployment.json** file.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-219">You already have a deployment manifest prepared for your scenario, the **deployment.json** file.</span></span> <span data-ttu-id="0f4a0-220">All you need to do now is select a device to receive the deployment.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-220">All you need to do now is select a device to receive the deployment.</span></span>

1. <span data-ttu-id="0f4a0-221">In the VS Code command palette, run **Azure IoT Hub: Select IoT Hub**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-221">In the VS Code command palette, run **Azure IoT Hub: Select IoT Hub**.</span></span> 

2. <span data-ttu-id="0f4a0-222">Choose the subscription and IoT hub that contain the IoT Edge device that you want to configure.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-222">Choose the subscription and IoT hub that contain the IoT Edge device that you want to configure.</span></span> 

3. <span data-ttu-id="0f4a0-223">In the VS Code explorer, expand the **Azure IoT Hub Devices** section.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-223">In the VS Code explorer, expand the **Azure IoT Hub Devices** section.</span></span> 

4. <span data-ttu-id="0f4a0-224">Right-click the name of your IoT Edge device, then select **Create Deployment for Single Device**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-224">Right-click the name of your IoT Edge device, then select **Create Deployment for Single Device**.</span></span> 

   ![Create deployment for single device](./media/tutorial-csharp-module/create-deployment.png)

5. <span data-ttu-id="0f4a0-226">Select the **deployment.json** file in the **config** folder and then click **Select Edge Deployment Manifest**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-226">Select the **deployment.json** file in the **config** folder and then click **Select Edge Deployment Manifest**.</span></span> <span data-ttu-id="0f4a0-227">Do not use the deployment.template.json file.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-227">Do not use the deployment.template.json file.</span></span> 

6. <span data-ttu-id="0f4a0-228">Click the refresh button.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-228">Click the refresh button.</span></span> <span data-ttu-id="0f4a0-229">You should see the new **CSharpModule** running along with the **TempSensor** module and the **$edgeAgent** and **$edgeHub**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-229">You should see the new **CSharpModule** running along with the **TempSensor** module and the **$edgeAgent** and **$edgeHub**.</span></span>  

## <a name="view-generated-data"></a><span data-ttu-id="0f4a0-230">View generated data</span><span class="sxs-lookup"><span data-stu-id="0f4a0-230">View generated data</span></span>

1. <span data-ttu-id="0f4a0-231">To monitor data that arrives at the IoT hub, select the ellipsis (**...**), and then select **Start Monitoring D2C Messages**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-231">To monitor data that arrives at the IoT hub, select the ellipsis (**...**), and then select **Start Monitoring D2C Messages**.</span></span>
2. <span data-ttu-id="0f4a0-232">To monitor the D2C message for a specific device, right-click the device in the list, and select **Start Monitoring D2C Messages**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-232">To monitor the D2C message for a specific device, right-click the device in the list, and select **Start Monitoring D2C Messages**.</span></span>
3. <span data-ttu-id="0f4a0-233">To stop monitoring data, run the command **Azure IoT Hub: Stop monitoring D2C message** in the command palette.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-233">To stop monitoring data, run the command **Azure IoT Hub: Stop monitoring D2C message** in the command palette.</span></span> 
4. <span data-ttu-id="0f4a0-234">To view or update the module twin, right-click the module in the list, and select **Edit module twin**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-234">To view or update the module twin, right-click the module in the list, and select **Edit module twin**.</span></span> <span data-ttu-id="0f4a0-235">To update the module twin, save the twin JSON file, right-click the editor area, and select **Update Module Twin**.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-235">To update the module twin, save the twin JSON file, right-click the editor area, and select **Update Module Twin**.</span></span>
5. <span data-ttu-id="0f4a0-236">To view Docker logs, install [Docker](https://marketplace.visualstudio.com/items?itemName=PeterJausovec.vscode-docker) for VS Code.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-236">To view Docker logs, install [Docker](https://marketplace.visualstudio.com/items?itemName=PeterJausovec.vscode-docker) for VS Code.</span></span> <span data-ttu-id="0f4a0-237">You can find your running modules locally in Docker explorer.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-237">You can find your running modules locally in Docker explorer.</span></span> <span data-ttu-id="0f4a0-238">In the context menu, select **Show Logs** to view in the integrated terminal.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-238">In the context menu, select **Show Logs** to view in the integrated terminal.</span></span>
 
## <a name="clean-up-resources"></a><span data-ttu-id="0f4a0-239">Clean up resources</span><span class="sxs-lookup"><span data-stu-id="0f4a0-239">Clean up resources</span></span> 

<span data-ttu-id="0f4a0-240">If you plan to continue to the next recommended article, you can keep the resources and configurations that you created and reuse them.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-240">If you plan to continue to the next recommended article, you can keep the resources and configurations that you created and reuse them.</span></span> <span data-ttu-id="0f4a0-241">You can also keep using the same IoT Edge device as a test device.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-241">You can also keep using the same IoT Edge device as a test device.</span></span> 

<span data-ttu-id="0f4a0-242">Otherwise, you can delete the local configurations and the Azure resources that you created in this article to avoid charges.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-242">Otherwise, you can delete the local configurations and the Azure resources that you created in this article to avoid charges.</span></span> 

[!INCLUDE [iot-edge-clean-up-cloud-resources](../../includes/iot-edge-clean-up-cloud-resources.md)]

[!INCLUDE [iot-edge-clean-up-local-resources](../../includes/iot-edge-clean-up-local-resources.md)]


## <a name="next-steps"></a><span data-ttu-id="0f4a0-243">Next steps</span><span class="sxs-lookup"><span data-stu-id="0f4a0-243">Next steps</span></span>

<span data-ttu-id="0f4a0-244">In this tutorial, you created an IoT Edge module with code to filter raw data that's generated by your IoT Edge device.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-244">In this tutorial, you created an IoT Edge module with code to filter raw data that's generated by your IoT Edge device.</span></span> <span data-ttu-id="0f4a0-245">When you're ready to build your own modules, you can learn more about how to [develop a C# module with Azure IoT Edge for Visual Studio Code](how-to-develop-csharp-module.md).</span><span class="sxs-lookup"><span data-stu-id="0f4a0-245">When you're ready to build your own modules, you can learn more about how to [develop a C# module with Azure IoT Edge for Visual Studio Code](how-to-develop-csharp-module.md).</span></span> <span data-ttu-id="0f4a0-246">You can continue on to the next tutorials to learn other ways that Azure IoT Edge can help you turn data into business insights at the edge.</span><span class="sxs-lookup"><span data-stu-id="0f4a0-246">You can continue on to the next tutorials to learn other ways that Azure IoT Edge can help you turn data into business insights at the edge.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="0f4a0-247">Store data at the edge with SQL Server databases</span><span class="sxs-lookup"><span data-stu-id="0f4a0-247">Store data at the edge with SQL Server databases</span></span>](tutorial-store-data-sql-server.md)

<!-- Links -->
[lnk-tutorial1-win]: quickstart.md
[lnk-tutorial1-lin]: quickstart-linux.md

<!-- Images -->
[1]: ./media/tutorial-csharp-module/programcs.png
[2]: ./media/tutorial-csharp-module/build-module.png
[3]: ./media/tutorial-csharp-module/docker-os.png
