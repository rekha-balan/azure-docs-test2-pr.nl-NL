---
title: Diagnose a virtual machine network routing problem - tutorial - Azure portal | Microsoft Docs
description: In this tutorial, you learn how to diagnose a virtual machine network routing problem using the next hop capability of Azure Network Watcher.
services: network-watcher
documentationcenter: network-watcher
author: jimdial
manager: jeconnoc
editor: ''
tags: azure-resource-manager
Customer intent: I need to diagnose virtual machine (VM) network routing problem that prevents communication to different destinations.
ms.assetid: ''
ms.service: network-watcher
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: network-watcher
ms.workload: infrastructure
ms.date: 04/20/2018
ms.author: jdial
ms.custom: mvc
ms.openlocfilehash: ea64c93726c3bc5c5d60f35790bb337333d4d47a
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44968615"
---
# <a name="tutorial-diagnose-a-virtual-machine-network-routing-problem-using-the-azure-portal"></a><span data-ttu-id="80579-103">Tutorial: Diagnose a virtual machine network routing problem using the Azure portal</span><span class="sxs-lookup"><span data-stu-id="80579-103">Tutorial: Diagnose a virtual machine network routing problem using the Azure portal</span></span>

<span data-ttu-id="80579-104">When you deploy a virtual machine (VM), Azure creates several default routes for it.</span><span class="sxs-lookup"><span data-stu-id="80579-104">When you deploy a virtual machine (VM), Azure creates several default routes for it.</span></span> <span data-ttu-id="80579-105">You may create custom routes to override Azure's default routes.</span><span class="sxs-lookup"><span data-stu-id="80579-105">You may create custom routes to override Azure's default routes.</span></span> <span data-ttu-id="80579-106">Sometimes, a custom route can result in a VM not being able to communicate with other resources.</span><span class="sxs-lookup"><span data-stu-id="80579-106">Sometimes, a custom route can result in a VM not being able to communicate with other resources.</span></span> <span data-ttu-id="80579-107">In this tutorial, you learn how to:</span><span class="sxs-lookup"><span data-stu-id="80579-107">In this tutorial, you learn how to:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="80579-108">Create a VM</span><span class="sxs-lookup"><span data-stu-id="80579-108">Create a VM</span></span>
> * <span data-ttu-id="80579-109">Test communication to a URL using the next hop capability of Network Watcher</span><span class="sxs-lookup"><span data-stu-id="80579-109">Test communication to a URL using the next hop capability of Network Watcher</span></span>
> * <span data-ttu-id="80579-110">Test communication to an IP address</span><span class="sxs-lookup"><span data-stu-id="80579-110">Test communication to an IP address</span></span>
> * <span data-ttu-id="80579-111">Diagnose a routing problem, and learn how you can resolve it</span><span class="sxs-lookup"><span data-stu-id="80579-111">Diagnose a routing problem, and learn how you can resolve it</span></span>

<span data-ttu-id="80579-112">If you prefer, you can diagnose a virtual machine network routing problem using the [Azure CLI](diagnose-vm-network-routing-problem-cli.md) or [Azure PowerShell](diagnose-vm-network-routing-problem-powershell.md).</span><span class="sxs-lookup"><span data-stu-id="80579-112">If you prefer, you can diagnose a virtual machine network routing problem using the [Azure CLI](diagnose-vm-network-routing-problem-cli.md) or [Azure PowerShell](diagnose-vm-network-routing-problem-powershell.md).</span></span>

<span data-ttu-id="80579-113">If you don't have an Azure subscription, create a [free account](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) before you begin.</span><span class="sxs-lookup"><span data-stu-id="80579-113">If you don't have an Azure subscription, create a [free account](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) before you begin.</span></span>

## <a name="log-in-to-azure"></a><span data-ttu-id="80579-114">Log in to Azure</span><span class="sxs-lookup"><span data-stu-id="80579-114">Log in to Azure</span></span>

<span data-ttu-id="80579-115">Log in to the Azure portal at https://portal.azure.com.</span><span class="sxs-lookup"><span data-stu-id="80579-115">Log in to the Azure portal at https://portal.azure.com.</span></span>

## <a name="create-a-vm"></a><span data-ttu-id="80579-116">Create a VM</span><span class="sxs-lookup"><span data-stu-id="80579-116">Create a VM</span></span>

1. <span data-ttu-id="80579-117">Select **+ Create a resource** found on the upper, left corner of the Azure portal.</span><span class="sxs-lookup"><span data-stu-id="80579-117">Select **+ Create a resource** found on the upper, left corner of the Azure portal.</span></span>
2. <span data-ttu-id="80579-118">Select **Compute**, and then select **Windows Server 2016 Datacenter** or **Ubuntu Server 17.10 VM**.</span><span class="sxs-lookup"><span data-stu-id="80579-118">Select **Compute**, and then select **Windows Server 2016 Datacenter** or **Ubuntu Server 17.10 VM**.</span></span>
3. <span data-ttu-id="80579-119">Enter, or select, the following information, accept the defaults for the remaining settings, and then select **OK**:</span><span class="sxs-lookup"><span data-stu-id="80579-119">Enter, or select, the following information, accept the defaults for the remaining settings, and then select **OK**:</span></span>

    |<span data-ttu-id="80579-120">Setting</span><span class="sxs-lookup"><span data-stu-id="80579-120">Setting</span></span>|<span data-ttu-id="80579-121">Value</span><span class="sxs-lookup"><span data-stu-id="80579-121">Value</span></span>|
    |---|---|
    |<span data-ttu-id="80579-122">Name</span><span class="sxs-lookup"><span data-stu-id="80579-122">Name</span></span>|<span data-ttu-id="80579-123">myVm</span><span class="sxs-lookup"><span data-stu-id="80579-123">myVm</span></span>|
    |<span data-ttu-id="80579-124">User name</span><span class="sxs-lookup"><span data-stu-id="80579-124">User name</span></span>| <span data-ttu-id="80579-125">Enter a user name of your choosing.</span><span class="sxs-lookup"><span data-stu-id="80579-125">Enter a user name of your choosing.</span></span>|
    |<span data-ttu-id="80579-126">Password</span><span class="sxs-lookup"><span data-stu-id="80579-126">Password</span></span>| <span data-ttu-id="80579-127">Enter a password of your choosing.</span><span class="sxs-lookup"><span data-stu-id="80579-127">Enter a password of your choosing.</span></span> <span data-ttu-id="80579-128">The password must be at least 12 characters long and meet the [defined complexity requirements](../virtual-machines/windows/faq.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).</span><span class="sxs-lookup"><span data-stu-id="80579-128">The password must be at least 12 characters long and meet the [defined complexity requirements](../virtual-machines/windows/faq.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).</span></span>|
    |<span data-ttu-id="80579-129">Subscription</span><span class="sxs-lookup"><span data-stu-id="80579-129">Subscription</span></span>| <span data-ttu-id="80579-130">Select your subscription.</span><span class="sxs-lookup"><span data-stu-id="80579-130">Select your subscription.</span></span>|
    |<span data-ttu-id="80579-131">Resource group</span><span class="sxs-lookup"><span data-stu-id="80579-131">Resource group</span></span>| <span data-ttu-id="80579-132">Select **Create new** and enter **myResourceGroup**.</span><span class="sxs-lookup"><span data-stu-id="80579-132">Select **Create new** and enter **myResourceGroup**.</span></span>|
    |<span data-ttu-id="80579-133">Location</span><span class="sxs-lookup"><span data-stu-id="80579-133">Location</span></span>| <span data-ttu-id="80579-134">Select **East US**</span><span class="sxs-lookup"><span data-stu-id="80579-134">Select **East US**</span></span>|

4. <span data-ttu-id="80579-135">Select a size for the VM and then select **Select**.</span><span class="sxs-lookup"><span data-stu-id="80579-135">Select a size for the VM and then select **Select**.</span></span>
5. <span data-ttu-id="80579-136">Under **Settings**, accept all the defaults, and select **OK**.</span><span class="sxs-lookup"><span data-stu-id="80579-136">Under **Settings**, accept all the defaults, and select **OK**.</span></span>
6. <span data-ttu-id="80579-137">Under **Create** of the **Summary**, select **Create** to start VM deployment.</span><span class="sxs-lookup"><span data-stu-id="80579-137">Under **Create** of the **Summary**, select **Create** to start VM deployment.</span></span> <span data-ttu-id="80579-138">The VM takes a few minutes to deploy.</span><span class="sxs-lookup"><span data-stu-id="80579-138">The VM takes a few minutes to deploy.</span></span> <span data-ttu-id="80579-139">Wait for the VM to finish deploying before continuing with the remaining steps.</span><span class="sxs-lookup"><span data-stu-id="80579-139">Wait for the VM to finish deploying before continuing with the remaining steps.</span></span>

## <a name="test-network-communication"></a><span data-ttu-id="80579-140">Test network communication</span><span class="sxs-lookup"><span data-stu-id="80579-140">Test network communication</span></span>

<span data-ttu-id="80579-141">To test network communication with Network Watcher, you must first enable a network watcher in at least one Azure region and then use Network Watcher's next hop capability to test communication.</span><span class="sxs-lookup"><span data-stu-id="80579-141">To test network communication with Network Watcher, you must first enable a network watcher in at least one Azure region and then use Network Watcher's next hop capability to test communication.</span></span>

### <a name="enable-network-watcher"></a><span data-ttu-id="80579-142">Enable network watcher</span><span class="sxs-lookup"><span data-stu-id="80579-142">Enable network watcher</span></span>

<span data-ttu-id="80579-143">If you already have a network watcher enabled in at least one region, skip to [Use next hop](#use-next-hop).</span><span class="sxs-lookup"><span data-stu-id="80579-143">If you already have a network watcher enabled in at least one region, skip to [Use next hop](#use-next-hop).</span></span>

1. <span data-ttu-id="80579-144">In the portal, select **All services**.</span><span class="sxs-lookup"><span data-stu-id="80579-144">In the portal, select **All services**.</span></span> <span data-ttu-id="80579-145">In the **Filter box**, enter *Network Watcher*.</span><span class="sxs-lookup"><span data-stu-id="80579-145">In the **Filter box**, enter *Network Watcher*.</span></span> <span data-ttu-id="80579-146">When **Network Watcher** appears in the results, select it.</span><span class="sxs-lookup"><span data-stu-id="80579-146">When **Network Watcher** appears in the results, select it.</span></span>
2. <span data-ttu-id="80579-147">Select **Regions**, to expand it, and then select **...** to the right of **East US**, as shown in the following picture:</span><span class="sxs-lookup"><span data-stu-id="80579-147">Select **Regions**, to expand it, and then select **...** to the right of **East US**, as shown in the following picture:</span></span>

    ![Enable Network Watcher](./media/diagnose-vm-network-traffic-filtering-problem/enable-network-watcher.png)

3. <span data-ttu-id="80579-149">Select **Enable Network Watcher**.</span><span class="sxs-lookup"><span data-stu-id="80579-149">Select **Enable Network Watcher**.</span></span>

### <a name="use-next-hop"></a><span data-ttu-id="80579-150">Use next hop</span><span class="sxs-lookup"><span data-stu-id="80579-150">Use next hop</span></span>

<span data-ttu-id="80579-151">Azure automatically creates routes to default destinations.</span><span class="sxs-lookup"><span data-stu-id="80579-151">Azure automatically creates routes to default destinations.</span></span> <span data-ttu-id="80579-152">You may create custom routes that override the default routes.</span><span class="sxs-lookup"><span data-stu-id="80579-152">You may create custom routes that override the default routes.</span></span> <span data-ttu-id="80579-153">Sometimes, custom routes can cause communication to fail.</span><span class="sxs-lookup"><span data-stu-id="80579-153">Sometimes, custom routes can cause communication to fail.</span></span> <span data-ttu-id="80579-154">Use the next hop capability of Network Watcher to determine which route Azure is using to route traffic.</span><span class="sxs-lookup"><span data-stu-id="80579-154">Use the next hop capability of Network Watcher to determine which route Azure is using to route traffic.</span></span>

1. <span data-ttu-id="80579-155">In the Azure portal, select **Next hop**, under **Network Watcher**.</span><span class="sxs-lookup"><span data-stu-id="80579-155">In the Azure portal, select **Next hop**, under **Network Watcher**.</span></span>
2. <span data-ttu-id="80579-156">Select your subscription, enter or select the following values, and then select **Next hop**, as shown in the picture that follows:</span><span class="sxs-lookup"><span data-stu-id="80579-156">Select your subscription, enter or select the following values, and then select **Next hop**, as shown in the picture that follows:</span></span>

    |<span data-ttu-id="80579-157">Setting</span><span class="sxs-lookup"><span data-stu-id="80579-157">Setting</span></span>                  |<span data-ttu-id="80579-158">Value</span><span class="sxs-lookup"><span data-stu-id="80579-158">Value</span></span>                                                   |
    |---------                |---------                                               |
    | <span data-ttu-id="80579-159">Resource group</span><span class="sxs-lookup"><span data-stu-id="80579-159">Resource group</span></span>          | <span data-ttu-id="80579-160">Select myResourceGroup</span><span class="sxs-lookup"><span data-stu-id="80579-160">Select myResourceGroup</span></span>                                 |
    | <span data-ttu-id="80579-161">Virtual machine</span><span class="sxs-lookup"><span data-stu-id="80579-161">Virtual machine</span></span>         | <span data-ttu-id="80579-162">Select myVm</span><span class="sxs-lookup"><span data-stu-id="80579-162">Select myVm</span></span>                                            |
    | <span data-ttu-id="80579-163">Network interface</span><span class="sxs-lookup"><span data-stu-id="80579-163">Network interface</span></span>       | <span data-ttu-id="80579-164">myvm - Your network interface name may be different.</span><span class="sxs-lookup"><span data-stu-id="80579-164">myvm - Your network interface name may be different.</span></span>   |
    | <span data-ttu-id="80579-165">Source IP address</span><span class="sxs-lookup"><span data-stu-id="80579-165">Source IP address</span></span>       | <span data-ttu-id="80579-166">10.0.0.4</span><span class="sxs-lookup"><span data-stu-id="80579-166">10.0.0.4</span></span>                                               |
    | <span data-ttu-id="80579-167">Destination IP address</span><span class="sxs-lookup"><span data-stu-id="80579-167">Destination IP address</span></span>  | <span data-ttu-id="80579-168">13.107.21.200 - One of the addresses for www.bing.com.</span><span class="sxs-lookup"><span data-stu-id="80579-168">13.107.21.200 - One of the addresses for www.bing.com.</span></span> |

    ![Next hop](./media/diagnose-vm-network-routing-problem/next-hop.png)

    <span data-ttu-id="80579-170">After a few seconds, the result informs you that the next hop type is **Internet**, and that the **Route table ID** is **System Route**.</span><span class="sxs-lookup"><span data-stu-id="80579-170">After a few seconds, the result informs you that the next hop type is **Internet**, and that the **Route table ID** is **System Route**.</span></span> <span data-ttu-id="80579-171">This result lets you know that there is a valid system route to the destination.</span><span class="sxs-lookup"><span data-stu-id="80579-171">This result lets you know that there is a valid system route to the destination.</span></span>

3. <span data-ttu-id="80579-172">Change the **Destination IP address** to *172.31.0.100* and select **Next hop** again.</span><span class="sxs-lookup"><span data-stu-id="80579-172">Change the **Destination IP address** to *172.31.0.100* and select **Next hop** again.</span></span> <span data-ttu-id="80579-173">The result returned informs you that **None** is the **Next hop type**, and that the **Route table ID** is also **System Route**.</span><span class="sxs-lookup"><span data-stu-id="80579-173">The result returned informs you that **None** is the **Next hop type**, and that the **Route table ID** is also **System Route**.</span></span> <span data-ttu-id="80579-174">This result lets you know that, while there is a valid system route to the destination, there is no next hop to route the traffic to the destination.</span><span class="sxs-lookup"><span data-stu-id="80579-174">This result lets you know that, while there is a valid system route to the destination, there is no next hop to route the traffic to the destination.</span></span>

## <a name="view-details-of-a-route"></a><span data-ttu-id="80579-175">View details of a route</span><span class="sxs-lookup"><span data-stu-id="80579-175">View details of a route</span></span>

1. <span data-ttu-id="80579-176">To analyze routing further, review the effective routes for the network interface.</span><span class="sxs-lookup"><span data-stu-id="80579-176">To analyze routing further, review the effective routes for the network interface.</span></span> <span data-ttu-id="80579-177">In the search box at the top of the portal, enter *myvm* (or whatever the name was of the network interface you checked).</span><span class="sxs-lookup"><span data-stu-id="80579-177">In the search box at the top of the portal, enter *myvm* (or whatever the name was of the network interface you checked).</span></span> <span data-ttu-id="80579-178">When **myvm** appears in the search results, select it.</span><span class="sxs-lookup"><span data-stu-id="80579-178">When **myvm** appears in the search results, select it.</span></span>
2. <span data-ttu-id="80579-179">Select **Effective routes** under **SUPPORT + TROUBLESHOOTING**, as shown in the following picture:</span><span class="sxs-lookup"><span data-stu-id="80579-179">Select **Effective routes** under **SUPPORT + TROUBLESHOOTING**, as shown in the following picture:</span></span>

    ![Effective routes](./media/diagnose-vm-network-routing-problem/effective-routes.png)

    <span data-ttu-id="80579-181">When you ran the test using 13.107.21.200 in [Use next hop](#use-next-hop), the route with the address prefix 0.0.0.0/0 was used to route traffic to the address, since no other route includes the address.</span><span class="sxs-lookup"><span data-stu-id="80579-181">When you ran the test using 13.107.21.200 in [Use next hop](#use-next-hop), the route with the address prefix 0.0.0.0/0 was used to route traffic to the address, since no other route includes the address.</span></span> <span data-ttu-id="80579-182">By default, all addresses not specified within the address prefix of another route are routed to the internet.</span><span class="sxs-lookup"><span data-stu-id="80579-182">By default, all addresses not specified within the address prefix of another route are routed to the internet.</span></span>

    <span data-ttu-id="80579-183">When you ran the test using 172.31.0.100 however, the result informed you that there was no next hop type.</span><span class="sxs-lookup"><span data-stu-id="80579-183">When you ran the test using 172.31.0.100 however, the result informed you that there was no next hop type.</span></span> <span data-ttu-id="80579-184">As you can see in the previous picture, though there is a default route to the 172.16.0.0/12 prefix, which includes the 172.31.0.100 address, the **NEXT HOP TYPE** is **None**.</span><span class="sxs-lookup"><span data-stu-id="80579-184">As you can see in the previous picture, though there is a default route to the 172.16.0.0/12 prefix, which includes the 172.31.0.100 address, the **NEXT HOP TYPE** is **None**.</span></span> <span data-ttu-id="80579-185">Azure creates a default route to 172.16.0.0/12, but doesn't specify a next hop type until there is a reason to.</span><span class="sxs-lookup"><span data-stu-id="80579-185">Azure creates a default route to 172.16.0.0/12, but doesn't specify a next hop type until there is a reason to.</span></span> <span data-ttu-id="80579-186">If, for example, you added the 172.16.0.0/12 address range to the address space of the virtual network, Azure changes the **NEXT HOP TYPE** to **Virtual network** for the route.</span><span class="sxs-lookup"><span data-stu-id="80579-186">If, for example, you added the 172.16.0.0/12 address range to the address space of the virtual network, Azure changes the **NEXT HOP TYPE** to **Virtual network** for the route.</span></span> <span data-ttu-id="80579-187">A check would then show **Virtual network** as the **NEXT HOP TYPE**.</span><span class="sxs-lookup"><span data-stu-id="80579-187">A check would then show **Virtual network** as the **NEXT HOP TYPE**.</span></span>

## <a name="clean-up-resources"></a><span data-ttu-id="80579-188">Clean up resources</span><span class="sxs-lookup"><span data-stu-id="80579-188">Clean up resources</span></span>

<span data-ttu-id="80579-189">When no longer needed, delete the resource group and all of the resources it contains:</span><span class="sxs-lookup"><span data-stu-id="80579-189">When no longer needed, delete the resource group and all of the resources it contains:</span></span>

1. <span data-ttu-id="80579-190">Enter *myResourceGroup* in the **Search** box at the top of the portal.</span><span class="sxs-lookup"><span data-stu-id="80579-190">Enter *myResourceGroup* in the **Search** box at the top of the portal.</span></span> <span data-ttu-id="80579-191">When you see **myResourceGroup** in the search results, select it.</span><span class="sxs-lookup"><span data-stu-id="80579-191">When you see **myResourceGroup** in the search results, select it.</span></span>
2. <span data-ttu-id="80579-192">Select **Delete resource group**.</span><span class="sxs-lookup"><span data-stu-id="80579-192">Select **Delete resource group**.</span></span>
3. <span data-ttu-id="80579-193">Enter *myResourceGroup* for **TYPE THE RESOURCE GROUP NAME:** and select **Delete**.</span><span class="sxs-lookup"><span data-stu-id="80579-193">Enter *myResourceGroup* for **TYPE THE RESOURCE GROUP NAME:** and select **Delete**.</span></span>

## <a name="next-steps"></a><span data-ttu-id="80579-194">Next steps</span><span class="sxs-lookup"><span data-stu-id="80579-194">Next steps</span></span>

<span data-ttu-id="80579-195">In this tutorial, you created a VM and diagnosed network routing from the VM.</span><span class="sxs-lookup"><span data-stu-id="80579-195">In this tutorial, you created a VM and diagnosed network routing from the VM.</span></span> <span data-ttu-id="80579-196">You learned that Azure creates several default routes and tested routing to two different destinations.</span><span class="sxs-lookup"><span data-stu-id="80579-196">You learned that Azure creates several default routes and tested routing to two different destinations.</span></span> <span data-ttu-id="80579-197">Learn more about [routing in Azure](../virtual-network/virtual-networks-udr-overview.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json) and how to [create custom routes](../virtual-network/manage-route-table.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json#create-a-route).</span><span class="sxs-lookup"><span data-stu-id="80579-197">Learn more about [routing in Azure](../virtual-network/virtual-networks-udr-overview.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json) and how to [create custom routes](../virtual-network/manage-route-table.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json#create-a-route).</span></span>

<span data-ttu-id="80579-198">For outbound VM connections, you can also determine the latency, allowed and denied network traffic between the VM and an endpoint, and the route used to an endpoint, using Network Watcher's [connection troubleshoot](network-watcher-connectivity-portal.md) capability.</span><span class="sxs-lookup"><span data-stu-id="80579-198">For outbound VM connections, you can also determine the latency, allowed and denied network traffic between the VM and an endpoint, and the route used to an endpoint, using Network Watcher's [connection troubleshoot](network-watcher-connectivity-portal.md) capability.</span></span> <span data-ttu-id="80579-199">Learn how you can monitor communication between a VM and an endpoint, such as an IP address or URL, over time using the Network Watcher connection monitor capability.</span><span class="sxs-lookup"><span data-stu-id="80579-199">Learn how you can monitor communication between a VM and an endpoint, such as an IP address or URL, over time using the Network Watcher connection monitor capability.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="80579-200">Monitor a network connection</span><span class="sxs-lookup"><span data-stu-id="80579-200">Monitor a network connection</span></span>](connection-monitor.md)