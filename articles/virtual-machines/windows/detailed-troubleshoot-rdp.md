---
title: Detailed remote desktop troubleshooting in Azure | Microsoft Docs
description: Review detailed troubleshooting steps for remote desktop errors where you cannot to a Windows virtual machines in Azure
services: virtual-machines-windows
documentationcenter: ''
author: iainfoulds
manager: timlt
editor: ''
tags: top-support-issue,azure-service-management,azure-resource-manager
keywords: >
  cannot connect to remote desktop, troubleshoot remote desktop, remote desktop cannot connect, remote desktop errors, remote desktop troubleshooting, remote desktop problems
ms.assetid: 9da36f3d-30dd-44af-824b-8ce5ef07e5e0
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: support-article
ms.date: 12/20/2016
ms.author: iainfou
ms.openlocfilehash: 54c0bc0ae8127b00bd58c6d6a76f0d617ff7d286
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44662252"
---
# <a name="detailed-troubleshooting-steps-for-remote-desktop-connection-issues-to-windows-vms-in-azure"></a><span data-ttu-id="e031c-104">Detailed troubleshooting steps for remote desktop connection issues to Windows VMs in Azure</span><span class="sxs-lookup"><span data-stu-id="e031c-104">Detailed troubleshooting steps for remote desktop connection issues to Windows VMs in Azure</span></span>
<span data-ttu-id="e031c-105">This article provides detailed troubleshooting steps to diagnose and fix complex Remote Desktop errors for Windows-based Azure virtual machines.</span><span class="sxs-lookup"><span data-stu-id="e031c-105">This article provides detailed troubleshooting steps to diagnose and fix complex Remote Desktop errors for Windows-based Azure virtual machines.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="e031c-106">To eliminate the more common Remote Desktop errors, make sure to read [the basic troubleshooting article for Remote Desktop](troubleshoot-rdp-connection.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) before proceeding.</span><span class="sxs-lookup"><span data-stu-id="e031c-106">To eliminate the more common Remote Desktop errors, make sure to read [the basic troubleshooting article for Remote Desktop](troubleshoot-rdp-connection.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) before proceeding.</span></span>

<span data-ttu-id="e031c-107">You may encounter a Remote Desktop error message that does not resemble any of the specific error messages covered in [the basic Remote Desktop troubleshooting guide](troubleshoot-rdp-connection.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="e031c-107">You may encounter a Remote Desktop error message that does not resemble any of the specific error messages covered in [the basic Remote Desktop troubleshooting guide](troubleshoot-rdp-connection.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span></span> <span data-ttu-id="e031c-108">Follow these steps to determine why the Remote Desktop (RDP) client is unable to connect to the RDP service on the Azure VM.</span><span class="sxs-lookup"><span data-stu-id="e031c-108">Follow these steps to determine why the Remote Desktop (RDP) client is unable to connect to the RDP service on the Azure VM.</span></span>

[!INCLUDE [learn-about-deployment-models](../../../includes/learn-about-deployment-models-both-include.md)]

<span data-ttu-id="e031c-109">If you need more help at any point in this article, you can contact the Azure experts on [the MSDN Azure and the Stack Overflow forums](https://azure.microsoft.com/support/forums/).</span><span class="sxs-lookup"><span data-stu-id="e031c-109">If you need more help at any point in this article, you can contact the Azure experts on [the MSDN Azure and the Stack Overflow forums](https://azure.microsoft.com/support/forums/).</span></span> <span data-ttu-id="e031c-110">Alternatively, you can also file an Azure support incident.</span><span class="sxs-lookup"><span data-stu-id="e031c-110">Alternatively, you can also file an Azure support incident.</span></span> <span data-ttu-id="e031c-111">Go to the [Azure Support site](https://azure.microsoft.com/support/options/) and click **Get Support**.</span><span class="sxs-lookup"><span data-stu-id="e031c-111">Go to the [Azure Support site](https://azure.microsoft.com/support/options/) and click **Get Support**.</span></span> <span data-ttu-id="e031c-112">For information about using Azure Support, read the [Microsoft Azure Support FAQ](https://azure.microsoft.com/support/faq/).</span><span class="sxs-lookup"><span data-stu-id="e031c-112">For information about using Azure Support, read the [Microsoft Azure Support FAQ](https://azure.microsoft.com/support/faq/).</span></span>

## <a name="components-of-a-remote-desktop-connection"></a><span data-ttu-id="e031c-113">Components of a Remote Desktop connection</span><span class="sxs-lookup"><span data-stu-id="e031c-113">Components of a Remote Desktop connection</span></span>
<span data-ttu-id="e031c-114">The following components are involved in an RDP connection:</span><span class="sxs-lookup"><span data-stu-id="e031c-114">The following components are involved in an RDP connection:</span></span>

![](https://docstestmedia1.blob.core.windows.net/azure-media/articles/virtual-machines/windows/media/detailed-troubleshoot-rdp/tshootrdp_0.png)

<span data-ttu-id="e031c-115">Before proceeding, it might help to mentally review what has changed since the last successful Remote Desktop connection to the VM.</span><span class="sxs-lookup"><span data-stu-id="e031c-115">Before proceeding, it might help to mentally review what has changed since the last successful Remote Desktop connection to the VM.</span></span> <span data-ttu-id="e031c-116">For example:</span><span class="sxs-lookup"><span data-stu-id="e031c-116">For example:</span></span>

* <span data-ttu-id="e031c-117">The public IP address of the VM or the cloud service containing the VM (also called the virtual IP address [VIP](https://en.wikipedia.org/wiki/Virtual_IP_address)) has changed.</span><span class="sxs-lookup"><span data-stu-id="e031c-117">The public IP address of the VM or the cloud service containing the VM (also called the virtual IP address [VIP](https://en.wikipedia.org/wiki/Virtual_IP_address)) has changed.</span></span> <span data-ttu-id="e031c-118">The RDP failure could be because your DNS client cache still has the *old IP address* registered for the DNS name.</span><span class="sxs-lookup"><span data-stu-id="e031c-118">The RDP failure could be because your DNS client cache still has the *old IP address* registered for the DNS name.</span></span> <span data-ttu-id="e031c-119">Flush your DNS client cache and try connecting the VM again.</span><span class="sxs-lookup"><span data-stu-id="e031c-119">Flush your DNS client cache and try connecting the VM again.</span></span> <span data-ttu-id="e031c-120">Or try connecting directly with the new VIP.</span><span class="sxs-lookup"><span data-stu-id="e031c-120">Or try connecting directly with the new VIP.</span></span>
* <span data-ttu-id="e031c-121">You are using a third-party application to manage your Remote Desktop connections instead of using the connection generated by the Azure portal.</span><span class="sxs-lookup"><span data-stu-id="e031c-121">You are using a third-party application to manage your Remote Desktop connections instead of using the connection generated by the Azure portal.</span></span> <span data-ttu-id="e031c-122">Verify that the application configuration includes the correct TCP port for the Remote Desktop traffic.</span><span class="sxs-lookup"><span data-stu-id="e031c-122">Verify that the application configuration includes the correct TCP port for the Remote Desktop traffic.</span></span> <span data-ttu-id="e031c-123">You can check this port for a classic virtual machine in the [Azure portal](https://portal.azure.com), by clicking the VM's Settings > Endpoints.</span><span class="sxs-lookup"><span data-stu-id="e031c-123">You can check this port for a classic virtual machine in the [Azure portal](https://portal.azure.com), by clicking the VM's Settings > Endpoints.</span></span>

## <a name="preliminary-steps"></a><span data-ttu-id="e031c-124">Preliminary steps</span><span class="sxs-lookup"><span data-stu-id="e031c-124">Preliminary steps</span></span>
<span data-ttu-id="e031c-125">Before proceeding to the detailed troubleshooting,</span><span class="sxs-lookup"><span data-stu-id="e031c-125">Before proceeding to the detailed troubleshooting,</span></span>

* <span data-ttu-id="e031c-126">Check the status of the virtual machine in the Azure classic portal or the Azure portal for any obvious issues.</span><span class="sxs-lookup"><span data-stu-id="e031c-126">Check the status of the virtual machine in the Azure classic portal or the Azure portal for any obvious issues.</span></span>
* <span data-ttu-id="e031c-127">Follow the [quick fix steps for common RDP errors in the basic troubleshooting guide](troubleshoot-rdp-connection.md#quick-troubleshooting-steps).</span><span class="sxs-lookup"><span data-stu-id="e031c-127">Follow the [quick fix steps for common RDP errors in the basic troubleshooting guide](troubleshoot-rdp-connection.md#quick-troubleshooting-steps).</span></span>

<span data-ttu-id="e031c-128">Try reconnecting to the VM via Remote Desktop after these steps.</span><span class="sxs-lookup"><span data-stu-id="e031c-128">Try reconnecting to the VM via Remote Desktop after these steps.</span></span>

## <a name="detailed-troubleshooting-steps"></a><span data-ttu-id="e031c-129">Detailed troubleshooting steps</span><span class="sxs-lookup"><span data-stu-id="e031c-129">Detailed troubleshooting steps</span></span>
<span data-ttu-id="e031c-130">The Remote Desktop client may not be able to reach the Remote Desktop service on the Azure VM due to issues at the following sources:</span><span class="sxs-lookup"><span data-stu-id="e031c-130">The Remote Desktop client may not be able to reach the Remote Desktop service on the Azure VM due to issues at the following sources:</span></span>

* [<span data-ttu-id="e031c-131">Remote Desktop client computer</span><span class="sxs-lookup"><span data-stu-id="e031c-131">Remote Desktop client computer</span></span>](#source-1-remote-desktop-client-computer)
* [<span data-ttu-id="e031c-132">Organization intranet edge device</span><span class="sxs-lookup"><span data-stu-id="e031c-132">Organization intranet edge device</span></span>](#source-2-organization-intranet-edge-device)
* [<span data-ttu-id="e031c-133">Cloud service endpoint and access control list (ACL)</span><span class="sxs-lookup"><span data-stu-id="e031c-133">Cloud service endpoint and access control list (ACL)</span></span>](#source-3-cloud-service-endpoint-and-acl)
* [<span data-ttu-id="e031c-134">Network security groups</span><span class="sxs-lookup"><span data-stu-id="e031c-134">Network security groups</span></span>](#source-4-network-security-groups)
* [<span data-ttu-id="e031c-135">Windows-based Azure VM</span><span class="sxs-lookup"><span data-stu-id="e031c-135">Windows-based Azure VM</span></span>](#source-5-windows-based-azure-vm)

## <a name="source-1-remote-desktop-client-computer"></a><span data-ttu-id="e031c-136">Source 1: Remote Desktop client computer</span><span class="sxs-lookup"><span data-stu-id="e031c-136">Source 1: Remote Desktop client computer</span></span>
<span data-ttu-id="e031c-137">Verify that your computer can make Remote Desktop connections to another on-premises, Windows-based computer.</span><span class="sxs-lookup"><span data-stu-id="e031c-137">Verify that your computer can make Remote Desktop connections to another on-premises, Windows-based computer.</span></span>

![](https://docstestmedia1.blob.core.windows.net/azure-media/articles/virtual-machines/windows/media/detailed-troubleshoot-rdp/tshootrdp_1.png)

<span data-ttu-id="e031c-138">If you cannot, check for the following settings on your computer:</span><span class="sxs-lookup"><span data-stu-id="e031c-138">If you cannot, check for the following settings on your computer:</span></span>

* <span data-ttu-id="e031c-139">A local firewall setting that is blocking Remote Desktop traffic.</span><span class="sxs-lookup"><span data-stu-id="e031c-139">A local firewall setting that is blocking Remote Desktop traffic.</span></span>
* <span data-ttu-id="e031c-140">Locally installed client proxy software that is preventing Remote Desktop connections.</span><span class="sxs-lookup"><span data-stu-id="e031c-140">Locally installed client proxy software that is preventing Remote Desktop connections.</span></span>
* <span data-ttu-id="e031c-141">Locally installed network monitoring software that is preventing Remote Desktop connections.</span><span class="sxs-lookup"><span data-stu-id="e031c-141">Locally installed network monitoring software that is preventing Remote Desktop connections.</span></span>
* <span data-ttu-id="e031c-142">Other types of security software that either monitor traffic or allow/disallow specific types of traffic that is preventing Remote Desktop connections.</span><span class="sxs-lookup"><span data-stu-id="e031c-142">Other types of security software that either monitor traffic or allow/disallow specific types of traffic that is preventing Remote Desktop connections.</span></span>

<span data-ttu-id="e031c-143">In all these cases, temporarily disable the software and try to connect to an on-premises computer via Remote Desktop.</span><span class="sxs-lookup"><span data-stu-id="e031c-143">In all these cases, temporarily disable the software and try to connect to an on-premises computer via Remote Desktop.</span></span> <span data-ttu-id="e031c-144">If you can find out the actual cause this way, work with your network administrator to correct the software settings to allow Remote Desktop connections.</span><span class="sxs-lookup"><span data-stu-id="e031c-144">If you can find out the actual cause this way, work with your network administrator to correct the software settings to allow Remote Desktop connections.</span></span>

## <a name="source-2-organization-intranet-edge-device"></a><span data-ttu-id="e031c-145">Source 2: Organization intranet edge device</span><span class="sxs-lookup"><span data-stu-id="e031c-145">Source 2: Organization intranet edge device</span></span>
<span data-ttu-id="e031c-146">Verify that a computer directly connected to the Internet can make Remote Desktop connections to your Azure virtual machine.</span><span class="sxs-lookup"><span data-stu-id="e031c-146">Verify that a computer directly connected to the Internet can make Remote Desktop connections to your Azure virtual machine.</span></span>

![](https://docstestmedia1.blob.core.windows.net/azure-media/articles/virtual-machines/windows/media/detailed-troubleshoot-rdp/tshootrdp_2.png)

<span data-ttu-id="e031c-147">If you do not have a computer that is directly connected to the Internet, create and test with a new Azure virtual machine in a resource group or cloud service.</span><span class="sxs-lookup"><span data-stu-id="e031c-147">If you do not have a computer that is directly connected to the Internet, create and test with a new Azure virtual machine in a resource group or cloud service.</span></span> <span data-ttu-id="e031c-148">For more information, see [Create a virtual machine running Windows in Azure](../virtual-machines-windows-hero-tutorial.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="e031c-148">For more information, see [Create a virtual machine running Windows in Azure](../virtual-machines-windows-hero-tutorial.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span></span> <span data-ttu-id="e031c-149">You can delete the virtual machine and the resource group or the cloud service, after the test.</span><span class="sxs-lookup"><span data-stu-id="e031c-149">You can delete the virtual machine and the resource group or the cloud service, after the test.</span></span>

<span data-ttu-id="e031c-150">If you can create a Remote Desktop connection with a computer directly attached to the Internet, check your organization intranet edge device for:</span><span class="sxs-lookup"><span data-stu-id="e031c-150">If you can create a Remote Desktop connection with a computer directly attached to the Internet, check your organization intranet edge device for:</span></span>

* <span data-ttu-id="e031c-151">An internal firewall blocking HTTPS connections to the Internet.</span><span class="sxs-lookup"><span data-stu-id="e031c-151">An internal firewall blocking HTTPS connections to the Internet.</span></span>
* <span data-ttu-id="e031c-152">A proxy server preventing Remote Desktop connections.</span><span class="sxs-lookup"><span data-stu-id="e031c-152">A proxy server preventing Remote Desktop connections.</span></span>
* <span data-ttu-id="e031c-153">Intrusion detection or network monitoring software running on devices in your edge network that is preventing Remote Desktop connections.</span><span class="sxs-lookup"><span data-stu-id="e031c-153">Intrusion detection or network monitoring software running on devices in your edge network that is preventing Remote Desktop connections.</span></span>

<span data-ttu-id="e031c-154">Work with your network administrator to correct the settings of your organization intranet edge device to allow HTTPS-based Remote Desktop connections to the Internet.</span><span class="sxs-lookup"><span data-stu-id="e031c-154">Work with your network administrator to correct the settings of your organization intranet edge device to allow HTTPS-based Remote Desktop connections to the Internet.</span></span>

## <a name="source-3-cloud-service-endpoint-and-acl"></a><span data-ttu-id="e031c-155">Source 3: Cloud service endpoint and ACL</span><span class="sxs-lookup"><span data-stu-id="e031c-155">Source 3: Cloud service endpoint and ACL</span></span>
<span data-ttu-id="e031c-156">For VMs created using the Classic deployment model, verify that another Azure VM that is in the same cloud service or virtual network can make Remote Desktop connections to your Azure VM.</span><span class="sxs-lookup"><span data-stu-id="e031c-156">For VMs created using the Classic deployment model, verify that another Azure VM that is in the same cloud service or virtual network can make Remote Desktop connections to your Azure VM.</span></span>

![](https://docstestmedia1.blob.core.windows.net/azure-media/articles/virtual-machines/windows/media/detailed-troubleshoot-rdp/tshootrdp_3.png)

> [!NOTE]
> <span data-ttu-id="e031c-157">For virtual machines created in Resource Manager, skip to [Source 4: Network Security Groups](#source-4-network-security-groups).</span><span class="sxs-lookup"><span data-stu-id="e031c-157">For virtual machines created in Resource Manager, skip to [Source 4: Network Security Groups](#source-4-network-security-groups).</span></span>
> 
> 

<span data-ttu-id="e031c-158">If you do not have another virtual machine in the same cloud service or virtual network, create one.</span><span class="sxs-lookup"><span data-stu-id="e031c-158">If you do not have another virtual machine in the same cloud service or virtual network, create one.</span></span> <span data-ttu-id="e031c-159">Follow the steps in [Create a virtual machine running Windows in Azure](../virtual-machines-windows-hero-tutorial.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="e031c-159">Follow the steps in [Create a virtual machine running Windows in Azure](../virtual-machines-windows-hero-tutorial.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span></span> <span data-ttu-id="e031c-160">Delete the test virtual machine after the test is completed.</span><span class="sxs-lookup"><span data-stu-id="e031c-160">Delete the test virtual machine after the test is completed.</span></span>

<span data-ttu-id="e031c-161">If you can connect via Remote Desktop to a virtual machine in the same cloud service or virtual network, check for these settings:</span><span class="sxs-lookup"><span data-stu-id="e031c-161">If you can connect via Remote Desktop to a virtual machine in the same cloud service or virtual network, check for these settings:</span></span>

* <span data-ttu-id="e031c-162">The endpoint configuration for Remote Desktop traffic on the target VM: The private TCP port of the endpoint must match the TCP port on which the VM's Remote Desktop service is listening (default is 3389).</span><span class="sxs-lookup"><span data-stu-id="e031c-162">The endpoint configuration for Remote Desktop traffic on the target VM: The private TCP port of the endpoint must match the TCP port on which the VM's Remote Desktop service is listening (default is 3389).</span></span>
* <span data-ttu-id="e031c-163">The ACL for the Remote Desktop traffic endpoint on the target VM: ACLs allow you to specify allowed or denied incoming traffic from the Internet based on its source IP address.</span><span class="sxs-lookup"><span data-stu-id="e031c-163">The ACL for the Remote Desktop traffic endpoint on the target VM: ACLs allow you to specify allowed or denied incoming traffic from the Internet based on its source IP address.</span></span> <span data-ttu-id="e031c-164">Misconfigured ACLs can prevent incoming Remote Desktop traffic to the endpoint.</span><span class="sxs-lookup"><span data-stu-id="e031c-164">Misconfigured ACLs can prevent incoming Remote Desktop traffic to the endpoint.</span></span> <span data-ttu-id="e031c-165">Check your ACLs to ensure that incoming traffic from your public IP addresses of your proxy or other edge server is allowed.</span><span class="sxs-lookup"><span data-stu-id="e031c-165">Check your ACLs to ensure that incoming traffic from your public IP addresses of your proxy or other edge server is allowed.</span></span> <span data-ttu-id="e031c-166">For more information, see [What is a Network Access Control List (ACL)?](../../virtual-network/virtual-networks-acl.md)</span><span class="sxs-lookup"><span data-stu-id="e031c-166">For more information, see [What is a Network Access Control List (ACL)?](../../virtual-network/virtual-networks-acl.md)</span></span>

<span data-ttu-id="e031c-167">To check if the endpoint is the source of the problem, remove the current endpoint and create a new one, choosing a random port in the range 49152–65535 for the external port number.</span><span class="sxs-lookup"><span data-stu-id="e031c-167">To check if the endpoint is the source of the problem, remove the current endpoint and create a new one, choosing a random port in the range 49152–65535 for the external port number.</span></span> <span data-ttu-id="e031c-168">For more information, see [How to set up endpoints to a virtual machine](classic/setup-endpoints.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="e031c-168">For more information, see [How to set up endpoints to a virtual machine](classic/setup-endpoints.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json).</span></span>

## <a name="source-4-network-security-groups"></a><span data-ttu-id="e031c-169">Source 4: Network Security Groups</span><span class="sxs-lookup"><span data-stu-id="e031c-169">Source 4: Network Security Groups</span></span>
<span data-ttu-id="e031c-170">Network Security Groups allow more granular control of allowed inbound and outbound traffic.</span><span class="sxs-lookup"><span data-stu-id="e031c-170">Network Security Groups allow more granular control of allowed inbound and outbound traffic.</span></span> <span data-ttu-id="e031c-171">You can create rules spanning subnets and cloud services in an Azure virtual network.</span><span class="sxs-lookup"><span data-stu-id="e031c-171">You can create rules spanning subnets and cloud services in an Azure virtual network.</span></span> <span data-ttu-id="e031c-172">Check your Network Security Group rules to ensure that Remote Desktop traffic from the Internet is allowed:</span><span class="sxs-lookup"><span data-stu-id="e031c-172">Check your Network Security Group rules to ensure that Remote Desktop traffic from the Internet is allowed:</span></span>

* <span data-ttu-id="e031c-173">In the Azure portal, select your VM</span><span class="sxs-lookup"><span data-stu-id="e031c-173">In the Azure portal, select your VM</span></span>
* <span data-ttu-id="e031c-174">Click **All settings** | **Network interfaces** and select your network interface.</span><span class="sxs-lookup"><span data-stu-id="e031c-174">Click **All settings** | **Network interfaces** and select your network interface.</span></span>
* <span data-ttu-id="e031c-175">Click **All settings** | **Network security group** and select your network security group.</span><span class="sxs-lookup"><span data-stu-id="e031c-175">Click **All settings** | **Network security group** and select your network security group.</span></span>
* <span data-ttu-id="e031c-176">Click **All settings** | **Inbound security rules** and ensure you have a rule allowing RDP on TCP port 3389.</span><span class="sxs-lookup"><span data-stu-id="e031c-176">Click **All settings** | **Inbound security rules** and ensure you have a rule allowing RDP on TCP port 3389.</span></span>
  * <span data-ttu-id="e031c-177">If you do not have a rule, click **Add** to create a rule.</span><span class="sxs-lookup"><span data-stu-id="e031c-177">If you do not have a rule, click **Add** to create a rule.</span></span> <span data-ttu-id="e031c-178">Enter **TCP** for the protocol and then **3389** for the destination port range.</span><span class="sxs-lookup"><span data-stu-id="e031c-178">Enter **TCP** for the protocol and then **3389** for the destination port range.</span></span>
  * <span data-ttu-id="e031c-179">Make sure the action is set to **Allow** and click OK to save your new inbound rule.</span><span class="sxs-lookup"><span data-stu-id="e031c-179">Make sure the action is set to **Allow** and click OK to save your new inbound rule.</span></span>

<span data-ttu-id="e031c-180">For more information, see [What is a Network Security Group (NSG)?](../../virtual-network/virtual-networks-nsg.md)</span><span class="sxs-lookup"><span data-stu-id="e031c-180">For more information, see [What is a Network Security Group (NSG)?](../../virtual-network/virtual-networks-nsg.md)</span></span>

## <a name="source-5-windows-based-azure-vm"></a><span data-ttu-id="e031c-181">Source 5: Windows-based Azure VM</span><span class="sxs-lookup"><span data-stu-id="e031c-181">Source 5: Windows-based Azure VM</span></span>
![](https://docstestmedia1.blob.core.windows.net/azure-media/articles/virtual-machines/windows/media/detailed-troubleshoot-rdp/tshootrdp_5.png)

<span data-ttu-id="e031c-182">Follow the instructions in [this article](reset-rdp.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="e031c-182">Follow the instructions in [this article](reset-rdp.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).</span></span> <span data-ttu-id="e031c-183">This article resets the Remote Desktop service on the virtual machine:</span><span class="sxs-lookup"><span data-stu-id="e031c-183">This article resets the Remote Desktop service on the virtual machine:</span></span>

* <span data-ttu-id="e031c-184">Enable the "Remote Desktop" Windows Firewall default rule (TCP port 3389).</span><span class="sxs-lookup"><span data-stu-id="e031c-184">Enable the "Remote Desktop" Windows Firewall default rule (TCP port 3389).</span></span>
* <span data-ttu-id="e031c-185">Enable Remote Desktop connections by setting the HKLM\System\CurrentControlSet\Control\Terminal Server\fDenyTSConnections registry value to 0.</span><span class="sxs-lookup"><span data-stu-id="e031c-185">Enable Remote Desktop connections by setting the HKLM\System\CurrentControlSet\Control\Terminal Server\fDenyTSConnections registry value to 0.</span></span>

<span data-ttu-id="e031c-186">Try the connection from your computer again.</span><span class="sxs-lookup"><span data-stu-id="e031c-186">Try the connection from your computer again.</span></span> <span data-ttu-id="e031c-187">If you are still not able to connect via Remote Desktop, check for the following possible problems:</span><span class="sxs-lookup"><span data-stu-id="e031c-187">If you are still not able to connect via Remote Desktop, check for the following possible problems:</span></span>

* <span data-ttu-id="e031c-188">The Remote Desktop service is not running on the target VM.</span><span class="sxs-lookup"><span data-stu-id="e031c-188">The Remote Desktop service is not running on the target VM.</span></span>
* <span data-ttu-id="e031c-189">The Remote Desktop service is not listening on TCP port 3389.</span><span class="sxs-lookup"><span data-stu-id="e031c-189">The Remote Desktop service is not listening on TCP port 3389.</span></span>
* <span data-ttu-id="e031c-190">Windows Firewall or another local firewall has an outbound rule that is preventing Remote Desktop traffic.</span><span class="sxs-lookup"><span data-stu-id="e031c-190">Windows Firewall or another local firewall has an outbound rule that is preventing Remote Desktop traffic.</span></span>
* <span data-ttu-id="e031c-191">Intrusion detection or network monitoring software running on the Azure virtual machine is preventing Remote Desktop connections.</span><span class="sxs-lookup"><span data-stu-id="e031c-191">Intrusion detection or network monitoring software running on the Azure virtual machine is preventing Remote Desktop connections.</span></span>

<span data-ttu-id="e031c-192">For VMs created using the classic deployment model, you can use a remote Azure PowerShell session to the Azure virtual machine.</span><span class="sxs-lookup"><span data-stu-id="e031c-192">For VMs created using the classic deployment model, you can use a remote Azure PowerShell session to the Azure virtual machine.</span></span> <span data-ttu-id="e031c-193">First, you need to install a certificate for the virtual machine's hosting cloud service.</span><span class="sxs-lookup"><span data-stu-id="e031c-193">First, you need to install a certificate for the virtual machine's hosting cloud service.</span></span> <span data-ttu-id="e031c-194">Go to [Configure Secure Remote PowerShell Access to Azure Virtual Machines](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe) and download the **InstallWinRMCertAzureVM.ps1** script file to your local computer.</span><span class="sxs-lookup"><span data-stu-id="e031c-194">Go to [Configure Secure Remote PowerShell Access to Azure Virtual Machines](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe) and download the **InstallWinRMCertAzureVM.ps1** script file to your local computer.</span></span>

<span data-ttu-id="e031c-195">Next, install Azure PowerShell if you haven't already.</span><span class="sxs-lookup"><span data-stu-id="e031c-195">Next, install Azure PowerShell if you haven't already.</span></span> <span data-ttu-id="e031c-196">See [How to install and configure Azure PowerShell](/powershell/azureps-cmdlets-docs).</span><span class="sxs-lookup"><span data-stu-id="e031c-196">See [How to install and configure Azure PowerShell](/powershell/azureps-cmdlets-docs).</span></span>

<span data-ttu-id="e031c-197">Next, open an Azure PowerShell command prompt and change the current folder to the location of the **InstallWinRMCertAzureVM.ps1** script file.</span><span class="sxs-lookup"><span data-stu-id="e031c-197">Next, open an Azure PowerShell command prompt and change the current folder to the location of the **InstallWinRMCertAzureVM.ps1** script file.</span></span> <span data-ttu-id="e031c-198">To run an Azure PowerShell script, you must set the correct execution policy.</span><span class="sxs-lookup"><span data-stu-id="e031c-198">To run an Azure PowerShell script, you must set the correct execution policy.</span></span> <span data-ttu-id="e031c-199">Run the **Get-ExecutionPolicy** command to determine your current policy level.</span><span class="sxs-lookup"><span data-stu-id="e031c-199">Run the **Get-ExecutionPolicy** command to determine your current policy level.</span></span> <span data-ttu-id="e031c-200">For information about setting the appropriate level, see [Set-ExecutionPolicy](https://technet.microsoft.com/library/hh849812.aspx).</span><span class="sxs-lookup"><span data-stu-id="e031c-200">For information about setting the appropriate level, see [Set-ExecutionPolicy](https://technet.microsoft.com/library/hh849812.aspx).</span></span>

<span data-ttu-id="e031c-201">Next, fill in your Azure subscription name, the cloud service name, and your virtual machine name (removing the < and > characters), and then run these commands.</span><span class="sxs-lookup"><span data-stu-id="e031c-201">Next, fill in your Azure subscription name, the cloud service name, and your virtual machine name (removing the < and > characters), and then run these commands.</span></span>

    $subscr="<Name of your Azure subscription>"
    $serviceName="<Name of the cloud service that contains the target virtual machine>"
    $vmName="<Name of the target virtual machine>"
    .\InstallWinRMCertAzureVM.ps1 -SubscriptionName $subscr -ServiceName $serviceName -Name $vmName

<span data-ttu-id="e031c-202">You can get the correct subscription name from the *SubscriptionName* property of the display of the **Get-AzureSubscription** command.</span><span class="sxs-lookup"><span data-stu-id="e031c-202">You can get the correct subscription name from the *SubscriptionName* property of the display of the **Get-AzureSubscription** command.</span></span> <span data-ttu-id="e031c-203">You can get the cloud service name for the virtual machine from the *ServiceName* column in the display of the **Get-AzureVM** command.</span><span class="sxs-lookup"><span data-stu-id="e031c-203">You can get the cloud service name for the virtual machine from the *ServiceName* column in the display of the **Get-AzureVM** command.</span></span>

<span data-ttu-id="e031c-204">Check if you have the new certificate.</span><span class="sxs-lookup"><span data-stu-id="e031c-204">Check if you have the new certificate.</span></span> <span data-ttu-id="e031c-205">Open a Certificates snap-in for the current user and look in the **Trusted Root Certification Authorities\Certificates** folder.</span><span class="sxs-lookup"><span data-stu-id="e031c-205">Open a Certificates snap-in for the current user and look in the **Trusted Root Certification Authorities\Certificates** folder.</span></span> <span data-ttu-id="e031c-206">You should see a certificate with the DNS name of your cloud service in the Issued To column (example: cloudservice4testing.cloudapp.net).</span><span class="sxs-lookup"><span data-stu-id="e031c-206">You should see a certificate with the DNS name of your cloud service in the Issued To column (example: cloudservice4testing.cloudapp.net).</span></span>

<span data-ttu-id="e031c-207">Next, initiate a remote Azure PowerShell session by using these commands.</span><span class="sxs-lookup"><span data-stu-id="e031c-207">Next, initiate a remote Azure PowerShell session by using these commands.</span></span>

    $uri = Get-AzureWinRMUri -ServiceName $serviceName -Name $vmName
    $creds = Get-Credential
    Enter-PSSession -ConnectionUri $uri -Credential $creds

<span data-ttu-id="e031c-208">After entering valid administrator credentials, you should see something similar to the following Azure PowerShell prompt:</span><span class="sxs-lookup"><span data-stu-id="e031c-208">After entering valid administrator credentials, you should see something similar to the following Azure PowerShell prompt:</span></span>

    [cloudservice4testing.cloudapp.net]: PS C:\Users\User1\Documents>

<span data-ttu-id="e031c-209">The first part of this prompt is your cloud service name that contains the target VM, which could be different from "cloudservice4testing.cloudapp.net".</span><span class="sxs-lookup"><span data-stu-id="e031c-209">The first part of this prompt is your cloud service name that contains the target VM, which could be different from "cloudservice4testing.cloudapp.net".</span></span> <span data-ttu-id="e031c-210">You can now issue Azure PowerShell commands for this cloud service to investigate the problems mentioned and correct the configuration.</span><span class="sxs-lookup"><span data-stu-id="e031c-210">You can now issue Azure PowerShell commands for this cloud service to investigate the problems mentioned and correct the configuration.</span></span>

### <a name="to-manually-correct-the-remote-desktop-services-listening-tcp-port"></a><span data-ttu-id="e031c-211">To manually correct the Remote Desktop Services listening TCP port</span><span class="sxs-lookup"><span data-stu-id="e031c-211">To manually correct the Remote Desktop Services listening TCP port</span></span>
<span data-ttu-id="e031c-212">At the remote Azure PowerShell session prompt, run this command.</span><span class="sxs-lookup"><span data-stu-id="e031c-212">At the remote Azure PowerShell session prompt, run this command.</span></span>

    Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"

<span data-ttu-id="e031c-213">The PortNumber property shows the current port number.</span><span class="sxs-lookup"><span data-stu-id="e031c-213">The PortNumber property shows the current port number.</span></span> <span data-ttu-id="e031c-214">If needed, change the Remote Desktop port number back to its default value (3389) by using this command.</span><span class="sxs-lookup"><span data-stu-id="e031c-214">If needed, change the Remote Desktop port number back to its default value (3389) by using this command.</span></span>

    Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber" -Value 3389

<span data-ttu-id="e031c-215">Verify that the port has been changed to 3389 by using this command.</span><span class="sxs-lookup"><span data-stu-id="e031c-215">Verify that the port has been changed to 3389 by using this command.</span></span>

    Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"

<span data-ttu-id="e031c-216">Exit the remote Azure PowerShell session by using this command.</span><span class="sxs-lookup"><span data-stu-id="e031c-216">Exit the remote Azure PowerShell session by using this command.</span></span>

    Exit-PSSession

<span data-ttu-id="e031c-217">Verify that the Remote Desktop endpoint for the Azure VM is also using TCP port 3398 as its internal port.</span><span class="sxs-lookup"><span data-stu-id="e031c-217">Verify that the Remote Desktop endpoint for the Azure VM is also using TCP port 3398 as its internal port.</span></span> <span data-ttu-id="e031c-218">Restart the Azure VM and try the Remote Desktop connection again.</span><span class="sxs-lookup"><span data-stu-id="e031c-218">Restart the Azure VM and try the Remote Desktop connection again.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="e031c-219">Additional resources</span><span class="sxs-lookup"><span data-stu-id="e031c-219">Additional resources</span></span>
[<span data-ttu-id="e031c-220">How to reset a password or the Remote Desktop service for Windows virtual machines</span><span class="sxs-lookup"><span data-stu-id="e031c-220">How to reset a password or the Remote Desktop service for Windows virtual machines</span></span>](reset-rdp.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)

[<span data-ttu-id="e031c-221">How to install and configure Azure PowerShell</span><span class="sxs-lookup"><span data-stu-id="e031c-221">How to install and configure Azure PowerShell</span></span>](/powershell/azureps-cmdlets-docs)

[<span data-ttu-id="e031c-222">Troubleshoot Secure Shell (SSH) connections to a Linux-based Azure virtual machine</span><span class="sxs-lookup"><span data-stu-id="e031c-222">Troubleshoot Secure Shell (SSH) connections to a Linux-based Azure virtual machine</span></span>](../linux/troubleshoot-ssh-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)

[<span data-ttu-id="e031c-223">Troubleshoot access to an application running on an Azure virtual machine</span><span class="sxs-lookup"><span data-stu-id="e031c-223">Troubleshoot access to an application running on an Azure virtual machine</span></span>](../linux/troubleshoot-app-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)






