---
title: 'Troubleshoot Azure Backup failure: Guest Agent Status Unavailable'
description: Symptoms, causes, and resolutions of Azure Backup failures related to agent, extension, and disks.
services: backup
author: genlin
manager: cshepard
keywords: Azure backup; VM agent; Network connectivity;
ms.service: backup
ms.topic: troubleshooting
ms.date: 06/25/2018
ms.author: genli
ms.openlocfilehash: 09cfda3c2c790297b0961ecac92cba61c9e6de6f
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44818849"
---
# <a name="troubleshoot-azure-backup-failure-issues-with-the-agent-or-extension"></a><span data-ttu-id="0044e-104">Troubleshoot Azure Backup failure: Issues with the agent or extension</span><span class="sxs-lookup"><span data-stu-id="0044e-104">Troubleshoot Azure Backup failure: Issues with the agent or extension</span></span>

<span data-ttu-id="0044e-105">This article provides troubleshooting steps that can help you resolve Azure Backup errors related to communication with the VM agent and extension.</span><span class="sxs-lookup"><span data-stu-id="0044e-105">This article provides troubleshooting steps that can help you resolve Azure Backup errors related to communication with the VM agent and extension.</span></span>

[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

## <a name="vm-agent-unable-to-communicate-with-azure-backup"></a><span data-ttu-id="0044e-106">VM agent unable to communicate with Azure Backup</span><span class="sxs-lookup"><span data-stu-id="0044e-106">VM agent unable to communicate with Azure Backup</span></span>

<span data-ttu-id="0044e-107">Error message: "VM Agent unable to communicate with Azure Backup"</span><span class="sxs-lookup"><span data-stu-id="0044e-107">Error message: "VM Agent unable to communicate with Azure Backup"</span></span><br>
<span data-ttu-id="0044e-108">Error code: "UserErrorGuestAgentStatusUnavailable"</span><span class="sxs-lookup"><span data-stu-id="0044e-108">Error code: "UserErrorGuestAgentStatusUnavailable"</span></span>

<span data-ttu-id="0044e-109">After you register and schedule a VM for the Backup service, Backup initiates the job by communicating with the VM agent to take a point-in-time snapshot.</span><span class="sxs-lookup"><span data-stu-id="0044e-109">After you register and schedule a VM for the Backup service, Backup initiates the job by communicating with the VM agent to take a point-in-time snapshot.</span></span> <span data-ttu-id="0044e-110">Any of the following conditions might prevent the snapshot from being triggered.</span><span class="sxs-lookup"><span data-stu-id="0044e-110">Any of the following conditions might prevent the snapshot from being triggered.</span></span> <span data-ttu-id="0044e-111">When a snapshot isn't triggered, the backup might fail.</span><span class="sxs-lookup"><span data-stu-id="0044e-111">When a snapshot isn't triggered, the backup might fail.</span></span> <span data-ttu-id="0044e-112">Complete the following troubleshooting steps in the order listed, and then retry your operation:</span><span class="sxs-lookup"><span data-stu-id="0044e-112">Complete the following troubleshooting steps in the order listed, and then retry your operation:</span></span>

<span data-ttu-id="0044e-113">**Cause 1: [The VM doesn't have internet access](#the-vm-has-no-internet-access)**</span><span class="sxs-lookup"><span data-stu-id="0044e-113">**Cause 1: [The VM doesn't have internet access](#the-vm-has-no-internet-access)**</span></span>  
<span data-ttu-id="0044e-114">**Cause 2: [The agent is installed in the VM, but it's unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**  </span><span class="sxs-lookup"><span data-stu-id="0044e-114">**Cause 2: [The agent is installed in the VM, but it's unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**  </span></span>  
<span data-ttu-id="0044e-115">**Cause 3: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**</span><span class="sxs-lookup"><span data-stu-id="0044e-115">**Cause 3: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**</span></span>  
<span data-ttu-id="0044e-116">**Cause 4: [The snapshot status can't be retrieved, or a snapshot can't be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**  </span><span class="sxs-lookup"><span data-stu-id="0044e-116">**Cause 4: [The snapshot status can't be retrieved, or a snapshot can't be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**  </span></span>  
<span data-ttu-id="0044e-117">**Cause 5: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)**</span><span class="sxs-lookup"><span data-stu-id="0044e-117">**Cause 5: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)**</span></span>  

## <a name="snapshot-operation-failed-due-to-no-network-connectivity-on-the-virtual-machine"></a><span data-ttu-id="0044e-118">Snapshot operation fails because the virtual machine isn't connected to the network</span><span class="sxs-lookup"><span data-stu-id="0044e-118">Snapshot operation fails because the virtual machine isn't connected to the network</span></span>

<span data-ttu-id="0044e-119">Error message: "Snapshot operation failed due to no network connectivity on the virtual machine"</span><span class="sxs-lookup"><span data-stu-id="0044e-119">Error message: "Snapshot operation failed due to no network connectivity on the virtual machine"</span></span><br>
<span data-ttu-id="0044e-120">Error code: "ExtensionSnapshotFailedNoNetwork"</span><span class="sxs-lookup"><span data-stu-id="0044e-120">Error code: "ExtensionSnapshotFailedNoNetwork"</span></span>

<span data-ttu-id="0044e-121">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span><span class="sxs-lookup"><span data-stu-id="0044e-121">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="0044e-122">Any of the following conditions might prevent the snapshot from being triggered.</span><span class="sxs-lookup"><span data-stu-id="0044e-122">Any of the following conditions might prevent the snapshot from being triggered.</span></span> <span data-ttu-id="0044e-123">If the snapshot isn't triggered, a backup failure might occur.</span><span class="sxs-lookup"><span data-stu-id="0044e-123">If the snapshot isn't triggered, a backup failure might occur.</span></span> <span data-ttu-id="0044e-124">Complete the following troubleshooting steps in the order listed, and then retry your operation:</span><span class="sxs-lookup"><span data-stu-id="0044e-124">Complete the following troubleshooting steps in the order listed, and then retry your operation:</span></span>    
<span data-ttu-id="0044e-125">**Cause 1: [The VM doesn't have internet access](#the-vm-has-no-internet-access)**</span><span class="sxs-lookup"><span data-stu-id="0044e-125">**Cause 1: [The VM doesn't have internet access](#the-vm-has-no-internet-access)**</span></span>  
<span data-ttu-id="0044e-126">**Cause 2: [The snapshot status can't be retrieved, or a snapshot can't be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**</span><span class="sxs-lookup"><span data-stu-id="0044e-126">**Cause 2: [The snapshot status can't be retrieved, or a snapshot can't be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**</span></span>  
<span data-ttu-id="0044e-127">**Cause 3: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)**</span><span class="sxs-lookup"><span data-stu-id="0044e-127">**Cause 3: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)**</span></span>  

## <a name="vmsnapshot-extension-operation-failed"></a><span data-ttu-id="0044e-128">VMSnapshot extension operation fails</span><span class="sxs-lookup"><span data-stu-id="0044e-128">VMSnapshot extension operation fails</span></span>

<span data-ttu-id="0044e-129">Error message: "VMSnapshot extension operation failed"</span><span class="sxs-lookup"><span data-stu-id="0044e-129">Error message: "VMSnapshot extension operation failed"</span></span><br>
<span data-ttu-id="0044e-130">Error code: "ExtentionOperationFailed"</span><span class="sxs-lookup"><span data-stu-id="0044e-130">Error code: "ExtentionOperationFailed"</span></span>

<span data-ttu-id="0044e-131">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span><span class="sxs-lookup"><span data-stu-id="0044e-131">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="0044e-132">Any of the following conditions might prevent the snapshot from being triggered.</span><span class="sxs-lookup"><span data-stu-id="0044e-132">Any of the following conditions might prevent the snapshot from being triggered.</span></span> <span data-ttu-id="0044e-133">If the snapshot isn't triggered, a backup failure might occur.</span><span class="sxs-lookup"><span data-stu-id="0044e-133">If the snapshot isn't triggered, a backup failure might occur.</span></span> <span data-ttu-id="0044e-134">Complete the following troubleshooting steps in the order listed, and then retry your operation:</span><span class="sxs-lookup"><span data-stu-id="0044e-134">Complete the following troubleshooting steps in the order listed, and then retry your operation:</span></span>  
<span data-ttu-id="0044e-135">**Cause 1: [The snapshot status can't be retrieved, or a snapshot can't be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**</span><span class="sxs-lookup"><span data-stu-id="0044e-135">**Cause 1: [The snapshot status can't be retrieved, or a snapshot can't be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**</span></span>  
<span data-ttu-id="0044e-136">**Cause 2: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)**</span><span class="sxs-lookup"><span data-stu-id="0044e-136">**Cause 2: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)**</span></span>  
<span data-ttu-id="0044e-137">**Cause 3: [The agent is installed in the VM, but it's unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**</span><span class="sxs-lookup"><span data-stu-id="0044e-137">**Cause 3: [The agent is installed in the VM, but it's unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**</span></span>  
<span data-ttu-id="0044e-138">**Cause 4: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**</span><span class="sxs-lookup"><span data-stu-id="0044e-138">**Cause 4: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**</span></span>

## <a name="backup-fails-because-the-vm-agent-is-unresponsive"></a><span data-ttu-id="0044e-139">Backup fails because the VM agent is unresponsive</span><span class="sxs-lookup"><span data-stu-id="0044e-139">Backup fails because the VM agent is unresponsive</span></span>

<span data-ttu-id="0044e-140">Error message: "Could not communicate with the VM agent for snapshot status"</span><span class="sxs-lookup"><span data-stu-id="0044e-140">Error message: "Could not communicate with the VM agent for snapshot status"</span></span> <br>
<span data-ttu-id="0044e-141">Error code: "GuestAgentSnapshotTaskStatusError"</span><span class="sxs-lookup"><span data-stu-id="0044e-141">Error code: "GuestAgentSnapshotTaskStatusError"</span></span>

<span data-ttu-id="0044e-142">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span><span class="sxs-lookup"><span data-stu-id="0044e-142">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="0044e-143">Any of the following conditions might prevent the snapshot from being triggered.</span><span class="sxs-lookup"><span data-stu-id="0044e-143">Any of the following conditions might prevent the snapshot from being triggered.</span></span> <span data-ttu-id="0044e-144">If the snapshot isn't triggered, a backup failure might occur.</span><span class="sxs-lookup"><span data-stu-id="0044e-144">If the snapshot isn't triggered, a backup failure might occur.</span></span> <span data-ttu-id="0044e-145">Complete the following troubleshooting steps in the order listed, and then retry your operation:</span><span class="sxs-lookup"><span data-stu-id="0044e-145">Complete the following troubleshooting steps in the order listed, and then retry your operation:</span></span>  
<span data-ttu-id="0044e-146">**Cause 1: [The agent is installed in the VM, but it's unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**</span><span class="sxs-lookup"><span data-stu-id="0044e-146">**Cause 1: [The agent is installed in the VM, but it's unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**</span></span>  
<span data-ttu-id="0044e-147">**Cause 2: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**</span><span class="sxs-lookup"><span data-stu-id="0044e-147">**Cause 2: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**</span></span>  
<span data-ttu-id="0044e-148">**Cause 3: [The VM doesn't have internet access](#the-vm-has-no-internet-access)**</span><span class="sxs-lookup"><span data-stu-id="0044e-148">**Cause 3: [The VM doesn't have internet access](#the-vm-has-no-internet-access)**</span></span>  

## <a name="backup-fails-with-an-internal-error"></a><span data-ttu-id="0044e-149">Backup fails, with an internal error</span><span class="sxs-lookup"><span data-stu-id="0044e-149">Backup fails, with an internal error</span></span>

<span data-ttu-id="0044e-150">Error message: "Backup failed with an internal error - Please retry the operation in a few minutes"</span><span class="sxs-lookup"><span data-stu-id="0044e-150">Error message: "Backup failed with an internal error - Please retry the operation in a few minutes"</span></span> <br>
<span data-ttu-id="0044e-151">Error code: "BackUpOperationFailed"/ "BackUpOperationFailedV2"</span><span class="sxs-lookup"><span data-stu-id="0044e-151">Error code: "BackUpOperationFailed"/ "BackUpOperationFailedV2"</span></span>

<span data-ttu-id="0044e-152">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span><span class="sxs-lookup"><span data-stu-id="0044e-152">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="0044e-153">Any of the following conditions might prevent the snapshot from being triggered.</span><span class="sxs-lookup"><span data-stu-id="0044e-153">Any of the following conditions might prevent the snapshot from being triggered.</span></span> <span data-ttu-id="0044e-154">If the snapshot isn't triggered, a backup failure might occur.</span><span class="sxs-lookup"><span data-stu-id="0044e-154">If the snapshot isn't triggered, a backup failure might occur.</span></span> <span data-ttu-id="0044e-155">Complete the following troubleshooting steps in the order listed, and then retry your operation:</span><span class="sxs-lookup"><span data-stu-id="0044e-155">Complete the following troubleshooting steps in the order listed, and then retry your operation:</span></span>  
<span data-ttu-id="0044e-156">**Cause 1: [The VM doesn't have internet access](#the-vm-has-no-internet-access)**</span><span class="sxs-lookup"><span data-stu-id="0044e-156">**Cause 1: [The VM doesn't have internet access](#the-vm-has-no-internet-access)**</span></span>  
<span data-ttu-id="0044e-157">**Cause 2: [The agent installed in the VM, but it's unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**</span><span class="sxs-lookup"><span data-stu-id="0044e-157">**Cause 2: [The agent installed in the VM, but it's unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**</span></span>  
<span data-ttu-id="0044e-158">**Cause 3: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**</span><span class="sxs-lookup"><span data-stu-id="0044e-158">**Cause 3: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**</span></span>  
<span data-ttu-id="0044e-159">**Cause 4: [The snapshot status can't be retrieved, or a snapshot can't be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**</span><span class="sxs-lookup"><span data-stu-id="0044e-159">**Cause 4: [The snapshot status can't be retrieved, or a snapshot can't be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**</span></span>  
<span data-ttu-id="0044e-160">**Cause 5: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)**</span><span class="sxs-lookup"><span data-stu-id="0044e-160">**Cause 5: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)**</span></span>  
<span data-ttu-id="0044e-161">**Cause 6: [Backup service doesn't have permission to delete the old restore points because of a resource group lock](#backup-service-does-not-have-permission-to-delete-the-old-restore-points-due-to-resource-group-lock)**</span><span class="sxs-lookup"><span data-stu-id="0044e-161">**Cause 6: [Backup service doesn't have permission to delete the old restore points because of a resource group lock](#backup-service-does-not-have-permission-to-delete-the-old-restore-points-due-to-resource-group-lock)**</span></span>

## <a name="causes-and-solutions"></a><span data-ttu-id="0044e-162">Causes and solutions</span><span class="sxs-lookup"><span data-stu-id="0044e-162">Causes and solutions</span></span>

### <a name="the-vm-has-no-internet-access"></a><span data-ttu-id="0044e-163">The VM doesn't have internet access</span><span class="sxs-lookup"><span data-stu-id="0044e-163">The VM doesn't have internet access</span></span>
<span data-ttu-id="0044e-164">Per the deployment requirement, the VM doesn't have internet access.</span><span class="sxs-lookup"><span data-stu-id="0044e-164">Per the deployment requirement, the VM doesn't have internet access.</span></span> <span data-ttu-id="0044e-165">Or, it might have restrictions that prevent access to the Azure infrastructure.</span><span class="sxs-lookup"><span data-stu-id="0044e-165">Or, it might have restrictions that prevent access to the Azure infrastructure.</span></span>

<span data-ttu-id="0044e-166">To function correctly, the Backup extension requires connectivity to Azure public IP addresses.</span><span class="sxs-lookup"><span data-stu-id="0044e-166">To function correctly, the Backup extension requires connectivity to Azure public IP addresses.</span></span> <span data-ttu-id="0044e-167">The extension sends commands to an Azure storage endpoint (HTTPs URL) to manage the snapshots of the VM.</span><span class="sxs-lookup"><span data-stu-id="0044e-167">The extension sends commands to an Azure storage endpoint (HTTPs URL) to manage the snapshots of the VM.</span></span> <span data-ttu-id="0044e-168">If the extension doesn't have access to the public internet, backup eventually fails.</span><span class="sxs-lookup"><span data-stu-id="0044e-168">If the extension doesn't have access to the public internet, backup eventually fails.</span></span>

<span data-ttu-id="0044e-169">It is possible to deploy a proxy server to route the VM traffic.</span><span class="sxs-lookup"><span data-stu-id="0044e-169">It is possible to deploy a proxy server to route the VM traffic.</span></span>
##### <a name="create-a-path-for-https-traffic"></a><span data-ttu-id="0044e-170">Create a path for HTTPs traffic</span><span class="sxs-lookup"><span data-stu-id="0044e-170">Create a path for HTTPs traffic</span></span>

1. <span data-ttu-id="0044e-171">If you have network restrictions in place (for example, a network security group), deploy an HTTPs proxy server to route the traffic.</span><span class="sxs-lookup"><span data-stu-id="0044e-171">If you have network restrictions in place (for example, a network security group), deploy an HTTPs proxy server to route the traffic.</span></span>
2. <span data-ttu-id="0044e-172">To allow access to the internet from the HTTPs proxy server, add rules to the network security group, if you have one.</span><span class="sxs-lookup"><span data-stu-id="0044e-172">To allow access to the internet from the HTTPs proxy server, add rules to the network security group, if you have one.</span></span>

<span data-ttu-id="0044e-173">To learn how to set up an HTTPs proxy for VM backups, see [Prepare your environment to back up Azure virtual machines](backup-azure-arm-vms-prepare.md#establish-network-connectivity).</span><span class="sxs-lookup"><span data-stu-id="0044e-173">To learn how to set up an HTTPs proxy for VM backups, see [Prepare your environment to back up Azure virtual machines](backup-azure-arm-vms-prepare.md#establish-network-connectivity).</span></span>

<span data-ttu-id="0044e-174">Either the backed up VM or the proxy server through which the traffic is routed requires access to Azure Public IP addresses</span><span class="sxs-lookup"><span data-stu-id="0044e-174">Either the backed up VM or the proxy server through which the traffic is routed requires access to Azure Public IP addresses</span></span>

####  <a name="solution"></a><span data-ttu-id="0044e-175">Solution</span><span class="sxs-lookup"><span data-stu-id="0044e-175">Solution</span></span>
<span data-ttu-id="0044e-176">To resolve the issue, try one of the following methods:</span><span class="sxs-lookup"><span data-stu-id="0044e-176">To resolve the issue, try one of the following methods:</span></span>

##### <a name="allow-access-to-azure-storage-that-corresponds-to-the-region"></a><span data-ttu-id="0044e-177">Allow access to Azure storage that corresponds to the region</span><span class="sxs-lookup"><span data-stu-id="0044e-177">Allow access to Azure storage that corresponds to the region</span></span>

<span data-ttu-id="0044e-178">You can use [service tags](../virtual-network/security-overview.md#service-tags) to allow connections to storage of the specific region.</span><span class="sxs-lookup"><span data-stu-id="0044e-178">You can use [service tags](../virtual-network/security-overview.md#service-tags) to allow connections to storage of the specific region.</span></span> <span data-ttu-id="0044e-179">Ensure that the rule that allows access to the storage account has higher priority than the rule that blocks internet access.</span><span class="sxs-lookup"><span data-stu-id="0044e-179">Ensure that the rule that allows access to the storage account has higher priority than the rule that blocks internet access.</span></span> 

![Network security group with storage tags for a region](./media/backup-azure-arm-vms-prepare/storage-tags-with-nsg.png)

<span data-ttu-id="0044e-181">To understand the step by step procedure to configure service tags, watch [this video](https://youtu.be/1EjLQtbKm1M).</span><span class="sxs-lookup"><span data-stu-id="0044e-181">To understand the step by step procedure to configure service tags, watch [this video](https://youtu.be/1EjLQtbKm1M).</span></span>

> [!WARNING]
> <span data-ttu-id="0044e-182">Storage service tags are in preview.</span><span class="sxs-lookup"><span data-stu-id="0044e-182">Storage service tags are in preview.</span></span> <span data-ttu-id="0044e-183">They are available only in specific regions.</span><span class="sxs-lookup"><span data-stu-id="0044e-183">They are available only in specific regions.</span></span> <span data-ttu-id="0044e-184">For a list of regions, see [Service tags for storage](../virtual-network/security-overview.md#service-tags).</span><span class="sxs-lookup"><span data-stu-id="0044e-184">For a list of regions, see [Service tags for storage](../virtual-network/security-overview.md#service-tags).</span></span>

<span data-ttu-id="0044e-185">If you use Azure Managed Disks, you might need an additional port opening (port 8443) on the firewalls.</span><span class="sxs-lookup"><span data-stu-id="0044e-185">If you use Azure Managed Disks, you might need an additional port opening (port 8443) on the firewalls.</span></span>

### <a name="the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a><span data-ttu-id="0044e-186">The agent is installed in the VM, but it's unresponsive (for Windows VMs)</span><span class="sxs-lookup"><span data-stu-id="0044e-186">The agent is installed in the VM, but it's unresponsive (for Windows VMs)</span></span>

#### <a name="solution"></a><span data-ttu-id="0044e-187">Solution</span><span class="sxs-lookup"><span data-stu-id="0044e-187">Solution</span></span>
<span data-ttu-id="0044e-188">The VM agent might have been corrupted, or the service might have been stopped.</span><span class="sxs-lookup"><span data-stu-id="0044e-188">The VM agent might have been corrupted, or the service might have been stopped.</span></span> <span data-ttu-id="0044e-189">Reinstalling the VM agent helps get the latest version.</span><span class="sxs-lookup"><span data-stu-id="0044e-189">Reinstalling the VM agent helps get the latest version.</span></span> <span data-ttu-id="0044e-190">It also helps restart communication with the service.</span><span class="sxs-lookup"><span data-stu-id="0044e-190">It also helps restart communication with the service.</span></span>

1. <span data-ttu-id="0044e-191">Determine whether the Windows Guest Agent service is running in the VM services (services.msc).</span><span class="sxs-lookup"><span data-stu-id="0044e-191">Determine whether the Windows Guest Agent service is running in the VM services (services.msc).</span></span> <span data-ttu-id="0044e-192">Try to restart the Windows Guest Agent service and initiate the backup.</span><span class="sxs-lookup"><span data-stu-id="0044e-192">Try to restart the Windows Guest Agent service and initiate the backup.</span></span>    
2. <span data-ttu-id="0044e-193">If the Windows Guest Agent service isn't visible in services, in Control Panel, go to **Programs and Features** to determine whether the Windows Guest Agent service is installed.</span><span class="sxs-lookup"><span data-stu-id="0044e-193">If the Windows Guest Agent service isn't visible in services, in Control Panel, go to **Programs and Features** to determine whether the Windows Guest Agent service is installed.</span></span>
4. <span data-ttu-id="0044e-194">If the Windows Guest Agent appears in **Programs and Features**, uninstall the Windows Guest Agent.</span><span class="sxs-lookup"><span data-stu-id="0044e-194">If the Windows Guest Agent appears in **Programs and Features**, uninstall the Windows Guest Agent.</span></span>
5. <span data-ttu-id="0044e-195">Download and install the [latest version of the agent MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="0044e-195">Download and install the [latest version of the agent MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <span data-ttu-id="0044e-196">You must have Administrator rights to complete the installation.</span><span class="sxs-lookup"><span data-stu-id="0044e-196">You must have Administrator rights to complete the installation.</span></span>
6. <span data-ttu-id="0044e-197">Verify that the Windows Guest Agent services appear in services.</span><span class="sxs-lookup"><span data-stu-id="0044e-197">Verify that the Windows Guest Agent services appear in services.</span></span>
7. <span data-ttu-id="0044e-198">Run an on-demand backup:</span><span class="sxs-lookup"><span data-stu-id="0044e-198">Run an on-demand backup:</span></span> 
    * <span data-ttu-id="0044e-199">In the portal, select **Backup Now**.</span><span class="sxs-lookup"><span data-stu-id="0044e-199">In the portal, select **Backup Now**.</span></span>

<span data-ttu-id="0044e-200">Also, verify that [Microsoft .NET 4.5 is installed](https://docs.microsoft.com/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed) in the VM.</span><span class="sxs-lookup"><span data-stu-id="0044e-200">Also, verify that [Microsoft .NET 4.5 is installed](https://docs.microsoft.com/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed) in the VM.</span></span> <span data-ttu-id="0044e-201">.NET 4.5 is required for the VM agent to communicate with the service.</span><span class="sxs-lookup"><span data-stu-id="0044e-201">.NET 4.5 is required for the VM agent to communicate with the service.</span></span>

### <a name="the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a><span data-ttu-id="0044e-202">The agent installed in the VM is out of date (for Linux VMs)</span><span class="sxs-lookup"><span data-stu-id="0044e-202">The agent installed in the VM is out of date (for Linux VMs)</span></span>

#### <a name="solution"></a><span data-ttu-id="0044e-203">Solution</span><span class="sxs-lookup"><span data-stu-id="0044e-203">Solution</span></span>
<span data-ttu-id="0044e-204">Most agent-related or extension-related failures for Linux VMs are caused by issues that affect an outdated VM agent.</span><span class="sxs-lookup"><span data-stu-id="0044e-204">Most agent-related or extension-related failures for Linux VMs are caused by issues that affect an outdated VM agent.</span></span> <span data-ttu-id="0044e-205">To troubleshoot this issue, follow these general guidelines:</span><span class="sxs-lookup"><span data-stu-id="0044e-205">To troubleshoot this issue, follow these general guidelines:</span></span>

1. <span data-ttu-id="0044e-206">Follow the instructions for [updating the Linux VM agent](../virtual-machines/linux/update-agent.md).</span><span class="sxs-lookup"><span data-stu-id="0044e-206">Follow the instructions for [updating the Linux VM agent](../virtual-machines/linux/update-agent.md).</span></span>

 > [!NOTE]
 > <span data-ttu-id="0044e-207">We *strongly recommend* that you update the agent only through a distribution repository.</span><span class="sxs-lookup"><span data-stu-id="0044e-207">We *strongly recommend* that you update the agent only through a distribution repository.</span></span> <span data-ttu-id="0044e-208">We do not recommend downloading the agent code directly from GitHub and updating it.</span><span class="sxs-lookup"><span data-stu-id="0044e-208">We do not recommend downloading the agent code directly from GitHub and updating it.</span></span> <span data-ttu-id="0044e-209">If the latest agent for your distribution is not available, contact distribution support for instructions on how to install it.</span><span class="sxs-lookup"><span data-stu-id="0044e-209">If the latest agent for your distribution is not available, contact distribution support for instructions on how to install it.</span></span> <span data-ttu-id="0044e-210">To check for the most recent agent, go to the [Windows Azure Linux agent](https://github.com/Azure/WALinuxAgent/releases) page in the GitHub repository.</span><span class="sxs-lookup"><span data-stu-id="0044e-210">To check for the most recent agent, go to the [Windows Azure Linux agent](https://github.com/Azure/WALinuxAgent/releases) page in the GitHub repository.</span></span>

2. <span data-ttu-id="0044e-211">Ensure that the Azure agent is running on the VM by running the following command: `ps -e`</span><span class="sxs-lookup"><span data-stu-id="0044e-211">Ensure that the Azure agent is running on the VM by running the following command: `ps -e`</span></span>

 <span data-ttu-id="0044e-212">If the process isn't running, restart it by using the following commands:</span><span class="sxs-lookup"><span data-stu-id="0044e-212">If the process isn't running, restart it by using the following commands:</span></span>

 * <span data-ttu-id="0044e-213">For Ubuntu: `service walinuxagent start`</span><span class="sxs-lookup"><span data-stu-id="0044e-213">For Ubuntu: `service walinuxagent start`</span></span>
 * <span data-ttu-id="0044e-214">For other distributions: `service waagent start`</span><span class="sxs-lookup"><span data-stu-id="0044e-214">For other distributions: `service waagent start`</span></span>

3. <span data-ttu-id="0044e-215">[Configure the auto restart agent](https://github.com/Azure/WALinuxAgent/wiki/Known-Issues#mitigate_agent_crash).</span><span class="sxs-lookup"><span data-stu-id="0044e-215">[Configure the auto restart agent](https://github.com/Azure/WALinuxAgent/wiki/Known-Issues#mitigate_agent_crash).</span></span>
4. <span data-ttu-id="0044e-216">Run a new test backup.</span><span class="sxs-lookup"><span data-stu-id="0044e-216">Run a new test backup.</span></span> <span data-ttu-id="0044e-217">If the failure persists, collect the following logs from the VM:</span><span class="sxs-lookup"><span data-stu-id="0044e-217">If the failure persists, collect the following logs from the VM:</span></span>

   * <span data-ttu-id="0044e-218">/var/lib/waagent/\*.xml</span><span class="sxs-lookup"><span data-stu-id="0044e-218">/var/lib/waagent/\*.xml</span></span>
   * <span data-ttu-id="0044e-219">/var/log/waagent.log</span><span class="sxs-lookup"><span data-stu-id="0044e-219">/var/log/waagent.log</span></span>
   * <span data-ttu-id="0044e-220">/var/log/azure/\*</span><span class="sxs-lookup"><span data-stu-id="0044e-220">/var/log/azure/\*</span></span>

<span data-ttu-id="0044e-221">If we require verbose logging for waagent, follow these steps:</span><span class="sxs-lookup"><span data-stu-id="0044e-221">If we require verbose logging for waagent, follow these steps:</span></span>

1. <span data-ttu-id="0044e-222">In the /etc/waagent.conf file, locate the following line: **Enable verbose logging (y|n)**</span><span class="sxs-lookup"><span data-stu-id="0044e-222">In the /etc/waagent.conf file, locate the following line: **Enable verbose logging (y|n)**</span></span>
2. <span data-ttu-id="0044e-223">Change the **Logs.Verbose** value from *n* to *y*.</span><span class="sxs-lookup"><span data-stu-id="0044e-223">Change the **Logs.Verbose** value from *n* to *y*.</span></span>
3. <span data-ttu-id="0044e-224">Save the change, and then restart waagent by completing the steps described earlier in this section.</span><span class="sxs-lookup"><span data-stu-id="0044e-224">Save the change, and then restart waagent by completing the steps described earlier in this section.</span></span>

###  <a name="the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a><span data-ttu-id="0044e-225">The snapshot status can't be retrieved, or a snapshot can't be taken</span><span class="sxs-lookup"><span data-stu-id="0044e-225">The snapshot status can't be retrieved, or a snapshot can't be taken</span></span>
<span data-ttu-id="0044e-226">The VM backup relies on issuing a snapshot command to the underlying storage account.</span><span class="sxs-lookup"><span data-stu-id="0044e-226">The VM backup relies on issuing a snapshot command to the underlying storage account.</span></span> <span data-ttu-id="0044e-227">Backup can fail either because it has no access to the storage account, or because the execution of the snapshot task is delayed.</span><span class="sxs-lookup"><span data-stu-id="0044e-227">Backup can fail either because it has no access to the storage account, or because the execution of the snapshot task is delayed.</span></span>

#### <a name="solution"></a><span data-ttu-id="0044e-228">Solution</span><span class="sxs-lookup"><span data-stu-id="0044e-228">Solution</span></span>
<span data-ttu-id="0044e-229">The following conditions might cause the snapshot task to fail:</span><span class="sxs-lookup"><span data-stu-id="0044e-229">The following conditions might cause the snapshot task to fail:</span></span>

| <span data-ttu-id="0044e-230">Cause</span><span class="sxs-lookup"><span data-stu-id="0044e-230">Cause</span></span> | <span data-ttu-id="0044e-231">Solution</span><span class="sxs-lookup"><span data-stu-id="0044e-231">Solution</span></span> |
| --- | --- |
| <span data-ttu-id="0044e-232">The VM status is reported incorrectly because the VM is shut down in Remote Desktop Protocol (RDP).</span><span class="sxs-lookup"><span data-stu-id="0044e-232">The VM status is reported incorrectly because the VM is shut down in Remote Desktop Protocol (RDP).</span></span> | <span data-ttu-id="0044e-233">If you shut down the VM in RDP, check the portal to determine whether the VM status is correct.</span><span class="sxs-lookup"><span data-stu-id="0044e-233">If you shut down the VM in RDP, check the portal to determine whether the VM status is correct.</span></span> <span data-ttu-id="0044e-234">If it’s not correct, shut down the VM in the portal by using the **Shutdown** option on the VM dashboard.</span><span class="sxs-lookup"><span data-stu-id="0044e-234">If it’s not correct, shut down the VM in the portal by using the **Shutdown** option on the VM dashboard.</span></span> |
| <span data-ttu-id="0044e-235">The VM can't get the host or fabric address from DHCP.</span><span class="sxs-lookup"><span data-stu-id="0044e-235">The VM can't get the host or fabric address from DHCP.</span></span> | <span data-ttu-id="0044e-236">DHCP must be enabled inside the guest for the IaaS VM backup to work.</span><span class="sxs-lookup"><span data-stu-id="0044e-236">DHCP must be enabled inside the guest for the IaaS VM backup to work.</span></span> <span data-ttu-id="0044e-237">If the VM can't get the host or fabric address from DHCP response 245, it can't download or run any extensions.</span><span class="sxs-lookup"><span data-stu-id="0044e-237">If the VM can't get the host or fabric address from DHCP response 245, it can't download or run any extensions.</span></span> <span data-ttu-id="0044e-238">If you need a static private IP, configure it through the platform.</span><span class="sxs-lookup"><span data-stu-id="0044e-238">If you need a static private IP, configure it through the platform.</span></span> <span data-ttu-id="0044e-239">The DHCP option inside the VM should be left enabled.</span><span class="sxs-lookup"><span data-stu-id="0044e-239">The DHCP option inside the VM should be left enabled.</span></span> <span data-ttu-id="0044e-240">For more information, see [Set a static internal private IP](../virtual-network/virtual-networks-reserved-private-ip.md).</span><span class="sxs-lookup"><span data-stu-id="0044e-240">For more information, see [Set a static internal private IP](../virtual-network/virtual-networks-reserved-private-ip.md).</span></span> |

### <a name="the-backup-extension-fails-to-update-or-load"></a><span data-ttu-id="0044e-241">The backup extension fails to update or load</span><span class="sxs-lookup"><span data-stu-id="0044e-241">The backup extension fails to update or load</span></span>
<span data-ttu-id="0044e-242">If extensions can't load, backup fails because a snapshot can't be taken.</span><span class="sxs-lookup"><span data-stu-id="0044e-242">If extensions can't load, backup fails because a snapshot can't be taken.</span></span>

#### <a name="solution"></a><span data-ttu-id="0044e-243">Solution</span><span class="sxs-lookup"><span data-stu-id="0044e-243">Solution</span></span>

<span data-ttu-id="0044e-244">Uninstall the extension to force the VMSnapshot extension to reload.</span><span class="sxs-lookup"><span data-stu-id="0044e-244">Uninstall the extension to force the VMSnapshot extension to reload.</span></span> <span data-ttu-id="0044e-245">The next backup attempt reloads the extension.</span><span class="sxs-lookup"><span data-stu-id="0044e-245">The next backup attempt reloads the extension.</span></span>

<span data-ttu-id="0044e-246">To uninstall the extension:</span><span class="sxs-lookup"><span data-stu-id="0044e-246">To uninstall the extension:</span></span>

1. <span data-ttu-id="0044e-247">In the [Azure portal](https://portal.azure.com/), go to the VM that is experiencing backup failure.</span><span class="sxs-lookup"><span data-stu-id="0044e-247">In the [Azure portal](https://portal.azure.com/), go to the VM that is experiencing backup failure.</span></span>
2. <span data-ttu-id="0044e-248">Select **Settings**.</span><span class="sxs-lookup"><span data-stu-id="0044e-248">Select **Settings**.</span></span>
3. <span data-ttu-id="0044e-249">Select **Extensions**.</span><span class="sxs-lookup"><span data-stu-id="0044e-249">Select **Extensions**.</span></span>
4. <span data-ttu-id="0044e-250">Select **Vmsnapshot Extension**.</span><span class="sxs-lookup"><span data-stu-id="0044e-250">Select **Vmsnapshot Extension**.</span></span>
5. <span data-ttu-id="0044e-251">Select **Uninstall**.</span><span class="sxs-lookup"><span data-stu-id="0044e-251">Select **Uninstall**.</span></span>

<span data-ttu-id="0044e-252">For Linux VM, If the VMSnapshot extension does not show in the Azure portal, [update the Azure Linux Agent](../virtual-machines/linux/update-agent.md), and then run the backup.</span><span class="sxs-lookup"><span data-stu-id="0044e-252">For Linux VM, If the VMSnapshot extension does not show in the Azure portal, [update the Azure Linux Agent](../virtual-machines/linux/update-agent.md), and then run the backup.</span></span> 

<span data-ttu-id="0044e-253">Completing these steps causes the extension to be reinstalled during the next backup.</span><span class="sxs-lookup"><span data-stu-id="0044e-253">Completing these steps causes the extension to be reinstalled during the next backup.</span></span>

### <a name="backup-service-does-not-have-permission-to-delete-the-old-restore-points-due-to-resource-group-lock"></a><span data-ttu-id="0044e-254">The Backup service doesn't have permission to delete the old restore points because of a resource group lock</span><span class="sxs-lookup"><span data-stu-id="0044e-254">The Backup service doesn't have permission to delete the old restore points because of a resource group lock</span></span>
<span data-ttu-id="0044e-255">This issue is specific to managed VMs in which the user locks the resource group.</span><span class="sxs-lookup"><span data-stu-id="0044e-255">This issue is specific to managed VMs in which the user locks the resource group.</span></span> <span data-ttu-id="0044e-256">In this case, the backup service can't delete older restore points.</span><span class="sxs-lookup"><span data-stu-id="0044e-256">In this case, the backup service can't delete older restore points.</span></span> <span data-ttu-id="0044e-257">Because there's a limit of 18 restore points, new backups start to fail.</span><span class="sxs-lookup"><span data-stu-id="0044e-257">Because there's a limit of 18 restore points, new backups start to fail.</span></span>

#### <a name="solution"></a><span data-ttu-id="0044e-258">Solution</span><span class="sxs-lookup"><span data-stu-id="0044e-258">Solution</span></span>

<span data-ttu-id="0044e-259">To resolve the issue, remove the lock from the resource group and complete the following steps to remove the restore point collection:</span><span class="sxs-lookup"><span data-stu-id="0044e-259">To resolve the issue, remove the lock from the resource group and complete the following steps to remove the restore point collection:</span></span> 
 
1. <span data-ttu-id="0044e-260">Remove the lock in the resource group in which the VM is located.</span><span class="sxs-lookup"><span data-stu-id="0044e-260">Remove the lock in the resource group in which the VM is located.</span></span> 
2. <span data-ttu-id="0044e-261">Install ARMClient by using Chocolatey:</span><span class="sxs-lookup"><span data-stu-id="0044e-261">Install ARMClient by using Chocolatey:</span></span> <br>
   <span data-ttu-id="0044e-262">https://github.com/projectkudu/ARMClient</span><span class="sxs-lookup"><span data-stu-id="0044e-262">https://github.com/projectkudu/ARMClient</span></span>
3. <span data-ttu-id="0044e-263">Sign in to ARMClient:</span><span class="sxs-lookup"><span data-stu-id="0044e-263">Sign in to ARMClient:</span></span> <br>
    `.\armclient.exe login`
4. <span data-ttu-id="0044e-264">Get the restore point collection that corresponds to the VM:</span><span class="sxs-lookup"><span data-stu-id="0044e-264">Get the restore point collection that corresponds to the VM:</span></span> <br>
    `.\armclient.exe get https://management.azure.com/subscriptions/<SubscriptionId>/resourceGroups/<ResourceGroupName>/providers/Microsoft.Compute/restorepointcollections/AzureBackup_<VM-Name>?api-version=2017-03-30`

    <span data-ttu-id="0044e-265">Example: `.\armclient.exe get https://management.azure.com/subscriptions/f2edfd5d-5496-4683-b94f-b3588c579006/resourceGroups/winvaultrg/providers/Microsoft.Compute/restorepointcollections/AzureBackup_winmanagedvm?api-version=2017-03-30`</span><span class="sxs-lookup"><span data-stu-id="0044e-265">Example: `.\armclient.exe get https://management.azure.com/subscriptions/f2edfd5d-5496-4683-b94f-b3588c579006/resourceGroups/winvaultrg/providers/Microsoft.Compute/restorepointcollections/AzureBackup_winmanagedvm?api-version=2017-03-30`</span></span>
5. <span data-ttu-id="0044e-266">Delete the restore point collection:</span><span class="sxs-lookup"><span data-stu-id="0044e-266">Delete the restore point collection:</span></span> <br>
    `.\armclient.exe delete https://management.azure.com/subscriptions/<SubscriptionId>/resourceGroups/<ResourceGroupName>/providers/Microsoft.Compute/restorepointcollections/AzureBackup_<VM-Name>?api-version=2017-03-30` 
6. <span data-ttu-id="0044e-267">The next scheduled backup automatically creates a restore point collection and new restore points.</span><span class="sxs-lookup"><span data-stu-id="0044e-267">The next scheduled backup automatically creates a restore point collection and new restore points.</span></span>

<span data-ttu-id="0044e-268">Once done, you can again put back the lock on the VM resource group.</span><span class="sxs-lookup"><span data-stu-id="0044e-268">Once done, you can again put back the lock on the VM resource group.</span></span> 
