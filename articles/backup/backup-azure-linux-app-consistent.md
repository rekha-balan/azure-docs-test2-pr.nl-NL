---
title: 'Azure Backup: application consistent backups of Linux VMs | Microsoft Docs'
description: Use scripts to guarantee application-consistent backups to Azure, for your Linux virtual machines. The scripts apply only to Linux VMs in a Resource Manager deployment; the scripts do not apply to Windows VMs or service manager deployments. This article takes you through the steps for configuring the scripts, including troubleshooting.
services: backup
documentationcenter: dev-center-name
author: anuragmehrotra
manager: shivamg
keywords: app-consistent backup; application-consistent Azure VM backup; Linux VM backup; Azure Backup
ms.assetid: bbb99cf2-d8c7-4b3d-8b29-eadc0fed3bef
ms.service: backup
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 4/12/2017
ms.author: anuragm;markgal
ms.openlocfilehash: 0f4ca1924531df890433ec092790e6bec7c41df0
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44564058"
---
# <a name="application-consistent-backup-of-azure-linux-vms-preview"></a><span data-ttu-id="8ccca-106">Application consistent backup of Azure Linux VMs (Preview)</span><span class="sxs-lookup"><span data-stu-id="8ccca-106">Application consistent backup of Azure Linux VMs (Preview)</span></span>

<span data-ttu-id="8ccca-107">This article talks about the Linux pre- and post-script framework, and how it can be used to take application-consistent backups of Azure Linux VMs.</span><span class="sxs-lookup"><span data-stu-id="8ccca-107">This article talks about the Linux pre- and post-script framework, and how it can be used to take application-consistent backups of Azure Linux VMs.</span></span>

> [!Note]
> <span data-ttu-id="8ccca-108">Pre- and post-script framework is supported only for Resource Manager-deployed Linux virtual machines.</span><span class="sxs-lookup"><span data-stu-id="8ccca-108">Pre- and post-script framework is supported only for Resource Manager-deployed Linux virtual machines.</span></span> <span data-ttu-id="8ccca-109">Scripts for application consistency is not supported for Service Manager-deployed virtual machines or Windows virtual machines.</span><span class="sxs-lookup"><span data-stu-id="8ccca-109">Scripts for application consistency is not supported for Service Manager-deployed virtual machines or Windows virtual machines.</span></span>
>

## <a name="how-the-framework-works"></a><span data-ttu-id="8ccca-110">How the framework works</span><span class="sxs-lookup"><span data-stu-id="8ccca-110">How the framework works</span></span>

<span data-ttu-id="8ccca-111">The framework provides an option to run custom pre and post scripts while taking VM snapshot.</span><span class="sxs-lookup"><span data-stu-id="8ccca-111">The framework provides an option to run custom pre and post scripts while taking VM snapshot.</span></span> <span data-ttu-id="8ccca-112">Pre-script is executed just before taking the VM snapshot and post script is executed immediately after VM snapshot completion.</span><span class="sxs-lookup"><span data-stu-id="8ccca-112">Pre-script is executed just before taking the VM snapshot and post script is executed immediately after VM snapshot completion.</span></span> <span data-ttu-id="8ccca-113">This gives the flexibility to users to control their application and environment while taking VM backup.</span><span class="sxs-lookup"><span data-stu-id="8ccca-113">This gives the flexibility to users to control their application and environment while taking VM backup.</span></span>

<span data-ttu-id="8ccca-114">An important scenario for this framework is to ensure application consistent VM backup.</span><span class="sxs-lookup"><span data-stu-id="8ccca-114">An important scenario for this framework is to ensure application consistent VM backup.</span></span> <span data-ttu-id="8ccca-115">The pre-script can invoke application native APIs to quiesce the IOs and flush in memory content to the disk, this will ensure that the snapshot is application consistent i.e. application will come up when the VM is booted post restore.</span><span class="sxs-lookup"><span data-stu-id="8ccca-115">The pre-script can invoke application native APIs to quiesce the IOs and flush in memory content to the disk, this will ensure that the snapshot is application consistent i.e. application will come up when the VM is booted post restore.</span></span> <span data-ttu-id="8ccca-116">Post-script can be used to thaw the IOs using application native APIs so the application can resume normal operations post VM snapshot.</span><span class="sxs-lookup"><span data-stu-id="8ccca-116">Post-script can be used to thaw the IOs using application native APIs so the application can resume normal operations post VM snapshot.</span></span>

## <a name="steps-to-configure-pre-script-and-post-script"></a><span data-ttu-id="8ccca-117">Steps to configure pre-script and post-script</span><span class="sxs-lookup"><span data-stu-id="8ccca-117">Steps to configure pre-script and post-script</span></span>

1. <span data-ttu-id="8ccca-118">Log in to the Linux VM to be backed up as the root user.</span><span class="sxs-lookup"><span data-stu-id="8ccca-118">Log in to the Linux VM to be backed up as the root user.</span></span>

2. <span data-ttu-id="8ccca-119">Download VMSnapshotPluginConfig.json from [github](https://github.com/MicrosoftAzureBackup/VMSnapshotPluginConfig) and copy it to /etc/azure folder on all the VMs to be backed up.</span><span class="sxs-lookup"><span data-stu-id="8ccca-119">Download VMSnapshotPluginConfig.json from [github](https://github.com/MicrosoftAzureBackup/VMSnapshotPluginConfig) and copy it to /etc/azure folder on all the VMs to be backed up.</span></span> <span data-ttu-id="8ccca-120">Create the /etc/azure directory if it does not exist already.</span><span class="sxs-lookup"><span data-stu-id="8ccca-120">Create the /etc/azure directory if it does not exist already.</span></span>

3. <span data-ttu-id="8ccca-121">Copy the pre-script and post-script for your application on all the VMs to be backed up.</span><span class="sxs-lookup"><span data-stu-id="8ccca-121">Copy the pre-script and post-script for your application on all the VMs to be backed up.</span></span> <span data-ttu-id="8ccca-122">You can copy the scripts to any location with-in the VM, you need to update the full path of the script files in VMSnapshotPluginConfig.json file</span><span class="sxs-lookup"><span data-stu-id="8ccca-122">You can copy the scripts to any location with-in the VM, you need to update the full path of the script files in VMSnapshotPluginConfig.json file</span></span>

4. <span data-ttu-id="8ccca-123">Ensure following permissions for the files:</span><span class="sxs-lookup"><span data-stu-id="8ccca-123">Ensure following permissions for the files:</span></span>

   - <span data-ttu-id="8ccca-124">VMSnapshotPluginConfig.json- Permission “600” i.e. only “root” user should have “read” and “write” permissions to this file, no user should have “execute” permissions.</span><span class="sxs-lookup"><span data-stu-id="8ccca-124">VMSnapshotPluginConfig.json- Permission “600” i.e. only “root” user should have “read” and “write” permissions to this file, no user should have “execute” permissions.</span></span>
   - <span data-ttu-id="8ccca-125">Pre-script file- Permission “700” i.e. only “root” user should have “read”, “write”, and “execute” permissions to this file.</span><span class="sxs-lookup"><span data-stu-id="8ccca-125">Pre-script file- Permission “700” i.e. only “root” user should have “read”, “write”, and “execute” permissions to this file.</span></span>
   - <span data-ttu-id="8ccca-126">Post-script- Permission “700” i.e. only “root” user should have “read”, “write”, and “execute” permissions to this file.</span><span class="sxs-lookup"><span data-stu-id="8ccca-126">Post-script- Permission “700” i.e. only “root” user should have “read”, “write”, and “execute” permissions to this file.</span></span>

   > [!Note]
   > <span data-ttu-id="8ccca-127">The framework provides a lot of power to the users, so it’s very important it is completely secure and only “root” user should have access to critical json and script files.</span><span class="sxs-lookup"><span data-stu-id="8ccca-127">The framework provides a lot of power to the users, so it’s very important it is completely secure and only “root” user should have access to critical json and script files.</span></span>
   > <span data-ttu-id="8ccca-128">If in case the above requirements are not met, script will not be executed, resulting in file system/crash consistent backup.</span><span class="sxs-lookup"><span data-stu-id="8ccca-128">If in case the above requirements are not met, script will not be executed, resulting in file system/crash consistent backup.</span></span>
   >

5. <span data-ttu-id="8ccca-129">Configure VMSnapshotPluginConfig.json as per below details</span><span class="sxs-lookup"><span data-stu-id="8ccca-129">Configure VMSnapshotPluginConfig.json as per below details</span></span>
    - <span data-ttu-id="8ccca-130">**pluginName**- Leave this field as it is otherwise your scripts may not work as expected.</span><span class="sxs-lookup"><span data-stu-id="8ccca-130">**pluginName**- Leave this field as it is otherwise your scripts may not work as expected.</span></span>
    - <span data-ttu-id="8ccca-131">**preScriptLocation**- Provide full path of the pre-script on the VM to be backed up.</span><span class="sxs-lookup"><span data-stu-id="8ccca-131">**preScriptLocation**- Provide full path of the pre-script on the VM to be backed up.</span></span>
    - <span data-ttu-id="8ccca-132">**postScriptLocation**- Provide full path of the post-script on the VM to be backed up.</span><span class="sxs-lookup"><span data-stu-id="8ccca-132">**postScriptLocation**- Provide full path of the post-script on the VM to be backed up.</span></span>
    - <span data-ttu-id="8ccca-133">**preScriptParams**- Any optional parameter that need to be passed to the pre-script, all parameters should be in quotes and comma separated in case of multiple params.</span><span class="sxs-lookup"><span data-stu-id="8ccca-133">**preScriptParams**- Any optional parameter that need to be passed to the pre-script, all parameters should be in quotes and comma separated in case of multiple params.</span></span>
    - <span data-ttu-id="8ccca-134">**postScriptParams**- Any optional parameter that need to be passed to the post-script, all parameters should be in quotes and comma separated in case of multiple params.</span><span class="sxs-lookup"><span data-stu-id="8ccca-134">**postScriptParams**- Any optional parameter that need to be passed to the post-script, all parameters should be in quotes and comma separated in case of multiple params.</span></span>
    - <span data-ttu-id="8ccca-135">**preScriptNoOfRetries**- Number of times the pre-script should be re-tried in case of any error before terminating.</span><span class="sxs-lookup"><span data-stu-id="8ccca-135">**preScriptNoOfRetries**- Number of times the pre-script should be re-tried in case of any error before terminating.</span></span> <span data-ttu-id="8ccca-136">0 means only one try and no retry in case of failure.</span><span class="sxs-lookup"><span data-stu-id="8ccca-136">0 means only one try and no retry in case of failure.</span></span>
    - <span data-ttu-id="8ccca-137">**postScriptNoOfRetries**- Number of times the post-script should be re-tried in case of any error before terminating.</span><span class="sxs-lookup"><span data-stu-id="8ccca-137">**postScriptNoOfRetries**- Number of times the post-script should be re-tried in case of any error before terminating.</span></span> <span data-ttu-id="8ccca-138">0 means only one try and no retry in case of failure.</span><span class="sxs-lookup"><span data-stu-id="8ccca-138">0 means only one try and no retry in case of failure.</span></span>
    - <span data-ttu-id="8ccca-139">**timeoutInSeconds**- Individual timeouts for the pre-script and the post-script.</span><span class="sxs-lookup"><span data-stu-id="8ccca-139">**timeoutInSeconds**- Individual timeouts for the pre-script and the post-script.</span></span>
    - <span data-ttu-id="8ccca-140">**continueBackupOnFailure**- Set this value to true if you want Azure Backup to fall back to a file system consistent/crash consistent backup in case pre-script or post-script fails.</span><span class="sxs-lookup"><span data-stu-id="8ccca-140">**continueBackupOnFailure**- Set this value to true if you want Azure Backup to fall back to a file system consistent/crash consistent backup in case pre-script or post-script fails.</span></span> <span data-ttu-id="8ccca-141">Setting this to false will fail the backup in case of script failure (except in case of single disk VM where it will fall back to crash consistent backup irrespective of this setting).</span><span class="sxs-lookup"><span data-stu-id="8ccca-141">Setting this to false will fail the backup in case of script failure (except in case of single disk VM where it will fall back to crash consistent backup irrespective of this setting).</span></span>
    - <span data-ttu-id="8ccca-142">**fsFreezeEnabled**- This specifies if Linux fsfreeze should be called while taking VM snapshot to ensure file system consistency.</span><span class="sxs-lookup"><span data-stu-id="8ccca-142">**fsFreezeEnabled**- This specifies if Linux fsfreeze should be called while taking VM snapshot to ensure file system consistency.</span></span> <span data-ttu-id="8ccca-143">We recommend keeping this as true unless your application has dependency on disabling fsfreeze.</span><span class="sxs-lookup"><span data-stu-id="8ccca-143">We recommend keeping this as true unless your application has dependency on disabling fsfreeze.</span></span>

6. <span data-ttu-id="8ccca-144">The script framework is now configured, if the VM backup is already configured next backup will invoke the scripts and trigger application consistent backup.</span><span class="sxs-lookup"><span data-stu-id="8ccca-144">The script framework is now configured, if the VM backup is already configured next backup will invoke the scripts and trigger application consistent backup.</span></span> <span data-ttu-id="8ccca-145">If the VM backup is not configured, please configure using [Back up Azure virtual machines to Recovery Services vaults.](https://docs.microsoft.com/azure/backup/backup-azure-vms-first-look-arm)</span><span class="sxs-lookup"><span data-stu-id="8ccca-145">If the VM backup is not configured, please configure using [Back up Azure virtual machines to Recovery Services vaults.](https://docs.microsoft.com/azure/backup/backup-azure-vms-first-look-arm)</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="8ccca-146">Troubleshooting</span><span class="sxs-lookup"><span data-stu-id="8ccca-146">Troubleshooting</span></span>

<span data-ttu-id="8ccca-147">Please make sure you add appropriate logging while writing your pre-script and post-script and review your script logs to fix any script issues.</span><span class="sxs-lookup"><span data-stu-id="8ccca-147">Please make sure you add appropriate logging while writing your pre-script and post-script and review your script logs to fix any script issues.</span></span> <span data-ttu-id="8ccca-148">If you still have problems executing scripts refer to following table for more information.</span><span class="sxs-lookup"><span data-stu-id="8ccca-148">If you still have problems executing scripts refer to following table for more information.</span></span>

| <span data-ttu-id="8ccca-149">Error</span><span class="sxs-lookup"><span data-stu-id="8ccca-149">Error</span></span> | <span data-ttu-id="8ccca-150">Error message</span><span class="sxs-lookup"><span data-stu-id="8ccca-150">Error message</span></span> | <span data-ttu-id="8ccca-151">Recommended action</span><span class="sxs-lookup"><span data-stu-id="8ccca-151">Recommended action</span></span> |
| ------------------------ | -------------- | ------------------ |
| <span data-ttu-id="8ccca-152">Pre-ScriptExecutionFailed</span><span class="sxs-lookup"><span data-stu-id="8ccca-152">Pre-ScriptExecutionFailed</span></span> |<span data-ttu-id="8ccca-153">Pre-Script returned an error so backup may not be application consistent.</span><span class="sxs-lookup"><span data-stu-id="8ccca-153">Pre-Script returned an error so backup may not be application consistent.</span></span>  | <span data-ttu-id="8ccca-154">Please look at the failure logs for your script to rectify the issue.</span><span class="sxs-lookup"><span data-stu-id="8ccca-154">Please look at the failure logs for your script to rectify the issue.</span></span>|  
|   <span data-ttu-id="8ccca-155">Post-ScriptExecutionFailed</span><span class="sxs-lookup"><span data-stu-id="8ccca-155">Post-ScriptExecutionFailed</span></span> |    <span data-ttu-id="8ccca-156">Post-Script returned an error which might impact application state.</span><span class="sxs-lookup"><span data-stu-id="8ccca-156">Post-Script returned an error which might impact application state.</span></span> |   <span data-ttu-id="8ccca-157">Please look at the failure logs for your script to rectify the issue and check the application state.</span><span class="sxs-lookup"><span data-stu-id="8ccca-157">Please look at the failure logs for your script to rectify the issue and check the application state.</span></span> |
| <span data-ttu-id="8ccca-158">Pre-ScriptNotFound</span><span class="sxs-lookup"><span data-stu-id="8ccca-158">Pre-ScriptNotFound</span></span> |  <span data-ttu-id="8ccca-159">Pre-Script was not found at the location specified in the VMSnapshotPluginConfig.json config file.</span><span class="sxs-lookup"><span data-stu-id="8ccca-159">Pre-Script was not found at the location specified in the VMSnapshotPluginConfig.json config file.</span></span> |    <span data-ttu-id="8ccca-160">Please make sure that Pre-Script is present at the path specified in the config file to ensure application consistent backup.</span><span class="sxs-lookup"><span data-stu-id="8ccca-160">Please make sure that Pre-Script is present at the path specified in the config file to ensure application consistent backup.</span></span>|
| <span data-ttu-id="8ccca-161">Post-ScriptNotFound</span><span class="sxs-lookup"><span data-stu-id="8ccca-161">Post-ScriptNotFound</span></span> | <span data-ttu-id="8ccca-162">Post-Script was not found at the location specified in VMSnapshotPluginConfig.json config file</span><span class="sxs-lookup"><span data-stu-id="8ccca-162">Post-Script was not found at the location specified in VMSnapshotPluginConfig.json config file</span></span> |    <span data-ttu-id="8ccca-163">Please make sure that Post-Script is present at the path specified in the config file to ensure application consistent backup.</span><span class="sxs-lookup"><span data-stu-id="8ccca-163">Please make sure that Post-Script is present at the path specified in the config file to ensure application consistent backup.</span></span>|
| <span data-ttu-id="8ccca-164">IncorrectPluginhostFile</span><span class="sxs-lookup"><span data-stu-id="8ccca-164">IncorrectPluginhostFile</span></span> | <span data-ttu-id="8ccca-165">Pluginhost file which comes with the VmSnapshotLinux extension is corrupted so pre-script and post-script cannot be executed and the backup will not be application consistent.</span><span class="sxs-lookup"><span data-stu-id="8ccca-165">Pluginhost file which comes with the VmSnapshotLinux extension is corrupted so pre-script and post-script cannot be executed and the backup will not be application consistent.</span></span> | <span data-ttu-id="8ccca-166">Please un-install the VmSnapshotLinux extension, it will automatically be re-installed with next backup to fix the problem.</span><span class="sxs-lookup"><span data-stu-id="8ccca-166">Please un-install the VmSnapshotLinux extension, it will automatically be re-installed with next backup to fix the problem.</span></span> |
| <span data-ttu-id="8ccca-167">IncorrectJSONConfigFile</span><span class="sxs-lookup"><span data-stu-id="8ccca-167">IncorrectJSONConfigFile</span></span> | <span data-ttu-id="8ccca-168">VMSnapshotPluginConfig.json file is incorrect, so pre-script and post-script cannot be executed and the backup will not be application consistent</span><span class="sxs-lookup"><span data-stu-id="8ccca-168">VMSnapshotPluginConfig.json file is incorrect, so pre-script and post-script cannot be executed and the backup will not be application consistent</span></span> | <span data-ttu-id="8ccca-169">Please download the copy from [github](https://github.com/MicrosoftAzureBackup/VMSnapshotPluginConfig) and configure it again</span><span class="sxs-lookup"><span data-stu-id="8ccca-169">Please download the copy from [github](https://github.com/MicrosoftAzureBackup/VMSnapshotPluginConfig) and configure it again</span></span> |
| <span data-ttu-id="8ccca-170">InsufficientPermissionforPre-Script</span><span class="sxs-lookup"><span data-stu-id="8ccca-170">InsufficientPermissionforPre-Script</span></span> | <span data-ttu-id="8ccca-171">For executing scripts, root user should be the owner of the file and file should have “700” permissions i.e. only owner should have “read”, “write”, and “execute” permissions</span><span class="sxs-lookup"><span data-stu-id="8ccca-171">For executing scripts, root user should be the owner of the file and file should have “700” permissions i.e. only owner should have “read”, “write”, and “execute” permissions</span></span> | <span data-ttu-id="8ccca-172">Make sure “root” user is the “owner” of the script file and only owner have “read”, “write” and “execute” permissions.</span><span class="sxs-lookup"><span data-stu-id="8ccca-172">Make sure “root” user is the “owner” of the script file and only owner have “read”, “write” and “execute” permissions.</span></span> |
| <span data-ttu-id="8ccca-173">InsufficientPermissionforPost-Script</span><span class="sxs-lookup"><span data-stu-id="8ccca-173">InsufficientPermissionforPost-Script</span></span> | <span data-ttu-id="8ccca-174">For executing scripts, root user should be the owner of the file and file should have “700” permissions i.e. only owner should have “read”, “write”, and “execute” permissions</span><span class="sxs-lookup"><span data-stu-id="8ccca-174">For executing scripts, root user should be the owner of the file and file should have “700” permissions i.e. only owner should have “read”, “write”, and “execute” permissions</span></span> | <span data-ttu-id="8ccca-175">Make sure “root” user is the “owner” of the script file and only owner have “read”, “write” and “execute” permissions.</span><span class="sxs-lookup"><span data-stu-id="8ccca-175">Make sure “root” user is the “owner” of the script file and only owner have “read”, “write” and “execute” permissions.</span></span> |
| <span data-ttu-id="8ccca-176">Pre-ScriptTimeout</span><span class="sxs-lookup"><span data-stu-id="8ccca-176">Pre-ScriptTimeout</span></span> | <span data-ttu-id="8ccca-177">Execution of Application Consistent Backup Pre-Script timed-out.</span><span class="sxs-lookup"><span data-stu-id="8ccca-177">Execution of Application Consistent Backup Pre-Script timed-out.</span></span> | <span data-ttu-id="8ccca-178">Please check the script and increase the timeout in the VMSnapshotPluginConfig.json file located at /etc/azure.</span><span class="sxs-lookup"><span data-stu-id="8ccca-178">Please check the script and increase the timeout in the VMSnapshotPluginConfig.json file located at /etc/azure.</span></span> |
| <span data-ttu-id="8ccca-179">Post-ScriptTimeout</span><span class="sxs-lookup"><span data-stu-id="8ccca-179">Post-ScriptTimeout</span></span> | <span data-ttu-id="8ccca-180">Execution of Application Consistent Backup Post-Script timed-out.</span><span class="sxs-lookup"><span data-stu-id="8ccca-180">Execution of Application Consistent Backup Post-Script timed-out.</span></span> | <span data-ttu-id="8ccca-181">Please check the script and increase the timeout in the VMSnapshotPluginConfig.json file located at /etc/azure.</span><span class="sxs-lookup"><span data-stu-id="8ccca-181">Please check the script and increase the timeout in the VMSnapshotPluginConfig.json file located at /etc/azure.</span></span> |

## <a name="next-steps"></a><span data-ttu-id="8ccca-182">Next Steps</span><span class="sxs-lookup"><span data-stu-id="8ccca-182">Next Steps</span></span>
[<span data-ttu-id="8ccca-183">Configure VM backup to a Recovery Services Vault</span><span class="sxs-lookup"><span data-stu-id="8ccca-183">Configure VM backup to a Recovery Services Vault</span></span>](https://docs.microsoft.com/azure/backup/backup-azure-arm-vms)
