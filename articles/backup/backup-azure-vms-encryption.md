---
title: Backup and restore encrypted VMs using Azure Backup
description: This article talks about the backup and restore experience for VMs encrypted using Azure Disk Encryption.
services: backup
documentationcenter: ''
author: JPallavi
manager: vijayts
editor: ''
ms.assetid: 8387f186-7d7b-400a-8fc3-88a85403ea63
ms.service: backup
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 01/18/2017
ms.author: pajosh;markgal;trinadhk
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 4e35d296805f0c44484e8d05a271e42a21cc1531
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44552854"
---
# <a name="how-to-back-up-and-restore-encrypted-virtual-machines-with-azure-backup"></a><span data-ttu-id="ee20e-103">How to back up and restore encrypted virtual machines with Azure Backup</span><span class="sxs-lookup"><span data-stu-id="ee20e-103">How to back up and restore encrypted virtual machines with Azure Backup</span></span>
<span data-ttu-id="ee20e-104">This article talks about steps to backup and restore virtual machines using Azure Backup.</span><span class="sxs-lookup"><span data-stu-id="ee20e-104">This article talks about steps to backup and restore virtual machines using Azure Backup.</span></span> <span data-ttu-id="ee20e-105">It also provides details about supported scenarios, pre-requisites, and troubleshooting steps for error cases.</span><span class="sxs-lookup"><span data-stu-id="ee20e-105">It also provides details about supported scenarios, pre-requisites, and troubleshooting steps for error cases.</span></span>

## <a name="supported-scenarios"></a><span data-ttu-id="ee20e-106">Supported Scenarios</span><span class="sxs-lookup"><span data-stu-id="ee20e-106">Supported Scenarios</span></span>
> [!NOTE]
> 1. <span data-ttu-id="ee20e-107">Backup and restore of encrypted VMs is supported only for Resource Manager deployed virtual machines.</span><span class="sxs-lookup"><span data-stu-id="ee20e-107">Backup and restore of encrypted VMs is supported only for Resource Manager deployed virtual machines.</span></span> <span data-ttu-id="ee20e-108">It is not supported for Classic virtual machines.</span><span class="sxs-lookup"><span data-stu-id="ee20e-108">It is not supported for Classic virtual machines.</span></span> <br>
> 2. <span data-ttu-id="ee20e-109">It is supported for both Windows and Linux virtual machines using Azure Disk Encryption, which leverages the industry standard BitLocker feature of Windows and DM-Crypt feature of Linux to provide encryption of disks.</span><span class="sxs-lookup"><span data-stu-id="ee20e-109">It is supported for both Windows and Linux virtual machines using Azure Disk Encryption, which leverages the industry standard BitLocker feature of Windows and DM-Crypt feature of Linux to provide encryption of disks.</span></span> <br>
> 3. <span data-ttu-id="ee20e-110">It is supported only for virtual machines encrypted using BitLocker Encryption Key and Key Encryption Key both.</span><span class="sxs-lookup"><span data-stu-id="ee20e-110">It is supported only for virtual machines encrypted using BitLocker Encryption Key and Key Encryption Key both.</span></span> <span data-ttu-id="ee20e-111">It is not supported for virtual machines encrypted using BitLocker Encryption Key only.</span><span class="sxs-lookup"><span data-stu-id="ee20e-111">It is not supported for virtual machines encrypted using BitLocker Encryption Key only.</span></span> <br>
>
>

## <a name="pre-requisites"></a><span data-ttu-id="ee20e-112">Pre-requisites</span><span class="sxs-lookup"><span data-stu-id="ee20e-112">Pre-requisites</span></span>
1. <span data-ttu-id="ee20e-113">Virtual machine has been encrypted using [Azure Disk Encryption](../security/azure-security-disk-encryption.md).</span><span class="sxs-lookup"><span data-stu-id="ee20e-113">Virtual machine has been encrypted using [Azure Disk Encryption](../security/azure-security-disk-encryption.md).</span></span> <span data-ttu-id="ee20e-114">It should be encrypted using BitLocker Encryption Key and Key Encryption Key both.</span><span class="sxs-lookup"><span data-stu-id="ee20e-114">It should be encrypted using BitLocker Encryption Key and Key Encryption Key both.</span></span>
2. <span data-ttu-id="ee20e-115">Recovery services vault has been created and storage replication set using steps mentioned in the article [Prepare your environment for backup](backup-azure-arm-vms-prepare.md).</span><span class="sxs-lookup"><span data-stu-id="ee20e-115">Recovery services vault has been created and storage replication set using steps mentioned in the article [Prepare your environment for backup](backup-azure-arm-vms-prepare.md).</span></span>

## <a name="backup-encrypted-vm"></a><span data-ttu-id="ee20e-116">Backup encrypted VM</span><span class="sxs-lookup"><span data-stu-id="ee20e-116">Backup encrypted VM</span></span>
<span data-ttu-id="ee20e-117">Use the following steps to set backup goal, define policy, configure items and trigger backup.</span><span class="sxs-lookup"><span data-stu-id="ee20e-117">Use the following steps to set backup goal, define policy, configure items and trigger backup.</span></span>

### <a name="configure-backup"></a><span data-ttu-id="ee20e-118">Configure backup</span><span class="sxs-lookup"><span data-stu-id="ee20e-118">Configure backup</span></span>
1. <span data-ttu-id="ee20e-119">If you already have a Recovery Services vault open, proceed to next step.</span><span class="sxs-lookup"><span data-stu-id="ee20e-119">If you already have a Recovery Services vault open, proceed to next step.</span></span> <span data-ttu-id="ee20e-120">If you do not have a Recovery Services vault open, but are in the Azure portal, on the Hub menu, click **Browse**.</span><span class="sxs-lookup"><span data-stu-id="ee20e-120">If you do not have a Recovery Services vault open, but are in the Azure portal, on the Hub menu, click **Browse**.</span></span>

   * <span data-ttu-id="ee20e-121">In the list of resources, type **Recovery Services**.</span><span class="sxs-lookup"><span data-stu-id="ee20e-121">In the list of resources, type **Recovery Services**.</span></span>
   * <span data-ttu-id="ee20e-122">As you begin typing, the list filters based on your input.</span><span class="sxs-lookup"><span data-stu-id="ee20e-122">As you begin typing, the list filters based on your input.</span></span> <span data-ttu-id="ee20e-123">When you see **Recovery Services vaults**, click it.</span><span class="sxs-lookup"><span data-stu-id="ee20e-123">When you see **Recovery Services vaults**, click it.</span></span>

      ![Create Recovery Services Vault step 1](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-vms-encryption/browse-to-rs-vaults.png) <br/>

     <span data-ttu-id="ee20e-125">The list of Recovery Services vaults appears.</span><span class="sxs-lookup"><span data-stu-id="ee20e-125">The list of Recovery Services vaults appears.</span></span> <span data-ttu-id="ee20e-126">From the list of Recovery Services vaults, select a vault.</span><span class="sxs-lookup"><span data-stu-id="ee20e-126">From the list of Recovery Services vaults, select a vault.</span></span>

     <span data-ttu-id="ee20e-127">The selected vault dashboard opens.</span><span class="sxs-lookup"><span data-stu-id="ee20e-127">The selected vault dashboard opens.</span></span>
2. <span data-ttu-id="ee20e-128">From the list of items that appears under vault, click **Backup** to open the Backup blade.</span><span class="sxs-lookup"><span data-stu-id="ee20e-128">From the list of items that appears under vault, click **Backup** to open the Backup blade.</span></span>

      ![Open Backup blade](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-vms-encryption/select-backup.png)
3. <span data-ttu-id="ee20e-130">On the Backup blade, click **Backup goal** to open the Backup Goal blade.</span><span class="sxs-lookup"><span data-stu-id="ee20e-130">On the Backup blade, click **Backup goal** to open the Backup Goal blade.</span></span>

      ![Open Scenario blade](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-vms-encryption/select-backup-goal-one.png)
4. <span data-ttu-id="ee20e-132">On the Backup Goal blade, set **Where is your workload running** to Azure and **What do you want to backup** to Virtual machine, then click **OK**.</span><span class="sxs-lookup"><span data-stu-id="ee20e-132">On the Backup Goal blade, set **Where is your workload running** to Azure and **What do you want to backup** to Virtual machine, then click **OK**.</span></span>

   <span data-ttu-id="ee20e-133">The Backup Goal blade closes and the Backup policy blade opens.</span><span class="sxs-lookup"><span data-stu-id="ee20e-133">The Backup Goal blade closes and the Backup policy blade opens.</span></span>

   ![Open Scenario blade](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-vms-encryption/select-backup-goal-two.png)
5. <span data-ttu-id="ee20e-135">On the Backup policy blade, select the backup policy you want to apply to the vault and click **OK**.</span><span class="sxs-lookup"><span data-stu-id="ee20e-135">On the Backup policy blade, select the backup policy you want to apply to the vault and click **OK**.</span></span>

      ![Select backup policy](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-vms-encryption/setting-rs-backup-policy-new.png)

    <span data-ttu-id="ee20e-137">The details of the default policy are listed in the details.</span><span class="sxs-lookup"><span data-stu-id="ee20e-137">The details of the default policy are listed in the details.</span></span> <span data-ttu-id="ee20e-138">If you want to create a policy, select **Create New** from the drop-down menu.</span><span class="sxs-lookup"><span data-stu-id="ee20e-138">If you want to create a policy, select **Create New** from the drop-down menu.</span></span> <span data-ttu-id="ee20e-139">Once you click **OK**, the backup policy is associated with the vault.</span><span class="sxs-lookup"><span data-stu-id="ee20e-139">Once you click **OK**, the backup policy is associated with the vault.</span></span>

    <span data-ttu-id="ee20e-140">Next choose the VMs to associate with the vault.</span><span class="sxs-lookup"><span data-stu-id="ee20e-140">Next choose the VMs to associate with the vault.</span></span>
6. <span data-ttu-id="ee20e-141">Choose the encrypted virtual machines to associate with the specified policy and click **OK**.</span><span class="sxs-lookup"><span data-stu-id="ee20e-141">Choose the encrypted virtual machines to associate with the specified policy and click **OK**.</span></span>

      ![Select encrypted VMs](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-vms-encryption/selected-encrypted-vms.png)
7. <span data-ttu-id="ee20e-143">This page shows a message about key vault associated to the encrypted VMs selected.</span><span class="sxs-lookup"><span data-stu-id="ee20e-143">This page shows a message about key vault associated to the encrypted VMs selected.</span></span> <span data-ttu-id="ee20e-144">Backup service requires read-only access to the keys and secrets in the key vault.</span><span class="sxs-lookup"><span data-stu-id="ee20e-144">Backup service requires read-only access to the keys and secrets in the key vault.</span></span> <span data-ttu-id="ee20e-145">It uses these permissions to backup key and secret, along with the associated VMs.</span><span class="sxs-lookup"><span data-stu-id="ee20e-145">It uses these permissions to backup key and secret, along with the associated VMs.</span></span>

      ![Encrypted VMs message](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-vms-encryption/encrypted-vm-message.png)

      <span data-ttu-id="ee20e-147">Now that you have defined all settings for the vault, in the Backup blade click Enable Backup at the bottom of the page.</span><span class="sxs-lookup"><span data-stu-id="ee20e-147">Now that you have defined all settings for the vault, in the Backup blade click Enable Backup at the bottom of the page.</span></span> <span data-ttu-id="ee20e-148">Enable  Backup deploys the policy to the vault and the VMs.</span><span class="sxs-lookup"><span data-stu-id="ee20e-148">Enable  Backup deploys the policy to the vault and the VMs.</span></span>
8. <span data-ttu-id="ee20e-149">The next phase in preparation is installing the VM Agent or making sure the VM Agent is installed.</span><span class="sxs-lookup"><span data-stu-id="ee20e-149">The next phase in preparation is installing the VM Agent or making sure the VM Agent is installed.</span></span> <span data-ttu-id="ee20e-150">To do the same, use the steps mentioned in the article [Prepare your environment for backup](backup-azure-arm-vms-prepare.md).</span><span class="sxs-lookup"><span data-stu-id="ee20e-150">To do the same, use the steps mentioned in the article [Prepare your environment for backup](backup-azure-arm-vms-prepare.md).</span></span>

### <a name="triggering-backup-job"></a><span data-ttu-id="ee20e-151">Triggering backup job</span><span class="sxs-lookup"><span data-stu-id="ee20e-151">Triggering backup job</span></span>
<span data-ttu-id="ee20e-152">Use the steps mentioned in the article [Backup Azure VMs to recovery services vault](backup-azure-arm-vms.md) to trigger backup job.</span><span class="sxs-lookup"><span data-stu-id="ee20e-152">Use the steps mentioned in the article [Backup Azure VMs to recovery services vault](backup-azure-arm-vms.md) to trigger backup job.</span></span>

## <a name="restore-encrypted-vm"></a><span data-ttu-id="ee20e-153">Restore encrypted VM</span><span class="sxs-lookup"><span data-stu-id="ee20e-153">Restore encrypted VM</span></span>
<span data-ttu-id="ee20e-154">To restore encrypted VM, first Restore Disks using steps mentioned in section **Restore backed up disks** in [Choosing VM restore configuration](backup-azure-arm-restore-vms.md#choosing-a-vm-restore-configuration).</span><span class="sxs-lookup"><span data-stu-id="ee20e-154">To restore encrypted VM, first Restore Disks using steps mentioned in section **Restore backed up disks** in [Choosing VM restore configuration](backup-azure-arm-restore-vms.md#choosing-a-vm-restore-configuration).</span></span> <span data-ttu-id="ee20e-155">After that, use the PowerShell steps mentioned in [Create a VM from restored disks](backup-azure-vms-automation.md#create-a-vm-from-restored-disks) to create full VM from restored disks.</span><span class="sxs-lookup"><span data-stu-id="ee20e-155">After that, use the PowerShell steps mentioned in [Create a VM from restored disks](backup-azure-vms-automation.md#create-a-vm-from-restored-disks) to create full VM from restored disks.</span></span>

## <a name="troubleshooting-errors"></a><span data-ttu-id="ee20e-156">Troubleshooting errors</span><span class="sxs-lookup"><span data-stu-id="ee20e-156">Troubleshooting errors</span></span>
| <span data-ttu-id="ee20e-157">Operation</span><span class="sxs-lookup"><span data-stu-id="ee20e-157">Operation</span></span> | <span data-ttu-id="ee20e-158">Error details</span><span class="sxs-lookup"><span data-stu-id="ee20e-158">Error details</span></span> | <span data-ttu-id="ee20e-159">Resolution</span><span class="sxs-lookup"><span data-stu-id="ee20e-159">Resolution</span></span> |
| --- | --- | --- |
| <span data-ttu-id="ee20e-160">Backup</span><span class="sxs-lookup"><span data-stu-id="ee20e-160">Backup</span></span> |<span data-ttu-id="ee20e-161">Validation failed as virtual machine is encrypted with BEK alone.</span><span class="sxs-lookup"><span data-stu-id="ee20e-161">Validation failed as virtual machine is encrypted with BEK alone.</span></span> <span data-ttu-id="ee20e-162">Backups can be enabled only for virtual machines encrypted with both BEK and KEK.</span><span class="sxs-lookup"><span data-stu-id="ee20e-162">Backups can be enabled only for virtual machines encrypted with both BEK and KEK.</span></span> |<span data-ttu-id="ee20e-163">Virtual machine should be encrypted using BEK and KEK.</span><span class="sxs-lookup"><span data-stu-id="ee20e-163">Virtual machine should be encrypted using BEK and KEK.</span></span> <span data-ttu-id="ee20e-164">First decrypt the VM and encrypt it using both BEK and KEK.</span><span class="sxs-lookup"><span data-stu-id="ee20e-164">First decrypt the VM and encrypt it using both BEK and KEK.</span></span> <span data-ttu-id="ee20e-165">Enable backup once VM is encrypted using both BEK and KEK.</span><span class="sxs-lookup"><span data-stu-id="ee20e-165">Enable backup once VM is encrypted using both BEK and KEK.</span></span> <span data-ttu-id="ee20e-166">Learn more on how you can [decrypt and encrypt the VM](../security/azure-security-disk-encryption.md)</span><span class="sxs-lookup"><span data-stu-id="ee20e-166">Learn more on how you can [decrypt and encrypt the VM](../security/azure-security-disk-encryption.md)</span></span>  |
| <span data-ttu-id="ee20e-167">Restore</span><span class="sxs-lookup"><span data-stu-id="ee20e-167">Restore</span></span> |<span data-ttu-id="ee20e-168">You cannot restore this encrypted VM since key vault associated with this VM does not exist.</span><span class="sxs-lookup"><span data-stu-id="ee20e-168">You cannot restore this encrypted VM since key vault associated with this VM does not exist.</span></span> |<span data-ttu-id="ee20e-169">Create key vault using [Get Started with Azure Key Vault](../key-vault/key-vault-get-started.md).</span><span class="sxs-lookup"><span data-stu-id="ee20e-169">Create key vault using [Get Started with Azure Key Vault](../key-vault/key-vault-get-started.md).</span></span> <span data-ttu-id="ee20e-170">Refer the article [Restore key vault key and secret using Azure Backup](backup-azure-restore-key-secret.md) to restore key and secret if they are not present.</span><span class="sxs-lookup"><span data-stu-id="ee20e-170">Refer the article [Restore key vault key and secret using Azure Backup](backup-azure-restore-key-secret.md) to restore key and secret if they are not present.</span></span> |
| <span data-ttu-id="ee20e-171">Restore</span><span class="sxs-lookup"><span data-stu-id="ee20e-171">Restore</span></span> |<span data-ttu-id="ee20e-172">You cannot restore this encrypted VM since key and secret associated with this VM do not exist.</span><span class="sxs-lookup"><span data-stu-id="ee20e-172">You cannot restore this encrypted VM since key and secret associated with this VM do not exist.</span></span> |<span data-ttu-id="ee20e-173">Refer the article [Restore key vault key and secret using Azure Backup](backup-azure-restore-key-secret.md) to restore key and secret if they are not present.</span><span class="sxs-lookup"><span data-stu-id="ee20e-173">Refer the article [Restore key vault key and secret using Azure Backup](backup-azure-restore-key-secret.md) to restore key and secret if they are not present.</span></span> |
| <span data-ttu-id="ee20e-174">Restore</span><span class="sxs-lookup"><span data-stu-id="ee20e-174">Restore</span></span> |<span data-ttu-id="ee20e-175">Backup Service does not have authorization to access resources in your subscription.</span><span class="sxs-lookup"><span data-stu-id="ee20e-175">Backup Service does not have authorization to access resources in your subscription.</span></span> |<span data-ttu-id="ee20e-176">As mentioned above, Restore Disks first, using steps mentioned in section **Restore backed up disks** in [Choosing VM restore configuration](backup-azure-arm-restore-vms.md#choosing-a-vm-restore-configuration).</span><span class="sxs-lookup"><span data-stu-id="ee20e-176">As mentioned above, Restore Disks first, using steps mentioned in section **Restore backed up disks** in [Choosing VM restore configuration](backup-azure-arm-restore-vms.md#choosing-a-vm-restore-configuration).</span></span> <span data-ttu-id="ee20e-177">After that, user PowerShell to [Create a VM from restored disks](backup-azure-vms-automation.md#create-a-vm-from-restored-disks).</span><span class="sxs-lookup"><span data-stu-id="ee20e-177">After that, user PowerShell to [Create a VM from restored disks](backup-azure-vms-automation.md#create-a-vm-from-restored-disks).</span></span>







