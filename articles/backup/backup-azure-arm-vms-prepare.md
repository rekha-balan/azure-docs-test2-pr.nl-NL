---
title: 'Azure Backup: Prepare to back up virtual machines | Microsoft Docs'
description: Make sure your environment is prepared for backing up virtual machines in Azure.
services: backup
documentationcenter: ''
author: markgalioto
manager: carmonm
editor: ''
keywords: backups; backing up;
ms.assetid: e87e8db2-b4d9-40e1-a481-1aa560c03395
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 2/7/2017
ms.author: markgal;trinadhk;
ms.openlocfilehash: cdd7fe02fe385f9fd9b08180ce641b8ab88e9bb5
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44563927"
---
# <a name="prepare-your-environment-to-back-up-resource-manager-deployed-virtual-machines"></a><span data-ttu-id="3223e-104">Prepare your environment to back up Resource Manager-deployed virtual machines</span><span class="sxs-lookup"><span data-stu-id="3223e-104">Prepare your environment to back up Resource Manager-deployed virtual machines</span></span>
> [!div class="op_single_selector"]
> * [Resource Manager model](backup-azure-arm-vms-prepare.md)
> * [Classic model](backup-azure-vms-prepare.md)
>
>

<span data-ttu-id="3223e-107">This article provides the steps for preparing your environment to back up a Resource Manager-deployed virtual machine (VM).</span><span class="sxs-lookup"><span data-stu-id="3223e-107">This article provides the steps for preparing your environment to back up a Resource Manager-deployed virtual machine (VM).</span></span> <span data-ttu-id="3223e-108">The steps shown in the procedures use the Azure portal.</span><span class="sxs-lookup"><span data-stu-id="3223e-108">The steps shown in the procedures use the Azure portal.</span></span>  

<span data-ttu-id="3223e-109">The Azure Backup service has two types of vaults (back up vaults and recovery services vaults) for protecting your VMs.</span><span class="sxs-lookup"><span data-stu-id="3223e-109">The Azure Backup service has two types of vaults (back up vaults and recovery services vaults) for protecting your VMs.</span></span> <span data-ttu-id="3223e-110">A backup vault protects VMs deployed using the Classic deployment model.</span><span class="sxs-lookup"><span data-stu-id="3223e-110">A backup vault protects VMs deployed using the Classic deployment model.</span></span> <span data-ttu-id="3223e-111">A recovery services vault protects **both Classic-deployed or Resource Manager-deployed VMs**.</span><span class="sxs-lookup"><span data-stu-id="3223e-111">A recovery services vault protects **both Classic-deployed or Resource Manager-deployed VMs**.</span></span> <span data-ttu-id="3223e-112">You must use a Recovery Services vault to protect a Resource Manager-deployed VM.</span><span class="sxs-lookup"><span data-stu-id="3223e-112">You must use a Recovery Services vault to protect a Resource Manager-deployed VM.</span></span>

> [!NOTE]
> Azure has two deployment models for creating and working with resources: [Resource Manager and Classic](../azure-resource-manager/resource-manager-deployment-model.md). See [Prepare your environment to back up Azure virtual machines](backup-azure-vms-prepare.md) for details on working with Classic deployment model VMs.
>
>

<span data-ttu-id="3223e-115">Before you can protect or back up a Resource Manager-deployed virtual machine (VM), make sure these prerequisites exist:</span><span class="sxs-lookup"><span data-stu-id="3223e-115">Before you can protect or back up a Resource Manager-deployed virtual machine (VM), make sure these prerequisites exist:</span></span>

* <span data-ttu-id="3223e-116">Create a recovery services vault (or identify an existing recovery services vault) *in the same location as your VM*.</span><span class="sxs-lookup"><span data-stu-id="3223e-116">Create a recovery services vault (or identify an existing recovery services vault) *in the same location as your VM*.</span></span>
* <span data-ttu-id="3223e-117">Select a scenario, define the backup policy, and define items to protect.</span><span class="sxs-lookup"><span data-stu-id="3223e-117">Select a scenario, define the backup policy, and define items to protect.</span></span>
* <span data-ttu-id="3223e-118">Check the installation of VM Agent on virtual machine.</span><span class="sxs-lookup"><span data-stu-id="3223e-118">Check the installation of VM Agent on virtual machine.</span></span>
* <span data-ttu-id="3223e-119">Check network connectivity</span><span class="sxs-lookup"><span data-stu-id="3223e-119">Check network connectivity</span></span>
* <span data-ttu-id="3223e-120">For Linux VMs, in case you want to customize your backup environment for application consistent backups please follow the [steps to configure pre-snapshot and post-snapshot scripts](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent)</span><span class="sxs-lookup"><span data-stu-id="3223e-120">For Linux VMs, in case you want to customize your backup environment for application consistent backups please follow the [steps to configure pre-snapshot and post-snapshot scripts](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent)</span></span>

<span data-ttu-id="3223e-121">If you know these conditions already exist in your environment then proceed to the [Back up your VMs article](backup-azure-vms.md).</span><span class="sxs-lookup"><span data-stu-id="3223e-121">If you know these conditions already exist in your environment then proceed to the [Back up your VMs article](backup-azure-vms.md).</span></span> <span data-ttu-id="3223e-122">If you need to set up, or check, any of these prerequisites, this article leads you through the steps to prepare that prerequisite.</span><span class="sxs-lookup"><span data-stu-id="3223e-122">If you need to set up, or check, any of these prerequisites, this article leads you through the steps to prepare that prerequisite.</span></span>

##<a name="supported-operating-system-for-backup"></a><span data-ttu-id="3223e-123">Supported operating system for backup</span><span class="sxs-lookup"><span data-stu-id="3223e-123">Supported operating system for backup</span></span>
 * <span data-ttu-id="3223e-124">**Linux**: Azure Backup supports [a list of distributions that are endorsed by Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) except Core OS Linux.</span><span class="sxs-lookup"><span data-stu-id="3223e-124">**Linux**: Azure Backup supports [a list of distributions that are endorsed by Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) except Core OS Linux.</span></span> <span data-ttu-id="3223e-125">_Other Bring-Your-Own-Linux distributions also might work as long as the VM agent is available on the virtual machine and support for Python exists. However, we do not endorse those distributions for backup._</span><span class="sxs-lookup"><span data-stu-id="3223e-125">_Other Bring-Your-Own-Linux distributions also might work as long as the VM agent is available on the virtual machine and support for Python exists. However, we do not endorse those distributions for backup._</span></span>
 * <span data-ttu-id="3223e-126">**Windows Server**:  Versions older than Windows Server 2008 R2 are not supported.</span><span class="sxs-lookup"><span data-stu-id="3223e-126">**Windows Server**:  Versions older than Windows Server 2008 R2 are not supported.</span></span>

## <a name="limitations-when-backing-up-and-restoring-a-vm"></a><span data-ttu-id="3223e-127">Limitations when backing up and restoring a VM</span><span class="sxs-lookup"><span data-stu-id="3223e-127">Limitations when backing up and restoring a VM</span></span>
<span data-ttu-id="3223e-128">Before you prepare your environment, please understand the limitations.</span><span class="sxs-lookup"><span data-stu-id="3223e-128">Before you prepare your environment, please understand the limitations.</span></span>

* <span data-ttu-id="3223e-129">Backing up virtual machines with more than 16 data disks is not supported.</span><span class="sxs-lookup"><span data-stu-id="3223e-129">Backing up virtual machines with more than 16 data disks is not supported.</span></span>
* <span data-ttu-id="3223e-130">Backing up virtual machines with a reserved IP address and no defined endpoint is not supported.</span><span class="sxs-lookup"><span data-stu-id="3223e-130">Backing up virtual machines with a reserved IP address and no defined endpoint is not supported.</span></span>
* <span data-ttu-id="3223e-131">Backup of VMs encrypted using just BEK is not supported.</span><span class="sxs-lookup"><span data-stu-id="3223e-131">Backup of VMs encrypted using just BEK is not supported.</span></span> <span data-ttu-id="3223e-132">Backup of Linux VMs encrypted using LUKS encryption is not supported.</span><span class="sxs-lookup"><span data-stu-id="3223e-132">Backup of Linux VMs encrypted using LUKS encryption is not supported.</span></span>
* <span data-ttu-id="3223e-133">Backup of Linux virtual machines with Docker extension is not supported.</span><span class="sxs-lookup"><span data-stu-id="3223e-133">Backup of Linux virtual machines with Docker extension is not supported.</span></span>
* <span data-ttu-id="3223e-134">Backup data doesn't include network mounted drives attached to VM.</span><span class="sxs-lookup"><span data-stu-id="3223e-134">Backup data doesn't include network mounted drives attached to VM.</span></span>
* <span data-ttu-id="3223e-135">Replacing an existing virtual machine during restore is not supported.</span><span class="sxs-lookup"><span data-stu-id="3223e-135">Replacing an existing virtual machine during restore is not supported.</span></span> <span data-ttu-id="3223e-136">If you attempt to restore the VM when the VM exists, the restore operation fails.</span><span class="sxs-lookup"><span data-stu-id="3223e-136">If you attempt to restore the VM when the VM exists, the restore operation fails.</span></span>
* <span data-ttu-id="3223e-137">Cross-region backup and restore are not supported.</span><span class="sxs-lookup"><span data-stu-id="3223e-137">Cross-region backup and restore are not supported.</span></span>
* <span data-ttu-id="3223e-138">You can back up virtual machines in all public regions of Azure (see the [checklist](https://azure.microsoft.com/regions/#services) of supported regions).</span><span class="sxs-lookup"><span data-stu-id="3223e-138">You can back up virtual machines in all public regions of Azure (see the [checklist](https://azure.microsoft.com/regions/#services) of supported regions).</span></span> <span data-ttu-id="3223e-139">If the region that you are looking for is unsupported today, it will not appear in the dropdown list during vault creation.</span><span class="sxs-lookup"><span data-stu-id="3223e-139">If the region that you are looking for is unsupported today, it will not appear in the dropdown list during vault creation.</span></span>
* <span data-ttu-id="3223e-140">Restoring a domain controller (DC) VM that is part of a multi-DC configuration is supported only through PowerShell.</span><span class="sxs-lookup"><span data-stu-id="3223e-140">Restoring a domain controller (DC) VM that is part of a multi-DC configuration is supported only through PowerShell.</span></span> <span data-ttu-id="3223e-141">Read more about [restoring a multi-DC domain controller](backup-azure-restore-vms.md#restoring-domain-controller-vms).</span><span class="sxs-lookup"><span data-stu-id="3223e-141">Read more about [restoring a multi-DC domain controller](backup-azure-restore-vms.md#restoring-domain-controller-vms).</span></span>
* <span data-ttu-id="3223e-142">Restoring virtual machines that have the following special network configurations is supported only through PowerShell.</span><span class="sxs-lookup"><span data-stu-id="3223e-142">Restoring virtual machines that have the following special network configurations is supported only through PowerShell.</span></span> <span data-ttu-id="3223e-143">VMs created using the restore workflow in the UI will not have these network configurations after the restore operation is complete.</span><span class="sxs-lookup"><span data-stu-id="3223e-143">VMs created using the restore workflow in the UI will not have these network configurations after the restore operation is complete.</span></span> <span data-ttu-id="3223e-144">To learn more, see [Restoring VMs with special network configurations](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).</span><span class="sxs-lookup"><span data-stu-id="3223e-144">To learn more, see [Restoring VMs with special network configurations](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).</span></span>
  * <span data-ttu-id="3223e-145">Virtual machines under load balancer configuration (internal and external)</span><span class="sxs-lookup"><span data-stu-id="3223e-145">Virtual machines under load balancer configuration (internal and external)</span></span>
  * <span data-ttu-id="3223e-146">Virtual machines with multiple reserved IP addresses</span><span class="sxs-lookup"><span data-stu-id="3223e-146">Virtual machines with multiple reserved IP addresses</span></span>
  * <span data-ttu-id="3223e-147">Virtual machines with multiple network adapters</span><span class="sxs-lookup"><span data-stu-id="3223e-147">Virtual machines with multiple network adapters</span></span>

## <a name="create-a-recovery-services-vault-for-a-vm"></a><span data-ttu-id="3223e-148">Create a recovery services vault for a VM</span><span class="sxs-lookup"><span data-stu-id="3223e-148">Create a recovery services vault for a VM</span></span>
<span data-ttu-id="3223e-149">A recovery services vault is an entity that stores the backups and recovery points that have been created over time.</span><span class="sxs-lookup"><span data-stu-id="3223e-149">A recovery services vault is an entity that stores the backups and recovery points that have been created over time.</span></span> <span data-ttu-id="3223e-150">The recovery services vault also contains the backup policies associated with the protected virtual machines.</span><span class="sxs-lookup"><span data-stu-id="3223e-150">The recovery services vault also contains the backup policies associated with the protected virtual machines.</span></span>

<span data-ttu-id="3223e-151">To create a recovery services vault:</span><span class="sxs-lookup"><span data-stu-id="3223e-151">To create a recovery services vault:</span></span>

1. <span data-ttu-id="3223e-152">Sign in to the [Azure portal](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="3223e-152">Sign in to the [Azure portal](https://portal.azure.com/).</span></span>
2. <span data-ttu-id="3223e-153">On the Hub menu, click **Browse** and in the list of resources, type **Recovery Services**.</span><span class="sxs-lookup"><span data-stu-id="3223e-153">On the Hub menu, click **Browse** and in the list of resources, type **Recovery Services**.</span></span> <span data-ttu-id="3223e-154">As you begin typing, the list will filter based on your input.</span><span class="sxs-lookup"><span data-stu-id="3223e-154">As you begin typing, the list will filter based on your input.</span></span> <span data-ttu-id="3223e-155">Click **Recovery Services vault**.</span><span class="sxs-lookup"><span data-stu-id="3223e-155">Click **Recovery Services vault**.</span></span>

    ![Click the Browse button and type Recovery Services.](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/browse-to-rs-vaults-updated.png) <br/>

    <span data-ttu-id="3223e-158">The list of Recovery Services vaults is displayed.</span><span class="sxs-lookup"><span data-stu-id="3223e-158">The list of Recovery Services vaults is displayed.</span></span>
3. <span data-ttu-id="3223e-159">On the **Recovery Services vaults** menu, click **Add**.</span><span class="sxs-lookup"><span data-stu-id="3223e-159">On the **Recovery Services vaults** menu, click **Add**.</span></span>

    ![Create Recovery Services Vault step 2](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/rs-vault-menu.png)

    <span data-ttu-id="3223e-161">The Recovery Services vault blade opens, prompting you to provide a **Name**, **Subscription**, **Resource group**, and **Location**.</span><span class="sxs-lookup"><span data-stu-id="3223e-161">The Recovery Services vault blade opens, prompting you to provide a **Name**, **Subscription**, **Resource group**, and **Location**.</span></span>

    ![Create Recovery Services vault step 5](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/rs-vault-attributes.png)
4. <span data-ttu-id="3223e-163">For **Name**, enter a friendly name to identify the vault.</span><span class="sxs-lookup"><span data-stu-id="3223e-163">For **Name**, enter a friendly name to identify the vault.</span></span> <span data-ttu-id="3223e-164">The name needs to be unique for the Azure subscription.</span><span class="sxs-lookup"><span data-stu-id="3223e-164">The name needs to be unique for the Azure subscription.</span></span> <span data-ttu-id="3223e-165">Type a name that contains between 2 and 50 characters.</span><span class="sxs-lookup"><span data-stu-id="3223e-165">Type a name that contains between 2 and 50 characters.</span></span> <span data-ttu-id="3223e-166">It must start with a letter, and can contain only letters, numbers, and hyphens.</span><span class="sxs-lookup"><span data-stu-id="3223e-166">It must start with a letter, and can contain only letters, numbers, and hyphens.</span></span>
5. <span data-ttu-id="3223e-167">Click **Subscription** to see the available list of subscriptions.</span><span class="sxs-lookup"><span data-stu-id="3223e-167">Click **Subscription** to see the available list of subscriptions.</span></span> <span data-ttu-id="3223e-168">If you are not sure which subscription to use, use the default (or suggested) subscription.</span><span class="sxs-lookup"><span data-stu-id="3223e-168">If you are not sure which subscription to use, use the default (or suggested) subscription.</span></span> <span data-ttu-id="3223e-169">There will be multiple choices only if your organizational account is associated with multiple Azure subscriptions.</span><span class="sxs-lookup"><span data-stu-id="3223e-169">There will be multiple choices only if your organizational account is associated with multiple Azure subscriptions.</span></span>
6. <span data-ttu-id="3223e-170">Click **Resource group** to see the available list of Resource groups, or click **New** to create a new Resource group.</span><span class="sxs-lookup"><span data-stu-id="3223e-170">Click **Resource group** to see the available list of Resource groups, or click **New** to create a new Resource group.</span></span> <span data-ttu-id="3223e-171">For complete information on Resource groups, see [Azure Resource Manager overview](../azure-resource-manager/resource-group-overview.md)</span><span class="sxs-lookup"><span data-stu-id="3223e-171">For complete information on Resource groups, see [Azure Resource Manager overview](../azure-resource-manager/resource-group-overview.md)</span></span>
7. <span data-ttu-id="3223e-172">Click **Location** to select the geographic region for the vault.</span><span class="sxs-lookup"><span data-stu-id="3223e-172">Click **Location** to select the geographic region for the vault.</span></span> <span data-ttu-id="3223e-173">The vault **must** be in the same region as the virtual machines that you want to protect.</span><span class="sxs-lookup"><span data-stu-id="3223e-173">The vault **must** be in the same region as the virtual machines that you want to protect.</span></span>

   > [!IMPORTANT]
   > If you are unsure of the location in which your VM exists, close out of the vault creation dialog, and go to the list of Virtual Machines in the portal. If you have virtual machines in multiple regions, you will need to create a Recovery Services vault in each region. Create the vault in the first location before going to the next location. There is no need to specify storage accounts to store the backup data--the Recovery Services vault and the Azure Backup service handle this automatically.
   >
   >

8. <span data-ttu-id="3223e-178">Click **Create**.</span><span class="sxs-lookup"><span data-stu-id="3223e-178">Click **Create**.</span></span> <span data-ttu-id="3223e-179">It can take a while for the Recovery Services vault to be created.</span><span class="sxs-lookup"><span data-stu-id="3223e-179">It can take a while for the Recovery Services vault to be created.</span></span> <span data-ttu-id="3223e-180">Monitor the status notifications in the upper right-hand area in the portal.</span><span class="sxs-lookup"><span data-stu-id="3223e-180">Monitor the status notifications in the upper right-hand area in the portal.</span></span> <span data-ttu-id="3223e-181">Once your vault is created, it appears in the list of Recovery Services vaults.</span><span class="sxs-lookup"><span data-stu-id="3223e-181">Once your vault is created, it appears in the list of Recovery Services vaults.</span></span> <span data-ttu-id="3223e-182">If you don't see your vault, click **Refresh** to</span><span class="sxs-lookup"><span data-stu-id="3223e-182">If you don't see your vault, click **Refresh** to</span></span>

    ![List of backup vaults](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/rs-list-of-vaults.png)

    <span data-ttu-id="3223e-184">Now that you've created your vault, learn how to set the storage replication.</span><span class="sxs-lookup"><span data-stu-id="3223e-184">Now that you've created your vault, learn how to set the storage replication.</span></span>

## <a name="set-storage-replication"></a><span data-ttu-id="3223e-185">Set Storage Replication</span><span class="sxs-lookup"><span data-stu-id="3223e-185">Set Storage Replication</span></span>
<span data-ttu-id="3223e-186">The storage replication option allows you to choose between geo-redundant storage and locally redundant storage.</span><span class="sxs-lookup"><span data-stu-id="3223e-186">The storage replication option allows you to choose between geo-redundant storage and locally redundant storage.</span></span> <span data-ttu-id="3223e-187">By default, your vault has geo-redundant storage.</span><span class="sxs-lookup"><span data-stu-id="3223e-187">By default, your vault has geo-redundant storage.</span></span> <span data-ttu-id="3223e-188">Leave the option set to geo-redundant storage if this is your primary backup.</span><span class="sxs-lookup"><span data-stu-id="3223e-188">Leave the option set to geo-redundant storage if this is your primary backup.</span></span> <span data-ttu-id="3223e-189">Choose locally redundant storage if you want a cheaper option that isn't quite as durable.</span><span class="sxs-lookup"><span data-stu-id="3223e-189">Choose locally redundant storage if you want a cheaper option that isn't quite as durable.</span></span>

<span data-ttu-id="3223e-190">To edit the storage replication setting:</span><span class="sxs-lookup"><span data-stu-id="3223e-190">To edit the storage replication setting:</span></span>

1. <span data-ttu-id="3223e-191">On the **Recovery Services vaults** blade, select your vault.</span><span class="sxs-lookup"><span data-stu-id="3223e-191">On the **Recovery Services vaults** blade, select your vault.</span></span>
    <span data-ttu-id="3223e-192">When you click your vault, the Settings blade (*which has the name of the vault at the top*) and the vault details blade opens.</span><span class="sxs-lookup"><span data-stu-id="3223e-192">When you click your vault, the Settings blade (*which has the name of the vault at the top*) and the vault details blade opens.</span></span>

    ![choose your vault from the list of backup vaults](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/new-vault-settings-blade.png)

2. <span data-ttu-id="3223e-194">On the **Settings** blade, use the vertical slider to scroll down to the **Manage** section.</span><span class="sxs-lookup"><span data-stu-id="3223e-194">On the **Settings** blade, use the vertical slider to scroll down to the **Manage** section.</span></span> <span data-ttu-id="3223e-195">Click **Backup Infrastructure** to open its blade.</span><span class="sxs-lookup"><span data-stu-id="3223e-195">Click **Backup Infrastructure** to open its blade.</span></span> <span data-ttu-id="3223e-196">In the **General** section click **Backup Configuration** to open its blade.</span><span class="sxs-lookup"><span data-stu-id="3223e-196">In the **General** section click **Backup Configuration** to open its blade.</span></span> <span data-ttu-id="3223e-197">On the **Backup Configuration** blade, choose the storage replication option for your vault.</span><span class="sxs-lookup"><span data-stu-id="3223e-197">On the **Backup Configuration** blade, choose the storage replication option for your vault.</span></span> <span data-ttu-id="3223e-198">By default, your vault has geo-redundant storage.</span><span class="sxs-lookup"><span data-stu-id="3223e-198">By default, your vault has geo-redundant storage.</span></span> <span data-ttu-id="3223e-199">If you change the Storage replication type, click **Save**.</span><span class="sxs-lookup"><span data-stu-id="3223e-199">If you change the Storage replication type, click **Save**.</span></span>

    ![List of backup vaults](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/full-blade.png)

     <span data-ttu-id="3223e-201">If you are using Azure as a primary backup storage endpoint, continue using geo-redundant storage.</span><span class="sxs-lookup"><span data-stu-id="3223e-201">If you are using Azure as a primary backup storage endpoint, continue using geo-redundant storage.</span></span> <span data-ttu-id="3223e-202">If you are using Azure as a non-primary backup storage endpoint, then choose locally redundant storage.</span><span class="sxs-lookup"><span data-stu-id="3223e-202">If you are using Azure as a non-primary backup storage endpoint, then choose locally redundant storage.</span></span> <span data-ttu-id="3223e-203">Read more about [geo-redundant](../storage/storage-redundancy.md#geo-redundant-storage) and [locally redundant](../storage/storage-redundancy.md#locally-redundant-storage) storage options in the [Azure Storage replication overview](../storage/storage-redundancy.md).</span><span class="sxs-lookup"><span data-stu-id="3223e-203">Read more about [geo-redundant](../storage/storage-redundancy.md#geo-redundant-storage) and [locally redundant](../storage/storage-redundancy.md#locally-redundant-storage) storage options in the [Azure Storage replication overview](../storage/storage-redundancy.md).</span></span>
    <span data-ttu-id="3223e-204">After choosing the storage option for your vault, you are ready to associate the VM with the vault.</span><span class="sxs-lookup"><span data-stu-id="3223e-204">After choosing the storage option for your vault, you are ready to associate the VM with the vault.</span></span> <span data-ttu-id="3223e-205">To begin the association, you should discover and register the Azure virtual machines.</span><span class="sxs-lookup"><span data-stu-id="3223e-205">To begin the association, you should discover and register the Azure virtual machines.</span></span>

## <a name="select-a-backup-goal-set-policy-and-define-items-to-protect"></a><span data-ttu-id="3223e-206">Select a backup goal, set policy and define items to protect</span><span class="sxs-lookup"><span data-stu-id="3223e-206">Select a backup goal, set policy and define items to protect</span></span>
<span data-ttu-id="3223e-207">Before registering a VM with a vault, run the discovery process to ensure that any new virtual machines that have been added to the subscription are identified.</span><span class="sxs-lookup"><span data-stu-id="3223e-207">Before registering a VM with a vault, run the discovery process to ensure that any new virtual machines that have been added to the subscription are identified.</span></span> <span data-ttu-id="3223e-208">The process queries Azure for the list of virtual machines in the subscription, along with additional information like the cloud service name and the region.</span><span class="sxs-lookup"><span data-stu-id="3223e-208">The process queries Azure for the list of virtual machines in the subscription, along with additional information like the cloud service name and the region.</span></span> <span data-ttu-id="3223e-209">In the Azure portal, scenario refers to what you are going to put into the recovery services vault.</span><span class="sxs-lookup"><span data-stu-id="3223e-209">In the Azure portal, scenario refers to what you are going to put into the recovery services vault.</span></span> <span data-ttu-id="3223e-210">Policy is the schedule for how often and when recovery points are taken.</span><span class="sxs-lookup"><span data-stu-id="3223e-210">Policy is the schedule for how often and when recovery points are taken.</span></span> <span data-ttu-id="3223e-211">Policy also includes the retention range for the recovery points.</span><span class="sxs-lookup"><span data-stu-id="3223e-211">Policy also includes the retention range for the recovery points.</span></span>

1. <span data-ttu-id="3223e-212">If you already have a Recovery Services vault open, proceed to step 2.</span><span class="sxs-lookup"><span data-stu-id="3223e-212">If you already have a Recovery Services vault open, proceed to step 2.</span></span> <span data-ttu-id="3223e-213">If you do not have a Recovery Services vault open, then open the [Azure portal](https://portal.azure.com/) and on the Hub menu, click **More services**.</span><span class="sxs-lookup"><span data-stu-id="3223e-213">If you do not have a Recovery Services vault open, then open the [Azure portal](https://portal.azure.com/) and on the Hub menu, click **More services**.</span></span>

   * <span data-ttu-id="3223e-214">In the list of resources, type **Recovery Services**.</span><span class="sxs-lookup"><span data-stu-id="3223e-214">In the list of resources, type **Recovery Services**.</span></span>
   * <span data-ttu-id="3223e-215">As you begin typing, the list will filter based on your input.</span><span class="sxs-lookup"><span data-stu-id="3223e-215">As you begin typing, the list will filter based on your input.</span></span> <span data-ttu-id="3223e-216">When you see **Recovery Services vaults**, click it.</span><span class="sxs-lookup"><span data-stu-id="3223e-216">When you see **Recovery Services vaults**, click it.</span></span>

     ![Create Recovery Services Vault step 1](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/browse-to-rs-vaults-updated.png) <br/>

     <span data-ttu-id="3223e-218">The list of Recovery Services vaults appears.</span><span class="sxs-lookup"><span data-stu-id="3223e-218">The list of Recovery Services vaults appears.</span></span> <span data-ttu-id="3223e-219">If there are no vaults in your subscription, this list will be empty.</span><span class="sxs-lookup"><span data-stu-id="3223e-219">If there are no vaults in your subscription, this list will be empty.</span></span>

    ![View of the Recovery Services vaults list](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/rs-list-of-vaults.png)

   * <span data-ttu-id="3223e-221">From the list of Recovery Services vaults, select a vault to open its dashboard.</span><span class="sxs-lookup"><span data-stu-id="3223e-221">From the list of Recovery Services vaults, select a vault to open its dashboard.</span></span>

     <span data-ttu-id="3223e-222">The Settings blade and the vault dashboard for the chosen vault, opens.</span><span class="sxs-lookup"><span data-stu-id="3223e-222">The Settings blade and the vault dashboard for the chosen vault, opens.</span></span>

     ![Open vault blade](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/new-vault-settings-blade.png)
2. <span data-ttu-id="3223e-224">On the vault dashboard menu click **Backup** to open the Backup blade.</span><span class="sxs-lookup"><span data-stu-id="3223e-224">On the vault dashboard menu click **Backup** to open the Backup blade.</span></span>

    ![Open Backup blade](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/backup-button.png)

    <span data-ttu-id="3223e-226">The Backup and Backup Goal blades open.</span><span class="sxs-lookup"><span data-stu-id="3223e-226">The Backup and Backup Goal blades open.</span></span>

    ![Open Scenario blade](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/select-backup-goal-1.png)

3. <span data-ttu-id="3223e-228">On the Backup Goal blade, set **Where is your workload running** to Azure and **What do you want to backup** to Virtual machine, then click **OK**.</span><span class="sxs-lookup"><span data-stu-id="3223e-228">On the Backup Goal blade, set **Where is your workload running** to Azure and **What do you want to backup** to Virtual machine, then click **OK**.</span></span>

    <span data-ttu-id="3223e-229">This registers the VM extension with the vault.</span><span class="sxs-lookup"><span data-stu-id="3223e-229">This registers the VM extension with the vault.</span></span> <span data-ttu-id="3223e-230">The Backup Goal blade closes and the **Backup policy** blade opens.</span><span class="sxs-lookup"><span data-stu-id="3223e-230">The Backup Goal blade closes and the **Backup policy** blade opens.</span></span>

    ![Open Scenario blade](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/select-backup-goal-2.png)
4. <span data-ttu-id="3223e-232">On the Backup policy blade, select the backup policy you want to apply to the vault.</span><span class="sxs-lookup"><span data-stu-id="3223e-232">On the Backup policy blade, select the backup policy you want to apply to the vault.</span></span>

    ![Select backup policy](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/setting-rs-backup-policy-new.png)

    <span data-ttu-id="3223e-234">The details of the default policy are listed under the drop-down menu.</span><span class="sxs-lookup"><span data-stu-id="3223e-234">The details of the default policy are listed under the drop-down menu.</span></span> <span data-ttu-id="3223e-235">If you want to create a new policy, select **Create New** from the drop-down menu.</span><span class="sxs-lookup"><span data-stu-id="3223e-235">If you want to create a new policy, select **Create New** from the drop-down menu.</span></span> <span data-ttu-id="3223e-236">For instructions on defining a backup policy, see [Defining a backup policy](backup-azure-vms-first-look-arm.md#defining-a-backup-policy).</span><span class="sxs-lookup"><span data-stu-id="3223e-236">For instructions on defining a backup policy, see [Defining a backup policy](backup-azure-vms-first-look-arm.md#defining-a-backup-policy).</span></span>
    <span data-ttu-id="3223e-237">Click **OK** to associate the backup policy with the vault.</span><span class="sxs-lookup"><span data-stu-id="3223e-237">Click **OK** to associate the backup policy with the vault.</span></span>

    <span data-ttu-id="3223e-238">The Backup policy blade closes and the **Select virtual machines** blade opens.</span><span class="sxs-lookup"><span data-stu-id="3223e-238">The Backup policy blade closes and the **Select virtual machines** blade opens.</span></span>
5. <span data-ttu-id="3223e-239">In the **Select virtual machines** blade, choose the virtual machines to associate with the specified policy and click **OK**.</span><span class="sxs-lookup"><span data-stu-id="3223e-239">In the **Select virtual machines** blade, choose the virtual machines to associate with the specified policy and click **OK**.</span></span>

    ![Select workload](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/select-vms-to-backup.png)

    <span data-ttu-id="3223e-241">The selected virtual machine is validated.</span><span class="sxs-lookup"><span data-stu-id="3223e-241">The selected virtual machine is validated.</span></span> <span data-ttu-id="3223e-242">If you do not see the virtual machines that you expected to see, check that they exist in the same Azure location as the Recovery Services vault and are not already protected in another vault.</span><span class="sxs-lookup"><span data-stu-id="3223e-242">If you do not see the virtual machines that you expected to see, check that they exist in the same Azure location as the Recovery Services vault and are not already protected in another vault.</span></span> <span data-ttu-id="3223e-243">The location of the Recovery Services vault is shown on the vault dashboard.</span><span class="sxs-lookup"><span data-stu-id="3223e-243">The location of the Recovery Services vault is shown on the vault dashboard.</span></span>

6. <span data-ttu-id="3223e-244">Now that you have defined all settings for the vault, in the Backup blade click **Enable Backup**.</span><span class="sxs-lookup"><span data-stu-id="3223e-244">Now that you have defined all settings for the vault, in the Backup blade click **Enable Backup**.</span></span> <span data-ttu-id="3223e-245">This deploys the policy to the vault and the VMs.</span><span class="sxs-lookup"><span data-stu-id="3223e-245">This deploys the policy to the vault and the VMs.</span></span> <span data-ttu-id="3223e-246">This does not create the initial recovery point for the virtual machine.</span><span class="sxs-lookup"><span data-stu-id="3223e-246">This does not create the initial recovery point for the virtual machine.</span></span>

    ![Enable Backup](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-arm-vms-prepare/vm-validated-click-enable.png)

<span data-ttu-id="3223e-248">After successfully enabling the backup, your backup policy will execute on schedule.</span><span class="sxs-lookup"><span data-stu-id="3223e-248">After successfully enabling the backup, your backup policy will execute on schedule.</span></span> <span data-ttu-id="3223e-249">If you would like to generate an on-demand backup job to back up the virtual machines now, see [Triggering the Backup job](./backup-azure-arm-vms.md#triggering-the-backup-job).</span><span class="sxs-lookup"><span data-stu-id="3223e-249">If you would like to generate an on-demand backup job to back up the virtual machines now, see [Triggering the Backup job](./backup-azure-arm-vms.md#triggering-the-backup-job).</span></span>

<span data-ttu-id="3223e-250">If you have problems registering the virtual machine, see the following information on installing the VM Agent and on Network connectivity.</span><span class="sxs-lookup"><span data-stu-id="3223e-250">If you have problems registering the virtual machine, see the following information on installing the VM Agent and on Network connectivity.</span></span> <span data-ttu-id="3223e-251">You probably don't need the following information if you are protecting virtual machines created in Azure.</span><span class="sxs-lookup"><span data-stu-id="3223e-251">You probably don't need the following information if you are protecting virtual machines created in Azure.</span></span> <span data-ttu-id="3223e-252">However if you migrated your virtual machines into Azure, then be sure you have properly installed the VM agent and that your virtual machine can communicate with the virtual network.</span><span class="sxs-lookup"><span data-stu-id="3223e-252">However if you migrated your virtual machines into Azure, then be sure you have properly installed the VM agent and that your virtual machine can communicate with the virtual network.</span></span>

## <a name="install-the-vm-agent-on-the-virtual-machine"></a><span data-ttu-id="3223e-253">Install the VM Agent on the virtual machine</span><span class="sxs-lookup"><span data-stu-id="3223e-253">Install the VM Agent on the virtual machine</span></span>
<span data-ttu-id="3223e-254">The Azure VM Agent must be installed on the Azure virtual machine for the Backup extension to work.</span><span class="sxs-lookup"><span data-stu-id="3223e-254">The Azure VM Agent must be installed on the Azure virtual machine for the Backup extension to work.</span></span> <span data-ttu-id="3223e-255">If your VM was created from the Azure gallery, then the VM Agent is already present on the virtual machine.</span><span class="sxs-lookup"><span data-stu-id="3223e-255">If your VM was created from the Azure gallery, then the VM Agent is already present on the virtual machine.</span></span> <span data-ttu-id="3223e-256">This information is provided for the situations where you are *not* using a VM created from the Azure gallery - for example you migrated a VM from an on-premises datacenter.</span><span class="sxs-lookup"><span data-stu-id="3223e-256">This information is provided for the situations where you are *not* using a VM created from the Azure gallery - for example you migrated a VM from an on-premises datacenter.</span></span> <span data-ttu-id="3223e-257">In such a case, the VM Agent needs to be installed in order to protect the virtual machine.</span><span class="sxs-lookup"><span data-stu-id="3223e-257">In such a case, the VM Agent needs to be installed in order to protect the virtual machine.</span></span> <span data-ttu-id="3223e-258">Learn about the [VM Agent](../virtual-machines/windows/classic/agents-and-extensions.md#azure-vm-agents-for-windows-and-linux).</span><span class="sxs-lookup"><span data-stu-id="3223e-258">Learn about the [VM Agent](../virtual-machines/windows/classic/agents-and-extensions.md#azure-vm-agents-for-windows-and-linux).</span></span>

<span data-ttu-id="3223e-259">If you have problems backing up the Azure VM, check that the Azure VM Agent is correctly installed on the virtual machine (see the table below).</span><span class="sxs-lookup"><span data-stu-id="3223e-259">If you have problems backing up the Azure VM, check that the Azure VM Agent is correctly installed on the virtual machine (see the table below).</span></span> <span data-ttu-id="3223e-260">The following table provides additional information about the VM Agent for Windows and Linux VMs.</span><span class="sxs-lookup"><span data-stu-id="3223e-260">The following table provides additional information about the VM Agent for Windows and Linux VMs.</span></span>

| <span data-ttu-id="3223e-261">**Operation**</span><span class="sxs-lookup"><span data-stu-id="3223e-261">**Operation**</span></span> | <span data-ttu-id="3223e-262">**Windows**</span><span class="sxs-lookup"><span data-stu-id="3223e-262">**Windows**</span></span> | <span data-ttu-id="3223e-263">**Linux**</span><span class="sxs-lookup"><span data-stu-id="3223e-263">**Linux**</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3223e-264">Installing the VM Agent</span><span class="sxs-lookup"><span data-stu-id="3223e-264">Installing the VM Agent</span></span> |<span data-ttu-id="3223e-265">Download and install the [agent MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="3223e-265">Download and install the [agent MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <span data-ttu-id="3223e-266">You will need Administrator privileges to complete the installation.</span><span class="sxs-lookup"><span data-stu-id="3223e-266">You will need Administrator privileges to complete the installation.</span></span> |<li> <span data-ttu-id="3223e-267">Install the latest [Linux agent](../virtual-machines/linux/agent-user-guide.md).</span><span class="sxs-lookup"><span data-stu-id="3223e-267">Install the latest [Linux agent](../virtual-machines/linux/agent-user-guide.md).</span></span> <span data-ttu-id="3223e-268">You will need Administrator privileges to complete the installation.</span><span class="sxs-lookup"><span data-stu-id="3223e-268">You will need Administrator privileges to complete the installation.</span></span> <span data-ttu-id="3223e-269">We recommend installing agent from your distribution repository.</span><span class="sxs-lookup"><span data-stu-id="3223e-269">We recommend installing agent from your distribution repository.</span></span> <span data-ttu-id="3223e-270">We **do not recommend** installing Linux VM agent directly from github.</span><span class="sxs-lookup"><span data-stu-id="3223e-270">We **do not recommend** installing Linux VM agent directly from github.</span></span>  |
| <span data-ttu-id="3223e-271">Updating the VM Agent</span><span class="sxs-lookup"><span data-stu-id="3223e-271">Updating the VM Agent</span></span> |<span data-ttu-id="3223e-272">Updating the VM Agent is as simple as reinstalling the [VM Agent binaries](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span><span class="sxs-lookup"><span data-stu-id="3223e-272">Updating the VM Agent is as simple as reinstalling the [VM Agent binaries](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <br><span data-ttu-id="3223e-273">Ensure that no backup operation is running while the VM agent is being updated.</span><span class="sxs-lookup"><span data-stu-id="3223e-273">Ensure that no backup operation is running while the VM agent is being updated.</span></span> |<span data-ttu-id="3223e-274">Follow the instructions on [updating the Linux VM Agent](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span><span class="sxs-lookup"><span data-stu-id="3223e-274">Follow the instructions on [updating the Linux VM Agent](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).</span></span> <span data-ttu-id="3223e-275">We recommend updating agent from your distribution repository.</span><span class="sxs-lookup"><span data-stu-id="3223e-275">We recommend updating agent from your distribution repository.</span></span> <span data-ttu-id="3223e-276">We **do not recommend** updating Linux VM agent directly from github.</span><span class="sxs-lookup"><span data-stu-id="3223e-276">We **do not recommend** updating Linux VM agent directly from github.</span></span><br><span data-ttu-id="3223e-277">Ensure that no backup operation is running while the VM Agent is being updated.</span><span class="sxs-lookup"><span data-stu-id="3223e-277">Ensure that no backup operation is running while the VM Agent is being updated.</span></span> |
| <span data-ttu-id="3223e-278">Validating the VM Agent installation</span><span class="sxs-lookup"><span data-stu-id="3223e-278">Validating the VM Agent installation</span></span> |<li><span data-ttu-id="3223e-279">Navigate to the *C:\WindowsAzure\Packages* folder in the Azure VM.</span><span class="sxs-lookup"><span data-stu-id="3223e-279">Navigate to the *C:\WindowsAzure\Packages* folder in the Azure VM.</span></span> <li><span data-ttu-id="3223e-280">You should find the WaAppAgent.exe file present.</span><span class="sxs-lookup"><span data-stu-id="3223e-280">You should find the WaAppAgent.exe file present.</span></span><li> <span data-ttu-id="3223e-281">Right-click the file, go to **Properties**, and then select the **Details** tab. The Product Version field should be 2.6.1198.718 or higher.</span><span class="sxs-lookup"><span data-stu-id="3223e-281">Right-click the file, go to **Properties**, and then select the **Details** tab. The Product Version field should be 2.6.1198.718 or higher.</span></span> |<span data-ttu-id="3223e-282">N/A</span><span class="sxs-lookup"><span data-stu-id="3223e-282">N/A</span></span> |

### <a name="backup-extension"></a><span data-ttu-id="3223e-283">Backup extension</span><span class="sxs-lookup"><span data-stu-id="3223e-283">Backup extension</span></span>
<span data-ttu-id="3223e-284">Once the VM Agent is installed on the virtual machine, the Azure Backup service installs the backup extension to the VM Agent.</span><span class="sxs-lookup"><span data-stu-id="3223e-284">Once the VM Agent is installed on the virtual machine, the Azure Backup service installs the backup extension to the VM Agent.</span></span> <span data-ttu-id="3223e-285">The Azure Backup service seamlessly upgrades and patches the backup extension.</span><span class="sxs-lookup"><span data-stu-id="3223e-285">The Azure Backup service seamlessly upgrades and patches the backup extension.</span></span>

<span data-ttu-id="3223e-286">The backup extension is installed by the Backup service whether or not the VM is running.</span><span class="sxs-lookup"><span data-stu-id="3223e-286">The backup extension is installed by the Backup service whether or not the VM is running.</span></span> <span data-ttu-id="3223e-287">A running VM provides the greatest chance of getting an application-consistent recovery point.</span><span class="sxs-lookup"><span data-stu-id="3223e-287">A running VM provides the greatest chance of getting an application-consistent recovery point.</span></span> <span data-ttu-id="3223e-288">However, the Azure Backup service continues to back up the VM even if it is turned off, and the extension could not be installed.</span><span class="sxs-lookup"><span data-stu-id="3223e-288">However, the Azure Backup service continues to back up the VM even if it is turned off, and the extension could not be installed.</span></span> <span data-ttu-id="3223e-289">This is known as Offline VM.</span><span class="sxs-lookup"><span data-stu-id="3223e-289">This is known as Offline VM.</span></span> <span data-ttu-id="3223e-290">In this case, the recovery point will be *crash consistent*.</span><span class="sxs-lookup"><span data-stu-id="3223e-290">In this case, the recovery point will be *crash consistent*.</span></span>

## <a name="network-connectivity"></a><span data-ttu-id="3223e-291">Network connectivity</span><span class="sxs-lookup"><span data-stu-id="3223e-291">Network connectivity</span></span>
<span data-ttu-id="3223e-292">In order to manage the VM snapshots, the backup extension needs connectivity to the Azure public IP addresses.</span><span class="sxs-lookup"><span data-stu-id="3223e-292">In order to manage the VM snapshots, the backup extension needs connectivity to the Azure public IP addresses.</span></span> <span data-ttu-id="3223e-293">Without the right Internet connectivity, the virtual machine's HTTP requests time out and the backup operation fails.</span><span class="sxs-lookup"><span data-stu-id="3223e-293">Without the right Internet connectivity, the virtual machine's HTTP requests time out and the backup operation fails.</span></span> <span data-ttu-id="3223e-294">If your deployment has access restrictions in place (through a network security group (NSG), for example), then choose one of these options for providing a clear path for backup traffic:</span><span class="sxs-lookup"><span data-stu-id="3223e-294">If your deployment has access restrictions in place (through a network security group (NSG), for example), then choose one of these options for providing a clear path for backup traffic:</span></span>

* <span data-ttu-id="3223e-295">[Whitelist the Azure datacenter IP ranges](http://www.microsoft.com/en-us/download/details.aspx?id=41653) - see the article for instructions on how to whitelist the IP addresses.</span><span class="sxs-lookup"><span data-stu-id="3223e-295">[Whitelist the Azure datacenter IP ranges](http://www.microsoft.com/en-us/download/details.aspx?id=41653) - see the article for instructions on how to whitelist the IP addresses.</span></span>
* <span data-ttu-id="3223e-296">Deploy an HTTP proxy server for routing traffic.</span><span class="sxs-lookup"><span data-stu-id="3223e-296">Deploy an HTTP proxy server for routing traffic.</span></span>

<span data-ttu-id="3223e-297">When deciding which option to use, the trade-offs are between manageability, granular control, and cost.</span><span class="sxs-lookup"><span data-stu-id="3223e-297">When deciding which option to use, the trade-offs are between manageability, granular control, and cost.</span></span>

| <span data-ttu-id="3223e-298">Option</span><span class="sxs-lookup"><span data-stu-id="3223e-298">Option</span></span> | <span data-ttu-id="3223e-299">Advantages</span><span class="sxs-lookup"><span data-stu-id="3223e-299">Advantages</span></span> | <span data-ttu-id="3223e-300">Disadvantages</span><span class="sxs-lookup"><span data-stu-id="3223e-300">Disadvantages</span></span> |
| --- | --- | --- |
| <span data-ttu-id="3223e-301">Whitelist IP ranges</span><span class="sxs-lookup"><span data-stu-id="3223e-301">Whitelist IP ranges</span></span> |<span data-ttu-id="3223e-302">No additional costs.</span><span class="sxs-lookup"><span data-stu-id="3223e-302">No additional costs.</span></span><br><br><span data-ttu-id="3223e-303">For opening access in an NSG, use the <i>Set-AzureNetworkSecurityRule</i> cmdlet.</span><span class="sxs-lookup"><span data-stu-id="3223e-303">For opening access in an NSG, use the <i>Set-AzureNetworkSecurityRule</i> cmdlet.</span></span> |<span data-ttu-id="3223e-304">Complex to manage as the impacted IP ranges change over time.</span><span class="sxs-lookup"><span data-stu-id="3223e-304">Complex to manage as the impacted IP ranges change over time.</span></span><br><br><span data-ttu-id="3223e-305">Provides access to the whole of Azure, and not just Storage.</span><span class="sxs-lookup"><span data-stu-id="3223e-305">Provides access to the whole of Azure, and not just Storage.</span></span> |
| <span data-ttu-id="3223e-306">HTTP proxy</span><span class="sxs-lookup"><span data-stu-id="3223e-306">HTTP proxy</span></span> |<span data-ttu-id="3223e-307">Granular control in the proxy over the storage URLs allowed.</span><span class="sxs-lookup"><span data-stu-id="3223e-307">Granular control in the proxy over the storage URLs allowed.</span></span><br><span data-ttu-id="3223e-308">Single point of Internet access to VMs.</span><span class="sxs-lookup"><span data-stu-id="3223e-308">Single point of Internet access to VMs.</span></span><br><span data-ttu-id="3223e-309">Not subject to Azure IP address changes.</span><span class="sxs-lookup"><span data-stu-id="3223e-309">Not subject to Azure IP address changes.</span></span> |<span data-ttu-id="3223e-310">Additional costs for running a VM with the proxy software.</span><span class="sxs-lookup"><span data-stu-id="3223e-310">Additional costs for running a VM with the proxy software.</span></span> |

### <a name="whitelist-the-azure-datacenter-ip-ranges"></a><span data-ttu-id="3223e-311">Whitelist the Azure datacenter IP ranges</span><span class="sxs-lookup"><span data-stu-id="3223e-311">Whitelist the Azure datacenter IP ranges</span></span>
<span data-ttu-id="3223e-312">To whitelist the Azure datacenter IP ranges, please see the [Azure website](http://www.microsoft.com/en-us/download/details.aspx?id=41653) for details on the IP ranges, and instructions.</span><span class="sxs-lookup"><span data-stu-id="3223e-312">To whitelist the Azure datacenter IP ranges, please see the [Azure website](http://www.microsoft.com/en-us/download/details.aspx?id=41653) for details on the IP ranges, and instructions.</span></span>

### <a name="using-an-http-proxy-for-vm-backups"></a><span data-ttu-id="3223e-313">Using an HTTP proxy for VM backups</span><span class="sxs-lookup"><span data-stu-id="3223e-313">Using an HTTP proxy for VM backups</span></span>
<span data-ttu-id="3223e-314">When backing up a VM, the backup extension on the VM sends the snapshot management commands to Azure Storage using an HTTPS API.</span><span class="sxs-lookup"><span data-stu-id="3223e-314">When backing up a VM, the backup extension on the VM sends the snapshot management commands to Azure Storage using an HTTPS API.</span></span> <span data-ttu-id="3223e-315">Route the backup extension traffic through the HTTP proxy since it is the only component configured for access to the public Internet.</span><span class="sxs-lookup"><span data-stu-id="3223e-315">Route the backup extension traffic through the HTTP proxy since it is the only component configured for access to the public Internet.</span></span>

> [!NOTE]
> There is no recommendation for the proxy software that should be used. Ensure that you pick a proxy that is compatible with the configuration steps below.
>
>

<span data-ttu-id="3223e-318">The example image below shows the three configuration steps necessary to use an HTTP proxy:</span><span class="sxs-lookup"><span data-stu-id="3223e-318">The example image below shows the three configuration steps necessary to use an HTTP proxy:</span></span>

* <span data-ttu-id="3223e-319">App VM routes all HTTP traffic bound for the public Internet through Proxy VM.</span><span class="sxs-lookup"><span data-stu-id="3223e-319">App VM routes all HTTP traffic bound for the public Internet through Proxy VM.</span></span>
* <span data-ttu-id="3223e-320">Proxy VM allows incoming traffic from VMs in the virtual network.</span><span class="sxs-lookup"><span data-stu-id="3223e-320">Proxy VM allows incoming traffic from VMs in the virtual network.</span></span>
* <span data-ttu-id="3223e-321">The Network Security Group (NSG) named NSF-lockdown needs a security rule allowing outbound Internet traffic from Proxy VM.</span><span class="sxs-lookup"><span data-stu-id="3223e-321">The Network Security Group (NSG) named NSF-lockdown needs a security rule allowing outbound Internet traffic from Proxy VM.</span></span>

![NSG with HTTP proxy deployment diagram](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-vms-prepare/nsg-with-http-proxy.png)

<span data-ttu-id="3223e-323">To use an HTTP proxy to communicating to the public Internet, follow these steps:</span><span class="sxs-lookup"><span data-stu-id="3223e-323">To use an HTTP proxy to communicating to the public Internet, follow these steps:</span></span>

#### <a name="step-1-configure-outgoing-network-connections"></a><span data-ttu-id="3223e-324">Step 1.</span><span class="sxs-lookup"><span data-stu-id="3223e-324">Step 1.</span></span> <span data-ttu-id="3223e-325">Configure outgoing network connections</span><span class="sxs-lookup"><span data-stu-id="3223e-325">Configure outgoing network connections</span></span>
###### <a name="for-windows-machines"></a><span data-ttu-id="3223e-326">For Windows machines</span><span class="sxs-lookup"><span data-stu-id="3223e-326">For Windows machines</span></span>
<span data-ttu-id="3223e-327">This will setup proxy server configuration for Local System Account.</span><span class="sxs-lookup"><span data-stu-id="3223e-327">This will setup proxy server configuration for Local System Account.</span></span>

1. <span data-ttu-id="3223e-328">Download [PsExec](https://technet.microsoft.com/sysinternals/bb897553)</span><span class="sxs-lookup"><span data-stu-id="3223e-328">Download [PsExec](https://technet.microsoft.com/sysinternals/bb897553)</span></span>
2. <span data-ttu-id="3223e-329">Run following command from elevated prompt,</span><span class="sxs-lookup"><span data-stu-id="3223e-329">Run following command from elevated prompt,</span></span>

     ```
     psexec -i -s "c:\Program Files\Internet Explorer\iexplore.exe"
     ```
     <span data-ttu-id="3223e-330">It will open internet explorer window.</span><span class="sxs-lookup"><span data-stu-id="3223e-330">It will open internet explorer window.</span></span>
3. <span data-ttu-id="3223e-331">Go to Tools -> Internet Options -> Connections -> LAN settings.</span><span class="sxs-lookup"><span data-stu-id="3223e-331">Go to Tools -> Internet Options -> Connections -> LAN settings.</span></span>
4. <span data-ttu-id="3223e-332">Verify proxy settings for System account.</span><span class="sxs-lookup"><span data-stu-id="3223e-332">Verify proxy settings for System account.</span></span> <span data-ttu-id="3223e-333">Set Proxy IP and port.</span><span class="sxs-lookup"><span data-stu-id="3223e-333">Set Proxy IP and port.</span></span>
5. <span data-ttu-id="3223e-334">Close Internet Explorer.</span><span class="sxs-lookup"><span data-stu-id="3223e-334">Close Internet Explorer.</span></span>

<span data-ttu-id="3223e-335">This will set up a machine-wide proxy configuration, and will be used for any outgoing HTTP/HTTPS traffic.</span><span class="sxs-lookup"><span data-stu-id="3223e-335">This will set up a machine-wide proxy configuration, and will be used for any outgoing HTTP/HTTPS traffic.</span></span>

<span data-ttu-id="3223e-336">If you have setup a proxy server on a current user account(not a Local System Account), use the following script to apply them to SYSTEMACCOUNT:</span><span class="sxs-lookup"><span data-stu-id="3223e-336">If you have setup a proxy server on a current user account(not a Local System Account), use the following script to apply them to SYSTEMACCOUNT:</span></span>

```
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name DefaultConnectionSettings -Value $obj.DefaultConnectionSettings
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name SavedLegacySettings -Value $obj.SavedLegacySettings
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value $obj.ProxyEnable
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name Proxyserver -Value $obj.Proxyserver
```

> [!NOTE]
> If you observe "(407) Proxy Authentication Required" in proxy server log, check your authentication is setup correctly.
>
>

###### <a name="for-linux-machines"></a><span data-ttu-id="3223e-338">For Linux machines</span><span class="sxs-lookup"><span data-stu-id="3223e-338">For Linux machines</span></span>
<span data-ttu-id="3223e-339">Add the following line to the ```/etc/environment``` file:</span><span class="sxs-lookup"><span data-stu-id="3223e-339">Add the following line to the ```/etc/environment``` file:</span></span>

```
http_proxy=http://<proxy IP>:<proxy port>
```

<span data-ttu-id="3223e-340">Add the following lines to the ```/etc/waagent.conf``` file:</span><span class="sxs-lookup"><span data-stu-id="3223e-340">Add the following lines to the ```/etc/waagent.conf``` file:</span></span>

```
HttpProxy.Host=<proxy IP>
HttpProxy.Port=<proxy port>
```

#### <a name="step-2-allow-incoming-connections-on-the-proxy-server"></a><span data-ttu-id="3223e-341">Step 2.</span><span class="sxs-lookup"><span data-stu-id="3223e-341">Step 2.</span></span> <span data-ttu-id="3223e-342">Allow incoming connections on the proxy server:</span><span class="sxs-lookup"><span data-stu-id="3223e-342">Allow incoming connections on the proxy server:</span></span>
1. <span data-ttu-id="3223e-343">On the proxy server, open Windows Firewall.</span><span class="sxs-lookup"><span data-stu-id="3223e-343">On the proxy server, open Windows Firewall.</span></span> <span data-ttu-id="3223e-344">The easiest way to access the firewall is to search for Windows Firewall with Advanced Security.</span><span class="sxs-lookup"><span data-stu-id="3223e-344">The easiest way to access the firewall is to search for Windows Firewall with Advanced Security.</span></span>

    ![Open the Firewall](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-vms-prepare/firewall-01.png)
2. <span data-ttu-id="3223e-346">In the Windows Firewall dialog, right-click **Inbound Rules** and click **New Rule...**.</span><span class="sxs-lookup"><span data-stu-id="3223e-346">In the Windows Firewall dialog, right-click **Inbound Rules** and click **New Rule...**.</span></span>

    ![Create a new rule](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-vms-prepare/firewall-02.png)
3. <span data-ttu-id="3223e-348">In the **New Inbound Rule Wizard**, choose the **Custom** option for the **Rule Type** and click **Next**.</span><span class="sxs-lookup"><span data-stu-id="3223e-348">In the **New Inbound Rule Wizard**, choose the **Custom** option for the **Rule Type** and click **Next**.</span></span>
4. <span data-ttu-id="3223e-349">On the page to select the **Program**, choose **All Programs** and click **Next**.</span><span class="sxs-lookup"><span data-stu-id="3223e-349">On the page to select the **Program**, choose **All Programs** and click **Next**.</span></span>
5. <span data-ttu-id="3223e-350">On the **Protocol and Ports** page, enter the following information and click **Next**:</span><span class="sxs-lookup"><span data-stu-id="3223e-350">On the **Protocol and Ports** page, enter the following information and click **Next**:</span></span>

    ![Create a new rule](https://docstestmedia1.blob.core.windows.net/azure-media/articles/backup/media/backup-azure-vms-prepare/firewall-03.png)

   * <span data-ttu-id="3223e-352">for *Protocol type* choose *TCP*</span><span class="sxs-lookup"><span data-stu-id="3223e-352">for *Protocol type* choose *TCP*</span></span>
   * <span data-ttu-id="3223e-353">for *Local port* choose *Specific Ports*, in the field below specify the ```<Proxy Port>``` that has been configured.</span><span class="sxs-lookup"><span data-stu-id="3223e-353">for *Local port* choose *Specific Ports*, in the field below specify the ```<Proxy Port>``` that has been configured.</span></span>
   * <span data-ttu-id="3223e-354">for *Remote port* select *All Ports*</span><span class="sxs-lookup"><span data-stu-id="3223e-354">for *Remote port* select *All Ports*</span></span>

     <span data-ttu-id="3223e-355">For the rest of the wizard, click all the way to the end and give this rule a name.</span><span class="sxs-lookup"><span data-stu-id="3223e-355">For the rest of the wizard, click all the way to the end and give this rule a name.</span></span>

#### <a name="step-3-add-an-exception-rule-to-the-nsg"></a><span data-ttu-id="3223e-356">Step 3.</span><span class="sxs-lookup"><span data-stu-id="3223e-356">Step 3.</span></span> <span data-ttu-id="3223e-357">Add an exception rule to the NSG:</span><span class="sxs-lookup"><span data-stu-id="3223e-357">Add an exception rule to the NSG:</span></span>
<span data-ttu-id="3223e-358">In an Azure PowerShell command prompt, enter the following command:</span><span class="sxs-lookup"><span data-stu-id="3223e-358">In an Azure PowerShell command prompt, enter the following command:</span></span>

<span data-ttu-id="3223e-359">The following command adds an exception to the NSG.</span><span class="sxs-lookup"><span data-stu-id="3223e-359">The following command adds an exception to the NSG.</span></span> <span data-ttu-id="3223e-360">This exception allows TCP traffic from any port on 10.0.0.5 to any Internet address on port 80 (HTTP) or 443 (HTTPS).</span><span class="sxs-lookup"><span data-stu-id="3223e-360">This exception allows TCP traffic from any port on 10.0.0.5 to any Internet address on port 80 (HTTP) or 443 (HTTPS).</span></span> <span data-ttu-id="3223e-361">If you require a specific port in the public Internet, be sure to add that port to the ```-DestinationPortRange``` as well.</span><span class="sxs-lookup"><span data-stu-id="3223e-361">If you require a specific port in the public Internet, be sure to add that port to the ```-DestinationPortRange``` as well.</span></span>

```
Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
```


<span data-ttu-id="3223e-362">*These steps use specific names and values for this example. Please use the names and values for your deployment when entering, or cutting and pasting details into your code.*</span><span class="sxs-lookup"><span data-stu-id="3223e-362">*These steps use specific names and values for this example. Please use the names and values for your deployment when entering, or cutting and pasting details into your code.*</span></span>

<span data-ttu-id="3223e-363">Now that you know you have network connectivity, you are ready to back up your VM.</span><span class="sxs-lookup"><span data-stu-id="3223e-363">Now that you know you have network connectivity, you are ready to back up your VM.</span></span> <span data-ttu-id="3223e-364">See [Back up Resource Manager-deployed VMs](backup-azure-arm-vms.md).</span><span class="sxs-lookup"><span data-stu-id="3223e-364">See [Back up Resource Manager-deployed VMs](backup-azure-arm-vms.md).</span></span>

## <a name="questions"></a><span data-ttu-id="3223e-365">Questions?</span><span class="sxs-lookup"><span data-stu-id="3223e-365">Questions?</span></span>
<span data-ttu-id="3223e-366">If you have questions, or if there is any feature that you would like to see included, [send us feedback](http://aka.ms/azurebackup_feedback).</span><span class="sxs-lookup"><span data-stu-id="3223e-366">If you have questions, or if there is any feature that you would like to see included, [send us feedback](http://aka.ms/azurebackup_feedback).</span></span>

## <a name="next-steps"></a><span data-ttu-id="3223e-367">Next steps</span><span class="sxs-lookup"><span data-stu-id="3223e-367">Next steps</span></span>
<span data-ttu-id="3223e-368">Now that you have prepared your environment for backing up your VM, your next logical step is to create a backup.</span><span class="sxs-lookup"><span data-stu-id="3223e-368">Now that you have prepared your environment for backing up your VM, your next logical step is to create a backup.</span></span> <span data-ttu-id="3223e-369">The planning article provides more detailed information about backing up VMs.</span><span class="sxs-lookup"><span data-stu-id="3223e-369">The planning article provides more detailed information about backing up VMs.</span></span>

* [<span data-ttu-id="3223e-370">Back up virtual machines</span><span class="sxs-lookup"><span data-stu-id="3223e-370">Back up virtual machines</span></span>](backup-azure-vms.md)
* [<span data-ttu-id="3223e-371">Plan your VM backup infrastructure</span><span class="sxs-lookup"><span data-stu-id="3223e-371">Plan your VM backup infrastructure</span></span>](backup-azure-vms-introduction.md)
* [<span data-ttu-id="3223e-372">Manage virtual machine backups</span><span class="sxs-lookup"><span data-stu-id="3223e-372">Manage virtual machine backups</span></span>](backup-azure-manage-vms.md)



















