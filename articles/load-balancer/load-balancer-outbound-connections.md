---
title: Outbound connections in Azure | Microsoft Docs
description: This article explains how Azure enables VMs to communicate with public internet services.
services: load-balancer
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: ''
ms.assetid: 5f666f2a-3a63-405a-abcd-b2e34d40e001
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/27/2018
ms.author: kumud
ms.openlocfilehash: ea8e8ae9b0f487481ac2f25d4e2b9c5733e15431
ms.sourcegitcommit: d1451406a010fd3aa854dc8e5b77dc5537d8050e
ms.translationtype: MT
ms.contentlocale: nl-NL
ms.lasthandoff: 09/13/2018
ms.locfileid: "44803847"
---
# <a name="outbound-connections-in-azure"></a><span data-ttu-id="c6cb9-103">Outbound connections in Azure</span><span class="sxs-lookup"><span data-stu-id="c6cb9-103">Outbound connections in Azure</span></span>

<span data-ttu-id="c6cb9-104">Azure provides outbound connectivity for customer deployments through several different mechanisms.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-104">Azure provides outbound connectivity for customer deployments through several different mechanisms.</span></span> <span data-ttu-id="c6cb9-105">This article describes what the scenarios are, when they apply, how they work, and how to manage them.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-105">This article describes what the scenarios are, when they apply, how they work, and how to manage them.</span></span>

>[!NOTE] 
><span data-ttu-id="c6cb9-106">This article covers Resource Manager deployments only.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-106">This article covers Resource Manager deployments only.</span></span> <span data-ttu-id="c6cb9-107">Review [Outbound connections (Classic)](load-balancer-outbound-connections-classic.md) for all Classic deployment scenarios in Azure.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-107">Review [Outbound connections (Classic)](load-balancer-outbound-connections-classic.md) for all Classic deployment scenarios in Azure.</span></span>

<span data-ttu-id="c6cb9-108">A deployment in Azure can communicate with endpoints outside Azure in the public IP address space.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-108">A deployment in Azure can communicate with endpoints outside Azure in the public IP address space.</span></span> <span data-ttu-id="c6cb9-109">When an instance initiates an outbound flow to a destination in the public IP address space, Azure dynamically maps the private IP address to a public IP address.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-109">When an instance initiates an outbound flow to a destination in the public IP address space, Azure dynamically maps the private IP address to a public IP address.</span></span> <span data-ttu-id="c6cb9-110">After this mapping is created, return traffic for this outbound originated flow can also reach the private IP address where the flow originated.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-110">After this mapping is created, return traffic for this outbound originated flow can also reach the private IP address where the flow originated.</span></span>

<span data-ttu-id="c6cb9-111">Azure uses source network address translation (SNAT) to perform this function.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-111">Azure uses source network address translation (SNAT) to perform this function.</span></span> <span data-ttu-id="c6cb9-112">When multiple private IP addresses are masquerading behind a single public IP address, Azure uses [port address translation (PAT)](#pat) to masquerade private IP addresses.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-112">When multiple private IP addresses are masquerading behind a single public IP address, Azure uses [port address translation (PAT)](#pat) to masquerade private IP addresses.</span></span> <span data-ttu-id="c6cb9-113">Ephemeral ports are used for PAT and are [preallocated](#preallocatedports) based on pool size.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-113">Ephemeral ports are used for PAT and are [preallocated](#preallocatedports) based on pool size.</span></span>

<span data-ttu-id="c6cb9-114">There are multiple [outbound scenarios](#scenarios).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-114">There are multiple [outbound scenarios](#scenarios).</span></span> <span data-ttu-id="c6cb9-115">You can combine these scenarios as needed.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-115">You can combine these scenarios as needed.</span></span> <span data-ttu-id="c6cb9-116">Review them carefully to understand the capabilities, constraints, and patterns as they apply to your deployment model and application scenario.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-116">Review them carefully to understand the capabilities, constraints, and patterns as they apply to your deployment model and application scenario.</span></span> <span data-ttu-id="c6cb9-117">Review guidance for [managing these scenarios](#snatexhaust).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-117">Review guidance for [managing these scenarios](#snatexhaust).</span></span>

>[!IMPORTANT] 
><span data-ttu-id="c6cb9-118">Standard Load Balancer introduces new abilities and different behaviors to outbound connectivity.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-118">Standard Load Balancer introduces new abilities and different behaviors to outbound connectivity.</span></span>   <span data-ttu-id="c6cb9-119">For example, [scenario 3](#defaultsnat) does not exist when an internal Standard Load Balancer is present and different steps need to be taken.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-119">For example, [scenario 3](#defaultsnat) does not exist when an internal Standard Load Balancer is present and different steps need to be taken.</span></span>   <span data-ttu-id="c6cb9-120">Carefully review this entire document to understand the overall concepts and differences between SKUs.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-120">Carefully review this entire document to understand the overall concepts and differences between SKUs.</span></span>

## <a name="scenarios"></a><span data-ttu-id="c6cb9-121">Scenario overview</span><span class="sxs-lookup"><span data-stu-id="c6cb9-121">Scenario overview</span></span>

<span data-ttu-id="c6cb9-122">Azure Load Balancer and related resources are explicitly defined when you're using [Azure Resource Manager](#arm).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-122">Azure Load Balancer and related resources are explicitly defined when you're using [Azure Resource Manager](#arm).</span></span>  <span data-ttu-id="c6cb9-123">Azure currently provides three different methods to achieve outbound connectivity for Azure Resource Manager resources.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-123">Azure currently provides three different methods to achieve outbound connectivity for Azure Resource Manager resources.</span></span> 

| <span data-ttu-id="c6cb9-124">Scenario</span><span class="sxs-lookup"><span data-stu-id="c6cb9-124">Scenario</span></span> | <span data-ttu-id="c6cb9-125">Method</span><span class="sxs-lookup"><span data-stu-id="c6cb9-125">Method</span></span> | <span data-ttu-id="c6cb9-126">IP protocols</span><span class="sxs-lookup"><span data-stu-id="c6cb9-126">IP protocols</span></span> | <span data-ttu-id="c6cb9-127">Description</span><span class="sxs-lookup"><span data-stu-id="c6cb9-127">Description</span></span> |
| --- | --- | --- | --- |
| [<span data-ttu-id="c6cb9-128">1. VM with an Instance Level Public IP address (with or without Load Balancer)</span><span class="sxs-lookup"><span data-stu-id="c6cb9-128">1. VM with an Instance Level Public IP address (with or without Load Balancer)</span></span>](#ilpip) | <span data-ttu-id="c6cb9-129">SNAT, port masquerading not used</span><span class="sxs-lookup"><span data-stu-id="c6cb9-129">SNAT, port masquerading not used</span></span> | <span data-ttu-id="c6cb9-130">TCP, UDP, ICMP, ESP</span><span class="sxs-lookup"><span data-stu-id="c6cb9-130">TCP, UDP, ICMP, ESP</span></span> | <span data-ttu-id="c6cb9-131">Azure uses the public IP assigned to the IP configuration of the instance's NIC.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-131">Azure uses the public IP assigned to the IP configuration of the instance's NIC.</span></span> <span data-ttu-id="c6cb9-132">The instance has all ephemeral ports available.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-132">The instance has all ephemeral ports available.</span></span> |
| [<span data-ttu-id="c6cb9-133">2. Public Load Balancer associated with a VM (no Instance Level Public IP address on the instance)</span><span class="sxs-lookup"><span data-stu-id="c6cb9-133">2. Public Load Balancer associated with a VM (no Instance Level Public IP address on the instance)</span></span>](#lb) | <span data-ttu-id="c6cb9-134">SNAT with port masquerading (PAT) using the Load Balancer frontends</span><span class="sxs-lookup"><span data-stu-id="c6cb9-134">SNAT with port masquerading (PAT) using the Load Balancer frontends</span></span> | <span data-ttu-id="c6cb9-135">TCP, UDP</span><span class="sxs-lookup"><span data-stu-id="c6cb9-135">TCP, UDP</span></span> |<span data-ttu-id="c6cb9-136">Azure shares the public IP address of the public Load Balancer frontends with multiple private IP addresses.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-136">Azure shares the public IP address of the public Load Balancer frontends with multiple private IP addresses.</span></span> <span data-ttu-id="c6cb9-137">Azure uses ephemeral ports of the frontends to PAT.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-137">Azure uses ephemeral ports of the frontends to PAT.</span></span> |
| [<span data-ttu-id="c6cb9-138">3. Standalone VM (no Load Balancer, no Instance Level Public IP address)</span><span class="sxs-lookup"><span data-stu-id="c6cb9-138">3. Standalone VM (no Load Balancer, no Instance Level Public IP address)</span></span>](#defaultsnat) | <span data-ttu-id="c6cb9-139">SNAT with port masquerading (PAT)</span><span class="sxs-lookup"><span data-stu-id="c6cb9-139">SNAT with port masquerading (PAT)</span></span> | <span data-ttu-id="c6cb9-140">TCP, UDP</span><span class="sxs-lookup"><span data-stu-id="c6cb9-140">TCP, UDP</span></span> | <span data-ttu-id="c6cb9-141">Azure automatically designates a public IP address for SNAT, shares this public IP address with multiple private IP addresses of the availability set, and uses ephemeral ports of this public IP address.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-141">Azure automatically designates a public IP address for SNAT, shares this public IP address with multiple private IP addresses of the availability set, and uses ephemeral ports of this public IP address.</span></span> <span data-ttu-id="c6cb9-142">This is a fallback scenario for the preceding scenarios.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-142">This is a fallback scenario for the preceding scenarios.</span></span> <span data-ttu-id="c6cb9-143">We don't recommend it if you need visibility and control.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-143">We don't recommend it if you need visibility and control.</span></span> |

<span data-ttu-id="c6cb9-144">If you don't want a VM to communicate with endpoints outside Azure in public IP address space, you can use network security groups (NSGs) to block access as needed.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-144">If you don't want a VM to communicate with endpoints outside Azure in public IP address space, you can use network security groups (NSGs) to block access as needed.</span></span> <span data-ttu-id="c6cb9-145">The section [Preventing outbound connectivity](#preventoutbound) discusses NSGs in more detail.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-145">The section [Preventing outbound connectivity](#preventoutbound) discusses NSGs in more detail.</span></span> <span data-ttu-id="c6cb9-146">Guidance on designing, implementing, and managing a virtual network without any outbound access is outside the scope of this article.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-146">Guidance on designing, implementing, and managing a virtual network without any outbound access is outside the scope of this article.</span></span>

### <a name="ilpip"></a><span data-ttu-id="c6cb9-147">Scenario 1: VM with an Instance Level Public IP address</span><span class="sxs-lookup"><span data-stu-id="c6cb9-147">Scenario 1: VM with an Instance Level Public IP address</span></span>

<span data-ttu-id="c6cb9-148">In this scenario, the VM has an Instance Level Public IP (ILPIP) assigned to it.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-148">In this scenario, the VM has an Instance Level Public IP (ILPIP) assigned to it.</span></span> <span data-ttu-id="c6cb9-149">As far as outbound connections are concerned, it doesn't matter whether the VM is load balanced or not.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-149">As far as outbound connections are concerned, it doesn't matter whether the VM is load balanced or not.</span></span> <span data-ttu-id="c6cb9-150">This scenario takes precedence over the others.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-150">This scenario takes precedence over the others.</span></span> <span data-ttu-id="c6cb9-151">When an ILPIP is used, the VM uses the ILPIP for all outbound flows.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-151">When an ILPIP is used, the VM uses the ILPIP for all outbound flows.</span></span>  

<span data-ttu-id="c6cb9-152">A public IP assigned to a VM is a 1:1 relationship (rather than 1:many) and implemented as a stateless 1:1 NAT.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-152">A public IP assigned to a VM is a 1:1 relationship (rather than 1:many) and implemented as a stateless 1:1 NAT.</span></span>  <span data-ttu-id="c6cb9-153">Port masquerading (PAT) is not used, and the VM has all ephemeral ports available for use.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-153">Port masquerading (PAT) is not used, and the VM has all ephemeral ports available for use.</span></span>

<span data-ttu-id="c6cb9-154">If your application initiates many outbound flows and you experience SNAT port exhaustion, consider assigning an [ILPIP to mitigate SNAT constraints](#assignilpip).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-154">If your application initiates many outbound flows and you experience SNAT port exhaustion, consider assigning an [ILPIP to mitigate SNAT constraints](#assignilpip).</span></span> <span data-ttu-id="c6cb9-155">Review [Managing SNAT exhaustion](#snatexhaust) in its entirety.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-155">Review [Managing SNAT exhaustion](#snatexhaust) in its entirety.</span></span>

### <a name="lb"></a><span data-ttu-id="c6cb9-156">Scenario 2: Load-balanced VM without an Instance Level Public IP address</span><span class="sxs-lookup"><span data-stu-id="c6cb9-156">Scenario 2: Load-balanced VM without an Instance Level Public IP address</span></span>

<span data-ttu-id="c6cb9-157">In this scenario, the VM is part of a public Load Balancer backend pool.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-157">In this scenario, the VM is part of a public Load Balancer backend pool.</span></span> <span data-ttu-id="c6cb9-158">The VM does not have a public IP address assigned to it.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-158">The VM does not have a public IP address assigned to it.</span></span> <span data-ttu-id="c6cb9-159">The Load Balancer resource must be configured with a load balancer rule to create a link between the public IP frontend with the backend pool.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-159">The Load Balancer resource must be configured with a load balancer rule to create a link between the public IP frontend with the backend pool.</span></span>

<span data-ttu-id="c6cb9-160">If you do not complete this rule configuration, the behavior is as described in the scenario for [Standalone VM with no Instance Level Public IP](#defaultsnat).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-160">If you do not complete this rule configuration, the behavior is as described in the scenario for [Standalone VM with no Instance Level Public IP](#defaultsnat).</span></span> <span data-ttu-id="c6cb9-161">It is not necessary for the rule to have a working listener in the backend pool for the health probe to succeed.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-161">It is not necessary for the rule to have a working listener in the backend pool for the health probe to succeed.</span></span>

<span data-ttu-id="c6cb9-162">When the load-balanced VM creates an outbound flow, Azure translates the private source IP address of the outbound flow to the public IP address of the public Load Balancer frontend.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-162">When the load-balanced VM creates an outbound flow, Azure translates the private source IP address of the outbound flow to the public IP address of the public Load Balancer frontend.</span></span> <span data-ttu-id="c6cb9-163">Azure uses SNAT to perform this function.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-163">Azure uses SNAT to perform this function.</span></span> <span data-ttu-id="c6cb9-164">Azure also uses [PAT](#pat) to masquerade multiple private IP addresses behind a public IP address.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-164">Azure also uses [PAT](#pat) to masquerade multiple private IP addresses behind a public IP address.</span></span> 

<span data-ttu-id="c6cb9-165">Ephemeral ports of the load balancer's public IP address frontend are used to distinguish individual flows originated by the VM.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-165">Ephemeral ports of the load balancer's public IP address frontend are used to distinguish individual flows originated by the VM.</span></span> <span data-ttu-id="c6cb9-166">SNAT dynamically uses [preallocated ephemeral ports](#preallocatedports) when outbound flows are created.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-166">SNAT dynamically uses [preallocated ephemeral ports](#preallocatedports) when outbound flows are created.</span></span> <span data-ttu-id="c6cb9-167">In this context, the ephemeral ports used for SNAT are called SNAT ports.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-167">In this context, the ephemeral ports used for SNAT are called SNAT ports.</span></span>

<span data-ttu-id="c6cb9-168">SNAT ports are preallocated as described in the [Understanding SNAT and PAT](#snat) section.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-168">SNAT ports are preallocated as described in the [Understanding SNAT and PAT](#snat) section.</span></span> <span data-ttu-id="c6cb9-169">They're a finite resource that can be exhausted.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-169">They're a finite resource that can be exhausted.</span></span> <span data-ttu-id="c6cb9-170">It's important to understand how they are [consumed](#pat).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-170">It's important to understand how they are [consumed](#pat).</span></span> <span data-ttu-id="c6cb9-171">To understand how to design for this consumption and mitigate as necessary, review [Managing SNAT exhaustion](#snatexhaust).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-171">To understand how to design for this consumption and mitigate as necessary, review [Managing SNAT exhaustion](#snatexhaust).</span></span>

<span data-ttu-id="c6cb9-172">When [multiple (public) IP addresses are associated with Load Balancer Basic](load-balancer-multivip-overview.md), any of these public IP addresses are a [candidate for outbound flows](#multivipsnat), and one is selected.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-172">When [multiple (public) IP addresses are associated with Load Balancer Basic](load-balancer-multivip-overview.md), any of these public IP addresses are a [candidate for outbound flows](#multivipsnat), and one is selected.</span></span>  

<span data-ttu-id="c6cb9-173">To monitor the health of outbound connections with Load Balancer Basic, you can use [Log Analytics for Load Balancer](load-balancer-monitor-log.md) and [alert event logs](load-balancer-monitor-log.md#alert-event-log) to monitor for SNAT port exhaustion messages.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-173">To monitor the health of outbound connections with Load Balancer Basic, you can use [Log Analytics for Load Balancer](load-balancer-monitor-log.md) and [alert event logs](load-balancer-monitor-log.md#alert-event-log) to monitor for SNAT port exhaustion messages.</span></span>

### <a name="defaultsnat"></a><span data-ttu-id="c6cb9-174">Scenario 3: Standalone VM without an Instance Level Public IP address</span><span class="sxs-lookup"><span data-stu-id="c6cb9-174">Scenario 3: Standalone VM without an Instance Level Public IP address</span></span>

<span data-ttu-id="c6cb9-175">In this scenario, the VM is not part of a public Load Balancer pool (and not part of an internal Standard Load Balancer pool) and does not have an ILPIP address assigned to it.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-175">In this scenario, the VM is not part of a public Load Balancer pool (and not part of an internal Standard Load Balancer pool) and does not have an ILPIP address assigned to it.</span></span> <span data-ttu-id="c6cb9-176">When the VM creates an outbound flow, Azure translates the private source IP address of the outbound flow to a public source IP address.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-176">When the VM creates an outbound flow, Azure translates the private source IP address of the outbound flow to a public source IP address.</span></span> <span data-ttu-id="c6cb9-177">The public IP address used for this outbound flow is not configurable and does not count against the subscription's public IP resource limit.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-177">The public IP address used for this outbound flow is not configurable and does not count against the subscription's public IP resource limit.</span></span>

>[!IMPORTANT] 
><span data-ttu-id="c6cb9-178">This scenario also applies when __only__ an internal Basic Load Balancer is attached.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-178">This scenario also applies when __only__ an internal Basic Load Balancer is attached.</span></span> <span data-ttu-id="c6cb9-179">Scenario 3 is __not available__ when an internal Standard Load Balancer is attached to a VM.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-179">Scenario 3 is __not available__ when an internal Standard Load Balancer is attached to a VM.</span></span>  <span data-ttu-id="c6cb9-180">You must explicitly create [scenario 1](#ilpip) or [scenario 2](#lb) in addition to using an internal Standard Load Balancer.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-180">You must explicitly create [scenario 1](#ilpip) or [scenario 2](#lb) in addition to using an internal Standard Load Balancer.</span></span>

<span data-ttu-id="c6cb9-181">Azure uses SNAT with port masquerading ([PAT](#pat)) to perform this function.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-181">Azure uses SNAT with port masquerading ([PAT](#pat)) to perform this function.</span></span> <span data-ttu-id="c6cb9-182">This scenario is similar to [scenario 2](#lb), except there is no control over the IP address used.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-182">This scenario is similar to [scenario 2](#lb), except there is no control over the IP address used.</span></span> <span data-ttu-id="c6cb9-183">This is a fallback scenario for when scenarios 1 and 2 do not exist.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-183">This is a fallback scenario for when scenarios 1 and 2 do not exist.</span></span> <span data-ttu-id="c6cb9-184">We don't recommend this scenario if you want control over the outbound address.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-184">We don't recommend this scenario if you want control over the outbound address.</span></span> <span data-ttu-id="c6cb9-185">If outbound connections are a critical part of your application, you should choose another scenario.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-185">If outbound connections are a critical part of your application, you should choose another scenario.</span></span>

<span data-ttu-id="c6cb9-186">SNAT ports are preallocated as described in the [Understanding SNAT and PAT](#snat) section.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-186">SNAT ports are preallocated as described in the [Understanding SNAT and PAT](#snat) section.</span></span>  <span data-ttu-id="c6cb9-187">The number of VMs sharing an Availability Set determines which preallocation tier applies.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-187">The number of VMs sharing an Availability Set determines which preallocation tier applies.</span></span>  <span data-ttu-id="c6cb9-188">A standalone VM without an Availability Set is effectively a pool of 1 for the purposes of determining preallocation (1024 SNAT ports).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-188">A standalone VM without an Availability Set is effectively a pool of 1 for the purposes of determining preallocation (1024 SNAT ports).</span></span> <span data-ttu-id="c6cb9-189">SNAT ports are a finite resource that can be exhausted.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-189">SNAT ports are a finite resource that can be exhausted.</span></span> <span data-ttu-id="c6cb9-190">It's important to understand how they are [consumed](#pat).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-190">It's important to understand how they are [consumed](#pat).</span></span> <span data-ttu-id="c6cb9-191">To understand how to design for this consumption and mitigate as necessary, review [Managing SNAT exhaustion](#snatexhaust).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-191">To understand how to design for this consumption and mitigate as necessary, review [Managing SNAT exhaustion](#snatexhaust).</span></span>

### <a name="combinations"></a><span data-ttu-id="c6cb9-192">Multiple, combined scenarios</span><span class="sxs-lookup"><span data-stu-id="c6cb9-192">Multiple, combined scenarios</span></span>

<span data-ttu-id="c6cb9-193">You can combine the scenarios described in the preceding sections to achieve a particular outcome.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-193">You can combine the scenarios described in the preceding sections to achieve a particular outcome.</span></span> <span data-ttu-id="c6cb9-194">When multiple scenarios are present, an order of precedence applies: [scenario 1](#ilpip) takes precedence over [scenario 2](#lb) and [3](#defaultsnat).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-194">When multiple scenarios are present, an order of precedence applies: [scenario 1](#ilpip) takes precedence over [scenario 2](#lb) and [3](#defaultsnat).</span></span> <span data-ttu-id="c6cb9-195">[Scenario 2](#lb) overrides [scenario 3](#defaultsnat).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-195">[Scenario 2](#lb) overrides [scenario 3](#defaultsnat).</span></span>

<span data-ttu-id="c6cb9-196">An example is an Azure Resource Manager deployment where the application relies heavily on outbound connections to a limited number of destinations but also receives inbound flows over a Load Balancer frontend.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-196">An example is an Azure Resource Manager deployment where the application relies heavily on outbound connections to a limited number of destinations but also receives inbound flows over a Load Balancer frontend.</span></span> <span data-ttu-id="c6cb9-197">In this case, you can combine scenarios 1 and 2 for relief.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-197">In this case, you can combine scenarios 1 and 2 for relief.</span></span> <span data-ttu-id="c6cb9-198">For additional patterns, review [Managing SNAT exhaustion](#snatexhaust).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-198">For additional patterns, review [Managing SNAT exhaustion](#snatexhaust).</span></span>

### <a name="multife"></a> <span data-ttu-id="c6cb9-199">Multiple frontends for outbound flows</span><span class="sxs-lookup"><span data-stu-id="c6cb9-199">Multiple frontends for outbound flows</span></span>

#### <a name="load-balancer-standard"></a><span data-ttu-id="c6cb9-200">Load Balancer Standard</span><span class="sxs-lookup"><span data-stu-id="c6cb9-200">Load Balancer Standard</span></span>

<span data-ttu-id="c6cb9-201">Load Balancer Standard uses all candidates for outbound flows at the same time when [multiple (public) IP frontends](load-balancer-multivip-overview.md) is present.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-201">Load Balancer Standard uses all candidates for outbound flows at the same time when [multiple (public) IP frontends](load-balancer-multivip-overview.md) is present.</span></span> <span data-ttu-id="c6cb9-202">Each frontend multiplies the number of available preallocated SNAT ports if a load balancing rule is enabled for outbound connections.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-202">Each frontend multiplies the number of available preallocated SNAT ports if a load balancing rule is enabled for outbound connections.</span></span>

<span data-ttu-id="c6cb9-203">You can choose to suppress a frontend IP address from being used for outbound connections with a new load balancing rule option:</span><span class="sxs-lookup"><span data-stu-id="c6cb9-203">You can choose to suppress a frontend IP address from being used for outbound connections with a new load balancing rule option:</span></span>

```json    
      "loadBalancingRules": [
        {
          "disableOutboundSnat": false
        }
      ]
```

<span data-ttu-id="c6cb9-204">Normally, this option defaults to _false_ and signifies that this rule programs outbound SNAT for the associated VMs in the backend pool of the load balancing rule.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-204">Normally, this option defaults to _false_ and signifies that this rule programs outbound SNAT for the associated VMs in the backend pool of the load balancing rule.</span></span>  <span data-ttu-id="c6cb9-205">This can be changed to _true_ to prevent Load Balancer from using the associated frontend IP address for outbound connections for the VM's in the backend pool of this load balancing rule.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-205">This can be changed to _true_ to prevent Load Balancer from using the associated frontend IP address for outbound connections for the VM's in the backend pool of this load balancing rule.</span></span>  <span data-ttu-id="c6cb9-206">And you can also still designate a specific IP address for outbound flows as described in [Multiple, combined scenarios](#combinations) as well.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-206">And you can also still designate a specific IP address for outbound flows as described in [Multiple, combined scenarios](#combinations) as well.</span></span>

#### <a name="load-balancer-basic"></a><span data-ttu-id="c6cb9-207">Load Balancer Basic</span><span class="sxs-lookup"><span data-stu-id="c6cb9-207">Load Balancer Basic</span></span>

<span data-ttu-id="c6cb9-208">Load Balancer Basic chooses a single frontend to be used for outbound flows when [multiple (public) IP frontends](load-balancer-multivip-overview.md) are candidates for outbound flows.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-208">Load Balancer Basic chooses a single frontend to be used for outbound flows when [multiple (public) IP frontends](load-balancer-multivip-overview.md) are candidates for outbound flows.</span></span> <span data-ttu-id="c6cb9-209">This selection is not configurable, and you should consider the selection algorithm to be random.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-209">This selection is not configurable, and you should consider the selection algorithm to be random.</span></span> <span data-ttu-id="c6cb9-210">You can designate a specific IP address for outbound flows as described in [Multiple, combined scenarios](#combinations).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-210">You can designate a specific IP address for outbound flows as described in [Multiple, combined scenarios](#combinations).</span></span>

### <a name="az"></a> <span data-ttu-id="c6cb9-211">Availability Zones</span><span class="sxs-lookup"><span data-stu-id="c6cb9-211">Availability Zones</span></span>

<span data-ttu-id="c6cb9-212">When using [Standard Load Balancer with Availability Zones](load-balancer-standard-availability-zones.md), zone-redundant frontends can provide zone-redundant outbound SNAT connections and SNAT programming survives zone failure.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-212">When using [Standard Load Balancer with Availability Zones](load-balancer-standard-availability-zones.md), zone-redundant frontends can provide zone-redundant outbound SNAT connections and SNAT programming survives zone failure.</span></span>  <span data-ttu-id="c6cb9-213">When zonal frontends are used, outbound SNAT connections share fate with the zone they belong to.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-213">When zonal frontends are used, outbound SNAT connections share fate with the zone they belong to.</span></span>

## <a name="snat"></a><span data-ttu-id="c6cb9-214">Understanding SNAT and PAT</span><span class="sxs-lookup"><span data-stu-id="c6cb9-214">Understanding SNAT and PAT</span></span>

### <a name="pat"></a><span data-ttu-id="c6cb9-215">Port masquerading SNAT (PAT)</span><span class="sxs-lookup"><span data-stu-id="c6cb9-215">Port masquerading SNAT (PAT)</span></span>

<span data-ttu-id="c6cb9-216">When a public Load Balancer resource is associated with VM instances, each outbound connection source is rewritten.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-216">When a public Load Balancer resource is associated with VM instances, each outbound connection source is rewritten.</span></span> <span data-ttu-id="c6cb9-217">The source is rewritten from the virtual network private IP address space to the frontend Public IP address of the load balancer.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-217">The source is rewritten from the virtual network private IP address space to the frontend Public IP address of the load balancer.</span></span> <span data-ttu-id="c6cb9-218">In the public IP address space, the 5-tuple of the flow (source IP address, source port, IP transport protocol, destination IP address, destination port) must be unique.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-218">In the public IP address space, the 5-tuple of the flow (source IP address, source port, IP transport protocol, destination IP address, destination port) must be unique.</span></span>  <span data-ttu-id="c6cb9-219">Port masquerading SNAT can be used with either TCP or UDP IP protocols.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-219">Port masquerading SNAT can be used with either TCP or UDP IP protocols.</span></span>

<span data-ttu-id="c6cb9-220">Ephemeral ports (SNAT ports) are used to achieve this after rewriting the private source IP address, because multiple flows originate from a single public IP address.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-220">Ephemeral ports (SNAT ports) are used to achieve this after rewriting the private source IP address, because multiple flows originate from a single public IP address.</span></span> <span data-ttu-id="c6cb9-221">The port masquerading SNAT algorithm allocates SNAT ports differently for UDP versus TCP.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-221">The port masquerading SNAT algorithm allocates SNAT ports differently for UDP versus TCP.</span></span>

#### <a name="tcp"></a><span data-ttu-id="c6cb9-222">TCP SNAT Ports</span><span class="sxs-lookup"><span data-stu-id="c6cb9-222">TCP SNAT Ports</span></span>

<span data-ttu-id="c6cb9-223">One SNAT port is consumed per flow to a single destination IP address, port.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-223">One SNAT port is consumed per flow to a single destination IP address, port.</span></span> <span data-ttu-id="c6cb9-224">For multiple TCP flows to the same destination IP address, port, and protocol, each TCP flow consumes a single SNAT port.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-224">For multiple TCP flows to the same destination IP address, port, and protocol, each TCP flow consumes a single SNAT port.</span></span> <span data-ttu-id="c6cb9-225">This ensures that the flows are unique when they originate from the same public IP address and go to the same destination IP address, port, and protocol.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-225">This ensures that the flows are unique when they originate from the same public IP address and go to the same destination IP address, port, and protocol.</span></span> 

<span data-ttu-id="c6cb9-226">Multiple flows, each to a different destination IP address, port, and protocol, share a single SNAT port.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-226">Multiple flows, each to a different destination IP address, port, and protocol, share a single SNAT port.</span></span> <span data-ttu-id="c6cb9-227">The destination IP address, port, and protocol make flows unique without the need for additional source ports to distinguish flows in the public IP address space.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-227">The destination IP address, port, and protocol make flows unique without the need for additional source ports to distinguish flows in the public IP address space.</span></span>

#### <a name="udp"></a> <span data-ttu-id="c6cb9-228">UDP SNAT Ports</span><span class="sxs-lookup"><span data-stu-id="c6cb9-228">UDP SNAT Ports</span></span>

<span data-ttu-id="c6cb9-229">UDP SNAT ports are managed by a different algorithm than TCP SNAT ports.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-229">UDP SNAT ports are managed by a different algorithm than TCP SNAT ports.</span></span>  <span data-ttu-id="c6cb9-230">Load Balancer uses an algorithm known as "port-restricted cone NAT" for UDP.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-230">Load Balancer uses an algorithm known as "port-restricted cone NAT" for UDP.</span></span>  <span data-ttu-id="c6cb9-231">One SNAT port is consumed for each flow, irrespective of destination IP address, port.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-231">One SNAT port is consumed for each flow, irrespective of destination IP address, port.</span></span>

#### <a name="exhaustion"></a><span data-ttu-id="c6cb9-232">Exhaustion</span><span class="sxs-lookup"><span data-stu-id="c6cb9-232">Exhaustion</span></span>

<span data-ttu-id="c6cb9-233">When SNAT port resources are exhausted, outbound flows fail until existing flows release SNAT ports.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-233">When SNAT port resources are exhausted, outbound flows fail until existing flows release SNAT ports.</span></span> <span data-ttu-id="c6cb9-234">Load Balancer reclaims SNAT ports when the flow closes and uses a [4-minute idle timeout](#idletimeout) for reclaiming SNAT ports from idle flows.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-234">Load Balancer reclaims SNAT ports when the flow closes and uses a [4-minute idle timeout](#idletimeout) for reclaiming SNAT ports from idle flows.</span></span>

<span data-ttu-id="c6cb9-235">UDP SNAT ports generally exhaust much faster than TCP SNAT ports due to the difference in algorithm used.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-235">UDP SNAT ports generally exhaust much faster than TCP SNAT ports due to the difference in algorithm used.</span></span> <span data-ttu-id="c6cb9-236">You must design and scale test with this difference in mind.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-236">You must design and scale test with this difference in mind.</span></span>

<span data-ttu-id="c6cb9-237">For patterns to mitigate conditions that commonly lead to SNAT port exhaustion, review the [Managing SNAT](#snatexhaust) section.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-237">For patterns to mitigate conditions that commonly lead to SNAT port exhaustion, review the [Managing SNAT](#snatexhaust) section.</span></span>

### <a name="preallocatedports"></a><span data-ttu-id="c6cb9-238">Ephemeral port preallocation for port masquerading SNAT (PAT)</span><span class="sxs-lookup"><span data-stu-id="c6cb9-238">Ephemeral port preallocation for port masquerading SNAT (PAT)</span></span>

<span data-ttu-id="c6cb9-239">Azure uses an algorithm to determine the number of preallocated SNAT ports available based on the size of the backend pool when using port masquerading SNAT ([PAT](#pat)).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-239">Azure uses an algorithm to determine the number of preallocated SNAT ports available based on the size of the backend pool when using port masquerading SNAT ([PAT](#pat)).</span></span> <span data-ttu-id="c6cb9-240">SNAT ports are ephemeral ports available for a particular public IP source address.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-240">SNAT ports are ephemeral ports available for a particular public IP source address.</span></span>

<span data-ttu-id="c6cb9-241">The same number of SNAT ports are preallocated for UDP and TCP respectively and consumed independently per IP transport protocol.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-241">The same number of SNAT ports are preallocated for UDP and TCP respectively and consumed independently per IP transport protocol.</span></span>  <span data-ttu-id="c6cb9-242">However, the SNAT port usage is different depending on whether the flow is UDP or TCP.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-242">However, the SNAT port usage is different depending on whether the flow is UDP or TCP.</span></span>

>[!IMPORTANT]
><span data-ttu-id="c6cb9-243">Standard SKU SNAT programming is per IP transport protocol and derived from the load balancing rule.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-243">Standard SKU SNAT programming is per IP transport protocol and derived from the load balancing rule.</span></span>  <span data-ttu-id="c6cb9-244">If only a TCP load balancing rule exists, SNAT is only available for TCP.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-244">If only a TCP load balancing rule exists, SNAT is only available for TCP.</span></span> <span data-ttu-id="c6cb9-245">If you have only a TCP load balancing rule and need outbound SNAT for UDP, create a UDP load balancing rule from the same frontend to the same backend pool.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-245">If you have only a TCP load balancing rule and need outbound SNAT for UDP, create a UDP load balancing rule from the same frontend to the same backend pool.</span></span>  <span data-ttu-id="c6cb9-246">This will trigger SNAT programming for UDP.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-246">This will trigger SNAT programming for UDP.</span></span>  <span data-ttu-id="c6cb9-247">A working rule or health probe is not required.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-247">A working rule or health probe is not required.</span></span>  <span data-ttu-id="c6cb9-248">Basic SKU SNAT always programs SNAT for both IP transport protocol, irrespective of the transport protocol specified in the load balancing rule.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-248">Basic SKU SNAT always programs SNAT for both IP transport protocol, irrespective of the transport protocol specified in the load balancing rule.</span></span>

<span data-ttu-id="c6cb9-249">Azure preallocates SNAT ports to the IP configuration of the NIC of each VM.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-249">Azure preallocates SNAT ports to the IP configuration of the NIC of each VM.</span></span> <span data-ttu-id="c6cb9-250">When an IP configuration is added to the pool, the SNAT ports are preallocated for this IP configuration based on the backend pool size.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-250">When an IP configuration is added to the pool, the SNAT ports are preallocated for this IP configuration based on the backend pool size.</span></span> <span data-ttu-id="c6cb9-251">When outbound flows are created, [PAT](#pat) dynamically consumes (up to the preallocated limit) and releases these ports when the flow closes or [idle timeouts](#idletimeout) happen.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-251">When outbound flows are created, [PAT](#pat) dynamically consumes (up to the preallocated limit) and releases these ports when the flow closes or [idle timeouts](#idletimeout) happen.</span></span>

<span data-ttu-id="c6cb9-252">The following table shows the SNAT port preallocations for tiers of backend pool sizes:</span><span class="sxs-lookup"><span data-stu-id="c6cb9-252">The following table shows the SNAT port preallocations for tiers of backend pool sizes:</span></span>

| <span data-ttu-id="c6cb9-253">Pool size (VM instances)</span><span class="sxs-lookup"><span data-stu-id="c6cb9-253">Pool size (VM instances)</span></span> | <span data-ttu-id="c6cb9-254">Preallocated SNAT ports per IP configuration</span><span class="sxs-lookup"><span data-stu-id="c6cb9-254">Preallocated SNAT ports per IP configuration</span></span>|
| --- | --- |
| <span data-ttu-id="c6cb9-255">1-50</span><span class="sxs-lookup"><span data-stu-id="c6cb9-255">1-50</span></span> | <span data-ttu-id="c6cb9-256">1,024</span><span class="sxs-lookup"><span data-stu-id="c6cb9-256">1,024</span></span> |
| <span data-ttu-id="c6cb9-257">51-100</span><span class="sxs-lookup"><span data-stu-id="c6cb9-257">51-100</span></span> | <span data-ttu-id="c6cb9-258">512</span><span class="sxs-lookup"><span data-stu-id="c6cb9-258">512</span></span> |
| <span data-ttu-id="c6cb9-259">101-200</span><span class="sxs-lookup"><span data-stu-id="c6cb9-259">101-200</span></span> | <span data-ttu-id="c6cb9-260">256</span><span class="sxs-lookup"><span data-stu-id="c6cb9-260">256</span></span> |
| <span data-ttu-id="c6cb9-261">201-400</span><span class="sxs-lookup"><span data-stu-id="c6cb9-261">201-400</span></span> | <span data-ttu-id="c6cb9-262">128</span><span class="sxs-lookup"><span data-stu-id="c6cb9-262">128</span></span> |
| <span data-ttu-id="c6cb9-263">401-800</span><span class="sxs-lookup"><span data-stu-id="c6cb9-263">401-800</span></span> | <span data-ttu-id="c6cb9-264">64</span><span class="sxs-lookup"><span data-stu-id="c6cb9-264">64</span></span> |
| <span data-ttu-id="c6cb9-265">801-1,000</span><span class="sxs-lookup"><span data-stu-id="c6cb9-265">801-1,000</span></span> | <span data-ttu-id="c6cb9-266">32</span><span class="sxs-lookup"><span data-stu-id="c6cb9-266">32</span></span> |

>[!NOTE]
> <span data-ttu-id="c6cb9-267">When using Standard Load Balancer with [multiple frontends](load-balancer-multivip-overview.md), [each frontend IP address multiplies the number of available SNAT ports](#multivipsnat) in the previous table.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-267">When using Standard Load Balancer with [multiple frontends](load-balancer-multivip-overview.md), [each frontend IP address multiplies the number of available SNAT ports](#multivipsnat) in the previous table.</span></span> <span data-ttu-id="c6cb9-268">For example, a backend pool of 50 VM's with 2 load balancing rules, each with a separate frontend IP address, will use 2048 (2x 1024) SNAT ports per IP configuration.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-268">For example, a backend pool of 50 VM's with 2 load balancing rules, each with a separate frontend IP address, will use 2048 (2x 1024) SNAT ports per IP configuration.</span></span> <span data-ttu-id="c6cb9-269">See details for [multiple frontends](#multife).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-269">See details for [multiple frontends](#multife).</span></span>

<span data-ttu-id="c6cb9-270">Remember that the number of SNAT ports available does not translate directly to number of flows.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-270">Remember that the number of SNAT ports available does not translate directly to number of flows.</span></span> <span data-ttu-id="c6cb9-271">A single SNAT port can be reused for multiple unique destinations.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-271">A single SNAT port can be reused for multiple unique destinations.</span></span> <span data-ttu-id="c6cb9-272">Ports are consumed only if it's necessary to make flows unique.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-272">Ports are consumed only if it's necessary to make flows unique.</span></span> <span data-ttu-id="c6cb9-273">For design and mitigation guidance, refer to the section about [how to manage this exhaustible resource](#snatexhaust) and the section that describes [PAT](#pat).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-273">For design and mitigation guidance, refer to the section about [how to manage this exhaustible resource](#snatexhaust) and the section that describes [PAT](#pat).</span></span>

<span data-ttu-id="c6cb9-274">Changing the size of your backend pool might affect some of your established flows.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-274">Changing the size of your backend pool might affect some of your established flows.</span></span> <span data-ttu-id="c6cb9-275">If the backend pool size increases and transitions into the next tier, half of your preallocated SNAT ports are reclaimed during the transition to the next larger backend pool tier.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-275">If the backend pool size increases and transitions into the next tier, half of your preallocated SNAT ports are reclaimed during the transition to the next larger backend pool tier.</span></span> <span data-ttu-id="c6cb9-276">Flows that are associated with a reclaimed SNAT port will time out and must be reestablished.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-276">Flows that are associated with a reclaimed SNAT port will time out and must be reestablished.</span></span> <span data-ttu-id="c6cb9-277">If a new flow is attempted, the flow will succeed immediately as long as preallocated ports are available.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-277">If a new flow is attempted, the flow will succeed immediately as long as preallocated ports are available.</span></span>

<span data-ttu-id="c6cb9-278">If the backend pool size decreases and transitions into a lower tier, the number of available SNAT ports increases.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-278">If the backend pool size decreases and transitions into a lower tier, the number of available SNAT ports increases.</span></span> <span data-ttu-id="c6cb9-279">In this case, existing allocated SNAT ports and their respective flows are not affected.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-279">In this case, existing allocated SNAT ports and their respective flows are not affected.</span></span>

<span data-ttu-id="c6cb9-280">SNAT ports allocations are IP transport protocol specific (TCP and UDP are maintained separately) and are released under the following conditions:</span><span class="sxs-lookup"><span data-stu-id="c6cb9-280">SNAT ports allocations are IP transport protocol specific (TCP and UDP are maintained separately) and are released under the following conditions:</span></span>

### <a name="tcp-snat-port-release"></a><span data-ttu-id="c6cb9-281">TCP SNAT port release</span><span class="sxs-lookup"><span data-stu-id="c6cb9-281">TCP SNAT port release</span></span>

- <span data-ttu-id="c6cb9-282">If both server/client sends FIN/ACK, SNAT port will be released after 240 seconds.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-282">If both server/client sends FIN/ACK, SNAT port will be released after 240 seconds.</span></span>
- <span data-ttu-id="c6cb9-283">If a RST is seen, SNAT port will be released after 15 seconds.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-283">If a RST is seen, SNAT port will be released after 15 seconds.</span></span>
- <span data-ttu-id="c6cb9-284">idle timeout has been reached</span><span class="sxs-lookup"><span data-stu-id="c6cb9-284">idle timeout has been reached</span></span>

### <a name="udp-snat-port-release"></a><span data-ttu-id="c6cb9-285">UDP SNAT port release</span><span class="sxs-lookup"><span data-stu-id="c6cb9-285">UDP SNAT port release</span></span>

- <span data-ttu-id="c6cb9-286">idle timeout has been reached</span><span class="sxs-lookup"><span data-stu-id="c6cb9-286">idle timeout has been reached</span></span>

## <a name="problemsolving"></a> <span data-ttu-id="c6cb9-287">Problem solving</span><span class="sxs-lookup"><span data-stu-id="c6cb9-287">Problem solving</span></span> 

<span data-ttu-id="c6cb9-288">This section is intended to help mitigate SNAT exhaustion and other scenarios which can occur with outbound connections in Azure.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-288">This section is intended to help mitigate SNAT exhaustion and other scenarios which can occur with outbound connections in Azure.</span></span>

### <a name="snatexhaust"></a> <span data-ttu-id="c6cb9-289">Managing SNAT (PAT) port exhaustion</span><span class="sxs-lookup"><span data-stu-id="c6cb9-289">Managing SNAT (PAT) port exhaustion</span></span>
<span data-ttu-id="c6cb9-290">[Ephemeral ports](#preallocatedports) used for [PAT](#pat) are an exhaustible resource, as described in [Standalone VM without an Instance Level Public IP address](#defaultsnat) and [Load-balanced VM without an Instance Level Public IP address](#lb).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-290">[Ephemeral ports](#preallocatedports) used for [PAT](#pat) are an exhaustible resource, as described in [Standalone VM without an Instance Level Public IP address](#defaultsnat) and [Load-balanced VM without an Instance Level Public IP address](#lb).</span></span>

<span data-ttu-id="c6cb9-291">If you know that you're initiating many outbound TCP or UDP connections to the same destination IP address and port, and you observe failing outbound connections or are advised by support that you're exhausting SNAT ports (preallocated [ephemeral ports](#preallocatedports) used by [PAT](#pat)), you have several general mitigation options.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-291">If you know that you're initiating many outbound TCP or UDP connections to the same destination IP address and port, and you observe failing outbound connections or are advised by support that you're exhausting SNAT ports (preallocated [ephemeral ports](#preallocatedports) used by [PAT](#pat)), you have several general mitigation options.</span></span> <span data-ttu-id="c6cb9-292">Review these options and decide what is available and best for your scenario.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-292">Review these options and decide what is available and best for your scenario.</span></span> <span data-ttu-id="c6cb9-293">It's possible that one or more can help manage this scenario.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-293">It's possible that one or more can help manage this scenario.</span></span>

<span data-ttu-id="c6cb9-294">If you are having trouble understanding the outbound connection behavior, you can use IP stack statistics (netstat).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-294">If you are having trouble understanding the outbound connection behavior, you can use IP stack statistics (netstat).</span></span> <span data-ttu-id="c6cb9-295">Or it can be helpful to observe connection behaviors by using packet captures.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-295">Or it can be helpful to observe connection behaviors by using packet captures.</span></span> <span data-ttu-id="c6cb9-296">You can perform these packet captures in the guest OS of your instance or use [Network Watcher for packet capture](../network-watcher/network-watcher-packet-capture-manage-portal.md).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-296">You can perform these packet captures in the guest OS of your instance or use [Network Watcher for packet capture](../network-watcher/network-watcher-packet-capture-manage-portal.md).</span></span>

#### <a name="connectionreuse"></a><span data-ttu-id="c6cb9-297">Modify the application to reuse connections</span><span class="sxs-lookup"><span data-stu-id="c6cb9-297">Modify the application to reuse connections</span></span> 
<span data-ttu-id="c6cb9-298">You can reduce demand for ephemeral ports that are used for SNAT by reusing connections in your application.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-298">You can reduce demand for ephemeral ports that are used for SNAT by reusing connections in your application.</span></span> <span data-ttu-id="c6cb9-299">This is especially true for protocols like HTTP/1.1, where connection reuse is the default.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-299">This is especially true for protocols like HTTP/1.1, where connection reuse is the default.</span></span> <span data-ttu-id="c6cb9-300">And other protocols that use HTTP as their transport (for example, REST) can benefit in turn.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-300">And other protocols that use HTTP as their transport (for example, REST) can benefit in turn.</span></span> 

<span data-ttu-id="c6cb9-301">Reuse is always better than individual, atomic TCP connections for each request.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-301">Reuse is always better than individual, atomic TCP connections for each request.</span></span> <span data-ttu-id="c6cb9-302">Reuse results in more performant, very efficient TCP transactions.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-302">Reuse results in more performant, very efficient TCP transactions.</span></span>

#### <a name="connection pooling"></a><span data-ttu-id="c6cb9-303">Modify the application to use connection pooling</span><span class="sxs-lookup"><span data-stu-id="c6cb9-303">Modify the application to use connection pooling</span></span>
<span data-ttu-id="c6cb9-304">You can employ a connection pooling scheme in your application, where requests are internally distributed across a fixed set of connections (each reusing where possible).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-304">You can employ a connection pooling scheme in your application, where requests are internally distributed across a fixed set of connections (each reusing where possible).</span></span> <span data-ttu-id="c6cb9-305">This scheme constrains the number of ephemeral ports in use and creates a more predictable environment.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-305">This scheme constrains the number of ephemeral ports in use and creates a more predictable environment.</span></span> <span data-ttu-id="c6cb9-306">This scheme can also increase the throughput of requests by allowing multiple simultaneous operations when a single connection is blocking on the reply of an operation.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-306">This scheme can also increase the throughput of requests by allowing multiple simultaneous operations when a single connection is blocking on the reply of an operation.</span></span>  

<span data-ttu-id="c6cb9-307">Connection pooling might already exist within the framework that you're using to develop your application or the configuration settings for your application.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-307">Connection pooling might already exist within the framework that you're using to develop your application or the configuration settings for your application.</span></span> <span data-ttu-id="c6cb9-308">You can combine connection pooling with connection reuse.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-308">You can combine connection pooling with connection reuse.</span></span> <span data-ttu-id="c6cb9-309">Your multiple requests then consume a fixed, predictable number of ports to the same destination IP address and port.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-309">Your multiple requests then consume a fixed, predictable number of ports to the same destination IP address and port.</span></span> <span data-ttu-id="c6cb9-310">The requests also benefit from efficient use of TCP transactions reducing latency and resource utilization.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-310">The requests also benefit from efficient use of TCP transactions reducing latency and resource utilization.</span></span> <span data-ttu-id="c6cb9-311">UDP transactions can also benefit, because managing the number of UDP flows can in turn avoid exhaust conditions and manage the SNAT port utilization.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-311">UDP transactions can also benefit, because managing the number of UDP flows can in turn avoid exhaust conditions and manage the SNAT port utilization.</span></span>

#### <a name="retry logic"></a><span data-ttu-id="c6cb9-312">Modify the application to use less aggressive retry logic</span><span class="sxs-lookup"><span data-stu-id="c6cb9-312">Modify the application to use less aggressive retry logic</span></span>
<span data-ttu-id="c6cb9-313">When [preallocated ephemeral ports](#preallocatedports) used for [PAT](#pat) are exhausted or application failures occur, aggressive or brute force retries without decay and backoff logic cause exhaustion to occur or persist.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-313">When [preallocated ephemeral ports](#preallocatedports) used for [PAT](#pat) are exhausted or application failures occur, aggressive or brute force retries without decay and backoff logic cause exhaustion to occur or persist.</span></span> <span data-ttu-id="c6cb9-314">You can reduce demand for ephemeral ports by using a less aggressive retry logic.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-314">You can reduce demand for ephemeral ports by using a less aggressive retry logic.</span></span> 

<span data-ttu-id="c6cb9-315">Ephemeral ports have a 4-minute idle timeout (not adjustable).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-315">Ephemeral ports have a 4-minute idle timeout (not adjustable).</span></span> <span data-ttu-id="c6cb9-316">If the retries are too aggressive, the exhaustion has no opportunity to clear up on its own.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-316">If the retries are too aggressive, the exhaustion has no opportunity to clear up on its own.</span></span> <span data-ttu-id="c6cb9-317">Therefore, considering how--and how often--your application retries transactions is a critical part of the design.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-317">Therefore, considering how--and how often--your application retries transactions is a critical part of the design.</span></span>

#### <a name="assignilpip"></a><span data-ttu-id="c6cb9-318">Assign an Instance Level Public IP to each VM</span><span class="sxs-lookup"><span data-stu-id="c6cb9-318">Assign an Instance Level Public IP to each VM</span></span>
<span data-ttu-id="c6cb9-319">Assigning an ILPIP changes your scenario to [Instance Level Public IP to a VM](#ilpip).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-319">Assigning an ILPIP changes your scenario to [Instance Level Public IP to a VM](#ilpip).</span></span> <span data-ttu-id="c6cb9-320">All ephemeral ports of the public IP that are used for each VM are available to the VM.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-320">All ephemeral ports of the public IP that are used for each VM are available to the VM.</span></span> <span data-ttu-id="c6cb9-321">(As opposed to scenarios where ephemeral ports of a public IP are shared with all the VMs associated with the respective backend pool.) There are trade-offs to consider, such as the additional cost of public IP addresses and the potential impact of whitelisting a large number of individual IP addresses.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-321">(As opposed to scenarios where ephemeral ports of a public IP are shared with all the VMs associated with the respective backend pool.) There are trade-offs to consider, such as the additional cost of public IP addresses and the potential impact of whitelisting a large number of individual IP addresses.</span></span>

>[!NOTE] 
><span data-ttu-id="c6cb9-322">This option is not available for web worker roles.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-322">This option is not available for web worker roles.</span></span>

#### <a name="multifesnat"></a><span data-ttu-id="c6cb9-323">Use multiple frontends</span><span class="sxs-lookup"><span data-stu-id="c6cb9-323">Use multiple frontends</span></span>

<span data-ttu-id="c6cb9-324">When using public Standard Load Balancer, you assign [multiple frontend IP addresses for outbound connections](#multife) and [multiply the number of SNAT ports available](#preallocatedports).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-324">When using public Standard Load Balancer, you assign [multiple frontend IP addresses for outbound connections](#multife) and [multiply the number of SNAT ports available](#preallocatedports).</span></span>  <span data-ttu-id="c6cb9-325">You need to create a frontend IP configuration, rule, and backend pool to trigger the programming of SNAT to the public IP of the frontend.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-325">You need to create a frontend IP configuration, rule, and backend pool to trigger the programming of SNAT to the public IP of the frontend.</span></span>  <span data-ttu-id="c6cb9-326">The rule does not need to function and a health probe does not need to succeed.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-326">The rule does not need to function and a health probe does not need to succeed.</span></span>  <span data-ttu-id="c6cb9-327">If you do use multiple frontends for inbound as well (rather than just for outbound), you should use custom health probes well to ensure reliability.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-327">If you do use multiple frontends for inbound as well (rather than just for outbound), you should use custom health probes well to ensure reliability.</span></span>

>[!NOTE]
><span data-ttu-id="c6cb9-328">In most cases, exhaustion of SNAT ports is a sign of bad design.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-328">In most cases, exhaustion of SNAT ports is a sign of bad design.</span></span>  <span data-ttu-id="c6cb9-329">Make sure you understand why you are exhausting ports before using more frontends to add SNAT ports.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-329">Make sure you understand why you are exhausting ports before using more frontends to add SNAT ports.</span></span>  <span data-ttu-id="c6cb9-330">You may be masking a problem which can lead to failure later.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-330">You may be masking a problem which can lead to failure later.</span></span>

#### <a name="scaleout"></a><span data-ttu-id="c6cb9-331">Scale out</span><span class="sxs-lookup"><span data-stu-id="c6cb9-331">Scale out</span></span>

<span data-ttu-id="c6cb9-332">[Preallocated ports](#preallocatedports) are assigned based on the backend pool size and grouped into tiers to minimize disruption when some of the ports have to be reallocated to accommodate the next larger backend pool size tier.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-332">[Preallocated ports](#preallocatedports) are assigned based on the backend pool size and grouped into tiers to minimize disruption when some of the ports have to be reallocated to accommodate the next larger backend pool size tier.</span></span>  <span data-ttu-id="c6cb9-333">You may have an option to increase the intensity of SNAT port utilization for a given frontend by scaling your backend pool to the maximum size for a given tier.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-333">You may have an option to increase the intensity of SNAT port utilization for a given frontend by scaling your backend pool to the maximum size for a given tier.</span></span>  <span data-ttu-id="c6cb9-334">This requires for the application to scale out efficiently.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-334">This requires for the application to scale out efficiently.</span></span>

<span data-ttu-id="c6cb9-335">For example, 2 virtual machines in the backend pool would have 1024 SNAT ports available per IP configuration, allowing a total of 2048 SNAT ports for the deployment.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-335">For example, 2 virtual machines in the backend pool would have 1024 SNAT ports available per IP configuration, allowing a total of 2048 SNAT ports for the deployment.</span></span>  <span data-ttu-id="c6cb9-336">If the deployment were to be increased to 50 virtual machines, even though the number of preallocated ports remains constant per virtual machine, a total of 51,200 (50 x 1024) SNAT ports can be used by the deployment.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-336">If the deployment were to be increased to 50 virtual machines, even though the number of preallocated ports remains constant per virtual machine, a total of 51,200 (50 x 1024) SNAT ports can be used by the deployment.</span></span>  <span data-ttu-id="c6cb9-337">If you wish to scale out your deployment, check the number of [preallocated ports](#preallocatedports) per tier to make sure you shape your scale out to the maximum for the respective tier.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-337">If you wish to scale out your deployment, check the number of [preallocated ports](#preallocatedports) per tier to make sure you shape your scale out to the maximum for the respective tier.</span></span>  <span data-ttu-id="c6cb9-338">In the preceding example, if you had chosen to scale out to 51 instead of 50 instances, you would progress to the next tier and end up with fewer SNAT ports per VM as well as in total.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-338">In the preceding example, if you had chosen to scale out to 51 instead of 50 instances, you would progress to the next tier and end up with fewer SNAT ports per VM as well as in total.</span></span>

<span data-ttu-id="c6cb9-339">If you scale out to the next larger backend pool size tier, there is potential for some of your outbound connections to time out if allocated ports have to be reallocated.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-339">If you scale out to the next larger backend pool size tier, there is potential for some of your outbound connections to time out if allocated ports have to be reallocated.</span></span>  <span data-ttu-id="c6cb9-340">If you are only using some of your SNAT ports, scaling out across the next larger backend pool size is inconsequential.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-340">If you are only using some of your SNAT ports, scaling out across the next larger backend pool size is inconsequential.</span></span>  <span data-ttu-id="c6cb9-341">Half the existing ports will be reallocated each time you move to the next backend pool tier.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-341">Half the existing ports will be reallocated each time you move to the next backend pool tier.</span></span>  <span data-ttu-id="c6cb9-342">If you don't want this to take place, you need to shape your deployment to the tier size.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-342">If you don't want this to take place, you need to shape your deployment to the tier size.</span></span>  <span data-ttu-id="c6cb9-343">Or make sure your application can detect and retry as necessary.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-343">Or make sure your application can detect and retry as necessary.</span></span>  <span data-ttu-id="c6cb9-344">TCP keepalives can assist in detect when SNAT ports no longer function due to being reallocated.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-344">TCP keepalives can assist in detect when SNAT ports no longer function due to being reallocated.</span></span>

### <a name="idletimeout"></a><span data-ttu-id="c6cb9-345">Use keepalives to reset the outbound idle timeout</span><span class="sxs-lookup"><span data-stu-id="c6cb9-345">Use keepalives to reset the outbound idle timeout</span></span>

<span data-ttu-id="c6cb9-346">Outbound connections have a 4-minute idle timeout.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-346">Outbound connections have a 4-minute idle timeout.</span></span> <span data-ttu-id="c6cb9-347">This timeout is not adjustable.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-347">This timeout is not adjustable.</span></span> <span data-ttu-id="c6cb9-348">However, you can use transport (for example, TCP keepalives) or application-layer keepalives to refresh an idle flow and reset this idle timeout if necessary.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-348">However, you can use transport (for example, TCP keepalives) or application-layer keepalives to refresh an idle flow and reset this idle timeout if necessary.</span></span>  

<span data-ttu-id="c6cb9-349">When using TCP keepalives, it is sufficient to enable them on one side of the connection.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-349">When using TCP keepalives, it is sufficient to enable them on one side of the connection.</span></span> <span data-ttu-id="c6cb9-350">For example, it is sufficient to enable them on the server side only to reset the idle timer of the flow and it is not necessary for both sides to initiated TCP keepalives.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-350">For example, it is sufficient to enable them on the server side only to reset the idle timer of the flow and it is not necessary for both sides to initiated TCP keepalives.</span></span>  <span data-ttu-id="c6cb9-351">Similar concepts exist for application layer, including database client-server configurations.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-351">Similar concepts exist for application layer, including database client-server configurations.</span></span>  <span data-ttu-id="c6cb9-352">Check the server side for what options exist for application specific keepalives.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-352">Check the server side for what options exist for application specific keepalives.</span></span>

## <a name="discoveroutbound"></a><span data-ttu-id="c6cb9-353">Discovering the public IP that a VM uses</span><span class="sxs-lookup"><span data-stu-id="c6cb9-353">Discovering the public IP that a VM uses</span></span>
<span data-ttu-id="c6cb9-354">There are many ways to determine the public source IP address of an outbound connection.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-354">There are many ways to determine the public source IP address of an outbound connection.</span></span> <span data-ttu-id="c6cb9-355">OpenDNS provides a service that can show you the public IP address of your VM.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-355">OpenDNS provides a service that can show you the public IP address of your VM.</span></span> 

<span data-ttu-id="c6cb9-356">By using the nslookup command, you can send a DNS query for the name myip.opendns.com to the OpenDNS resolver.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-356">By using the nslookup command, you can send a DNS query for the name myip.opendns.com to the OpenDNS resolver.</span></span> <span data-ttu-id="c6cb9-357">The service returns the source IP address that was used to send the query.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-357">The service returns the source IP address that was used to send the query.</span></span> <span data-ttu-id="c6cb9-358">When you run the following query from your VM, the response is the public IP used for that VM:</span><span class="sxs-lookup"><span data-stu-id="c6cb9-358">When you run the following query from your VM, the response is the public IP used for that VM:</span></span>

    nslookup myip.opendns.com resolver1.opendns.com

## <a name="preventoutbound"></a><span data-ttu-id="c6cb9-359">Preventing outbound connectivity</span><span class="sxs-lookup"><span data-stu-id="c6cb9-359">Preventing outbound connectivity</span></span>
<span data-ttu-id="c6cb9-360">Sometimes it's undesirable for a VM to be allowed to create an outbound flow.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-360">Sometimes it's undesirable for a VM to be allowed to create an outbound flow.</span></span> <span data-ttu-id="c6cb9-361">Or there might be a requirement to manage which destinations can be reached with outbound flows, or which destinations can begin inbound flows.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-361">Or there might be a requirement to manage which destinations can be reached with outbound flows, or which destinations can begin inbound flows.</span></span> <span data-ttu-id="c6cb9-362">In this case, you can use [network security groups](../virtual-network/security-overview.md) to manage the destinations that the VM can reach.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-362">In this case, you can use [network security groups](../virtual-network/security-overview.md) to manage the destinations that the VM can reach.</span></span> <span data-ttu-id="c6cb9-363">You can also use NSGs to manage which public destination can initiate inbound flows.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-363">You can also use NSGs to manage which public destination can initiate inbound flows.</span></span>

<span data-ttu-id="c6cb9-364">When you apply an NSG to a load-balanced VM, pay attention to the [service tags](../virtual-network/security-overview.md#service-tags) and [default security rules](../virtual-network/security-overview.md#default-security-rules).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-364">When you apply an NSG to a load-balanced VM, pay attention to the [service tags](../virtual-network/security-overview.md#service-tags) and [default security rules](../virtual-network/security-overview.md#default-security-rules).</span></span> <span data-ttu-id="c6cb9-365">You must ensure that the VM can receive health probe requests from Azure Load Balancer.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-365">You must ensure that the VM can receive health probe requests from Azure Load Balancer.</span></span> 

<span data-ttu-id="c6cb9-366">If an NSG blocks health probe requests from the AZURE_LOADBALANCER default tag, your VM health probe fails and the VM is marked down.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-366">If an NSG blocks health probe requests from the AZURE_LOADBALANCER default tag, your VM health probe fails and the VM is marked down.</span></span> <span data-ttu-id="c6cb9-367">Load Balancer stops sending new flows to that VM.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-367">Load Balancer stops sending new flows to that VM.</span></span>

## <a name="limitations"></a><span data-ttu-id="c6cb9-368">Limitations</span><span class="sxs-lookup"><span data-stu-id="c6cb9-368">Limitations</span></span>
- <span data-ttu-id="c6cb9-369">DisableOutboundSnat is not available as an option when configuring a load balancing rule in the portal.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-369">DisableOutboundSnat is not available as an option when configuring a load balancing rule in the portal.</span></span>  <span data-ttu-id="c6cb9-370">Use REST, template, or client tools instead.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-370">Use REST, template, or client tools instead.</span></span>
- <span data-ttu-id="c6cb9-371">Web Worker Roles without a VNet and other Microsoft platform services can be accessible when only an internal Standard Load Balancer is used due to a side effect from how pre-VNet services and other platform services function.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-371">Web Worker Roles without a VNet and other Microsoft platform services can be accessible when only an internal Standard Load Balancer is used due to a side effect from how pre-VNet services and other platform services function.</span></span> <span data-ttu-id="c6cb9-372">You must not rely on this side effect as the respective service itself or the underlying platform may change without notice.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-372">You must not rely on this side effect as the respective service itself or the underlying platform may change without notice.</span></span> <span data-ttu-id="c6cb9-373">You must always assume you need to create outbound connectivity explicitly if desired when using an internal Standard Load Balancer only.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-373">You must always assume you need to create outbound connectivity explicitly if desired when using an internal Standard Load Balancer only.</span></span> <span data-ttu-id="c6cb9-374">The [default SNAT](#defaultsnat) scenario 3 described in this article is not available.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-374">The [default SNAT](#defaultsnat) scenario 3 described in this article is not available.</span></span>

## <a name="next-steps"></a><span data-ttu-id="c6cb9-375">Next steps</span><span class="sxs-lookup"><span data-stu-id="c6cb9-375">Next steps</span></span>

- <span data-ttu-id="c6cb9-376">Learn more about [Load Balancer](load-balancer-overview.md).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-376">Learn more about [Load Balancer](load-balancer-overview.md).</span></span>
- <span data-ttu-id="c6cb9-377">Learn more about [Standard Load Balancer](load-balancer-standard-overview.md).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-377">Learn more about [Standard Load Balancer](load-balancer-standard-overview.md).</span></span>
- <span data-ttu-id="c6cb9-378">Learn more about [network security groups](../virtual-network/security-overview.md).</span><span class="sxs-lookup"><span data-stu-id="c6cb9-378">Learn more about [network security groups](../virtual-network/security-overview.md).</span></span>
- <span data-ttu-id="c6cb9-379">Learn about some of the other key [networking capabilities](../networking/networking-overview.md) in Azure.</span><span class="sxs-lookup"><span data-stu-id="c6cb9-379">Learn about some of the other key [networking capabilities](../networking/networking-overview.md) in Azure.</span></span>
