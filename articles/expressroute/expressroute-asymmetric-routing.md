---
title: Asymmetric routing | Microsoft Docs
description: This article walks you through the issues a customer might face with asymmetric routing in a network that has multiple links to a destination.
documentationcenter: na
services: expressroute
author: osamazia
manager: carmonm
editor: ''
ms.assetid: a754bff9-95c9-44b5-9796-377fc21e8322
ms.service: expressroute
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/10/2016
ms.author: osamam
ms.openlocfilehash: 981516346b530a38d05e8d7347af8ed1eac37b37
ms.sourcegitcommit: 5b9d839c0c0a94b293fdafe1d6e5429506c07e05
ms.translationtype: HT
ms.contentlocale: nl-NL
ms.lasthandoff: 08/02/2018
ms.locfileid: "44556705"
---
# <a name="asymmetric-routing-with-multiple-network-paths"></a><span data-ttu-id="81907-103">Asymmetric routing with multiple network paths</span><span class="sxs-lookup"><span data-stu-id="81907-103">Asymmetric routing with multiple network paths</span></span>
<span data-ttu-id="81907-104">This article explains how forward and return network traffic might take different routes when multiple paths are available between network source and destination.</span><span class="sxs-lookup"><span data-stu-id="81907-104">This article explains how forward and return network traffic might take different routes when multiple paths are available between network source and destination.</span></span>

<span data-ttu-id="81907-105">It's important to understand two concepts to understand asymmetric routing.</span><span class="sxs-lookup"><span data-stu-id="81907-105">It's important to understand two concepts to understand asymmetric routing.</span></span> <span data-ttu-id="81907-106">One is the effect of multiple network paths.</span><span class="sxs-lookup"><span data-stu-id="81907-106">One is the effect of multiple network paths.</span></span> <span data-ttu-id="81907-107">The other is how devices, like a firewall, keep state.</span><span class="sxs-lookup"><span data-stu-id="81907-107">The other is how devices, like a firewall, keep state.</span></span> <span data-ttu-id="81907-108">These types of devices are called stateful devices.</span><span class="sxs-lookup"><span data-stu-id="81907-108">These types of devices are called stateful devices.</span></span> <span data-ttu-id="81907-109">A combination of these two factors creates scenarios in which network traffic is dropped by a stateful device because the stateful device didn't detect that traffic originated with the device itself.</span><span class="sxs-lookup"><span data-stu-id="81907-109">A combination of these two factors creates scenarios in which network traffic is dropped by a stateful device because the stateful device didn't detect that traffic originated with the device itself.</span></span>

## <a name="multiple-network-paths"></a><span data-ttu-id="81907-110">Multiple network paths</span><span class="sxs-lookup"><span data-stu-id="81907-110">Multiple network paths</span></span>
<span data-ttu-id="81907-111">When an enterprise network has only one link to the Internet through their Internet service provider, all traffic to and from the Internet travels the same path.</span><span class="sxs-lookup"><span data-stu-id="81907-111">When an enterprise network has only one link to the Internet through their Internet service provider, all traffic to and from the Internet travels the same path.</span></span> <span data-ttu-id="81907-112">Often, companies purchase multiple circuits, as redundant paths, to improve network uptime.</span><span class="sxs-lookup"><span data-stu-id="81907-112">Often, companies purchase multiple circuits, as redundant paths, to improve network uptime.</span></span> <span data-ttu-id="81907-113">When this happens, it's possible that traffic that goes outside of the network, to the Internet, goes through one link, and the return traffic goes through a different link.</span><span class="sxs-lookup"><span data-stu-id="81907-113">When this happens, it's possible that traffic that goes outside of the network, to the Internet, goes through one link, and the return traffic goes through a different link.</span></span> <span data-ttu-id="81907-114">This is commonly known as asymmetric routing.</span><span class="sxs-lookup"><span data-stu-id="81907-114">This is commonly known as asymmetric routing.</span></span> <span data-ttu-id="81907-115">In asymmetric routing, reverse network traffic takes a different path from the original flow.</span><span class="sxs-lookup"><span data-stu-id="81907-115">In asymmetric routing, reverse network traffic takes a different path from the original flow.</span></span>

![Network with multiple paths](https://docstestmedia1.blob.core.windows.net/azure-media/articles/expressroute/media/expressroute-asymmetric-routing/AsymmetricRouting3.png)

<span data-ttu-id="81907-117">Although it primarily occurs on the Internet, asymmetric routing also applies to other combinations of multiple paths.</span><span class="sxs-lookup"><span data-stu-id="81907-117">Although it primarily occurs on the Internet, asymmetric routing also applies to other combinations of multiple paths.</span></span> <span data-ttu-id="81907-118">It applies, for example, both to an Internet path and a private path that go to the same destination, and to multiple private paths that go to the same destination.</span><span class="sxs-lookup"><span data-stu-id="81907-118">It applies, for example, both to an Internet path and a private path that go to the same destination, and to multiple private paths that go to the same destination.</span></span>

<span data-ttu-id="81907-119">Each router along the way, from source to destination, computes the best path to reach a destination.</span><span class="sxs-lookup"><span data-stu-id="81907-119">Each router along the way, from source to destination, computes the best path to reach a destination.</span></span> <span data-ttu-id="81907-120">The router's determination of best possible path is based on two main factors:</span><span class="sxs-lookup"><span data-stu-id="81907-120">The router's determination of best possible path is based on two main factors:</span></span>

* <span data-ttu-id="81907-121">Routing between external networks is based on a routing protocol, Border Gateway Protocol (BGP).</span><span class="sxs-lookup"><span data-stu-id="81907-121">Routing between external networks is based on a routing protocol, Border Gateway Protocol (BGP).</span></span> <span data-ttu-id="81907-122">BGP takes advertisements from neighbors and runs them through a series of steps to determine the best path to the intended destination.</span><span class="sxs-lookup"><span data-stu-id="81907-122">BGP takes advertisements from neighbors and runs them through a series of steps to determine the best path to the intended destination.</span></span> <span data-ttu-id="81907-123">It stores the best path in its routing table.</span><span class="sxs-lookup"><span data-stu-id="81907-123">It stores the best path in its routing table.</span></span>
* <span data-ttu-id="81907-124">The length of a subnet mask associated with a route influences routing paths.</span><span class="sxs-lookup"><span data-stu-id="81907-124">The length of a subnet mask associated with a route influences routing paths.</span></span> <span data-ttu-id="81907-125">If a router receives multiple advertisements for the same IP address but with different subnet masks, the router prefers the advertisement with a longer subnet mask because it's considered a more specific route.</span><span class="sxs-lookup"><span data-stu-id="81907-125">If a router receives multiple advertisements for the same IP address but with different subnet masks, the router prefers the advertisement with a longer subnet mask because it's considered a more specific route.</span></span>

## <a name="stateful-devices"></a><span data-ttu-id="81907-126">Stateful devices</span><span class="sxs-lookup"><span data-stu-id="81907-126">Stateful devices</span></span>
<span data-ttu-id="81907-127">Routers look at the IP header of a packet for routing purposes.</span><span class="sxs-lookup"><span data-stu-id="81907-127">Routers look at the IP header of a packet for routing purposes.</span></span> <span data-ttu-id="81907-128">Some devices look even deeper inside the packet.</span><span class="sxs-lookup"><span data-stu-id="81907-128">Some devices look even deeper inside the packet.</span></span> <span data-ttu-id="81907-129">Typically, these devices look at Layer4 (Transmission Control Protocol, or TCP; or User Datagram Protocol, or UDP), or even Layer7 (Application Layer) headers.</span><span class="sxs-lookup"><span data-stu-id="81907-129">Typically, these devices look at Layer4 (Transmission Control Protocol, or TCP; or User Datagram Protocol, or UDP), or even Layer7 (Application Layer) headers.</span></span> <span data-ttu-id="81907-130">These kinds of devices are either security devices or bandwidth-optimization devices.</span><span class="sxs-lookup"><span data-stu-id="81907-130">These kinds of devices are either security devices or bandwidth-optimization devices.</span></span> 

<span data-ttu-id="81907-131">A firewall is a common example of a stateful device.</span><span class="sxs-lookup"><span data-stu-id="81907-131">A firewall is a common example of a stateful device.</span></span> <span data-ttu-id="81907-132">A firewall allows or denies a packet to pass through its interfaces based on various fields such as protocol, TCP/UDP port, and URL headers.</span><span class="sxs-lookup"><span data-stu-id="81907-132">A firewall allows or denies a packet to pass through its interfaces based on various fields such as protocol, TCP/UDP port, and URL headers.</span></span> <span data-ttu-id="81907-133">This level of packet inspection puts a heavy processing load on the device.</span><span class="sxs-lookup"><span data-stu-id="81907-133">This level of packet inspection puts a heavy processing load on the device.</span></span> <span data-ttu-id="81907-134">To improve performance, the firewall inspects the first packet of a flow.</span><span class="sxs-lookup"><span data-stu-id="81907-134">To improve performance, the firewall inspects the first packet of a flow.</span></span> <span data-ttu-id="81907-135">If it allows the packet to proceed, it keeps the flow information in its state table.</span><span class="sxs-lookup"><span data-stu-id="81907-135">If it allows the packet to proceed, it keeps the flow information in its state table.</span></span> <span data-ttu-id="81907-136">All subsequent packets related to this flow are allowed based on the initial determination.</span><span class="sxs-lookup"><span data-stu-id="81907-136">All subsequent packets related to this flow are allowed based on the initial determination.</span></span> <span data-ttu-id="81907-137">A packet that is part of an existing flow might arrive at the firewall.</span><span class="sxs-lookup"><span data-stu-id="81907-137">A packet that is part of an existing flow might arrive at the firewall.</span></span> <span data-ttu-id="81907-138">If the firewall has no prior state information about it, the firewall drops the packet.</span><span class="sxs-lookup"><span data-stu-id="81907-138">If the firewall has no prior state information about it, the firewall drops the packet.</span></span>

## <a name="asymmetric-routing-with-expressroute"></a><span data-ttu-id="81907-139">Asymmetric routing with ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="81907-139">Asymmetric routing with ExpressRoute</span></span>
<span data-ttu-id="81907-140">When you connect to Microsoft through Azure ExpressRoute, your network changes like this:</span><span class="sxs-lookup"><span data-stu-id="81907-140">When you connect to Microsoft through Azure ExpressRoute, your network changes like this:</span></span>

* <span data-ttu-id="81907-141">You have multiple links to Microsoft.</span><span class="sxs-lookup"><span data-stu-id="81907-141">You have multiple links to Microsoft.</span></span> <span data-ttu-id="81907-142">One link is your existing Internet connection, and the other is via ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-142">One link is your existing Internet connection, and the other is via ExpressRoute.</span></span> <span data-ttu-id="81907-143">Some traffic to Microsoft might go through the Internet but come back via ExpressRoute, or vice versa.</span><span class="sxs-lookup"><span data-stu-id="81907-143">Some traffic to Microsoft might go through the Internet but come back via ExpressRoute, or vice versa.</span></span>
* <span data-ttu-id="81907-144">You receive more specific IP addresses via ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-144">You receive more specific IP addresses via ExpressRoute.</span></span> <span data-ttu-id="81907-145">So, for traffic from your network to Microsoft for services offered via ExpressRoute, routers always prefer ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-145">So, for traffic from your network to Microsoft for services offered via ExpressRoute, routers always prefer ExpressRoute.</span></span>

<span data-ttu-id="81907-146">To understand the effect these two changes have on a network, let’s consider some scenarios.</span><span class="sxs-lookup"><span data-stu-id="81907-146">To understand the effect these two changes have on a network, let’s consider some scenarios.</span></span> <span data-ttu-id="81907-147">As an example, you have only one circuit to the Internet and you consume all Microsoft services via the Internet.</span><span class="sxs-lookup"><span data-stu-id="81907-147">As an example, you have only one circuit to the Internet and you consume all Microsoft services via the Internet.</span></span> <span data-ttu-id="81907-148">The traffic from your network to Microsoft and back traverses the same Internet link and passes through the firewall.</span><span class="sxs-lookup"><span data-stu-id="81907-148">The traffic from your network to Microsoft and back traverses the same Internet link and passes through the firewall.</span></span> <span data-ttu-id="81907-149">The firewall records the flow as it sees the first packet and return packets are allowed because the flow exists in the state table.</span><span class="sxs-lookup"><span data-stu-id="81907-149">The firewall records the flow as it sees the first packet and return packets are allowed because the flow exists in the state table.</span></span>

![Asymmetric routing with ExpressRoute](https://docstestmedia1.blob.core.windows.net/azure-media/articles/expressroute/media/expressroute-asymmetric-routing/AsymmetricRouting1.png)

<span data-ttu-id="81907-151">Then, you turn on ExpressRoute and consume services offered by Microsoft over ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-151">Then, you turn on ExpressRoute and consume services offered by Microsoft over ExpressRoute.</span></span> <span data-ttu-id="81907-152">All other services from Microsoft are consumed over the Internet.</span><span class="sxs-lookup"><span data-stu-id="81907-152">All other services from Microsoft are consumed over the Internet.</span></span> <span data-ttu-id="81907-153">You deploy a separate firewall at your edge that is connected to ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-153">You deploy a separate firewall at your edge that is connected to ExpressRoute.</span></span> <span data-ttu-id="81907-154">Microsoft advertises more specific prefixes to your network over ExpressRoute for specific services.</span><span class="sxs-lookup"><span data-stu-id="81907-154">Microsoft advertises more specific prefixes to your network over ExpressRoute for specific services.</span></span> <span data-ttu-id="81907-155">Your routing infrastructure chooses ExpressRoute as the preferred path for those prefixes.</span><span class="sxs-lookup"><span data-stu-id="81907-155">Your routing infrastructure chooses ExpressRoute as the preferred path for those prefixes.</span></span> <span data-ttu-id="81907-156">If you are not advertising your public IP addresses to Microsoft over ExpressRoute, Microsoft communicates with your public IP addresses via the Internet.</span><span class="sxs-lookup"><span data-stu-id="81907-156">If you are not advertising your public IP addresses to Microsoft over ExpressRoute, Microsoft communicates with your public IP addresses via the Internet.</span></span> <span data-ttu-id="81907-157">Forward traffic from your network to Microsoft uses ExpressRoute, and reverse traffic from Microsoft uses the Internet.</span><span class="sxs-lookup"><span data-stu-id="81907-157">Forward traffic from your network to Microsoft uses ExpressRoute, and reverse traffic from Microsoft uses the Internet.</span></span> <span data-ttu-id="81907-158">When the firewall at the edge sees a response packet for a flow that it does not find in the state table, it drops the return traffic.</span><span class="sxs-lookup"><span data-stu-id="81907-158">When the firewall at the edge sees a response packet for a flow that it does not find in the state table, it drops the return traffic.</span></span>

<span data-ttu-id="81907-159">If you choose to use the same network address translation (NAT) pool for ExpressRoute and for the Internet, you'll see similar issues with the clients in your network on private IP addresses.</span><span class="sxs-lookup"><span data-stu-id="81907-159">If you choose to use the same network address translation (NAT) pool for ExpressRoute and for the Internet, you'll see similar issues with the clients in your network on private IP addresses.</span></span> <span data-ttu-id="81907-160">Requests for services like Windows Update go via the Internet because IP addresses for these services are not advertised via ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-160">Requests for services like Windows Update go via the Internet because IP addresses for these services are not advertised via ExpressRoute.</span></span> <span data-ttu-id="81907-161">However, the return traffic comes back via ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-161">However, the return traffic comes back via ExpressRoute.</span></span> <span data-ttu-id="81907-162">If Microsoft receives an IP address with the same subnet mask from the Internet and ExpressRoute, it prefers ExpressRoute over the Internet.</span><span class="sxs-lookup"><span data-stu-id="81907-162">If Microsoft receives an IP address with the same subnet mask from the Internet and ExpressRoute, it prefers ExpressRoute over the Internet.</span></span> <span data-ttu-id="81907-163">If a firewall or another stateful device that is on your network edge and facing ExpressRoute has no prior information about the flow, it drops the packets that belong to that flow.</span><span class="sxs-lookup"><span data-stu-id="81907-163">If a firewall or another stateful device that is on your network edge and facing ExpressRoute has no prior information about the flow, it drops the packets that belong to that flow.</span></span>

## <a name="asymmetric-routing-solutions"></a><span data-ttu-id="81907-164">Asymmetric routing solutions</span><span class="sxs-lookup"><span data-stu-id="81907-164">Asymmetric routing solutions</span></span>
<span data-ttu-id="81907-165">You have two main options to solve the problem of asymmetric routing.</span><span class="sxs-lookup"><span data-stu-id="81907-165">You have two main options to solve the problem of asymmetric routing.</span></span> <span data-ttu-id="81907-166">One is through routing, and the other is by using source-based NAT (SNAT).</span><span class="sxs-lookup"><span data-stu-id="81907-166">One is through routing, and the other is by using source-based NAT (SNAT).</span></span>

### <a name="routing"></a><span data-ttu-id="81907-167">Routing</span><span class="sxs-lookup"><span data-stu-id="81907-167">Routing</span></span>
<span data-ttu-id="81907-168">Ensure that your public IP addresses are advertised to appropriate wide area network (WAN) links.</span><span class="sxs-lookup"><span data-stu-id="81907-168">Ensure that your public IP addresses are advertised to appropriate wide area network (WAN) links.</span></span> <span data-ttu-id="81907-169">For example, if you want to use the Internet for authentication traffic and ExpressRoute for your mail traffic, you should not advertise your Active Directory Federation Services (AD FS) public IP addresses over ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-169">For example, if you want to use the Internet for authentication traffic and ExpressRoute for your mail traffic, you should not advertise your Active Directory Federation Services (AD FS) public IP addresses over ExpressRoute.</span></span> <span data-ttu-id="81907-170">Similarly, be sure not to expose an on-premises AD FS server to IP addresses that the router receives over ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-170">Similarly, be sure not to expose an on-premises AD FS server to IP addresses that the router receives over ExpressRoute.</span></span> <span data-ttu-id="81907-171">Routes received over ExpressRoute are more specific so they make ExpressRoute the preferred path for authentication traffic to Microsoft.</span><span class="sxs-lookup"><span data-stu-id="81907-171">Routes received over ExpressRoute are more specific so they make ExpressRoute the preferred path for authentication traffic to Microsoft.</span></span> <span data-ttu-id="81907-172">This causes asymmetric routing.</span><span class="sxs-lookup"><span data-stu-id="81907-172">This causes asymmetric routing.</span></span>

<span data-ttu-id="81907-173">If you want to use ExpressRoute for authentication, make sure that you are advertising AD FS public IP addresses over ExpressRoute without NAT.</span><span class="sxs-lookup"><span data-stu-id="81907-173">If you want to use ExpressRoute for authentication, make sure that you are advertising AD FS public IP addresses over ExpressRoute without NAT.</span></span> <span data-ttu-id="81907-174">This way, traffic that originates from Microsoft and goes to an on-premises AD FS server goes over ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-174">This way, traffic that originates from Microsoft and goes to an on-premises AD FS server goes over ExpressRoute.</span></span> <span data-ttu-id="81907-175">Return traffic from customer to Microsoft uses ExpressRoute because it's the preferred route over the Internet.</span><span class="sxs-lookup"><span data-stu-id="81907-175">Return traffic from customer to Microsoft uses ExpressRoute because it's the preferred route over the Internet.</span></span>

### <a name="source-based-nat"></a><span data-ttu-id="81907-176">Source-based NAT</span><span class="sxs-lookup"><span data-stu-id="81907-176">Source-based NAT</span></span>
<span data-ttu-id="81907-177">Another way of solving asymmetric routing issues is by using SNAT.</span><span class="sxs-lookup"><span data-stu-id="81907-177">Another way of solving asymmetric routing issues is by using SNAT.</span></span> <span data-ttu-id="81907-178">For example, you have not advertised the public IP address of an on-premises Simple Mail Transfer Protocol (SMTP) server over ExpressRoute because you intend to use the Internet for this type of communication.</span><span class="sxs-lookup"><span data-stu-id="81907-178">For example, you have not advertised the public IP address of an on-premises Simple Mail Transfer Protocol (SMTP) server over ExpressRoute because you intend to use the Internet for this type of communication.</span></span> <span data-ttu-id="81907-179">A request that originates with Microsoft and then goes to your on-premises SMTP server traverses the Internet.</span><span class="sxs-lookup"><span data-stu-id="81907-179">A request that originates with Microsoft and then goes to your on-premises SMTP server traverses the Internet.</span></span> <span data-ttu-id="81907-180">You SNAT the incoming request to an internal IP address.</span><span class="sxs-lookup"><span data-stu-id="81907-180">You SNAT the incoming request to an internal IP address.</span></span> <span data-ttu-id="81907-181">Reverse traffic from the SMTP server goes to the edge firewall (which you use for NAT) instead of through ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-181">Reverse traffic from the SMTP server goes to the edge firewall (which you use for NAT) instead of through ExpressRoute.</span></span> <span data-ttu-id="81907-182">The return traffic goes back via the Internet.</span><span class="sxs-lookup"><span data-stu-id="81907-182">The return traffic goes back via the Internet.</span></span>

![Source-based NAT network configuration](https://docstestmedia1.blob.core.windows.net/azure-media/articles/expressroute/media/expressroute-asymmetric-routing/AsymmetricRouting2.png)

## <a name="asymmetric-routing-detection"></a><span data-ttu-id="81907-184">Asymmetric routing detection</span><span class="sxs-lookup"><span data-stu-id="81907-184">Asymmetric routing detection</span></span>
<span data-ttu-id="81907-185">Traceroute is the best way to make sure that your network traffic is traversing the expected path.</span><span class="sxs-lookup"><span data-stu-id="81907-185">Traceroute is the best way to make sure that your network traffic is traversing the expected path.</span></span> <span data-ttu-id="81907-186">If you expect traffic from your on-premises SMTP server to Microsoft to take the Internet path, the expected traceroute is from the SMTP server to Office 365.</span><span class="sxs-lookup"><span data-stu-id="81907-186">If you expect traffic from your on-premises SMTP server to Microsoft to take the Internet path, the expected traceroute is from the SMTP server to Office 365.</span></span> <span data-ttu-id="81907-187">The result validates that traffic is indeed leaving your network toward the Internet and not toward ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="81907-187">The result validates that traffic is indeed leaving your network toward the Internet and not toward ExpressRoute.</span></span>




